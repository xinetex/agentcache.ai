<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AgentCache Dashboard – Analytics & Insights</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
</head>
<body class="min-h-screen bg-[#050816] text-slate-100 antialiased">
  <!-- Header -->
  <header class="border-b border-slate-800 bg-slate-950/50 backdrop-blur-sm sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-sky-500/10 border border-sky-500/40 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-sky-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M13 2L4 14h6l-1 8 9-12h-6l1-8z" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div>
            <h1 class="text-lg font-semibold tracking-tight text-slate-50">AgentCache</h1>
            <p class="text-xs text-slate-400">Analytics Dashboard</p>
          </div>
        </div>
        
        <div class="flex items-center gap-3">
          <select id="periodSelect" class="px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-900 text-xs text-slate-200">
            <option value="24h">Last 24 hours</option>
            <option value="7d" selected>Last 7 days</option>
            <option value="30d">Last 30 days</option>
          </select>
          
          <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-900">
            <div class="w-2 h-2 rounded-full bg-emerald-400"></div>
            <span class="text-xs text-slate-300" id="userEmail">user@example.com</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      <!-- Total Requests -->
      <div class="bg-slate-950/70 border border-slate-800/80 rounded-2xl p-5">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs text-slate-400">Total Requests</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-sky-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
          </svg>
        </div>
        <p class="text-3xl font-bold tracking-tight text-slate-50" id="totalRequests">0</p>
        <p class="text-xs text-emerald-400 mt-1" id="requestsChange">+0% from last period</p>
      </div>

      <!-- Hit Rate -->
      <div class="bg-slate-950/70 border border-emerald-500/30 rounded-2xl p-5">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs text-slate-400">Cache Hit Rate</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-emerald-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
        </div>
        <p class="text-3xl font-bold tracking-tight text-emerald-400" id="hitRate">0%</p>
        <p class="text-xs text-slate-400 mt-1"><span id="cacheHits">0</span> hits / <span id="cacheMisses">0</span> misses</p>
      </div>

      <!-- Cost Savings -->
      <div class="bg-slate-950/70 border border-amber-500/30 rounded-2xl p-5">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs text-slate-400">Cost Saved</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-amber-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
          </svg>
        </div>
        <p class="text-3xl font-bold tracking-tight text-amber-400" id="costSaved">$0.00</p>
        <p class="text-xs text-slate-400 mt-1"><span id="tokensSaved">0</span> tokens saved</p>
      </div>

      <!-- Avg Latency -->
      <div class="bg-slate-950/70 border border-violet-500/30 rounded-2xl p-5">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs text-slate-400">Avg Latency</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-violet-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>
        <p class="text-3xl font-bold tracking-tight text-violet-400" id="avgLatency">0ms</p>
        <p class="text-xs text-slate-400 mt-1">10× faster than direct API</p>
      </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Hit Rate Over Time -->
      <div class="bg-slate-950/70 border border-slate-800/80 rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="text-base font-semibold tracking-tight text-slate-50">Hit Rate Over Time</h2>
            <p class="text-xs text-slate-400 mt-0.5">Cache performance trend</p>
          </div>
          <span class="px-2 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/40 text-[10px] text-emerald-300">Live</span>
        </div>
        <div id="hitRateChart" class="w-full h-64"></div>
      </div>

      <!-- Requests Distribution -->
      <div class="bg-slate-950/70 border border-slate-800/80 rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="text-base font-semibold tracking-tight text-slate-50">Requests Distribution</h2>
            <p class="text-xs text-slate-400 mt-0.5">Hits vs Misses breakdown</p>
          </div>
        </div>
        <div id="distributionChart" class="w-full h-64"></div>
      </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Cost Savings Timeline -->
      <div class="bg-slate-950/70 border border-slate-800/80 rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="text-base font-semibold tracking-tight text-slate-50">Cost Savings Timeline</h2>
            <p class="text-xs text-slate-400 mt-0.5">Cumulative savings over time</p>
          </div>
        </div>
        <div id="savingsChart" class="w-full h-64"></div>
      </div>

      <!-- Latency Comparison -->
      <div class="bg-slate-950/70 border border-slate-800/80 rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="text-base font-semibold tracking-tight text-slate-50">Latency Comparison</h2>
            <p class="text-xs text-slate-400 mt-0.5">Cache hits vs direct API calls</p>
          </div>
        </div>
        <div id="latencyChart" class="w-full h-64"></div>
      </div>
    </div>

    <!-- Freshness Distribution (Anti-Cache Feature) -->
    <div class="bg-slate-950/70 border border-slate-800/80 rounded-2xl p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-base font-semibold tracking-tight text-slate-50">Cache Freshness Distribution</h2>
          <p class="text-xs text-slate-400 mt-0.5">Real-time freshness monitoring</p>
        </div>
        <span class="px-2 py-1 rounded-full bg-sky-500/10 border border-sky-500/40 text-[10px] text-sky-300">Anti-Cache</span>
      </div>
      <div id="freshnessChart" class="w-full h-48"></div>
    </div>

    <!-- Quota & Usage -->
    <div class="bg-slate-950/70 border border-slate-800/80 rounded-2xl p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-base font-semibold tracking-tight text-slate-50">Monthly Quota Usage</h2>
          <p class="text-xs text-slate-400 mt-0.5">Track your subscription limits</p>
        </div>
        <button class="px-3 py-1.5 rounded-lg bg-sky-500 text-xs font-medium text-slate-950 hover:bg-sky-400 transition">
          Upgrade Plan
        </button>
      </div>
      
      <div class="space-y-4">
        <div>
          <div class="flex items-center justify-between text-sm mb-2">
            <span class="text-slate-300">Requests this month</span>
            <span class="text-slate-50 font-medium"><span id="quotaUsed">0</span> / <span id="quotaLimit">1,000</span></span>
          </div>
          <div class="h-3 rounded-full bg-slate-900 overflow-hidden">
            <div id="quotaBar" class="h-full bg-gradient-to-r from-emerald-500 to-sky-500 transition-all duration-500" style="width: 0%"></div>
          </div>
          <p class="text-xs text-slate-400 mt-1"><span id="quotaRemaining">1,000</span> requests remaining</p>
        </div>

        <div class="grid grid-cols-3 gap-4 pt-4 border-t border-slate-800">
          <div>
            <p class="text-xs text-slate-400">Usage</p>
            <p class="text-lg font-semibold text-slate-50" id="quotaPercent">0%</p>
          </div>
          <div>
            <p class="text-xs text-slate-400">Resets in</p>
            <p class="text-lg font-semibold text-slate-50" id="quotaReset">-</p>
          </div>
          <div>
            <p class="text-xs text-slate-400">Current Plan</p>
            <p class="text-lg font-semibold text-sky-400" id="currentPlan">Starter</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="bg-slate-950/70 border border-slate-800/80 rounded-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-base font-semibold tracking-tight text-slate-50">Recent Activity</h2>
          <p class="text-xs text-slate-400 mt-0.5">Latest cache operations</p>
        </div>
        <button class="text-xs text-sky-400 hover:text-sky-300">View all →</button>
      </div>

      <div class="space-y-3" id="activityLog">
        <!-- Activity items populated by JS -->
      </div>
    </div>
  </main>

  <script>
    // Configuration
    const API_BASE = 'https://agentcache.ai';
    const API_KEY = localStorage.getItem('agentcache_api_key') || 'ac_demo_test123';
    let currentPeriod = '7d';
    let statsData = null;
    let refreshInterval = null;

    function startPolling() {
      refreshInterval = setInterval(() => {
        if (!document.hidden) loadDashboard();
      }, 60000); // 60s instead of 30s
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadDashboard();
      
      document.getElementById('periodSelect').addEventListener('change', (e) => {
        currentPeriod = e.target.value;
        loadDashboard();
      });

      startPolling();
    });
    
    // Pause polling when hidden
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        if (refreshInterval) clearInterval(refreshInterval);
      } else {
        loadDashboard();
        startPolling();
      }
    });
    
    window.addEventListener('beforeunload', () => {
      if (refreshInterval) clearInterval(refreshInterval);
    });

    // Load dashboard data
    async function loadDashboard() {
      try {
        const response = await fetch(`${API_BASE}/api/stats?period=${currentPeriod}`, {
          headers: {
            'X-API-Key': API_KEY
          }
        });

        if (!response.ok) throw new Error('Failed to load stats');
        
        statsData = await response.json();
        updateDashboard(statsData);
        renderCharts(statsData);
      } catch (error) {
        console.error('Dashboard error:', error);
        // Show demo data
        loadDemoData();
      }
    }

    // Update dashboard metrics
    function updateDashboard(data) {
      // KPIs
      document.getElementById('totalRequests').textContent = data.metrics.total_requests.toLocaleString();
      document.getElementById('hitRate').textContent = data.metrics.hit_rate + '%';
      document.getElementById('cacheHits').textContent = data.metrics.cache_hits.toLocaleString();
      document.getElementById('cacheMisses').textContent = data.metrics.cache_misses.toLocaleString();
      document.getElementById('costSaved').textContent = data.metrics.cost_saved;
      document.getElementById('tokensSaved').textContent = data.metrics.tokens_saved.toLocaleString();
      document.getElementById('avgLatency').textContent = data.metrics.avg_latency_ms + 'ms';

      // Quota
      document.getElementById('quotaUsed').textContent = data.quota.monthly_used.toLocaleString();
      document.getElementById('quotaLimit').textContent = data.quota.monthly_limit.toLocaleString();
      document.getElementById('quotaRemaining').textContent = data.quota.monthly_remaining.toLocaleString();
      document.getElementById('quotaPercent').textContent = data.quota.usage_percent + '%';
      document.getElementById('quotaBar').style.width = data.quota.usage_percent + '%';

      // Calculate days until reset
      const now = new Date();
      const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      const daysRemaining = Math.ceil((nextMonth - now) / (1000 * 60 * 60 * 24));
      document.getElementById('quotaReset').textContent = daysRemaining + 'd';

      // Update bar color based on usage
      const bar = document.getElementById('quotaBar');
      if (data.quota.usage_percent > 90) {
        bar.className = 'h-full bg-gradient-to-r from-rose-500 to-amber-500 transition-all duration-500';
      } else if (data.quota.usage_percent > 75) {
        bar.className = 'h-full bg-gradient-to-r from-amber-500 to-emerald-500 transition-all duration-500';
      }
    }

    // Render Observable Plot charts
    function renderCharts(data) {
      // Generate mock time series data for demo
      const days = currentPeriod === '24h' ? 24 : currentPeriod === '7d' ? 7 : 30;
      const timeSeriesData = Array.from({ length: days }, (_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - (days - i - 1));
        return {
          date,
          hits: Math.floor(Math.random() * 100 + 50 * (data.metrics.hit_rate / 100)),
          misses: Math.floor(Math.random() * 30 + 10),
          cost_saved: Math.random() * 5 + 2,
          latency: Math.random() * 200 + 300
        };
      });

      // 1. Hit Rate Over Time (Line Chart)
      const hitRatePlot = Plot.plot({
        width: document.getElementById('hitRateChart').offsetWidth,
        height: 256,
        marginLeft: 50,
        style: {
          background: 'transparent',
          color: '#cbd5e1'
        },
        x: {
          type: 'time',
          grid: true,
          tickFormat: currentPeriod === '24h' ? '%H:%M' : '%b %d'
        },
        y: {
          label: 'Requests',
          grid: true
        },
        marks: [
          Plot.lineY(timeSeriesData, {
            x: 'date',
            y: 'hits',
            stroke: '#10b981',
            strokeWidth: 2,
            curve: 'catmull-rom'
          }),
          Plot.lineY(timeSeriesData, {
            x: 'date',
            y: 'misses',
            stroke: '#ef4444',
            strokeWidth: 2,
            curve: 'catmull-rom'
          }),
          Plot.ruleY([0])
        ]
      });
      document.getElementById('hitRateChart').innerHTML = '';
      document.getElementById('hitRateChart').appendChild(hitRatePlot);

      // 2. Distribution (Pie/Donut Chart equivalent with bars)
      const distributionData = [
        { type: 'Cache Hits', value: data.metrics.cache_hits, color: '#10b981' },
        { type: 'Cache Misses', value: data.metrics.cache_misses, color: '#ef4444' }
      ];

      const distributionPlot = Plot.plot({
        width: document.getElementById('distributionChart').offsetWidth,
        height: 256,
        marginLeft: 100,
        style: {
          background: 'transparent',
          color: '#cbd5e1'
        },
        x: {
          grid: true
        },
        y: {
          label: null
        },
        marks: [
          Plot.barX(distributionData, {
            y: 'type',
            x: 'value',
            fill: 'color',
            rx: 4
          }),
          Plot.text(distributionData, {
            y: 'type',
            x: 'value',
            text: d => d.value.toLocaleString(),
            textAnchor: 'start',
            dx: 10,
            fill: '#f1f5f9'
          }),
          Plot.ruleX([0])
        ]
      });
      document.getElementById('distributionChart').innerHTML = '';
      document.getElementById('distributionChart').appendChild(distributionPlot);

      // 3. Cost Savings Timeline (Area Chart)
      const savingsPlot = Plot.plot({
        width: document.getElementById('savingsChart').offsetWidth,
        height: 256,
        marginLeft: 50,
        style: {
          background: 'transparent',
          color: '#cbd5e1'
        },
        x: {
          type: 'time',
          tickFormat: currentPeriod === '24h' ? '%H:%M' : '%b %d'
        },
        y: {
          label: 'Cost Saved ($)',
          grid: true
        },
        marks: [
          Plot.areaY(timeSeriesData, {
            x: 'date',
            y: 'cost_saved',
            fill: '#fbbf24',
            fillOpacity: 0.3,
            curve: 'catmull-rom'
          }),
          Plot.lineY(timeSeriesData, {
            x: 'date',
            y: 'cost_saved',
            stroke: '#fbbf24',
            strokeWidth: 2,
            curve: 'catmull-rom'
          }),
          Plot.ruleY([0])
        ]
      });
      document.getElementById('savingsChart').innerHTML = '';
      document.getElementById('savingsChart').appendChild(savingsPlot);

      // 4. Latency Comparison (Grouped Bar)
      const latencyData = [
        { type: 'Cache Hit', latency: data.metrics.cache_hit_latency_ms },
        { type: 'Cache Miss', latency: data.metrics.cache_miss_latency_ms }
      ];

      const latencyPlot = Plot.plot({
        width: document.getElementById('latencyChart').offsetWidth,
        height: 256,
        marginLeft: 100,
        style: {
          background: 'transparent',
          color: '#cbd5e1'
        },
        x: {
          grid: true,
          label: 'Latency (ms)'
        },
        y: {
          label: null
        },
        color: {
          domain: ['Cache Hit', 'Cache Miss'],
          range: ['#8b5cf6', '#ec4899']
        },
        marks: [
          Plot.barX(latencyData, {
            y: 'type',
            x: 'latency',
            fill: 'type',
            rx: 4
          }),
          Plot.text(latencyData, {
            y: 'type',
            x: 'latency',
            text: d => d.latency + 'ms',
            textAnchor: 'start',
            dx: 10,
            fill: '#f1f5f9'
          }),
          Plot.ruleX([0])
        ]
      });
      document.getElementById('latencyChart').innerHTML = '';
      document.getElementById('latencyChart').appendChild(latencyPlot);

      // 5. Freshness Distribution (Stacked Bar)
      const freshnessData = [
        { status: 'Fresh', count: 1842, percent: 68 },
        { status: 'Stale', count: 624, percent: 23 },
        { status: 'Expired', count: 248, percent: 9 }
      ];

      const freshnessPlot = Plot.plot({
        width: document.getElementById('freshnessChart').offsetWidth,
        height: 192,
        marginLeft: 80,
        style: {
          background: 'transparent',
          color: '#cbd5e1'
        },
        x: {
          percent: true,
          label: 'Percentage'
        },
        y: {
          label: null
        },
        color: {
          domain: ['Fresh', 'Stale', 'Expired'],
          range: ['#10b981', '#fbbf24', '#ef4444']
        },
        marks: [
          Plot.barX(freshnessData, {
            y: () => 'Cache Status',
            x: 'percent',
            fill: 'status',
            rx: 4
          }),
          Plot.text(freshnessData, {
            y: () => 'Cache Status',
            x: 'percent',
            text: d => `${d.status}: ${d.count} (${d.percent}%)`,
            textAnchor: 'middle',
            fill: '#1e293b',
            fontWeight: 'bold'
          }),
          Plot.ruleX([0])
        ]
      });
      document.getElementById('freshnessChart').innerHTML = '';
      document.getElementById('freshnessChart').appendChild(freshnessPlot);

      // Update activity log
      updateActivityLog();
    }

    // Update activity log
    function updateActivityLog() {
      const activities = [
        { time: '2 minutes ago', action: 'Cache hit', detail: 'openai/gpt-4', status: 'success' },
        { time: '5 minutes ago', action: 'Cache invalidated', detail: 'news/* pattern', status: 'warning' },
        { time: '12 minutes ago', action: 'URL change detected', detail: 'competitor.com/pricing', status: 'info' },
        { time: '24 minutes ago', action: 'Cache miss', detail: 'anthropic/claude-3', status: 'neutral' },
        { time: '1 hour ago', action: 'Listener registered', detail: 'example.com', status: 'success' }
      ];

      const colors = {
        success: 'emerald',
        warning: 'amber',
        info: 'sky',
        neutral: 'slate'
      };

      const html = activities.map(a => `
        <div class="flex items-start gap-3 p-3 rounded-lg hover:bg-slate-900/50 transition">
          <div class="w-2 h-2 rounded-full bg-${colors[a.status]}-400 mt-2"></div>
          <div class="flex-1 min-w-0">
            <p class="text-sm text-slate-200">${a.action}</p>
            <p class="text-xs text-slate-400 truncate">${a.detail}</p>
          </div>
          <span class="text-xs text-slate-500 whitespace-nowrap">${a.time}</span>
        </div>
      `).join('');

      document.getElementById('activityLog').innerHTML = html;
    }

    // Load demo data if API fails
    function loadDemoData() {
      const demoData = {
        period: currentPeriod,
        namespace: 'default',
        metrics: {
          total_requests: 2546,
          cache_hits: 2034,
          cache_misses: 512,
          hit_rate: 79.9,
          tokens_saved: 2034000,
          cost_saved: '$20.34',
          avg_latency_ms: 187
        },
        quota: {
          monthly_limit: 10000,
          monthly_used: 4532,
          monthly_remaining: 5468,
          usage_percent: 45.3
        }
      };

      statsData = { ...demoData, metrics: { ...demoData.metrics, cache_hit_latency_ms: 35, cache_miss_latency_ms: 1800 }};
      updateDashboard(statsData);
      renderCharts(statsData);
    }
  </script>
</body>
</html>
