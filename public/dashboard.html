<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting to Studio...</title>
    <meta http-equiv="refresh" content="0; url=/studio-v2.html">
    <script>window.location.replace('/studio-v2.html');</script>
    <meta http-equiv="refresh" content="0; url=/cognitive-universe.html">
    <script>
        // Immediate redirect
        window.location.replace('/cognitive-universe.html');
    </script>
    <style>
        body {
            background-color: #020617;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
        }
        code {
            font-family: 'JetBrains Mono', monospace;
        }
        .glass {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        @keyframes pulse-green {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-green {
            animation: pulse-green 2s ease-in-out infinite;
        }
    </style>
</head>
<body class="p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-4xl font-bold mb-2">AgentCache Dashboard</h1>
                <p class="text-slate-400">Real-time cache statistics and savings</p>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-green-500 pulse-green"></span>
                <span class="text-sm text-slate-400">Live</span>
            </div>
        </div>

        <!-- API Key Display -->
        <div id="apiKeySection" class="glass rounded-xl p-4 mb-8 border border-slate-700">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-sm text-slate-400 mb-1">API Key</div>
                    <code id="apiKeyDisplay" class="text-green-400"></code>
                </div>
                <div class="text-right">
                    <div class="text-sm text-slate-400 mb-1">Plan</div>
                    <span id="planDisplay" class="text-white font-semibold">Community</span>
                </div>
            </div>
        </div>

        <!-- Main Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Requests Today -->
            <div class="glass rounded-xl p-6 border border-slate-700">
                <div class="text-sm text-slate-400 mb-2">Requests Today</div>
                <div class="text-4xl font-bold text-white mb-1">
                    <span id="requestsToday">0</span>
                </div>
                <div class="text-xs text-slate-500">
                    <span id="quotaRemaining">10,000</span> remaining this month
                </div>
            </div>

            <!-- Cache Hit Rate -->
            <div class="glass rounded-xl p-6 border border-slate-700">
                <div class="text-sm text-slate-400 mb-2">Cache Hit Rate</div>
                <div class="text-4xl font-bold text-green-400 mb-1">
                    <span id="hitRate">0</span>%
                </div>
                <div class="text-xs text-slate-500">
                    <span id="totalHits">0</span> hits / <span id="totalMisses">0</span> misses
                </div>
            </div>

            <!-- Money Saved -->
            <div class="glass rounded-xl p-6 border border-slate-700">
                <div class="text-sm text-slate-400 mb-2">Money Saved</div>
                <div class="text-4xl font-bold text-green-400 mb-1">
                    $<span id="moneySaved">0.00</span>
                </div>
                <div class="text-xs text-slate-500">
                    This month
                </div>
            </div>

            <!-- Avg Latency -->
            <div class="glass rounded-xl p-6 border border-slate-700">
                <div class="text-sm text-slate-400 mb-2">Avg Cache Hit</div>
                <div class="text-4xl font-bold text-cyan-400 mb-1">
                    <span id="latency">0</span>ms
                </div>
                <div class="text-xs text-slate-500">
                    P95: <span id="latencyP95">0</span>ms
                </div>
            </div>
        </div>

        <!-- Freshness Distribution -->
        <div class="glass rounded-xl p-6 border border-slate-700 mb-8">
            <h3 class="text-xl font-bold mb-4">Cache Freshness</h3>
            <div class="grid grid-cols-3 gap-4">
                <div class="text-center">
                    <div class="text-3xl font-bold text-green-500 mb-1">
                        <span id="freshCount">0</span>
                    </div>
                    <div class="text-sm text-slate-400">ðŸŸ¢ Fresh</div>
                    <div class="text-xs text-slate-600">&lt; 75% TTL</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-yellow-500 mb-1">
                        <span id="staleCount">0</span>
                    </div>
                    <div class="text-sm text-slate-400">ðŸŸ¡ Stale</div>
                    <div class="text-xs text-slate-600">&gt; 75% TTL</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-red-500 mb-1">
                        <span id="expiredCount">0</span>
                    </div>
                    <div class="text-sm text-slate-400">ðŸ”´ Expired</div>
                    <div class="text-xs text-slate-600">&gt; 100% TTL</div>
                </div>
            </div>
        </div>

        <!-- Anti-Cache Features -->
        <div class="glass rounded-xl p-6 border border-green-500/30 mb-8">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span>ðŸ”„</span>
                Anti-Cache: Active Freshness Management
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h4 class="font-semibold mb-2">Manual Invalidation</h4>
                    <pre class="bg-slate-900 rounded p-3 text-xs overflow-x-auto"><code>curl -X POST /api/cache/invalidate \\
  -H "X-API-Key: <span class="text-green-400" id="apiKeyCode1">your-key</span>" \\
  -d '{"pattern":"news/*","olderThan":21600000}'</code></pre>
                </div>
                <div>
                    <h4 class="font-semibold mb-2">URL Monitoring</h4>
                    <pre class="bg-slate-900 rounded p-3 text-xs overflow-x-auto"><code>curl -X POST /api/listeners/register \\
  -H "X-API-Key: <span class="text-green-400" id="apiKeyCode2">your-key</span>" \\
  -d '{"url":"https://example.com"}'</code></pre>
                </div>
            </div>
        </div>

        <!-- Overflow Partners -->
        <div class="glass rounded-xl p-6 border border-purple-500/30 mb-8">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span>ðŸ”„</span>
                Overflow Partners: Elastic Cache Network
            </h3>
            <div id="partnerStats" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Partner stats will be populated here -->
                <div class="text-center text-slate-500 text-sm">Loading partner stats...</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="glass rounded-xl p-6 border border-slate-700">
                <h3 class="text-lg font-bold mb-3">Quick Actions</h3>
                <div class="space-y-2">
                    <button onclick="invalidateOldCaches()" class="w-full px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-sm font-semibold transition">
                        ðŸ—‘ï¸ Invalidate Old Caches (>24h)
                    </button>
                    <button onclick="viewDocs()" class="w-full px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg text-sm font-semibold transition">
                        ðŸ“– View Documentation
                    </button>
                    <button onclick="shareSavings()" class="w-full px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm font-semibold transition">
                        ðŸ“± Share My Savings
                    </button>
                </div>
            </div>

            <div class="glass rounded-xl p-6 border border-slate-700">
                <h3 class="text-lg font-bold mb-3">Upgrade</h3>
                <p class="text-sm text-slate-400 mb-4">Need more requests? Upgrade to Pro for 1M requests/month.</p>
                <a href="/community.html#pricing" class="block w-full px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-sm font-semibold text-center transition">
                    ðŸš€ Upgrade to Pro - $49/month
                </a>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-sm text-slate-500 mt-12">
            Auto-refreshes every 5 seconds â€¢ Last updated: <span id="lastUpdated">Never</span>
        </div>
    </div>

    <script>
// Get API key from URL or localStorage
        const urlParams = new URLSearchParams(window.location.search);
        let apiKey = urlParams.get('key') || localStorage.getItem('ac_api_key');

        // If API key provided via URL, persist to localStorage for next visits
        if (urlParams.get('key')) {
            localStorage.setItem('ac_api_key', urlParams.get('key'));
        }

        if (!apiKey) {
            document.body.innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-6">
                  <div class="glass max-w-lg w-full rounded-2xl p-8 border border-slate-700 text-left">
                    <h1 class="text-2xl font-bold mb-3">Missing API Key</h1>
                    <p class="text-slate-400 mb-6">This developer dashboard requires an API key. You can:</p>

                    <ol class="list-decimal list-inside space-y-2 text-sm text-slate-300 mb-6">
                      <li>Append it to the URL: <code class="bg-slate-900 px-2 py-1 rounded">/dashboard.html?key=ac_xxx</code></li>
                      <li>Paste it below and we'll remember it for you.</li>
                      <li>Generate one via QR: <a href="/get-key.html" class="text-cyan-400 underline">/get-key.html</a></li>
                    </ol>

                    <div class="flex gap-2 mb-4">
                      <input id="apiKeyInput" type="text" placeholder="ac_..." class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-cyan-600"/>
                      <button id="saveKeyBtn" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg text-sm font-semibold">Save</button>
                    </div>

                    <div class="flex items-center justify-between text-sm">
                      <a href="/portal/login" class="text-slate-400 hover:text-white">I'm platform admin â†’ Portal</a>
                      <button id="useDemoBtn" class="text-slate-400 hover:text-white">Use demo key</button>
                    </div>
                  </div>
                </div>
            `;

            document.getElementById('saveKeyBtn').addEventListener('click', () => {
              const v = document.getElementById('apiKeyInput').value.trim();
              if (!v.startsWith('ac_')) { alert('Please paste a valid API key (starts with ac_)'); return; }
              localStorage.setItem('ac_api_key', v);
              const url = new URL(window.location.href);
              url.searchParams.set('key', v);
              window.location.href = url.toString();
            });

            document.getElementById('useDemoBtn').addEventListener('click', () => {
              const demo = 'ac_demo_test123';
              localStorage.setItem('ac_api_key', demo);
              const url = new URL(window.location.href);
              url.searchParams.set('key', demo);
              window.location.href = url.toString();
            });
        } else {
            document.getElementById('apiKeyDisplay').textContent = apiKey;
            document.getElementById('apiKeyCode1').textContent = apiKey;
            document.getElementById('apiKeyCode2').textContent = apiKey;
            
            // Start fetching stats
            fetchStats();
            fetchPartnerStats();
            setInterval(fetchStats, 5000); // Refresh every 5 seconds
            setInterval(fetchPartnerStats, 10000); // Refresh partner stats every 10 seconds
        }

        async function fetchPartnerStats() {
            try {
                const response = await fetch('/api/overflow/stats', {
                    headers: { 'X-API-Key': apiKey }
                });

                if (!response.ok) {
                    console.error('Failed to fetch partner stats:', response.status);
                    return;
                }

                const data = await response.json();
                
                // Render partner stats
                const partnerStatsHtml = data.partners.map(partner => {
                    const partnerName = partner.id.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                    return `
                        <div class="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                            <div class="text-sm font-semibold text-purple-400 mb-3">${partnerName}</div>
                            <div class="space-y-2 text-xs">
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Cache Hits:</span>
                                    <span class="text-white font-semibold">${partner.cache.hits}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Hit Rate:</span>
                                    <span class="text-green-400 font-semibold">${partner.cache.hitRate}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Webhooks:</span>
                                    <span class="text-cyan-400 font-semibold">${partner.webhooks.total}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Webhook Success:</span>
                                    <span class="text-green-400 font-semibold">${partner.webhooks.successRate}%</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('partnerStats').innerHTML = partnerStatsHtml;
            } catch (error) {
                console.error('Error fetching partner stats:', error);
                document.getElementById('partnerStats').innerHTML = '<div class="text-center text-red-500 text-sm">Error loading partner stats</div>';
            }
        }

        async function fetchStats() {
            try {
                const response = await fetch('/api/stats', {
                    headers: { 'X-API-Key': apiKey }
                });

                if (!response.ok) {
                    console.error('Failed to fetch stats:', response.status);
                    return;
                }

                const data = await response.json();
                
                // Update stats
                document.getElementById('requestsToday').textContent = data.requestsToday || 0;
                document.getElementById('quotaRemaining').textContent = (data.monthlyQuota || 10000) - (data.used || 0);
                document.getElementById('hitRate').textContent = data.hitRate || 0;
                document.getElementById('totalHits').textContent = data.hits || 0;
                document.getElementById('totalMisses').textContent = data.misses || 0;
                document.getElementById('moneySaved').textContent = (data.costSaved || 0).toFixed(2);
                document.getElementById('latency').textContent = data.avgLatency || 0;
                document.getElementById('latencyP95').textContent = data.latencyP95 || 0;
                
                // Freshness distribution
                if (data.freshness) {
                    document.getElementById('freshCount').textContent = data.freshness.fresh || 0;
                    document.getElementById('staleCount').textContent = data.freshness.stale || 0;
                    document.getElementById('expiredCount').textContent = data.freshness.expired || 0;
                }
                
                document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }

        async function invalidateOldCaches() {
            if (!confirm('This will invalidate all caches older than 24 hours. Continue?')) return;
            
            try {
                const response = await fetch('/api/cache/invalidate', {
                    method: 'POST',
                    headers: {
                        'X-API-Key': apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        olderThan: 86400000, // 24 hours
                        reason: 'manual_cleanup'
                    })
                });

                const data = await response.json();
                alert(`Invalidated ${data.invalidated || 0} caches!`);
                fetchStats();
            } catch (error) {
                alert('Error invalidating caches: ' + error.message);
            }
        }

        function viewDocs() {
            window.open('/docs.html', '_blank');
        }

        function shareSavings() {
            const saved = document.getElementById('moneySaved').textContent;
            const text = `I saved $${saved} this month using @AgentCache! ðŸš€\n\nFree AI response caching with 95% cost reduction.\n\nhttps://agentcache.ai`;
            
            if (navigator.share) {
                navigator.share({ text });
            } else {
                navigator.clipboard.writeText(text);
                alert('Copied to clipboard! Share on Twitter/X');
            }
        }
    </script>
</body>
</html>
