<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings | AgentCache</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f9fafb;
    }

    .tab-active {
      background-color: #f3f4f6;
      color: #111827;
      border-right: 3px solid #0ea5e9;
    }

    .tab-inactive {
      color: #6b7280;
    }

    .tab-inactive:hover {
      background-color: #f9fafb;
      color: #374151;
    }
  </style>
</head>

<body class="flex h-screen overflow-hidden">

  <!-- Sidebar -->
  <aside class="w-64 bg-white border-r border-gray-200 flex flex-col">
    <div class="h-16 flex items-center px-6 border-b border-gray-100">
      <a href="/user-dashboard.html"
        class="flex items-center gap-2 text-gray-500 hover:text-gray-900 transition-colors">
        <iconify-icon icon="solar:arrow-left-linear"></iconify-icon>
        <span class="text-sm font-medium">Back to Workspace</span>
      </a>
    </div>

    <nav class="flex-1 p-4 space-y-1">
      <button onclick="switchTab('general')" id="tab-general"
        class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-l-lg transition-colors tab-active text-left">
        <iconify-icon icon="solar:settings-linear" class="text-lg"></iconify-icon> General
      </button>
      <button onclick="switchTab('robotics')" id="tab-robotics"
        class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-l-lg transition-colors tab-inactive text-left">
        <iconify-icon icon="solar:box-minimalistic-linear" class="text-lg"></iconify-icon> Robotics
      </button>
      <button onclick="switchTab('finance')" id="tab-finance"
        class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-l-lg transition-colors tab-inactive text-left">
        <iconify-icon icon="solar:wallet-money-linear" class="text-lg"></iconify-icon> Finance
      </button>
      <button onclick="switchTab('legal')" id="tab-legal"
        class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-l-lg transition-colors tab-inactive text-left">
        <iconify-icon icon="solar:scale-linear" class="text-lg"></iconify-icon> Legal
      </button>
      <button onclick="switchTab('security')" id="tab-security"
        class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-l-lg transition-colors tab-inactive text-left">
        <iconify-icon icon="solar:shield-keyhole-linear" class="text-lg"></iconify-icon> Security
      </button>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 overflow-y-auto p-8">
    <div class="max-w-2xl mx-auto">

      <div class="flex justify-between items-center mb-8">
        <h1 class="text-2xl font-bold text-gray-900" id="page-title">General Settings</h1>
        <span id="save-status" class="text-xs text-gray-400 font-medium opacity-0 transition-opacity">Saved</span>
      </div>

      <!-- GENERAL TAB -->
      <div id="content-general" class="space-y-6">
        <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
          <h2 class="text-base font-semibold text-gray-900 mb-4">Appearance</h2>
          <div class="grid grid-cols-3 gap-4">
            <label class="cursor-pointer">
              <input type="radio" name="theme" value="light" class="peer sr-only" onchange="saveSettings()">
              <div
                class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 peer-checked:border-blue-500 peer-checked:bg-blue-50 text-center transition-all">
                <iconify-icon icon="solar:sun-2-linear"
                  class="text-2xl mb-2 text-gray-500 peer-checked:text-blue-600"></iconify-icon>
                <div class="text-sm font-medium text-gray-700 peer-checked:text-blue-700">Light</div>
              </div>
            </label>
            <label class="cursor-pointer">
              <input type="radio" name="theme" value="dark" class="peer sr-only" onchange="saveSettings()">
              <div
                class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 peer-checked:border-blue-500 peer-checked:bg-blue-50 text-center transition-all">
                <iconify-icon icon="solar:moon-stars-linear"
                  class="text-2xl mb-2 text-gray-500 peer-checked:text-blue-600"></iconify-icon>
                <div class="text-sm font-medium text-gray-700 peer-checked:text-blue-700">Dark</div>
              </div>
            </label>
            <label class="cursor-pointer">
              <input type="radio" name="theme" value="system" class="peer sr-only" onchange="saveSettings()">
              <div
                class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 peer-checked:border-blue-500 peer-checked:bg-blue-50 text-center transition-all">
                <iconify-icon icon="solar:laptop-minimalistic-linear"
                  class="text-2xl mb-2 text-gray-500 peer-checked:text-blue-600"></iconify-icon>
                <div class="text-sm font-medium text-gray-700 peer-checked:text-blue-700">System</div>
              </div>
            </label>
          </div>
        </div>

        <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
          <h2 class="text-base font-semibold text-gray-900 mb-4">Notifications</h2>
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-medium text-gray-900">Enable Email Alerts</div>
              <div class="text-xs text-gray-500">Receive reports and critical alerts via email.</div>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="notif-toggle" class="sr-only peer" onchange="saveSettings()">
              <div
                class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- ROBOTICS TAB -->
      <div id="content-robotics" class="space-y-6 hidden">
        <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
          <h2 class="text-base font-semibold text-gray-900 mb-4">Motion Planning</h2>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Unit System</label>
              <select id="robot-units"
                class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500"
                onchange="saveSettings()">
                <option value="metric">Metric (Meters / Kg)</option>
                <option value="imperial">Imperial (Feet / Lbs)</option>
              </select>
            </div>

            <div>
              <div class="flex justify-between">
                <label class="block text-sm font-medium text-gray-700 mb-1">Safety Margin (Obstacle Buffer)</label>
                <span class="text-xs text-gray-500" id="safety-val">0.2m</span>
              </div>
              <input type="range" id="robot-margin" min="0.1" max="2.0" step="0.1" class="w-full"
                oninput="document.getElementById('safety-val').innerText = this.value + 'm'; saveSettings()">
            </div>
          </div>
        </div>
      </div>

      <!-- FINANCE TAB -->
      <div id="content-finance" class="space-y-6 hidden">
        <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
          <h2 class="text-base font-semibold text-gray-900 mb-4">Risk Profile</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tolerance Level</label>
              <select id="finance-risk"
                class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500"
                onchange="saveSettings()">
                <option value="conservative">Conservative (Low Yield / Safe)</option>
                <option value="moderate">Moderate (Balanced)</option>
                <option value="aggressive">Aggressive (High Alpha)</option>
              </select>
            </div>
          </div>
        </div>

        <!-- TREASURY MOCK -->
        <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-base font-semibold text-gray-900">Treasury & Billing</h2>
            <div class="text-right">
              <span class="block text-xs text-gray-500">Current Balance</span>
              <span class="block text-xl font-bold text-gray-900" id="wallet-balance">$0.00</span>
            </div>
          </div>

          <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
            <label class="block text-sm font-medium text-gray-700 mb-2">Add Funds (Mock Mode)</label>
            <div class="flex gap-2">
              <button onclick="deposit(10)"
                class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-100 transition-colors">+$10</button>
              <button onclick="deposit(100)"
                class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-100 transition-colors">+$100</button>
              <button onclick="deposit(1000)"
                class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-100 transition-colors">+$1,000</button>
              <button onclick="deposit(5000)"
                class="px-4 py-2 bg-gray-900 text-white border border-gray-900 rounded-lg text-sm font-medium hover:bg-gray-800 transition-colors ml-auto">Custom...</button>
            </div>
            <p class="text-xs text-gray-400 mt-2 flex items-center gap-1">
              <iconify-icon icon="solar:info-circle-linear"></iconify-icon>
              Payments are simulated. No real cards charged.
            </p>
          </div>

          <script>
            async function deposit(amount) {
              const btn = event.target;
              const oldText = btn.innerText;
              btn.innerText = "Processing...";
              btn.disabled = true;

              try {
                const token = localStorage.getItem('agentcache_token');
                const res = await fetch('/api/billing/deposit', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                  },
                  body: JSON.stringify({ amount })
                });
                const data = await res.json();

                if (data.success) {
                  document.getElementById('wallet-balance').innerText = '$' + data.balance.toFixed(2);
                  // Flash success
                  btn.className = "px-4 py-2 bg-emerald-500 text-white border border-emerald-500 rounded-lg text-sm font-medium transition-colors";
                  btn.innerText = "Success";
                  setTimeout(() => {
                    btn.className = "px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-100 transition-colors";
                    btn.innerText = oldText;
                    btn.disabled = false;
                  }, 2000);
                }
              } catch (e) {
                alert("Deposit failed: " + e.message);
                btn.innerText = "Error";
              }
            }
          </script>
        </div>
      </div>

      <!-- LEGAL TAB -->
      <div id="content-legal" class="space-y-6 hidden">
        <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
          <h2 class="text-base font-semibold text-gray-900 mb-4">Compliance Engine</h2>

          <div class="space-y-4">
            <div class="flex items-center gap-2">
              <input type="checkbox" id="legal-redact" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                onchange="saveSettings()">
              <label for="legal-redact" class="text-sm text-gray-700">Auto-Redact PII/PHI in Reports</label>
            </div>
            <div class="flex items-center gap-2">
              <input type="checkbox" id="legal-gdpr" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                onchange="saveSettings()">
              <label for="legal-gdpr" class="text-sm text-gray-700">Enforce GDPR Data Locality</label>
            </div>
          </div>
        </div>
      </div>

      <!-- SECURITY TAB -->
      <div id="content-security" class="space-y-6 hidden">
        <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
          <h2 class="text-base font-semibold text-gray-900 mb-4">Password</h2>
          <button
            class="w-full bg-gray-50 text-gray-700 font-medium py-2 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors"
            onclick="triggerReset()">
            Send Password Reset Email
          </button>
          <p class="text-xs text-gray-500 mt-2 text-center">We'll send a magic link to your registered email.</p>
        </div>
      </div>

    </div>
  </main>

  <script>
    // State
    const tabs = ['general', 'robotics', 'finance', 'legal', 'security'];
    const titles = {
      general: 'General Settings',
      robotics: 'Robotics Configuration',
      finance: 'Financial Risk Profile',
      legal: 'Compliance Settings',
      security: 'Security & Access'
    };

    async function init() {
      // Fetch current settings
      const token = localStorage.getItem('agentcache_token');
      if (!token && !localStorage.getItem('token')) {
        // Redirect if no auth? For demo we stay
      }

      try {
        const res = await fetch('/api/user/settings', {
          headers: { 'Authorization': `Bearer ${token || 'demo'}` }
        });
        const data = await res.json();

        // Populate Form
        // General
        if (data.themePref) {
          const radio = document.querySelector(`input[name="theme"][value="${data.themePref}"]`);
          if (radio) radio.checked = true;
        }
        document.getElementById('notif-toggle').checked = data.notificationsEnabled;

        // Sectors
        if (data.sectorConfig) {
          // Robotics
          if (data.sectorConfig.robotics) {
            document.getElementById('robot-units').value = data.sectorConfig.robotics.unit || 'metric';
            document.getElementById('robot-margin').value = data.sectorConfig.robotics.safetyMargin || 0.2;
            document.getElementById('safety-val').innerText = (data.sectorConfig.robotics.safetyMargin || 0.2) + 'm';
          }
          // Finance
          if (data.sectorConfig.finance) {
            document.getElementById('finance-risk').value = data.sectorConfig.finance.riskTolerance || 'moderate';
          }
          // Legal
          if (data.sectorConfig.legal) {
            document.getElementById('legal-redact').checked = !!data.sectorConfig.legal.autoRedact;
          }
        }

      } catch (e) { console.error("Fetch Settings Failed", e); }
    }

    function switchTab(id) {
      // Update Title
      document.getElementById('page-title').innerText = titles[id];

      // Toggle Content
      tabs.forEach(t => {
        const el = document.getElementById(`content-${t}`);
        const btn = document.getElementById(`tab-${t}`);
        if (t === id) {
          el.classList.remove('hidden');
          btn.classList.remove('tab-inactive');
          btn.classList.add('tab-active');
        } else {
          el.classList.add('hidden');
          btn.classList.remove('tab-active');
          btn.classList.add('tab-inactive');
        }
      });
    }

    let debounceTimer;
    function saveSettings() {
      // Show saving...
      const status = document.getElementById('save-status');
      status.innerText = "Saving...";
      status.style.opacity = 1;

      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(async () => {

        // Gather Data
        const payload = {
          themePref: document.querySelector('input[name="theme"]:checked')?.value || 'system',
          notificationsEnabled: document.getElementById('notif-toggle').checked,
          sectorConfig: {
            robotics: {
              unit: document.getElementById('robot-units').value,
              safetyMargin: parseFloat(document.getElementById('robot-margin').value)
            },
            finance: {
              riskTolerance: document.getElementById('finance-risk').value
            },
            legal: {
              autoRedact: document.getElementById('legal-redact').checked,
              // gdpr: ...
            }
          }
        };

        // Send API
        const token = localStorage.getItem('agentcache_token');
        try {
          await fetch('/api/user/settings', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(payload)
          });

          status.innerText = "Saved";
          setTimeout(() => status.style.opacity = 0, 1500);

        } catch (e) {
          status.innerText = "Error Saving";
          console.error(e);
        }

      }, 500); // 500ms debounce
    }

    async function triggerReset() {
      // Mock email for now since we don't have user object easily in frontend state without a fetch
      // But we can prompt or assume current user.
      const email = prompt("Confirm your email address:");
      if (email) {
        await fetch('/api/auth/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        alert("Reset link sent to console logs (Mock Mode)");
      }
    }

    // Init
    init();

  </script>
</body>

</html>