<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <title>AgentCache Studio v1.0</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Rajdhani:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Rajdhani', 'sans-serif'],
                        display: ['Orbitron', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    colors: {
                        metal: {
                            bg: '#0f1115',
                            panel: '#161920',
                            surface: '#1c2128',
                            border: '#2d3340',
                            highlight: '#3b4252',
                            text: '#e5e9f0',
                            dim: '#81a1c1',
                            accent: '#88c0d0', // Polished Blue
                            success: '#a3be8c',
                            warning: '#ebcb8b',
                            danger: '#bf616a'
                        }
                    },
                    boxShadow: {
                        'metal-glow': '0 0 20px rgba(136, 192, 208, 0.1)',
                        'panel-depth': '0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0f1115;
            background-image:
                radial-gradient(circle at 50% 0%, #232831 0%, transparent 70%),
                linear-gradient(0deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            color: #e5e9f0;
            overflow: hidden;
        }

        .metal-panel {
            background: linear-gradient(145deg, #1a1e26, #161920);
            border: 1px solid #2d3340;
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.05),
                0 4px 20px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        .metal-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(136, 192, 208, 0.3), transparent);
        }

        .metal-text-glow {
            text-shadow: 0 0 10px rgba(136, 192, 208, 0.3);
        }

        .metal-input {
            background: #13161c;
            border: 1px solid #2d3340;
            color: #e5e9f0;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.2s;
        }

        .metal-input:focus {
            outline: none;
            border-color: #88c0d0;
            box-shadow: 0 0 0 2px rgba(136, 192, 208, 0.1);
        }

        /* Polished Slider */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: linear-gradient(180deg, #e5e9f0, #88c0d0);
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            border: 1px solid #2d3340;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #2d3340;
            border-radius: 2px;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0f1115;
        }

        ::-webkit-scrollbar-thumb {
            background: #3b4252;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4c566a;
        }

        .node circle {
            stroke: #fff;
            stroke-width: 1.5px;
        }

        .link {
            stroke: #4c566a;
            stroke-opacity: 0.4;
        }
    </style>
</head>

<body class="h-screen flex flex-col p-4 gap-4">

    <!-- Header -->
    <header class="h-16 metal-panel rounded-lg flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center gap-4">
            <img src="/assets/logo.svg" class="h-8 w-8" onerror="this.style.display='none'">
            <!-- Fallback if no logo -->
            <div
                class="w-8 h-8 bg-gradient-to-br from-slate-700 to-slate-900 border border-slate-600 rounded flex items-center justify-center font-bold text-white font-display text-lg shadow-lg">
                A</div>
            <div>
                <h1 class="font-display text-2xl font-bold tracking-wider text-white metal-text-glow">AGENTCACHE <span
                        class="text-metal-accent">STUDIO</span> <span
                        class="text-xs align-top opacity-70 text-metal-dim">PRO</span></h1>
            </div>
        </div>

        <div class="flex items-center gap-8 font-mono text-sm">
            <div class="flex items-center gap-2">
                <span class="text-metal-dim">SYSTEM STATUS:</span>
                <span class="text-metal-accent metal-text-glow">OPTIMAL</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-metal-dim">CONNECTED AGENTS:</span>
                <span class="text-white" id="agent-count">--</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-metal-dim">DATA FLOW:</span>
                <span class="text-metal-success">STABLE</span>
            </div>
        </div>
    </header>

    <!-- Main Grid -->
    <div class="flex-1 grid grid-cols-12 gap-4 min-h-0">

        <!-- Left Column: Stats & Controls -->
        <div class="col-span-3 flex flex-col gap-4">

            <!-- CPU / Memory -->
            <div class="metal-panel rounded-lg p-4 flex flex-col gap-4">
                <div class="flex justify-between items-center border-b border-metal-border pb-2">
                    <span class="font-display font-bold text-metal-dim text-sm">SYSTEM RESOURCES</span>
                    <svg class="w-4 h-4 text-metal-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z">
                        </path>
                    </svg>
                </div>

                <div class="flex items-center gap-4">
                    <!-- CPU Donut (SVG) -->
                    <div class="relative w-20 h-20 flex items-center justify-center">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="40" cy="40" r="36" stroke="#2d3340" stroke-width="8" fill="none"></circle>
                            <circle id="cpu-circle" cx="40" cy="40" r="36" stroke="#88c0d0" stroke-width="8" fill="none"
                                stroke-dasharray="226" stroke-dashoffset="180"></circle>
                        </svg>
                        <div class="absolute text-center">
                            <div class="text-xs text-metal-dim">CPU</div>
                            <div class="font-mono font-bold text-white" id="cpu-text">0%</div>
                        </div>
                    </div>

                    <!-- Memory Graph (SVG Line) -->
                    <div class="flex-1 h-16 flex flex-col justify-end">
                        <div class="text-xs text-metal-dim mb-1">MEMORY ALLOCATION</div>
                        <div class="flex justify-between text-xs font-mono text-white mb-1">
                            <span id="mem-used">0 GB</span>
                            <span class="text-metal-dim">/ 64 GB</span>
                        </div>
                        <div class="w-full h-1 bg-metal-border rounded-full overflow-hidden">
                            <div id="mem-bar" class="h-full bg-metal-accent w-0 transition-all duration-500"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agent Constraints -->
            <div class="metal-panel rounded-lg p-4 flex-1 flex flex-col gap-4 overflow-y-auto">
                <div class="flex justify-between items-center border-b border-metal-border pb-2">
                    <span class="font-display font-bold text-metal-dim text-sm">AGENT CONSTRAINTS</span>
                    <svg class="w-4 h-4 text-metal-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4">
                        </path>
                    </svg>
                </div>

                <div class="space-y-6">
                    <!-- Tone -->
                    <div>
                        <div class="flex justify-between text-xs font-mono mb-2">
                            <span class="text-metal-text">TONE: <span
                                    class="text-metal-accent">PROFESSIONAL</span></span>
                            <span class="text-metal-dim">0.8</span>
                        </div>
                        <input type="range" min="0" max="100" value="80" class="w-full">
                    </div>

                    <!-- Creativity -->
                    <div>
                        <div class="flex justify-between text-xs font-mono mb-2">
                            <span class="text-metal-text">CREATIVITY: <span
                                    class="text-metal-accent">CONTROLLED</span></span>
                            <span class="text-metal-dim">0.5</span>
                        </div>
                        <input type="range" min="0" max="100" value="50" class="w-full">
                    </div>

                    <!-- Max Depth -->
                    <div>
                        <div class="flex justify-between text-xs font-mono mb-2">
                            <span class="text-metal-text">MAX DEPTH: <span class="text-metal-accent">64
                                    LEVELS</span></span>
                        </div>
                        <input type="range" min="0" max="100" value="64" class="w-full">
                    </div>

                    <!-- Toggles -->
                    <div class="space-y-3 pt-4 border-t border-metal-border">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-mono text-metal-text">ETHICAL FILTERS</span>
                            <div class="w-10 h-5 bg-metal-accent/20 rounded-full relative cursor-pointer">
                                <div class="absolute right-1 top-1 w-3 h-3 bg-metal-accent rounded-full shadow-sm">
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-mono text-metal-text">MEMORY PERSISTENCE</span>
                            <div class="w-10 h-5 bg-metal-accent/20 rounded-full relative cursor-pointer">
                                <div class="absolute right-1 top-1 w-3 h-3 bg-metal-accent rounded-full shadow-sm">
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-mono text-metal-text">EXTERNAL ACCESS</span>
                            <div class="w-10 h-5 bg-metal-border rounded-full relative cursor-pointer">
                                <div class="absolute left-1 top-1 w-3 h-3 bg-metal-dim rounded-full"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center: Memory Graph -->
        <div class="col-span-6 flex flex-col gap-4">
            <div class="metal-panel rounded-lg flex-1 relative overflow-hidden group">
                <div class="absolute top-0 left-0 p-4 z-10 w-full flex justify-between items-start pointer-events-none">
                    <div>
                        <h2 class="font-display font-bold text-white text-lg">MEMORY GRAPH</h2>
                        <div class="text-xs text-metal-dim font-mono">VISUALIZING KNOWLEDGE TOPOLOGY</div>
                    </div>
                    <div class="flex gap-2 pointer-events-auto">
                        <button class="p-2 hover:bg-white/5 rounded transition text-metal-accent"><svg class="w-4 h-4"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                                </path>
                            </svg></button>
                        <button class="p-2 hover:bg-white/5 rounded transition text-metal-accent"><svg class="w-4 h-4"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4">
                                </path>
                            </svg></button>
                    </div>
                </div>

                <!-- D3 Graph Container -->
                <div id="graph-container" class="w-full h-full"></div>
            </div>
        </div>

        <!-- Right Column: Cache Stats & Logs -->
        <div class="col-span-3 flex flex-col gap-4">

            <!-- Cache Hit Rate -->
            <div class="metal-panel rounded-lg p-4 h-48 flex flex-col">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-display font-bold text-metal-dim text-sm">CACHE HIT RATE</span>
                    <svg class="w-4 h-4 text-metal-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
                <div class="text-4xl font-mono font-bold text-metal-accent metal-text-glow mb-4" id="hit-rate">--%</div>

                <!-- Mini Chart (SVG) -->
                <div class="flex-1 relative">
                    <svg class="w-full h-full" preserveAspectRatio="none">
                        <path d="M0,50 Q20,40 40,45 T80,30 T120,20 T160,35 T200,10 L200,60 L0,60 Z"
                            fill="rgba(136, 192, 208, 0.1)" stroke="none"></path>
                        <path d="M0,50 Q20,40 40,45 T80,30 T120,20 T160,35 T200,10" fill="none" stroke="#88c0d0"
                            stroke-width="2"></path>
                    </svg>
                </div>

                <div class="flex justify-between items-end mt-2">
                    <div>
                        <div class="text-xs text-metal-dim">LATENCY</div>
                        <div class="font-mono text-white text-lg" id="latency">--ms</div>
                    </div>
                    <!-- Audio Viz Bars -->
                    <div class="flex gap-1 items-end h-8">
                        <div class="w-1 bg-metal-accent h-4 animate-pulse"></div>
                        <div class="w-1 bg-metal-accent h-6 animate-pulse" style="animation-delay: 0.1s"></div>
                        <div class="w-1 bg-metal-accent h-3 animate-pulse" style="animation-delay: 0.2s"></div>
                        <div class="w-1 bg-metal-accent h-7 animate-pulse" style="animation-delay: 0.3s"></div>
                        <div class="w-1 bg-metal-accent h-5 animate-pulse" style="animation-delay: 0.4s"></div>
                    </div>
                </div>
            </div>

            <!-- Live Stream -->
            <div class="metal-panel rounded-lg p-4 flex-1 flex flex-col overflow-hidden">
                <div class="flex justify-between items-center border-b border-metal-border pb-2 mb-2">
                    <span class="font-display font-bold text-metal-dim text-sm">LIVE STREAM - LOG OUTPUT</span>
                    <div class="flex gap-1">
                        <div class="w-2 h-2 rounded-full bg-metal-dim"></div>
                        <div class="w-2 h-2 rounded-full bg-metal-dim"></div>
                        <div class="w-2 h-2 rounded-full bg-metal-dim"></div>
                    </div>
                </div>

                <div id="log-container"
                    class="flex-1 overflow-y-auto font-mono text-xs space-y-1 text-metal-text opacity-80">
                    <!-- Logs will be injected here -->
                    <div class="text-metal-dim">[SYSTEM] Initializing AgentCache Studio...</div>
                </div>

                <!-- Audio Waveform at bottom -->
                <div class="h-8 w-full mt-2 opacity-50">
                    <svg class="w-full h-full" preserveAspectRatio="none">
                        <path d="M0,15 Q10,5 20,15 T40,15 T60,15 T80,15 T100,15 T120,15 T140,15 T160,15 T180,15 T200,15"
                            fill="none" stroke="#88c0d0" stroke-width="1" class="animate-pulse"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- D3 Graph Visualization ---
        function initGraph(data) {
            const container = document.getElementById('graph-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Clear previous
            d3.select("#graph-container").selectAll("*").remove();

            const svg = d3.select("#graph-container")
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            const simulation = d3.forceSimulation(data.nodes)
                .force("link", d3.forceLink(data.links).id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2));

            const link = svg.append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(data.links)
                .enter().append("line")
                .attr("stroke", "#00f0ff")
                .attr("stroke-opacity", 0.4)
                .attr("stroke-width", 1);

            // Node Groups
            const node = svg.append("g")
                .attr("class", "nodes")
                .selectAll("g")
                .data(data.nodes)
                .enter().append("g")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            // Outer Glow
            node.append("circle")
                .attr("r", d => d.size + 4)
                .attr("fill", d => d.group === 1 ? "rgba(136, 192, 208, 0.1)" : "rgba(94, 129, 172, 0.1)")
                .attr("class", "animate-pulse");

            // Core Node
            node.append("circle")
                .attr("r", d => d.size)
                .attr("fill", "#1a1e26")
                .attr("stroke", d => d.group === 1 ? "#88c0d0" : "#5e81ac")
                .attr("stroke-width", 2);

            // Inner Dot
            node.append("circle")
                .attr("r", 4)
                .attr("fill", d => d.group === 1 ? "#88c0d0" : "#5e81ac");

            // Labels
            node.append("text")
                .text(d => d.id)
                .attr("x", 0)
                .attr("y", d => -d.size - 5)
                .attr("text-anchor", "middle")
                .attr("font-family", "JetBrains Mono")
                .attr("font-size", "10px")
                .attr("fill", "#e5e9f0")
                .style("text-shadow", "0 0 5px rgba(0,0,0,0.8)");

            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("transform", d => `translate(${d.x},${d.y})`);
            });

            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }

        // --- Real-time Data Fetching ---
        async function fetchData() {
            try {
                const res = await fetch('/api/studio/stats');
                const data = await res.json();

                // Update System Stats
                const cpuPercent = data.system.cpu;
                const cpuCircle = document.getElementById('cpu-circle');
                const circumference = 2 * Math.PI * 36;
                const offset = circumference - (cpuPercent / 100) * circumference;
                cpuCircle.style.strokeDashoffset = offset;
                document.getElementById('cpu-text').innerText = `${cpuPercent}%`;

                document.getElementById('mem-used').innerText = `${data.system.memory.used} GB`;
                const memPercent = (data.system.memory.used / data.system.memory.total) * 100;
                document.getElementById('mem-bar').style.width = `${memPercent}%`;

                // Update Agent Stats
                document.getElementById('agent-count').innerText = data.agents.connected;

                // Update Cache Stats
                document.getElementById('hit-rate').innerText = `${data.cache.hitRate}%`;
                document.getElementById('latency').innerText = `${data.cache.latency}ms`;

                // Update Graph (Only if data changed significantly, or init)
                if (!window.graphInitialized && data.graph) {
                    initGraph(data.graph);
                    window.graphInitialized = true;
                }

                // Add Log Entry (Simulated)
                addLogEntry();

            } catch (err) {
                console.error("Failed to fetch stats", err);
            }
        }

        function addLogEntry() {
            const logs = [
                "AGENT_BETA executing knowledge retrieval on 'Project_Titan'",
                "CACHE HIT: Req#8922 updated auth token interaction data",
                "SYSTEM: Re-indexing graph complete. Latency: 12ms",
                "WARNING: Agent_Delta approaching constraint limit on 'CREATIVITY'",
                "AGENT_ALPHA successfully merged knowledge from 'SOURCE: EXTERNAL_DB_01'",
                "CACHE_MANAGER: Optimizing storage...",
                "PII_GUARD: Redacted SSN from input stream [TraceID: 9921]"
            ];
            const randomLog = logs[Math.floor(Math.random() * logs.length)];
            const time = new Date().toLocaleTimeString();

            const container = document.getElementById('log-container');
            const div = document.createElement('div');
            div.innerHTML = `<span class="text-metal-dim">[${time}]</span> ${randomLog}`;
            container.prepend(div); // Add to top

            if (container.children.length > 20) {
                container.lastElementChild.remove();
            }
        }

        // Loop
        setInterval(fetchData, 2000);
        fetchData(); // Init

        // Window Resize for Graph
        window.addEventListener('resize', () => {
            window.graphInitialized = false; // Force re-render
            fetchData();
        });

    </script>
</body>

</html>