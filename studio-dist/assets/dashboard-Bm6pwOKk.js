import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css              */import{r as D,j as b,R as K,a as aw,g as $x,b as cw}from"./client-DwJ0wxic.js";import{u as lw,C as ml,R as Vx,M as vt,T as dr,V as Te,P as xl,a as le,b as En,G as zx,c as wn,S as ef,d as un,e as jx,B as sa,f as hc,L as uw,g as Hx,h as Wx,i as dw,Q as hw,j as qx,k as fw,l as pw,w as se,H as Ft,m as tf,N as xi,n as gw,o as yl,p as lt,q as ie,r as ut,s as Is,t as Sn,v as _n,x as Ze,F as mw,y as xw,z as jt,A as Ao,D as vi,W as Pc,E as Ln,I as yw,J as Xx,K as bw,O as nf,U as Yx,X as _w,Y as vw,Z as Tw,_ as ww,$ as Sw,a0 as Nw,a1 as Ew,a2 as Aw,a3 as rf,a4 as Kx,a5 as $n,a6 as sf,a7 as Dp,a8 as Go,a9 as Rw,aa as Cw,ab as Qt,ac as Lr,ad as dt,ae as Or,af as Ur,ag as Mr,ah as Ro,ai as ar,aj as Rr,ak as bs,al as Mw,am as of,an as af,ao as Nd,ap as cf,aq as lf,ar as rs,as as ye,at as Pw,au as oa,av as bl,aw as _l,ax as Dw,ay as Pt,az as vl,aA as $o,aB as Tl,aC as Ti,aD as Ed,aE as Vo,aF as Qx,aG as xn,aH as Zx,aI as Jx,aJ as ey,aK as ty,aL as ny,aM as uf,aN as ry,aO as iy,aP as Bp,aQ as _s,aR as nn,aS as Bw,aT as sy,aU as oy,aV as ay,aW as cy,aX as ly,aY as uy,aZ as dy,a_ as hy,a$ as fy,b0 as py,b1 as gy,b2 as my,b3 as Fw,b4 as kw,b5 as Iw,b6 as vs,b7 as Dc,b8 as Bc,b9 as Fc,ba as wi,bb as xy,bc as yy,bd as by,be as _y,bf as vy,bg as Ty,bh as wy,bi as Sy,bj as Lw,bk as Ow,bl as Ny,bm as Ey,bn as Co,bo as Mo,bp as is,bq as Uw,br as df,bs as hf,bt as ff,bu as Fr,bv as pf,bw as gf,bx as fc,by as pc,bz as gc,bA as mc,bB as Fp,bC as kp,bD as Ip,bE as Lp,bF as Ad,bG as Rd,bH as Cd,bI as Md,bJ as Pd,bK as Dd,bL as Bd,bM as Fd,bN as kd,bO as Id,bP as Ld,bQ as Od,bR as Ud,bS as Gd,bT as $d,bU as Vd,bV as zd,bW as jd,bX as Hd,bY as Wd,bZ as qd,b_ as Xd,b$ as Ay,c0 as Gw,c1 as $w,c2 as Vw,c3 as zw,c4 as jw,c5 as Hw,c6 as Ww,c7 as qw,c8 as Xw,c9 as Yw,ca as kc,cb as Kw,cc as Qw,cd as Zw,ce as Jw,cf as Ry,cg as eS,ch as tS,ci as nS,cj as rS,ck as iS,cl as sS,cm as oS,cn as aS,co as cS,cp as lS,cq as uS,cr as dS,cs as hS,ct as fS,cu as pS,cv as gS,cw as mS,cx as xS,cy as Cy,cz as yS,cA as bS,cB as _S,cC as vS,cD as Ic,cE as TS,cF as My,cG as wS,cH as Py,cI as SS,cJ as NS,cK as ES,cL as xc,cM as Lc,cN as Oc,cO as Op,cP as AS,cQ as RS,cR as CS,cS as MS,cT as PS,cU as DS,cV as BS,cW as FS,cX as kS,cY as Up,cZ as IS,c_ as Gp,c$ as LS,d0 as OS,d1 as Dy,d2 as cn,d3 as US,d4 as GS}from"./extends-EVGp5csO.js";const $S=n=>n.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),VS=n=>n.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,t,r)=>r?r.toUpperCase():t.toLowerCase()),$p=n=>{const e=VS(n);return e.charAt(0).toUpperCase()+e.slice(1)},By=(...n)=>n.filter((e,t,r)=>!!e&&e.trim()!==""&&r.indexOf(e)===t).join(" ").trim(),zS=n=>{for(const e in n)if(e.startsWith("aria-")||e==="role"||e==="title")return!0};var jS={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};const HS=D.forwardRef(({color:n="currentColor",size:e=24,strokeWidth:t=2,absoluteStrokeWidth:r,className:i="",children:s,iconNode:o,...a},c)=>D.createElement("svg",{ref:c,...jS,width:e,height:e,stroke:n,strokeWidth:r?Number(t)*24/Number(e):t,className:By("lucide",i),...!s&&!zS(a)&&{"aria-hidden":"true"},...a},[...o.map(([l,u])=>D.createElement(l,u)),...Array.isArray(s)?s:[s]]));const Ve=(n,e)=>{const t=D.forwardRef(({className:r,...i},s)=>D.createElement(HS,{ref:s,iconNode:e,className:By(`lucide-${$S($p(n))}`,`lucide-${n}`,r),...i}));return t.displayName=$p(n),t};const WS=[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]],yr=Ve("activity",WS);const qS=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]],mf=Ve("arrow-right",qS);const XS=[["path",{d:"M10.268 21a2 2 0 0 0 3.464 0",key:"vwvbt9"}],["path",{d:"M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326",key:"11g9vi"}]],YS=Ve("bell",XS);const KS=[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],QS=Ve("clock",KS);const ZS=[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]],Yd=Ve("database",ZS);const JS=[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],eN=Ve("eye",JS);const tN=[["path",{d:"M14 2v6a2 2 0 0 0 .245.96l5.51 10.08A2 2 0 0 1 18 22H6a2 2 0 0 1-1.755-2.96l5.51-10.08A2 2 0 0 0 10 8V2",key:"18mbvz"}],["path",{d:"M6.453 15h11.094",key:"3shlmq"}],["path",{d:"M8.5 2h7",key:"csnxdl"}]],Fy=Ve("flask-conical",tN);const nN=[["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}],["line",{x1:"3",x2:"9",y1:"12",y2:"12",key:"1dyftd"}],["line",{x1:"15",x2:"21",y1:"12",y2:"12",key:"oup4p8"}]],Vp=Ve("git-commit-horizontal",nN);const rN=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]],zp=Ve("globe",rN);const iN=[["path",{d:"M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z",key:"yt0hxn"}]],sN=Ve("hexagon",iN);const oN=[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z",key:"zw3jo"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12",key:"1wduqc"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17",key:"kqbvx6"}]],jp=Ve("layers",oN);const aN=[["rect",{width:"7",height:"7",x:"3",y:"3",rx:"1",key:"1g98yp"}],["rect",{width:"7",height:"7",x:"14",y:"3",rx:"1",key:"6d4xhi"}],["rect",{width:"7",height:"7",x:"14",y:"14",rx:"1",key:"nxv5o0"}],["rect",{width:"7",height:"7",x:"3",y:"14",rx:"1",key:"1bb6yr"}]],cN=Ve("layout-grid",aN);const lN=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]],uN=Ve("lock",lN);const dN=[["path",{d:"m16 17 5-5-5-5",key:"1bji2h"}],["path",{d:"M21 12H9",key:"dn1m92"}],["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}]],hN=Ve("log-out",dN);const fN=[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]],pN=Ve("play",fN);const gN=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],mN=Ve("plus",gN);const xN=[["path",{d:"M16.247 7.761a6 6 0 0 1 0 8.478",key:"1fwjs5"}],["path",{d:"M19.075 4.933a10 10 0 0 1 0 14.134",key:"ehdyv1"}],["path",{d:"M4.925 19.067a10 10 0 0 1 0-14.134",key:"1q22gi"}],["path",{d:"M7.753 16.239a6 6 0 0 1 0-8.478",key:"r2q7qm"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}]],ky=Ve("radio",xN);const yN=[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]],bN=Ve("save",yN);const _N=[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]],Kd=Ve("search",_N);const vN=[["rect",{width:"20",height:"8",x:"2",y:"2",rx:"2",ry:"2",key:"ngkwjq"}],["rect",{width:"20",height:"8",x:"2",y:"14",rx:"2",ry:"2",key:"iecqi9"}],["line",{x1:"6",x2:"6.01",y1:"6",y2:"6",key:"16zg32"}],["line",{x1:"6",x2:"6.01",y1:"18",y2:"18",key:"nzw8ys"}]],TN=Ve("server",vN);const wN=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]],Iy=Ve("shield",wN);const SN=[["path",{d:"M12 19h8",key:"baeox8"}],["path",{d:"m4 17 6-6-6-6",key:"1yngyt"}]],NN=Ve("terminal",SN);const EN=[["path",{d:"M10 14.66v1.626a2 2 0 0 1-.976 1.696A5 5 0 0 0 7 21.978",key:"1n3hpd"}],["path",{d:"M14 14.66v1.626a2 2 0 0 0 .976 1.696A5 5 0 0 1 17 21.978",key:"rfe1zi"}],["path",{d:"M18 9h1.5a1 1 0 0 0 0-5H18",key:"7xy6bh"}],["path",{d:"M4 22h16",key:"57wxv0"}],["path",{d:"M6 9a6 6 0 0 0 12 0V3a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1z",key:"1mhfuq"}],["path",{d:"M6 9H4.5a1 1 0 0 1 0-5H6",key:"tex48p"}]],AN=Ve("trophy",EN);const RN=[["path",{d:"m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72",key:"ul74o6"}],["path",{d:"m14 7 3 3",key:"1r5n42"}],["path",{d:"M5 6v4",key:"ilb8ba"}],["path",{d:"M19 14v4",key:"blhpug"}],["path",{d:"M10 2v2",key:"7u0qdc"}],["path",{d:"M7 8H3",key:"zfb6yr"}],["path",{d:"M21 16h-4",key:"1cnmox"}],["path",{d:"M11 3H9",key:"1obp7u"}]],CN=Ve("wand-sparkles",RN);const MN=[["rect",{width:"8",height:"8",x:"3",y:"3",rx:"2",key:"by2w9f"}],["path",{d:"M7 11v4a2 2 0 0 0 2 2h4",key:"xkn7yn"}],["rect",{width:"8",height:"8",x:"13",y:"13",rx:"2",key:"1cgmvn"}]],PN=Ve("workflow",MN);const DN=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],BN=Ve("x",DN);const FN=[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]],Ly=Ve("zap",FN),kN=({activeView:n,setActiveView:e,user:t})=>{const[r,i]=D.useState(!1),s=[{id:"overview",label:"Overview",icon:cN},{id:"pipeline",label:"Pipeline Studio",icon:PN},{id:"swarm",label:"Swarm Intelligence",icon:sN},{id:"observability",label:"Observability",icon:yr},{id:"lab",label:"Research Lab",icon:Fy},{id:"data",label:"Data Explorer",icon:Yd},{id:"governance",label:"Governance",icon:Iy}];return b.jsxs("div",{className:`fixed left-0 top-16 bottom-0 z-40 flex flex-col bg-[rgba(6,11,20,0.95)] border-r border-[rgba(0,243,255,0.2)] backdrop-blur-xl transition-all duration-300 ${r?"w-64":"w-16"}`,onMouseEnter:()=>i(!0),onMouseLeave:()=>i(!1),children:[b.jsx("div",{className:"flex-1 py-6 flex flex-col gap-2",children:s.map(o=>{const a=o.icon,c=n===o.id;return b.jsxs("button",{onClick:()=>e(o.id),className:`relative flex items-center h-12 px-4 mx-2 rounded-lg transition-all duration-200 group ${c?"bg-[rgba(0,243,255,0.1)] text-[var(--hud-accent)] shadow-[0_0_15px_rgba(0,243,255,0.2)]":"text-[var(--hud-text-dim)] hover:bg-[rgba(255,255,255,0.05)] hover:text-white"}`,children:[b.jsx(a,{size:20,className:`min-w-[20px] transition-transform duration-300 ${c?"scale-110":"group-hover:scale-110"}`}),b.jsx("span",{className:`ml-4 font-['Rajdhani'] font-semibold tracking-wide whitespace-nowrap overflow-hidden transition-all duration-300 ${r?"opacity-100 w-auto":"opacity-0 w-0"}`,children:o.label}),c&&b.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 w-1 h-6 bg-[var(--hud-accent)] rounded-r-full shadow-[0_0_10px_var(--hud-accent)]"})]},o.id)})}),b.jsxs("div",{className:"p-2 border-t border-[rgba(0,243,255,0.1)]",children:[b.jsxs("div",{className:`flex items-center p-2 rounded-lg bg-[rgba(0,0,0,0.3)] border border-[rgba(255,255,255,0.05)] ${r?"justify-start":"justify-center"}`,children:[b.jsx("div",{className:"w-8 h-8 rounded bg-gradient-to-br from-[var(--hud-accent)] to-[var(--hud-accent-secondary)] flex items-center justify-center text-black font-bold text-xs shadow-[0_0_10px_rgba(0,243,255,0.3)]",children:t?.name?.charAt(0)||"G"}),b.jsxs("div",{className:`ml-3 overflow-hidden transition-all duration-300 ${r?"w-auto opacity-100":"w-0 opacity-0"}`,children:[b.jsx("div",{className:"text-sm font-bold text-white truncate",children:t?.name||"Guest"}),b.jsx("div",{className:"text-xs text-[var(--hud-accent)] font-mono",children:t?.role||"Viewer"})]})]}),b.jsxs("button",{onClick:()=>{localStorage.removeItem("agentcache_token"),localStorage.removeItem("agentcache_user"),window.location.href="/login.html"},className:`mt-2 w-full flex items-center justify-center h-10 rounded-lg text-red-400 hover:bg-red-500/10 hover:text-red-300 transition-colors ${!r&&"hidden"}`,children:[b.jsx(hN,{size:16,className:"mr-2"}),b.jsx("span",{className:"font-['Rajdhani'] font-semibold",children:"LOGOUT"})]})]})]})},IN=()=>{const[n,e]=D.useState(new Date),[t,r]=D.useState(!1);return D.useEffect(()=>{const i=setInterval(()=>e(new Date),1e3),s=()=>r(window.scrollY>20);return window.addEventListener("scroll",s),()=>{clearInterval(i),window.removeEventListener("scroll",s)}},[]),b.jsx("header",{className:`fixed top-0 left-0 right-0 h-16 z-50 transition-all duration-300 ${t?"bg-[rgba(3,5,8,0.9)] backdrop-blur-md border-b border-[rgba(0,243,255,0.2)]":"bg-transparent border-b border-transparent"}`,children:b.jsxs("div",{className:"h-full px-6 flex items-center justify-between",children:[b.jsxs("div",{className:"flex items-center gap-4",children:[b.jsxs("div",{className:"relative group cursor-pointer",children:[b.jsx("div",{className:"absolute -inset-1 bg-gradient-to-r from-[var(--hud-accent)] to-[var(--hud-accent-secondary)] rounded-lg blur opacity-40 group-hover:opacity-75 transition duration-500"}),b.jsx("div",{className:"relative w-10 h-10 bg-black border border-[var(--hud-accent)] rounded-lg flex items-center justify-center",children:b.jsx("div",{className:"w-4 h-4 bg-[var(--hud-accent)] rotate-45 group-hover:rotate-90 transition-transform duration-500"})})]}),b.jsxs("div",{children:[b.jsxs("h1",{className:"text-xl font-['Rajdhani'] font-bold tracking-widest text-white",children:["AGENT",b.jsx("span",{className:"text-[var(--hud-accent)]",children:"CACHE"})]}),b.jsxs("div",{className:"flex items-center gap-2 text-[10px] font-mono text-[var(--hud-text-dim)]",children:[b.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"}),"SYSTEM ONLINE"]})]})]}),b.jsxs("div",{className:"hidden md:flex items-center gap-8 px-8 py-2 bg-[rgba(255,255,255,0.03)] rounded-full border border-[rgba(255,255,255,0.05)]",children:[b.jsxs("div",{className:"flex items-center gap-2",children:[b.jsx("span",{className:"text-[10px] text-[var(--hud-text-dim)] uppercase tracking-wider",children:"Grid Status"}),b.jsx("span",{className:"text-xs font-mono text-[var(--hud-success)]",children:"OPTIMAL"})]}),b.jsx("div",{className:"w-px h-4 bg-[rgba(255,255,255,0.1)]"}),b.jsxs("div",{className:"flex items-center gap-2",children:[b.jsx("span",{className:"text-[10px] text-[var(--hud-text-dim)] uppercase tracking-wider",children:"Latency"}),b.jsx("span",{className:"text-xs font-mono text-[var(--hud-accent)]",children:"42ms"})]}),b.jsx("div",{className:"w-px h-4 bg-[rgba(255,255,255,0.1)]"}),b.jsxs("div",{className:"flex items-center gap-2",children:[b.jsx("span",{className:"text-[10px] text-[var(--hud-text-dim)] uppercase tracking-wider",children:"Active Agents"}),b.jsx("span",{className:"text-xs font-mono text-white",children:"8,492"})]})]}),b.jsxs("div",{className:"flex items-center gap-6",children:[b.jsxs("div",{className:"flex items-center gap-4",children:[b.jsx("button",{className:"text-[var(--hud-text-dim)] hover:text-white transition-colors",children:b.jsx(Kd,{size:20})}),b.jsxs("button",{className:"relative text-[var(--hud-text-dim)] hover:text-white transition-colors",children:[b.jsx(YS,{size:20}),b.jsx("span",{className:"absolute -top-1 -right-1 w-2 h-2 bg-[var(--hud-accent)] rounded-full animate-pulse"})]})]}),b.jsxs("div",{className:"text-right hidden sm:block",children:[b.jsx("div",{className:"text-sm font-mono font-bold text-white",children:n.toLocaleTimeString([],{hour12:!1})}),b.jsx("div",{className:"text-[10px] font-mono text-[var(--hud-text-dim)]",children:"UTC"})]})]})]})})},Le=({title:n,children:e,className:t="",icon:r,action:i})=>b.jsxs("div",{className:`relative group bg-[var(--hud-panel-bg)] border border-[var(--hud-border)] rounded-lg overflow-hidden transition-all duration-300 hover:shadow-[0_0_20px_rgba(0,243,255,0.1)] hover:border-[var(--hud-accent)] ${t}`,children:[b.jsx("div",{className:"absolute top-0 left-0 w-2 h-2 border-t-2 border-l-2 border-[var(--hud-accent)] opacity-50 group-hover:opacity-100 transition-opacity"}),b.jsx("div",{className:"absolute top-0 right-0 w-2 h-2 border-t-2 border-r-2 border-[var(--hud-accent)] opacity-50 group-hover:opacity-100 transition-opacity"}),b.jsx("div",{className:"absolute bottom-0 left-0 w-2 h-2 border-b-2 border-l-2 border-[var(--hud-accent)] opacity-50 group-hover:opacity-100 transition-opacity"}),b.jsx("div",{className:"absolute bottom-0 right-0 w-2 h-2 border-b-2 border-r-2 border-[var(--hud-accent)] opacity-50 group-hover:opacity-100 transition-opacity"}),(n||r)&&b.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-[var(--hud-border)] bg-[rgba(0,0,0,0.2)]",children:[b.jsxs("div",{className:"flex items-center gap-3",children:[r&&b.jsx(r,{size:18,className:"text-[var(--hud-accent)]"}),b.jsxs("h3",{className:"font-['Rajdhani'] font-bold text-lg tracking-wider text-white uppercase",children:[b.jsx("span",{className:"text-[var(--hud-accent)] mr-2",children:"::"}),n]})]}),i&&b.jsx("div",{className:"text-sm",children:i})]}),b.jsx("div",{className:"p-6",children:e})]}),ba=({value:n,max:e=100,label:t,sublabel:r,color:i="var(--hud-accent)"})=>{const s=Math.min(100,Math.max(0,n/e*100)),o=36,a=2*Math.PI*o,c=a-s/100*a;return b.jsxs("div",{className:"flex flex-col items-center justify-center",children:[b.jsxs("div",{className:"relative w-32 h-32 flex items-center justify-center",children:[b.jsxs("svg",{className:"w-full h-full transform -rotate-90",children:[b.jsx("circle",{cx:"64",cy:"64",r:o,stroke:"rgba(255,255,255,0.1)",strokeWidth:"8",fill:"transparent"}),b.jsx("circle",{cx:"64",cy:"64",r:o,stroke:i,strokeWidth:"8",fill:"transparent",strokeDasharray:a,strokeDashoffset:c,strokeLinecap:"round",className:"transition-all duration-1000 ease-out",style:{filter:`drop-shadow(0 0 4px ${i})`}})]}),b.jsx("div",{className:"absolute inset-0 flex flex-col items-center justify-center",children:b.jsxs("span",{className:"text-2xl font-['Rajdhani'] font-bold text-white",children:[n,"%"]})})]}),b.jsxs("div",{className:"text-center mt-2",children:[b.jsx("div",{className:"text-sm font-bold text-white tracking-wide",children:t}),r&&b.jsx("div",{className:"text-xs text-[var(--hud-text-dim)]",children:r})]})]})},Uc=({columns:n,data:e,onRowClick:t})=>b.jsx("div",{className:"w-full overflow-x-auto",children:b.jsxs("table",{className:"w-full text-left border-collapse",children:[b.jsx("thead",{children:b.jsx("tr",{className:"border-b border-[var(--hud-border)]",children:n.map((r,i)=>b.jsx("th",{className:"py-3 px-4 text-xs font-['Rajdhani'] font-bold text-[var(--hud-text-dim)] uppercase tracking-wider whitespace-nowrap bg-[rgba(0,0,0,0.2)]",children:r.header},i))})}),b.jsx("tbody",{className:"font-mono text-sm",children:e.map((r,i)=>b.jsx("tr",{onClick:()=>t&&t(r),className:`
                border-b border-[rgba(255,255,255,0.05)] transition-colors duration-200
                ${t?"cursor-pointer hover:bg-[rgba(0,243,255,0.05)]":""}
                group
              `,children:n.map((s,o)=>b.jsx("td",{className:"py-3 px-4 text-white group-hover:text-[var(--hud-accent)] transition-colors",children:s.render?s.render(r):r[s.accessor]},o))},r.id||i))})]})}),Hp=()=>{const[n,e]=D.useState({requests:0,bandwidth:0,latency:0,savings:0,hitRate:0,uptime:100}),[t,r]=D.useState([]),[i,s]=D.useState(!0);return D.useEffect(()=>{const o=async()=>{try{const u=await(await fetch("/api/admin-stats",{headers:{Authorization:`Bearer ${localStorage.getItem("agentcache_token")}`}})).json();u&&!u.error&&e({requests:u.total_requests_today||0,bandwidth:Math.round((u.tokens_saved_today||0)/1e3),latency:42,savings:u.cost_saved_today?parseFloat(u.cost_saved_today.replace("$","")):0,hitRate:u.hit_rate||0,uptime:99.9})}catch(l){console.error("Failed to fetch admin stats:",l)}finally{s(!1)}};o();const a=setInterval(o,3e4),c=new EventSource("/api/events/stream");return c.onmessage=l=>{const u=JSON.parse(l.data);if(u.type==="sys:connected")return;const d={id:Date.now(),type:u.type.toUpperCase(),source:u.agentId||"System",hash:u.hash?`${u.hash.substring(0,8)}...`:"-",time:new Date().toLocaleTimeString()};r(h=>[d,...h].slice(0,10))},()=>{clearInterval(a),c.close()}},[]),b.jsxs("div",{className:"space-y-6",children:[b.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[b.jsx(Le,{title:"Global Grid Status",icon:zp,className:"lg:col-span-2 min-h-[300px]",children:b.jsxs("div",{className:"w-full h-full flex items-center justify-center bg-[rgba(0,0,0,0.3)] rounded border border-[rgba(255,255,255,0.05)] relative overflow-hidden",children:[b.jsx("div",{className:"absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--hud-accent)_0%,_transparent_70%)] opacity-10 animate-pulse"}),b.jsxs("div",{className:"text-center",children:[b.jsx(zp,{size:64,className:"mx-auto text-[var(--hud-accent)] opacity-50 mb-4"}),b.jsxs("p",{className:"text-[var(--hud-text-dim)] font-mono text-sm",children:["GRID VISUALIZATION ONLINE",b.jsx("br",{}),b.jsx("span",{className:"text-[var(--hud-success)]",children:"3 REGIONS ACTIVE"})]})]})]})}),b.jsx(Le,{title:"System Health",icon:yr,className:"flex flex-col justify-center",children:b.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[b.jsx(ba,{value:n.uptime,label:"Uptime",sublabel:"30 Days",color:"var(--hud-success)"}),b.jsx(ba,{value:n.hitRate,label:"Cache Hit",sublabel:"Global",color:"var(--hud-accent)"}),b.jsx(ba,{value:42,max:100,label:"CPU Load",sublabel:"Cluster",color:"var(--hud-warning)"}),b.jsx(ba,{value:12,max:100,label:"Memory",sublabel:"Usage",color:"var(--hud-accent-secondary)"})]})})]}),b.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[b.jsxs(Le,{className:"p-0",children:[b.jsxs("div",{className:"flex items-center justify-between",children:[b.jsxs("div",{children:[b.jsx("p",{className:"text-[var(--hud-text-dim)] text-xs uppercase tracking-wider mb-1",children:"Total Requests"}),b.jsx("h3",{className:"text-2xl font-mono font-bold text-white",children:n.requests.toLocaleString()})]}),b.jsx(Ly,{className:"text-[var(--hud-accent)] opacity-50",size:24})]}),b.jsx("div",{className:"mt-2 text-xs text-[var(--hud-success)] flex items-center",children:b.jsx("span",{children:"Today"})})]}),b.jsxs(Le,{className:"p-0",children:[b.jsxs("div",{className:"flex items-center justify-between",children:[b.jsxs("div",{children:[b.jsx("p",{className:"text-[var(--hud-text-dim)] text-xs uppercase tracking-wider mb-1",children:"Tokens Saved"}),b.jsxs("h3",{className:"text-2xl font-mono font-bold text-white",children:[n.bandwidth.toLocaleString()," k"]})]}),b.jsx(TN,{className:"text-[var(--hud-accent-secondary)] opacity-50",size:24})]}),b.jsx("div",{className:"mt-2 text-xs text-[var(--hud-success)] flex items-center",children:b.jsx("span",{children:"Est. Bandwidth"})})]}),b.jsxs(Le,{className:"p-0",children:[b.jsxs("div",{className:"flex items-center justify-between",children:[b.jsxs("div",{children:[b.jsx("p",{className:"text-[var(--hud-text-dim)] text-xs uppercase tracking-wider mb-1",children:"Avg Latency"}),b.jsxs("h3",{className:"text-2xl font-mono font-bold text-white",children:[n.latency,"ms"]})]}),b.jsx(yr,{className:"text-[var(--hud-warning)] opacity-50",size:24})]}),b.jsx("div",{className:"mt-2 text-xs text-[var(--hud-success)] flex items-center",children:b.jsx("span",{children:"Global Avg"})})]}),b.jsxs(Le,{className:"p-0",children:[b.jsxs("div",{className:"flex items-center justify-between",children:[b.jsxs("div",{children:[b.jsx("p",{className:"text-[var(--hud-text-dim)] text-xs uppercase tracking-wider mb-1",children:"Cost Savings"}),b.jsxs("h3",{className:"text-2xl font-mono font-bold text-white",children:["$",n.savings.toFixed(2)]})]}),b.jsx(Iy,{className:"text-[var(--hud-success)] opacity-50",size:24})]}),b.jsx("div",{className:"mt-2 text-xs text-[var(--hud-success)] flex items-center",children:b.jsx("span",{children:"Today"})})]})]}),b.jsxs(Le,{title:"Live Event Stream",icon:QS,action:b.jsx("button",{className:"text-xs text-[var(--hud-accent)] hover:underline",children:"View All"}),children:[b.jsx(Uc,{columns:[{header:"Time",accessor:"time"},{header:"Type",accessor:"type",render:o=>b.jsx("span",{className:`text-xs font-bold px-2 py-1 rounded ${o.type.includes("HIT")?"bg-green-500/10 text-green-400":o.type.includes("MISS")?"bg-red-500/10 text-red-400":"bg-blue-500/10 text-blue-400"}`,children:o.type})},{header:"Source",accessor:"source"},{header:"Hash / ID",accessor:"hash",render:o=>b.jsx("span",{className:"font-mono text-[var(--hud-text-dim)]",children:o.hash})}],data:t}),t.length===0&&b.jsx("div",{className:"p-4 text-center text-[var(--hud-text-dim)] italic",children:"Waiting for events..."})]})]})};function It(n){if(typeof n=="string"||typeof n=="number")return""+n;let e="";if(Array.isArray(n))for(let t=0,r;t<n.length;t++)(r=It(n[t]))!==""&&(e+=(e&&" ")+r);else for(let t in n)n[t]&&(e+=(e&&" ")+t);return e}const LN={},Wp=n=>{let e;const t=new Set,r=(u,d)=>{const h=typeof u=="function"?u(e):u;if(!Object.is(h,e)){const f=e;e=d??(typeof h!="object"||h===null)?h:Object.assign({},e,h),t.forEach(p=>p(e,f))}},i=()=>e,c={setState:r,getState:i,getInitialState:()=>l,subscribe:u=>(t.add(u),()=>t.delete(u)),destroy:()=>{(LN?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),t.clear()}},l=e=n(r,i,c);return c},ON=n=>n?Wp(n):Wp,{useDebugValue:UN}=K,{useSyncExternalStoreWithSelector:GN}=lw,$N=n=>n;function Oy(n,e=$N,t){const r=GN(n.subscribe,n.getState,n.getServerState||n.getInitialState,e,t);return UN(r),r}const qp=(n,e)=>{const t=ON(n),r=(i,s=e)=>Oy(t,i,s);return Object.assign(r,t),r},VN=(n,e)=>n?qp(n,e):qp;function Ct(n,e){if(Object.is(n,e))return!0;if(typeof n!="object"||n===null||typeof e!="object"||e===null)return!1;if(n instanceof Map&&e instanceof Map){if(n.size!==e.size)return!1;for(const[r,i]of n)if(!Object.is(i,e.get(r)))return!1;return!0}if(n instanceof Set&&e instanceof Set){if(n.size!==e.size)return!1;for(const r of n)if(!e.has(r))return!1;return!0}const t=Object.keys(n);if(t.length!==Object.keys(e).length)return!1;for(const r of t)if(!Object.prototype.hasOwnProperty.call(e,r)||!Object.is(n[r],e[r]))return!1;return!0}var zN={value:()=>{}};function aa(){for(var n=0,e=arguments.length,t={},r;n<e;++n){if(!(r=arguments[n]+"")||r in t||/[\s.]/.test(r))throw new Error("illegal type: "+r);t[r]=[]}return new yc(t)}function yc(n){this._=n}function jN(n,e){return n.trim().split(/^|\s+/).map(function(t){var r="",i=t.indexOf(".");if(i>=0&&(r=t.slice(i+1),t=t.slice(0,i)),t&&!e.hasOwnProperty(t))throw new Error("unknown type: "+t);return{type:t,name:r}})}yc.prototype=aa.prototype={constructor:yc,on:function(n,e){var t=this._,r=jN(n+"",t),i,s=-1,o=r.length;if(arguments.length<2){for(;++s<o;)if((i=(n=r[s]).type)&&(i=HN(t[i],n.name)))return i;return}if(e!=null&&typeof e!="function")throw new Error("invalid callback: "+e);for(;++s<o;)if(i=(n=r[s]).type)t[i]=Xp(t[i],n.name,e);else if(e==null)for(i in t)t[i]=Xp(t[i],n.name,null);return this},copy:function(){var n={},e=this._;for(var t in e)n[t]=e[t].slice();return new yc(n)},call:function(n,e){if((i=arguments.length-2)>0)for(var t=new Array(i),r=0,i,s;r<i;++r)t[r]=arguments[r+2];if(!this._.hasOwnProperty(n))throw new Error("unknown type: "+n);for(s=this._[n],r=0,i=s.length;r<i;++r)s[r].value.apply(e,t)},apply:function(n,e,t){if(!this._.hasOwnProperty(n))throw new Error("unknown type: "+n);for(var r=this._[n],i=0,s=r.length;i<s;++i)r[i].value.apply(e,t)}};function HN(n,e){for(var t=0,r=n.length,i;t<r;++t)if((i=n[t]).name===e)return i.value}function Xp(n,e,t){for(var r=0,i=n.length;r<i;++r)if(n[r].name===e){n[r]=zN,n=n.slice(0,r).concat(n.slice(r+1));break}return t!=null&&n.push({name:e,value:t}),n}var Qd="http://www.w3.org/1999/xhtml";const Yp={svg:"http://www.w3.org/2000/svg",xhtml:Qd,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function wl(n){var e=n+="",t=e.indexOf(":");return t>=0&&(e=n.slice(0,t))!=="xmlns"&&(n=n.slice(t+1)),Yp.hasOwnProperty(e)?{space:Yp[e],local:n}:n}function WN(n){return function(){var e=this.ownerDocument,t=this.namespaceURI;return t===Qd&&e.documentElement.namespaceURI===Qd?e.createElement(n):e.createElementNS(t,n)}}function qN(n){return function(){return this.ownerDocument.createElementNS(n.space,n.local)}}function Uy(n){var e=wl(n);return(e.local?qN:WN)(e)}function XN(){}function xf(n){return n==null?XN:function(){return this.querySelector(n)}}function YN(n){typeof n!="function"&&(n=xf(n));for(var e=this._groups,t=e.length,r=new Array(t),i=0;i<t;++i)for(var s=e[i],o=s.length,a=r[i]=new Array(o),c,l,u=0;u<o;++u)(c=s[u])&&(l=n.call(c,c.__data__,u,s))&&("__data__"in c&&(l.__data__=c.__data__),a[u]=l);return new Zt(r,this._parents)}function KN(n){return n==null?[]:Array.isArray(n)?n:Array.from(n)}function QN(){return[]}function Gy(n){return n==null?QN:function(){return this.querySelectorAll(n)}}function ZN(n){return function(){return KN(n.apply(this,arguments))}}function JN(n){typeof n=="function"?n=ZN(n):n=Gy(n);for(var e=this._groups,t=e.length,r=[],i=[],s=0;s<t;++s)for(var o=e[s],a=o.length,c,l=0;l<a;++l)(c=o[l])&&(r.push(n.call(c,c.__data__,l,o)),i.push(c));return new Zt(r,i)}function $y(n){return function(){return this.matches(n)}}function Vy(n){return function(e){return e.matches(n)}}var eE=Array.prototype.find;function tE(n){return function(){return eE.call(this.children,n)}}function nE(){return this.firstElementChild}function rE(n){return this.select(n==null?nE:tE(typeof n=="function"?n:Vy(n)))}var iE=Array.prototype.filter;function sE(){return Array.from(this.children)}function oE(n){return function(){return iE.call(this.children,n)}}function aE(n){return this.selectAll(n==null?sE:oE(typeof n=="function"?n:Vy(n)))}function cE(n){typeof n!="function"&&(n=$y(n));for(var e=this._groups,t=e.length,r=new Array(t),i=0;i<t;++i)for(var s=e[i],o=s.length,a=r[i]=[],c,l=0;l<o;++l)(c=s[l])&&n.call(c,c.__data__,l,s)&&a.push(c);return new Zt(r,this._parents)}function zy(n){return new Array(n.length)}function lE(){return new Zt(this._enter||this._groups.map(zy),this._parents)}function Gc(n,e){this.ownerDocument=n.ownerDocument,this.namespaceURI=n.namespaceURI,this._next=null,this._parent=n,this.__data__=e}Gc.prototype={constructor:Gc,appendChild:function(n){return this._parent.insertBefore(n,this._next)},insertBefore:function(n,e){return this._parent.insertBefore(n,e)},querySelector:function(n){return this._parent.querySelector(n)},querySelectorAll:function(n){return this._parent.querySelectorAll(n)}};function uE(n){return function(){return n}}function dE(n,e,t,r,i,s){for(var o=0,a,c=e.length,l=s.length;o<l;++o)(a=e[o])?(a.__data__=s[o],r[o]=a):t[o]=new Gc(n,s[o]);for(;o<c;++o)(a=e[o])&&(i[o]=a)}function hE(n,e,t,r,i,s,o){var a,c,l=new Map,u=e.length,d=s.length,h=new Array(u),f;for(a=0;a<u;++a)(c=e[a])&&(h[a]=f=o.call(c,c.__data__,a,e)+"",l.has(f)?i[a]=c:l.set(f,c));for(a=0;a<d;++a)f=o.call(n,s[a],a,s)+"",(c=l.get(f))?(r[a]=c,c.__data__=s[a],l.delete(f)):t[a]=new Gc(n,s[a]);for(a=0;a<u;++a)(c=e[a])&&l.get(h[a])===c&&(i[a]=c)}function fE(n){return n.__data__}function pE(n,e){if(!arguments.length)return Array.from(this,fE);var t=e?hE:dE,r=this._parents,i=this._groups;typeof n!="function"&&(n=uE(n));for(var s=i.length,o=new Array(s),a=new Array(s),c=new Array(s),l=0;l<s;++l){var u=r[l],d=i[l],h=d.length,f=gE(n.call(u,u&&u.__data__,l,r)),p=f.length,g=a[l]=new Array(p),x=o[l]=new Array(p),m=c[l]=new Array(h);t(u,d,g,x,m,f,e);for(var y=0,_=0,v,T;y<p;++y)if(v=g[y]){for(y>=_&&(_=y+1);!(T=x[_])&&++_<p;);v._next=T||null}}return o=new Zt(o,r),o._enter=a,o._exit=c,o}function gE(n){return typeof n=="object"&&"length"in n?n:Array.from(n)}function mE(){return new Zt(this._exit||this._groups.map(zy),this._parents)}function xE(n,e,t){var r=this.enter(),i=this,s=this.exit();return typeof n=="function"?(r=n(r),r&&(r=r.selection())):r=r.append(n+""),e!=null&&(i=e(i),i&&(i=i.selection())),t==null?s.remove():t(s),r&&i?r.merge(i).order():i}function yE(n){for(var e=n.selection?n.selection():n,t=this._groups,r=e._groups,i=t.length,s=r.length,o=Math.min(i,s),a=new Array(i),c=0;c<o;++c)for(var l=t[c],u=r[c],d=l.length,h=a[c]=new Array(d),f,p=0;p<d;++p)(f=l[p]||u[p])&&(h[p]=f);for(;c<i;++c)a[c]=t[c];return new Zt(a,this._parents)}function bE(){for(var n=this._groups,e=-1,t=n.length;++e<t;)for(var r=n[e],i=r.length-1,s=r[i],o;--i>=0;)(o=r[i])&&(s&&o.compareDocumentPosition(s)^4&&s.parentNode.insertBefore(o,s),s=o);return this}function _E(n){n||(n=vE);function e(d,h){return d&&h?n(d.__data__,h.__data__):!d-!h}for(var t=this._groups,r=t.length,i=new Array(r),s=0;s<r;++s){for(var o=t[s],a=o.length,c=i[s]=new Array(a),l,u=0;u<a;++u)(l=o[u])&&(c[u]=l);c.sort(e)}return new Zt(i,this._parents).order()}function vE(n,e){return n<e?-1:n>e?1:n>=e?0:NaN}function TE(){var n=arguments[0];return arguments[0]=this,n.apply(null,arguments),this}function wE(){return Array.from(this)}function SE(){for(var n=this._groups,e=0,t=n.length;e<t;++e)for(var r=n[e],i=0,s=r.length;i<s;++i){var o=r[i];if(o)return o}return null}function NE(){let n=0;for(const e of this)++n;return n}function EE(){return!this.node()}function AE(n){for(var e=this._groups,t=0,r=e.length;t<r;++t)for(var i=e[t],s=0,o=i.length,a;s<o;++s)(a=i[s])&&n.call(a,a.__data__,s,i);return this}function RE(n){return function(){this.removeAttribute(n)}}function CE(n){return function(){this.removeAttributeNS(n.space,n.local)}}function ME(n,e){return function(){this.setAttribute(n,e)}}function PE(n,e){return function(){this.setAttributeNS(n.space,n.local,e)}}function DE(n,e){return function(){var t=e.apply(this,arguments);t==null?this.removeAttribute(n):this.setAttribute(n,t)}}function BE(n,e){return function(){var t=e.apply(this,arguments);t==null?this.removeAttributeNS(n.space,n.local):this.setAttributeNS(n.space,n.local,t)}}function FE(n,e){var t=wl(n);if(arguments.length<2){var r=this.node();return t.local?r.getAttributeNS(t.space,t.local):r.getAttribute(t)}return this.each((e==null?t.local?CE:RE:typeof e=="function"?t.local?BE:DE:t.local?PE:ME)(t,e))}function jy(n){return n.ownerDocument&&n.ownerDocument.defaultView||n.document&&n||n.defaultView}function kE(n){return function(){this.style.removeProperty(n)}}function IE(n,e,t){return function(){this.style.setProperty(n,e,t)}}function LE(n,e,t){return function(){var r=e.apply(this,arguments);r==null?this.style.removeProperty(n):this.style.setProperty(n,r,t)}}function OE(n,e,t){return arguments.length>1?this.each((e==null?kE:typeof e=="function"?LE:IE)(n,e,t??"")):Ts(this.node(),n)}function Ts(n,e){return n.style.getPropertyValue(e)||jy(n).getComputedStyle(n,null).getPropertyValue(e)}function UE(n){return function(){delete this[n]}}function GE(n,e){return function(){this[n]=e}}function $E(n,e){return function(){var t=e.apply(this,arguments);t==null?delete this[n]:this[n]=t}}function VE(n,e){return arguments.length>1?this.each((e==null?UE:typeof e=="function"?$E:GE)(n,e)):this.node()[n]}function Hy(n){return n.trim().split(/^|\s+/)}function yf(n){return n.classList||new Wy(n)}function Wy(n){this._node=n,this._names=Hy(n.getAttribute("class")||"")}Wy.prototype={add:function(n){var e=this._names.indexOf(n);e<0&&(this._names.push(n),this._node.setAttribute("class",this._names.join(" ")))},remove:function(n){var e=this._names.indexOf(n);e>=0&&(this._names.splice(e,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(n){return this._names.indexOf(n)>=0}};function qy(n,e){for(var t=yf(n),r=-1,i=e.length;++r<i;)t.add(e[r])}function Xy(n,e){for(var t=yf(n),r=-1,i=e.length;++r<i;)t.remove(e[r])}function zE(n){return function(){qy(this,n)}}function jE(n){return function(){Xy(this,n)}}function HE(n,e){return function(){(e.apply(this,arguments)?qy:Xy)(this,n)}}function WE(n,e){var t=Hy(n+"");if(arguments.length<2){for(var r=yf(this.node()),i=-1,s=t.length;++i<s;)if(!r.contains(t[i]))return!1;return!0}return this.each((typeof e=="function"?HE:e?zE:jE)(t,e))}function qE(){this.textContent=""}function XE(n){return function(){this.textContent=n}}function YE(n){return function(){var e=n.apply(this,arguments);this.textContent=e??""}}function KE(n){return arguments.length?this.each(n==null?qE:(typeof n=="function"?YE:XE)(n)):this.node().textContent}function QE(){this.innerHTML=""}function ZE(n){return function(){this.innerHTML=n}}function JE(n){return function(){var e=n.apply(this,arguments);this.innerHTML=e??""}}function eA(n){return arguments.length?this.each(n==null?QE:(typeof n=="function"?JE:ZE)(n)):this.node().innerHTML}function tA(){this.nextSibling&&this.parentNode.appendChild(this)}function nA(){return this.each(tA)}function rA(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function iA(){return this.each(rA)}function sA(n){var e=typeof n=="function"?n:Uy(n);return this.select(function(){return this.appendChild(e.apply(this,arguments))})}function oA(){return null}function aA(n,e){var t=typeof n=="function"?n:Uy(n),r=e==null?oA:typeof e=="function"?e:xf(e);return this.select(function(){return this.insertBefore(t.apply(this,arguments),r.apply(this,arguments)||null)})}function cA(){var n=this.parentNode;n&&n.removeChild(this)}function lA(){return this.each(cA)}function uA(){var n=this.cloneNode(!1),e=this.parentNode;return e?e.insertBefore(n,this.nextSibling):n}function dA(){var n=this.cloneNode(!0),e=this.parentNode;return e?e.insertBefore(n,this.nextSibling):n}function hA(n){return this.select(n?dA:uA)}function fA(n){return arguments.length?this.property("__data__",n):this.node().__data__}function pA(n){return function(e){n.call(this,e,this.__data__)}}function gA(n){return n.trim().split(/^|\s+/).map(function(e){var t="",r=e.indexOf(".");return r>=0&&(t=e.slice(r+1),e=e.slice(0,r)),{type:e,name:t}})}function mA(n){return function(){var e=this.__on;if(e){for(var t=0,r=-1,i=e.length,s;t<i;++t)s=e[t],(!n.type||s.type===n.type)&&s.name===n.name?this.removeEventListener(s.type,s.listener,s.options):e[++r]=s;++r?e.length=r:delete this.__on}}}function xA(n,e,t){return function(){var r=this.__on,i,s=pA(e);if(r){for(var o=0,a=r.length;o<a;++o)if((i=r[o]).type===n.type&&i.name===n.name){this.removeEventListener(i.type,i.listener,i.options),this.addEventListener(i.type,i.listener=s,i.options=t),i.value=e;return}}this.addEventListener(n.type,s,t),i={type:n.type,name:n.name,value:e,listener:s,options:t},r?r.push(i):this.__on=[i]}}function yA(n,e,t){var r=gA(n+""),i,s=r.length,o;if(arguments.length<2){var a=this.node().__on;if(a){for(var c=0,l=a.length,u;c<l;++c)for(i=0,u=a[c];i<s;++i)if((o=r[i]).type===u.type&&o.name===u.name)return u.value}return}for(a=e?xA:mA,i=0;i<s;++i)this.each(a(r[i],e,t));return this}function Yy(n,e,t){var r=jy(n),i=r.CustomEvent;typeof i=="function"?i=new i(e,t):(i=r.document.createEvent("Event"),t?(i.initEvent(e,t.bubbles,t.cancelable),i.detail=t.detail):i.initEvent(e,!1,!1)),n.dispatchEvent(i)}function bA(n,e){return function(){return Yy(this,n,e)}}function _A(n,e){return function(){return Yy(this,n,e.apply(this,arguments))}}function vA(n,e){return this.each((typeof e=="function"?_A:bA)(n,e))}function*TA(){for(var n=this._groups,e=0,t=n.length;e<t;++e)for(var r=n[e],i=0,s=r.length,o;i<s;++i)(o=r[i])&&(yield o)}var Ky=[null];function Zt(n,e){this._groups=n,this._parents=e}function ca(){return new Zt([[document.documentElement]],Ky)}function wA(){return this}Zt.prototype=ca.prototype={constructor:Zt,select:YN,selectAll:JN,selectChild:rE,selectChildren:aE,filter:cE,data:pE,enter:lE,exit:mE,join:xE,merge:yE,selection:wA,order:bE,sort:_E,call:TE,nodes:wE,node:SE,size:NE,empty:EE,each:AE,attr:FE,style:OE,property:VE,classed:WE,text:KE,html:eA,raise:nA,lower:iA,append:sA,insert:aA,remove:lA,clone:hA,datum:fA,on:yA,dispatch:vA,[Symbol.iterator]:TA};function st(n){return typeof n=="string"?new Zt([[document.querySelector(n)]],[document.documentElement]):new Zt([[n]],Ky)}function SA(n){let e;for(;e=n.sourceEvent;)n=e;return n}function fn(n,e){if(n=SA(n),e===void 0&&(e=n.currentTarget),e){var t=e.ownerSVGElement||e;if(t.createSVGPoint){var r=t.createSVGPoint();return r.x=n.clientX,r.y=n.clientY,r=r.matrixTransform(e.getScreenCTM().inverse()),[r.x,r.y]}if(e.getBoundingClientRect){var i=e.getBoundingClientRect();return[n.clientX-i.left-e.clientLeft,n.clientY-i.top-e.clientTop]}}return[n.pageX,n.pageY]}const NA={passive:!1},zo={capture:!0,passive:!1};function ru(n){n.stopImmediatePropagation()}function us(n){n.preventDefault(),n.stopImmediatePropagation()}function Qy(n){var e=n.document.documentElement,t=st(n).on("dragstart.drag",us,zo);"onselectstart"in e?t.on("selectstart.drag",us,zo):(e.__noselect=e.style.MozUserSelect,e.style.MozUserSelect="none")}function Zy(n,e){var t=n.document.documentElement,r=st(n).on("dragstart.drag",null);e&&(r.on("click.drag",us,zo),setTimeout(function(){r.on("click.drag",null)},0)),"onselectstart"in t?r.on("selectstart.drag",null):(t.style.MozUserSelect=t.__noselect,delete t.__noselect)}const _a=n=>()=>n;function Zd(n,{sourceEvent:e,subject:t,target:r,identifier:i,active:s,x:o,y:a,dx:c,dy:l,dispatch:u}){Object.defineProperties(this,{type:{value:n,enumerable:!0,configurable:!0},sourceEvent:{value:e,enumerable:!0,configurable:!0},subject:{value:t,enumerable:!0,configurable:!0},target:{value:r,enumerable:!0,configurable:!0},identifier:{value:i,enumerable:!0,configurable:!0},active:{value:s,enumerable:!0,configurable:!0},x:{value:o,enumerable:!0,configurable:!0},y:{value:a,enumerable:!0,configurable:!0},dx:{value:c,enumerable:!0,configurable:!0},dy:{value:l,enumerable:!0,configurable:!0},_:{value:u}})}Zd.prototype.on=function(){var n=this._.on.apply(this._,arguments);return n===this._?this:n};function EA(n){return!n.ctrlKey&&!n.button}function AA(){return this.parentNode}function RA(n,e){return e??{x:n.x,y:n.y}}function CA(){return navigator.maxTouchPoints||"ontouchstart"in this}function MA(){var n=EA,e=AA,t=RA,r=CA,i={},s=aa("start","drag","end"),o=0,a,c,l,u,d=0;function h(v){v.on("mousedown.drag",f).filter(r).on("touchstart.drag",x).on("touchmove.drag",m,NA).on("touchend.drag touchcancel.drag",y).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function f(v,T){if(!(u||!n.call(this,v,T))){var w=_(this,e.call(this,v,T),v,T,"mouse");w&&(st(v.view).on("mousemove.drag",p,zo).on("mouseup.drag",g,zo),Qy(v.view),ru(v),l=!1,a=v.clientX,c=v.clientY,w("start",v))}}function p(v){if(us(v),!l){var T=v.clientX-a,w=v.clientY-c;l=T*T+w*w>d}i.mouse("drag",v)}function g(v){st(v.view).on("mousemove.drag mouseup.drag",null),Zy(v.view,l),us(v),i.mouse("end",v)}function x(v,T){if(n.call(this,v,T)){var w=v.changedTouches,N=e.call(this,v,T),E=w.length,A,B;for(A=0;A<E;++A)(B=_(this,N,v,T,w[A].identifier,w[A]))&&(ru(v),B("start",v,w[A]))}}function m(v){var T=v.changedTouches,w=T.length,N,E;for(N=0;N<w;++N)(E=i[T[N].identifier])&&(us(v),E("drag",v,T[N]))}function y(v){var T=v.changedTouches,w=T.length,N,E;for(u&&clearTimeout(u),u=setTimeout(function(){u=null},500),N=0;N<w;++N)(E=i[T[N].identifier])&&(ru(v),E("end",v,T[N]))}function _(v,T,w,N,E,A){var B=s.copy(),R=fn(A||w,T),L,F,S;if((S=t.call(v,new Zd("beforestart",{sourceEvent:w,target:h,identifier:E,active:o,x:R[0],y:R[1],dx:0,dy:0,dispatch:B}),N))!=null)return L=S.x-R[0]||0,F=S.y-R[1]||0,function U(k,P,$){var M=R,W;switch(k){case"start":i[E]=U,W=o++;break;case"end":delete i[E],--o;case"drag":R=fn($||P,T),W=o;break}B.call(k,v,new Zd(k,{sourceEvent:P,subject:S,target:h,identifier:E,active:W,x:R[0]+L,y:R[1]+F,dx:R[0]-M[0],dy:R[1]-M[1],dispatch:B}),N)}}return h.filter=function(v){return arguments.length?(n=typeof v=="function"?v:_a(!!v),h):n},h.container=function(v){return arguments.length?(e=typeof v=="function"?v:_a(v),h):e},h.subject=function(v){return arguments.length?(t=typeof v=="function"?v:_a(v),h):t},h.touchable=function(v){return arguments.length?(r=typeof v=="function"?v:_a(!!v),h):r},h.on=function(){var v=s.on.apply(s,arguments);return v===s?h:v},h.clickDistance=function(v){return arguments.length?(d=(v=+v)*v,h):Math.sqrt(d)},h}function bf(n,e,t){n.prototype=e.prototype=t,t.constructor=n}function Jy(n,e){var t=Object.create(n.prototype);for(var r in e)t[r]=e[r];return t}function la(){}var jo=.7,$c=1/jo,ds="\\s*([+-]?\\d+)\\s*",Ho="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",Vn="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",PA=/^#([0-9a-f]{3,8})$/,DA=new RegExp(`^rgb\\(${ds},${ds},${ds}\\)$`),BA=new RegExp(`^rgb\\(${Vn},${Vn},${Vn}\\)$`),FA=new RegExp(`^rgba\\(${ds},${ds},${ds},${Ho}\\)$`),kA=new RegExp(`^rgba\\(${Vn},${Vn},${Vn},${Ho}\\)$`),IA=new RegExp(`^hsl\\(${Ho},${Vn},${Vn}\\)$`),LA=new RegExp(`^hsla\\(${Ho},${Vn},${Vn},${Ho}\\)$`),Kp={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};bf(la,Ri,{copy(n){return Object.assign(new this.constructor,this,n)},displayable(){return this.rgb().displayable()},hex:Qp,formatHex:Qp,formatHex8:OA,formatHsl:UA,formatRgb:Zp,toString:Zp});function Qp(){return this.rgb().formatHex()}function OA(){return this.rgb().formatHex8()}function UA(){return eb(this).formatHsl()}function Zp(){return this.rgb().formatRgb()}function Ri(n){var e,t;return n=(n+"").trim().toLowerCase(),(e=PA.exec(n))?(t=e[1].length,e=parseInt(e[1],16),t===6?Jp(e):t===3?new $t(e>>8&15|e>>4&240,e>>4&15|e&240,(e&15)<<4|e&15,1):t===8?va(e>>24&255,e>>16&255,e>>8&255,(e&255)/255):t===4?va(e>>12&15|e>>8&240,e>>8&15|e>>4&240,e>>4&15|e&240,((e&15)<<4|e&15)/255):null):(e=DA.exec(n))?new $t(e[1],e[2],e[3],1):(e=BA.exec(n))?new $t(e[1]*255/100,e[2]*255/100,e[3]*255/100,1):(e=FA.exec(n))?va(e[1],e[2],e[3],e[4]):(e=kA.exec(n))?va(e[1]*255/100,e[2]*255/100,e[3]*255/100,e[4]):(e=IA.exec(n))?ng(e[1],e[2]/100,e[3]/100,1):(e=LA.exec(n))?ng(e[1],e[2]/100,e[3]/100,e[4]):Kp.hasOwnProperty(n)?Jp(Kp[n]):n==="transparent"?new $t(NaN,NaN,NaN,0):null}function Jp(n){return new $t(n>>16&255,n>>8&255,n&255,1)}function va(n,e,t,r){return r<=0&&(n=e=t=NaN),new $t(n,e,t,r)}function GA(n){return n instanceof la||(n=Ri(n)),n?(n=n.rgb(),new $t(n.r,n.g,n.b,n.opacity)):new $t}function Wo(n,e,t,r){return arguments.length===1?GA(n):new $t(n,e,t,r??1)}function $t(n,e,t,r){this.r=+n,this.g=+e,this.b=+t,this.opacity=+r}bf($t,Wo,Jy(la,{brighter(n){return n=n==null?$c:Math.pow($c,n),new $t(this.r*n,this.g*n,this.b*n,this.opacity)},darker(n){return n=n==null?jo:Math.pow(jo,n),new $t(this.r*n,this.g*n,this.b*n,this.opacity)},rgb(){return this},clamp(){return new $t(Si(this.r),Si(this.g),Si(this.b),Vc(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:eg,formatHex:eg,formatHex8:$A,formatRgb:tg,toString:tg}));function eg(){return`#${yi(this.r)}${yi(this.g)}${yi(this.b)}`}function $A(){return`#${yi(this.r)}${yi(this.g)}${yi(this.b)}${yi((isNaN(this.opacity)?1:this.opacity)*255)}`}function tg(){const n=Vc(this.opacity);return`${n===1?"rgb(":"rgba("}${Si(this.r)}, ${Si(this.g)}, ${Si(this.b)}${n===1?")":`, ${n})`}`}function Vc(n){return isNaN(n)?1:Math.max(0,Math.min(1,n))}function Si(n){return Math.max(0,Math.min(255,Math.round(n)||0))}function yi(n){return n=Si(n),(n<16?"0":"")+n.toString(16)}function ng(n,e,t,r){return r<=0?n=e=t=NaN:t<=0||t>=1?n=e=NaN:e<=0&&(n=NaN),new yn(n,e,t,r)}function eb(n){if(n instanceof yn)return new yn(n.h,n.s,n.l,n.opacity);if(n instanceof la||(n=Ri(n)),!n)return new yn;if(n instanceof yn)return n;n=n.rgb();var e=n.r/255,t=n.g/255,r=n.b/255,i=Math.min(e,t,r),s=Math.max(e,t,r),o=NaN,a=s-i,c=(s+i)/2;return a?(e===s?o=(t-r)/a+(t<r)*6:t===s?o=(r-e)/a+2:o=(e-t)/a+4,a/=c<.5?s+i:2-s-i,o*=60):a=c>0&&c<1?0:o,new yn(o,a,c,n.opacity)}function VA(n,e,t,r){return arguments.length===1?eb(n):new yn(n,e,t,r??1)}function yn(n,e,t,r){this.h=+n,this.s=+e,this.l=+t,this.opacity=+r}bf(yn,VA,Jy(la,{brighter(n){return n=n==null?$c:Math.pow($c,n),new yn(this.h,this.s,this.l*n,this.opacity)},darker(n){return n=n==null?jo:Math.pow(jo,n),new yn(this.h,this.s,this.l*n,this.opacity)},rgb(){var n=this.h%360+(this.h<0)*360,e=isNaN(n)||isNaN(this.s)?0:this.s,t=this.l,r=t+(t<.5?t:1-t)*e,i=2*t-r;return new $t(iu(n>=240?n-240:n+120,i,r),iu(n,i,r),iu(n<120?n+240:n-120,i,r),this.opacity)},clamp(){return new yn(rg(this.h),Ta(this.s),Ta(this.l),Vc(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const n=Vc(this.opacity);return`${n===1?"hsl(":"hsla("}${rg(this.h)}, ${Ta(this.s)*100}%, ${Ta(this.l)*100}%${n===1?")":`, ${n})`}`}}));function rg(n){return n=(n||0)%360,n<0?n+360:n}function Ta(n){return Math.max(0,Math.min(1,n||0))}function iu(n,e,t){return(n<60?e+(t-e)*n/60:n<180?t:n<240?e+(t-e)*(240-n)/60:e)*255}const _f=n=>()=>n;function zA(n,e){return function(t){return n+t*e}}function jA(n,e,t){return n=Math.pow(n,t),e=Math.pow(e,t)-n,t=1/t,function(r){return Math.pow(n+r*e,t)}}function HA(n){return(n=+n)==1?tb:function(e,t){return t-e?jA(e,t,n):_f(isNaN(e)?t:e)}}function tb(n,e){var t=e-n;return t?zA(n,t):_f(isNaN(n)?e:n)}const zc=(function n(e){var t=HA(e);function r(i,s){var o=t((i=Wo(i)).r,(s=Wo(s)).r),a=t(i.g,s.g),c=t(i.b,s.b),l=tb(i.opacity,s.opacity);return function(u){return i.r=o(u),i.g=a(u),i.b=c(u),i.opacity=l(u),i+""}}return r.gamma=n,r})(1);function WA(n,e){e||(e=[]);var t=n?Math.min(e.length,n.length):0,r=e.slice(),i;return function(s){for(i=0;i<t;++i)r[i]=n[i]*(1-s)+e[i]*s;return r}}function qA(n){return ArrayBuffer.isView(n)&&!(n instanceof DataView)}function XA(n,e){var t=e?e.length:0,r=n?Math.min(t,n.length):0,i=new Array(r),s=new Array(t),o;for(o=0;o<r;++o)i[o]=Sl(n[o],e[o]);for(;o<t;++o)s[o]=e[o];return function(a){for(o=0;o<r;++o)s[o]=i[o](a);return s}}function YA(n,e){var t=new Date;return n=+n,e=+e,function(r){return t.setTime(n*(1-r)+e*r),t}}function mn(n,e){return n=+n,e=+e,function(t){return n*(1-t)+e*t}}function KA(n,e){var t={},r={},i;(n===null||typeof n!="object")&&(n={}),(e===null||typeof e!="object")&&(e={});for(i in e)i in n?t[i]=Sl(n[i],e[i]):r[i]=e[i];return function(s){for(i in t)r[i]=t[i](s);return r}}var Jd=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,su=new RegExp(Jd.source,"g");function QA(n){return function(){return n}}function ZA(n){return function(e){return n(e)+""}}function nb(n,e){var t=Jd.lastIndex=su.lastIndex=0,r,i,s,o=-1,a=[],c=[];for(n=n+"",e=e+"";(r=Jd.exec(n))&&(i=su.exec(e));)(s=i.index)>t&&(s=e.slice(t,s),a[o]?a[o]+=s:a[++o]=s),(r=r[0])===(i=i[0])?a[o]?a[o]+=i:a[++o]=i:(a[++o]=null,c.push({i:o,x:mn(r,i)})),t=su.lastIndex;return t<e.length&&(s=e.slice(t),a[o]?a[o]+=s:a[++o]=s),a.length<2?c[0]?ZA(c[0].x):QA(e):(e=c.length,function(l){for(var u=0,d;u<e;++u)a[(d=c[u]).i]=d.x(l);return a.join("")})}function Sl(n,e){var t=typeof e,r;return e==null||t==="boolean"?_f(e):(t==="number"?mn:t==="string"?(r=Ri(e))?(e=r,zc):nb:e instanceof Ri?zc:e instanceof Date?YA:qA(e)?WA:Array.isArray(e)?XA:typeof e.valueOf!="function"&&typeof e.toString!="function"||isNaN(e)?KA:mn)(n,e)}function rb(n,e){return n=+n,e=+e,function(t){return Math.round(n*(1-t)+e*t)}}var ig=180/Math.PI,eh={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function ib(n,e,t,r,i,s){var o,a,c;return(o=Math.sqrt(n*n+e*e))&&(n/=o,e/=o),(c=n*t+e*r)&&(t-=n*c,r-=e*c),(a=Math.sqrt(t*t+r*r))&&(t/=a,r/=a,c/=a),n*r<e*t&&(n=-n,e=-e,c=-c,o=-o),{translateX:i,translateY:s,rotate:Math.atan2(e,n)*ig,skewX:Math.atan(c)*ig,scaleX:o,scaleY:a}}var wa;function JA(n){const e=new(typeof DOMMatrix=="function"?DOMMatrix:WebKitCSSMatrix)(n+"");return e.isIdentity?eh:ib(e.a,e.b,e.c,e.d,e.e,e.f)}function e2(n){return n==null||(wa||(wa=document.createElementNS("http://www.w3.org/2000/svg","g")),wa.setAttribute("transform",n),!(n=wa.transform.baseVal.consolidate()))?eh:(n=n.matrix,ib(n.a,n.b,n.c,n.d,n.e,n.f))}function sb(n,e,t,r){function i(l){return l.length?l.pop()+" ":""}function s(l,u,d,h,f,p){if(l!==d||u!==h){var g=f.push("translate(",null,e,null,t);p.push({i:g-4,x:mn(l,d)},{i:g-2,x:mn(u,h)})}else(d||h)&&f.push("translate("+d+e+h+t)}function o(l,u,d,h){l!==u?(l-u>180?u+=360:u-l>180&&(l+=360),h.push({i:d.push(i(d)+"rotate(",null,r)-2,x:mn(l,u)})):u&&d.push(i(d)+"rotate("+u+r)}function a(l,u,d,h){l!==u?h.push({i:d.push(i(d)+"skewX(",null,r)-2,x:mn(l,u)}):u&&d.push(i(d)+"skewX("+u+r)}function c(l,u,d,h,f,p){if(l!==d||u!==h){var g=f.push(i(f)+"scale(",null,",",null,")");p.push({i:g-4,x:mn(l,d)},{i:g-2,x:mn(u,h)})}else(d!==1||h!==1)&&f.push(i(f)+"scale("+d+","+h+")")}return function(l,u){var d=[],h=[];return l=n(l),u=n(u),s(l.translateX,l.translateY,u.translateX,u.translateY,d,h),o(l.rotate,u.rotate,d,h),a(l.skewX,u.skewX,d,h),c(l.scaleX,l.scaleY,u.scaleX,u.scaleY,d,h),l=u=null,function(f){for(var p=-1,g=h.length,x;++p<g;)d[(x=h[p]).i]=x.x(f);return d.join("")}}}var t2=sb(JA,"px, ","px)","deg)"),n2=sb(e2,", ",")",")"),r2=1e-12;function sg(n){return((n=Math.exp(n))+1/n)/2}function i2(n){return((n=Math.exp(n))-1/n)/2}function s2(n){return((n=Math.exp(2*n))-1)/(n+1)}const o2=(function n(e,t,r){function i(s,o){var a=s[0],c=s[1],l=s[2],u=o[0],d=o[1],h=o[2],f=u-a,p=d-c,g=f*f+p*p,x,m;if(g<r2)m=Math.log(h/l)/e,x=function(N){return[a+N*f,c+N*p,l*Math.exp(e*N*m)]};else{var y=Math.sqrt(g),_=(h*h-l*l+r*g)/(2*l*t*y),v=(h*h-l*l-r*g)/(2*h*t*y),T=Math.log(Math.sqrt(_*_+1)-_),w=Math.log(Math.sqrt(v*v+1)-v);m=(w-T)/e,x=function(N){var E=N*m,A=sg(T),B=l/(t*y)*(A*s2(e*E+T)-i2(T));return[a+B*f,c+B*p,l*A/sg(e*E+T)]}}return x.duration=m*1e3*e/Math.SQRT2,x}return i.rho=function(s){var o=Math.max(.001,+s),a=o*o,c=a*a;return n(o,a,c)},i})(Math.SQRT2,2,4);var ws=0,bo=0,Xs=0,ob=1e3,jc,_o,Hc=0,Ci=0,Nl=0,qo=typeof performance=="object"&&performance.now?performance:Date,ab=typeof window=="object"&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(n){setTimeout(n,17)};function vf(){return Ci||(ab(a2),Ci=qo.now()+Nl)}function a2(){Ci=0}function Wc(){this._call=this._time=this._next=null}Wc.prototype=Tf.prototype={constructor:Wc,restart:function(n,e,t){if(typeof n!="function")throw new TypeError("callback is not a function");t=(t==null?vf():+t)+(e==null?0:+e),!this._next&&_o!==this&&(_o?_o._next=this:jc=this,_o=this),this._call=n,this._time=t,th()},stop:function(){this._call&&(this._call=null,this._time=1/0,th())}};function Tf(n,e,t){var r=new Wc;return r.restart(n,e,t),r}function c2(){vf(),++ws;for(var n=jc,e;n;)(e=Ci-n._time)>=0&&n._call.call(void 0,e),n=n._next;--ws}function og(){Ci=(Hc=qo.now())+Nl,ws=bo=0;try{c2()}finally{ws=0,u2(),Ci=0}}function l2(){var n=qo.now(),e=n-Hc;e>ob&&(Nl-=e,Hc=n)}function u2(){for(var n,e=jc,t,r=1/0;e;)e._call?(r>e._time&&(r=e._time),n=e,e=e._next):(t=e._next,e._next=null,e=n?n._next=t:jc=t);_o=n,th(r)}function th(n){if(!ws){bo&&(bo=clearTimeout(bo));var e=n-Ci;e>24?(n<1/0&&(bo=setTimeout(og,n-qo.now()-Nl)),Xs&&(Xs=clearInterval(Xs))):(Xs||(Hc=qo.now(),Xs=setInterval(l2,ob)),ws=1,ab(og))}}function ag(n,e,t){var r=new Wc;return e=e==null?0:+e,r.restart(i=>{r.stop(),n(i+e)},e,t),r}var d2=aa("start","end","cancel","interrupt"),h2=[],cb=0,cg=1,nh=2,bc=3,lg=4,rh=5,_c=6;function El(n,e,t,r,i,s){var o=n.__transition;if(!o)n.__transition={};else if(t in o)return;f2(n,t,{name:e,index:r,group:i,on:d2,tween:h2,time:s.time,delay:s.delay,duration:s.duration,ease:s.ease,timer:null,state:cb})}function wf(n,e){var t=An(n,e);if(t.state>cb)throw new Error("too late; already scheduled");return t}function Xn(n,e){var t=An(n,e);if(t.state>bc)throw new Error("too late; already running");return t}function An(n,e){var t=n.__transition;if(!t||!(t=t[e]))throw new Error("transition not found");return t}function f2(n,e,t){var r=n.__transition,i;r[e]=t,t.timer=Tf(s,0,t.time);function s(l){t.state=cg,t.timer.restart(o,t.delay,t.time),t.delay<=l&&o(l-t.delay)}function o(l){var u,d,h,f;if(t.state!==cg)return c();for(u in r)if(f=r[u],f.name===t.name){if(f.state===bc)return ag(o);f.state===lg?(f.state=_c,f.timer.stop(),f.on.call("interrupt",n,n.__data__,f.index,f.group),delete r[u]):+u<e&&(f.state=_c,f.timer.stop(),f.on.call("cancel",n,n.__data__,f.index,f.group),delete r[u])}if(ag(function(){t.state===bc&&(t.state=lg,t.timer.restart(a,t.delay,t.time),a(l))}),t.state=nh,t.on.call("start",n,n.__data__,t.index,t.group),t.state===nh){for(t.state=bc,i=new Array(h=t.tween.length),u=0,d=-1;u<h;++u)(f=t.tween[u].value.call(n,n.__data__,t.index,t.group))&&(i[++d]=f);i.length=d+1}}function a(l){for(var u=l<t.duration?t.ease.call(null,l/t.duration):(t.timer.restart(c),t.state=rh,1),d=-1,h=i.length;++d<h;)i[d].call(n,u);t.state===rh&&(t.on.call("end",n,n.__data__,t.index,t.group),c())}function c(){t.state=_c,t.timer.stop(),delete r[e];for(var l in r)return;delete n.__transition}}function vc(n,e){var t=n.__transition,r,i,s=!0,o;if(t){e=e==null?null:e+"";for(o in t){if((r=t[o]).name!==e){s=!1;continue}i=r.state>nh&&r.state<rh,r.state=_c,r.timer.stop(),r.on.call(i?"interrupt":"cancel",n,n.__data__,r.index,r.group),delete t[o]}s&&delete n.__transition}}function p2(n){return this.each(function(){vc(this,n)})}function g2(n,e){var t,r;return function(){var i=Xn(this,n),s=i.tween;if(s!==t){r=t=s;for(var o=0,a=r.length;o<a;++o)if(r[o].name===e){r=r.slice(),r.splice(o,1);break}}i.tween=r}}function m2(n,e,t){var r,i;if(typeof t!="function")throw new Error;return function(){var s=Xn(this,n),o=s.tween;if(o!==r){i=(r=o).slice();for(var a={name:e,value:t},c=0,l=i.length;c<l;++c)if(i[c].name===e){i[c]=a;break}c===l&&i.push(a)}s.tween=i}}function x2(n,e){var t=this._id;if(n+="",arguments.length<2){for(var r=An(this.node(),t).tween,i=0,s=r.length,o;i<s;++i)if((o=r[i]).name===n)return o.value;return null}return this.each((e==null?g2:m2)(t,n,e))}function Sf(n,e,t){var r=n._id;return n.each(function(){var i=Xn(this,r);(i.value||(i.value={}))[e]=t.apply(this,arguments)}),function(i){return An(i,r).value[e]}}function lb(n,e){var t;return(typeof e=="number"?mn:e instanceof Ri?zc:(t=Ri(e))?(e=t,zc):nb)(n,e)}function y2(n){return function(){this.removeAttribute(n)}}function b2(n){return function(){this.removeAttributeNS(n.space,n.local)}}function _2(n,e,t){var r,i=t+"",s;return function(){var o=this.getAttribute(n);return o===i?null:o===r?s:s=e(r=o,t)}}function v2(n,e,t){var r,i=t+"",s;return function(){var o=this.getAttributeNS(n.space,n.local);return o===i?null:o===r?s:s=e(r=o,t)}}function T2(n,e,t){var r,i,s;return function(){var o,a=t(this),c;return a==null?void this.removeAttribute(n):(o=this.getAttribute(n),c=a+"",o===c?null:o===r&&c===i?s:(i=c,s=e(r=o,a)))}}function w2(n,e,t){var r,i,s;return function(){var o,a=t(this),c;return a==null?void this.removeAttributeNS(n.space,n.local):(o=this.getAttributeNS(n.space,n.local),c=a+"",o===c?null:o===r&&c===i?s:(i=c,s=e(r=o,a)))}}function S2(n,e){var t=wl(n),r=t==="transform"?n2:lb;return this.attrTween(n,typeof e=="function"?(t.local?w2:T2)(t,r,Sf(this,"attr."+n,e)):e==null?(t.local?b2:y2)(t):(t.local?v2:_2)(t,r,e))}function N2(n,e){return function(t){this.setAttribute(n,e.call(this,t))}}function E2(n,e){return function(t){this.setAttributeNS(n.space,n.local,e.call(this,t))}}function A2(n,e){var t,r;function i(){var s=e.apply(this,arguments);return s!==r&&(t=(r=s)&&E2(n,s)),t}return i._value=e,i}function R2(n,e){var t,r;function i(){var s=e.apply(this,arguments);return s!==r&&(t=(r=s)&&N2(n,s)),t}return i._value=e,i}function C2(n,e){var t="attr."+n;if(arguments.length<2)return(t=this.tween(t))&&t._value;if(e==null)return this.tween(t,null);if(typeof e!="function")throw new Error;var r=wl(n);return this.tween(t,(r.local?A2:R2)(r,e))}function M2(n,e){return function(){wf(this,n).delay=+e.apply(this,arguments)}}function P2(n,e){return e=+e,function(){wf(this,n).delay=e}}function D2(n){var e=this._id;return arguments.length?this.each((typeof n=="function"?M2:P2)(e,n)):An(this.node(),e).delay}function B2(n,e){return function(){Xn(this,n).duration=+e.apply(this,arguments)}}function F2(n,e){return e=+e,function(){Xn(this,n).duration=e}}function k2(n){var e=this._id;return arguments.length?this.each((typeof n=="function"?B2:F2)(e,n)):An(this.node(),e).duration}function I2(n,e){if(typeof e!="function")throw new Error;return function(){Xn(this,n).ease=e}}function L2(n){var e=this._id;return arguments.length?this.each(I2(e,n)):An(this.node(),e).ease}function O2(n,e){return function(){var t=e.apply(this,arguments);if(typeof t!="function")throw new Error;Xn(this,n).ease=t}}function U2(n){if(typeof n!="function")throw new Error;return this.each(O2(this._id,n))}function G2(n){typeof n!="function"&&(n=$y(n));for(var e=this._groups,t=e.length,r=new Array(t),i=0;i<t;++i)for(var s=e[i],o=s.length,a=r[i]=[],c,l=0;l<o;++l)(c=s[l])&&n.call(c,c.__data__,l,s)&&a.push(c);return new br(r,this._parents,this._name,this._id)}function $2(n){if(n._id!==this._id)throw new Error;for(var e=this._groups,t=n._groups,r=e.length,i=t.length,s=Math.min(r,i),o=new Array(r),a=0;a<s;++a)for(var c=e[a],l=t[a],u=c.length,d=o[a]=new Array(u),h,f=0;f<u;++f)(h=c[f]||l[f])&&(d[f]=h);for(;a<r;++a)o[a]=e[a];return new br(o,this._parents,this._name,this._id)}function V2(n){return(n+"").trim().split(/^|\s+/).every(function(e){var t=e.indexOf(".");return t>=0&&(e=e.slice(0,t)),!e||e==="start"})}function z2(n,e,t){var r,i,s=V2(e)?wf:Xn;return function(){var o=s(this,n),a=o.on;a!==r&&(i=(r=a).copy()).on(e,t),o.on=i}}function j2(n,e){var t=this._id;return arguments.length<2?An(this.node(),t).on.on(n):this.each(z2(t,n,e))}function H2(n){return function(){var e=this.parentNode;for(var t in this.__transition)if(+t!==n)return;e&&e.removeChild(this)}}function W2(){return this.on("end.remove",H2(this._id))}function q2(n){var e=this._name,t=this._id;typeof n!="function"&&(n=xf(n));for(var r=this._groups,i=r.length,s=new Array(i),o=0;o<i;++o)for(var a=r[o],c=a.length,l=s[o]=new Array(c),u,d,h=0;h<c;++h)(u=a[h])&&(d=n.call(u,u.__data__,h,a))&&("__data__"in u&&(d.__data__=u.__data__),l[h]=d,El(l[h],e,t,h,l,An(u,t)));return new br(s,this._parents,e,t)}function X2(n){var e=this._name,t=this._id;typeof n!="function"&&(n=Gy(n));for(var r=this._groups,i=r.length,s=[],o=[],a=0;a<i;++a)for(var c=r[a],l=c.length,u,d=0;d<l;++d)if(u=c[d]){for(var h=n.call(u,u.__data__,d,c),f,p=An(u,t),g=0,x=h.length;g<x;++g)(f=h[g])&&El(f,e,t,g,h,p);s.push(h),o.push(u)}return new br(s,o,e,t)}var Y2=ca.prototype.constructor;function K2(){return new Y2(this._groups,this._parents)}function Q2(n,e){var t,r,i;return function(){var s=Ts(this,n),o=(this.style.removeProperty(n),Ts(this,n));return s===o?null:s===t&&o===r?i:i=e(t=s,r=o)}}function ub(n){return function(){this.style.removeProperty(n)}}function Z2(n,e,t){var r,i=t+"",s;return function(){var o=Ts(this,n);return o===i?null:o===r?s:s=e(r=o,t)}}function J2(n,e,t){var r,i,s;return function(){var o=Ts(this,n),a=t(this),c=a+"";return a==null&&(c=a=(this.style.removeProperty(n),Ts(this,n))),o===c?null:o===r&&c===i?s:(i=c,s=e(r=o,a))}}function eR(n,e){var t,r,i,s="style."+e,o="end."+s,a;return function(){var c=Xn(this,n),l=c.on,u=c.value[s]==null?a||(a=ub(e)):void 0;(l!==t||i!==u)&&(r=(t=l).copy()).on(o,i=u),c.on=r}}function tR(n,e,t){var r=(n+="")=="transform"?t2:lb;return e==null?this.styleTween(n,Q2(n,r)).on("end.style."+n,ub(n)):typeof e=="function"?this.styleTween(n,J2(n,r,Sf(this,"style."+n,e))).each(eR(this._id,n)):this.styleTween(n,Z2(n,r,e),t).on("end.style."+n,null)}function nR(n,e,t){return function(r){this.style.setProperty(n,e.call(this,r),t)}}function rR(n,e,t){var r,i;function s(){var o=e.apply(this,arguments);return o!==i&&(r=(i=o)&&nR(n,o,t)),r}return s._value=e,s}function iR(n,e,t){var r="style."+(n+="");if(arguments.length<2)return(r=this.tween(r))&&r._value;if(e==null)return this.tween(r,null);if(typeof e!="function")throw new Error;return this.tween(r,rR(n,e,t??""))}function sR(n){return function(){this.textContent=n}}function oR(n){return function(){var e=n(this);this.textContent=e??""}}function aR(n){return this.tween("text",typeof n=="function"?oR(Sf(this,"text",n)):sR(n==null?"":n+""))}function cR(n){return function(e){this.textContent=n.call(this,e)}}function lR(n){var e,t;function r(){var i=n.apply(this,arguments);return i!==t&&(e=(t=i)&&cR(i)),e}return r._value=n,r}function uR(n){var e="text";if(arguments.length<1)return(e=this.tween(e))&&e._value;if(n==null)return this.tween(e,null);if(typeof n!="function")throw new Error;return this.tween(e,lR(n))}function dR(){for(var n=this._name,e=this._id,t=db(),r=this._groups,i=r.length,s=0;s<i;++s)for(var o=r[s],a=o.length,c,l=0;l<a;++l)if(c=o[l]){var u=An(c,e);El(c,n,t,l,o,{time:u.time+u.delay+u.duration,delay:0,duration:u.duration,ease:u.ease})}return new br(r,this._parents,n,t)}function hR(){var n,e,t=this,r=t._id,i=t.size();return new Promise(function(s,o){var a={value:o},c={value:function(){--i===0&&s()}};t.each(function(){var l=Xn(this,r),u=l.on;u!==n&&(e=(n=u).copy(),e._.cancel.push(a),e._.interrupt.push(a),e._.end.push(c)),l.on=e}),i===0&&s()})}var fR=0;function br(n,e,t,r){this._groups=n,this._parents=e,this._name=t,this._id=r}function db(){return++fR}var Zn=ca.prototype;br.prototype={constructor:br,select:q2,selectAll:X2,selectChild:Zn.selectChild,selectChildren:Zn.selectChildren,filter:G2,merge:$2,selection:K2,transition:dR,call:Zn.call,nodes:Zn.nodes,node:Zn.node,size:Zn.size,empty:Zn.empty,each:Zn.each,on:j2,attr:S2,attrTween:C2,style:tR,styleTween:iR,text:aR,textTween:uR,remove:W2,tween:x2,delay:D2,duration:k2,ease:L2,easeVarying:U2,end:hR,[Symbol.iterator]:Zn[Symbol.iterator]};function pR(n){return((n*=2)<=1?n*n*n:(n-=2)*n*n+2)/2}var gR={time:null,delay:0,duration:250,ease:pR};function mR(n,e){for(var t;!(t=n.__transition)||!(t=t[e]);)if(!(n=n.parentNode))throw new Error(`transition ${e} not found`);return t}function xR(n){var e,t;n instanceof br?(e=n._id,n=n._name):(e=db(),(t=gR).time=vf(),n=n==null?null:n+"");for(var r=this._groups,i=r.length,s=0;s<i;++s)for(var o=r[s],a=o.length,c,l=0;l<a;++l)(c=o[l])&&El(c,n,e,l,o,t||mR(c,e));return new br(r,this._parents,n,e)}ca.prototype.interrupt=p2;ca.prototype.transition=xR;const Sa=n=>()=>n;function yR(n,{sourceEvent:e,target:t,transform:r,dispatch:i}){Object.defineProperties(this,{type:{value:n,enumerable:!0,configurable:!0},sourceEvent:{value:e,enumerable:!0,configurable:!0},target:{value:t,enumerable:!0,configurable:!0},transform:{value:r,enumerable:!0,configurable:!0},_:{value:i}})}function hr(n,e,t){this.k=n,this.x=e,this.y=t}hr.prototype={constructor:hr,scale:function(n){return n===1?this:new hr(this.k*n,this.x,this.y)},translate:function(n,e){return n===0&e===0?this:new hr(this.k,this.x+this.k*n,this.y+this.k*e)},apply:function(n){return[n[0]*this.k+this.x,n[1]*this.k+this.y]},applyX:function(n){return n*this.k+this.x},applyY:function(n){return n*this.k+this.y},invert:function(n){return[(n[0]-this.x)/this.k,(n[1]-this.y)/this.k]},invertX:function(n){return(n-this.x)/this.k},invertY:function(n){return(n-this.y)/this.k},rescaleX:function(n){return n.copy().domain(n.range().map(this.invertX,this).map(n.invert,n))},rescaleY:function(n){return n.copy().domain(n.range().map(this.invertY,this).map(n.invert,n))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};var Gr=new hr(1,0,0);hr.prototype;function ou(n){n.stopImmediatePropagation()}function Ys(n){n.preventDefault(),n.stopImmediatePropagation()}function bR(n){return(!n.ctrlKey||n.type==="wheel")&&!n.button}function _R(){var n=this;return n instanceof SVGElement?(n=n.ownerSVGElement||n,n.hasAttribute("viewBox")?(n=n.viewBox.baseVal,[[n.x,n.y],[n.x+n.width,n.y+n.height]]):[[0,0],[n.width.baseVal.value,n.height.baseVal.value]]):[[0,0],[n.clientWidth,n.clientHeight]]}function ug(){return this.__zoom||Gr}function vR(n){return-n.deltaY*(n.deltaMode===1?.05:n.deltaMode?1:.002)*(n.ctrlKey?10:1)}function TR(){return navigator.maxTouchPoints||"ontouchstart"in this}function wR(n,e,t){var r=n.invertX(e[0][0])-t[0][0],i=n.invertX(e[1][0])-t[1][0],s=n.invertY(e[0][1])-t[0][1],o=n.invertY(e[1][1])-t[1][1];return n.translate(i>r?(r+i)/2:Math.min(0,r)||Math.max(0,i),o>s?(s+o)/2:Math.min(0,s)||Math.max(0,o))}function hb(){var n=bR,e=_R,t=wR,r=vR,i=TR,s=[0,1/0],o=[[-1/0,-1/0],[1/0,1/0]],a=250,c=o2,l=aa("start","zoom","end"),u,d,h,f=500,p=150,g=0,x=10;function m(S){S.property("__zoom",ug).on("wheel.zoom",E,{passive:!1}).on("mousedown.zoom",A).on("dblclick.zoom",B).filter(i).on("touchstart.zoom",R).on("touchmove.zoom",L).on("touchend.zoom touchcancel.zoom",F).style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}m.transform=function(S,U,k,P){var $=S.selection?S.selection():S;$.property("__zoom",ug),S!==$?T(S,U,k,P):$.interrupt().each(function(){w(this,arguments).event(P).start().zoom(null,typeof U=="function"?U.apply(this,arguments):U).end()})},m.scaleBy=function(S,U,k,P){m.scaleTo(S,function(){var $=this.__zoom.k,M=typeof U=="function"?U.apply(this,arguments):U;return $*M},k,P)},m.scaleTo=function(S,U,k,P){m.transform(S,function(){var $=e.apply(this,arguments),M=this.__zoom,W=k==null?v($):typeof k=="function"?k.apply(this,arguments):k,G=M.invert(W),z=typeof U=="function"?U.apply(this,arguments):U;return t(_(y(M,z),W,G),$,o)},k,P)},m.translateBy=function(S,U,k,P){m.transform(S,function(){return t(this.__zoom.translate(typeof U=="function"?U.apply(this,arguments):U,typeof k=="function"?k.apply(this,arguments):k),e.apply(this,arguments),o)},null,P)},m.translateTo=function(S,U,k,P,$){m.transform(S,function(){var M=e.apply(this,arguments),W=this.__zoom,G=P==null?v(M):typeof P=="function"?P.apply(this,arguments):P;return t(Gr.translate(G[0],G[1]).scale(W.k).translate(typeof U=="function"?-U.apply(this,arguments):-U,typeof k=="function"?-k.apply(this,arguments):-k),M,o)},P,$)};function y(S,U){return U=Math.max(s[0],Math.min(s[1],U)),U===S.k?S:new hr(U,S.x,S.y)}function _(S,U,k){var P=U[0]-k[0]*S.k,$=U[1]-k[1]*S.k;return P===S.x&&$===S.y?S:new hr(S.k,P,$)}function v(S){return[(+S[0][0]+ +S[1][0])/2,(+S[0][1]+ +S[1][1])/2]}function T(S,U,k,P){S.on("start.zoom",function(){w(this,arguments).event(P).start()}).on("interrupt.zoom end.zoom",function(){w(this,arguments).event(P).end()}).tween("zoom",function(){var $=this,M=arguments,W=w($,M).event(P),G=e.apply($,M),z=k==null?v(G):typeof k=="function"?k.apply($,M):k,Z=Math.max(G[1][0]-G[0][0],G[1][1]-G[0][1]),ee=$.__zoom,O=typeof U=="function"?U.apply($,M):U,Y=c(ee.invert(z).concat(Z/ee.k),O.invert(z).concat(Z/O.k));return function(te){if(te===1)te=O;else{var ae=Y(te),me=Z/ae[2];te=new hr(me,z[0]-ae[0]*me,z[1]-ae[1]*me)}W.zoom(null,te)}})}function w(S,U,k){return!k&&S.__zooming||new N(S,U)}function N(S,U){this.that=S,this.args=U,this.active=0,this.sourceEvent=null,this.extent=e.apply(S,U),this.taps=0}N.prototype={event:function(S){return S&&(this.sourceEvent=S),this},start:function(){return++this.active===1&&(this.that.__zooming=this,this.emit("start")),this},zoom:function(S,U){return this.mouse&&S!=="mouse"&&(this.mouse[1]=U.invert(this.mouse[0])),this.touch0&&S!=="touch"&&(this.touch0[1]=U.invert(this.touch0[0])),this.touch1&&S!=="touch"&&(this.touch1[1]=U.invert(this.touch1[0])),this.that.__zoom=U,this.emit("zoom"),this},end:function(){return--this.active===0&&(delete this.that.__zooming,this.emit("end")),this},emit:function(S){var U=st(this.that).datum();l.call(S,this.that,new yR(S,{sourceEvent:this.sourceEvent,target:m,transform:this.that.__zoom,dispatch:l}),U)}};function E(S,...U){if(!n.apply(this,arguments))return;var k=w(this,U).event(S),P=this.__zoom,$=Math.max(s[0],Math.min(s[1],P.k*Math.pow(2,r.apply(this,arguments)))),M=fn(S);if(k.wheel)(k.mouse[0][0]!==M[0]||k.mouse[0][1]!==M[1])&&(k.mouse[1]=P.invert(k.mouse[0]=M)),clearTimeout(k.wheel);else{if(P.k===$)return;k.mouse=[M,P.invert(M)],vc(this),k.start()}Ys(S),k.wheel=setTimeout(W,p),k.zoom("mouse",t(_(y(P,$),k.mouse[0],k.mouse[1]),k.extent,o));function W(){k.wheel=null,k.end()}}function A(S,...U){if(h||!n.apply(this,arguments))return;var k=S.currentTarget,P=w(this,U,!0).event(S),$=st(S.view).on("mousemove.zoom",z,!0).on("mouseup.zoom",Z,!0),M=fn(S,k),W=S.clientX,G=S.clientY;Qy(S.view),ou(S),P.mouse=[M,this.__zoom.invert(M)],vc(this),P.start();function z(ee){if(Ys(ee),!P.moved){var O=ee.clientX-W,Y=ee.clientY-G;P.moved=O*O+Y*Y>g}P.event(ee).zoom("mouse",t(_(P.that.__zoom,P.mouse[0]=fn(ee,k),P.mouse[1]),P.extent,o))}function Z(ee){$.on("mousemove.zoom mouseup.zoom",null),Zy(ee.view,P.moved),Ys(ee),P.event(ee).end()}}function B(S,...U){if(n.apply(this,arguments)){var k=this.__zoom,P=fn(S.changedTouches?S.changedTouches[0]:S,this),$=k.invert(P),M=k.k*(S.shiftKey?.5:2),W=t(_(y(k,M),P,$),e.apply(this,U),o);Ys(S),a>0?st(this).transition().duration(a).call(T,W,P,S):st(this).call(m.transform,W,P,S)}}function R(S,...U){if(n.apply(this,arguments)){var k=S.touches,P=k.length,$=w(this,U,S.changedTouches.length===P).event(S),M,W,G,z;for(ou(S),W=0;W<P;++W)G=k[W],z=fn(G,this),z=[z,this.__zoom.invert(z),G.identifier],$.touch0?!$.touch1&&$.touch0[2]!==z[2]&&($.touch1=z,$.taps=0):($.touch0=z,M=!0,$.taps=1+!!u);u&&(u=clearTimeout(u)),M&&($.taps<2&&(d=z[0],u=setTimeout(function(){u=null},f)),vc(this),$.start())}}function L(S,...U){if(this.__zooming){var k=w(this,U).event(S),P=S.changedTouches,$=P.length,M,W,G,z;for(Ys(S),M=0;M<$;++M)W=P[M],G=fn(W,this),k.touch0&&k.touch0[2]===W.identifier?k.touch0[0]=G:k.touch1&&k.touch1[2]===W.identifier&&(k.touch1[0]=G);if(W=k.that.__zoom,k.touch1){var Z=k.touch0[0],ee=k.touch0[1],O=k.touch1[0],Y=k.touch1[1],te=(te=O[0]-Z[0])*te+(te=O[1]-Z[1])*te,ae=(ae=Y[0]-ee[0])*ae+(ae=Y[1]-ee[1])*ae;W=y(W,Math.sqrt(te/ae)),G=[(Z[0]+O[0])/2,(Z[1]+O[1])/2],z=[(ee[0]+Y[0])/2,(ee[1]+Y[1])/2]}else if(k.touch0)G=k.touch0[0],z=k.touch0[1];else return;k.zoom("touch",t(_(W,G,z),k.extent,o))}}function F(S,...U){if(this.__zooming){var k=w(this,U).event(S),P=S.changedTouches,$=P.length,M,W;for(ou(S),h&&clearTimeout(h),h=setTimeout(function(){h=null},f),M=0;M<$;++M)W=P[M],k.touch0&&k.touch0[2]===W.identifier?delete k.touch0:k.touch1&&k.touch1[2]===W.identifier&&delete k.touch1;if(k.touch1&&!k.touch0&&(k.touch0=k.touch1,delete k.touch1),k.touch0)k.touch0[1]=this.__zoom.invert(k.touch0[0]);else if(k.end(),k.taps===2&&(W=fn(W,this),Math.hypot(d[0]-W[0],d[1]-W[1])<x)){var G=st(this).on("dblclick.zoom");G&&G.apply(this,arguments)}}}return m.wheelDelta=function(S){return arguments.length?(r=typeof S=="function"?S:Sa(+S),m):r},m.filter=function(S){return arguments.length?(n=typeof S=="function"?S:Sa(!!S),m):n},m.touchable=function(S){return arguments.length?(i=typeof S=="function"?S:Sa(!!S),m):i},m.extent=function(S){return arguments.length?(e=typeof S=="function"?S:Sa([[+S[0][0],+S[0][1]],[+S[1][0],+S[1][1]]]),m):e},m.scaleExtent=function(S){return arguments.length?(s[0]=+S[0],s[1]=+S[1],m):[s[0],s[1]]},m.translateExtent=function(S){return arguments.length?(o[0][0]=+S[0][0],o[1][0]=+S[1][0],o[0][1]=+S[0][1],o[1][1]=+S[1][1],m):[[o[0][0],o[0][1]],[o[1][0],o[1][1]]]},m.constrain=function(S){return arguments.length?(t=S,m):t},m.duration=function(S){return arguments.length?(a=+S,m):a},m.interpolate=function(S){return arguments.length?(c=S,m):c},m.on=function(){var S=l.on.apply(l,arguments);return S===l?m:S},m.clickDistance=function(S){return arguments.length?(g=(S=+S)*S,m):Math.sqrt(g)},m.tapDistance=function(S){return arguments.length?(x=+S,m):x},m}aw();const Al=D.createContext(null),SR=Al.Provider,_r={error001:()=>"[React Flow]: Seems like you have not used zustand provider as an ancestor. Help: https://reactflow.dev/error#001",error002:()=>"It looks like you've created a new nodeTypes or edgeTypes object. If this wasn't on purpose please define the nodeTypes/edgeTypes outside of the component or memoize them.",error003:n=>`Node type "${n}" not found. Using fallback type "default".`,error004:()=>"The React Flow parent container needs a width and a height to render the graph.",error005:()=>"Only child nodes can use a parent extent.",error006:()=>"Can't create edge. An edge needs a source and a target.",error007:n=>`The old edge with id=${n} does not exist.`,error009:n=>`Marker type "${n}" doesn't exist.`,error008:(n,e)=>`Couldn't create edge for ${n?"target":"source"} handle id: "${n?e.targetHandle:e.sourceHandle}", edge id: ${e.id}.`,error010:()=>"Handle: No node id found. Make sure to only use a Handle inside a custom Node.",error011:n=>`Edge type "${n}" not found. Using fallback type "default".`,error012:n=>`Node with id "${n}" does not exist, it may have been removed. This can happen when a node is deleted before the "onNodeClick" handler is called.`},fb=_r.error001();function tt(n,e){const t=D.useContext(Al);if(t===null)throw new Error(fb);return Oy(t,n,e)}const xt=()=>{const n=D.useContext(Al);if(n===null)throw new Error(fb);return D.useMemo(()=>({getState:n.getState,setState:n.setState,subscribe:n.subscribe,destroy:n.destroy}),[n])},NR=n=>n.userSelectionActive?"none":"all";function pb({position:n,children:e,className:t,style:r,...i}){const s=tt(NR),o=`${n}`.split("-");return K.createElement("div",{className:It(["react-flow__panel",t,...o]),style:{...r,pointerEvents:s},...i},e)}function ER({proOptions:n,position:e="bottom-right"}){return n?.hideAttribution?null:K.createElement(pb,{position:e,className:"react-flow__attribution","data-message":"Please only hide this attribution when you are subscribed to React Flow Pro: https://reactflow.dev/pro"},K.createElement("a",{href:"https://reactflow.dev",target:"_blank",rel:"noopener noreferrer","aria-label":"React Flow attribution"},"React Flow"))}const AR=({x:n,y:e,label:t,labelStyle:r={},labelShowBg:i=!0,labelBgStyle:s={},labelBgPadding:o=[2,4],labelBgBorderRadius:a=2,children:c,className:l,...u})=>{const d=D.useRef(null),[h,f]=D.useState({x:0,y:0,width:0,height:0}),p=It(["react-flow__edge-textwrapper",l]);return D.useEffect(()=>{if(d.current){const g=d.current.getBBox();f({x:g.x,y:g.y,width:g.width,height:g.height})}},[t]),typeof t>"u"||!t?null:K.createElement("g",{transform:`translate(${n-h.width/2} ${e-h.height/2})`,className:p,visibility:h.width?"visible":"hidden",...u},i&&K.createElement("rect",{width:h.width+2*o[0],x:-o[0],y:-o[1],height:h.height+2*o[1],className:"react-flow__edge-textbg",style:s,rx:a,ry:a}),K.createElement("text",{className:"react-flow__edge-text",y:h.height/2,dy:"0.3em",ref:d,style:r},t),c)};var RR=D.memo(AR);const Nf=n=>({width:n.offsetWidth,height:n.offsetHeight}),Ss=(n,e=0,t=1)=>Math.min(Math.max(n,e),t),Ef=(n={x:0,y:0},e)=>({x:Ss(n.x,e[0][0],e[1][0]),y:Ss(n.y,e[0][1],e[1][1])}),dg=(n,e,t)=>n<e?Ss(Math.abs(n-e),1,50)/50:n>t?-Ss(Math.abs(n-t),1,50)/50:0,gb=(n,e)=>{const t=dg(n.x,35,e.width-35)*20,r=dg(n.y,35,e.height-35)*20;return[t,r]},mb=n=>n.getRootNode?.()||window?.document,CR=(n,e)=>({x:Math.min(n.x,e.x),y:Math.min(n.y,e.y),x2:Math.max(n.x2,e.x2),y2:Math.max(n.y2,e.y2)}),Af=({x:n,y:e,width:t,height:r})=>({x:n,y:e,x2:n+t,y2:e+r}),MR=({x:n,y:e,x2:t,y2:r})=>({x:n,y:e,width:t-n,height:r-e}),hg=n=>({...n.positionAbsolute||{x:0,y:0},width:n.width||0,height:n.height||0}),ih=(n,e)=>{const t=Math.max(0,Math.min(n.x+n.width,e.x+e.width)-Math.max(n.x,e.x)),r=Math.max(0,Math.min(n.y+n.height,e.y+e.height)-Math.max(n.y,e.y));return Math.ceil(t*r)},PR=n=>sn(n.width)&&sn(n.height)&&sn(n.x)&&sn(n.y),sn=n=>!isNaN(n)&&isFinite(n),rt=Symbol.for("internals"),xb=["Enter"," ","Escape"],DR=(n,e)=>{},BR=n=>"nativeEvent"in n;function sh(n){const t=(BR(n)?n.nativeEvent:n).composedPath?.()?.[0]||n.target;return["INPUT","SELECT","TEXTAREA"].includes(t?.nodeName)||t?.hasAttribute("contenteditable")||!!t?.closest(".nokey")}const yb=n=>"clientX"in n,$r=(n,e)=>{const t=yb(n),r=t?n.clientX:n.touches?.[0].clientX,i=t?n.clientY:n.touches?.[0].clientY;return{x:r-(e?.left??0),y:i-(e?.top??0)}},qc=()=>typeof navigator<"u"&&navigator?.userAgent?.indexOf("Mac")>=0,ua=({id:n,path:e,labelX:t,labelY:r,label:i,labelStyle:s,labelShowBg:o,labelBgStyle:a,labelBgPadding:c,labelBgBorderRadius:l,style:u,markerEnd:d,markerStart:h,interactionWidth:f=20})=>K.createElement(K.Fragment,null,K.createElement("path",{id:n,style:u,d:e,fill:"none",className:"react-flow__edge-path",markerEnd:d,markerStart:h}),f&&K.createElement("path",{d:e,fill:"none",strokeOpacity:0,strokeWidth:f,className:"react-flow__edge-interaction"}),i&&sn(t)&&sn(r)?K.createElement(RR,{x:t,y:r,label:i,labelStyle:s,labelShowBg:o,labelBgStyle:a,labelBgPadding:c,labelBgBorderRadius:l}):null);ua.displayName="BaseEdge";function Ks(n,e,t){return t===void 0?t:r=>{const i=e().edges.find(s=>s.id===n);i&&t(r,{...i})}}function bb({sourceX:n,sourceY:e,targetX:t,targetY:r}){const i=Math.abs(t-n)/2,s=t<n?t+i:t-i,o=Math.abs(r-e)/2,a=r<e?r+o:r-o;return[s,a,i,o]}function _b({sourceX:n,sourceY:e,targetX:t,targetY:r,sourceControlX:i,sourceControlY:s,targetControlX:o,targetControlY:a}){const c=n*.125+i*.375+o*.375+t*.125,l=e*.125+s*.375+a*.375+r*.125,u=Math.abs(c-n),d=Math.abs(l-e);return[c,l,u,d]}var Mi;(function(n){n.Strict="strict",n.Loose="loose"})(Mi||(Mi={}));var bi;(function(n){n.Free="free",n.Vertical="vertical",n.Horizontal="horizontal"})(bi||(bi={}));var Xo;(function(n){n.Partial="partial",n.Full="full"})(Xo||(Xo={}));var Pr;(function(n){n.Bezier="default",n.Straight="straight",n.Step="step",n.SmoothStep="smoothstep",n.SimpleBezier="simplebezier"})(Pr||(Pr={}));var Xc;(function(n){n.Arrow="arrow",n.ArrowClosed="arrowclosed"})(Xc||(Xc={}));var he;(function(n){n.Left="left",n.Top="top",n.Right="right",n.Bottom="bottom"})(he||(he={}));function fg({pos:n,x1:e,y1:t,x2:r,y2:i}){return n===he.Left||n===he.Right?[.5*(e+r),t]:[e,.5*(t+i)]}function vb({sourceX:n,sourceY:e,sourcePosition:t=he.Bottom,targetX:r,targetY:i,targetPosition:s=he.Top}){const[o,a]=fg({pos:t,x1:n,y1:e,x2:r,y2:i}),[c,l]=fg({pos:s,x1:r,y1:i,x2:n,y2:e}),[u,d,h,f]=_b({sourceX:n,sourceY:e,targetX:r,targetY:i,sourceControlX:o,sourceControlY:a,targetControlX:c,targetControlY:l});return[`M${n},${e} C${o},${a} ${c},${l} ${r},${i}`,u,d,h,f]}const Rf=D.memo(({sourceX:n,sourceY:e,targetX:t,targetY:r,sourcePosition:i=he.Bottom,targetPosition:s=he.Top,label:o,labelStyle:a,labelShowBg:c,labelBgStyle:l,labelBgPadding:u,labelBgBorderRadius:d,style:h,markerEnd:f,markerStart:p,interactionWidth:g})=>{const[x,m,y]=vb({sourceX:n,sourceY:e,sourcePosition:i,targetX:t,targetY:r,targetPosition:s});return K.createElement(ua,{path:x,labelX:m,labelY:y,label:o,labelStyle:a,labelShowBg:c,labelBgStyle:l,labelBgPadding:u,labelBgBorderRadius:d,style:h,markerEnd:f,markerStart:p,interactionWidth:g})});Rf.displayName="SimpleBezierEdge";const pg={[he.Left]:{x:-1,y:0},[he.Right]:{x:1,y:0},[he.Top]:{x:0,y:-1},[he.Bottom]:{x:0,y:1}},FR=({source:n,sourcePosition:e=he.Bottom,target:t})=>e===he.Left||e===he.Right?n.x<t.x?{x:1,y:0}:{x:-1,y:0}:n.y<t.y?{x:0,y:1}:{x:0,y:-1},gg=(n,e)=>Math.sqrt(Math.pow(e.x-n.x,2)+Math.pow(e.y-n.y,2));function kR({source:n,sourcePosition:e=he.Bottom,target:t,targetPosition:r=he.Top,center:i,offset:s}){const o=pg[e],a=pg[r],c={x:n.x+o.x*s,y:n.y+o.y*s},l={x:t.x+a.x*s,y:t.y+a.y*s},u=FR({source:c,sourcePosition:e,target:l}),d=u.x!==0?"x":"y",h=u[d];let f=[],p,g;const x={x:0,y:0},m={x:0,y:0},[y,_,v,T]=bb({sourceX:n.x,sourceY:n.y,targetX:t.x,targetY:t.y});if(o[d]*a[d]===-1){p=i.x??y,g=i.y??_;const N=[{x:p,y:c.y},{x:p,y:l.y}],E=[{x:c.x,y:g},{x:l.x,y:g}];o[d]===h?f=d==="x"?N:E:f=d==="x"?E:N}else{const N=[{x:c.x,y:l.y}],E=[{x:l.x,y:c.y}];if(d==="x"?f=o.x===h?E:N:f=o.y===h?N:E,e===r){const F=Math.abs(n[d]-t[d]);if(F<=s){const S=Math.min(s-1,s-F);o[d]===h?x[d]=(c[d]>n[d]?-1:1)*S:m[d]=(l[d]>t[d]?-1:1)*S}}if(e!==r){const F=d==="x"?"y":"x",S=o[d]===a[F],U=c[F]>l[F],k=c[F]<l[F];(o[d]===1&&(!S&&U||S&&k)||o[d]!==1&&(!S&&k||S&&U))&&(f=d==="x"?N:E)}const A={x:c.x+x.x,y:c.y+x.y},B={x:l.x+m.x,y:l.y+m.y},R=Math.max(Math.abs(A.x-f[0].x),Math.abs(B.x-f[0].x)),L=Math.max(Math.abs(A.y-f[0].y),Math.abs(B.y-f[0].y));R>=L?(p=(A.x+B.x)/2,g=f[0].y):(p=f[0].x,g=(A.y+B.y)/2)}return[[n,{x:c.x+x.x,y:c.y+x.y},...f,{x:l.x+m.x,y:l.y+m.y},t],p,g,v,T]}function IR(n,e,t,r){const i=Math.min(gg(n,e)/2,gg(e,t)/2,r),{x:s,y:o}=e;if(n.x===s&&s===t.x||n.y===o&&o===t.y)return`L${s} ${o}`;if(n.y===o){const l=n.x<t.x?-1:1,u=n.y<t.y?1:-1;return`L ${s+i*l},${o}Q ${s},${o} ${s},${o+i*u}`}const a=n.x<t.x?1:-1,c=n.y<t.y?-1:1;return`L ${s},${o+i*c}Q ${s},${o} ${s+i*a},${o}`}function oh({sourceX:n,sourceY:e,sourcePosition:t=he.Bottom,targetX:r,targetY:i,targetPosition:s=he.Top,borderRadius:o=5,centerX:a,centerY:c,offset:l=20}){const[u,d,h,f,p]=kR({source:{x:n,y:e},sourcePosition:t,target:{x:r,y:i},targetPosition:s,center:{x:a,y:c},offset:l});return[u.reduce((x,m,y)=>{let _="";return y>0&&y<u.length-1?_=IR(u[y-1],m,u[y+1],o):_=`${y===0?"M":"L"}${m.x} ${m.y}`,x+=_,x},""),d,h,f,p]}const Rl=D.memo(({sourceX:n,sourceY:e,targetX:t,targetY:r,label:i,labelStyle:s,labelShowBg:o,labelBgStyle:a,labelBgPadding:c,labelBgBorderRadius:l,style:u,sourcePosition:d=he.Bottom,targetPosition:h=he.Top,markerEnd:f,markerStart:p,pathOptions:g,interactionWidth:x})=>{const[m,y,_]=oh({sourceX:n,sourceY:e,sourcePosition:d,targetX:t,targetY:r,targetPosition:h,borderRadius:g?.borderRadius,offset:g?.offset});return K.createElement(ua,{path:m,labelX:y,labelY:_,label:i,labelStyle:s,labelShowBg:o,labelBgStyle:a,labelBgPadding:c,labelBgBorderRadius:l,style:u,markerEnd:f,markerStart:p,interactionWidth:x})});Rl.displayName="SmoothStepEdge";const Cf=D.memo(n=>K.createElement(Rl,{...n,pathOptions:D.useMemo(()=>({borderRadius:0,offset:n.pathOptions?.offset}),[n.pathOptions?.offset])}));Cf.displayName="StepEdge";function LR({sourceX:n,sourceY:e,targetX:t,targetY:r}){const[i,s,o,a]=bb({sourceX:n,sourceY:e,targetX:t,targetY:r});return[`M ${n},${e}L ${t},${r}`,i,s,o,a]}const Mf=D.memo(({sourceX:n,sourceY:e,targetX:t,targetY:r,label:i,labelStyle:s,labelShowBg:o,labelBgStyle:a,labelBgPadding:c,labelBgBorderRadius:l,style:u,markerEnd:d,markerStart:h,interactionWidth:f})=>{const[p,g,x]=LR({sourceX:n,sourceY:e,targetX:t,targetY:r});return K.createElement(ua,{path:p,labelX:g,labelY:x,label:i,labelStyle:s,labelShowBg:o,labelBgStyle:a,labelBgPadding:c,labelBgBorderRadius:l,style:u,markerEnd:d,markerStart:h,interactionWidth:f})});Mf.displayName="StraightEdge";function Na(n,e){return n>=0?.5*n:e*25*Math.sqrt(-n)}function mg({pos:n,x1:e,y1:t,x2:r,y2:i,c:s}){switch(n){case he.Left:return[e-Na(e-r,s),t];case he.Right:return[e+Na(r-e,s),t];case he.Top:return[e,t-Na(t-i,s)];case he.Bottom:return[e,t+Na(i-t,s)]}}function Tb({sourceX:n,sourceY:e,sourcePosition:t=he.Bottom,targetX:r,targetY:i,targetPosition:s=he.Top,curvature:o=.25}){const[a,c]=mg({pos:t,x1:n,y1:e,x2:r,y2:i,c:o}),[l,u]=mg({pos:s,x1:r,y1:i,x2:n,y2:e,c:o}),[d,h,f,p]=_b({sourceX:n,sourceY:e,targetX:r,targetY:i,sourceControlX:a,sourceControlY:c,targetControlX:l,targetControlY:u});return[`M${n},${e} C${a},${c} ${l},${u} ${r},${i}`,d,h,f,p]}const Yc=D.memo(({sourceX:n,sourceY:e,targetX:t,targetY:r,sourcePosition:i=he.Bottom,targetPosition:s=he.Top,label:o,labelStyle:a,labelShowBg:c,labelBgStyle:l,labelBgPadding:u,labelBgBorderRadius:d,style:h,markerEnd:f,markerStart:p,pathOptions:g,interactionWidth:x})=>{const[m,y,_]=Tb({sourceX:n,sourceY:e,sourcePosition:i,targetX:t,targetY:r,targetPosition:s,curvature:g?.curvature});return K.createElement(ua,{path:m,labelX:y,labelY:_,label:o,labelStyle:a,labelShowBg:c,labelBgStyle:l,labelBgPadding:u,labelBgBorderRadius:d,style:h,markerEnd:f,markerStart:p,interactionWidth:x})});Yc.displayName="BezierEdge";const Pf=D.createContext(null),OR=Pf.Provider;Pf.Consumer;const UR=()=>D.useContext(Pf),GR=n=>"id"in n&&"source"in n&&"target"in n,$R=({source:n,sourceHandle:e,target:t,targetHandle:r})=>`reactflow__edge-${n}${e||""}-${t}${r||""}`,ah=(n,e)=>typeof n>"u"?"":typeof n=="string"?n:`${e?`${e}__`:""}${Object.keys(n).sort().map(r=>`${r}=${n[r]}`).join("&")}`,VR=(n,e)=>e.some(t=>t.source===n.source&&t.target===n.target&&(t.sourceHandle===n.sourceHandle||!t.sourceHandle&&!n.sourceHandle)&&(t.targetHandle===n.targetHandle||!t.targetHandle&&!n.targetHandle)),wb=(n,e)=>{if(!n.source||!n.target)return e;let t;return GR(n)?t={...n}:t={...n,id:$R(n)},VR(t,e)?e:e.concat(t)},ch=({x:n,y:e},[t,r,i],s,[o,a])=>{const c={x:(n-t)/i,y:(e-r)/i};return s?{x:o*Math.round(c.x/o),y:a*Math.round(c.y/a)}:c},Sb=({x:n,y:e},[t,r,i])=>({x:n*i+t,y:e*i+r}),hs=(n,e=[0,0])=>{if(!n)return{x:0,y:0,positionAbsolute:{x:0,y:0}};const t=(n.width??0)*e[0],r=(n.height??0)*e[1],i={x:n.position.x-t,y:n.position.y-r};return{...i,positionAbsolute:n.positionAbsolute?{x:n.positionAbsolute.x-t,y:n.positionAbsolute.y-r}:i}},Df=(n,e=[0,0])=>{if(n.length===0)return{x:0,y:0,width:0,height:0};const t=n.reduce((r,i)=>{const{x:s,y:o}=hs(i,e).positionAbsolute;return CR(r,Af({x:s,y:o,width:i.width||0,height:i.height||0}))},{x:1/0,y:1/0,x2:-1/0,y2:-1/0});return MR(t)},Nb=(n,e,[t,r,i]=[0,0,1],s=!1,o=!1,a=[0,0])=>{const c={x:(e.x-t)/i,y:(e.y-r)/i,width:e.width/i,height:e.height/i},l=[];return n.forEach(u=>{const{width:d,height:h,selectable:f=!0,hidden:p=!1}=u;if(o&&!f||p)return!1;const{positionAbsolute:g}=hs(u,a),x={x:g.x,y:g.y,width:d||0,height:h||0},m=ih(c,x),y=typeof d>"u"||typeof h>"u"||d===null||h===null,_=s&&m>0,v=(d||0)*(h||0);(y||_||m>=v||u.dragging)&&l.push(u)}),l},Eb=(n,e)=>{const t=n.map(r=>r.id);return e.filter(r=>t.includes(r.source)||t.includes(r.target))},Ab=(n,e,t,r,i,s=.1)=>{const o=e/(n.width*(1+s)),a=t/(n.height*(1+s)),c=Math.min(o,a),l=Ss(c,r,i),u=n.x+n.width/2,d=n.y+n.height/2,h=e/2-u*l,f=t/2-d*l;return{x:h,y:f,zoom:l}},ci=(n,e=0)=>n.transition().duration(e);function xg(n,e,t,r){return(e[t]||[]).reduce((i,s)=>(`${n.id}-${s.id}-${t}`!==r&&i.push({id:s.id||null,type:t,nodeId:n.id,x:(n.positionAbsolute?.x??0)+s.x+s.width/2,y:(n.positionAbsolute?.y??0)+s.y+s.height/2}),i),[])}function zR(n,e,t,r,i,s){const{x:o,y:a}=$r(n),l=e.elementsFromPoint(o,a).find(p=>p.classList.contains("react-flow__handle"));if(l){const p=l.getAttribute("data-nodeid");if(p){const g=Bf(void 0,l),x=l.getAttribute("data-handleid"),m=s({nodeId:p,id:x,type:g});if(m){const y=i.find(_=>_.nodeId===p&&_.type===g&&_.id===x);return{handle:{id:x,type:g,nodeId:p,x:y?.x||t.x,y:y?.y||t.y},validHandleResult:m}}}}let u=[],d=1/0;if(i.forEach(p=>{const g=Math.sqrt((p.x-t.x)**2+(p.y-t.y)**2);if(g<=r){const x=s(p);g<=d&&(g<d?u=[{handle:p,validHandleResult:x}]:g===d&&u.push({handle:p,validHandleResult:x}),d=g)}}),!u.length)return{handle:null,validHandleResult:Rb()};if(u.length===1)return u[0];const h=u.some(({validHandleResult:p})=>p.isValid),f=u.some(({handle:p})=>p.type==="target");return u.find(({handle:p,validHandleResult:g})=>f?p.type==="target":h?g.isValid:!0)||u[0]}const jR={source:null,target:null,sourceHandle:null,targetHandle:null},Rb=()=>({handleDomNode:null,isValid:!1,connection:jR,endHandle:null});function Cb(n,e,t,r,i,s,o){const a=i==="target",c=o.querySelector(`.react-flow__handle[data-id="${n?.nodeId}-${n?.id}-${n?.type}"]`),l={...Rb(),handleDomNode:c};if(c){const u=Bf(void 0,c),d=c.getAttribute("data-nodeid"),h=c.getAttribute("data-handleid"),f=c.classList.contains("connectable"),p=c.classList.contains("connectableend"),g={source:a?d:t,sourceHandle:a?h:r,target:a?t:d,targetHandle:a?r:h};l.connection=g,f&&p&&(e===Mi.Strict?a&&u==="source"||!a&&u==="target":d!==t||h!==r)&&(l.endHandle={nodeId:d,handleId:h,type:u},l.isValid=s(g))}return l}function HR({nodes:n,nodeId:e,handleId:t,handleType:r}){return n.reduce((i,s)=>{if(s[rt]){const{handleBounds:o}=s[rt];let a=[],c=[];o&&(a=xg(s,o,"source",`${e}-${t}-${r}`),c=xg(s,o,"target",`${e}-${t}-${r}`)),i.push(...a,...c)}return i},[])}function Bf(n,e){return n||(e?.classList.contains("target")?"target":e?.classList.contains("source")?"source":null)}function au(n){n?.classList.remove("valid","connecting","react-flow__handle-valid","react-flow__handle-connecting")}function WR(n,e){let t=null;return e?t="valid":n&&!e&&(t="invalid"),t}function Mb({event:n,handleId:e,nodeId:t,onConnect:r,isTarget:i,getState:s,setState:o,isValidConnection:a,edgeUpdaterType:c,onReconnectEnd:l}){const u=mb(n.target),{connectionMode:d,domNode:h,autoPanOnConnect:f,connectionRadius:p,onConnectStart:g,panBy:x,getNodes:m,cancelConnection:y}=s();let _=0,v;const{x:T,y:w}=$r(n),N=u?.elementFromPoint(T,w),E=Bf(c,N),A=h?.getBoundingClientRect();if(!A||!E)return;let B,R=$r(n,A),L=!1,F=null,S=!1,U=null;const k=HR({nodes:m(),nodeId:t,handleId:e,handleType:E}),P=()=>{if(!f)return;const[W,G]=gb(R,A);x({x:W,y:G}),_=requestAnimationFrame(P)};o({connectionPosition:R,connectionStatus:null,connectionNodeId:t,connectionHandleId:e,connectionHandleType:E,connectionStartHandle:{nodeId:t,handleId:e,type:E},connectionEndHandle:null}),g?.(n,{nodeId:t,handleId:e,handleType:E});function $(W){const{transform:G}=s();R=$r(W,A);const{handle:z,validHandleResult:Z}=zR(W,u,ch(R,G,!1,[1,1]),p,k,ee=>Cb(ee,d,t,e,i?"target":"source",a,u));if(v=z,L||(P(),L=!0),U=Z.handleDomNode,F=Z.connection,S=Z.isValid,o({connectionPosition:v&&S?Sb({x:v.x,y:v.y},G):R,connectionStatus:WR(!!v,S),connectionEndHandle:Z.endHandle}),!v&&!S&&!U)return au(B);F.source!==F.target&&U&&(au(B),B=U,U.classList.add("connecting","react-flow__handle-connecting"),U.classList.toggle("valid",S),U.classList.toggle("react-flow__handle-valid",S))}function M(W){(v||U)&&F&&S&&r?.(F),s().onConnectEnd?.(W),c&&l?.(W),au(B),y(),cancelAnimationFrame(_),L=!1,S=!1,F=null,U=null,u.removeEventListener("mousemove",$),u.removeEventListener("mouseup",M),u.removeEventListener("touchmove",$),u.removeEventListener("touchend",M)}u.addEventListener("mousemove",$),u.addEventListener("mouseup",M),u.addEventListener("touchmove",$),u.addEventListener("touchend",M)}const yg=()=>!0,qR=n=>({connectionStartHandle:n.connectionStartHandle,connectOnClick:n.connectOnClick,noPanClassName:n.noPanClassName}),XR=(n,e,t)=>r=>{const{connectionStartHandle:i,connectionEndHandle:s,connectionClickStartHandle:o}=r;return{connecting:i?.nodeId===n&&i?.handleId===e&&i?.type===t||s?.nodeId===n&&s?.handleId===e&&s?.type===t,clickConnecting:o?.nodeId===n&&o?.handleId===e&&o?.type===t}},Pb=D.forwardRef(({type:n="source",position:e=he.Top,isValidConnection:t,isConnectable:r=!0,isConnectableStart:i=!0,isConnectableEnd:s=!0,id:o,onConnect:a,children:c,className:l,onMouseDown:u,onTouchStart:d,...h},f)=>{const p=o||null,g=n==="target",x=xt(),m=UR(),{connectOnClick:y,noPanClassName:_}=tt(qR,Ct),{connecting:v,clickConnecting:T}=tt(XR(m,p,n),Ct);m||x.getState().onError?.("010",_r.error010());const w=A=>{const{defaultEdgeOptions:B,onConnect:R,hasDefaultEdges:L}=x.getState(),F={...B,...A};if(L){const{edges:S,setEdges:U}=x.getState();U(wb(F,S))}R?.(F),a?.(F)},N=A=>{if(!m)return;const B=yb(A);i&&(B&&A.button===0||!B)&&Mb({event:A,handleId:p,nodeId:m,onConnect:w,isTarget:g,getState:x.getState,setState:x.setState,isValidConnection:t||x.getState().isValidConnection||yg}),B?u?.(A):d?.(A)},E=A=>{const{onClickConnectStart:B,onClickConnectEnd:R,connectionClickStartHandle:L,connectionMode:F,isValidConnection:S}=x.getState();if(!m||!L&&!i)return;if(!L){B?.(A,{nodeId:m,handleId:p,handleType:n}),x.setState({connectionClickStartHandle:{nodeId:m,type:n,handleId:p}});return}const U=mb(A.target),k=t||S||yg,{connection:P,isValid:$}=Cb({nodeId:m,id:p,type:n},F,L.nodeId,L.handleId||null,L.type,k,U);$&&w(P),R?.(A),x.setState({connectionClickStartHandle:null})};return K.createElement("div",{"data-handleid":p,"data-nodeid":m,"data-handlepos":e,"data-id":`${m}-${p}-${n}`,className:It(["react-flow__handle",`react-flow__handle-${e}`,"nodrag",_,l,{source:!g,target:g,connectable:r,connectablestart:i,connectableend:s,connecting:T,connectionindicator:r&&(i&&!v||s&&v)}]),onMouseDown:N,onTouchStart:N,onClick:y?E:void 0,ref:f,...h},c)});Pb.displayName="Handle";var Ns=D.memo(Pb);const Db=({data:n,isConnectable:e,targetPosition:t=he.Top,sourcePosition:r=he.Bottom})=>K.createElement(K.Fragment,null,K.createElement(Ns,{type:"target",position:t,isConnectable:e}),n?.label,K.createElement(Ns,{type:"source",position:r,isConnectable:e}));Db.displayName="DefaultNode";var lh=D.memo(Db);const Bb=({data:n,isConnectable:e,sourcePosition:t=he.Bottom})=>K.createElement(K.Fragment,null,n?.label,K.createElement(Ns,{type:"source",position:t,isConnectable:e}));Bb.displayName="InputNode";var Fb=D.memo(Bb);const kb=({data:n,isConnectable:e,targetPosition:t=he.Top})=>K.createElement(K.Fragment,null,K.createElement(Ns,{type:"target",position:t,isConnectable:e}),n?.label);kb.displayName="OutputNode";var Ib=D.memo(kb);const Ff=()=>null;Ff.displayName="GroupNode";const YR=n=>({selectedNodes:n.getNodes().filter(e=>e.selected),selectedEdges:n.edges.filter(e=>e.selected).map(e=>({...e}))}),Ea=n=>n.id;function KR(n,e){return Ct(n.selectedNodes.map(Ea),e.selectedNodes.map(Ea))&&Ct(n.selectedEdges.map(Ea),e.selectedEdges.map(Ea))}const Lb=D.memo(({onSelectionChange:n})=>{const e=xt(),{selectedNodes:t,selectedEdges:r}=tt(YR,KR);return D.useEffect(()=>{const i={nodes:t,edges:r};n?.(i),e.getState().onSelectionChange.forEach(s=>s(i))},[t,r,n]),null});Lb.displayName="SelectionListener";const QR=n=>!!n.onSelectionChange;function ZR({onSelectionChange:n}){const e=tt(QR);return n||e?K.createElement(Lb,{onSelectionChange:n}):null}const JR=n=>({setNodes:n.setNodes,setEdges:n.setEdges,setDefaultNodesAndEdges:n.setDefaultNodesAndEdges,setMinZoom:n.setMinZoom,setMaxZoom:n.setMaxZoom,setTranslateExtent:n.setTranslateExtent,setNodeExtent:n.setNodeExtent,reset:n.reset});function Gi(n,e){D.useEffect(()=>{typeof n<"u"&&e(n)},[n])}function we(n,e,t){D.useEffect(()=>{typeof e<"u"&&t({[n]:e})},[e])}const eC=({nodes:n,edges:e,defaultNodes:t,defaultEdges:r,onConnect:i,onConnectStart:s,onConnectEnd:o,onClickConnectStart:a,onClickConnectEnd:c,nodesDraggable:l,nodesConnectable:u,nodesFocusable:d,edgesFocusable:h,edgesUpdatable:f,elevateNodesOnSelect:p,minZoom:g,maxZoom:x,nodeExtent:m,onNodesChange:y,onEdgesChange:_,elementsSelectable:v,connectionMode:T,snapGrid:w,snapToGrid:N,translateExtent:E,connectOnClick:A,defaultEdgeOptions:B,fitView:R,fitViewOptions:L,onNodesDelete:F,onEdgesDelete:S,onNodeDrag:U,onNodeDragStart:k,onNodeDragStop:P,onSelectionDrag:$,onSelectionDragStart:M,onSelectionDragStop:W,noPanClassName:G,nodeOrigin:z,rfId:Z,autoPanOnConnect:ee,autoPanOnNodeDrag:O,onError:Y,connectionRadius:te,isValidConnection:ae,nodeDragThreshold:me})=>{const{setNodes:ge,setEdges:Se,setDefaultNodesAndEdges:et,setMinZoom:ft,setMaxZoom:it,setTranslateExtent:je,setNodeExtent:yt,reset:Ce}=tt(JR,Ct),ue=xt();return D.useEffect(()=>{const qt=r?.map(Kr=>({...Kr,...B}));return et(t,qt),()=>{Ce()}},[]),we("defaultEdgeOptions",B,ue.setState),we("connectionMode",T,ue.setState),we("onConnect",i,ue.setState),we("onConnectStart",s,ue.setState),we("onConnectEnd",o,ue.setState),we("onClickConnectStart",a,ue.setState),we("onClickConnectEnd",c,ue.setState),we("nodesDraggable",l,ue.setState),we("nodesConnectable",u,ue.setState),we("nodesFocusable",d,ue.setState),we("edgesFocusable",h,ue.setState),we("edgesUpdatable",f,ue.setState),we("elementsSelectable",v,ue.setState),we("elevateNodesOnSelect",p,ue.setState),we("snapToGrid",N,ue.setState),we("snapGrid",w,ue.setState),we("onNodesChange",y,ue.setState),we("onEdgesChange",_,ue.setState),we("connectOnClick",A,ue.setState),we("fitViewOnInit",R,ue.setState),we("fitViewOnInitOptions",L,ue.setState),we("onNodesDelete",F,ue.setState),we("onEdgesDelete",S,ue.setState),we("onNodeDrag",U,ue.setState),we("onNodeDragStart",k,ue.setState),we("onNodeDragStop",P,ue.setState),we("onSelectionDrag",$,ue.setState),we("onSelectionDragStart",M,ue.setState),we("onSelectionDragStop",W,ue.setState),we("noPanClassName",G,ue.setState),we("nodeOrigin",z,ue.setState),we("rfId",Z,ue.setState),we("autoPanOnConnect",ee,ue.setState),we("autoPanOnNodeDrag",O,ue.setState),we("onError",Y,ue.setState),we("connectionRadius",te,ue.setState),we("isValidConnection",ae,ue.setState),we("nodeDragThreshold",me,ue.setState),Gi(n,ge),Gi(e,Se),Gi(g,ft),Gi(x,it),Gi(E,je),Gi(m,yt),null},bg={display:"none"},tC={position:"absolute",width:1,height:1,margin:-1,border:0,padding:0,overflow:"hidden",clip:"rect(0px, 0px, 0px, 0px)",clipPath:"inset(100%)"},Ob="react-flow__node-desc",Ub="react-flow__edge-desc",nC="react-flow__aria-live",rC=n=>n.ariaLiveMessage;function iC({rfId:n}){const e=tt(rC);return K.createElement("div",{id:`${nC}-${n}`,"aria-live":"assertive","aria-atomic":"true",style:tC},e)}function sC({rfId:n,disableKeyboardA11y:e}){return K.createElement(K.Fragment,null,K.createElement("div",{id:`${Ob}-${n}`,style:bg},"Press enter or space to select a node.",!e&&"You can then use the arrow keys to move the node around."," Press delete to remove it and escape to cancel."," "),K.createElement("div",{id:`${Ub}-${n}`,style:bg},"Press enter or space to select an edge. You can then press delete to remove it or escape to cancel."),!e&&K.createElement(iC,{rfId:n}))}var Yo=(n=null,e={actInsideInputWithModifier:!0})=>{const[t,r]=D.useState(!1),i=D.useRef(!1),s=D.useRef(new Set([])),[o,a]=D.useMemo(()=>{if(n!==null){const l=(Array.isArray(n)?n:[n]).filter(d=>typeof d=="string").map(d=>d.split("+")),u=l.reduce((d,h)=>d.concat(...h),[]);return[l,u]}return[[],[]]},[n]);return D.useEffect(()=>{const c=typeof document<"u"?document:null,l=e?.target||c;if(n!==null){const u=f=>{if(i.current=f.ctrlKey||f.metaKey||f.shiftKey,(!i.current||i.current&&!e.actInsideInputWithModifier)&&sh(f))return!1;const g=vg(f.code,a);s.current.add(f[g]),_g(o,s.current,!1)&&(f.preventDefault(),r(!0))},d=f=>{if((!i.current||i.current&&!e.actInsideInputWithModifier)&&sh(f))return!1;const g=vg(f.code,a);_g(o,s.current,!0)?(r(!1),s.current.clear()):s.current.delete(f[g]),f.key==="Meta"&&s.current.clear(),i.current=!1},h=()=>{s.current.clear(),r(!1)};return l?.addEventListener("keydown",u),l?.addEventListener("keyup",d),window.addEventListener("blur",h),()=>{l?.removeEventListener("keydown",u),l?.removeEventListener("keyup",d),window.removeEventListener("blur",h)}}},[n,r]),t};function _g(n,e,t){return n.filter(r=>t||r.length===e.size).some(r=>r.every(i=>e.has(i)))}function vg(n,e){return e.includes(n)?"code":"key"}function Gb(n,e,t,r){const i=n.parentNode||n.parentId;if(!i)return t;const s=e.get(i),o=hs(s,r);return Gb(s,e,{x:(t.x??0)+o.x,y:(t.y??0)+o.y,z:(s[rt]?.z??0)>(t.z??0)?s[rt]?.z??0:t.z??0},r)}function $b(n,e,t){n.forEach(r=>{const i=r.parentNode||r.parentId;if(i&&!n.has(i))throw new Error(`Parent node ${i} not found`);if(i||t?.[r.id]){const{x:s,y:o,z:a}=Gb(r,n,{...r.position,z:r[rt]?.z??0},e);r.positionAbsolute={x:s,y:o},r[rt].z=a,t?.[r.id]&&(r[rt].isParent=!0)}})}function cu(n,e,t,r){const i=new Map,s={},o=r?1e3:0;return n.forEach(a=>{const c=(sn(a.zIndex)?a.zIndex:0)+(a.selected?o:0),l=e.get(a.id),u={...a,positionAbsolute:{x:a.position.x,y:a.position.y}},d=a.parentNode||a.parentId;d&&(s[d]=!0);const h=l?.type&&l?.type!==a.type;Object.defineProperty(u,rt,{enumerable:!1,value:{handleBounds:h?void 0:l?.[rt]?.handleBounds,z:c}}),i.set(a.id,u)}),$b(i,t,s),i}function Vb(n,e={}){const{getNodes:t,width:r,height:i,minZoom:s,maxZoom:o,d3Zoom:a,d3Selection:c,fitViewOnInitDone:l,fitViewOnInit:u,nodeOrigin:d}=n(),h=e.initial&&!l&&u;if(a&&c&&(h||!e.initial)){const p=t().filter(x=>{const m=e.includeHiddenNodes?x.width&&x.height:!x.hidden;return e.nodes?.length?m&&e.nodes.some(y=>y.id===x.id):m}),g=p.every(x=>x.width&&x.height);if(p.length>0&&g){const x=Df(p,d),{x:m,y,zoom:_}=Ab(x,r,i,e.minZoom??s,e.maxZoom??o,e.padding??.1),v=Gr.translate(m,y).scale(_);return typeof e.duration=="number"&&e.duration>0?a.transform(ci(c,e.duration),v):a.transform(c,v),!0}}return!1}function oC(n,e){return n.forEach(t=>{const r=e.get(t.id);r&&e.set(r.id,{...r,[rt]:r[rt],selected:t.selected})}),new Map(e)}function aC(n,e){return e.map(t=>{const r=n.find(i=>i.id===t.id);return r&&(t.selected=r.selected),t})}function Aa({changedNodes:n,changedEdges:e,get:t,set:r}){const{nodeInternals:i,edges:s,onNodesChange:o,onEdgesChange:a,hasDefaultNodes:c,hasDefaultEdges:l}=t();n?.length&&(c&&r({nodeInternals:oC(n,i)}),o?.(n)),e?.length&&(l&&r({edges:aC(e,s)}),a?.(e))}const $i=()=>{},cC={zoomIn:$i,zoomOut:$i,zoomTo:$i,getZoom:()=>1,setViewport:$i,getViewport:()=>({x:0,y:0,zoom:1}),fitView:()=>!1,setCenter:$i,fitBounds:$i,project:n=>n,screenToFlowPosition:n=>n,flowToScreenPosition:n=>n,viewportInitialized:!1},lC=n=>({d3Zoom:n.d3Zoom,d3Selection:n.d3Selection}),uC=()=>{const n=xt(),{d3Zoom:e,d3Selection:t}=tt(lC,Ct);return D.useMemo(()=>t&&e?{zoomIn:i=>e.scaleBy(ci(t,i?.duration),1.2),zoomOut:i=>e.scaleBy(ci(t,i?.duration),1/1.2),zoomTo:(i,s)=>e.scaleTo(ci(t,s?.duration),i),getZoom:()=>n.getState().transform[2],setViewport:(i,s)=>{const[o,a,c]=n.getState().transform,l=Gr.translate(i.x??o,i.y??a).scale(i.zoom??c);e.transform(ci(t,s?.duration),l)},getViewport:()=>{const[i,s,o]=n.getState().transform;return{x:i,y:s,zoom:o}},fitView:i=>Vb(n.getState,i),setCenter:(i,s,o)=>{const{width:a,height:c,maxZoom:l}=n.getState(),u=typeof o?.zoom<"u"?o.zoom:l,d=a/2-i*u,h=c/2-s*u,f=Gr.translate(d,h).scale(u);e.transform(ci(t,o?.duration),f)},fitBounds:(i,s)=>{const{width:o,height:a,minZoom:c,maxZoom:l}=n.getState(),{x:u,y:d,zoom:h}=Ab(i,o,a,c,l,s?.padding??.1),f=Gr.translate(u,d).scale(h);e.transform(ci(t,s?.duration),f)},project:i=>{const{transform:s,snapToGrid:o,snapGrid:a}=n.getState();return console.warn("[DEPRECATED] `project` is deprecated. Instead use `screenToFlowPosition`. There is no need to subtract the react flow bounds anymore! https://reactflow.dev/api-reference/types/react-flow-instance#screen-to-flow-position"),ch(i,s,o,a)},screenToFlowPosition:i=>{const{transform:s,snapToGrid:o,snapGrid:a,domNode:c}=n.getState();if(!c)return i;const{x:l,y:u}=c.getBoundingClientRect(),d={x:i.x-l,y:i.y-u};return ch(d,s,o,a)},flowToScreenPosition:i=>{const{transform:s,domNode:o}=n.getState();if(!o)return i;const{x:a,y:c}=o.getBoundingClientRect(),l=Sb(i,s);return{x:l.x+a,y:l.y+c}},viewportInitialized:!0}:cC,[e,t])};function kf(){const n=uC(),e=xt(),t=D.useCallback(()=>e.getState().getNodes().map(g=>({...g})),[]),r=D.useCallback(g=>e.getState().nodeInternals.get(g),[]),i=D.useCallback(()=>{const{edges:g=[]}=e.getState();return g.map(x=>({...x}))},[]),s=D.useCallback(g=>{const{edges:x=[]}=e.getState();return x.find(m=>m.id===g)},[]),o=D.useCallback(g=>{const{getNodes:x,setNodes:m,hasDefaultNodes:y,onNodesChange:_}=e.getState(),v=x(),T=typeof g=="function"?g(v):g;if(y)m(T);else if(_){const w=T.length===0?v.map(N=>({type:"remove",id:N.id})):T.map(N=>({item:N,type:"reset"}));_(w)}},[]),a=D.useCallback(g=>{const{edges:x=[],setEdges:m,hasDefaultEdges:y,onEdgesChange:_}=e.getState(),v=typeof g=="function"?g(x):g;if(y)m(v);else if(_){const T=v.length===0?x.map(w=>({type:"remove",id:w.id})):v.map(w=>({item:w,type:"reset"}));_(T)}},[]),c=D.useCallback(g=>{const x=Array.isArray(g)?g:[g],{getNodes:m,setNodes:y,hasDefaultNodes:_,onNodesChange:v}=e.getState();if(_){const w=[...m(),...x];y(w)}else if(v){const T=x.map(w=>({item:w,type:"add"}));v(T)}},[]),l=D.useCallback(g=>{const x=Array.isArray(g)?g:[g],{edges:m=[],setEdges:y,hasDefaultEdges:_,onEdgesChange:v}=e.getState();if(_)y([...m,...x]);else if(v){const T=x.map(w=>({item:w,type:"add"}));v(T)}},[]),u=D.useCallback(()=>{const{getNodes:g,edges:x=[],transform:m}=e.getState(),[y,_,v]=m;return{nodes:g().map(T=>({...T})),edges:x.map(T=>({...T})),viewport:{x:y,y:_,zoom:v}}},[]),d=D.useCallback(({nodes:g,edges:x})=>{const{nodeInternals:m,getNodes:y,edges:_,hasDefaultNodes:v,hasDefaultEdges:T,onNodesDelete:w,onEdgesDelete:N,onNodesChange:E,onEdgesChange:A}=e.getState(),B=(g||[]).map(U=>U.id),R=(x||[]).map(U=>U.id),L=y().reduce((U,k)=>{const P=k.parentNode||k.parentId,$=!B.includes(k.id)&&P&&U.find(W=>W.id===P);return(typeof k.deletable=="boolean"?k.deletable:!0)&&(B.includes(k.id)||$)&&U.push(k),U},[]),F=_.filter(U=>typeof U.deletable=="boolean"?U.deletable:!0),S=F.filter(U=>R.includes(U.id));if(L||S){const U=Eb(L,F),k=[...S,...U],P=k.reduce(($,M)=>($.includes(M.id)||$.push(M.id),$),[]);if((T||v)&&(T&&e.setState({edges:_.filter($=>!P.includes($.id))}),v&&(L.forEach($=>{m.delete($.id)}),e.setState({nodeInternals:new Map(m)}))),P.length>0&&(N?.(k),A&&A(P.map($=>({id:$,type:"remove"})))),L.length>0&&(w?.(L),E)){const $=L.map(M=>({id:M.id,type:"remove"}));E($)}}},[]),h=D.useCallback(g=>{const x=PR(g),m=x?null:e.getState().nodeInternals.get(g.id);return!x&&!m?[null,null,x]:[x?g:hg(m),m,x]},[]),f=D.useCallback((g,x=!0,m)=>{const[y,_,v]=h(g);return y?(m||e.getState().getNodes()).filter(T=>{if(!v&&(T.id===_.id||!T.positionAbsolute))return!1;const w=hg(T),N=ih(w,y);return x&&N>0||N>=y.width*y.height}):[]},[]),p=D.useCallback((g,x,m=!0)=>{const[y]=h(g);if(!y)return!1;const _=ih(y,x);return m&&_>0||_>=y.width*y.height},[]);return D.useMemo(()=>({...n,getNodes:t,getNode:r,getEdges:i,getEdge:s,setNodes:o,setEdges:a,addNodes:c,addEdges:l,toObject:u,deleteElements:d,getIntersectingNodes:f,isNodeIntersecting:p}),[n,t,r,i,s,o,a,c,l,u,d,f,p])}const dC={actInsideInputWithModifier:!1};var hC=({deleteKeyCode:n,multiSelectionKeyCode:e})=>{const t=xt(),{deleteElements:r}=kf(),i=Yo(n,dC),s=Yo(e);D.useEffect(()=>{if(i){const{edges:o,getNodes:a}=t.getState(),c=a().filter(u=>u.selected),l=o.filter(u=>u.selected);r({nodes:c,edges:l}),t.setState({nodesSelectionActive:!1})}},[i]),D.useEffect(()=>{t.setState({multiSelectionActive:s})},[s])};function fC(n){const e=xt();D.useEffect(()=>{let t;const r=()=>{if(!n.current)return;const i=Nf(n.current);(i.height===0||i.width===0)&&e.getState().onError?.("004",_r.error004()),e.setState({width:i.width||500,height:i.height||500})};return r(),window.addEventListener("resize",r),n.current&&(t=new ResizeObserver(()=>r()),t.observe(n.current)),()=>{window.removeEventListener("resize",r),t&&n.current&&t.unobserve(n.current)}},[])}const If={position:"absolute",width:"100%",height:"100%",top:0,left:0},pC=(n,e)=>n.x!==e.x||n.y!==e.y||n.zoom!==e.k,Ra=n=>({x:n.x,y:n.y,zoom:n.k}),Vi=(n,e)=>n.target.closest(`.${e}`),Tg=(n,e)=>e===2&&Array.isArray(n)&&n.includes(2),wg=n=>{const e=n.ctrlKey&&qc()?10:1;return-n.deltaY*(n.deltaMode===1?.05:n.deltaMode?1:.002)*e},gC=n=>({d3Zoom:n.d3Zoom,d3Selection:n.d3Selection,d3ZoomHandler:n.d3ZoomHandler,userSelectionActive:n.userSelectionActive}),mC=({onMove:n,onMoveStart:e,onMoveEnd:t,onPaneContextMenu:r,zoomOnScroll:i=!0,zoomOnPinch:s=!0,panOnScroll:o=!1,panOnScrollSpeed:a=.5,panOnScrollMode:c=bi.Free,zoomOnDoubleClick:l=!0,elementsSelectable:u,panOnDrag:d=!0,defaultViewport:h,translateExtent:f,minZoom:p,maxZoom:g,zoomActivationKeyCode:x,preventScrolling:m=!0,children:y,noWheelClassName:_,noPanClassName:v})=>{const T=D.useRef(),w=xt(),N=D.useRef(!1),E=D.useRef(!1),A=D.useRef(null),B=D.useRef({x:0,y:0,zoom:0}),{d3Zoom:R,d3Selection:L,d3ZoomHandler:F,userSelectionActive:S}=tt(gC,Ct),U=Yo(x),k=D.useRef(0),P=D.useRef(!1),$=D.useRef();return fC(A),D.useEffect(()=>{if(A.current){const M=A.current.getBoundingClientRect(),W=hb().scaleExtent([p,g]).translateExtent(f),G=st(A.current).call(W),z=Gr.translate(h.x,h.y).scale(Ss(h.zoom,p,g)),Z=[[0,0],[M.width,M.height]],ee=W.constrain()(z,Z,f);W.transform(G,ee),W.wheelDelta(wg),w.setState({d3Zoom:W,d3Selection:G,d3ZoomHandler:G.on("wheel.zoom"),transform:[ee.x,ee.y,ee.k],domNode:A.current.closest(".react-flow")})}},[]),D.useEffect(()=>{L&&R&&(o&&!U&&!S?L.on("wheel.zoom",M=>{if(Vi(M,_))return!1;M.preventDefault(),M.stopImmediatePropagation();const W=L.property("__zoom").k||1;if(M.ctrlKey&&s){const ae=fn(M),me=wg(M),ge=W*Math.pow(2,me);R.scaleTo(L,ge,ae,M);return}const G=M.deltaMode===1?20:1;let z=c===bi.Vertical?0:M.deltaX*G,Z=c===bi.Horizontal?0:M.deltaY*G;!qc()&&M.shiftKey&&c!==bi.Vertical&&(z=M.deltaY*G,Z=0),R.translateBy(L,-(z/W)*a,-(Z/W)*a,{internal:!0});const ee=Ra(L.property("__zoom")),{onViewportChangeStart:O,onViewportChange:Y,onViewportChangeEnd:te}=w.getState();clearTimeout($.current),P.current||(P.current=!0,e?.(M,ee),O?.(ee)),P.current&&(n?.(M,ee),Y?.(ee),$.current=setTimeout(()=>{t?.(M,ee),te?.(ee),P.current=!1},150))},{passive:!1}):typeof F<"u"&&L.on("wheel.zoom",function(M,W){if(!m&&M.type==="wheel"&&!M.ctrlKey||Vi(M,_))return null;M.preventDefault(),F.call(this,M,W)},{passive:!1}))},[S,o,c,L,R,F,U,s,m,_,e,n,t]),D.useEffect(()=>{R&&R.on("start",M=>{if(!M.sourceEvent||M.sourceEvent.internal)return null;k.current=M.sourceEvent?.button;const{onViewportChangeStart:W}=w.getState(),G=Ra(M.transform);N.current=!0,B.current=G,M.sourceEvent?.type==="mousedown"&&w.setState({paneDragging:!0}),W?.(G),e?.(M.sourceEvent,G)})},[R,e]),D.useEffect(()=>{R&&(S&&!N.current?R.on("zoom",null):S||R.on("zoom",M=>{const{onViewportChange:W}=w.getState();if(w.setState({transform:[M.transform.x,M.transform.y,M.transform.k]}),E.current=!!(r&&Tg(d,k.current??0)),(n||W)&&!M.sourceEvent?.internal){const G=Ra(M.transform);W?.(G),n?.(M.sourceEvent,G)}}))},[S,R,n,d,r]),D.useEffect(()=>{R&&R.on("end",M=>{if(!M.sourceEvent||M.sourceEvent.internal)return null;const{onViewportChangeEnd:W}=w.getState();if(N.current=!1,w.setState({paneDragging:!1}),r&&Tg(d,k.current??0)&&!E.current&&r(M.sourceEvent),E.current=!1,(t||W)&&pC(B.current,M.transform)){const G=Ra(M.transform);B.current=G,clearTimeout(T.current),T.current=setTimeout(()=>{W?.(G),t?.(M.sourceEvent,G)},o?150:0)}})},[R,o,d,t,r]),D.useEffect(()=>{R&&R.filter(M=>{const W=U||i,G=s&&M.ctrlKey;if((d===!0||Array.isArray(d)&&d.includes(1))&&M.button===1&&M.type==="mousedown"&&(Vi(M,"react-flow__node")||Vi(M,"react-flow__edge")))return!0;if(!d&&!W&&!o&&!l&&!s||S||!l&&M.type==="dblclick"||Vi(M,_)&&M.type==="wheel"||Vi(M,v)&&(M.type!=="wheel"||o&&M.type==="wheel"&&!U)||!s&&M.ctrlKey&&M.type==="wheel"||!W&&!o&&!G&&M.type==="wheel"||!d&&(M.type==="mousedown"||M.type==="touchstart")||Array.isArray(d)&&!d.includes(M.button)&&M.type==="mousedown")return!1;const z=Array.isArray(d)&&d.includes(M.button)||!M.button||M.button<=1;return(!M.ctrlKey||M.type==="wheel")&&z})},[S,R,i,s,o,l,d,u,U]),K.createElement("div",{className:"react-flow__renderer",ref:A,style:If},y)},xC=n=>({userSelectionActive:n.userSelectionActive,userSelectionRect:n.userSelectionRect});function yC(){const{userSelectionActive:n,userSelectionRect:e}=tt(xC,Ct);return n&&e?K.createElement("div",{className:"react-flow__selection react-flow__container",style:{width:e.width,height:e.height,transform:`translate(${e.x}px, ${e.y}px)`}}):null}function Sg(n,e){const t=e.parentNode||e.parentId,r=n.find(i=>i.id===t);if(r){const i=e.position.x+e.width-r.width,s=e.position.y+e.height-r.height;if(i>0||s>0||e.position.x<0||e.position.y<0){if(r.style={...r.style},r.style.width=r.style.width??r.width,r.style.height=r.style.height??r.height,i>0&&(r.style.width+=i),s>0&&(r.style.height+=s),e.position.x<0){const o=Math.abs(e.position.x);r.position.x=r.position.x-o,r.style.width+=o,e.position.x=0}if(e.position.y<0){const o=Math.abs(e.position.y);r.position.y=r.position.y-o,r.style.height+=o,e.position.y=0}r.width=r.style.width,r.height=r.style.height}}}function zb(n,e){if(n.some(r=>r.type==="reset"))return n.filter(r=>r.type==="reset").map(r=>r.item);const t=n.filter(r=>r.type==="add").map(r=>r.item);return e.reduce((r,i)=>{const s=n.filter(a=>a.id===i.id);if(s.length===0)return r.push(i),r;const o={...i};for(const a of s)if(a)switch(a.type){case"select":{o.selected=a.selected;break}case"position":{typeof a.position<"u"&&(o.position=a.position),typeof a.positionAbsolute<"u"&&(o.positionAbsolute=a.positionAbsolute),typeof a.dragging<"u"&&(o.dragging=a.dragging),o.expandParent&&Sg(r,o);break}case"dimensions":{typeof a.dimensions<"u"&&(o.width=a.dimensions.width,o.height=a.dimensions.height),typeof a.updateStyle<"u"&&(o.style={...o.style||{},...a.dimensions}),typeof a.resizing=="boolean"&&(o.resizing=a.resizing),o.expandParent&&Sg(r,o);break}case"remove":return r}return r.push(o),r},t)}function jb(n,e){return zb(n,e)}function bC(n,e){return zb(n,e)}const Cr=(n,e)=>({id:n,type:"select",selected:e});function ss(n,e){return n.reduce((t,r)=>{const i=e.includes(r.id);return!r.selected&&i?(r.selected=!0,t.push(Cr(r.id,!0))):r.selected&&!i&&(r.selected=!1,t.push(Cr(r.id,!1))),t},[])}const lu=(n,e)=>t=>{t.target===e.current&&n?.(t)},_C=n=>({userSelectionActive:n.userSelectionActive,elementsSelectable:n.elementsSelectable,dragging:n.paneDragging}),Hb=D.memo(({isSelecting:n,selectionMode:e=Xo.Full,panOnDrag:t,onSelectionStart:r,onSelectionEnd:i,onPaneClick:s,onPaneContextMenu:o,onPaneScroll:a,onPaneMouseEnter:c,onPaneMouseMove:l,onPaneMouseLeave:u,children:d})=>{const h=D.useRef(null),f=xt(),p=D.useRef(0),g=D.useRef(0),x=D.useRef(),{userSelectionActive:m,elementsSelectable:y,dragging:_}=tt(_C,Ct),v=()=>{f.setState({userSelectionActive:!1,userSelectionRect:null}),p.current=0,g.current=0},T=F=>{s?.(F),f.getState().resetSelectedElements(),f.setState({nodesSelectionActive:!1})},w=F=>{if(Array.isArray(t)&&t?.includes(2)){F.preventDefault();return}o?.(F)},N=a?F=>a(F):void 0,E=F=>{const{resetSelectedElements:S,domNode:U}=f.getState();if(x.current=U?.getBoundingClientRect(),!y||!n||F.button!==0||F.target!==h.current||!x.current)return;const{x:k,y:P}=$r(F,x.current);S(),f.setState({userSelectionRect:{width:0,height:0,startX:k,startY:P,x:k,y:P}}),r?.(F)},A=F=>{const{userSelectionRect:S,nodeInternals:U,edges:k,transform:P,onNodesChange:$,onEdgesChange:M,nodeOrigin:W,getNodes:G}=f.getState();if(!n||!x.current||!S)return;f.setState({userSelectionActive:!0,nodesSelectionActive:!1});const z=$r(F,x.current),Z=S.startX??0,ee=S.startY??0,O={...S,x:z.x<Z?z.x:Z,y:z.y<ee?z.y:ee,width:Math.abs(z.x-Z),height:Math.abs(z.y-ee)},Y=G(),te=Nb(U,O,P,e===Xo.Partial,!0,W),ae=Eb(te,k).map(ge=>ge.id),me=te.map(ge=>ge.id);if(p.current!==me.length){p.current=me.length;const ge=ss(Y,me);ge.length&&$?.(ge)}if(g.current!==ae.length){g.current=ae.length;const ge=ss(k,ae);ge.length&&M?.(ge)}f.setState({userSelectionRect:O})},B=F=>{if(F.button!==0)return;const{userSelectionRect:S}=f.getState();!m&&S&&F.target===h.current&&T?.(F),f.setState({nodesSelectionActive:p.current>0}),v(),i?.(F)},R=F=>{m&&(f.setState({nodesSelectionActive:p.current>0}),i?.(F)),v()},L=y&&(n||m);return K.createElement("div",{className:It(["react-flow__pane",{dragging:_,selection:n}]),onClick:L?void 0:lu(T,h),onContextMenu:lu(w,h),onWheel:lu(N,h),onMouseEnter:L?void 0:c,onMouseDown:L?E:void 0,onMouseMove:L?A:l,onMouseUp:L?B:void 0,onMouseLeave:L?R:u,ref:h,style:If},d,K.createElement(yC,null))});Hb.displayName="Pane";function Wb(n,e){const t=n.parentNode||n.parentId;if(!t)return!1;const r=e.get(t);return r?r.selected?!0:Wb(r,e):!1}function Ng(n,e,t){let r=n;do{if(r?.matches(e))return!0;if(r===t.current)return!1;r=r.parentElement}while(r);return!1}function vC(n,e,t,r){return Array.from(n.values()).filter(i=>(i.selected||i.id===r)&&(!i.parentNode||i.parentId||!Wb(i,n))&&(i.draggable||e&&typeof i.draggable>"u")).map(i=>({id:i.id,position:i.position||{x:0,y:0},positionAbsolute:i.positionAbsolute||{x:0,y:0},distance:{x:t.x-(i.positionAbsolute?.x??0),y:t.y-(i.positionAbsolute?.y??0)},delta:{x:0,y:0},extent:i.extent,parentNode:i.parentNode||i.parentId,parentId:i.parentNode||i.parentId,width:i.width,height:i.height,expandParent:i.expandParent}))}function TC(n,e){return!e||e==="parent"?e:[e[0],[e[1][0]-(n.width||0),e[1][1]-(n.height||0)]]}function qb(n,e,t,r,i=[0,0],s){const o=TC(n,n.extent||r);let a=o;const c=n.parentNode||n.parentId;if(n.extent==="parent"&&!n.expandParent)if(c&&n.width&&n.height){const d=t.get(c),{x:h,y:f}=hs(d,i).positionAbsolute;a=d&&sn(h)&&sn(f)&&sn(d.width)&&sn(d.height)?[[h+n.width*i[0],f+n.height*i[1]],[h+d.width-n.width+n.width*i[0],f+d.height-n.height+n.height*i[1]]]:a}else s?.("005",_r.error005()),a=o;else if(n.extent&&c&&n.extent!=="parent"){const d=t.get(c),{x:h,y:f}=hs(d,i).positionAbsolute;a=[[n.extent[0][0]+h,n.extent[0][1]+f],[n.extent[1][0]+h,n.extent[1][1]+f]]}let l={x:0,y:0};if(c){const d=t.get(c);l=hs(d,i).positionAbsolute}const u=a&&a!=="parent"?Ef(e,a):e;return{position:{x:u.x-l.x,y:u.y-l.y},positionAbsolute:u}}function uu({nodeId:n,dragItems:e,nodeInternals:t}){const r=e.map(i=>({...t.get(i.id),position:i.position,positionAbsolute:i.positionAbsolute}));return[n?r.find(i=>i.id===n):r[0],r]}const Eg=(n,e,t,r)=>{const i=e.querySelectorAll(n);if(!i||!i.length)return null;const s=Array.from(i),o=e.getBoundingClientRect(),a={x:o.width*r[0],y:o.height*r[1]};return s.map(c=>{const l=c.getBoundingClientRect();return{id:c.getAttribute("data-handleid"),position:c.getAttribute("data-handlepos"),x:(l.left-o.left-a.x)/t,y:(l.top-o.top-a.y)/t,...Nf(c)}})};function Qs(n,e,t){return t===void 0?t:r=>{const i=e().nodeInternals.get(n);i&&t(r,{...i})}}function uh({id:n,store:e,unselect:t=!1,nodeRef:r}){const{addSelectedNodes:i,unselectNodesAndEdges:s,multiSelectionActive:o,nodeInternals:a,onError:c}=e.getState(),l=a.get(n);if(!l){c?.("012",_r.error012(n));return}e.setState({nodesSelectionActive:!1}),l.selected?(t||l.selected&&o)&&(s({nodes:[l],edges:[]}),requestAnimationFrame(()=>r?.current?.blur())):i([n])}function wC(){const n=xt();return D.useCallback(({sourceEvent:t})=>{const{transform:r,snapGrid:i,snapToGrid:s}=n.getState(),o=t.touches?t.touches[0].clientX:t.clientX,a=t.touches?t.touches[0].clientY:t.clientY,c={x:(o-r[0])/r[2],y:(a-r[1])/r[2]};return{xSnapped:s?i[0]*Math.round(c.x/i[0]):c.x,ySnapped:s?i[1]*Math.round(c.y/i[1]):c.y,...c}},[])}function du(n){return(e,t,r)=>n?.(e,r)}function Xb({nodeRef:n,disabled:e=!1,noDragClassName:t,handleSelector:r,nodeId:i,isSelectable:s,selectNodesOnDrag:o}){const a=xt(),[c,l]=D.useState(!1),u=D.useRef([]),d=D.useRef({x:null,y:null}),h=D.useRef(0),f=D.useRef(null),p=D.useRef({x:0,y:0}),g=D.useRef(null),x=D.useRef(!1),m=D.useRef(!1),y=D.useRef(!1),_=wC();return D.useEffect(()=>{if(n?.current){const v=st(n.current),T=({x:E,y:A})=>{const{nodeInternals:B,onNodeDrag:R,onSelectionDrag:L,updateNodePositions:F,nodeExtent:S,snapGrid:U,snapToGrid:k,nodeOrigin:P,onError:$}=a.getState();d.current={x:E,y:A};let M=!1,W={x:0,y:0,x2:0,y2:0};if(u.current.length>1&&S){const z=Df(u.current,P);W=Af(z)}if(u.current=u.current.map(z=>{const Z={x:E-z.distance.x,y:A-z.distance.y};k&&(Z.x=U[0]*Math.round(Z.x/U[0]),Z.y=U[1]*Math.round(Z.y/U[1]));const ee=[[S[0][0],S[0][1]],[S[1][0],S[1][1]]];u.current.length>1&&S&&!z.extent&&(ee[0][0]=z.positionAbsolute.x-W.x+S[0][0],ee[1][0]=z.positionAbsolute.x+(z.width??0)-W.x2+S[1][0],ee[0][1]=z.positionAbsolute.y-W.y+S[0][1],ee[1][1]=z.positionAbsolute.y+(z.height??0)-W.y2+S[1][1]);const O=qb(z,Z,B,ee,P,$);return M=M||z.position.x!==O.position.x||z.position.y!==O.position.y,z.position=O.position,z.positionAbsolute=O.positionAbsolute,z}),!M)return;F(u.current,!0,!0),l(!0);const G=i?R:du(L);if(G&&g.current){const[z,Z]=uu({nodeId:i,dragItems:u.current,nodeInternals:B});G(g.current,z,Z)}},w=()=>{if(!f.current)return;const[E,A]=gb(p.current,f.current);if(E!==0||A!==0){const{transform:B,panBy:R}=a.getState();d.current.x=(d.current.x??0)-E/B[2],d.current.y=(d.current.y??0)-A/B[2],R({x:E,y:A})&&T(d.current)}h.current=requestAnimationFrame(w)},N=E=>{const{nodeInternals:A,multiSelectionActive:B,nodesDraggable:R,unselectNodesAndEdges:L,onNodeDragStart:F,onSelectionDragStart:S}=a.getState();m.current=!0;const U=i?F:du(S);(!o||!s)&&!B&&i&&(A.get(i)?.selected||L()),i&&s&&o&&uh({id:i,store:a,nodeRef:n});const k=_(E);if(d.current=k,u.current=vC(A,R,k,i),U&&u.current){const[P,$]=uu({nodeId:i,dragItems:u.current,nodeInternals:A});U(E.sourceEvent,P,$)}};if(e)v.on(".drag",null);else{const E=MA().on("start",A=>{const{domNode:B,nodeDragThreshold:R}=a.getState();R===0&&N(A),y.current=!1;const L=_(A);d.current=L,f.current=B?.getBoundingClientRect()||null,p.current=$r(A.sourceEvent,f.current)}).on("drag",A=>{const B=_(A),{autoPanOnNodeDrag:R,nodeDragThreshold:L}=a.getState();if(A.sourceEvent.type==="touchmove"&&A.sourceEvent.touches.length>1&&(y.current=!0),!y.current){if(!x.current&&m.current&&R&&(x.current=!0,w()),!m.current){const F=B.xSnapped-(d?.current?.x??0),S=B.ySnapped-(d?.current?.y??0);Math.sqrt(F*F+S*S)>L&&N(A)}(d.current.x!==B.xSnapped||d.current.y!==B.ySnapped)&&u.current&&m.current&&(g.current=A.sourceEvent,p.current=$r(A.sourceEvent,f.current),T(B))}}).on("end",A=>{if(!(!m.current||y.current)&&(l(!1),x.current=!1,m.current=!1,cancelAnimationFrame(h.current),u.current)){const{updateNodePositions:B,nodeInternals:R,onNodeDragStop:L,onSelectionDragStop:F}=a.getState(),S=i?L:du(F);if(B(u.current,!1,!1),S){const[U,k]=uu({nodeId:i,dragItems:u.current,nodeInternals:R});S(A.sourceEvent,U,k)}}}).filter(A=>{const B=A.target;return!A.button&&(!t||!Ng(B,`.${t}`,n))&&(!r||Ng(B,r,n))});return v.call(E),()=>{v.on(".drag",null)}}}},[n,e,t,r,s,a,i,o,_]),c}function Yb(){const n=xt();return D.useCallback(t=>{const{nodeInternals:r,nodeExtent:i,updateNodePositions:s,getNodes:o,snapToGrid:a,snapGrid:c,onError:l,nodesDraggable:u}=n.getState(),d=o().filter(y=>y.selected&&(y.draggable||u&&typeof y.draggable>"u")),h=a?c[0]:5,f=a?c[1]:5,p=t.isShiftPressed?4:1,g=t.x*h*p,x=t.y*f*p,m=d.map(y=>{if(y.positionAbsolute){const _={x:y.positionAbsolute.x+g,y:y.positionAbsolute.y+x};a&&(_.x=c[0]*Math.round(_.x/c[0]),_.y=c[1]*Math.round(_.y/c[1]));const{positionAbsolute:v,position:T}=qb(y,_,r,i,void 0,l);y.position=T,y.positionAbsolute=v}return y});s(m,!0,!1)},[])}const fs={ArrowUp:{x:0,y:-1},ArrowDown:{x:0,y:1},ArrowLeft:{x:-1,y:0},ArrowRight:{x:1,y:0}};var Zs=n=>{const e=({id:t,type:r,data:i,xPos:s,yPos:o,xPosOrigin:a,yPosOrigin:c,selected:l,onClick:u,onMouseEnter:d,onMouseMove:h,onMouseLeave:f,onContextMenu:p,onDoubleClick:g,style:x,className:m,isDraggable:y,isSelectable:_,isConnectable:v,isFocusable:T,selectNodesOnDrag:w,sourcePosition:N,targetPosition:E,hidden:A,resizeObserver:B,dragHandle:R,zIndex:L,isParent:F,noDragClassName:S,noPanClassName:U,initialized:k,disableKeyboardA11y:P,ariaLabel:$,rfId:M,hasHandleBounds:W})=>{const G=xt(),z=D.useRef(null),Z=D.useRef(null),ee=D.useRef(N),O=D.useRef(E),Y=D.useRef(r),te=_||y||u||d||h||f,ae=Yb(),me=Qs(t,G.getState,d),ge=Qs(t,G.getState,h),Se=Qs(t,G.getState,f),et=Qs(t,G.getState,p),ft=Qs(t,G.getState,g),it=Ce=>{const{nodeDragThreshold:ue}=G.getState();if(_&&(!w||!y||ue>0)&&uh({id:t,store:G,nodeRef:z}),u){const qt=G.getState().nodeInternals.get(t);qt&&u(Ce,{...qt})}},je=Ce=>{if(!sh(Ce)&&!P)if(xb.includes(Ce.key)&&_){const ue=Ce.key==="Escape";uh({id:t,store:G,unselect:ue,nodeRef:z})}else y&&l&&Object.prototype.hasOwnProperty.call(fs,Ce.key)&&(G.setState({ariaLiveMessage:`Moved selected node ${Ce.key.replace("Arrow","").toLowerCase()}. New position, x: ${~~s}, y: ${~~o}`}),ae({x:fs[Ce.key].x,y:fs[Ce.key].y,isShiftPressed:Ce.shiftKey}))};D.useEffect(()=>()=>{Z.current&&(B?.unobserve(Z.current),Z.current=null)},[]),D.useEffect(()=>{if(z.current&&!A){const Ce=z.current;(!k||!W||Z.current!==Ce)&&(Z.current&&B?.unobserve(Z.current),B?.observe(Ce),Z.current=Ce)}},[A,k,W]),D.useEffect(()=>{const Ce=Y.current!==r,ue=ee.current!==N,qt=O.current!==E;z.current&&(Ce||ue||qt)&&(Ce&&(Y.current=r),ue&&(ee.current=N),qt&&(O.current=E),G.getState().updateNodeDimensions([{id:t,nodeElement:z.current,forceUpdate:!0}]))},[t,r,N,E]);const yt=Xb({nodeRef:z,disabled:A||!y,noDragClassName:S,handleSelector:R,nodeId:t,isSelectable:_,selectNodesOnDrag:w});return A?null:K.createElement("div",{className:It(["react-flow__node",`react-flow__node-${r}`,{[U]:y},m,{selected:l,selectable:_,parent:F,dragging:yt}]),ref:z,style:{zIndex:L,transform:`translate(${a}px,${c}px)`,pointerEvents:te?"all":"none",visibility:k?"visible":"hidden",...x},"data-id":t,"data-testid":`rf__node-${t}`,onMouseEnter:me,onMouseMove:ge,onMouseLeave:Se,onContextMenu:et,onClick:it,onDoubleClick:ft,onKeyDown:T?je:void 0,tabIndex:T?0:void 0,role:T?"button":void 0,"aria-describedby":P?void 0:`${Ob}-${M}`,"aria-label":$},K.createElement(OR,{value:t},K.createElement(n,{id:t,data:i,type:r,xPos:s,yPos:o,selected:l,isConnectable:v,sourcePosition:N,targetPosition:E,dragging:yt,dragHandle:R,zIndex:L})))};return e.displayName="NodeWrapper",D.memo(e)};const SC=n=>{const e=n.getNodes().filter(t=>t.selected);return{...Df(e,n.nodeOrigin),transformString:`translate(${n.transform[0]}px,${n.transform[1]}px) scale(${n.transform[2]})`,userSelectionActive:n.userSelectionActive}};function NC({onSelectionContextMenu:n,noPanClassName:e,disableKeyboardA11y:t}){const r=xt(),{width:i,height:s,x:o,y:a,transformString:c,userSelectionActive:l}=tt(SC,Ct),u=Yb(),d=D.useRef(null);if(D.useEffect(()=>{t||d.current?.focus({preventScroll:!0})},[t]),Xb({nodeRef:d}),l||!i||!s)return null;const h=n?p=>{const g=r.getState().getNodes().filter(x=>x.selected);n(p,g)}:void 0,f=p=>{Object.prototype.hasOwnProperty.call(fs,p.key)&&u({x:fs[p.key].x,y:fs[p.key].y,isShiftPressed:p.shiftKey})};return K.createElement("div",{className:It(["react-flow__nodesselection","react-flow__container",e]),style:{transform:c}},K.createElement("div",{ref:d,className:"react-flow__nodesselection-rect",onContextMenu:h,tabIndex:t?void 0:-1,onKeyDown:t?void 0:f,style:{width:i,height:s,top:a,left:o}}))}var EC=D.memo(NC);const AC=n=>n.nodesSelectionActive,Kb=({children:n,onPaneClick:e,onPaneMouseEnter:t,onPaneMouseMove:r,onPaneMouseLeave:i,onPaneContextMenu:s,onPaneScroll:o,deleteKeyCode:a,onMove:c,onMoveStart:l,onMoveEnd:u,selectionKeyCode:d,selectionOnDrag:h,selectionMode:f,onSelectionStart:p,onSelectionEnd:g,multiSelectionKeyCode:x,panActivationKeyCode:m,zoomActivationKeyCode:y,elementsSelectable:_,zoomOnScroll:v,zoomOnPinch:T,panOnScroll:w,panOnScrollSpeed:N,panOnScrollMode:E,zoomOnDoubleClick:A,panOnDrag:B,defaultViewport:R,translateExtent:L,minZoom:F,maxZoom:S,preventScrolling:U,onSelectionContextMenu:k,noWheelClassName:P,noPanClassName:$,disableKeyboardA11y:M})=>{const W=tt(AC),G=Yo(d),z=Yo(m),Z=z||B,ee=z||w,O=G||h&&Z!==!0;return hC({deleteKeyCode:a,multiSelectionKeyCode:x}),K.createElement(mC,{onMove:c,onMoveStart:l,onMoveEnd:u,onPaneContextMenu:s,elementsSelectable:_,zoomOnScroll:v,zoomOnPinch:T,panOnScroll:ee,panOnScrollSpeed:N,panOnScrollMode:E,zoomOnDoubleClick:A,panOnDrag:!G&&Z,defaultViewport:R,translateExtent:L,minZoom:F,maxZoom:S,zoomActivationKeyCode:y,preventScrolling:U,noWheelClassName:P,noPanClassName:$},K.createElement(Hb,{onSelectionStart:p,onSelectionEnd:g,onPaneClick:e,onPaneMouseEnter:t,onPaneMouseMove:r,onPaneMouseLeave:i,onPaneContextMenu:s,onPaneScroll:o,panOnDrag:Z,isSelecting:!!O,selectionMode:f},n,W&&K.createElement(EC,{onSelectionContextMenu:k,noPanClassName:$,disableKeyboardA11y:M})))};Kb.displayName="FlowRenderer";var RC=D.memo(Kb);function CC(n){return tt(D.useCallback(t=>n?Nb(t.nodeInternals,{x:0,y:0,width:t.width,height:t.height},t.transform,!0):t.getNodes(),[n]))}function MC(n){const e={input:Zs(n.input||Fb),default:Zs(n.default||lh),output:Zs(n.output||Ib),group:Zs(n.group||Ff)},t={},r=Object.keys(n).filter(i=>!["input","default","output","group"].includes(i)).reduce((i,s)=>(i[s]=Zs(n[s]||lh),i),t);return{...e,...r}}const PC=({x:n,y:e,width:t,height:r,origin:i})=>!t||!r?{x:n,y:e}:i[0]<0||i[1]<0||i[0]>1||i[1]>1?{x:n,y:e}:{x:n-t*i[0],y:e-r*i[1]},DC=n=>({nodesDraggable:n.nodesDraggable,nodesConnectable:n.nodesConnectable,nodesFocusable:n.nodesFocusable,elementsSelectable:n.elementsSelectable,updateNodeDimensions:n.updateNodeDimensions,onError:n.onError}),Qb=n=>{const{nodesDraggable:e,nodesConnectable:t,nodesFocusable:r,elementsSelectable:i,updateNodeDimensions:s,onError:o}=tt(DC,Ct),a=CC(n.onlyRenderVisibleElements),c=D.useRef(),l=D.useMemo(()=>{if(typeof ResizeObserver>"u")return null;const u=new ResizeObserver(d=>{const h=d.map(f=>({id:f.target.getAttribute("data-id"),nodeElement:f.target,forceUpdate:!0}));s(h)});return c.current=u,u},[]);return D.useEffect(()=>()=>{c?.current?.disconnect()},[]),K.createElement("div",{className:"react-flow__nodes",style:If},a.map(u=>{let d=u.type||"default";n.nodeTypes[d]||(o?.("003",_r.error003(d)),d="default");const h=n.nodeTypes[d]||n.nodeTypes.default,f=!!(u.draggable||e&&typeof u.draggable>"u"),p=!!(u.selectable||i&&typeof u.selectable>"u"),g=!!(u.connectable||t&&typeof u.connectable>"u"),x=!!(u.focusable||r&&typeof u.focusable>"u"),m=n.nodeExtent?Ef(u.positionAbsolute,n.nodeExtent):u.positionAbsolute,y=m?.x??0,_=m?.y??0,v=PC({x:y,y:_,width:u.width??0,height:u.height??0,origin:n.nodeOrigin});return K.createElement(h,{key:u.id,id:u.id,className:u.className,style:u.style,type:d,data:u.data,sourcePosition:u.sourcePosition||he.Bottom,targetPosition:u.targetPosition||he.Top,hidden:u.hidden,xPos:y,yPos:_,xPosOrigin:v.x,yPosOrigin:v.y,selectNodesOnDrag:n.selectNodesOnDrag,onClick:n.onNodeClick,onMouseEnter:n.onNodeMouseEnter,onMouseMove:n.onNodeMouseMove,onMouseLeave:n.onNodeMouseLeave,onContextMenu:n.onNodeContextMenu,onDoubleClick:n.onNodeDoubleClick,selected:!!u.selected,isDraggable:f,isSelectable:p,isConnectable:g,isFocusable:x,resizeObserver:l,dragHandle:u.dragHandle,zIndex:u[rt]?.z??0,isParent:!!u[rt]?.isParent,noDragClassName:n.noDragClassName,noPanClassName:n.noPanClassName,initialized:!!u.width&&!!u.height,rfId:n.rfId,disableKeyboardA11y:n.disableKeyboardA11y,ariaLabel:u.ariaLabel,hasHandleBounds:!!u[rt]?.handleBounds})}))};Qb.displayName="NodeRenderer";var BC=D.memo(Qb);const FC=(n,e,t)=>t===he.Left?n-e:t===he.Right?n+e:n,kC=(n,e,t)=>t===he.Top?n-e:t===he.Bottom?n+e:n,Ag="react-flow__edgeupdater",Rg=({position:n,centerX:e,centerY:t,radius:r=10,onMouseDown:i,onMouseEnter:s,onMouseOut:o,type:a})=>K.createElement("circle",{onMouseDown:i,onMouseEnter:s,onMouseOut:o,className:It([Ag,`${Ag}-${a}`]),cx:FC(e,r,n),cy:kC(t,r,n),r,stroke:"transparent",fill:"transparent"}),IC=()=>!0;var zi=n=>{const e=({id:t,className:r,type:i,data:s,onClick:o,onEdgeDoubleClick:a,selected:c,animated:l,label:u,labelStyle:d,labelShowBg:h,labelBgStyle:f,labelBgPadding:p,labelBgBorderRadius:g,style:x,source:m,target:y,sourceX:_,sourceY:v,targetX:T,targetY:w,sourcePosition:N,targetPosition:E,elementsSelectable:A,hidden:B,sourceHandleId:R,targetHandleId:L,onContextMenu:F,onMouseEnter:S,onMouseMove:U,onMouseLeave:k,reconnectRadius:P,onReconnect:$,onReconnectStart:M,onReconnectEnd:W,markerEnd:G,markerStart:z,rfId:Z,ariaLabel:ee,isFocusable:O,isReconnectable:Y,pathOptions:te,interactionWidth:ae,disableKeyboardA11y:me})=>{const ge=D.useRef(null),[Se,et]=D.useState(!1),[ft,it]=D.useState(!1),je=xt(),yt=D.useMemo(()=>`url('#${ah(z,Z)}')`,[z,Z]),Ce=D.useMemo(()=>`url('#${ah(G,Z)}')`,[G,Z]);if(B)return null;const ue=St=>{const{edges:Rn,addSelectedEdges:Jr,unselectNodesAndEdges:ei,multiSelectionActive:Ui}=je.getState(),Cn=Rn.find(ti=>ti.id===t);Cn&&(A&&(je.setState({nodesSelectionActive:!1}),Cn.selected&&Ui?(ei({nodes:[],edges:[Cn]}),ge.current?.blur()):Jr([t])),o&&o(St,Cn))},qt=Ks(t,je.getState,a),Kr=Ks(t,je.getState,F),Hs=Ks(t,je.getState,S),Fi=Ks(t,je.getState,U),ki=Ks(t,je.getState,k),Qn=(St,Rn)=>{if(St.button!==0)return;const{edges:Jr,isValidConnection:ei}=je.getState(),Ui=Rn?y:m,Cn=(Rn?L:R)||null,ti=Rn?"target":"source",Jl=ei||IC,eu=Rn,qs=Jr.find(ni=>ni.id===t);it(!0),M?.(St,qs,ti);const tu=ni=>{it(!1),W?.(ni,qs,ti)};Mb({event:St,handleId:Cn,nodeId:Ui,onConnect:ni=>$?.(qs,ni),isTarget:eu,getState:je.getState,setState:je.setState,isValidConnection:Jl,edgeUpdaterType:ti,onReconnectEnd:tu})},Ii=St=>Qn(St,!0),Qr=St=>Qn(St,!1),Zr=()=>et(!0),Li=()=>et(!1),Oi=!A&&!o,Ws=St=>{if(!me&&xb.includes(St.key)&&A){const{unselectNodesAndEdges:Rn,addSelectedEdges:Jr,edges:ei}=je.getState();St.key==="Escape"?(ge.current?.blur(),Rn({edges:[ei.find(Cn=>Cn.id===t)]})):Jr([t])}};return K.createElement("g",{className:It(["react-flow__edge",`react-flow__edge-${i}`,r,{selected:c,animated:l,inactive:Oi,updating:Se}]),onClick:ue,onDoubleClick:qt,onContextMenu:Kr,onMouseEnter:Hs,onMouseMove:Fi,onMouseLeave:ki,onKeyDown:O?Ws:void 0,tabIndex:O?0:void 0,role:O?"button":"img","data-testid":`rf__edge-${t}`,"aria-label":ee===null?void 0:ee||`Edge from ${m} to ${y}`,"aria-describedby":O?`${Ub}-${Z}`:void 0,ref:ge},!ft&&K.createElement(n,{id:t,source:m,target:y,selected:c,animated:l,label:u,labelStyle:d,labelShowBg:h,labelBgStyle:f,labelBgPadding:p,labelBgBorderRadius:g,data:s,style:x,sourceX:_,sourceY:v,targetX:T,targetY:w,sourcePosition:N,targetPosition:E,sourceHandleId:R,targetHandleId:L,markerStart:yt,markerEnd:Ce,pathOptions:te,interactionWidth:ae}),Y&&K.createElement(K.Fragment,null,(Y==="source"||Y===!0)&&K.createElement(Rg,{position:N,centerX:_,centerY:v,radius:P,onMouseDown:Ii,onMouseEnter:Zr,onMouseOut:Li,type:"source"}),(Y==="target"||Y===!0)&&K.createElement(Rg,{position:E,centerX:T,centerY:w,radius:P,onMouseDown:Qr,onMouseEnter:Zr,onMouseOut:Li,type:"target"})))};return e.displayName="EdgeWrapper",D.memo(e)};function LC(n){const e={default:zi(n.default||Yc),straight:zi(n.bezier||Mf),step:zi(n.step||Cf),smoothstep:zi(n.step||Rl),simplebezier:zi(n.simplebezier||Rf)},t={},r=Object.keys(n).filter(i=>!["default","bezier"].includes(i)).reduce((i,s)=>(i[s]=zi(n[s]||Yc),i),t);return{...e,...r}}function Cg(n,e,t=null){const r=(t?.x||0)+e.x,i=(t?.y||0)+e.y,s=t?.width||e.width,o=t?.height||e.height;switch(n){case he.Top:return{x:r+s/2,y:i};case he.Right:return{x:r+s,y:i+o/2};case he.Bottom:return{x:r+s/2,y:i+o};case he.Left:return{x:r,y:i+o/2}}}function Mg(n,e){return n?n.length===1||!e?n[0]:e&&n.find(t=>t.id===e)||null:null}const OC=(n,e,t,r,i,s)=>{const o=Cg(t,n,e),a=Cg(s,r,i);return{sourceX:o.x,sourceY:o.y,targetX:a.x,targetY:a.y}};function UC({sourcePos:n,targetPos:e,sourceWidth:t,sourceHeight:r,targetWidth:i,targetHeight:s,width:o,height:a,transform:c}){const l={x:Math.min(n.x,e.x),y:Math.min(n.y,e.y),x2:Math.max(n.x+t,e.x+i),y2:Math.max(n.y+r,e.y+s)};l.x===l.x2&&(l.x2+=1),l.y===l.y2&&(l.y2+=1);const u=Af({x:(0-c[0])/c[2],y:(0-c[1])/c[2],width:o/c[2],height:a/c[2]}),d=Math.max(0,Math.min(u.x2,l.x2)-Math.max(u.x,l.x)),h=Math.max(0,Math.min(u.y2,l.y2)-Math.max(u.y,l.y));return Math.ceil(d*h)>0}function Pg(n){const e=n?.[rt]?.handleBounds||null,t=e&&n?.width&&n?.height&&typeof n?.positionAbsolute?.x<"u"&&typeof n?.positionAbsolute?.y<"u";return[{x:n?.positionAbsolute?.x||0,y:n?.positionAbsolute?.y||0,width:n?.width||0,height:n?.height||0},e,!!t]}const GC=[{level:0,isMaxLevel:!0,edges:[]}];function $C(n,e,t=!1){let r=-1;const i=n.reduce((o,a)=>{const c=sn(a.zIndex);let l=c?a.zIndex:0;if(t){const u=e.get(a.target),d=e.get(a.source),h=a.selected||u?.selected||d?.selected,f=Math.max(d?.[rt]?.z||0,u?.[rt]?.z||0,1e3);l=(c?a.zIndex:0)+(h?f:0)}return o[l]?o[l].push(a):o[l]=[a],r=l>r?l:r,o},{}),s=Object.entries(i).map(([o,a])=>{const c=+o;return{edges:a,level:c,isMaxLevel:c===r}});return s.length===0?GC:s}function VC(n,e,t){const r=tt(D.useCallback(i=>n?i.edges.filter(s=>{const o=e.get(s.source),a=e.get(s.target);return o?.width&&o?.height&&a?.width&&a?.height&&UC({sourcePos:o.positionAbsolute||{x:0,y:0},targetPos:a.positionAbsolute||{x:0,y:0},sourceWidth:o.width,sourceHeight:o.height,targetWidth:a.width,targetHeight:a.height,width:i.width,height:i.height,transform:i.transform})}):i.edges,[n,e]));return $C(r,e,t)}const zC=({color:n="none",strokeWidth:e=1})=>K.createElement("polyline",{style:{stroke:n,strokeWidth:e},strokeLinecap:"round",strokeLinejoin:"round",fill:"none",points:"-5,-4 0,0 -5,4"}),jC=({color:n="none",strokeWidth:e=1})=>K.createElement("polyline",{style:{stroke:n,fill:n,strokeWidth:e},strokeLinecap:"round",strokeLinejoin:"round",points:"-5,-4 0,0 -5,4 -5,-4"}),Dg={[Xc.Arrow]:zC,[Xc.ArrowClosed]:jC};function HC(n){const e=xt();return D.useMemo(()=>Object.prototype.hasOwnProperty.call(Dg,n)?Dg[n]:(e.getState().onError?.("009",_r.error009(n)),null),[n])}const WC=({id:n,type:e,color:t,width:r=12.5,height:i=12.5,markerUnits:s="strokeWidth",strokeWidth:o,orient:a="auto-start-reverse"})=>{const c=HC(e);return c?K.createElement("marker",{className:"react-flow__arrowhead",id:n,markerWidth:`${r}`,markerHeight:`${i}`,viewBox:"-10 -10 20 20",markerUnits:s,orient:a,refX:"0",refY:"0"},K.createElement(c,{color:t,strokeWidth:o})):null},qC=({defaultColor:n,rfId:e})=>t=>{const r=[];return t.edges.reduce((i,s)=>([s.markerStart,s.markerEnd].forEach(o=>{if(o&&typeof o=="object"){const a=ah(o,e);r.includes(a)||(i.push({id:a,color:o.color||n,...o}),r.push(a))}}),i),[]).sort((i,s)=>i.id.localeCompare(s.id))},Zb=({defaultColor:n,rfId:e})=>{const t=tt(D.useCallback(qC({defaultColor:n,rfId:e}),[n,e]),(r,i)=>!(r.length!==i.length||r.some((s,o)=>s.id!==i[o].id)));return K.createElement("defs",null,t.map(r=>K.createElement(WC,{id:r.id,key:r.id,type:r.type,color:r.color,width:r.width,height:r.height,markerUnits:r.markerUnits,strokeWidth:r.strokeWidth,orient:r.orient})))};Zb.displayName="MarkerDefinitions";var XC=D.memo(Zb);const YC=n=>({nodesConnectable:n.nodesConnectable,edgesFocusable:n.edgesFocusable,edgesUpdatable:n.edgesUpdatable,elementsSelectable:n.elementsSelectable,width:n.width,height:n.height,connectionMode:n.connectionMode,nodeInternals:n.nodeInternals,onError:n.onError}),Jb=({defaultMarkerColor:n,onlyRenderVisibleElements:e,elevateEdgesOnSelect:t,rfId:r,edgeTypes:i,noPanClassName:s,onEdgeContextMenu:o,onEdgeMouseEnter:a,onEdgeMouseMove:c,onEdgeMouseLeave:l,onEdgeClick:u,onEdgeDoubleClick:d,onReconnect:h,onReconnectStart:f,onReconnectEnd:p,reconnectRadius:g,children:x,disableKeyboardA11y:m})=>{const{edgesFocusable:y,edgesUpdatable:_,elementsSelectable:v,width:T,height:w,connectionMode:N,nodeInternals:E,onError:A}=tt(YC,Ct),B=VC(e,E,t);return T?K.createElement(K.Fragment,null,B.map(({level:R,edges:L,isMaxLevel:F})=>K.createElement("svg",{key:R,style:{zIndex:R},width:T,height:w,className:"react-flow__edges react-flow__container"},F&&K.createElement(XC,{defaultColor:n,rfId:r}),K.createElement("g",null,L.map(S=>{const[U,k,P]=Pg(E.get(S.source)),[$,M,W]=Pg(E.get(S.target));if(!P||!W)return null;let G=S.type||"default";i[G]||(A?.("011",_r.error011(G)),G="default");const z=i[G]||i.default,Z=N===Mi.Strict?M.target:(M.target??[]).concat(M.source??[]),ee=Mg(k.source,S.sourceHandle),O=Mg(Z,S.targetHandle),Y=ee?.position||he.Bottom,te=O?.position||he.Top,ae=!!(S.focusable||y&&typeof S.focusable>"u"),me=S.reconnectable||S.updatable,ge=typeof h<"u"&&(me||_&&typeof me>"u");if(!ee||!O)return A?.("008",_r.error008(ee,S)),null;const{sourceX:Se,sourceY:et,targetX:ft,targetY:it}=OC(U,ee,Y,$,O,te);return K.createElement(z,{key:S.id,id:S.id,className:It([S.className,s]),type:G,data:S.data,selected:!!S.selected,animated:!!S.animated,hidden:!!S.hidden,label:S.label,labelStyle:S.labelStyle,labelShowBg:S.labelShowBg,labelBgStyle:S.labelBgStyle,labelBgPadding:S.labelBgPadding,labelBgBorderRadius:S.labelBgBorderRadius,style:S.style,source:S.source,target:S.target,sourceHandleId:S.sourceHandle,targetHandleId:S.targetHandle,markerEnd:S.markerEnd,markerStart:S.markerStart,sourceX:Se,sourceY:et,targetX:ft,targetY:it,sourcePosition:Y,targetPosition:te,elementsSelectable:v,onContextMenu:o,onMouseEnter:a,onMouseMove:c,onMouseLeave:l,onClick:u,onEdgeDoubleClick:d,onReconnect:h,onReconnectStart:f,onReconnectEnd:p,reconnectRadius:g,rfId:r,ariaLabel:S.ariaLabel,isFocusable:ae,isReconnectable:ge,pathOptions:"pathOptions"in S?S.pathOptions:void 0,interactionWidth:S.interactionWidth,disableKeyboardA11y:m})})))),x):null};Jb.displayName="EdgeRenderer";var KC=D.memo(Jb);const QC=n=>`translate(${n.transform[0]}px,${n.transform[1]}px) scale(${n.transform[2]})`;function ZC({children:n}){const e=tt(QC);return K.createElement("div",{className:"react-flow__viewport react-flow__container",style:{transform:e}},n)}function JC(n){const e=kf(),t=D.useRef(!1);D.useEffect(()=>{!t.current&&e.viewportInitialized&&n&&(setTimeout(()=>n(e),1),t.current=!0)},[n,e.viewportInitialized])}const e3={[he.Left]:he.Right,[he.Right]:he.Left,[he.Top]:he.Bottom,[he.Bottom]:he.Top},e_=({nodeId:n,handleType:e,style:t,type:r=Pr.Bezier,CustomComponent:i,connectionStatus:s})=>{const{fromNode:o,handleId:a,toX:c,toY:l,connectionMode:u}=tt(D.useCallback(w=>({fromNode:w.nodeInternals.get(n),handleId:w.connectionHandleId,toX:(w.connectionPosition.x-w.transform[0])/w.transform[2],toY:(w.connectionPosition.y-w.transform[1])/w.transform[2],connectionMode:w.connectionMode}),[n]),Ct),d=o?.[rt]?.handleBounds;let h=d?.[e];if(u===Mi.Loose&&(h=h||d?.[e==="source"?"target":"source"]),!o||!h)return null;const f=a?h.find(w=>w.id===a):h[0],p=f?f.x+f.width/2:(o.width??0)/2,g=f?f.y+f.height/2:o.height??0,x=(o.positionAbsolute?.x??0)+p,m=(o.positionAbsolute?.y??0)+g,y=f?.position,_=y?e3[y]:null;if(!y||!_)return null;if(i)return K.createElement(i,{connectionLineType:r,connectionLineStyle:t,fromNode:o,fromHandle:f,fromX:x,fromY:m,toX:c,toY:l,fromPosition:y,toPosition:_,connectionStatus:s});let v="";const T={sourceX:x,sourceY:m,sourcePosition:y,targetX:c,targetY:l,targetPosition:_};return r===Pr.Bezier?[v]=Tb(T):r===Pr.Step?[v]=oh({...T,borderRadius:0}):r===Pr.SmoothStep?[v]=oh(T):r===Pr.SimpleBezier?[v]=vb(T):v=`M${x},${m} ${c},${l}`,K.createElement("path",{d:v,fill:"none",className:"react-flow__connection-path",style:t})};e_.displayName="ConnectionLine";const t3=n=>({nodeId:n.connectionNodeId,handleType:n.connectionHandleType,nodesConnectable:n.nodesConnectable,connectionStatus:n.connectionStatus,width:n.width,height:n.height});function n3({containerStyle:n,style:e,type:t,component:r}){const{nodeId:i,handleType:s,nodesConnectable:o,width:a,height:c,connectionStatus:l}=tt(t3,Ct);return!(i&&s&&a&&o)?null:K.createElement("svg",{style:n,width:a,height:c,className:"react-flow__edges react-flow__connectionline react-flow__container"},K.createElement("g",{className:It(["react-flow__connection",l])},K.createElement(e_,{nodeId:i,handleType:s,style:e,type:t,CustomComponent:r,connectionStatus:l})))}function Bg(n,e){return D.useRef(null),xt(),D.useMemo(()=>e(n),[n])}const t_=({nodeTypes:n,edgeTypes:e,onMove:t,onMoveStart:r,onMoveEnd:i,onInit:s,onNodeClick:o,onEdgeClick:a,onNodeDoubleClick:c,onEdgeDoubleClick:l,onNodeMouseEnter:u,onNodeMouseMove:d,onNodeMouseLeave:h,onNodeContextMenu:f,onSelectionContextMenu:p,onSelectionStart:g,onSelectionEnd:x,connectionLineType:m,connectionLineStyle:y,connectionLineComponent:_,connectionLineContainerStyle:v,selectionKeyCode:T,selectionOnDrag:w,selectionMode:N,multiSelectionKeyCode:E,panActivationKeyCode:A,zoomActivationKeyCode:B,deleteKeyCode:R,onlyRenderVisibleElements:L,elementsSelectable:F,selectNodesOnDrag:S,defaultViewport:U,translateExtent:k,minZoom:P,maxZoom:$,preventScrolling:M,defaultMarkerColor:W,zoomOnScroll:G,zoomOnPinch:z,panOnScroll:Z,panOnScrollSpeed:ee,panOnScrollMode:O,zoomOnDoubleClick:Y,panOnDrag:te,onPaneClick:ae,onPaneMouseEnter:me,onPaneMouseMove:ge,onPaneMouseLeave:Se,onPaneScroll:et,onPaneContextMenu:ft,onEdgeContextMenu:it,onEdgeMouseEnter:je,onEdgeMouseMove:yt,onEdgeMouseLeave:Ce,onReconnect:ue,onReconnectStart:qt,onReconnectEnd:Kr,reconnectRadius:Hs,noDragClassName:Fi,noWheelClassName:ki,noPanClassName:Qn,elevateEdgesOnSelect:Ii,disableKeyboardA11y:Qr,nodeOrigin:Zr,nodeExtent:Li,rfId:Oi})=>{const Ws=Bg(n,MC),St=Bg(e,LC);return JC(s),K.createElement(RC,{onPaneClick:ae,onPaneMouseEnter:me,onPaneMouseMove:ge,onPaneMouseLeave:Se,onPaneContextMenu:ft,onPaneScroll:et,deleteKeyCode:R,selectionKeyCode:T,selectionOnDrag:w,selectionMode:N,onSelectionStart:g,onSelectionEnd:x,multiSelectionKeyCode:E,panActivationKeyCode:A,zoomActivationKeyCode:B,elementsSelectable:F,onMove:t,onMoveStart:r,onMoveEnd:i,zoomOnScroll:G,zoomOnPinch:z,zoomOnDoubleClick:Y,panOnScroll:Z,panOnScrollSpeed:ee,panOnScrollMode:O,panOnDrag:te,defaultViewport:U,translateExtent:k,minZoom:P,maxZoom:$,onSelectionContextMenu:p,preventScrolling:M,noDragClassName:Fi,noWheelClassName:ki,noPanClassName:Qn,disableKeyboardA11y:Qr},K.createElement(ZC,null,K.createElement(KC,{edgeTypes:St,onEdgeClick:a,onEdgeDoubleClick:l,onlyRenderVisibleElements:L,onEdgeContextMenu:it,onEdgeMouseEnter:je,onEdgeMouseMove:yt,onEdgeMouseLeave:Ce,onReconnect:ue,onReconnectStart:qt,onReconnectEnd:Kr,reconnectRadius:Hs,defaultMarkerColor:W,noPanClassName:Qn,elevateEdgesOnSelect:!!Ii,disableKeyboardA11y:Qr,rfId:Oi},K.createElement(n3,{style:y,type:m,component:_,containerStyle:v})),K.createElement("div",{className:"react-flow__edgelabel-renderer"}),K.createElement(BC,{nodeTypes:Ws,onNodeClick:o,onNodeDoubleClick:c,onNodeMouseEnter:u,onNodeMouseMove:d,onNodeMouseLeave:h,onNodeContextMenu:f,selectNodesOnDrag:S,onlyRenderVisibleElements:L,noPanClassName:Qn,noDragClassName:Fi,disableKeyboardA11y:Qr,nodeOrigin:Zr,nodeExtent:Li,rfId:Oi})))};t_.displayName="GraphView";var r3=D.memo(t_);const dh=[[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY]],Sr={rfId:"1",width:0,height:0,transform:[0,0,1],nodeInternals:new Map,edges:[],onNodesChange:null,onEdgesChange:null,hasDefaultNodes:!1,hasDefaultEdges:!1,d3Zoom:null,d3Selection:null,d3ZoomHandler:void 0,minZoom:.5,maxZoom:2,translateExtent:dh,nodeExtent:dh,nodesSelectionActive:!1,userSelectionActive:!1,userSelectionRect:null,connectionNodeId:null,connectionHandleId:null,connectionHandleType:"source",connectionPosition:{x:0,y:0},connectionStatus:null,connectionMode:Mi.Strict,domNode:null,paneDragging:!1,noPanClassName:"nopan",nodeOrigin:[0,0],nodeDragThreshold:0,snapGrid:[15,15],snapToGrid:!1,nodesDraggable:!0,nodesConnectable:!0,nodesFocusable:!0,edgesFocusable:!0,edgesUpdatable:!0,elementsSelectable:!0,elevateNodesOnSelect:!0,fitViewOnInit:!1,fitViewOnInitDone:!1,fitViewOnInitOptions:void 0,onSelectionChange:[],multiSelectionActive:!1,connectionStartHandle:null,connectionEndHandle:null,connectionClickStartHandle:null,connectOnClick:!0,ariaLiveMessage:"",autoPanOnConnect:!0,autoPanOnNodeDrag:!0,connectionRadius:20,onError:DR,isValidConnection:void 0},i3=()=>VN((n,e)=>({...Sr,setNodes:t=>{const{nodeInternals:r,nodeOrigin:i,elevateNodesOnSelect:s}=e();n({nodeInternals:cu(t,r,i,s)})},getNodes:()=>Array.from(e().nodeInternals.values()),setEdges:t=>{const{defaultEdgeOptions:r={}}=e();n({edges:t.map(i=>({...r,...i}))})},setDefaultNodesAndEdges:(t,r)=>{const i=typeof t<"u",s=typeof r<"u",o=i?cu(t,new Map,e().nodeOrigin,e().elevateNodesOnSelect):new Map;n({nodeInternals:o,edges:s?r:[],hasDefaultNodes:i,hasDefaultEdges:s})},updateNodeDimensions:t=>{const{onNodesChange:r,nodeInternals:i,fitViewOnInit:s,fitViewOnInitDone:o,fitViewOnInitOptions:a,domNode:c,nodeOrigin:l}=e(),u=c?.querySelector(".react-flow__viewport");if(!u)return;const d=window.getComputedStyle(u),{m22:h}=new window.DOMMatrixReadOnly(d.transform),f=t.reduce((g,x)=>{const m=i.get(x.id);if(m?.hidden)i.set(m.id,{...m,[rt]:{...m[rt],handleBounds:void 0}});else if(m){const y=Nf(x.nodeElement);!!(y.width&&y.height&&(m.width!==y.width||m.height!==y.height||x.forceUpdate))&&(i.set(m.id,{...m,[rt]:{...m[rt],handleBounds:{source:Eg(".source",x.nodeElement,h,l),target:Eg(".target",x.nodeElement,h,l)}},...y}),g.push({id:m.id,type:"dimensions",dimensions:y}))}return g},[]);$b(i,l);const p=o||s&&!o&&Vb(e,{initial:!0,...a});n({nodeInternals:new Map(i),fitViewOnInitDone:p}),f?.length>0&&r?.(f)},updateNodePositions:(t,r=!0,i=!1)=>{const{triggerNodeChanges:s}=e(),o=t.map(a=>{const c={id:a.id,type:"position",dragging:i};return r&&(c.positionAbsolute=a.positionAbsolute,c.position=a.position),c});s(o)},triggerNodeChanges:t=>{const{onNodesChange:r,nodeInternals:i,hasDefaultNodes:s,nodeOrigin:o,getNodes:a,elevateNodesOnSelect:c}=e();if(t?.length){if(s){const l=jb(t,a()),u=cu(l,i,o,c);n({nodeInternals:u})}r?.(t)}},addSelectedNodes:t=>{const{multiSelectionActive:r,edges:i,getNodes:s}=e();let o,a=null;r?o=t.map(c=>Cr(c,!0)):(o=ss(s(),t),a=ss(i,[])),Aa({changedNodes:o,changedEdges:a,get:e,set:n})},addSelectedEdges:t=>{const{multiSelectionActive:r,edges:i,getNodes:s}=e();let o,a=null;r?o=t.map(c=>Cr(c,!0)):(o=ss(i,t),a=ss(s(),[])),Aa({changedNodes:a,changedEdges:o,get:e,set:n})},unselectNodesAndEdges:({nodes:t,edges:r}={})=>{const{edges:i,getNodes:s}=e(),o=t||s(),a=r||i,c=o.map(u=>(u.selected=!1,Cr(u.id,!1))),l=a.map(u=>Cr(u.id,!1));Aa({changedNodes:c,changedEdges:l,get:e,set:n})},setMinZoom:t=>{const{d3Zoom:r,maxZoom:i}=e();r?.scaleExtent([t,i]),n({minZoom:t})},setMaxZoom:t=>{const{d3Zoom:r,minZoom:i}=e();r?.scaleExtent([i,t]),n({maxZoom:t})},setTranslateExtent:t=>{e().d3Zoom?.translateExtent(t),n({translateExtent:t})},resetSelectedElements:()=>{const{edges:t,getNodes:r}=e(),s=r().filter(a=>a.selected).map(a=>Cr(a.id,!1)),o=t.filter(a=>a.selected).map(a=>Cr(a.id,!1));Aa({changedNodes:s,changedEdges:o,get:e,set:n})},setNodeExtent:t=>{const{nodeInternals:r}=e();r.forEach(i=>{i.positionAbsolute=Ef(i.position,t)}),n({nodeExtent:t,nodeInternals:new Map(r)})},panBy:t=>{const{transform:r,width:i,height:s,d3Zoom:o,d3Selection:a,translateExtent:c}=e();if(!o||!a||!t.x&&!t.y)return!1;const l=Gr.translate(r[0]+t.x,r[1]+t.y).scale(r[2]),u=[[0,0],[i,s]],d=o?.constrain()(l,u,c);return o.transform(a,d),r[0]!==d.x||r[1]!==d.y||r[2]!==d.k},cancelConnection:()=>n({connectionNodeId:Sr.connectionNodeId,connectionHandleId:Sr.connectionHandleId,connectionHandleType:Sr.connectionHandleType,connectionStatus:Sr.connectionStatus,connectionStartHandle:Sr.connectionStartHandle,connectionEndHandle:Sr.connectionEndHandle}),reset:()=>n({...Sr})}),Object.is),n_=({children:n})=>{const e=D.useRef(null);return e.current||(e.current=i3()),K.createElement(SR,{value:e.current},n)};n_.displayName="ReactFlowProvider";const r_=({children:n})=>D.useContext(Al)?K.createElement(K.Fragment,null,n):K.createElement(n_,null,n);r_.displayName="ReactFlowWrapper";const s3={input:Fb,default:lh,output:Ib,group:Ff},o3={default:Yc,straight:Mf,step:Cf,smoothstep:Rl,simplebezier:Rf},a3=[0,0],c3=[15,15],l3={x:0,y:0,zoom:1},u3={width:"100%",height:"100%",overflow:"hidden",position:"relative",zIndex:0},i_=D.forwardRef(({nodes:n,edges:e,defaultNodes:t,defaultEdges:r,className:i,nodeTypes:s=s3,edgeTypes:o=o3,onNodeClick:a,onEdgeClick:c,onInit:l,onMove:u,onMoveStart:d,onMoveEnd:h,onConnect:f,onConnectStart:p,onConnectEnd:g,onClickConnectStart:x,onClickConnectEnd:m,onNodeMouseEnter:y,onNodeMouseMove:_,onNodeMouseLeave:v,onNodeContextMenu:T,onNodeDoubleClick:w,onNodeDragStart:N,onNodeDrag:E,onNodeDragStop:A,onNodesDelete:B,onEdgesDelete:R,onSelectionChange:L,onSelectionDragStart:F,onSelectionDrag:S,onSelectionDragStop:U,onSelectionContextMenu:k,onSelectionStart:P,onSelectionEnd:$,connectionMode:M=Mi.Strict,connectionLineType:W=Pr.Bezier,connectionLineStyle:G,connectionLineComponent:z,connectionLineContainerStyle:Z,deleteKeyCode:ee="Backspace",selectionKeyCode:O="Shift",selectionOnDrag:Y=!1,selectionMode:te=Xo.Full,panActivationKeyCode:ae="Space",multiSelectionKeyCode:me=qc()?"Meta":"Control",zoomActivationKeyCode:ge=qc()?"Meta":"Control",snapToGrid:Se=!1,snapGrid:et=c3,onlyRenderVisibleElements:ft=!1,selectNodesOnDrag:it=!0,nodesDraggable:je,nodesConnectable:yt,nodesFocusable:Ce,nodeOrigin:ue=a3,edgesFocusable:qt,edgesUpdatable:Kr,elementsSelectable:Hs,defaultViewport:Fi=l3,minZoom:ki=.5,maxZoom:Qn=2,translateExtent:Ii=dh,preventScrolling:Qr=!0,nodeExtent:Zr,defaultMarkerColor:Li="#b1b1b7",zoomOnScroll:Oi=!0,zoomOnPinch:Ws=!0,panOnScroll:St=!1,panOnScrollSpeed:Rn=.5,panOnScrollMode:Jr=bi.Free,zoomOnDoubleClick:ei=!0,panOnDrag:Ui=!0,onPaneClick:Cn,onPaneMouseEnter:ti,onPaneMouseMove:Jl,onPaneMouseLeave:eu,onPaneScroll:qs,onPaneContextMenu:tu,children:Rp,onEdgeContextMenu:ni,onEdgeDoubleClick:R1,onEdgeMouseEnter:C1,onEdgeMouseMove:M1,onEdgeMouseLeave:P1,onEdgeUpdate:D1,onEdgeUpdateStart:B1,onEdgeUpdateEnd:F1,onReconnect:k1,onReconnectStart:I1,onReconnectEnd:L1,reconnectRadius:O1=10,edgeUpdaterRadius:U1=10,onNodesChange:G1,onEdgesChange:$1,noDragClassName:V1="nodrag",noWheelClassName:z1="nowheel",noPanClassName:Cp="nopan",fitView:j1=!1,fitViewOptions:H1,connectOnClick:W1=!0,attributionPosition:q1,proOptions:X1,defaultEdgeOptions:Y1,elevateNodesOnSelect:K1=!0,elevateEdgesOnSelect:Q1=!1,disableKeyboardA11y:Mp=!1,autoPanOnConnect:Z1=!0,autoPanOnNodeDrag:J1=!0,connectionRadius:ew=20,isValidConnection:tw,onError:nw,style:rw,id:Pp,nodeDragThreshold:iw,...sw},ow)=>{const nu=Pp||"1";return K.createElement("div",{...sw,style:{...rw,...u3},ref:ow,className:It(["react-flow",i]),"data-testid":"rf__wrapper",id:Pp},K.createElement(r_,null,K.createElement(r3,{onInit:l,onMove:u,onMoveStart:d,onMoveEnd:h,onNodeClick:a,onEdgeClick:c,onNodeMouseEnter:y,onNodeMouseMove:_,onNodeMouseLeave:v,onNodeContextMenu:T,onNodeDoubleClick:w,nodeTypes:s,edgeTypes:o,connectionLineType:W,connectionLineStyle:G,connectionLineComponent:z,connectionLineContainerStyle:Z,selectionKeyCode:O,selectionOnDrag:Y,selectionMode:te,deleteKeyCode:ee,multiSelectionKeyCode:me,panActivationKeyCode:ae,zoomActivationKeyCode:ge,onlyRenderVisibleElements:ft,selectNodesOnDrag:it,defaultViewport:Fi,translateExtent:Ii,minZoom:ki,maxZoom:Qn,preventScrolling:Qr,zoomOnScroll:Oi,zoomOnPinch:Ws,zoomOnDoubleClick:ei,panOnScroll:St,panOnScrollSpeed:Rn,panOnScrollMode:Jr,panOnDrag:Ui,onPaneClick:Cn,onPaneMouseEnter:ti,onPaneMouseMove:Jl,onPaneMouseLeave:eu,onPaneScroll:qs,onPaneContextMenu:tu,onSelectionContextMenu:k,onSelectionStart:P,onSelectionEnd:$,onEdgeContextMenu:ni,onEdgeDoubleClick:R1,onEdgeMouseEnter:C1,onEdgeMouseMove:M1,onEdgeMouseLeave:P1,onReconnect:k1??D1,onReconnectStart:I1??B1,onReconnectEnd:L1??F1,reconnectRadius:O1??U1,defaultMarkerColor:Li,noDragClassName:V1,noWheelClassName:z1,noPanClassName:Cp,elevateEdgesOnSelect:Q1,rfId:nu,disableKeyboardA11y:Mp,nodeOrigin:ue,nodeExtent:Zr}),K.createElement(eC,{nodes:n,edges:e,defaultNodes:t,defaultEdges:r,onConnect:f,onConnectStart:p,onConnectEnd:g,onClickConnectStart:x,onClickConnectEnd:m,nodesDraggable:je,nodesConnectable:yt,nodesFocusable:Ce,edgesFocusable:qt,edgesUpdatable:Kr,elementsSelectable:Hs,elevateNodesOnSelect:K1,minZoom:ki,maxZoom:Qn,nodeExtent:Zr,onNodesChange:G1,onEdgesChange:$1,snapToGrid:Se,snapGrid:et,connectionMode:M,translateExtent:Ii,connectOnClick:W1,defaultEdgeOptions:Y1,fitView:j1,fitViewOptions:H1,onNodesDelete:B,onEdgesDelete:R,onNodeDragStart:N,onNodeDrag:E,onNodeDragStop:A,onSelectionDrag:S,onSelectionDragStart:F,onSelectionDragStop:U,noPanClassName:Cp,nodeOrigin:ue,rfId:nu,autoPanOnConnect:Z1,autoPanOnNodeDrag:J1,onError:nw,connectionRadius:ew,isValidConnection:tw,nodeDragThreshold:iw}),K.createElement(ZR,{onSelectionChange:L}),Rp,K.createElement(ER,{proOptions:X1,position:q1}),K.createElement(sC,{rfId:nu,disableKeyboardA11y:Mp})))});i_.displayName="ReactFlow";function d3(){return K.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32"},K.createElement("path",{d:"M32 18.133H18.133V32h-4.266V18.133H0v-4.266h13.867V0h4.266v13.867H32z"}))}function h3(){return K.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 5"},K.createElement("path",{d:"M0 0h32v4.2H0z"}))}function f3(){return K.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 30"},K.createElement("path",{d:"M3.692 4.63c0-.53.4-.938.939-.938h5.215V0H4.708C2.13 0 0 2.054 0 4.63v5.216h3.692V4.631zM27.354 0h-5.2v3.692h5.17c.53 0 .984.4.984.939v5.215H32V4.631A4.624 4.624 0 0027.354 0zm.954 24.83c0 .532-.4.94-.939.94h-5.215v3.768h5.215c2.577 0 4.631-2.13 4.631-4.707v-5.139h-3.692v5.139zm-23.677.94c-.531 0-.939-.4-.939-.94v-5.138H0v5.139c0 2.577 2.13 4.707 4.708 4.707h5.138V25.77H4.631z"}))}function p3(){return K.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},K.createElement("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0 8 0 4.571 3.429 4.571 7.619v3.048H3.048A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047zm4.724-13.866H7.467V7.619c0-2.59 2.133-4.724 4.723-4.724 2.591 0 4.724 2.133 4.724 4.724v3.048z"}))}function g3(){return K.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},K.createElement("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0c-4.114 1.828-1.37 2.133.305 2.438 1.676.305 4.42 2.59 4.42 5.181v3.048H3.047A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047z"}))}const vo=({children:n,className:e,...t})=>K.createElement("button",{type:"button",className:It(["react-flow__controls-button",e]),...t},n);vo.displayName="ControlButton";const m3=n=>({isInteractive:n.nodesDraggable||n.nodesConnectable||n.elementsSelectable,minZoomReached:n.transform[2]<=n.minZoom,maxZoomReached:n.transform[2]>=n.maxZoom}),s_=({style:n,showZoom:e=!0,showFitView:t=!0,showInteractive:r=!0,fitViewOptions:i,onZoomIn:s,onZoomOut:o,onFitView:a,onInteractiveChange:c,className:l,children:u,position:d="bottom-left"})=>{const h=xt(),[f,p]=D.useState(!1),{isInteractive:g,minZoomReached:x,maxZoomReached:m}=tt(m3,Ct),{zoomIn:y,zoomOut:_,fitView:v}=kf();if(D.useEffect(()=>{p(!0)},[]),!f)return null;const T=()=>{y(),s?.()},w=()=>{_(),o?.()},N=()=>{v(i),a?.()},E=()=>{h.setState({nodesDraggable:!g,nodesConnectable:!g,elementsSelectable:!g}),c?.(!g)};return K.createElement(pb,{className:It(["react-flow__controls",l]),position:d,style:n,"data-testid":"rf__controls"},e&&K.createElement(K.Fragment,null,K.createElement(vo,{onClick:T,className:"react-flow__controls-zoomin",title:"zoom in","aria-label":"zoom in",disabled:m},K.createElement(d3,null)),K.createElement(vo,{onClick:w,className:"react-flow__controls-zoomout",title:"zoom out","aria-label":"zoom out",disabled:x},K.createElement(h3,null))),t&&K.createElement(vo,{className:"react-flow__controls-fitview",onClick:N,title:"fit view","aria-label":"fit view"},K.createElement(f3,null)),r&&K.createElement(vo,{className:"react-flow__controls-interactive",onClick:E,title:"toggle interactivity","aria-label":"toggle interactivity"},g?K.createElement(g3,null):K.createElement(p3,null)),u)};s_.displayName="Controls";var x3=D.memo(s_),Tn;(function(n){n.Lines="lines",n.Dots="dots",n.Cross="cross"})(Tn||(Tn={}));function y3({color:n,dimensions:e,lineWidth:t}){return K.createElement("path",{stroke:n,strokeWidth:t,d:`M${e[0]/2} 0 V${e[1]} M0 ${e[1]/2} H${e[0]}`})}function b3({color:n,radius:e}){return K.createElement("circle",{cx:e,cy:e,r:e,fill:n})}const _3={[Tn.Dots]:"#91919a",[Tn.Lines]:"#eee",[Tn.Cross]:"#e2e2e2"},v3={[Tn.Dots]:1,[Tn.Lines]:1,[Tn.Cross]:6},T3=n=>({transform:n.transform,patternId:`pattern-${n.rfId}`});function o_({id:n,variant:e=Tn.Dots,gap:t=20,size:r,lineWidth:i=1,offset:s=2,color:o,style:a,className:c}){const l=D.useRef(null),{transform:u,patternId:d}=tt(T3,Ct),h=o||_3[e],f=r||v3[e],p=e===Tn.Dots,g=e===Tn.Cross,x=Array.isArray(t)?t:[t,t],m=[x[0]*u[2]||1,x[1]*u[2]||1],y=f*u[2],_=g?[y,y]:m,v=p?[y/s,y/s]:[_[0]/s,_[1]/s];return K.createElement("svg",{className:It(["react-flow__background",c]),style:{...a,position:"absolute",width:"100%",height:"100%",top:0,left:0},ref:l,"data-testid":"rf__background"},K.createElement("pattern",{id:d+n,x:u[0]%m[0],y:u[1]%m[1],width:m[0],height:m[1],patternUnits:"userSpaceOnUse",patternTransform:`translate(-${v[0]},-${v[1]})`},p?K.createElement(b3,{color:h,radius:y/s}):K.createElement(y3,{dimensions:_,color:h,lineWidth:i})),K.createElement("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:`url(#${d+n})`}))}o_.displayName="Background";var w3=D.memo(o_);const S3=({data:n,type:e})=>{const r={source:"var(--hud-accent)",cache:"var(--hud-success)",llm:"var(--hud-accent-secondary)",sector:"#f59e0b"}[n.type]||"var(--hud-text)";return b.jsxs("div",{className:"px-4 py-2 rounded bg-black border border-[var(--hud-border)] shadow-[0_0_15px_rgba(0,0,0,0.5)] min-w-[150px]",children:[b.jsx(Ns,{type:"target",position:he.Top,className:"!bg-[var(--hud-text-dim)]"}),b.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[b.jsx("div",{className:"w-2 h-2 rounded-full",style:{backgroundColor:r}}),b.jsx("span",{className:"text-xs font-bold uppercase tracking-wider text-white",children:n.label})]}),b.jsx("div",{className:"text-[10px] font-mono text-[var(--hud-text-dim)]",children:n.details}),b.jsx(Ns,{type:"source",position:he.Bottom,className:"!bg-[var(--hud-text-dim)]"})]})},N3={cyber:S3};function E3(){const[n,e]=D.useState([]),[t,r]=D.useState([]),[i,s]=D.useState(!0),[o,a]=D.useState(1),[c,l]=D.useState({useCase:"",performance:"balanced"}),u=D.useCallback(g=>e(x=>jb(g,x)),[]),d=D.useCallback(g=>r(x=>bC(g,x)),[]),h=D.useCallback(g=>r(x=>wb(g,x)),[]),f=()=>{const g=[{id:"1",type:"cyber",position:{x:250,y:0},data:{label:"HTTP API",type:"source",details:"Ingress"}},{id:"2",type:"cyber",position:{x:250,y:100},data:{label:"L1 Cache",type:"cache",details:"Redis (In-Memory)"}},{id:"3",type:"cyber",position:{x:250,y:200},data:{label:"Semantic Router",type:"sector",details:"Healthcare Model"}},{id:"4",type:"cyber",position:{x:250,y:300},data:{label:"GPT-4o",type:"llm",details:"Fallback"}}],x=[{id:"e1-2",source:"1",target:"2",animated:!0,style:{stroke:"var(--hud-accent)"}},{id:"e2-3",source:"2",target:"3",animated:!0,style:{stroke:"var(--hud-accent)"}},{id:"e3-4",source:"3",target:"4",animated:!0,style:{stroke:"var(--hud-accent)"}}];e(g),r(x),s(!1)},p=async()=>{try{const g=localStorage.getItem("agentcache_token");if(!g){alert("Authentication required. Please log in.");return}const x={name:`Pipeline ${new Date().toLocaleTimeString()}`,sector:c.useCase||"custom",nodes:n,connections:t,description:`Generated via Wizard (${c.performance})`,complexity:{tier:"moderate",score:n.length*10},monthlyCost:0,features:["cache","llm"]},y=await(await fetch("/api/pipelines/create",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${g}`},body:JSON.stringify(x)})).json();if(y.success)alert(`Pipeline Saved! ID: ${y.pipeline.id}`);else throw new Error(y.error||"Unknown error")}catch(g){console.error("Save failed",g),alert(`Failed to save: ${g.message}`)}};return b.jsxs("div",{className:"h-[calc(100vh-8rem)] flex gap-6 relative",children:[b.jsx("div",{className:"w-64 flex flex-col gap-4",children:b.jsx(Le,{title:"Node Palette",icon:mN,className:"flex-1",children:b.jsx("div",{className:"space-y-2",children:["Source","Cache","LLM","Sector"].map(g=>b.jsx("div",{className:"p-3 rounded bg-[rgba(255,255,255,0.05)] border border-transparent hover:border-[var(--hud-accent)] cursor-grab active:cursor-grabbing transition-colors",children:b.jsxs("span",{className:"text-sm font-bold text-white",children:[g," Node"]})},g))})})}),b.jsxs("div",{className:"flex-1 rounded-lg border border-[var(--hud-border)] bg-black/50 overflow-hidden relative",children:[b.jsxs(i_,{nodes:n,edges:t,onNodesChange:u,onEdgesChange:d,onConnect:h,nodeTypes:N3,fitView:!0,children:[b.jsx(w3,{color:"#333",gap:20}),b.jsx(x3,{className:"!bg-black !border-[var(--hud-border)] !fill-white"})]}),b.jsxs("div",{className:"absolute top-4 right-4 flex gap-2",children:[b.jsxs("button",{onClick:()=>s(!0),className:"btn-cyber px-4 py-2 flex items-center gap-2 text-xs",children:[b.jsx(CN,{size:14})," Wizard"]}),b.jsxs("button",{onClick:p,className:"btn-cyber px-4 py-2 flex items-center gap-2 text-xs",children:[b.jsx(bN,{size:14})," Save"]}),b.jsxs("button",{className:"btn-cyber btn-cyber-primary px-4 py-2 flex items-center gap-2 text-xs",children:[b.jsx(pN,{size:14})," Deploy"]})]})]}),i&&b.jsx("div",{className:"absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm",children:b.jsxs(Le,{className:"w-[600px] max-h-[80vh] overflow-y-auto relative",children:[b.jsx("button",{onClick:()=>s(!1),className:"absolute top-4 right-4 text-[var(--hud-text-dim)] hover:text-white",children:b.jsx(BN,{size:20})}),b.jsxs("div",{className:"mb-6",children:[b.jsx("h2",{className:"text-xl font-bold text-[var(--hud-accent)] tracking-widest mb-1",children:"PIPELINE WIZARD"}),b.jsx("p",{className:"text-xs font-mono text-[var(--hud-text-dim)]",children:"CONFIGURE ORCHESTRATION PARAMETERS"})]}),o===1&&b.jsxs("div",{className:"space-y-4",children:[b.jsx("h3",{className:"text-sm font-bold text-white",children:"SELECT USE CASE"}),b.jsx("div",{className:"grid grid-cols-2 gap-4",children:[{id:"clinical",label:"Clinical Decision",icon:""},{id:"trading",label:"Trading Assistant",icon:""},{id:"legal",label:"Contract Review",icon:""},{id:"custom",label:"Custom",icon:""}].map(g=>b.jsxs("button",{onClick:()=>{l({...c,useCase:g.id}),a(2)},className:"p-4 rounded border border-[var(--hud-border)] hover:border-[var(--hud-accent)] hover:bg-[var(--hud-accent)]/10 text-left transition-all",children:[b.jsx("div",{className:"text-2xl mb-2",children:g.icon}),b.jsx("div",{className:"font-bold text-sm text-white",children:g.label})]},g.id))})]}),o===2&&b.jsxs("div",{className:"space-y-6",children:[b.jsx("h3",{className:"text-sm font-bold text-white",children:"OPTIMIZATION TARGET"}),b.jsx("div",{className:"space-y-3",children:[{id:"fast",label:"Low Latency",desc:"Minimize response time"},{id:"balanced",label:"Balanced",desc:"Good speed + cost savings"},{id:"cost",label:"Cost Optimized",desc:"Maximum savings"}].map(g=>b.jsxs("button",{onClick:()=>l({...c,performance:g.id}),className:`w-full p-4 rounded border text-left transition-all ${c.performance===g.id?"border-[var(--hud-accent)] bg-[var(--hud-accent)]/10":"border-[var(--hud-border)] hover:bg-[rgba(255,255,255,0.05)]"}`,children:[b.jsx("div",{className:"font-bold text-sm text-white",children:g.label}),b.jsx("div",{className:"text-xs text-[var(--hud-text-dim)]",children:g.desc})]},g.id))}),b.jsxs("div",{className:"flex justify-between pt-4 border-t border-[var(--hud-border)]",children:[b.jsx("button",{onClick:()=>a(1),className:"text-xs text-[var(--hud-text-dim)] hover:text-white",children:"BACK"}),b.jsx("button",{onClick:f,className:"btn-cyber btn-cyber-primary px-6 py-2 text-sm font-bold",children:"GENERATE"})]})]})]})})]})}function A3(n,e){var t=n==null?null:typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(t!=null){var r,i,s,o,a=[],c=!0,l=!1;try{if(s=(t=t.call(n)).next,e===0){if(Object(t)!==t)return;c=!1}else for(;!(c=(r=s.call(t)).done)&&(a.push(r.value),a.length!==e);c=!0);}catch(u){l=!0,i=u}finally{try{if(!c&&t.return!=null&&(o=t.return(),Object(o)!==o))return}finally{if(l)throw i}}return a}}function R3(n,e,t){return e=I3(e),e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function Fg(n,e){return P3(n)||A3(n,e)||a_(n,e)||F3()}function C3(n){return M3(n)||D3(n)||a_(n)||B3()}function M3(n){if(Array.isArray(n))return hh(n)}function P3(n){if(Array.isArray(n))return n}function D3(n){if(typeof Symbol<"u"&&n[Symbol.iterator]!=null||n["@@iterator"]!=null)return Array.from(n)}function a_(n,e){if(n){if(typeof n=="string")return hh(n,e);var t=Object.prototype.toString.call(n).slice(8,-1);if(t==="Object"&&n.constructor&&(t=n.constructor.name),t==="Map"||t==="Set")return Array.from(n);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return hh(n,e)}}function hh(n,e){(e==null||e>n.length)&&(e=n.length);for(var t=0,r=new Array(e);t<e;t++)r[t]=n[t];return r}function B3(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function F3(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function k3(n,e){if(typeof n!="object"||n===null)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var r=t.call(n,e);if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function I3(n){var e=k3(n,"string");return typeof e=="symbol"?e:String(e)}var L3=function(e,t){var r=new Set(t);return Object.assign.apply(Object,[{}].concat(C3(Object.entries(e).filter(function(i){var s=Fg(i,1),o=s[0];return!r.has(o)}).map(function(i){var s=Fg(i,2),o=s[0],a=s[1];return R3({},o,a)}))))};function fh(n,e){(e==null||e>n.length)&&(e=n.length);for(var t=0,r=Array(e);t<e;t++)r[t]=n[t];return r}function O3(n){if(Array.isArray(n))return n}function U3(n){if(Array.isArray(n))return fh(n)}function G3(n){if(typeof Symbol<"u"&&n[Symbol.iterator]!=null||n["@@iterator"]!=null)return Array.from(n)}function $3(n,e){var t=n==null?null:typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(t!=null){var r,i,s,o,a=[],c=!0,l=!1;try{if(s=(t=t.call(n)).next,e!==0)for(;!(c=(r=s.call(t)).done)&&(a.push(r.value),a.length!==e);c=!0);}catch(u){l=!0,i=u}finally{try{if(!c&&t.return!=null&&(o=t.return(),Object(o)!==o))return}finally{if(l)throw i}}return a}}function V3(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function z3(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function j3(n,e){return O3(n)||$3(n,e)||c_(n,e)||V3()}function kg(n){return U3(n)||G3(n)||c_(n)||z3()}function c_(n,e){if(n){if(typeof n=="string")return fh(n,e);var t={}.toString.call(n).slice(8,-1);return t==="Object"&&n.constructor&&(t=n.constructor.name),t==="Map"||t==="Set"?Array.from(n):t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?fh(n,e):void 0}}function H3(n){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},t=e.wrapperElementType,r=t===void 0?"div":t,i=e.nodeMapper,s=i===void 0?function(u){return u}:i,o=e.methodNames,a=o===void 0?[]:o,c=e.initPropNames,l=c===void 0?[]:c;return D.forwardRef(function(u,d){var h=D.useRef(),f=D.useMemo(function(){var x=Object.fromEntries(l.filter(function(m){return u.hasOwnProperty(m)}).map(function(m){return[m,u[m]]}));return n(x)},[]);Ig(function(){f(s(h.current))},D.useLayoutEffect),Ig(function(){return f._destructor instanceof Function?f._destructor:void 0});var p=D.useCallback(function(x){for(var m=arguments.length,y=new Array(m>1?m-1:0),_=1;_<m;_++)y[_-1]=arguments[_];return f[x]instanceof Function?f[x].apply(f,y):void 0},[f]),g=D.useRef({});return Object.keys(L3(u,[].concat(kg(a),kg(l)))).filter(function(x){return g.current[x]!==u[x]}).forEach(function(x){return p(x,u[x])}),g.current=u,D.useImperativeHandle(d,function(){return Object.fromEntries(a.map(function(x){return[x,function(){for(var m=arguments.length,y=new Array(m),_=0;_<m;_++)y[_]=arguments[_];return p.apply(void 0,[x].concat(y))}]}))},[p]),K.createElement(r,{ref:h})})}function Ig(n){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:D.useEffect,t=D.useRef(),r=D.useRef(!1),i=D.useRef(!1),s=D.useState(0),o=j3(s,2);o[0];var a=o[1];r.current&&(i.current=!0),e(function(){return r.current||(t.current=n(),r.current=!0),a(function(c){return c+1}),function(){i.current&&t.current&&t.current()}},[])}const ps=new xl,cr=new Te,l_=new le,hu=new Te,Tc=new Te,Kc=new le,ph=new le,u_=new En,d_=new le,h_=new le;let At=null,kn=null;const lr=[],Vr={NONE:-1,PAN:0,ROTATE:1};class W3 extends ml{constructor(e,t,r=null){super(t,r),this.objects=e,this.recursive=!0,this.transformGroup=!1,this.rotateSpeed=1,this.raycaster=new Vx,this.mouseButtons={LEFT:vt.PAN,MIDDLE:vt.PAN,RIGHT:vt.ROTATE},this.touches={ONE:dr.PAN},this._onPointerMove=q3.bind(this),this._onPointerDown=X3.bind(this),this._onPointerCancel=Y3.bind(this),this._onContextMenu=K3.bind(this),r!==null&&this.connect(r)}connect(e){super.connect(e),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointerup",this._onPointerCancel),this.domElement.addEventListener("pointerleave",this._onPointerCancel),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointerup",this._onPointerCancel),this.domElement.removeEventListener("pointerleave",this._onPointerCancel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.domElement.style.touchAction="auto",this.domElement.style.cursor=""}dispose(){this.disconnect()}_updatePointer(e){const t=this.domElement.getBoundingClientRect();cr.x=(e.clientX-t.left)/t.width*2-1,cr.y=-(e.clientY-t.top)/t.height*2+1}_updateState(e){let t;if(e.pointerType==="touch")t=this.touches.ONE;else switch(e.button){case 0:t=this.mouseButtons.LEFT;break;case 1:t=this.mouseButtons.MIDDLE;break;case 2:t=this.mouseButtons.RIGHT;break;default:t=null}switch(t){case vt.PAN:case dr.PAN:this.state=Vr.PAN;break;case vt.ROTATE:case dr.ROTATE:this.state=Vr.ROTATE;break;default:this.state=Vr.NONE}}}function q3(n){const e=this.object,t=this.domElement,r=this.raycaster;if(this.enabled!==!1){if(this._updatePointer(n),r.setFromCamera(cr,e),At)this.state===Vr.PAN?r.ray.intersectPlane(ps,Kc)&&(At.position.copy(Kc.sub(l_).applyMatrix4(u_)),this.dispatchEvent({type:"drag",object:At})):this.state===Vr.ROTATE&&(hu.subVectors(cr,Tc).multiplyScalar(this.rotateSpeed),At.rotateOnWorldAxis(d_,hu.x),At.rotateOnWorldAxis(h_.normalize(),-hu.y),this.dispatchEvent({type:"drag",object:At})),Tc.copy(cr);else if(n.pointerType==="mouse"||n.pointerType==="pen")if(lr.length=0,r.setFromCamera(cr,e),r.intersectObjects(this.objects,this.recursive,lr),lr.length>0){const i=lr[0].object;ps.setFromNormalAndCoplanarPoint(e.getWorldDirection(ps.normal),ph.setFromMatrixPosition(i.matrixWorld)),kn!==i&&kn!==null&&(this.dispatchEvent({type:"hoveroff",object:kn}),t.style.cursor="auto",kn=null),kn!==i&&(this.dispatchEvent({type:"hoveron",object:i}),t.style.cursor="pointer",kn=i)}else kn!==null&&(this.dispatchEvent({type:"hoveroff",object:kn}),t.style.cursor="auto",kn=null);Tc.copy(cr)}}function X3(n){const e=this.object,t=this.domElement,r=this.raycaster;this.enabled!==!1&&(this._updatePointer(n),this._updateState(n),lr.length=0,r.setFromCamera(cr,e),r.intersectObjects(this.objects,this.recursive,lr),lr.length>0&&(this.transformGroup===!0?At=f_(lr[0].object):At=lr[0].object,ps.setFromNormalAndCoplanarPoint(e.getWorldDirection(ps.normal),ph.setFromMatrixPosition(At.matrixWorld)),r.ray.intersectPlane(ps,Kc)&&(this.state===Vr.PAN?(u_.copy(At.parent.matrixWorld).invert(),l_.copy(Kc).sub(ph.setFromMatrixPosition(At.matrixWorld)),t.style.cursor="move",this.dispatchEvent({type:"dragstart",object:At})):this.state===Vr.ROTATE&&(d_.set(0,1,0).applyQuaternion(e.quaternion).normalize(),h_.set(1,0,0).applyQuaternion(e.quaternion).normalize(),t.style.cursor="move",this.dispatchEvent({type:"dragstart",object:At})))),Tc.copy(cr))}function Y3(){this.enabled!==!1&&(At&&(this.dispatchEvent({type:"dragend",object:At}),At=null),this.domElement.style.cursor=kn?"pointer":"auto",this.state=Vr.NONE)}function K3(n){this.enabled!==!1&&n.preventDefault()}function f_(n,e=null){return n.isGroup&&(e=n),n.parent===null?e:f_(n.parent,e)}function Q3(n,e,t){var r,i=1;n==null&&(n=0),e==null&&(e=0),t==null&&(t=0);function s(){var o,a=r.length,c,l=0,u=0,d=0;for(o=0;o<a;++o)c=r[o],l+=c.x||0,u+=c.y||0,d+=c.z||0;for(l=(l/a-n)*i,u=(u/a-e)*i,d=(d/a-t)*i,o=0;o<a;++o)c=r[o],l&&(c.x-=l),u&&(c.y-=u),d&&(c.z-=d)}return s.initialize=function(o){r=o},s.x=function(o){return arguments.length?(n=+o,s):n},s.y=function(o){return arguments.length?(e=+o,s):e},s.z=function(o){return arguments.length?(t=+o,s):t},s.strength=function(o){return arguments.length?(i=+o,s):i},s}function Z3(n){const e=+this._x.call(null,n);return p_(this.cover(e),e,n)}function p_(n,e,t){if(isNaN(e))return n;var r,i=n._root,s={data:t},o=n._x0,a=n._x1,c,l,u,d,h;if(!i)return n._root=s,n;for(;i.length;)if((u=e>=(c=(o+a)/2))?o=c:a=c,r=i,!(i=i[d=+u]))return r[d]=s,n;if(l=+n._x.call(null,i.data),e===l)return s.next=i,r?r[d]=s:n._root=s,n;do r=r?r[d]=new Array(2):n._root=new Array(2),(u=e>=(c=(o+a)/2))?o=c:a=c;while((d=+u)==(h=+(l>=c)));return r[h]=i,r[d]=s,n}function J3(n){Array.isArray(n)||(n=Array.from(n));const e=n.length,t=new Float64Array(e);let r=1/0,i=-1/0;for(let s=0,o;s<e;++s)isNaN(o=+this._x.call(null,n[s]))||(t[s]=o,o<r&&(r=o),o>i&&(i=o));if(r>i)return this;this.cover(r).cover(i);for(let s=0;s<e;++s)p_(this,t[s],n[s]);return this}function eM(n){if(isNaN(n=+n))return this;var e=this._x0,t=this._x1;if(isNaN(e))t=(e=Math.floor(n))+1;else{for(var r=t-e||1,i=this._root,s,o;e>n||n>=t;)switch(o=+(n<e),s=new Array(2),s[o]=i,i=s,r*=2,o){case 0:t=e+r;break;case 1:e=t-r;break}this._root&&this._root.length&&(this._root=i)}return this._x0=e,this._x1=t,this}function tM(){var n=[];return this.visit(function(e){if(!e.length)do n.push(e.data);while(e=e.next)}),n}function nM(n){return arguments.length?this.cover(+n[0][0]).cover(+n[1][0]):isNaN(this._x0)?void 0:[[this._x0],[this._x1]]}function gr(n,e,t){this.node=n,this.x0=e,this.x1=t}function rM(n,e){var t,r=this._x0,i,s,o=this._x1,a=[],c=this._root,l,u;for(c&&a.push(new gr(c,r,o)),e==null?e=1/0:(r=n-e,o=n+e);l=a.pop();)if(!(!(c=l.node)||(i=l.x0)>o||(s=l.x1)<r))if(c.length){var d=(i+s)/2;a.push(new gr(c[1],d,s),new gr(c[0],i,d)),(u=+(n>=d))&&(l=a[a.length-1],a[a.length-1]=a[a.length-1-u],a[a.length-1-u]=l)}else{var h=Math.abs(n-+this._x.call(null,c.data));h<e&&(e=h,r=n-h,o=n+h,t=c.data)}return t}function iM(n){if(isNaN(c=+this._x.call(null,n)))return this;var e,t=this._root,r,i,s,o=this._x0,a=this._x1,c,l,u,d,h;if(!t)return this;if(t.length)for(;;){if((u=c>=(l=(o+a)/2))?o=l:a=l,e=t,!(t=t[d=+u]))return this;if(!t.length)break;e[d+1&1]&&(r=e,h=d)}for(;t.data!==n;)if(i=t,!(t=t.next))return this;return(s=t.next)&&delete t.next,i?(s?i.next=s:delete i.next,this):e?(s?e[d]=s:delete e[d],(t=e[0]||e[1])&&t===(e[1]||e[0])&&!t.length&&(r?r[h]=t:this._root=t),this):(this._root=s,this)}function sM(n){for(var e=0,t=n.length;e<t;++e)this.remove(n[e]);return this}function oM(){return this._root}function aM(){var n=0;return this.visit(function(e){if(!e.length)do++n;while(e=e.next)}),n}function cM(n){var e=[],t,r=this._root,i,s,o;for(r&&e.push(new gr(r,this._x0,this._x1));t=e.pop();)if(!n(r=t.node,s=t.x0,o=t.x1)&&r.length){var a=(s+o)/2;(i=r[1])&&e.push(new gr(i,a,o)),(i=r[0])&&e.push(new gr(i,s,a))}return this}function lM(n){var e=[],t=[],r;for(this._root&&e.push(new gr(this._root,this._x0,this._x1));r=e.pop();){var i=r.node;if(i.length){var s,o=r.x0,a=r.x1,c=(o+a)/2;(s=i[0])&&e.push(new gr(s,o,c)),(s=i[1])&&e.push(new gr(s,c,a))}t.push(r)}for(;r=t.pop();)n(r.node,r.x0,r.x1);return this}function uM(n){return n[0]}function dM(n){return arguments.length?(this._x=n,this):this._x}function g_(n,e){var t=new Lf(e??uM,NaN,NaN);return n==null?t:t.addAll(n)}function Lf(n,e,t){this._x=n,this._x0=e,this._x1=t,this._root=void 0}function Lg(n){for(var e={data:n.data},t=e;n=n.next;)t=t.next={data:n.data};return e}var Wt=g_.prototype=Lf.prototype;Wt.copy=function(){var n=new Lf(this._x,this._x0,this._x1),e=this._root,t,r;if(!e)return n;if(!e.length)return n._root=Lg(e),n;for(t=[{source:e,target:n._root=new Array(2)}];e=t.pop();)for(var i=0;i<2;++i)(r=e.source[i])&&(r.length?t.push({source:r,target:e.target[i]=new Array(2)}):e.target[i]=Lg(r));return n};Wt.add=Z3;Wt.addAll=J3;Wt.cover=eM;Wt.data=tM;Wt.extent=nM;Wt.find=rM;Wt.remove=iM;Wt.removeAll=sM;Wt.root=oM;Wt.size=aM;Wt.visit=cM;Wt.visitAfter=lM;Wt.x=dM;function hM(n){const e=+this._x.call(null,n),t=+this._y.call(null,n);return m_(this.cover(e,t),e,t,n)}function m_(n,e,t,r){if(isNaN(e)||isNaN(t))return n;var i,s=n._root,o={data:r},a=n._x0,c=n._y0,l=n._x1,u=n._y1,d,h,f,p,g,x,m,y;if(!s)return n._root=o,n;for(;s.length;)if((g=e>=(d=(a+l)/2))?a=d:l=d,(x=t>=(h=(c+u)/2))?c=h:u=h,i=s,!(s=s[m=x<<1|g]))return i[m]=o,n;if(f=+n._x.call(null,s.data),p=+n._y.call(null,s.data),e===f&&t===p)return o.next=s,i?i[m]=o:n._root=o,n;do i=i?i[m]=new Array(4):n._root=new Array(4),(g=e>=(d=(a+l)/2))?a=d:l=d,(x=t>=(h=(c+u)/2))?c=h:u=h;while((m=x<<1|g)===(y=(p>=h)<<1|f>=d));return i[y]=s,i[m]=o,n}function fM(n){var e,t,r=n.length,i,s,o=new Array(r),a=new Array(r),c=1/0,l=1/0,u=-1/0,d=-1/0;for(t=0;t<r;++t)isNaN(i=+this._x.call(null,e=n[t]))||isNaN(s=+this._y.call(null,e))||(o[t]=i,a[t]=s,i<c&&(c=i),i>u&&(u=i),s<l&&(l=s),s>d&&(d=s));if(c>u||l>d)return this;for(this.cover(c,l).cover(u,d),t=0;t<r;++t)m_(this,o[t],a[t],n[t]);return this}function pM(n,e){if(isNaN(n=+n)||isNaN(e=+e))return this;var t=this._x0,r=this._y0,i=this._x1,s=this._y1;if(isNaN(t))i=(t=Math.floor(n))+1,s=(r=Math.floor(e))+1;else{for(var o=i-t||1,a=this._root,c,l;t>n||n>=i||r>e||e>=s;)switch(l=(e<r)<<1|n<t,c=new Array(4),c[l]=a,a=c,o*=2,l){case 0:i=t+o,s=r+o;break;case 1:t=i-o,s=r+o;break;case 2:i=t+o,r=s-o;break;case 3:t=i-o,r=s-o;break}this._root&&this._root.length&&(this._root=a)}return this._x0=t,this._y0=r,this._x1=i,this._y1=s,this}function gM(){var n=[];return this.visit(function(e){if(!e.length)do n.push(e.data);while(e=e.next)}),n}function mM(n){return arguments.length?this.cover(+n[0][0],+n[0][1]).cover(+n[1][0],+n[1][1]):isNaN(this._x0)?void 0:[[this._x0,this._y0],[this._x1,this._y1]]}function Bt(n,e,t,r,i){this.node=n,this.x0=e,this.y0=t,this.x1=r,this.y1=i}function xM(n,e,t){var r,i=this._x0,s=this._y0,o,a,c,l,u=this._x1,d=this._y1,h=[],f=this._root,p,g;for(f&&h.push(new Bt(f,i,s,u,d)),t==null?t=1/0:(i=n-t,s=e-t,u=n+t,d=e+t,t*=t);p=h.pop();)if(!(!(f=p.node)||(o=p.x0)>u||(a=p.y0)>d||(c=p.x1)<i||(l=p.y1)<s))if(f.length){var x=(o+c)/2,m=(a+l)/2;h.push(new Bt(f[3],x,m,c,l),new Bt(f[2],o,m,x,l),new Bt(f[1],x,a,c,m),new Bt(f[0],o,a,x,m)),(g=(e>=m)<<1|n>=x)&&(p=h[h.length-1],h[h.length-1]=h[h.length-1-g],h[h.length-1-g]=p)}else{var y=n-+this._x.call(null,f.data),_=e-+this._y.call(null,f.data),v=y*y+_*_;if(v<t){var T=Math.sqrt(t=v);i=n-T,s=e-T,u=n+T,d=e+T,r=f.data}}return r}function yM(n){if(isNaN(u=+this._x.call(null,n))||isNaN(d=+this._y.call(null,n)))return this;var e,t=this._root,r,i,s,o=this._x0,a=this._y0,c=this._x1,l=this._y1,u,d,h,f,p,g,x,m;if(!t)return this;if(t.length)for(;;){if((p=u>=(h=(o+c)/2))?o=h:c=h,(g=d>=(f=(a+l)/2))?a=f:l=f,e=t,!(t=t[x=g<<1|p]))return this;if(!t.length)break;(e[x+1&3]||e[x+2&3]||e[x+3&3])&&(r=e,m=x)}for(;t.data!==n;)if(i=t,!(t=t.next))return this;return(s=t.next)&&delete t.next,i?(s?i.next=s:delete i.next,this):e?(s?e[x]=s:delete e[x],(t=e[0]||e[1]||e[2]||e[3])&&t===(e[3]||e[2]||e[1]||e[0])&&!t.length&&(r?r[m]=t:this._root=t),this):(this._root=s,this)}function bM(n){for(var e=0,t=n.length;e<t;++e)this.remove(n[e]);return this}function _M(){return this._root}function vM(){var n=0;return this.visit(function(e){if(!e.length)do++n;while(e=e.next)}),n}function TM(n){var e=[],t,r=this._root,i,s,o,a,c;for(r&&e.push(new Bt(r,this._x0,this._y0,this._x1,this._y1));t=e.pop();)if(!n(r=t.node,s=t.x0,o=t.y0,a=t.x1,c=t.y1)&&r.length){var l=(s+a)/2,u=(o+c)/2;(i=r[3])&&e.push(new Bt(i,l,u,a,c)),(i=r[2])&&e.push(new Bt(i,s,u,l,c)),(i=r[1])&&e.push(new Bt(i,l,o,a,u)),(i=r[0])&&e.push(new Bt(i,s,o,l,u))}return this}function wM(n){var e=[],t=[],r;for(this._root&&e.push(new Bt(this._root,this._x0,this._y0,this._x1,this._y1));r=e.pop();){var i=r.node;if(i.length){var s,o=r.x0,a=r.y0,c=r.x1,l=r.y1,u=(o+c)/2,d=(a+l)/2;(s=i[0])&&e.push(new Bt(s,o,a,u,d)),(s=i[1])&&e.push(new Bt(s,u,a,c,d)),(s=i[2])&&e.push(new Bt(s,o,d,u,l)),(s=i[3])&&e.push(new Bt(s,u,d,c,l))}t.push(r)}for(;r=t.pop();)n(r.node,r.x0,r.y0,r.x1,r.y1);return this}function SM(n){return n[0]}function NM(n){return arguments.length?(this._x=n,this):this._x}function EM(n){return n[1]}function AM(n){return arguments.length?(this._y=n,this):this._y}function x_(n,e,t){var r=new Of(e??SM,t??EM,NaN,NaN,NaN,NaN);return n==null?r:r.addAll(n)}function Of(n,e,t,r,i,s){this._x=n,this._y=e,this._x0=t,this._y0=r,this._x1=i,this._y1=s,this._root=void 0}function Og(n){for(var e={data:n.data},t=e;n=n.next;)t=t.next={data:n.data};return e}var Lt=x_.prototype=Of.prototype;Lt.copy=function(){var n=new Of(this._x,this._y,this._x0,this._y0,this._x1,this._y1),e=this._root,t,r;if(!e)return n;if(!e.length)return n._root=Og(e),n;for(t=[{source:e,target:n._root=new Array(4)}];e=t.pop();)for(var i=0;i<4;++i)(r=e.source[i])&&(r.length?t.push({source:r,target:e.target[i]=new Array(4)}):e.target[i]=Og(r));return n};Lt.add=hM;Lt.addAll=fM;Lt.cover=pM;Lt.data=gM;Lt.extent=mM;Lt.find=xM;Lt.remove=yM;Lt.removeAll=bM;Lt.root=_M;Lt.size=vM;Lt.visit=TM;Lt.visitAfter=wM;Lt.x=NM;Lt.y=AM;function RM(n){const e=+this._x.call(null,n),t=+this._y.call(null,n),r=+this._z.call(null,n);return y_(this.cover(e,t,r),e,t,r,n)}function y_(n,e,t,r,i){if(isNaN(e)||isNaN(t)||isNaN(r))return n;var s,o=n._root,a={data:i},c=n._x0,l=n._y0,u=n._z0,d=n._x1,h=n._y1,f=n._z1,p,g,x,m,y,_,v,T,w,N,E;if(!o)return n._root=a,n;for(;o.length;)if((v=e>=(p=(c+d)/2))?c=p:d=p,(T=t>=(g=(l+h)/2))?l=g:h=g,(w=r>=(x=(u+f)/2))?u=x:f=x,s=o,!(o=o[N=w<<2|T<<1|v]))return s[N]=a,n;if(m=+n._x.call(null,o.data),y=+n._y.call(null,o.data),_=+n._z.call(null,o.data),e===m&&t===y&&r===_)return a.next=o,s?s[N]=a:n._root=a,n;do s=s?s[N]=new Array(8):n._root=new Array(8),(v=e>=(p=(c+d)/2))?c=p:d=p,(T=t>=(g=(l+h)/2))?l=g:h=g,(w=r>=(x=(u+f)/2))?u=x:f=x;while((N=w<<2|T<<1|v)===(E=(_>=x)<<2|(y>=g)<<1|m>=p));return s[E]=o,s[N]=a,n}function CM(n){Array.isArray(n)||(n=Array.from(n));const e=n.length,t=new Float64Array(e),r=new Float64Array(e),i=new Float64Array(e);let s=1/0,o=1/0,a=1/0,c=-1/0,l=-1/0,u=-1/0;for(let d=0,h,f,p,g;d<e;++d)isNaN(f=+this._x.call(null,h=n[d]))||isNaN(p=+this._y.call(null,h))||isNaN(g=+this._z.call(null,h))||(t[d]=f,r[d]=p,i[d]=g,f<s&&(s=f),f>c&&(c=f),p<o&&(o=p),p>l&&(l=p),g<a&&(a=g),g>u&&(u=g));if(s>c||o>l||a>u)return this;this.cover(s,o,a).cover(c,l,u);for(let d=0;d<e;++d)y_(this,t[d],r[d],i[d],n[d]);return this}function MM(n,e,t){if(isNaN(n=+n)||isNaN(e=+e)||isNaN(t=+t))return this;var r=this._x0,i=this._y0,s=this._z0,o=this._x1,a=this._y1,c=this._z1;if(isNaN(r))o=(r=Math.floor(n))+1,a=(i=Math.floor(e))+1,c=(s=Math.floor(t))+1;else{for(var l=o-r||1,u=this._root,d,h;r>n||n>=o||i>e||e>=a||s>t||t>=c;)switch(h=(t<s)<<2|(e<i)<<1|n<r,d=new Array(8),d[h]=u,u=d,l*=2,h){case 0:o=r+l,a=i+l,c=s+l;break;case 1:r=o-l,a=i+l,c=s+l;break;case 2:o=r+l,i=a-l,c=s+l;break;case 3:r=o-l,i=a-l,c=s+l;break;case 4:o=r+l,a=i+l,s=c-l;break;case 5:r=o-l,a=i+l,s=c-l;break;case 6:o=r+l,i=a-l,s=c-l;break;case 7:r=o-l,i=a-l,s=c-l;break}this._root&&this._root.length&&(this._root=u)}return this._x0=r,this._y0=i,this._z0=s,this._x1=o,this._y1=a,this._z1=c,this}function PM(){var n=[];return this.visit(function(e){if(!e.length)do n.push(e.data);while(e=e.next)}),n}function DM(n){return arguments.length?this.cover(+n[0][0],+n[0][1],+n[0][2]).cover(+n[1][0],+n[1][1],+n[1][2]):isNaN(this._x0)?void 0:[[this._x0,this._y0,this._z0],[this._x1,this._y1,this._z1]]}function $e(n,e,t,r,i,s,o){this.node=n,this.x0=e,this.y0=t,this.z0=r,this.x1=i,this.y1=s,this.z1=o}function BM(n,e,t,r){var i,s=this._x0,o=this._y0,a=this._z0,c,l,u,d,h,f,p=this._x1,g=this._y1,x=this._z1,m=[],y=this._root,_,v;for(y&&m.push(new $e(y,s,o,a,p,g,x)),r==null?r=1/0:(s=n-r,o=e-r,a=t-r,p=n+r,g=e+r,x=t+r,r*=r);_=m.pop();)if(!(!(y=_.node)||(c=_.x0)>p||(l=_.y0)>g||(u=_.z0)>x||(d=_.x1)<s||(h=_.y1)<o||(f=_.z1)<a))if(y.length){var T=(c+d)/2,w=(l+h)/2,N=(u+f)/2;m.push(new $e(y[7],T,w,N,d,h,f),new $e(y[6],c,w,N,T,h,f),new $e(y[5],T,l,N,d,w,f),new $e(y[4],c,l,N,T,w,f),new $e(y[3],T,w,u,d,h,N),new $e(y[2],c,w,u,T,h,N),new $e(y[1],T,l,u,d,w,N),new $e(y[0],c,l,u,T,w,N)),(v=(t>=N)<<2|(e>=w)<<1|n>=T)&&(_=m[m.length-1],m[m.length-1]=m[m.length-1-v],m[m.length-1-v]=_)}else{var E=n-+this._x.call(null,y.data),A=e-+this._y.call(null,y.data),B=t-+this._z.call(null,y.data),R=E*E+A*A+B*B;if(R<r){var L=Math.sqrt(r=R);s=n-L,o=e-L,a=t-L,p=n+L,g=e+L,x=t+L,i=y.data}}return i}const FM=(n,e,t,r,i,s)=>Math.sqrt((n-r)**2+(e-i)**2+(t-s)**2);function kM(n,e,t,r){const i=[],s=n-r,o=e-r,a=t-r,c=n+r,l=e+r,u=t+r;return this.visit((d,h,f,p,g,x,m)=>{if(!d.length)do{const y=d.data;FM(n,e,t,this._x(y),this._y(y),this._z(y))<=r&&i.push(y)}while(d=d.next);return h>c||f>l||p>u||g<s||x<o||m<a}),i}function IM(n){if(isNaN(h=+this._x.call(null,n))||isNaN(f=+this._y.call(null,n))||isNaN(p=+this._z.call(null,n)))return this;var e,t=this._root,r,i,s,o=this._x0,a=this._y0,c=this._z0,l=this._x1,u=this._y1,d=this._z1,h,f,p,g,x,m,y,_,v,T,w;if(!t)return this;if(t.length)for(;;){if((y=h>=(g=(o+l)/2))?o=g:l=g,(_=f>=(x=(a+u)/2))?a=x:u=x,(v=p>=(m=(c+d)/2))?c=m:d=m,e=t,!(t=t[T=v<<2|_<<1|y]))return this;if(!t.length)break;(e[T+1&7]||e[T+2&7]||e[T+3&7]||e[T+4&7]||e[T+5&7]||e[T+6&7]||e[T+7&7])&&(r=e,w=T)}for(;t.data!==n;)if(i=t,!(t=t.next))return this;return(s=t.next)&&delete t.next,i?(s?i.next=s:delete i.next,this):e?(s?e[T]=s:delete e[T],(t=e[0]||e[1]||e[2]||e[3]||e[4]||e[5]||e[6]||e[7])&&t===(e[7]||e[6]||e[5]||e[4]||e[3]||e[2]||e[1]||e[0])&&!t.length&&(r?r[w]=t:this._root=t),this):(this._root=s,this)}function LM(n){for(var e=0,t=n.length;e<t;++e)this.remove(n[e]);return this}function OM(){return this._root}function UM(){var n=0;return this.visit(function(e){if(!e.length)do++n;while(e=e.next)}),n}function GM(n){var e=[],t,r=this._root,i,s,o,a,c,l,u;for(r&&e.push(new $e(r,this._x0,this._y0,this._z0,this._x1,this._y1,this._z1));t=e.pop();)if(!n(r=t.node,s=t.x0,o=t.y0,a=t.z0,c=t.x1,l=t.y1,u=t.z1)&&r.length){var d=(s+c)/2,h=(o+l)/2,f=(a+u)/2;(i=r[7])&&e.push(new $e(i,d,h,f,c,l,u)),(i=r[6])&&e.push(new $e(i,s,h,f,d,l,u)),(i=r[5])&&e.push(new $e(i,d,o,f,c,h,u)),(i=r[4])&&e.push(new $e(i,s,o,f,d,h,u)),(i=r[3])&&e.push(new $e(i,d,h,a,c,l,f)),(i=r[2])&&e.push(new $e(i,s,h,a,d,l,f)),(i=r[1])&&e.push(new $e(i,d,o,a,c,h,f)),(i=r[0])&&e.push(new $e(i,s,o,a,d,h,f))}return this}function $M(n){var e=[],t=[],r;for(this._root&&e.push(new $e(this._root,this._x0,this._y0,this._z0,this._x1,this._y1,this._z1));r=e.pop();){var i=r.node;if(i.length){var s,o=r.x0,a=r.y0,c=r.z0,l=r.x1,u=r.y1,d=r.z1,h=(o+l)/2,f=(a+u)/2,p=(c+d)/2;(s=i[0])&&e.push(new $e(s,o,a,c,h,f,p)),(s=i[1])&&e.push(new $e(s,h,a,c,l,f,p)),(s=i[2])&&e.push(new $e(s,o,f,c,h,u,p)),(s=i[3])&&e.push(new $e(s,h,f,c,l,u,p)),(s=i[4])&&e.push(new $e(s,o,a,p,h,f,d)),(s=i[5])&&e.push(new $e(s,h,a,p,l,f,d)),(s=i[6])&&e.push(new $e(s,o,f,p,h,u,d)),(s=i[7])&&e.push(new $e(s,h,f,p,l,u,d))}t.push(r)}for(;r=t.pop();)n(r.node,r.x0,r.y0,r.z0,r.x1,r.y1,r.z1);return this}function VM(n){return n[0]}function zM(n){return arguments.length?(this._x=n,this):this._x}function jM(n){return n[1]}function HM(n){return arguments.length?(this._y=n,this):this._y}function WM(n){return n[2]}function qM(n){return arguments.length?(this._z=n,this):this._z}function b_(n,e,t,r){var i=new Uf(e??VM,t??jM,r??WM,NaN,NaN,NaN,NaN,NaN,NaN);return n==null?i:i.addAll(n)}function Uf(n,e,t,r,i,s,o,a,c){this._x=n,this._y=e,this._z=t,this._x0=r,this._y0=i,this._z0=s,this._x1=o,this._y1=a,this._z1=c,this._root=void 0}function Ug(n){for(var e={data:n.data},t=e;n=n.next;)t=t.next={data:n.data};return e}var wt=b_.prototype=Uf.prototype;wt.copy=function(){var n=new Uf(this._x,this._y,this._z,this._x0,this._y0,this._z0,this._x1,this._y1,this._z1),e=this._root,t,r;if(!e)return n;if(!e.length)return n._root=Ug(e),n;for(t=[{source:e,target:n._root=new Array(8)}];e=t.pop();)for(var i=0;i<8;++i)(r=e.source[i])&&(r.length?t.push({source:r,target:e.target[i]=new Array(8)}):e.target[i]=Ug(r));return n};wt.add=RM;wt.addAll=CM;wt.cover=MM;wt.data=PM;wt.extent=DM;wt.find=BM;wt.findAllWithinRadius=kM;wt.remove=IM;wt.removeAll=LM;wt.root=OM;wt.size=UM;wt.visit=GM;wt.visitAfter=$M;wt.x=zM;wt.y=HM;wt.z=qM;function fr(n){return function(){return n}}function ir(n){return(n()-.5)*1e-6}function XM(n){return n.index}function Gg(n,e){var t=n.get(e);if(!t)throw new Error("node not found: "+e);return t}function YM(n){var e=XM,t=h,r,i=fr(30),s,o,a,c,l,u,d=1;n==null&&(n=[]);function h(m){return 1/Math.min(c[m.source.index],c[m.target.index])}function f(m){for(var y=0,_=n.length;y<d;++y)for(var v=0,T,w,N,E=0,A=0,B=0,R,L;v<_;++v)T=n[v],w=T.source,N=T.target,E=N.x+N.vx-w.x-w.vx||ir(u),a>1&&(A=N.y+N.vy-w.y-w.vy||ir(u)),a>2&&(B=N.z+N.vz-w.z-w.vz||ir(u)),R=Math.sqrt(E*E+A*A+B*B),R=(R-s[v])/R*m*r[v],E*=R,A*=R,B*=R,N.vx-=E*(L=l[v]),a>1&&(N.vy-=A*L),a>2&&(N.vz-=B*L),w.vx+=E*(L=1-L),a>1&&(w.vy+=A*L),a>2&&(w.vz+=B*L)}function p(){if(o){var m,y=o.length,_=n.length,v=new Map(o.map((w,N)=>[e(w,N,o),w])),T;for(m=0,c=new Array(y);m<_;++m)T=n[m],T.index=m,typeof T.source!="object"&&(T.source=Gg(v,T.source)),typeof T.target!="object"&&(T.target=Gg(v,T.target)),c[T.source.index]=(c[T.source.index]||0)+1,c[T.target.index]=(c[T.target.index]||0)+1;for(m=0,l=new Array(_);m<_;++m)T=n[m],l[m]=c[T.source.index]/(c[T.source.index]+c[T.target.index]);r=new Array(_),g(),s=new Array(_),x()}}function g(){if(o)for(var m=0,y=n.length;m<y;++m)r[m]=+t(n[m],m,n)}function x(){if(o)for(var m=0,y=n.length;m<y;++m)s[m]=+i(n[m],m,n)}return f.initialize=function(m,...y){o=m,u=y.find(_=>typeof _=="function")||Math.random,a=y.find(_=>[1,2,3].includes(_))||2,p()},f.links=function(m){return arguments.length?(n=m,p(),f):n},f.id=function(m){return arguments.length?(e=m,f):e},f.iterations=function(m){return arguments.length?(d=+m,f):d},f.strength=function(m){return arguments.length?(t=typeof m=="function"?m:fr(+m),g(),f):t},f.distance=function(m){return arguments.length?(i=typeof m=="function"?m:fr(+m),x(),f):i},f}const KM=1664525,QM=1013904223,$g=4294967296;function ZM(){let n=1;return()=>(n=(KM*n+QM)%$g)/$g}var Vg=3;function fu(n){return n.x}function zg(n){return n.y}function JM(n){return n.z}var eP=10,tP=Math.PI*(3-Math.sqrt(5)),nP=Math.PI*20/(9+Math.sqrt(221));function rP(n,e){e=e||2;var t=Math.min(Vg,Math.max(1,Math.round(e))),r,i=1,s=.001,o=1-Math.pow(s,1/300),a=0,c=.6,l=new Map,u=Tf(f),d=aa("tick","end"),h=ZM();n==null&&(n=[]);function f(){p(),d.call("tick",r),i<s&&(u.stop(),d.call("end",r))}function p(m){var y,_=n.length,v;m===void 0&&(m=1);for(var T=0;T<m;++T)for(i+=(a-i)*o,l.forEach(function(w){w(i)}),y=0;y<_;++y)v=n[y],v.fx==null?v.x+=v.vx*=c:(v.x=v.fx,v.vx=0),t>1&&(v.fy==null?v.y+=v.vy*=c:(v.y=v.fy,v.vy=0)),t>2&&(v.fz==null?v.z+=v.vz*=c:(v.z=v.fz,v.vz=0));return r}function g(){for(var m=0,y=n.length,_;m<y;++m){if(_=n[m],_.index=m,_.fx!=null&&(_.x=_.fx),_.fy!=null&&(_.y=_.fy),_.fz!=null&&(_.z=_.fz),isNaN(_.x)||t>1&&isNaN(_.y)||t>2&&isNaN(_.z)){var v=eP*(t>2?Math.cbrt(.5+m):t>1?Math.sqrt(.5+m):m),T=m*tP,w=m*nP;t===1?_.x=v:t===2?(_.x=v*Math.cos(T),_.y=v*Math.sin(T)):(_.x=v*Math.sin(T)*Math.cos(w),_.y=v*Math.cos(T),_.z=v*Math.sin(T)*Math.sin(w))}(isNaN(_.vx)||t>1&&isNaN(_.vy)||t>2&&isNaN(_.vz))&&(_.vx=0,t>1&&(_.vy=0),t>2&&(_.vz=0))}}function x(m){return m.initialize&&m.initialize(n,h,t),m}return g(),r={tick:p,restart:function(){return u.restart(f),r},stop:function(){return u.stop(),r},numDimensions:function(m){return arguments.length?(t=Math.min(Vg,Math.max(1,Math.round(m))),l.forEach(x),r):t},nodes:function(m){return arguments.length?(n=m,g(),l.forEach(x),r):n},alpha:function(m){return arguments.length?(i=+m,r):i},alphaMin:function(m){return arguments.length?(s=+m,r):s},alphaDecay:function(m){return arguments.length?(o=+m,r):+o},alphaTarget:function(m){return arguments.length?(a=+m,r):a},velocityDecay:function(m){return arguments.length?(c=1-m,r):1-c},randomSource:function(m){return arguments.length?(h=m,l.forEach(x),r):h},force:function(m,y){return arguments.length>1?(y==null?l.delete(m):l.set(m,x(y)),r):l.get(m)},find:function(){var m=Array.prototype.slice.call(arguments),y=m.shift()||0,_=(t>1?m.shift():null)||0,v=(t>2?m.shift():null)||0,T=m.shift()||1/0,w=0,N=n.length,E,A,B,R,L,F;for(T*=T,w=0;w<N;++w)L=n[w],E=y-L.x,A=_-(L.y||0),B=v-(L.z||0),R=E*E+A*A+B*B,R<T&&(F=L,T=R);return F},on:function(m,y){return arguments.length>1?(d.on(m,y),r):d.on(m)}}}function iP(){var n,e,t,r,i,s=fr(-30),o,a=1,c=1/0,l=.81;function u(p){var g,x=n.length,m=(e===1?g_(n,fu):e===2?x_(n,fu,zg):e===3?b_(n,fu,zg,JM):null).visitAfter(h);for(i=p,g=0;g<x;++g)t=n[g],m.visit(f)}function d(){if(n){var p,g=n.length,x;for(o=new Array(g),p=0;p<g;++p)x=n[p],o[x.index]=+s(x,p,n)}}function h(p){var g=0,x,m,y=0,_,v,T,w,N=p.length;if(N){for(_=v=T=w=0;w<N;++w)(x=p[w])&&(m=Math.abs(x.value))&&(g+=x.value,y+=m,_+=m*(x.x||0),v+=m*(x.y||0),T+=m*(x.z||0));g*=Math.sqrt(4/N),p.x=_/y,e>1&&(p.y=v/y),e>2&&(p.z=T/y)}else{x=p,x.x=x.data.x,e>1&&(x.y=x.data.y),e>2&&(x.z=x.data.z);do g+=o[x.data.index];while(x=x.next)}p.value=g}function f(p,g,x,m,y){if(!p.value)return!0;var _=[x,m,y][e-1],v=p.x-t.x,T=e>1?p.y-t.y:0,w=e>2?p.z-t.z:0,N=_-g,E=v*v+T*T+w*w;if(N*N/l<E)return E<c&&(v===0&&(v=ir(r),E+=v*v),e>1&&T===0&&(T=ir(r),E+=T*T),e>2&&w===0&&(w=ir(r),E+=w*w),E<a&&(E=Math.sqrt(a*E)),t.vx+=v*p.value*i/E,e>1&&(t.vy+=T*p.value*i/E),e>2&&(t.vz+=w*p.value*i/E)),!0;if(p.length||E>=c)return;(p.data!==t||p.next)&&(v===0&&(v=ir(r),E+=v*v),e>1&&T===0&&(T=ir(r),E+=T*T),e>2&&w===0&&(w=ir(r),E+=w*w),E<a&&(E=Math.sqrt(a*E)));do p.data!==t&&(N=o[p.data.index]*i/E,t.vx+=v*N,e>1&&(t.vy+=T*N),e>2&&(t.vz+=w*N));while(p=p.next)}return u.initialize=function(p,...g){n=p,r=g.find(x=>typeof x=="function")||Math.random,e=g.find(x=>[1,2,3].includes(x))||2,d()},u.strength=function(p){return arguments.length?(s=typeof p=="function"?p:fr(+p),d(),u):s},u.distanceMin=function(p){return arguments.length?(a=p*p,u):Math.sqrt(a)},u.distanceMax=function(p){return arguments.length?(c=p*p,u):Math.sqrt(c)},u.theta=function(p){return arguments.length?(l=p*p,u):Math.sqrt(l)},u}function sP(n,e,t,r){var i,s,o=fr(.1),a,c;typeof n!="function"&&(n=fr(+n)),e==null&&(e=0),t==null&&(t=0),r==null&&(r=0);function l(d){for(var h=0,f=i.length;h<f;++h){var p=i[h],g=p.x-e||1e-6,x=(p.y||0)-t||1e-6,m=(p.z||0)-r||1e-6,y=Math.sqrt(g*g+x*x+m*m),_=(c[h]-y)*a[h]*d/y;p.vx+=g*_,s>1&&(p.vy+=x*_),s>2&&(p.vz+=m*_)}}function u(){if(i){var d,h=i.length;for(a=new Array(h),c=new Array(h),d=0;d<h;++d)c[d]=+n(i[d],d,i),a[d]=isNaN(c[d])?0:+o(i[d],d,i)}}return l.initialize=function(d,...h){i=d,s=h.find(f=>[1,2,3].includes(f))||2,u()},l.strength=function(d){return arguments.length?(o=typeof d=="function"?d:fr(+d),u(),l):o},l.radius=function(d){return arguments.length?(n=typeof d=="function"?d:fr(+d),u(),l):n},l.x=function(d){return arguments.length?(e=+d,l):e},l.y=function(d){return arguments.length?(t=+d,l):t},l.z=function(d){return arguments.length?(r=+d,l):r},l}function oP(n){cP(n);const e=aP(n);return n.on=e.on,n.off=e.off,n.fire=e.fire,n}function aP(n){let e=Object.create(null);return{on:function(t,r,i){if(typeof r!="function")throw new Error("callback is expected to be a function");let s=e[t];return s||(s=e[t]=[]),s.push({callback:r,ctx:i}),n},off:function(t,r){if(typeof t>"u")return e=Object.create(null),n;if(e[t])if(typeof r!="function")delete e[t];else{const o=e[t];for(let a=0;a<o.length;++a)o[a].callback===r&&o.splice(a,1)}return n},fire:function(t){const r=e[t];if(!r)return n;let i;arguments.length>1&&(i=Array.prototype.slice.call(arguments,1));for(let s=0;s<r.length;++s){const o=r[s];o.callback.apply(o.ctx,i)}return n}}}function cP(n){if(!n)throw new Error("Eventify cannot use falsy object as events subject");const e=["on","fire","off"];for(let t=0;t<e.length;++t)if(n.hasOwnProperty(e[t]))throw new Error("Subject cannot be eventified, since it already has property '"+e[t]+"'")}function lP(n){if(n=n||{},"uniqueLinkId"in n&&(console.warn("ngraph.graph: Starting from version 0.14 `uniqueLinkId` is deprecated.\nUse `multigraph` option instead\n",`
`,`Note: there is also change in default behavior: From now on each graph
is considered to be not a multigraph by default (each edge is unique).`),n.multigraph=n.uniqueLinkId),n.multigraph===void 0&&(n.multigraph=!1),typeof Map!="function")throw new Error("ngraph.graph requires `Map` to be defined. Please polyfill it before using ngraph");var e=new Map,t=new Map,r={},i=0,s=n.multigraph?v:_,o=[],a=P,c=P,l=P,u=P,d={version:20,addNode:g,addLink:y,removeLink:E,removeNode:m,getNode:x,getNodeCount:T,getLinkCount:w,getEdgeCount:w,getLinksCount:w,getNodesCount:T,getLinks:N,forEachNode:W,forEachLinkedNode:S,forEachLink:F,beginUpdate:l,endUpdate:u,clear:L,hasLink:B,hasNode:x,getLink:B,getLinkById:R};return oP(d),h(),d;function h(){var G=d.on;d.on=z;function z(){return d.beginUpdate=l=$,d.endUpdate=u=M,a=f,c=p,d.on=G,G.apply(d,arguments)}}function f(G,z){o.push({link:G,changeType:z})}function p(G,z){o.push({node:G,changeType:z})}function g(G,z){if(G===void 0)throw new Error("Invalid node identifier");l();var Z=x(G);return Z?(Z.data=z,c(Z,"update")):(Z=new uP(G,z),c(Z,"add")),e.set(G,Z),u(),Z}function x(G){return e.get(G)}function m(G){var z=x(G);if(!z)return!1;l();var Z=z.links;return Z&&(Z.forEach(A),z.links=null),e.delete(G),c(z,"remove"),u(),!0}function y(G,z,Z){l();var ee=x(G)||g(G),O=x(z)||g(z),Y=s(G,z,Z),te=t.has(Y.id);return t.set(Y.id,Y),jg(ee,Y),G!==z&&jg(O,Y),a(Y,te?"update":"add"),u(),Y}function _(G,z,Z){var ee=Ca(G,z),O=t.get(ee);return O?(O.data=Z,O):new Hg(G,z,Z,ee)}function v(G,z,Z){var ee=Ca(G,z),O=r.hasOwnProperty(ee);if(O||B(G,z)){O||(r[ee]=0);var Y="@"+ ++r[ee];ee=Ca(G+Y,z+Y)}return new Hg(G,z,Z,ee)}function T(){return e.size}function w(){return t.size}function N(G){var z=x(G);return z?z.links:null}function E(G,z){return z!==void 0&&(G=B(G,z)),A(G)}function A(G){if(!G||!t.get(G.id))return!1;l(),t.delete(G.id);var z=x(G.fromId),Z=x(G.toId);return z&&z.links.delete(G),Z&&Z.links.delete(G),a(G,"remove"),u(),!0}function B(G,z){if(!(G===void 0||z===void 0))return t.get(Ca(G,z))}function R(G){if(G!==void 0)return t.get(G)}function L(){l(),W(function(G){m(G.id)}),u()}function F(G){if(typeof G=="function")for(var z=t.values(),Z=z.next();!Z.done;){if(G(Z.value))return!0;Z=z.next()}}function S(G,z,Z){var ee=x(G);if(ee&&ee.links&&typeof z=="function")return Z?k(ee.links,G,z):U(ee.links,G,z)}function U(G,z,Z){for(var ee,O=G.values(),Y=O.next();!Y.done;){var te=Y.value,ae=te.fromId===z?te.toId:te.fromId;if(ee=Z(e.get(ae),te),ee)return!0;Y=O.next()}}function k(G,z,Z){for(var ee,O=G.values(),Y=O.next();!Y.done;){var te=Y.value;if(te.fromId===z&&(ee=Z(e.get(te.toId),te),ee))return!0;Y=O.next()}}function P(){}function $(){i+=1}function M(){i-=1,i===0&&o.length>0&&(d.fire("changed",o),o.length=0)}function W(G){if(typeof G!="function")throw new Error("Function is expected to iterate over graph nodes. You passed "+G);for(var z=e.values(),Z=z.next();!Z.done;){if(G(Z.value))return!0;Z=z.next()}}}function uP(n,e){this.id=n,this.links=null,this.data=e}function jg(n,e){n.links?n.links.add(e):n.links=new Set([e])}function Hg(n,e,t,r){this.fromId=n,this.toId=e,this.data=t,this.id=r}function Ca(n,e){return n.toString()+" "+e.toString()}var Ma={exports:{}},ji={exports:{}},pu,Wg;function __(){return Wg||(Wg=1,pu=function(e){return e===0?"x":e===1?"y":e===2?"z":"c"+(e+1)}),pu}var gu,qg;function Ls(){if(qg)return gu;qg=1;const n=__();return gu=function(t){return r;function r(i,s){let o=s&&s.indent||0,a=s&&s.join!==void 0?s.join:`
`,c=Array(o+1).join(" "),l=[];for(let u=0;u<t;++u){let d=n(u),h=u===0?"":c;l.push(h+i.replace(/{var}/g,d))}return l.join(a)}},gu}var Xg;function dP(){if(Xg)return ji.exports;Xg=1;const n=Ls();ji.exports=e,ji.exports.generateCreateBodyFunctionBody=t,ji.exports.getVectorCode=i,ji.exports.getBodyCode=r;function e(s,o){let a=t(s,o),{Body:c}=new Function(a)();return c}function t(s,o){return`
${i(s,o)}
${r(s)}
return {Body: Body, Vector: Vector};
`}function r(s){let o=n(s),a=o("{var}",{join:", "});return`
function Body(${a}) {
  this.isPinned = false;
  this.pos = new Vector(${a});
  this.force = new Vector();
  this.velocity = new Vector();
  this.mass = 1;

  this.springCount = 0;
  this.springLength = 0;
}

Body.prototype.reset = function() {
  this.force.reset();
  this.springCount = 0;
  this.springLength = 0;
}

Body.prototype.setPosition = function (${a}) {
  ${o("this.pos.{var} = {var} || 0;",{indent:2})}
};`}function i(s,o){let a=n(s),c="";return o&&(c=`${a(`
	   var v{var};
	Object.defineProperty(this, '{var}', {
	  set: function(v) { 
	    if (!Number.isFinite(v)) throw new Error('Cannot set non-numbers to {var}');
	    v{var} = v; 
	  },
	  get: function() { return v{var}; }
	});`)}`),`function Vector(${a("{var}",{join:", "})}) {
  ${c}
    if (typeof arguments[0] === 'object') {
      // could be another vector
      let v = arguments[0];
      ${a('if (!Number.isFinite(v.{var})) throw new Error("Expected value is not a finite number at Vector constructor ({var})");',{indent:4})}
      ${a("this.{var} = v.{var};",{indent:4})}
    } else {
      ${a('this.{var} = typeof {var} === "number" ? {var} : 0;',{indent:4})}
    }
  }
  
  Vector.prototype.reset = function () {
    ${a("this.{var} = ",{join:""})}0;
  };`}return ji.exports}var Jn={exports:{}},Yg;function hP(){if(Yg)return Jn.exports;Yg=1;const n=Ls(),e=__();Jn.exports=t,Jn.exports.generateQuadTreeFunctionBody=r,Jn.exports.getInsertStackCode=c,Jn.exports.getQuadNodeCode=a,Jn.exports.isSamePosition=i,Jn.exports.getChildBodyCode=o,Jn.exports.setChildBodyCode=s;function t(l){let u=r(l);return new Function(u)()}function r(l){let u=n(l),d=Math.pow(2,l);return`
${c()}
${a(l)}
${i(l)}
${o(l)}
${s(l)}

function createQuadTree(options, random) {
  options = options || {};
  options.gravity = typeof options.gravity === 'number' ? options.gravity : -1;
  options.theta = typeof options.theta === 'number' ? options.theta : 0.8;

  var gravity = options.gravity;
  var updateQueue = [];
  var insertStack = new InsertStack();
  var theta = options.theta;

  var nodesCache = [];
  var currentInCache = 0;
  var root = newNode();

  return {
    insertBodies: insertBodies,

    /**
     * Gets root node if it is present
     */
    getRoot: function() {
      return root;
    },

    updateBodyForce: update,

    options: function(newOptions) {
      if (newOptions) {
        if (typeof newOptions.gravity === 'number') {
          gravity = newOptions.gravity;
        }
        if (typeof newOptions.theta === 'number') {
          theta = newOptions.theta;
        }

        return this;
      }

      return {
        gravity: gravity,
        theta: theta
      };
    }
  };

  function newNode() {
    // To avoid pressure on GC we reuse nodes.
    var node = nodesCache[currentInCache];
    if (node) {
${g("      node.")}
      node.body = null;
      node.mass = ${u("node.mass_{var} = ",{join:""})}0;
      ${u("node.min_{var} = node.max_{var} = ",{join:""})}0;
    } else {
      node = new QuadNode();
      nodesCache[currentInCache] = node;
    }

    ++currentInCache;
    return node;
  }

  function update(sourceBody) {
    var queue = updateQueue;
    var v;
    ${u("var d{var};",{indent:4})}
    var r; 
    ${u("var f{var} = 0;",{indent:4})}
    var queueLength = 1;
    var shiftIdx = 0;
    var pushIdx = 1;

    queue[0] = root;

    while (queueLength) {
      var node = queue[shiftIdx];
      var body = node.body;

      queueLength -= 1;
      shiftIdx += 1;
      var differentBody = (body !== sourceBody);
      if (body && differentBody) {
        // If the current node is a leaf node (and it is not source body),
        // calculate the force exerted by the current node on body, and add this
        // amount to body's net force.
        ${u("d{var} = body.pos.{var} - sourceBody.pos.{var};",{indent:8})}
        r = Math.sqrt(${u("d{var} * d{var}",{join:" + "})});

        if (r === 0) {
          // Poor man's protection against zero distance.
          ${u("d{var} = (random.nextDouble() - 0.5) / 50;",{indent:10})}
          r = Math.sqrt(${u("d{var} * d{var}",{join:" + "})});
        }

        // This is standard gravitation force calculation but we divide
        // by r^3 to save two operations when normalizing force vector.
        v = gravity * body.mass * sourceBody.mass / (r * r * r);
        ${u("f{var} += v * d{var};",{indent:8})}
      } else if (differentBody) {
        // Otherwise, calculate the ratio s / r,  where s is the width of the region
        // represented by the internal node, and r is the distance between the body
        // and the node's center-of-mass
        ${u("d{var} = node.mass_{var} / node.mass - sourceBody.pos.{var};",{indent:8})}
        r = Math.sqrt(${u("d{var} * d{var}",{join:" + "})});

        if (r === 0) {
          // Sorry about code duplication. I don't want to create many functions
          // right away. Just want to see performance first.
          ${u("d{var} = (random.nextDouble() - 0.5) / 50;",{indent:10})}
          r = Math.sqrt(${u("d{var} * d{var}",{join:" + "})});
        }
        // If s / r < , treat this internal node as a single body, and calculate the
        // force it exerts on sourceBody, and add this amount to sourceBody's net force.
        if ((node.max_${e(0)} - node.min_${e(0)}) / r < theta) {
          // in the if statement above we consider node's width only
          // because the region was made into square during tree creation.
          // Thus there is no difference between using width or height.
          v = gravity * node.mass * sourceBody.mass / (r * r * r);
          ${u("f{var} += v * d{var};",{indent:10})}
        } else {
          // Otherwise, run the procedure recursively on each of the current node's children.

          // I intentionally unfolded this loop, to save several CPU cycles.
${p()}
        }
      }
    }

    ${u("sourceBody.force.{var} += f{var};",{indent:4})}
  }

  function insertBodies(bodies) {
    ${u("var {var}min = Number.MAX_VALUE;",{indent:4})}
    ${u("var {var}max = Number.MIN_VALUE;",{indent:4})}
    var i = bodies.length;

    // To reduce quad tree depth we are looking for exact bounding box of all particles.
    while (i--) {
      var pos = bodies[i].pos;
      ${u("if (pos.{var} < {var}min) {var}min = pos.{var};",{indent:6})}
      ${u("if (pos.{var} > {var}max) {var}max = pos.{var};",{indent:6})}
    }

    // Makes the bounds square.
    var maxSideLength = -Infinity;
    ${u("if ({var}max - {var}min > maxSideLength) maxSideLength = {var}max - {var}min ;",{indent:4})}

    currentInCache = 0;
    root = newNode();
    ${u("root.min_{var} = {var}min;",{indent:4})}
    ${u("root.max_{var} = {var}min + maxSideLength;",{indent:4})}

    i = bodies.length - 1;
    if (i >= 0) {
      root.body = bodies[i];
    }
    while (i--) {
      insert(bodies[i], root);
    }
  }

  function insert(newBody) {
    insertStack.reset();
    insertStack.push(root, newBody);

    while (!insertStack.isEmpty()) {
      var stackItem = insertStack.pop();
      var node = stackItem.node;
      var body = stackItem.body;

      if (!node.body) {
        // This is internal node. Update the total mass of the node and center-of-mass.
        ${u("var {var} = body.pos.{var};",{indent:8})}
        node.mass += body.mass;
        ${u("node.mass_{var} += body.mass * {var};",{indent:8})}

        // Recursively insert the body in the appropriate quadrant.
        // But first find the appropriate quadrant.
        var quadIdx = 0; // Assume we are in the 0's quad.
        ${u("var min_{var} = node.min_{var};",{indent:8})}
        ${u("var max_{var} = (min_{var} + node.max_{var}) / 2;",{indent:8})}

${f(8)}

        var child = getChild(node, quadIdx);

        if (!child) {
          // The node is internal but this quadrant is not taken. Add
          // subnode to it.
          child = newNode();
          ${u("child.min_{var} = min_{var};",{indent:10})}
          ${u("child.max_{var} = max_{var};",{indent:10})}
          child.body = body;

          setChild(node, quadIdx, child);
        } else {
          // continue searching in this quadrant.
          insertStack.push(child, body);
        }
      } else {
        // We are trying to add to the leaf node.
        // We have to convert current leaf into internal node
        // and continue adding two nodes.
        var oldBody = node.body;
        node.body = null; // internal nodes do not cary bodies

        if (isSamePosition(oldBody.pos, body.pos)) {
          // Prevent infinite subdivision by bumping one node
          // anywhere in this quadrant
          var retriesCount = 3;
          do {
            var offset = random.nextDouble();
            ${u("var d{var} = (node.max_{var} - node.min_{var}) * offset;",{indent:12})}

            ${u("oldBody.pos.{var} = node.min_{var} + d{var};",{indent:12})}
            retriesCount -= 1;
            // Make sure we don't bump it out of the box. If we do, next iteration should fix it
          } while (retriesCount > 0 && isSamePosition(oldBody.pos, body.pos));

          if (retriesCount === 0 && isSamePosition(oldBody.pos, body.pos)) {
            // This is very bad, we ran out of precision.
            // if we do not return from the method we'll get into
            // infinite loop here. So we sacrifice correctness of layout, and keep the app running
            // Next layout iteration should get larger bounding box in the first step and fix this
            return;
          }
        }
        // Next iteration should subdivide node further.
        insertStack.push(node, oldBody);
        insertStack.push(node, body);
      }
    }
  }
}
return createQuadTree;

`;function f(x){let m=[],y=Array(x+1).join(" ");for(let _=0;_<l;++_)m.push(y+`if (${e(_)} > max_${e(_)}) {`),m.push(y+`  quadIdx = quadIdx + ${Math.pow(2,_)};`),m.push(y+`  min_${e(_)} = max_${e(_)};`),m.push(y+`  max_${e(_)} = node.max_${e(_)};`),m.push(y+"}");return m.join(`
`)}function p(){let x=Array(11).join(" "),m=[];for(let y=0;y<d;++y)m.push(x+`if (node.quad${y}) {`),m.push(x+`  queue[pushIdx] = node.quad${y};`),m.push(x+"  queueLength += 1;"),m.push(x+"  pushIdx += 1;"),m.push(x+"}");return m.join(`
`)}function g(x){let m=[];for(let y=0;y<d;++y)m.push(`${x}quad${y} = null;`);return m.join(`
`)}}function i(l){let u=n(l);return`
  function isSamePosition(point1, point2) {
    ${u("var d{var} = Math.abs(point1.{var} - point2.{var});",{indent:2})}
  
    return ${u("d{var} < 1e-8",{join:" && "})};
  }  
`}function s(l){var u=Math.pow(2,l);return`
function setChild(node, idx, child) {
  ${d()}
}`;function d(){let h=[];for(let f=0;f<u;++f){let p=f===0?"  ":"  else ";h.push(`${p}if (idx === ${f}) node.quad${f} = child;`)}return h.join(`
`)}}function o(l){return`function getChild(node, idx) {
${u()}
  return null;
}`;function u(){let d=[],h=Math.pow(2,l);for(let f=0;f<h;++f)d.push(`  if (idx === ${f}) return node.quad${f};`);return d.join(`
`)}}function a(l){let u=n(l),d=Math.pow(2,l);var h=`
function QuadNode() {
  // body stored inside this node. In quad tree only leaf nodes (by construction)
  // contain bodies:
  this.body = null;

  // Child nodes are stored in quads. Each quad is presented by number:
  // 0 | 1
  // -----
  // 2 | 3
${f("  this.")}

  // Total mass of current node
  this.mass = 0;

  // Center of mass coordinates
  ${u("this.mass_{var} = 0;",{indent:2})}

  // bounding box coordinates
  ${u("this.min_{var} = 0;",{indent:2})}
  ${u("this.max_{var} = 0;",{indent:2})}
}
`;return h;function f(p){let g=[];for(let x=0;x<d;++x)g.push(`${p}quad${x} = null;`);return g.join(`
`)}}function c(){return`
/**
 * Our implementation of QuadTree is non-recursive to avoid GC hit
 * This data structure represent stack of elements
 * which we are trying to insert into quad tree.
 */
function InsertStack () {
    this.stack = [];
    this.popIdx = 0;
}

InsertStack.prototype = {
    isEmpty: function() {
        return this.popIdx === 0;
    },
    push: function (node, body) {
        var item = this.stack[this.popIdx];
        if (!item) {
            // we are trying to avoid memory pressure: create new element
            // only when absolutely necessary
            this.stack[this.popIdx] = new InsertStackElement(node, body);
        } else {
            item.node = node;
            item.body = body;
        }
        ++this.popIdx;
    },
    pop: function () {
        if (this.popIdx > 0) {
            return this.stack[--this.popIdx];
        }
    },
    reset: function () {
        this.popIdx = 0;
    }
};

function InsertStackElement(node, body) {
    this.node = node; // QuadTree node
    this.body = body; // physical body which needs to be inserted to node
}
`}return Jn.exports}var Pa={exports:{}},Kg;function fP(){if(Kg)return Pa.exports;Kg=1,Pa.exports=e,Pa.exports.generateFunctionBody=t;const n=Ls();function e(r){let i=t(r);return new Function("bodies","settings","random",i)}function t(r){let i=n(r);return`
  var boundingBox = {
    ${i("min_{var}: 0, max_{var}: 0,",{indent:4})}
  };

  return {
    box: boundingBox,

    update: updateBoundingBox,

    reset: resetBoundingBox,

    getBestNewPosition: function (neighbors) {
      var ${i("base_{var} = 0",{join:", "})};

      if (neighbors.length) {
        for (var i = 0; i < neighbors.length; ++i) {
          let neighborPos = neighbors[i].pos;
          ${i("base_{var} += neighborPos.{var};",{indent:10})}
        }

        ${i("base_{var} /= neighbors.length;",{indent:8})}
      } else {
        ${i("base_{var} = (boundingBox.min_{var} + boundingBox.max_{var}) / 2;",{indent:8})}
      }

      var springLength = settings.springLength;
      return {
        ${i("{var}: base_{var} + (random.nextDouble() - 0.5) * springLength,",{indent:8})}
      };
    }
  };

  function updateBoundingBox() {
    var i = bodies.length;
    if (i === 0) return; // No bodies - no borders.

    ${i("var max_{var} = -Infinity;",{indent:4})}
    ${i("var min_{var} = Infinity;",{indent:4})}

    while(i--) {
      // this is O(n), it could be done faster with quadtree, if we check the root node bounds
      var bodyPos = bodies[i].pos;
      ${i("if (bodyPos.{var} < min_{var}) min_{var} = bodyPos.{var};",{indent:6})}
      ${i("if (bodyPos.{var} > max_{var}) max_{var} = bodyPos.{var};",{indent:6})}
    }

    ${i("boundingBox.min_{var} = min_{var};",{indent:4})}
    ${i("boundingBox.max_{var} = max_{var};",{indent:4})}
  }

  function resetBoundingBox() {
    ${i("boundingBox.min_{var} = boundingBox.max_{var} = 0;",{indent:4})}
  }
`}return Pa.exports}var Da={exports:{}},Qg;function pP(){if(Qg)return Da.exports;Qg=1;const n=Ls();Da.exports=e,Da.exports.generateCreateDragForceFunctionBody=t;function e(r){let i=t(r);return new Function("options",i)}function t(r){return`
  if (!Number.isFinite(options.dragCoefficient)) throw new Error('dragCoefficient is not a finite number');

  return {
    update: function(body) {
      ${n(r)("body.force.{var} -= options.dragCoefficient * body.velocity.{var};",{indent:6})}
    }
  };
`}return Da.exports}var Ba={exports:{}},Zg;function gP(){if(Zg)return Ba.exports;Zg=1;const n=Ls();Ba.exports=e,Ba.exports.generateCreateSpringForceFunctionBody=t;function e(r){let i=t(r);return new Function("options","random",i)}function t(r){let i=n(r);return`
  if (!Number.isFinite(options.springCoefficient)) throw new Error('Spring coefficient is not a number');
  if (!Number.isFinite(options.springLength)) throw new Error('Spring length is not a number');

  return {
    /**
     * Updates forces acting on a spring
     */
    update: function (spring) {
      var body1 = spring.from;
      var body2 = spring.to;
      var length = spring.length < 0 ? options.springLength : spring.length;
      ${i("var d{var} = body2.pos.{var} - body1.pos.{var};",{indent:6})}
      var r = Math.sqrt(${i("d{var} * d{var}",{join:" + "})});

      if (r === 0) {
        ${i("d{var} = (random.nextDouble() - 0.5) / 50;",{indent:8})}
        r = Math.sqrt(${i("d{var} * d{var}",{join:" + "})});
      }

      var d = r - length;
      var coefficient = ((spring.coefficient > 0) ? spring.coefficient : options.springCoefficient) * d / r;

      ${i("body1.force.{var} += coefficient * d{var}",{indent:6})};
      body1.springCount += 1;
      body1.springLength += r;

      ${i("body2.force.{var} -= coefficient * d{var}",{indent:6})};
      body2.springCount += 1;
      body2.springLength += r;
    }
  };
`}return Ba.exports}var Fa={exports:{}},Jg;function mP(){if(Jg)return Fa.exports;Jg=1;const n=Ls();Fa.exports=e,Fa.exports.generateIntegratorFunctionBody=t;function e(r){let i=t(r);return new Function("bodies","timeStep","adaptiveTimeStepWeight",i)}function t(r){let i=n(r);return`
  var length = bodies.length;
  if (length === 0) return 0;

  ${i("var d{var} = 0, t{var} = 0;",{indent:2})}

  for (var i = 0; i < length; ++i) {
    var body = bodies[i];
    if (body.isPinned) continue;

    if (adaptiveTimeStepWeight && body.springCount) {
      timeStep = (adaptiveTimeStepWeight * body.springLength/body.springCount);
    }

    var coeff = timeStep / body.mass;

    ${i("body.velocity.{var} += coeff * body.force.{var};",{indent:4})}
    ${i("var v{var} = body.velocity.{var};",{indent:4})}
    var v = Math.sqrt(${i("v{var} * v{var}",{join:" + "})});

    if (v > 1) {
      // We normalize it so that we move within timeStep range. 
      // for the case when v <= 1 - we let velocity to fade out.
      ${i("body.velocity.{var} = v{var} / v;",{indent:6})}
    }

    ${i("d{var} = timeStep * body.velocity.{var};",{indent:4})}

    ${i("body.pos.{var} += d{var};",{indent:4})}

    ${i("t{var} += Math.abs(d{var});",{indent:4})}
  }

  return (${i("t{var} * t{var}",{join:" + "})})/length;
`}return Fa.exports}var mu,em;function xP(){if(em)return mu;em=1,mu=n;function n(e,t,r,i){this.from=e,this.to=t,this.length=r,this.coefficient=i}return mu}var xu,tm;function yP(){if(tm)return xu;tm=1,xu=n;function n(e,t){var r;if(e||(e={}),t){for(r in t)if(t.hasOwnProperty(r)){var i=e.hasOwnProperty(r),s=typeof t[r],o=!i||typeof e[r]!==s;o?e[r]=t[r]:s==="object"&&(e[r]=n(e[r],t[r]))}}return e}return xu}var yu,nm;function v_(){if(nm)return yu;nm=1;function n(r){t(r);const i=e(r);return r.on=i.on,r.off=i.off,r.fire=i.fire,r}function e(r){let i=Object.create(null);return{on:function(s,o,a){if(typeof o!="function")throw new Error("callback is expected to be a function");let c=i[s];return c||(c=i[s]=[]),c.push({callback:o,ctx:a}),r},off:function(s,o){if(typeof s>"u")return i=Object.create(null),r;if(i[s])if(typeof o!="function")delete i[s];else{const a=i[s];for(let c=0;c<a.length;++c)a[c].callback===o&&a.splice(c,1)}return r},fire:function(s){const o=i[s];if(!o)return r;let a;arguments.length>1&&(a=Array.prototype.slice.call(arguments,1));for(let c=0;c<o.length;++c){const l=o[c];l.callback.apply(l.ctx,a)}return r}}}function t(r){if(!r)throw new Error("Eventify cannot use falsy object as events subject");const i=["on","fire","off"];for(let s=0;s<i.length;++s)if(r.hasOwnProperty(i[s]))throw new Error("Subject cannot be eventified, since it already has property '"+i[s]+"'")}return yu=n,yu}var Js={exports:{}},rm;function bP(){if(rm)return Js.exports;rm=1,Js.exports=n,Js.exports.random=n,Js.exports.randomIterator=a;function n(c){var l=typeof c=="number"?c:+new Date;return new e(l)}function e(c){this.seed=c}e.prototype.next=o,e.prototype.nextDouble=s,e.prototype.uniform=s,e.prototype.gaussian=t,e.prototype.random=s;function t(){var c,l,u;do l=this.nextDouble()*2-1,u=this.nextDouble()*2-1,c=l*l+u*u;while(c>=1||c===0);return l*Math.sqrt(-2*Math.log(c)/c)}e.prototype.levy=r;function r(){var c=1.5,l=Math.pow(i(1+c)*Math.sin(Math.PI*c/2)/(i((1+c)/2)*c*Math.pow(2,(c-1)/2)),1/c);return this.gaussian()*l/Math.pow(Math.abs(this.gaussian()),1/c)}function i(c){return Math.sqrt(2*Math.PI/c)*Math.pow(1/Math.E*(c+1/(12*c-1/(10*c))),c)}function s(){var c=this.seed;return c=c+2127912214+(c<<12)&4294967295,c=(c^3345072700^c>>>19)&4294967295,c=c+374761393+(c<<5)&4294967295,c=(c+3550635116^c<<9)&4294967295,c=c+4251993797+(c<<3)&4294967295,c=(c^3042594569^c>>>16)&4294967295,this.seed=c,(c&268435455)/268435456}function o(c){return Math.floor(this.nextDouble()*c)}function a(c,l){var u=l||n();if(typeof u.next!="function")throw new Error("customRandom does not match expected API: next() function is missing");return{forEach:h,shuffle:d};function d(){var f,p,g;for(f=c.length-1;f>0;--f)p=u.next(f+1),g=c[p],c[p]=c[f],c[f]=g;return c}function h(f){var p,g,x;for(p=c.length-1;p>0;--p)g=u.next(p+1),x=c[g],c[g]=c[p],c[p]=x,f(x);c.length&&f(c[0])}}return Js.exports}var bu,im;function sm(){if(im)return bu;im=1,bu=a;var n=dP(),e=hP(),t=fP(),r=pP(),i=gP(),s=mP(),o={};function a(u){var d=xP(),h=yP(),f=v_();if(u){if(u.springCoeff!==void 0)throw new Error("springCoeff was renamed to springCoefficient");if(u.dragCoeff!==void 0)throw new Error("dragCoeff was renamed to dragCoefficient")}u=h(u,{springLength:10,springCoefficient:.8,gravity:-12,theta:.8,dragCoefficient:.9,timeStep:.5,adaptiveTimeStepWeight:0,dimensions:2,debug:!1});var p=o[u.dimensions];if(!p){var g=u.dimensions;p={Body:n(g,u.debug),createQuadTree:e(g),createBounds:t(g),createDragForce:r(g),createSpringForce:i(g),integrate:s(g)},o[g]=p}var x=p.Body,m=p.createQuadTree,y=p.createBounds,_=p.createDragForce,v=p.createSpringForce,T=p.integrate,w=O=>new x(O),N=bP().random(42),E=[],A=[],B=m(u,N),R=y(E,u,N),L=v(u,N),F=_(u),S=0,U=[],k=new Map,P=0;W("nbody",Z),W("spring",ee);var $={bodies:E,quadTree:B,springs:A,settings:u,addForce:W,removeForce:G,getForces:z,step:function(){for(var O=0;O<U.length;++O)U[O](P);var Y=T(E,u.timeStep,u.adaptiveTimeStepWeight);return P+=1,Y},addBody:function(O){if(!O)throw new Error("Body is required");return E.push(O),O},addBodyAt:function(O){if(!O)throw new Error("Body position is required");var Y=w(O);return E.push(Y),Y},removeBody:function(O){if(O){var Y=E.indexOf(O);if(!(Y<0))return E.splice(Y,1),E.length===0&&R.reset(),!0}},addSpring:function(O,Y,te,ae){if(!O||!Y)throw new Error("Cannot add null spring to force simulator");typeof te!="number"&&(te=-1);var me=new d(O,Y,te,ae>=0?ae:-1);return A.push(me),me},getTotalMovement:function(){return S},removeSpring:function(O){if(O){var Y=A.indexOf(O);if(Y>-1)return A.splice(Y,1),!0}},getBestNewBodyPosition:function(O){return R.getBestNewPosition(O)},getBBox:M,getBoundingBox:M,invalidateBBox:function(){console.warn("invalidateBBox() is deprecated, bounds always recomputed on `getBBox()` call")},gravity:function(O){return O!==void 0?(u.gravity=O,B.options({gravity:O}),this):u.gravity},theta:function(O){return O!==void 0?(u.theta=O,B.options({theta:O}),this):u.theta},random:N};return c(u,$),f($),$;function M(){return R.update(),R.box}function W(O,Y){if(k.has(O))throw new Error("Force "+O+" is already added");k.set(O,Y),U.push(Y)}function G(O){var Y=U.indexOf(k.get(O));Y<0||(U.splice(Y,1),k.delete(O))}function z(){return k}function Z(){if(E.length!==0){B.insertBodies(E);for(var O=E.length;O--;){var Y=E[O];Y.isPinned||(Y.reset(),B.updateBodyForce(Y),F.update(Y))}}}function ee(){for(var O=A.length;O--;)L.update(A[O])}}function c(u,d){for(var h in u)l(u,d,h)}function l(u,d,h){if(u.hasOwnProperty(h)&&typeof d[h]!="function"){var f=Number.isFinite(u[h]);f?d[h]=function(p){if(p!==void 0){if(!Number.isFinite(p))throw new Error("Value of "+h+" should be a valid number.");return u[h]=p,d}return u[h]}:d[h]=function(p){return p!==void 0?(u[h]=p,d):u[h]}}}return bu}var om;function _P(){if(om)return Ma.exports;om=1,Ma.exports=e,Ma.exports.simulator=sm();var n=v_();function e(r,i){if(!r)throw new Error("Graph structure cannot be undefined");var s=i&&i.createSimulator||sm(),o=s(i);if(Array.isArray(i))throw new Error("Physics settings is expected to be an object");var a=r.version>19?k:U;i&&typeof i.nodeMass=="function"&&(a=i.nodeMass);var c=new Map,l={},u=0,d=o.settings.springTransform||t;w(),_();var h=!1,f={step:function(){if(u===0)return p(!0),!0;var P=o.step();f.lastMove=P,f.fire("step");var $=P/u,M=$<=.01;return p(M),M},getNodePosition:function(P){return S(P).pos},setNodePosition:function(P){var $=S(P);$.setPosition.apply($,Array.prototype.slice.call(arguments,1))},getLinkPosition:function(P){var $=l[P];if($)return{from:$.from.pos,to:$.to.pos}},getGraphRect:function(){return o.getBBox()},forEachBody:g,pinNode:function(P,$){var M=S(P.id);M.isPinned=!!$},isNodePinned:function(P){return S(P.id).isPinned},dispose:function(){r.off("changed",T),f.fire("disposed")},getBody:y,getSpring:m,getForceVectorLength:x,simulator:o,graph:r,lastMove:0};return n(f),f;function p(P){h!==P&&(h=P,v(P))}function g(P){c.forEach(P)}function x(){var P=0,$=0;return g(function(M){P+=Math.abs(M.force.x),$+=Math.abs(M.force.y)}),Math.sqrt(P*P+$*$)}function m(P,$){var M;if($===void 0)typeof P!="object"?M=P:M=P.id;else{var W=r.hasLink(P,$);if(!W)return;M=W.id}return l[M]}function y(P){return c.get(P)}function _(){r.on("changed",T)}function v(P){f.fire("stable",P)}function T(P){for(var $=0;$<P.length;++$){var M=P[$];M.changeType==="add"?(M.node&&N(M.node.id),M.link&&A(M.link)):M.changeType==="remove"&&(M.node&&E(M.node),M.link&&B(M.link))}u=r.getNodesCount()}function w(){u=0,r.forEachNode(function(P){N(P.id),u+=1}),r.forEachLink(A)}function N(P){var $=c.get(P);if(!$){var M=r.getNode(P);if(!M)throw new Error("initBody() was called with unknown node id");var W=M.position;if(!W){var G=R(M);W=o.getBestNewBodyPosition(G)}$=o.addBodyAt(W),$.id=P,c.set(P,$),L(P),F(M)&&($.isPinned=!0)}}function E(P){var $=P.id,M=c.get($);M&&(c.delete($),o.removeBody(M))}function A(P){L(P.fromId),L(P.toId);var $=c.get(P.fromId),M=c.get(P.toId),W=o.addSpring($,M,P.length);d(P,W),l[P.id]=W}function B(P){var $=l[P.id];if($){var M=r.getNode(P.fromId),W=r.getNode(P.toId);M&&L(M.id),W&&L(W.id),delete l[P.id],o.removeSpring($)}}function R(P){var $=[];if(!P.links)return $;for(var M=Math.min(P.links.length,2),W=0;W<M;++W){var G=P.links[W],z=G.fromId!==P.id?c.get(G.fromId):c.get(G.toId);z&&z.pos&&$.push(z)}return $}function L(P){var $=c.get(P);if($.mass=a(P),Number.isNaN($.mass))throw new Error("Node mass should be a number")}function F(P){return P&&(P.isPinned||P.data&&P.data.isPinned)}function S(P){var $=c.get(P);return $||(N(P),$=c.get(P)),$}function U(P){var $=r.getLinks(P);return $?1+$.length/3:1}function k(P){var $=r.getLinks(P);return $?1+$.size/3:1}}function t(){}return Ma.exports}var vP=_P();const TP=$x(vP);function gh(n){var e=typeof n;return n!=null&&(e=="object"||e=="function")}var wP=typeof global=="object"&&global&&global.Object===Object&&global,SP=typeof self=="object"&&self&&self.Object===Object&&self,T_=wP||SP||Function("return this")(),_u=function(){return T_.Date.now()},NP=/\s/;function EP(n){for(var e=n.length;e--&&NP.test(n.charAt(e)););return e}var AP=/^\s+/;function RP(n){return n&&n.slice(0,EP(n)+1).replace(AP,"")}var Qc=T_.Symbol,w_=Object.prototype,CP=w_.hasOwnProperty,MP=w_.toString,eo=Qc?Qc.toStringTag:void 0;function PP(n){var e=CP.call(n,eo),t=n[eo];try{n[eo]=void 0;var r=!0}catch{}var i=MP.call(n);return r&&(e?n[eo]=t:delete n[eo]),i}var DP=Object.prototype,BP=DP.toString;function FP(n){return BP.call(n)}var kP="[object Null]",IP="[object Undefined]",am=Qc?Qc.toStringTag:void 0;function LP(n){return n==null?n===void 0?IP:kP:am&&am in Object(n)?PP(n):FP(n)}function OP(n){return n!=null&&typeof n=="object"}var UP="[object Symbol]";function GP(n){return typeof n=="symbol"||OP(n)&&LP(n)==UP}var cm=NaN,$P=/^[-+]0x[0-9a-f]+$/i,VP=/^0b[01]+$/i,zP=/^0o[0-7]+$/i,jP=parseInt;function lm(n){if(typeof n=="number")return n;if(GP(n))return cm;if(gh(n)){var e=typeof n.valueOf=="function"?n.valueOf():n;n=gh(e)?e+"":e}if(typeof n!="string")return n===0?n:+n;n=RP(n);var t=VP.test(n);return t||zP.test(n)?jP(n.slice(2),t?2:8):$P.test(n)?cm:+n}var HP="Expected a function",WP=Math.max,qP=Math.min;function XP(n,e,t){var r,i,s,o,a,c,l=0,u=!1,d=!1,h=!0;if(typeof n!="function")throw new TypeError(HP);e=lm(e)||0,gh(t)&&(u=!!t.leading,d="maxWait"in t,s=d?WP(lm(t.maxWait)||0,e):s,h="trailing"in t?!!t.trailing:h);function f(w){var N=r,E=i;return r=i=void 0,l=w,o=n.apply(E,N),o}function p(w){return l=w,a=setTimeout(m,e),u?f(w):o}function g(w){var N=w-c,E=w-l,A=e-N;return d?qP(A,s-E):A}function x(w){var N=w-c,E=w-l;return c===void 0||N>=e||N<0||d&&E>=s}function m(){var w=_u();if(x(w))return y(w);a=setTimeout(m,g(w))}function y(w){return a=void 0,h&&r?f(w):(r=i=void 0,o)}function _(){a!==void 0&&clearTimeout(a),l=0,r=c=i=a=void 0}function v(){return a===void 0?o:y(_u())}function T(){var w=_u(),N=x(w);if(r=arguments,i=this,c=w,N){if(a===void 0)return p(c);if(d)return clearTimeout(a),a=setTimeout(m,e),f(c)}return a===void 0&&(a=setTimeout(m,e)),o}return T.cancel=_,T.flush=v,T}function um(n,e){(e==null||e>n.length)&&(e=n.length);for(var t=0,r=Array(e);t<e;t++)r[t]=n[t];return r}function YP(n){if(Array.isArray(n))return n}function KP(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}function QP(n,e,t){return Object.defineProperty(n,"prototype",{writable:!1}),n}function ZP(n,e){var t=n==null?null:typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(t!=null){var r,i,s,o,a=[],c=!0,l=!1;try{if(s=(t=t.call(n)).next,e!==0)for(;!(c=(r=s.call(t)).done)&&(a.push(r.value),a.length!==e);c=!0);}catch(u){l=!0,i=u}finally{try{if(!c&&t.return!=null&&(o=t.return(),Object(o)!==o))return}finally{if(l)throw i}}return a}}function JP(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function eD(n,e){return YP(n)||ZP(n,e)||tD(n,e)||JP()}function tD(n,e){if(n){if(typeof n=="string")return um(n,e);var t={}.toString.call(n).slice(8,-1);return t==="Object"&&n.constructor&&(t=n.constructor.name),t==="Map"||t==="Set"?Array.from(n):t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?um(n,e):void 0}}var nD=QP(function n(e,t){var r=t.default,i=r===void 0?null:r,s=t.triggerUpdate,o=s===void 0?!0:s,a=t.onChange,c=a===void 0?function(l,u){}:a;KP(this,n),this.name=e,this.defaultVal=i,this.triggerUpdate=o,this.onChange=c});function Cl(n){var e=n.stateInit,t=e===void 0?function(){return{}}:e,r=n.props,i=r===void 0?{}:r,s=n.methods,o=s===void 0?{}:s,a=n.aliases,c=a===void 0?{}:a,l=n.init,u=l===void 0?function(){}:l,d=n.update,h=d===void 0?function(){}:d,f=Object.keys(i).map(function(p){return new nD(p,i[p])});return function p(){for(var g=arguments.length,x=new Array(g),m=0;m<g;m++)x[m]=arguments[m];var y=!!(this instanceof p&&this.constructor),_=y?x.shift():void 0,v=x[0],T=v===void 0?{}:v,w=Object.assign({},t instanceof Function?t(T):t,{initialised:!1}),N={};function E(R){return A(R,T),B(),E}var A=function(L,F){u.call(E,L,w,F),w.initialised=!0},B=XP(function(){w.initialised&&(h.call(E,w,N),N={})},1);return f.forEach(function(R){E[R.name]=L(R);function L(F){var S=F.name,U=F.triggerUpdate,k=U===void 0?!1:U,P=F.onChange,$=P===void 0?function(G,z){}:P,M=F.defaultVal,W=M===void 0?null:M;return function(G){var z=w[S];if(!arguments.length)return z;var Z=G===void 0?W:G;return w[S]=Z,$.call(E,Z,w,z),!N.hasOwnProperty(S)&&(N[S]=z),k&&B(),E}}}),Object.keys(o).forEach(function(R){E[R]=function(){for(var L,F=arguments.length,S=new Array(F),U=0;U<F;U++)S[U]=arguments[U];return(L=o[R]).call.apply(L,[E,w].concat(S))}}),Object.entries(c).forEach(function(R){var L=eD(R,2),F=L[0],S=L[1];return E[F]=E[S]}),E.resetProps=function(){return f.forEach(function(R){E[R.name](R.defaultVal)}),E},E.resetProps(),w._rerender=B,y&&_&&E(_),E}}var Ee=(function(n){return typeof n=="function"?n:typeof n=="string"?function(e){return e[n]}:function(e){return n}});function wc(n,e){return n==null||e==null?NaN:n<e?-1:n>e?1:n>=e?0:NaN}function S_(n,e){return n==null||e==null?NaN:e<n?-1:e>n?1:e>=n?0:NaN}function N_(n){let e,t,r;n.length!==2?(e=wc,t=(a,c)=>wc(n(a),c),r=(a,c)=>n(a)-c):(e=n===wc||n===S_?n:rD,t=n,r=n);function i(a,c,l=0,u=a.length){if(l<u){if(e(c,c)!==0)return u;do{const d=l+u>>>1;t(a[d],c)<0?l=d+1:u=d}while(l<u)}return l}function s(a,c,l=0,u=a.length){if(l<u){if(e(c,c)!==0)return u;do{const d=l+u>>>1;t(a[d],c)<=0?l=d+1:u=d}while(l<u)}return l}function o(a,c,l=0,u=a.length){const d=i(a,c,l,u-1);return d>l&&r(a[d-1],c)>-r(a[d],c)?d-1:d}return{left:i,center:o,right:s}}function rD(){return 0}function iD(n){return n===null?NaN:+n}const sD=N_(wc),oD=sD.right;N_(iD).center;function dm(n,e){let t,r;if(e===void 0)for(const i of n)i!=null&&(t===void 0?i>=i&&(t=r=i):(t>i&&(t=i),r<i&&(r=i)));else{let i=-1;for(let s of n)(s=e(s,++i,n))!=null&&(t===void 0?s>=s&&(t=r=s):(t>s&&(t=s),r<s&&(r=s)))}return[t,r]}class hm extends Map{constructor(e,t=lD){if(super(),Object.defineProperties(this,{_intern:{value:new Map},_key:{value:t}}),e!=null)for(const[r,i]of e)this.set(r,i)}get(e){return super.get(fm(this,e))}has(e){return super.has(fm(this,e))}set(e,t){return super.set(aD(this,e),t)}delete(e){return super.delete(cD(this,e))}}function fm({_intern:n,_key:e},t){const r=e(t);return n.has(r)?n.get(r):t}function aD({_intern:n,_key:e},t){const r=e(t);return n.has(r)?n.get(r):(n.set(r,t),t)}function cD({_intern:n,_key:e},t){const r=e(t);return n.has(r)&&(t=n.get(r),n.delete(r)),t}function lD(n){return n!==null&&typeof n=="object"?n.valueOf():n}const uD=Math.sqrt(50),dD=Math.sqrt(10),hD=Math.sqrt(2);function Zc(n,e,t){const r=(e-n)/Math.max(0,t),i=Math.floor(Math.log10(r)),s=r/Math.pow(10,i),o=s>=uD?10:s>=dD?5:s>=hD?2:1;let a,c,l;return i<0?(l=Math.pow(10,-i)/o,a=Math.round(n*l),c=Math.round(e*l),a/l<n&&++a,c/l>e&&--c,l=-l):(l=Math.pow(10,i)*o,a=Math.round(n/l),c=Math.round(e/l),a*l<n&&++a,c*l>e&&--c),c<a&&.5<=t&&t<2?Zc(n,e,t*2):[a,c,l]}function fD(n,e,t){if(e=+e,n=+n,t=+t,!(t>0))return[];if(n===e)return[n];const r=e<n,[i,s,o]=r?Zc(e,n,t):Zc(n,e,t);if(!(s>=i))return[];const a=s-i+1,c=new Array(a);if(r)if(o<0)for(let l=0;l<a;++l)c[l]=(s-l)/-o;else for(let l=0;l<a;++l)c[l]=(s-l)*o;else if(o<0)for(let l=0;l<a;++l)c[l]=(i+l)/-o;else for(let l=0;l<a;++l)c[l]=(i+l)*o;return c}function mh(n,e,t){return e=+e,n=+n,t=+t,Zc(n,e,t)[2]}function pD(n,e,t){e=+e,n=+n,t=+t;const r=e<n,i=r?mh(e,n,t):mh(n,e,t);return(r?-1:1)*(i<0?1/-i:i)}function gD(n,e){let t;if(e===void 0)for(const r of n)r!=null&&(t<r||t===void 0&&r>=r)&&(t=r);else{let r=-1;for(let i of n)(i=e(i,++r,n))!=null&&(t<i||t===void 0&&i>=i)&&(t=i)}return t}function mD(n,e){let t;if(e===void 0)for(const r of n)r!=null&&(t>r||t===void 0&&r>=r)&&(t=r);else{let r=-1;for(let i of n)(i=e(i,++r,n))!=null&&(t>i||t===void 0&&i>=i)&&(t=i)}return t}function xD(n,e,t){n=+n,e=+e,t=(i=arguments.length)<2?(e=n,n=0,1):i<3?1:+t;for(var r=-1,i=Math.max(0,Math.ceil((e-n)/t))|0,s=new Array(i);++r<i;)s[r]=n+r*t;return s}function xh(n,e){(e==null||e>n.length)&&(e=n.length);for(var t=0,r=Array(e);t<e;t++)r[t]=n[t];return r}function yD(n){if(Array.isArray(n))return n}function bD(n){if(Array.isArray(n))return xh(n)}function E_(n,e,t){if(typeof n=="function"?n===e:n.has(e))return arguments.length<3?e:t;throw new TypeError("Private element is not present on this object")}function _D(n,e){if(e.has(n))throw new TypeError("Cannot initialize the same private elements twice on an object")}function vD(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}function Nt(n,e){return n.get(E_(n,e))}function Hi(n,e,t){_D(n,e),e.set(n,t)}function ka(n,e,t){return n.set(E_(n,e),t),t}function TD(n,e){for(var t=0;t<e.length;t++){var r=e[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,PD(r.key),r)}}function wD(n,e,t){return e&&TD(n.prototype,e),Object.defineProperty(n,"prototype",{writable:!1}),n}function SD(n){if(typeof Symbol<"u"&&n[Symbol.iterator]!=null||n["@@iterator"]!=null)return Array.from(n)}function ND(n,e){var t=n==null?null:typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(t!=null){var r,i,s,o,a=[],c=!0,l=!1;try{if(s=(t=t.call(n)).next,e!==0)for(;!(c=(r=s.call(t)).done)&&(a.push(r.value),a.length!==e);c=!0);}catch(u){l=!0,i=u}finally{try{if(!c&&t.return!=null&&(o=t.return(),Object(o)!==o))return}finally{if(l)throw i}}return a}}function ED(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function AD(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function RD(n,e){return yD(n)||ND(n,e)||A_(n,e)||ED()}function CD(n){return bD(n)||SD(n)||A_(n)||AD()}function MD(n,e){if(typeof n!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var r=t.call(n,e);if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(n)}function PD(n){var e=MD(n,"string");return typeof e=="symbol"?e:e+""}function A_(n,e){if(n){if(typeof n=="string")return xh(n,e);var t={}.toString.call(n).slice(8,-1);return t==="Object"&&n.constructor&&(t=n.constructor.name),t==="Map"||t==="Set"?Array.from(n):t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?xh(n,e):void 0}}var Wi=new WeakMap,to=new WeakMap,qi=new WeakMap,vu=new WeakMap,Tu=new WeakMap,wu=new WeakMap,DD=(function(){function n(){vD(this,n),Hi(this,Wi,new Map),Hi(this,to,new Map),Hi(this,qi,function(e){return e}),Hi(this,vu,function(){return{}}),Hi(this,Tu,function(){}),Hi(this,wu,function(){})}return wD(n,[{key:"getObj",value:function(t){return Nt(Wi,this).get(Nt(qi,this).call(this,t))}},{key:"getData",value:function(t){return Nt(to,this).get(t)}},{key:"entries",value:function(){return CD(Nt(to,this).entries()).map(function(t){var r=RD(t,2),i=r[0],s=r[1];return[s,i]})}},{key:"id",value:function(t){return ka(qi,this,Ee(t)),this}},{key:"onCreateObj",value:function(t){return ka(vu,this,t),this}},{key:"onUpdateObj",value:function(t){return ka(Tu,this,t),this}},{key:"onRemoveObj",value:function(t){return ka(wu,this,t),this}},{key:"digest",value:function(t){var r=this;t.filter(function(s){return!Nt(Wi,r).has(Nt(qi,r).call(r,s))}).forEach(function(s){var o=Nt(vu,r).call(r,s);Nt(Wi,r).set(Nt(qi,r).call(r,s),o),Nt(to,r).set(o,s)});var i=new Map(t.map(function(s){return[Nt(qi,r).call(r,s),s]}));return Nt(Wi,this).forEach(function(s,o){i.has(o)?Nt(Tu,r).call(r,s,i.get(o)):(Nt(wu,r).call(r,s,o),Nt(Wi,r).delete(o),Nt(to,r).delete(s))}),this}},{key:"clear",value:function(){return this.digest([]),this}}])})();function Gf(n,e){switch(arguments.length){case 0:break;case 1:this.range(n);break;default:this.range(e).domain(n);break}return this}function BD(n,e){switch(arguments.length){case 0:break;case 1:{typeof n=="function"?this.interpolator(n):this.range(n);break}default:{this.domain(n),typeof e=="function"?this.interpolator(e):this.range(e);break}}return this}const pm=Symbol("implicit");function da(){var n=new hm,e=[],t=[],r=pm;function i(s){let o=n.get(s);if(o===void 0){if(r!==pm)return r;n.set(s,o=e.push(s)-1)}return t[o%t.length]}return i.domain=function(s){if(!arguments.length)return e.slice();e=[],n=new hm;for(const o of s)n.has(o)||n.set(o,e.push(o)-1);return i},i.range=function(s){return arguments.length?(t=Array.from(s),i):t.slice()},i.unknown=function(s){return arguments.length?(r=s,i):r},i.copy=function(){return da(e,t).unknown(r)},Gf.apply(i,arguments),i}function R_(){var n=da().unknown(void 0),e=n.domain,t=n.range,r=0,i=1,s,o,a=!1,c=0,l=0,u=.5;delete n.unknown;function d(){var h=e().length,f=i<r,p=f?i:r,g=f?r:i;s=(g-p)/Math.max(1,h-c+l*2),a&&(s=Math.floor(s)),p+=(g-p-s*(h-c))*u,o=s*(1-c),a&&(p=Math.round(p),o=Math.round(o));var x=xD(h).map(function(m){return p+s*m});return t(f?x.reverse():x)}return n.domain=function(h){return arguments.length?(e(h),d()):e()},n.range=function(h){return arguments.length?([r,i]=h,r=+r,i=+i,d()):[r,i]},n.rangeRound=function(h){return[r,i]=h,r=+r,i=+i,a=!0,d()},n.bandwidth=function(){return o},n.step=function(){return s},n.round=function(h){return arguments.length?(a=!!h,d()):a},n.padding=function(h){return arguments.length?(c=Math.min(1,l=+h),d()):c},n.paddingInner=function(h){return arguments.length?(c=Math.min(1,h),d()):c},n.paddingOuter=function(h){return arguments.length?(l=+h,d()):l},n.align=function(h){return arguments.length?(u=Math.max(0,Math.min(1,h)),d()):u},n.copy=function(){return R_(e(),[r,i]).round(a).paddingInner(c).paddingOuter(l).align(u)},Gf.apply(d(),arguments)}function C_(n){var e=n.copy;return n.padding=n.paddingOuter,delete n.paddingInner,delete n.paddingOuter,n.copy=function(){return C_(e())},n}function FD(){return C_(R_.apply(null,arguments).paddingInner(1))}function kD(n){return function(){return n}}function ID(n){return+n}var gm=[0,1];function kr(n){return n}function yh(n,e){return(e-=n=+n)?function(t){return(t-n)/e}:kD(isNaN(e)?NaN:.5)}function LD(n,e){var t;return n>e&&(t=n,n=e,e=t),function(r){return Math.max(n,Math.min(e,r))}}function OD(n,e,t){var r=n[0],i=n[1],s=e[0],o=e[1];return i<r?(r=yh(i,r),s=t(o,s)):(r=yh(r,i),s=t(s,o)),function(a){return s(r(a))}}function UD(n,e,t){var r=Math.min(n.length,e.length)-1,i=new Array(r),s=new Array(r),o=-1;for(n[r]<n[0]&&(n=n.slice().reverse(),e=e.slice().reverse());++o<r;)i[o]=yh(n[o],n[o+1]),s[o]=t(e[o],e[o+1]);return function(a){var c=oD(n,a,1,r)-1;return s[c](i[c](a))}}function GD(n,e){return e.domain(n.domain()).range(n.range()).interpolate(n.interpolate()).clamp(n.clamp()).unknown(n.unknown())}function $D(){var n=gm,e=gm,t=Sl,r,i,s,o=kr,a,c,l;function u(){var h=Math.min(n.length,e.length);return o!==kr&&(o=LD(n[0],n[h-1])),a=h>2?UD:OD,c=l=null,d}function d(h){return h==null||isNaN(h=+h)?s:(c||(c=a(n.map(r),e,t)))(r(o(h)))}return d.invert=function(h){return o(i((l||(l=a(e,n.map(r),mn)))(h)))},d.domain=function(h){return arguments.length?(n=Array.from(h,ID),u()):n.slice()},d.range=function(h){return arguments.length?(e=Array.from(h),u()):e.slice()},d.rangeRound=function(h){return e=Array.from(h),t=rb,u()},d.clamp=function(h){return arguments.length?(o=h?!0:kr,u()):o!==kr},d.interpolate=function(h){return arguments.length?(t=h,u()):t},d.unknown=function(h){return arguments.length?(s=h,d):s},function(h,f){return r=h,i=f,u()}}function VD(){return $D()(kr,kr)}function zD(n){return Math.abs(n=Math.round(n))>=1e21?n.toLocaleString("en").replace(/,/g,""):n.toString(10)}function Jc(n,e){if((t=(n=e?n.toExponential(e-1):n.toExponential()).indexOf("e"))<0)return null;var t,r=n.slice(0,t);return[r.length>1?r[0]+r.slice(2):r,+n.slice(t+1)]}function Es(n){return n=Jc(Math.abs(n)),n?n[1]:NaN}function jD(n,e){return function(t,r){for(var i=t.length,s=[],o=0,a=n[0],c=0;i>0&&a>0&&(c+a+1>r&&(a=Math.max(1,r-c)),s.push(t.substring(i-=a,i+a)),!((c+=a+1)>r));)a=n[o=(o+1)%n.length];return s.reverse().join(e)}}function HD(n){return function(e){return e.replace(/[0-9]/g,function(t){return n[+t]})}}var WD=/^(?:(.)?([<>=^]))?([+\-( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?(~)?([a-z%])?$/i;function el(n){if(!(e=WD.exec(n)))throw new Error("invalid format: "+n);var e;return new $f({fill:e[1],align:e[2],sign:e[3],symbol:e[4],zero:e[5],width:e[6],comma:e[7],precision:e[8]&&e[8].slice(1),trim:e[9],type:e[10]})}el.prototype=$f.prototype;function $f(n){this.fill=n.fill===void 0?" ":n.fill+"",this.align=n.align===void 0?">":n.align+"",this.sign=n.sign===void 0?"-":n.sign+"",this.symbol=n.symbol===void 0?"":n.symbol+"",this.zero=!!n.zero,this.width=n.width===void 0?void 0:+n.width,this.comma=!!n.comma,this.precision=n.precision===void 0?void 0:+n.precision,this.trim=!!n.trim,this.type=n.type===void 0?"":n.type+""}$f.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?"0":"")+(this.width===void 0?"":Math.max(1,this.width|0))+(this.comma?",":"")+(this.precision===void 0?"":"."+Math.max(0,this.precision|0))+(this.trim?"~":"")+this.type};function qD(n){e:for(var e=n.length,t=1,r=-1,i;t<e;++t)switch(n[t]){case".":r=i=t;break;case"0":r===0&&(r=t),i=t;break;default:if(!+n[t])break e;r>0&&(r=0);break}return r>0?n.slice(0,r)+n.slice(i+1):n}var M_;function XD(n,e){var t=Jc(n,e);if(!t)return n+"";var r=t[0],i=t[1],s=i-(M_=Math.max(-8,Math.min(8,Math.floor(i/3)))*3)+1,o=r.length;return s===o?r:s>o?r+new Array(s-o+1).join("0"):s>0?r.slice(0,s)+"."+r.slice(s):"0."+new Array(1-s).join("0")+Jc(n,Math.max(0,e+s-1))[0]}function mm(n,e){var t=Jc(n,e);if(!t)return n+"";var r=t[0],i=t[1];return i<0?"0."+new Array(-i).join("0")+r:r.length>i+1?r.slice(0,i+1)+"."+r.slice(i+1):r+new Array(i-r.length+2).join("0")}const xm={"%":(n,e)=>(n*100).toFixed(e),b:n=>Math.round(n).toString(2),c:n=>n+"",d:zD,e:(n,e)=>n.toExponential(e),f:(n,e)=>n.toFixed(e),g:(n,e)=>n.toPrecision(e),o:n=>Math.round(n).toString(8),p:(n,e)=>mm(n*100,e),r:mm,s:XD,X:n=>Math.round(n).toString(16).toUpperCase(),x:n=>Math.round(n).toString(16)};function ym(n){return n}var bm=Array.prototype.map,_m=["y","z","a","f","p","n","","m","","k","M","G","T","P","E","Z","Y"];function YD(n){var e=n.grouping===void 0||n.thousands===void 0?ym:jD(bm.call(n.grouping,Number),n.thousands+""),t=n.currency===void 0?"":n.currency[0]+"",r=n.currency===void 0?"":n.currency[1]+"",i=n.decimal===void 0?".":n.decimal+"",s=n.numerals===void 0?ym:HD(bm.call(n.numerals,String)),o=n.percent===void 0?"%":n.percent+"",a=n.minus===void 0?"":n.minus+"",c=n.nan===void 0?"NaN":n.nan+"";function l(d){d=el(d);var h=d.fill,f=d.align,p=d.sign,g=d.symbol,x=d.zero,m=d.width,y=d.comma,_=d.precision,v=d.trim,T=d.type;T==="n"?(y=!0,T="g"):xm[T]||(_===void 0&&(_=12),v=!0,T="g"),(x||h==="0"&&f==="=")&&(x=!0,h="0",f="=");var w=g==="$"?t:g==="#"&&/[boxX]/.test(T)?"0"+T.toLowerCase():"",N=g==="$"?r:/[%p]/.test(T)?o:"",E=xm[T],A=/[defgprs%]/.test(T);_=_===void 0?6:/[gprs]/.test(T)?Math.max(1,Math.min(21,_)):Math.max(0,Math.min(20,_));function B(R){var L=w,F=N,S,U,k;if(T==="c")F=E(R)+F,R="";else{R=+R;var P=R<0||1/R<0;if(R=isNaN(R)?c:E(Math.abs(R),_),v&&(R=qD(R)),P&&+R==0&&p!=="+"&&(P=!1),L=(P?p==="("?p:a:p==="-"||p==="("?"":p)+L,F=(T==="s"?_m[8+M_/3]:"")+F+(P&&p==="("?")":""),A){for(S=-1,U=R.length;++S<U;)if(k=R.charCodeAt(S),48>k||k>57){F=(k===46?i+R.slice(S+1):R.slice(S))+F,R=R.slice(0,S);break}}}y&&!x&&(R=e(R,1/0));var $=L.length+R.length+F.length,M=$<m?new Array(m-$+1).join(h):"";switch(y&&x&&(R=e(M+R,M.length?m-F.length:1/0),M=""),f){case"<":R=L+R+F+M;break;case"=":R=L+M+R+F;break;case"^":R=M.slice(0,$=M.length>>1)+L+R+F+M.slice($);break;default:R=M+L+R+F;break}return s(R)}return B.toString=function(){return d+""},B}function u(d,h){var f=l((d=el(d),d.type="f",d)),p=Math.max(-8,Math.min(8,Math.floor(Es(h)/3)))*3,g=Math.pow(10,-p),x=_m[8+p/3];return function(m){return f(g*m)+x}}return{format:l,formatPrefix:u}}var Ia,P_,D_;KD({thousands:",",grouping:[3],currency:["$",""]});function KD(n){return Ia=YD(n),P_=Ia.format,D_=Ia.formatPrefix,Ia}function QD(n){return Math.max(0,-Es(Math.abs(n)))}function ZD(n,e){return Math.max(0,Math.max(-8,Math.min(8,Math.floor(Es(e)/3)))*3-Es(Math.abs(n)))}function JD(n,e){return n=Math.abs(n),e=Math.abs(e)-n,Math.max(0,Es(e)-Es(n))+1}function eB(n,e,t,r){var i=pD(n,e,t),s;switch(r=el(r??",f"),r.type){case"s":{var o=Math.max(Math.abs(n),Math.abs(e));return r.precision==null&&!isNaN(s=ZD(i,o))&&(r.precision=s),D_(r,o)}case"":case"e":case"g":case"p":case"r":{r.precision==null&&!isNaN(s=JD(i,Math.max(Math.abs(n),Math.abs(e))))&&(r.precision=s-(r.type==="e"));break}case"f":case"%":{r.precision==null&&!isNaN(s=QD(i))&&(r.precision=s-(r.type==="%")*2);break}}return P_(r)}function B_(n){var e=n.domain;return n.ticks=function(t){var r=e();return fD(r[0],r[r.length-1],t??10)},n.tickFormat=function(t,r){var i=e();return eB(i[0],i[i.length-1],t??10,r)},n.nice=function(t){t==null&&(t=10);var r=e(),i=0,s=r.length-1,o=r[i],a=r[s],c,l,u=10;for(a<o&&(l=o,o=a,a=l,l=i,i=s,s=l);u-- >0;){if(l=mh(o,a,t),l===c)return r[i]=o,r[s]=a,e(r);if(l>0)o=Math.floor(o/l)*l,a=Math.ceil(a/l)*l;else if(l<0)o=Math.ceil(o*l)/l,a=Math.floor(a*l)/l;else break;c=l}return n},n}function F_(){var n=VD();return n.copy=function(){return GD(n,F_())},Gf.apply(n,arguments),B_(n)}function tB(){var n=0,e=1,t,r,i,s,o=kr,a=!1,c;function l(d){return d==null||isNaN(d=+d)?c:o(i===0?.5:(d=(s(d)-t)*i,a?Math.max(0,Math.min(1,d)):d))}l.domain=function(d){return arguments.length?([n,e]=d,t=s(n=+n),r=s(e=+e),i=t===r?0:1/(r-t),l):[n,e]},l.clamp=function(d){return arguments.length?(a=!!d,l):a},l.interpolator=function(d){return arguments.length?(o=d,l):o};function u(d){return function(h){var f,p;return arguments.length?([f,p]=h,o=d(f,p),l):[o(0),o(1)]}}return l.range=u(Sl),l.rangeRound=u(rb),l.unknown=function(d){return arguments.length?(c=d,l):c},function(d){return s=d,t=d(n),r=d(e),i=t===r?0:1/(r-t),l}}function nB(n,e){return e.domain(n.domain()).interpolator(n.interpolator()).clamp(n.clamp()).unknown(n.unknown())}function k_(){var n=B_(tB()(kr));return n.copy=function(){return nB(n,k_())},BD.apply(n,arguments)}function I_(n){for(var e=n.length/6|0,t=new Array(e),r=0;r<e;)t[r]="#"+n.slice(r*6,++r*6);return t}const L_=I_("1f77b4ff7f0e2ca02cd627289467bd8c564be377c27f7f7fbcbd2217becf"),rB=I_("a6cee31f78b4b2df8a33a02cfb9a99e31a1cfdbf6fff7f00cab2d66a3d9affff99b15928");function tl(n){"@babel/helpers - typeof";return tl=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},tl(n)}var iB=/^\s+/,sB=/\s+$/;function de(n,e){if(n=n||"",e=e||{},n instanceof de)return n;if(!(this instanceof de))return new de(n,e);var t=oB(n);this._originalInput=n,this._r=t.r,this._g=t.g,this._b=t.b,this._a=t.a,this._roundA=Math.round(100*this._a)/100,this._format=e.format||t.format,this._gradientType=e.gradientType,this._r<1&&(this._r=Math.round(this._r)),this._g<1&&(this._g=Math.round(this._g)),this._b<1&&(this._b=Math.round(this._b)),this._ok=t.ok}de.prototype={isDark:function(){return this.getBrightness()<128},isLight:function(){return!this.isDark()},isValid:function(){return this._ok},getOriginalInput:function(){return this._originalInput},getFormat:function(){return this._format},getAlpha:function(){return this._a},getBrightness:function(){var e=this.toRgb();return(e.r*299+e.g*587+e.b*114)/1e3},getLuminance:function(){var e=this.toRgb(),t,r,i,s,o,a;return t=e.r/255,r=e.g/255,i=e.b/255,t<=.03928?s=t/12.92:s=Math.pow((t+.055)/1.055,2.4),r<=.03928?o=r/12.92:o=Math.pow((r+.055)/1.055,2.4),i<=.03928?a=i/12.92:a=Math.pow((i+.055)/1.055,2.4),.2126*s+.7152*o+.0722*a},setAlpha:function(e){return this._a=O_(e),this._roundA=Math.round(100*this._a)/100,this},toHsv:function(){var e=Tm(this._r,this._g,this._b);return{h:e.h*360,s:e.s,v:e.v,a:this._a}},toHsvString:function(){var e=Tm(this._r,this._g,this._b),t=Math.round(e.h*360),r=Math.round(e.s*100),i=Math.round(e.v*100);return this._a==1?"hsv("+t+", "+r+"%, "+i+"%)":"hsva("+t+", "+r+"%, "+i+"%, "+this._roundA+")"},toHsl:function(){var e=vm(this._r,this._g,this._b);return{h:e.h*360,s:e.s,l:e.l,a:this._a}},toHslString:function(){var e=vm(this._r,this._g,this._b),t=Math.round(e.h*360),r=Math.round(e.s*100),i=Math.round(e.l*100);return this._a==1?"hsl("+t+", "+r+"%, "+i+"%)":"hsla("+t+", "+r+"%, "+i+"%, "+this._roundA+")"},toHex:function(e){return wm(this._r,this._g,this._b,e)},toHexString:function(e){return"#"+this.toHex(e)},toHex8:function(e){return uB(this._r,this._g,this._b,this._a,e)},toHex8String:function(e){return"#"+this.toHex8(e)},toRgb:function(){return{r:Math.round(this._r),g:Math.round(this._g),b:Math.round(this._b),a:this._a}},toRgbString:function(){return this._a==1?"rgb("+Math.round(this._r)+", "+Math.round(this._g)+", "+Math.round(this._b)+")":"rgba("+Math.round(this._r)+", "+Math.round(this._g)+", "+Math.round(this._b)+", "+this._roundA+")"},toPercentageRgb:function(){return{r:Math.round(Ye(this._r,255)*100)+"%",g:Math.round(Ye(this._g,255)*100)+"%",b:Math.round(Ye(this._b,255)*100)+"%",a:this._a}},toPercentageRgbString:function(){return this._a==1?"rgb("+Math.round(Ye(this._r,255)*100)+"%, "+Math.round(Ye(this._g,255)*100)+"%, "+Math.round(Ye(this._b,255)*100)+"%)":"rgba("+Math.round(Ye(this._r,255)*100)+"%, "+Math.round(Ye(this._g,255)*100)+"%, "+Math.round(Ye(this._b,255)*100)+"%, "+this._roundA+")"},toName:function(){return this._a===0?"transparent":this._a<1?!1:TB[wm(this._r,this._g,this._b,!0)]||!1},toFilter:function(e){var t="#"+Sm(this._r,this._g,this._b,this._a),r=t,i=this._gradientType?"GradientType = 1, ":"";if(e){var s=de(e);r="#"+Sm(s._r,s._g,s._b,s._a)}return"progid:DXImageTransform.Microsoft.gradient("+i+"startColorstr="+t+",endColorstr="+r+")"},toString:function(e){var t=!!e;e=e||this._format;var r=!1,i=this._a<1&&this._a>=0,s=!t&&i&&(e==="hex"||e==="hex6"||e==="hex3"||e==="hex4"||e==="hex8"||e==="name");return s?e==="name"&&this._a===0?this.toName():this.toRgbString():(e==="rgb"&&(r=this.toRgbString()),e==="prgb"&&(r=this.toPercentageRgbString()),(e==="hex"||e==="hex6")&&(r=this.toHexString()),e==="hex3"&&(r=this.toHexString(!0)),e==="hex4"&&(r=this.toHex8String(!0)),e==="hex8"&&(r=this.toHex8String()),e==="name"&&(r=this.toName()),e==="hsl"&&(r=this.toHslString()),e==="hsv"&&(r=this.toHsvString()),r||this.toHexString())},clone:function(){return de(this.toString())},_applyModification:function(e,t){var r=e.apply(null,[this].concat([].slice.call(t)));return this._r=r._r,this._g=r._g,this._b=r._b,this.setAlpha(r._a),this},lighten:function(){return this._applyModification(pB,arguments)},brighten:function(){return this._applyModification(gB,arguments)},darken:function(){return this._applyModification(mB,arguments)},desaturate:function(){return this._applyModification(dB,arguments)},saturate:function(){return this._applyModification(hB,arguments)},greyscale:function(){return this._applyModification(fB,arguments)},spin:function(){return this._applyModification(xB,arguments)},_applyCombination:function(e,t){return e.apply(null,[this].concat([].slice.call(t)))},analogous:function(){return this._applyCombination(_B,arguments)},complement:function(){return this._applyCombination(yB,arguments)},monochromatic:function(){return this._applyCombination(vB,arguments)},splitcomplement:function(){return this._applyCombination(bB,arguments)},triad:function(){return this._applyCombination(Nm,[3])},tetrad:function(){return this._applyCombination(Nm,[4])}};de.fromRatio=function(n,e){if(tl(n)=="object"){var t={};for(var r in n)n.hasOwnProperty(r)&&(r==="a"?t[r]=n[r]:t[r]=To(n[r]));n=t}return de(n,e)};function oB(n){var e={r:0,g:0,b:0},t=1,r=null,i=null,s=null,o=!1,a=!1;return typeof n=="string"&&(n=EB(n)),tl(n)=="object"&&(er(n.r)&&er(n.g)&&er(n.b)?(e=aB(n.r,n.g,n.b),o=!0,a=String(n.r).substr(-1)==="%"?"prgb":"rgb"):er(n.h)&&er(n.s)&&er(n.v)?(r=To(n.s),i=To(n.v),e=lB(n.h,r,i),o=!0,a="hsv"):er(n.h)&&er(n.s)&&er(n.l)&&(r=To(n.s),s=To(n.l),e=cB(n.h,r,s),o=!0,a="hsl"),n.hasOwnProperty("a")&&(t=n.a)),t=O_(t),{ok:o,format:n.format||a,r:Math.min(255,Math.max(e.r,0)),g:Math.min(255,Math.max(e.g,0)),b:Math.min(255,Math.max(e.b,0)),a:t}}function aB(n,e,t){return{r:Ye(n,255)*255,g:Ye(e,255)*255,b:Ye(t,255)*255}}function vm(n,e,t){n=Ye(n,255),e=Ye(e,255),t=Ye(t,255);var r=Math.max(n,e,t),i=Math.min(n,e,t),s,o,a=(r+i)/2;if(r==i)s=o=0;else{var c=r-i;switch(o=a>.5?c/(2-r-i):c/(r+i),r){case n:s=(e-t)/c+(e<t?6:0);break;case e:s=(t-n)/c+2;break;case t:s=(n-e)/c+4;break}s/=6}return{h:s,s:o,l:a}}function cB(n,e,t){var r,i,s;n=Ye(n,360),e=Ye(e,100),t=Ye(t,100);function o(l,u,d){return d<0&&(d+=1),d>1&&(d-=1),d<1/6?l+(u-l)*6*d:d<1/2?u:d<2/3?l+(u-l)*(2/3-d)*6:l}if(e===0)r=i=s=t;else{var a=t<.5?t*(1+e):t+e-t*e,c=2*t-a;r=o(c,a,n+1/3),i=o(c,a,n),s=o(c,a,n-1/3)}return{r:r*255,g:i*255,b:s*255}}function Tm(n,e,t){n=Ye(n,255),e=Ye(e,255),t=Ye(t,255);var r=Math.max(n,e,t),i=Math.min(n,e,t),s,o,a=r,c=r-i;if(o=r===0?0:c/r,r==i)s=0;else{switch(r){case n:s=(e-t)/c+(e<t?6:0);break;case e:s=(t-n)/c+2;break;case t:s=(n-e)/c+4;break}s/=6}return{h:s,s:o,v:a}}function lB(n,e,t){n=Ye(n,360)*6,e=Ye(e,100),t=Ye(t,100);var r=Math.floor(n),i=n-r,s=t*(1-e),o=t*(1-i*e),a=t*(1-(1-i)*e),c=r%6,l=[t,o,s,s,a,t][c],u=[a,t,t,o,s,s][c],d=[s,s,a,t,t,o][c];return{r:l*255,g:u*255,b:d*255}}function wm(n,e,t,r){var i=[vn(Math.round(n).toString(16)),vn(Math.round(e).toString(16)),vn(Math.round(t).toString(16))];return r&&i[0].charAt(0)==i[0].charAt(1)&&i[1].charAt(0)==i[1].charAt(1)&&i[2].charAt(0)==i[2].charAt(1)?i[0].charAt(0)+i[1].charAt(0)+i[2].charAt(0):i.join("")}function uB(n,e,t,r,i){var s=[vn(Math.round(n).toString(16)),vn(Math.round(e).toString(16)),vn(Math.round(t).toString(16)),vn(U_(r))];return i&&s[0].charAt(0)==s[0].charAt(1)&&s[1].charAt(0)==s[1].charAt(1)&&s[2].charAt(0)==s[2].charAt(1)&&s[3].charAt(0)==s[3].charAt(1)?s[0].charAt(0)+s[1].charAt(0)+s[2].charAt(0)+s[3].charAt(0):s.join("")}function Sm(n,e,t,r){var i=[vn(U_(r)),vn(Math.round(n).toString(16)),vn(Math.round(e).toString(16)),vn(Math.round(t).toString(16))];return i.join("")}de.equals=function(n,e){return!n||!e?!1:de(n).toRgbString()==de(e).toRgbString()};de.random=function(){return de.fromRatio({r:Math.random(),g:Math.random(),b:Math.random()})};function dB(n,e){e=e===0?0:e||10;var t=de(n).toHsl();return t.s-=e/100,t.s=Ml(t.s),de(t)}function hB(n,e){e=e===0?0:e||10;var t=de(n).toHsl();return t.s+=e/100,t.s=Ml(t.s),de(t)}function fB(n){return de(n).desaturate(100)}function pB(n,e){e=e===0?0:e||10;var t=de(n).toHsl();return t.l+=e/100,t.l=Ml(t.l),de(t)}function gB(n,e){e=e===0?0:e||10;var t=de(n).toRgb();return t.r=Math.max(0,Math.min(255,t.r-Math.round(255*-(e/100)))),t.g=Math.max(0,Math.min(255,t.g-Math.round(255*-(e/100)))),t.b=Math.max(0,Math.min(255,t.b-Math.round(255*-(e/100)))),de(t)}function mB(n,e){e=e===0?0:e||10;var t=de(n).toHsl();return t.l-=e/100,t.l=Ml(t.l),de(t)}function xB(n,e){var t=de(n).toHsl(),r=(t.h+e)%360;return t.h=r<0?360+r:r,de(t)}function yB(n){var e=de(n).toHsl();return e.h=(e.h+180)%360,de(e)}function Nm(n,e){if(isNaN(e)||e<=0)throw new Error("Argument to polyad must be a positive number");for(var t=de(n).toHsl(),r=[de(n)],i=360/e,s=1;s<e;s++)r.push(de({h:(t.h+s*i)%360,s:t.s,l:t.l}));return r}function bB(n){var e=de(n).toHsl(),t=e.h;return[de(n),de({h:(t+72)%360,s:e.s,l:e.l}),de({h:(t+216)%360,s:e.s,l:e.l})]}function _B(n,e,t){e=e||6,t=t||30;var r=de(n).toHsl(),i=360/t,s=[de(n)];for(r.h=(r.h-(i*e>>1)+720)%360;--e;)r.h=(r.h+i)%360,s.push(de(r));return s}function vB(n,e){e=e||6;for(var t=de(n).toHsv(),r=t.h,i=t.s,s=t.v,o=[],a=1/e;e--;)o.push(de({h:r,s:i,v:s})),s=(s+a)%1;return o}de.mix=function(n,e,t){t=t===0?0:t||50;var r=de(n).toRgb(),i=de(e).toRgb(),s=t/100,o={r:(i.r-r.r)*s+r.r,g:(i.g-r.g)*s+r.g,b:(i.b-r.b)*s+r.b,a:(i.a-r.a)*s+r.a};return de(o)};de.readability=function(n,e){var t=de(n),r=de(e);return(Math.max(t.getLuminance(),r.getLuminance())+.05)/(Math.min(t.getLuminance(),r.getLuminance())+.05)};de.isReadable=function(n,e,t){var r=de.readability(n,e),i,s;switch(s=!1,i=AB(t),i.level+i.size){case"AAsmall":case"AAAlarge":s=r>=4.5;break;case"AAlarge":s=r>=3;break;case"AAAsmall":s=r>=7;break}return s};de.mostReadable=function(n,e,t){var r=null,i=0,s,o,a,c;t=t||{},o=t.includeFallbackColors,a=t.level,c=t.size;for(var l=0;l<e.length;l++)s=de.readability(n,e[l]),s>i&&(i=s,r=de(e[l]));return de.isReadable(n,r,{level:a,size:c})||!o?r:(t.includeFallbackColors=!1,de.mostReadable(n,["#fff","#000"],t))};var bh=de.names={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"0ff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000",blanchedalmond:"ffebcd",blue:"00f",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",burntsienna:"ea7e5d",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"0ff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"f0f",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"789",lightslategrey:"789",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"0f0",limegreen:"32cd32",linen:"faf0e6",magenta:"f0f",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",rebeccapurple:"663399",red:"f00",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"fff",whitesmoke:"f5f5f5",yellow:"ff0",yellowgreen:"9acd32"},TB=de.hexNames=wB(bh);function wB(n){var e={};for(var t in n)n.hasOwnProperty(t)&&(e[n[t]]=t);return e}function O_(n){return n=parseFloat(n),(isNaN(n)||n<0||n>1)&&(n=1),n}function Ye(n,e){SB(n)&&(n="100%");var t=NB(n);return n=Math.min(e,Math.max(0,parseFloat(n))),t&&(n=parseInt(n*e,10)/100),Math.abs(n-e)<1e-6?1:n%e/parseFloat(e)}function Ml(n){return Math.min(1,Math.max(0,n))}function Yt(n){return parseInt(n,16)}function SB(n){return typeof n=="string"&&n.indexOf(".")!=-1&&parseFloat(n)===1}function NB(n){return typeof n=="string"&&n.indexOf("%")!=-1}function vn(n){return n.length==1?"0"+n:""+n}function To(n){return n<=1&&(n=n*100+"%"),n}function U_(n){return Math.round(parseFloat(n)*255).toString(16)}function Em(n){return Yt(n)/255}var hn=(function(){var n="[-\\+]?\\d+%?",e="[-\\+]?\\d*\\.\\d+%?",t="(?:"+e+")|(?:"+n+")",r="[\\s|\\(]+("+t+")[,|\\s]+("+t+")[,|\\s]+("+t+")\\s*\\)?",i="[\\s|\\(]+("+t+")[,|\\s]+("+t+")[,|\\s]+("+t+")[,|\\s]+("+t+")\\s*\\)?";return{CSS_UNIT:new RegExp(t),rgb:new RegExp("rgb"+r),rgba:new RegExp("rgba"+i),hsl:new RegExp("hsl"+r),hsla:new RegExp("hsla"+i),hsv:new RegExp("hsv"+r),hsva:new RegExp("hsva"+i),hex3:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/,hex4:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex8:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/}})();function er(n){return!!hn.CSS_UNIT.exec(n)}function EB(n){n=n.replace(iB,"").replace(sB,"").toLowerCase();var e=!1;if(bh[n])n=bh[n],e=!0;else if(n=="transparent")return{r:0,g:0,b:0,a:0,format:"name"};var t;return(t=hn.rgb.exec(n))?{r:t[1],g:t[2],b:t[3]}:(t=hn.rgba.exec(n))?{r:t[1],g:t[2],b:t[3],a:t[4]}:(t=hn.hsl.exec(n))?{h:t[1],s:t[2],l:t[3]}:(t=hn.hsla.exec(n))?{h:t[1],s:t[2],l:t[3],a:t[4]}:(t=hn.hsv.exec(n))?{h:t[1],s:t[2],v:t[3]}:(t=hn.hsva.exec(n))?{h:t[1],s:t[2],v:t[3],a:t[4]}:(t=hn.hex8.exec(n))?{r:Yt(t[1]),g:Yt(t[2]),b:Yt(t[3]),a:Em(t[4]),format:e?"name":"hex8"}:(t=hn.hex6.exec(n))?{r:Yt(t[1]),g:Yt(t[2]),b:Yt(t[3]),format:e?"name":"hex"}:(t=hn.hex4.exec(n))?{r:Yt(t[1]+""+t[1]),g:Yt(t[2]+""+t[2]),b:Yt(t[3]+""+t[3]),a:Em(t[4]+""+t[4]),format:e?"name":"hex8"}:(t=hn.hex3.exec(n))?{r:Yt(t[1]+""+t[1]),g:Yt(t[2]+""+t[2]),b:Yt(t[3]+""+t[3]),format:e?"name":"hex"}:!1}function AB(n){var e,t;return n=n||{level:"AA",size:"small"},e=(n.level||"AA").toUpperCase(),t=(n.size||"small").toLowerCase(),e!=="AA"&&e!=="AAA"&&(e="AA"),t!=="small"&&t!=="large"&&(t="small"),{level:e,size:t}}function _h(n,e){(e==null||e>n.length)&&(e=n.length);for(var t=0,r=Array(e);t<e;t++)r[t]=n[t];return r}function RB(n){if(Array.isArray(n))return n}function CB(n){if(Array.isArray(n))return _h(n)}function G_(n,e,t){if(typeof n=="function"?n===e:n.has(e))return arguments.length<3?e:t;throw new TypeError("Private element is not present on this object")}function MB(n){if(n===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return n}function $_(n,e,t){return e=As(e),OB(n,Vf()?Reflect.construct(e,t||[],As(n).constructor):e.apply(n,t))}function PB(n,e){if(e.has(n))throw new TypeError("Cannot initialize the same private elements twice on an object")}function V_(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}function Su(n,e){return n.get(G_(n,e))}function Am(n,e,t){PB(n,e),e.set(n,t)}function Rm(n,e,t){return n.set(G_(n,e),t),t}function z_(n,e,t){if(Vf())return Reflect.construct.apply(null,arguments);var r=[null];r.push.apply(r,e);var i=new(n.bind.apply(n,r));return i}function DB(n,e){for(var t=0;t<e.length;t++){var r=e[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,W_(r.key),r)}}function j_(n,e,t){return e&&DB(n.prototype,e),Object.defineProperty(n,"prototype",{writable:!1}),n}function Pl(n,e,t){return(e=W_(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function vh(){return vh=typeof Reflect<"u"&&Reflect.get?Reflect.get.bind():function(n,e,t){var r=UB(n,e);if(r){var i=Object.getOwnPropertyDescriptor(r,e);return i.get?i.get.call(arguments.length<3?n:t):i.value}},vh.apply(null,arguments)}function As(n){return As=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},As(n)}function H_(n,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),Object.defineProperty(n,"prototype",{writable:!1}),e&&Th(n,e)}function Vf(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(Vf=function(){return!!n})()}function BB(n){if(typeof Symbol<"u"&&n[Symbol.iterator]!=null||n["@@iterator"]!=null)return Array.from(n)}function FB(n,e){var t=n==null?null:typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(t!=null){var r,i,s,o,a=[],c=!0,l=!1;try{if(s=(t=t.call(n)).next,e!==0)for(;!(c=(r=s.call(t)).done)&&(a.push(r.value),a.length!==e);c=!0);}catch(u){l=!0,i=u}finally{try{if(!c&&t.return!=null&&(o=t.return(),Object(o)!==o))return}finally{if(l)throw i}}return a}}function kB(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function IB(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Cm(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(n,i).enumerable})),t.push.apply(t,r)}return t}function LB(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Cm(Object(t),!0).forEach(function(r){Pl(n,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):Cm(Object(t)).forEach(function(r){Object.defineProperty(n,r,Object.getOwnPropertyDescriptor(t,r))})}return n}function OB(n,e){if(e&&(typeof e=="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return MB(n)}function Th(n,e){return Th=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,r){return t.__proto__=r,t},Th(n,e)}function Po(n,e){return RB(n)||FB(n,e)||q_(n,e)||kB()}function UB(n,e){for(;!{}.hasOwnProperty.call(n,e)&&(n=As(n))!==null;);return n}function Nu(n,e,t,r){var i=vh(As(n.prototype),e,t);return typeof i=="function"?function(s){return i.apply(t,s)}:i}function pn(n){return CB(n)||BB(n)||q_(n)||IB()}function GB(n,e){if(typeof n!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var r=t.call(n,e);if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function W_(n){var e=GB(n,"string");return typeof e=="symbol"?e:e+""}function wh(n){"@babel/helpers - typeof";return wh=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},wh(n)}function q_(n,e){if(n){if(typeof n=="string")return _h(n,e);var t={}.toString.call(n).slice(8,-1);return t==="Object"&&n.constructor&&(t=n.constructor.name),t==="Map"||t==="Set"?Array.from(n):t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_h(n,e):void 0}}var X_=function(e){e instanceof Array?e.forEach(X_):(e.map&&e.map.dispose(),e.dispose())},Y_=function(e){e.geometry&&e.geometry.dispose(),e.material&&X_(e.material),e.texture&&e.texture.dispose(),e.children&&e.children.forEach(Y_)},Sh=function(e){for(;e.children.length;){var t=e.children[0];e.remove(t),Y_(t)}},Eu=new WeakMap,La=new WeakMap,no=(function(n){function e(t){var r,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},s=i.dataBindAttr,o=s===void 0?"__data":s,a=i.objBindAttr,c=a===void 0?"__threeObj":a;return V_(this,e),r=$_(this,e),Pl(r,"scene",void 0),Am(r,Eu,void 0),Am(r,La,void 0),r.scene=t,Rm(Eu,r,o),Rm(La,r,c),r.onRemoveObj(function(){}),r}return H_(e,n),j_(e,[{key:"onCreateObj",value:function(r){var i=this;return Nu(e,"onCreateObj",this)([function(s){var o=r(s);return s[Su(La,i)]=o,o[Su(Eu,i)]=s,i.scene.add(o),o}]),this}},{key:"onRemoveObj",value:function(r){var i=this;return Nu(e,"onRemoveObj",this)([function(s,o){var a=Nu(e,"getData",i)([s]);r(s,o),i.scene.remove(s),Sh(s),delete a[Su(La,i)]}]),this}}])})(DD),ro=function(e){return isNaN(e)?parseInt(de(e).toHex(),16):e},Au=function(e){return isNaN(e)?de(e).getAlpha():1},$B=da(rB);function Mm(n,e,t){!e||typeof t!="string"||n.filter(function(r){return!r[t]}).forEach(function(r){r[t]=$B(e(r))})}function VB(n,e){var t=n.nodes,r=n.links,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},s=i.nodeFilter,o=s===void 0?function(){return!0}:s,a=i.onLoopError,c=a===void 0?function(f){throw"Invalid DAG structure! Found cycle in node path: ".concat(f.join(" -> "),".")}:a,l={};t.forEach(function(f){return l[e(f)]={data:f,out:[],depth:-1,skip:!o(f)}}),r.forEach(function(f){var p=f.source,g=f.target,x=v(p),m=v(g);if(!l.hasOwnProperty(x))throw"Missing source node with id: ".concat(x);if(!l.hasOwnProperty(m))throw"Missing target node with id: ".concat(m);var y=l[x],_=l[m];y.out.push(_);function v(T){return wh(T)==="object"?e(T):T}});var u=[];h(Object.values(l));var d=Object.assign.apply(Object,[{}].concat(pn(Object.entries(l).filter(function(f){var p=Po(f,2),g=p[1];return!g.skip}).map(function(f){var p=Po(f,2),g=p[0],x=p[1];return Pl({},g,x.depth)}))));return d;function h(f){for(var p=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[],g=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,x=function(){var v=f[m];if(p.indexOf(v)!==-1){var T=[].concat(pn(p.slice(p.indexOf(v))),[v]).map(function(w){return e(w.data)});return u.some(function(w){return w.length===T.length&&w.every(function(N,E){return N===T[E]})})||(u.push(T),c(T)),1}g>v.depth&&(v.depth=g,h(v.out,[].concat(pn(p),[v]),g+(v.skip?0:1)))},m=0,y=f.length;m<y;m++)x()}}var xe=window.THREE?window.THREE:{Group:zx,Mesh:wn,MeshLambertMaterial:jx,Color:un,BufferGeometry:sa,BufferAttribute:hc,Matrix4:En,Vector3:le,SphereGeometry:ef,CylinderGeometry:Hx,TubeGeometry:pw,ConeGeometry:fw,Line:uw,LineBasicMaterial:qx,QuadraticBezierCurve3:hw,CubicBezierCurve3:dw,Box3:Wx},Pm={graph:lP,forcelayout:TP},zB=2,Ru=new xe.BufferGeometry().setAttribute?"setAttribute":"addAttribute",Oa=new xe.BufferGeometry().applyMatrix4?"applyMatrix4":"applyMatrix",jB=Cl({props:{jsonUrl:{onChange:function(e,t){var r=this;e&&!t.fetchingJson&&(t.fetchingJson=!0,t.onLoading(),fetch(e).then(function(i){return i.json()}).then(function(i){t.fetchingJson=!1,t.onFinishLoading(i),r.graphData(i)}))},triggerUpdate:!1},graphData:{default:{nodes:[],links:[]},onChange:function(e,t){t.engineRunning=!1}},numDimensions:{default:3,onChange:function(e,t){var r=t.d3ForceLayout.force("charge");r&&r.strength(e>2?-60:-30),e<3&&i(t.graphData.nodes,"z"),e<2&&i(t.graphData.nodes,"y");function i(s,o){s.forEach(function(a){delete a[o],delete a["v".concat(o)]})}}},dagMode:{onChange:function(e,t){!e&&t.forceEngine==="d3"&&(t.graphData.nodes||[]).forEach(function(r){return r.fx=r.fy=r.fz=void 0})}},dagLevelDistance:{},dagNodeFilter:{default:function(e){return!0}},onDagError:{triggerUpdate:!1},nodeRelSize:{default:4},nodeId:{default:"id"},nodeVal:{default:"val"},nodeResolution:{default:8},nodeColor:{default:"color"},nodeAutoColorBy:{},nodeOpacity:{default:.75},nodeVisibility:{default:!0},nodeThreeObject:{},nodeThreeObjectExtend:{default:!1},nodePositionUpdate:{triggerUpdate:!1},linkSource:{default:"source"},linkTarget:{default:"target"},linkVisibility:{default:!0},linkColor:{default:"color"},linkAutoColorBy:{},linkOpacity:{default:.2},linkWidth:{},linkResolution:{default:6},linkCurvature:{default:0,triggerUpdate:!1},linkCurveRotation:{default:0,triggerUpdate:!1},linkMaterial:{},linkThreeObject:{},linkThreeObjectExtend:{default:!1},linkPositionUpdate:{triggerUpdate:!1},linkDirectionalArrowLength:{default:0},linkDirectionalArrowColor:{},linkDirectionalArrowRelPos:{default:.5,triggerUpdate:!1},linkDirectionalArrowResolution:{default:8},linkDirectionalParticles:{default:0},linkDirectionalParticleSpeed:{default:.01,triggerUpdate:!1},linkDirectionalParticleOffset:{default:0,triggerUpdate:!1},linkDirectionalParticleWidth:{default:.5},linkDirectionalParticleColor:{},linkDirectionalParticleResolution:{default:4},linkDirectionalParticleThreeObject:{},forceEngine:{default:"d3"},d3AlphaMin:{default:0},d3AlphaDecay:{default:.0228,triggerUpdate:!1,onChange:function(e,t){t.d3ForceLayout.alphaDecay(e)}},d3AlphaTarget:{default:0,triggerUpdate:!1,onChange:function(e,t){t.d3ForceLayout.alphaTarget(e)}},d3VelocityDecay:{default:.4,triggerUpdate:!1,onChange:function(e,t){t.d3ForceLayout.velocityDecay(e)}},ngraphPhysics:{default:{timeStep:20,gravity:-1.2,theta:.8,springLength:30,springCoefficient:8e-4,dragCoefficient:.02}},warmupTicks:{default:0,triggerUpdate:!1},cooldownTicks:{default:1/0,triggerUpdate:!1},cooldownTime:{default:15e3,triggerUpdate:!1},onLoading:{default:function(){},triggerUpdate:!1},onFinishLoading:{default:function(){},triggerUpdate:!1},onUpdate:{default:function(){},triggerUpdate:!1},onFinishUpdate:{default:function(){},triggerUpdate:!1},onEngineTick:{default:function(){},triggerUpdate:!1},onEngineStop:{default:function(){},triggerUpdate:!1}},methods:{refresh:function(e){return e._flushObjects=!0,e._rerender(),this},d3Force:function(e,t,r){return r===void 0?e.d3ForceLayout.force(t):(e.d3ForceLayout.force(t,r),this)},d3ReheatSimulation:function(e){return e.d3ForceLayout.alpha(1),this.resetCountdown(),this},resetCountdown:function(e){return e.cntTicks=0,e.startTickTime=new Date,e.engineRunning=!0,this},tickFrame:function(e){var t=e.forceEngine!=="ngraph";return e.engineRunning&&r(),i(),s(),this;function r(){++e.cntTicks>e.cooldownTicks||new Date-e.startTickTime>e.cooldownTime||t&&e.d3AlphaMin>0&&e.d3ForceLayout.alpha()<e.d3AlphaMin?(e.engineRunning=!1,e.onEngineStop()):(e.layout[t?"tick":"step"](),e.onEngineTick());var o=Ee(e.nodeThreeObjectExtend);e.nodeDataMapper.entries().forEach(function(h){var f=Po(h,2),p=f[0],g=f[1];if(g){var x=t?p:e.layout.getNodePosition(p[e.nodeId]),m=o(p);(!e.nodePositionUpdate||!e.nodePositionUpdate(m?g.children[0]:g,{x:x.x,y:x.y,z:x.z},p)||m)&&(g.position.x=x.x,g.position.y=x.y||0,g.position.z=x.z||0)}});var a=Ee(e.linkWidth),c=Ee(e.linkCurvature),l=Ee(e.linkCurveRotation),u=Ee(e.linkThreeObjectExtend);e.linkDataMapper.entries().forEach(function(h){var f=Po(h,2),p=f[0],g=f[1];if(g){var x=t?p:e.layout.getLinkPosition(e.layout.graph.getLink(p.source,p.target).id),m=x[t?"source":"from"],y=x[t?"target":"to"];if(!(!m||!y||!m.hasOwnProperty("x")||!y.hasOwnProperty("x"))){d(p);var _=u(p);if(!(e.linkPositionUpdate&&e.linkPositionUpdate(_?g.children[1]:g,{start:{x:m.x,y:m.y,z:m.z},end:{x:y.x,y:y.y,z:y.z}},p)&&!_)){var v=30,T=p.__curve,w=g.children.length?g.children[0]:g;if(w.type==="Line"){if(T){var E=T.getPoints(v);w.geometry.getAttribute("position").array.length!==E.length*3&&w.geometry[Ru]("position",new xe.BufferAttribute(new Float32Array(E.length*3),3)),w.geometry.setFromPoints(E)}else{var N=w.geometry.getAttribute("position");(!N||!N.array||N.array.length!==6)&&w.geometry[Ru]("position",N=new xe.BufferAttribute(new Float32Array(6),3)),N.array[0]=m.x,N.array[1]=m.y||0,N.array[2]=m.z||0,N.array[3]=y.x,N.array[4]=y.y||0,N.array[5]=y.z||0,N.needsUpdate=!0}w.geometry.computeBoundingSphere()}else if(w.type==="Mesh")if(T){w.geometry.type.match(/^Tube(Buffer)?Geometry$/)||(w.position.set(0,0,0),w.rotation.set(0,0,0),w.scale.set(1,1,1));var U=Math.ceil(a(p)*10)/10,k=U/2,P=new xe.TubeGeometry(T,v,k,e.linkResolution,!1);w.geometry.dispose(),w.geometry=P}else{if(!w.geometry.type.match(/^Cylinder(Buffer)?Geometry$/)){var A=Math.ceil(a(p)*10)/10,B=A/2,R=new xe.CylinderGeometry(B,B,1,e.linkResolution,1,!1);R[Oa](new xe.Matrix4().makeTranslation(0,1/2,0)),R[Oa](new xe.Matrix4().makeRotationX(Math.PI/2)),w.geometry.dispose(),w.geometry=R}var L=new xe.Vector3(m.x,m.y||0,m.z||0),F=new xe.Vector3(y.x,y.y||0,y.z||0),S=L.distanceTo(F);w.position.x=L.x,w.position.y=L.y,w.position.z=L.z,w.scale.z=S,w.parent.localToWorld(F),w.lookAt(F)}}}}});function d(h){var f=t?h:e.layout.getLinkPosition(e.layout.graph.getLink(h.source,h.target).id),p=f[t?"source":"from"],g=f[t?"target":"to"];if(!(!p||!g||!p.hasOwnProperty("x")||!g.hasOwnProperty("x"))){var x=c(h);if(!x)h.__curve=null;else{var m=new xe.Vector3(p.x,p.y||0,p.z||0),y=new xe.Vector3(g.x,g.y||0,g.z||0),_=m.distanceTo(y),v,T=l(h);if(_>0){var w=g.x-p.x,N=g.y-p.y||0,E=new xe.Vector3().subVectors(y,m),A=E.clone().multiplyScalar(x).cross(w!==0||N!==0?new xe.Vector3(0,0,1):new xe.Vector3(0,1,0)).applyAxisAngle(E.normalize(),T).add(new xe.Vector3().addVectors(m,y).divideScalar(2));v=new xe.QuadraticBezierCurve3(m,A,y)}else{var B=x*70,R=-T,L=R+Math.PI/2;v=new xe.CubicBezierCurve3(m,new xe.Vector3(B*Math.cos(L),B*Math.sin(L),0).add(m),new xe.Vector3(B*Math.cos(R),B*Math.sin(R),0).add(m),y)}h.__curve=v}}}}function i(){var o=Ee(e.linkDirectionalArrowRelPos),a=Ee(e.linkDirectionalArrowLength),c=Ee(e.nodeVal);e.arrowDataMapper.entries().forEach(function(l){var u=Po(l,2),d=u[0],h=u[1];if(h){var f=t?d:e.layout.getLinkPosition(e.layout.graph.getLink(d.source,d.target).id),p=f[t?"source":"from"],g=f[t?"target":"to"];if(!(!p||!g||!p.hasOwnProperty("x")||!g.hasOwnProperty("x"))){var x=Math.cbrt(Math.max(0,c(p)||1))*e.nodeRelSize,m=Math.cbrt(Math.max(0,c(g)||1))*e.nodeRelSize,y=a(d),_=o(d),v=d.__curve?function(B){return d.__curve.getPoint(B)}:function(B){var R=function(F,S,U,k){return S[F]+(U[F]-S[F])*k||0};return{x:R("x",p,g,B),y:R("y",p,g,B),z:R("z",p,g,B)}},T=d.__curve?d.__curve.getLength():Math.sqrt(["x","y","z"].map(function(B){return Math.pow((g[B]||0)-(p[B]||0),2)}).reduce(function(B,R){return B+R},0)),w=x+y+(T-x-m-y)*_,N=v(w/T),E=v((w-y)/T);["x","y","z"].forEach(function(B){return h.position[B]=E[B]});var A=z_(xe.Vector3,pn(["x","y","z"].map(function(B){return N[B]})));h.parent.localToWorld(A),h.lookAt(A)}}})}function s(){var o=Ee(e.linkDirectionalParticleSpeed),a=Ee(e.linkDirectionalParticleOffset);e.graphData.links.forEach(function(c){var l=e.particlesDataMapper.getObj(c),u=l&&l.children,d=c.__singleHopPhotonsObj&&c.__singleHopPhotonsObj.children;if(!((!d||!d.length)&&(!u||!u.length))){var h=t?c:e.layout.getLinkPosition(e.layout.graph.getLink(c.source,c.target).id),f=h[t?"source":"from"],p=h[t?"target":"to"];if(!(!f||!p||!f.hasOwnProperty("x")||!p.hasOwnProperty("x"))){var g=o(c),x=Math.abs(a(c)),m=c.__curve?function(_){return c.__curve.getPoint(_)}:function(_){var v=function(w,N,E,A){return N[w]+(E[w]-N[w])*A||0};return{x:v("x",f,p,_),y:v("y",f,p,_),z:v("z",f,p,_)}},y=[].concat(pn(u||[]),pn(d||[]));y.forEach(function(_,v){var T=_.parent.__linkThreeObjType==="singleHopPhotons";if(_.hasOwnProperty("__progressRatio")||(_.__progressRatio=T?0:(v+x)/u.length),_.__progressRatio+=g,_.__progressRatio>=1)if(!T)_.__progressRatio=_.__progressRatio%1;else{_.parent.remove(_),Sh(_);return}var w=_.__progressRatio,N=m(w);_.geometry.type!=="SphereGeometry"&&_.lookAt(N.x,N.y,N.z),["x","y","z"].forEach(function(E){return _.position[E]=N[E]})})}}})}},emitParticle:function(e,t){if(t&&e.graphData.links.includes(t)){if(!t.__singleHopPhotonsObj){var r=new xe.Group;r.__linkThreeObjType="singleHopPhotons",t.__singleHopPhotonsObj=r,e.graphScene.add(r)}var i=Ee(e.linkDirectionalParticleThreeObject)(t);if(i&&e.linkDirectionalParticleThreeObject===i&&(i=i.clone()),!i){var s=Ee(e.linkDirectionalParticleWidth),o=Math.ceil(s(t)*10)/10/2,a=e.linkDirectionalParticleResolution,c=new xe.SphereGeometry(o,a,a),l=Ee(e.linkColor),u=Ee(e.linkDirectionalParticleColor),d=u(t)||l(t)||"#f0f0f0",h=new xe.Color(ro(d)),f=e.linkOpacity*3,p=new xe.MeshLambertMaterial({color:h,transparent:!0,opacity:f});i=new xe.Mesh(c,p)}t.__singleHopPhotonsObj.add(i)}return this},getGraphBbox:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:function(){return!0};if(!e.initialised)return null;var r=(function i(s){var o=[];if(s.geometry){s.geometry.computeBoundingBox();var a=new xe.Box3;a.copy(s.geometry.boundingBox).applyMatrix4(s.matrixWorld),o.push(a)}return o.concat.apply(o,pn((s.children||[]).filter(function(c){return!c.hasOwnProperty("__graphObjType")||c.__graphObjType==="node"&&t(c.__data)}).map(i)))})(e.graphScene);return r.length?Object.assign.apply(Object,pn(["x","y","z"].map(function(i){return Pl({},i,[mD(r,function(s){return s.min[i]}),gD(r,function(s){return s.max[i]})])}))):null}},stateInit:function(){return{d3ForceLayout:rP().force("link",YM()).force("charge",iP()).force("center",Q3()).force("dagRadial",null).stop(),engineRunning:!1}},init:function(e,t){t.graphScene=e,t.nodeDataMapper=new no(e,{objBindAttr:"__threeObj"}),t.linkDataMapper=new no(e,{objBindAttr:"__lineObj"}),t.arrowDataMapper=new no(e,{objBindAttr:"__arrowObj"}),t.particlesDataMapper=new no(e,{objBindAttr:"__photonsObj"})},update:function(e,t){var r=function(Y){return Y.some(function(te){return t.hasOwnProperty(te)})};if(e.engineRunning=!1,typeof e.onUpdate=="function"&&e.onUpdate(),e.nodeAutoColorBy!==null&&r(["nodeAutoColorBy","graphData","nodeColor"])&&Mm(e.graphData.nodes,Ee(e.nodeAutoColorBy),e.nodeColor),e.linkAutoColorBy!==null&&r(["linkAutoColorBy","graphData","linkColor"])&&Mm(e.graphData.links,Ee(e.linkAutoColorBy),e.linkColor),e._flushObjects||r(["graphData","nodeThreeObject","nodeThreeObjectExtend","nodeVal","nodeColor","nodeVisibility","nodeRelSize","nodeResolution","nodeOpacity"])){var i=Ee(e.nodeThreeObject),s=Ee(e.nodeThreeObjectExtend),o=Ee(e.nodeVal),a=Ee(e.nodeColor),c=Ee(e.nodeVisibility),l={},u={};(e._flushObjects||r(["nodeThreeObject","nodeThreeObjectExtend"]))&&e.nodeDataMapper.clear(),e.nodeDataMapper.onCreateObj(function(O){var Y=i(O),te=s(O);Y&&e.nodeThreeObject===Y&&(Y=Y.clone());var ae;return Y&&!te?ae=Y:(ae=new xe.Mesh,ae.__graphDefaultObj=!0,Y&&te&&ae.add(Y)),ae.__graphObjType="node",ae}).onUpdateObj(function(O,Y){if(O.__graphDefaultObj){var te=o(Y)||1,ae=Math.cbrt(te)*e.nodeRelSize,me=e.nodeResolution;(!O.geometry.type.match(/^Sphere(Buffer)?Geometry$/)||O.geometry.parameters.radius!==ae||O.geometry.parameters.widthSegments!==me)&&(l.hasOwnProperty(te)||(l[te]=new xe.SphereGeometry(ae,me,me)),O.geometry.dispose(),O.geometry=l[te]);var ge=a(Y),Se=new xe.Color(ro(ge||"#ffffaa")),et=e.nodeOpacity*Au(ge);(O.material.type!=="MeshLambertMaterial"||!O.material.color.equals(Se)||O.material.opacity!==et)&&(u.hasOwnProperty(ge)||(u[ge]=new xe.MeshLambertMaterial({color:Se,transparent:!0,opacity:et})),O.material.dispose(),O.material=u[ge])}}).digest(e.graphData.nodes.filter(c))}if(e._flushObjects||r(["graphData","linkThreeObject","linkThreeObjectExtend","linkMaterial","linkColor","linkWidth","linkVisibility","linkResolution","linkOpacity","linkDirectionalArrowLength","linkDirectionalArrowColor","linkDirectionalArrowResolution","linkDirectionalParticles","linkDirectionalParticleWidth","linkDirectionalParticleColor","linkDirectionalParticleResolution","linkDirectionalParticleThreeObject"])){var d=Ee(e.linkThreeObject),h=Ee(e.linkThreeObjectExtend),f=Ee(e.linkMaterial),p=Ee(e.linkVisibility),g=Ee(e.linkColor),x=Ee(e.linkWidth),m={},y={},_={},v=e.graphData.links.filter(p);if((e._flushObjects||r(["linkThreeObject","linkThreeObjectExtend","linkWidth"]))&&e.linkDataMapper.clear(),e.linkDataMapper.onRemoveObj(function(O){var Y=O.__data&&O.__data.__singleHopPhotonsObj;Y&&(Y.parent.remove(Y),Sh(Y),delete O.__data.__singleHopPhotonsObj)}).onCreateObj(function(O){var Y=d(O),te=h(O);Y&&e.linkThreeObject===Y&&(Y=Y.clone());var ae;if(!Y||te){var me=!!x(O);if(me)ae=new xe.Mesh;else{var ge=new xe.BufferGeometry;ge[Ru]("position",new xe.BufferAttribute(new Float32Array(6),3)),ae=new xe.Line(ge)}}var Se;return Y?te?(Se=new xe.Group,Se.__graphDefaultObj=!0,Se.add(ae),Se.add(Y)):Se=Y:(Se=ae,Se.__graphDefaultObj=!0),Se.renderOrder=10,Se.__graphObjType="link",Se}).onUpdateObj(function(O,Y){if(O.__graphDefaultObj){var te=O.children.length?O.children[0]:O,ae=Math.ceil(x(Y)*10)/10,me=!!ae;if(me){var ge=ae/2,Se=e.linkResolution;if(!te.geometry.type.match(/^Cylinder(Buffer)?Geometry$/)||te.geometry.parameters.radiusTop!==ge||te.geometry.parameters.radialSegments!==Se){if(!m.hasOwnProperty(ae)){var et=new xe.CylinderGeometry(ge,ge,1,Se,1,!1);et[Oa](new xe.Matrix4().makeTranslation(0,1/2,0)),et[Oa](new xe.Matrix4().makeRotationX(Math.PI/2)),m[ae]=et}te.geometry.dispose(),te.geometry=m[ae]}}var ft=f(Y);if(ft)te.material=ft;else{var it=g(Y),je=new xe.Color(ro(it||"#f0f0f0")),yt=e.linkOpacity*Au(it),Ce=me?"MeshLambertMaterial":"LineBasicMaterial";if(te.material.type!==Ce||!te.material.color.equals(je)||te.material.opacity!==yt){var ue=me?y:_;ue.hasOwnProperty(it)||(ue[it]=new xe[Ce]({color:je,transparent:yt<1,opacity:yt,depthWrite:yt>=1})),te.material.dispose(),te.material=ue[it]}}}}).digest(v),e.linkDirectionalArrowLength||t.hasOwnProperty("linkDirectionalArrowLength")){var T=Ee(e.linkDirectionalArrowLength),w=Ee(e.linkDirectionalArrowColor);e.arrowDataMapper.onCreateObj(function(){var O=new xe.Mesh(void 0,new xe.MeshLambertMaterial({transparent:!0}));return O.__linkThreeObjType="arrow",O}).onUpdateObj(function(O,Y){var te=T(Y),ae=e.linkDirectionalArrowResolution;if(!O.geometry.type.match(/^Cone(Buffer)?Geometry$/)||O.geometry.parameters.height!==te||O.geometry.parameters.radialSegments!==ae){var me=new xe.ConeGeometry(te*.25,te,ae);me.translate(0,te/2,0),me.rotateX(Math.PI/2),O.geometry.dispose(),O.geometry=me}var ge=w(Y)||g(Y)||"#f0f0f0";O.material.color=new xe.Color(ro(ge)),O.material.opacity=e.linkOpacity*3*Au(ge)}).digest(v.filter(T))}if(e.linkDirectionalParticles||t.hasOwnProperty("linkDirectionalParticles")){var N=Ee(e.linkDirectionalParticles),E=Ee(e.linkDirectionalParticleWidth),A=Ee(e.linkDirectionalParticleColor),B=Ee(e.linkDirectionalParticleThreeObject),R={},L={};e.particlesDataMapper.onCreateObj(function(){var O=new xe.Group;return O.__linkThreeObjType="photons",O.__photonDataMapper=new no(O),O}).onUpdateObj(function(O,Y){var te=!!O.children.length&&O.children[0],ae=B(Y),me,ge;if(ae)me=ae.geometry,ge=ae.material;else{var Se=Math.ceil(E(Y)*10)/10/2,et=e.linkDirectionalParticleResolution;te&&te.geometry.parameters.radius===Se&&te.geometry.parameters.widthSegments===et?me=te.geometry:(L.hasOwnProperty(Se)||(L[Se]=new xe.SphereGeometry(Se,et,et)),me=L[Se]);var ft=A(Y)||g(Y)||"#f0f0f0",it=new xe.Color(ro(ft)),je=e.linkOpacity*3;te&&te.material.color.equals(it)&&te.material.opacity===je?ge=te.material:(R.hasOwnProperty(ft)||(R[ft]=new xe.MeshLambertMaterial({color:it,transparent:!0,opacity:je})),ge=R[ft])}te&&(te.geometry!==me&&te.geometry.dispose(),te.material!==ge&&te.material.dispose());var yt=Math.round(Math.abs(N(Y)));O.__photonDataMapper.id(function(Ce){return Ce.idx}).onCreateObj(function(){return new xe.Mesh(me,ge)}).onUpdateObj(function(Ce){Ce.geometry=me,Ce.material=ge}).digest(pn(new Array(yt)).map(function(Ce,ue){return{idx:ue}}))}).digest(v.filter(N))}}if(e._flushObjects=!1,r(["graphData","nodeId","linkSource","linkTarget","numDimensions","forceEngine","dagMode","dagNodeFilter","dagLevelDistance"])){e.engineRunning=!1,e.graphData.links.forEach(function(O){O.source=O[e.linkSource],O.target=O[e.linkTarget]});var F=e.forceEngine!=="ngraph",S;if(F){(S=e.d3ForceLayout).stop().alpha(1).numDimensions(e.numDimensions).nodes(e.graphData.nodes);var U=e.d3ForceLayout.force("link");U&&U.id(function(O){return O[e.nodeId]}).links(e.graphData.links);var k=e.dagMode&&VB(e.graphData,function(O){return O[e.nodeId]},{nodeFilter:e.dagNodeFilter,onLoopError:e.onDagError||void 0}),P=Math.max.apply(Math,pn(Object.values(k||[]))),$=e.dagLevelDistance||e.graphData.nodes.length/(P||1)*zB*(["radialin","radialout"].indexOf(e.dagMode)!==-1?.7:1);if(["lr","rl","td","bu","zin","zout"].includes(t.dagMode)){var M=["lr","rl"].includes(t.dagMode)?"fx":["td","bu"].includes(t.dagMode)?"fy":"fz";e.graphData.nodes.filter(e.dagNodeFilter).forEach(function(O){return delete O[M]})}if(["lr","rl","td","bu","zin","zout"].includes(e.dagMode)){var W=["rl","td","zout"].includes(e.dagMode),G=function(Y){return(k[Y[e.nodeId]]-P/2)*$*(W?-1:1)},z=["lr","rl"].includes(e.dagMode)?"fx":["td","bu"].includes(e.dagMode)?"fy":"fz";e.graphData.nodes.filter(e.dagNodeFilter).forEach(function(O){return O[z]=G(O)})}e.d3ForceLayout.force("dagRadial",["radialin","radialout"].indexOf(e.dagMode)!==-1?sP(function(O){var Y=k[O[e.nodeId]]||-1;return(e.dagMode==="radialin"?P-Y:Y)*$}).strength(function(O){return e.dagNodeFilter(O)?1:0}):null)}else{var Z=Pm.graph();e.graphData.nodes.forEach(function(O){Z.addNode(O[e.nodeId])}),e.graphData.links.forEach(function(O){Z.addLink(O.source,O.target)}),S=Pm.forcelayout(Z,LB({dimensions:e.numDimensions},e.ngraphPhysics)),S.graph=Z}for(var ee=0;ee<e.warmupTicks&&!(F&&e.d3AlphaMin>0&&e.d3ForceLayout.alpha()<e.d3AlphaMin);ee++)S[F?"tick":"step"]();e.layout=S,this.resetCountdown()}e.engineRunning=!0,e.onFinishUpdate()}});function HB(n){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Object,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,r=(function(i){function s(){var o;V_(this,s);for(var a=arguments.length,c=new Array(a),l=0;l<a;l++)c[l]=arguments[l];return o=$_(this,s,[].concat(c)),o.__kapsuleInstance=z_(n,[].concat(pn(t?[o]:[]),c)),o}return H_(s,i),j_(s)})(e);return Object.keys(n()).forEach(function(i){return r.prototype[i]=function(){var s,o=(s=this.__kapsuleInstance)[i].apply(s,arguments);return o===this.__kapsuleInstance?this:o}}),r}var WB=window.THREE?window.THREE:{Group:zx},K_=HB(jB,WB.Group,!0);const qB=["alphaMap","alphaTest","anisotropy","anisotropyMap","anisotropyRotation","aoMap","aoMapIntensity","attenuationColor","attenuationDistance","bumpMap","clearcoat","clearcoatMap","clearcoatNormalMap","clearcoatNormalScale","clearcoatRoughness","color","dispersion","displacementMap","emissive","emissiveIntensity","emissiveMap","envMap","envMapIntensity","gradientMap","ior","iridescence","iridescenceIOR","iridescenceMap","iridescenceThicknessMap","lightMap","lightMapIntensity","map","matcap","metalness","metalnessMap","normalMap","normalScale","opacity","roughness","roughnessMap","sheen","sheenColor","sheenColorMap","sheenRoughnessMap","shininess","specular","specularColor","specularColorMap","specularIntensity","specularIntensityMap","specularMap","thickness","transmission","transmissionMap"],Cu=new WeakMap;class XB{constructor(e){this.renderObjects=new WeakMap,this.hasNode=this.containsNode(e),this.hasAnimation=e.object.isSkinnedMesh===!0,this.refreshUniforms=qB,this.renderId=0}firstInitialization(e){return this.renderObjects.has(e)===!1?(this.getRenderObjectData(e),!0):!1}needsVelocity(e){const t=e.getMRT();return t!==null&&t.has("velocity")}getRenderObjectData(e){let t=this.renderObjects.get(e);if(t===void 0){const{geometry:r,material:i,object:s}=e;if(t={material:this.getMaterialData(i),geometry:{id:r.id,attributes:this.getAttributesData(r.attributes),indexVersion:r.index?r.index.version:null,drawRange:{start:r.drawRange.start,count:r.drawRange.count}},worldMatrix:s.matrixWorld.clone()},s.center&&(t.center=s.center.clone()),s.morphTargetInfluences&&(t.morphTargetInfluences=s.morphTargetInfluences.slice()),e.bundle!==null&&(t.version=e.bundle.version),t.material.transmission>0){const{width:o,height:a}=e.context;t.bufferWidth=o,t.bufferHeight=a}t.lights=this.getLightsData(e.lightsNode.getLights()),this.renderObjects.set(e,t)}return t}getAttributesData(e){const t={};for(const r in e){const i=e[r];t[r]={version:i.version}}return t}containsNode(e){const t=e.material;for(const r in t)if(t[r]&&t[r].isNode)return!0;return e.renderer.overrideNodes.modelViewMatrix!==null||e.renderer.overrideNodes.modelNormalViewMatrix!==null}getMaterialData(e){const t={};for(const r of this.refreshUniforms){const i=e[r];i!=null&&(typeof i=="object"&&i.clone!==void 0?i.isTexture===!0?t[r]={id:i.id,version:i.version}:t[r]=i.clone():t[r]=i)}return t}equals(e,t){const{object:r,material:i,geometry:s}=e,o=this.getRenderObjectData(e);if(o.worldMatrix.equals(r.matrixWorld)!==!0)return o.worldMatrix.copy(r.matrixWorld),!1;const a=o.material;for(const x in a){const m=a[x],y=i[x];if(m.equals!==void 0){if(m.equals(y)===!1)return m.copy(y),!1}else if(y.isTexture===!0){if(m.id!==y.id||m.version!==y.version)return m.id=y.id,m.version=y.version,!1}else if(m!==y)return a[x]=y,!1}if(a.transmission>0){const{width:x,height:m}=e.context;if(o.bufferWidth!==x||o.bufferHeight!==m)return o.bufferWidth=x,o.bufferHeight=m,!1}const c=o.geometry,l=s.attributes,u=c.attributes,d=Object.keys(u),h=Object.keys(l);if(c.id!==s.id)return c.id=s.id,!1;if(d.length!==h.length)return o.geometry.attributes=this.getAttributesData(l),!1;for(const x of d){const m=u[x],y=l[x];if(y===void 0)return delete u[x],!1;if(m.version!==y.version)return m.version=y.version,!1}const f=s.index,p=c.indexVersion,g=f?f.version:null;if(p!==g)return c.indexVersion=g,!1;if(c.drawRange.start!==s.drawRange.start||c.drawRange.count!==s.drawRange.count)return c.drawRange.start=s.drawRange.start,c.drawRange.count=s.drawRange.count,!1;if(o.morphTargetInfluences){let x=!1;for(let m=0;m<o.morphTargetInfluences.length;m++)o.morphTargetInfluences[m]!==r.morphTargetInfluences[m]&&(o.morphTargetInfluences[m]=r.morphTargetInfluences[m],x=!0);if(x)return!1}if(o.lights){for(let x=0;x<t.length;x++)if(o.lights[x].map!==t[x].map)return!1}return o.center&&o.center.equals(r.center)===!1?(o.center.copy(r.center),!0):(e.bundle!==null&&(o.version=e.bundle.version),!0)}getLightsData(e){const t=[];for(const r of e)r.isSpotLight===!0&&r.map!==null&&t.push({map:r.map.version});return t}getLights(e,t){if(Cu.has(e)){const i=Cu.get(e);if(i.renderId===t)return i.lightsData}const r=this.getLightsData(e.getLights());return Cu.set(e,{renderId:t,lightsData:r}),r}needsRefresh(e,t){if(this.hasNode||this.hasAnimation||this.firstInitialization(e)||this.needsVelocity(t.renderer))return!0;const{renderId:r}=t;if(this.renderId!==r)return this.renderId=r,!0;const i=e.object.static===!0,s=e.bundle!==null&&e.bundle.static===!0&&this.getRenderObjectData(e).version===e.bundle.version;if(i||s)return!1;const o=this.getLights(e.lightsNode,r);return this.equals(e,o)!==!0}}function zf(n,e=0){let t=3735928559^e,r=1103547991^e;if(n instanceof Array)for(let i=0,s;i<n.length;i++)s=n[i],t=Math.imul(t^s,2654435761),r=Math.imul(r^s,1597334677);else for(let i=0,s;i<n.length;i++)s=n.charCodeAt(i),t=Math.imul(t^s,2654435761),r=Math.imul(r^s,1597334677);return t=Math.imul(t^t>>>16,2246822507),t^=Math.imul(r^r>>>13,3266489909),r=Math.imul(r^r>>>16,2246822507),r^=Math.imul(t^t>>>13,3266489909),4294967296*(2097151&r)+(t>>>0)}const Dl=n=>zf(n),ha=n=>zf(n),Do=(...n)=>zf(n),YB=new Map([[1,"float"],[2,"vec2"],[3,"vec3"],[4,"vec4"],[9,"mat3"],[16,"mat4"]]),Dm=new WeakMap;function KB(n){return YB.get(n)}function nl(n){if(n==null)return null;const e=typeof n;return n.isNode===!0?"node":e==="number"?"float":e==="boolean"?"bool":e==="string"?"string":e==="function"?"shader":n.isVector2===!0?"vec2":n.isVector3===!0?"vec3":n.isVector4===!0?"vec4":n.isMatrix2===!0?"mat2":n.isMatrix3===!0?"mat3":n.isMatrix4===!0?"mat4":n.isColor===!0?"color":n instanceof ArrayBuffer?"ArrayBuffer":null}function jf(n,...e){const t=n?n.slice(-4):void 0;return e.length===1&&(t==="vec2"?e=[e[0],e[0]]:t==="vec3"?e=[e[0],e[0],e[0]]:t==="vec4"&&(e=[e[0],e[0],e[0],e[0]])),n==="color"?new un(...e):t==="vec2"?new Te(...e):t==="vec3"?new le(...e):t==="vec4"?new Ze(...e):t==="mat2"?new Ry(...e):t==="mat3"?new oa(...e):t==="mat4"?new En(...e):n==="bool"?e[0]||!1:n==="float"||n==="int"||n==="uint"?e[0]||0:n==="string"?e[0]||"":n==="ArrayBuffer"?ZB(e[0]):null}function Q_(n){let e=Dm.get(n);return e===void 0&&(e={},Dm.set(n,e)),e}function QB(n){let e="";const t=new Uint8Array(n);for(let r=0;r<t.length;r++)e+=String.fromCharCode(t[r]);return btoa(e)}function ZB(n){return Uint8Array.from(atob(n),e=>e.charCodeAt(0)).buffer}const Ua={VERTEX:"vertex"},_e={NONE:"none",FRAME:"frame",RENDER:"render",OBJECT:"object"},On={READ_ONLY:"readOnly",WRITE_ONLY:"writeOnly",READ_WRITE:"readWrite"},JB=["fragment","vertex"],Bm=["setup","analyze","generate"],Fm=[...JB,"compute"],Os=["x","y","z","w"],eF={analyze:"setup",generate:"analyze"};let tF=0;class ce extends rf{static get type(){return"Node"}constructor(e=null){super(),this.nodeType=e,this.updateType=_e.NONE,this.updateBeforeType=_e.NONE,this.updateAfterType=_e.NONE,this.uuid=Ic.generateUUID(),this.version=0,this.name="",this.global=!1,this.parents=!1,this.isNode=!0,this._beforeNodes=null,this._cacheKey=null,this._cacheKeyVersion=0,Object.defineProperty(this,"id",{value:tF++})}set needsUpdate(e){e===!0&&this.version++}get type(){return this.constructor.type}onUpdate(e,t){return this.updateType=t,this.update=e.bind(this),this}onFrameUpdate(e){return this.onUpdate(e,_e.FRAME)}onRenderUpdate(e){return this.onUpdate(e,_e.RENDER)}onObjectUpdate(e){return this.onUpdate(e,_e.OBJECT)}onReference(e){return this.updateReference=e.bind(this),this}updateReference(){return this}isGlobal(){return this.global}*getChildren(){for(const{childNode:e}of this._getChildren())yield e}dispose(){this.dispatchEvent({type:"dispose"})}traverse(e){e(this);for(const t of this.getChildren())t.traverse(e)}_getChildren(e=new Set){const t=[];e.add(this);for(const r of Object.getOwnPropertyNames(this)){const i=this[r];if(!(r.startsWith("_")===!0||e.has(i))){if(Array.isArray(i)===!0)for(let s=0;s<i.length;s++){const o=i[s];o&&o.isNode===!0&&t.push({property:r,index:s,childNode:o})}else if(i&&i.isNode===!0)t.push({property:r,childNode:i});else if(i&&Object.getPrototypeOf(i)===Object.prototype)for(const s in i){if(s.startsWith("_")===!0)continue;const o=i[s];o&&o.isNode===!0&&t.push({property:r,index:s,childNode:o})}}}return t}getCacheKey(e=!1,t=null){if(e=e||this.version!==this._cacheKeyVersion,e===!0||this._cacheKey===null){t===null&&(t=new Set);const r=[];for(const{property:i,childNode:s}of this._getChildren(t))r.push(Dl(i.slice(0,-4)),s.getCacheKey(e,t));this._cacheKey=Do(ha(r),this.customCacheKey()),this._cacheKeyVersion=this.version}return this._cacheKey}customCacheKey(){return this.id}getScope(){return this}getHash(){return this.uuid}getUpdateType(){return this.updateType}getUpdateBeforeType(){return this.updateBeforeType}getUpdateAfterType(){return this.updateAfterType}getElementType(e){const t=this.getNodeType(e);return e.getElementType(t)}getMemberType(){return"void"}getNodeType(e){const t=e.getNodeProperties(this);return t.outputNode?t.outputNode.getNodeType(e):this.nodeType}getShared(e){const t=this.getHash(e);return e.getNodeFromHash(t)||this}getArrayCount(){return null}setup(e){const t=e.getNodeProperties(this);let r=0;for(const i of this.getChildren())t["node"+r++]=i;return t.outputNode||null}analyze(e,t=null){const r=e.increaseUsage(this);if(this.parents===!0){const i=e.getDataFromNode(this,"any");i.stages=i.stages||{},i.stages[e.shaderStage]=i.stages[e.shaderStage]||[],i.stages[e.shaderStage].push(t)}if(r===1){const i=e.getNodeProperties(this);for(const s of Object.values(i))s&&s.isNode===!0&&s.build(e,this)}}generate(e,t){const{outputNode:r}=e.getNodeProperties(this);if(r&&r.isNode===!0)return r.build(e,t)}updateBefore(){se("Abstract function.")}updateAfter(){se("Abstract function.")}update(){se("Abstract function.")}before(e){return this._beforeNodes===null&&(this._beforeNodes=[]),this._beforeNodes.push(e),this}build(e,t=null){const r=this.getShared(e);if(this!==r)return r.build(e,t);if(this._beforeNodes!==null){const c=this._beforeNodes;this._beforeNodes=null;for(const l of c)l.build(e,t);this._beforeNodes=c}const i=e.getDataFromNode(this);i.buildStages=i.buildStages||{},i.buildStages[e.buildStage]=!0;const s=eF[e.buildStage];if(s&&i.buildStages[s]!==!0){const c=e.getBuildStage();e.setBuildStage(s),this.build(e),e.setBuildStage(c)}e.addNode(this),e.addChain(this);let o=null;const a=e.getBuildStage();if(a==="setup"){this.updateReference(e);const c=e.getNodeProperties(this);if(c.initialized!==!0){c.initialized=!0,c.outputNode=this.setup(e)||c.outputNode||null;for(const l of Object.values(c))if(l&&l.isNode===!0){if(l.parents===!0){const u=e.getNodeProperties(l);u.parents=u.parents||[],u.parents.push(this)}l.build(e)}}o=c.outputNode}else if(a==="analyze")this.analyze(e,t);else if(a==="generate"){if(this.generate.length<2){const l=this.getNodeType(e),u=e.getDataFromNode(this);o=u.snippet,o===void 0?u.generated===void 0?(u.generated=!0,o=this.generate(e)||"",u.snippet=o):(se("Node: Recursion detected.",this),o="/* Recursion detected. */"):u.flowCodes!==void 0&&e.context.nodeBlock!==void 0&&e.addFlowCodeHierarchy(this,e.context.nodeBlock),o=e.format(o,l,t)}else o=this.generate(e,t)||"";o===""&&t!==null&&t!=="void"&&t!=="OutputType"&&(ie(`TSL: Invalid generated code, expected a "${t}".`),o=e.generateConst(t))}return e.removeChain(this),e.addSequentialNode(this),o}getSerializeChildren(){return this._getChildren()}serialize(e){const t=this.getSerializeChildren(),r={};for(const{property:i,index:s,childNode:o}of t)s!==void 0?(r[i]===void 0&&(r[i]=Number.isInteger(s)?[]:{}),r[i][s]=o.toJSON(e.meta).uuid):r[i]=o.toJSON(e.meta).uuid;Object.keys(r).length>0&&(e.inputNodes=r)}deserialize(e){if(e.inputNodes!==void 0){const t=e.meta.nodes;for(const r in e.inputNodes)if(Array.isArray(e.inputNodes[r])){const i=[];for(const s of e.inputNodes[r])i.push(t[s]);this[r]=i}else if(typeof e.inputNodes[r]=="object"){const i={};for(const s in e.inputNodes[r]){const o=e.inputNodes[r][s];i[s]=t[o]}this[r]=i}else{const i=e.inputNodes[r];this[r]=t[i]}}}toJSON(e){const{uuid:t,type:r}=this,i=e===void 0||typeof e=="string";i&&(e={textures:{},images:{},nodes:{}});let s=e.nodes[t];s===void 0&&(s={uuid:t,type:r,meta:e,metadata:{version:4.7,type:"Node",generator:"Node.toJSON"}},i!==!0&&(e.nodes[s.uuid]=s),this.serialize(s),delete s.meta);function o(a){const c=[];for(const l in a){const u=a[l];delete u.metadata,c.push(u)}return c}if(i){const a=o(e.textures),c=o(e.images),l=o(e.nodes);a.length>0&&(s.textures=a),c.length>0&&(s.images=c),l.length>0&&(s.nodes=l)}return s}}class fa extends ce{static get type(){return"ArrayElementNode"}constructor(e,t){super(),this.node=e,this.indexNode=t,this.isArrayElementNode=!0}getNodeType(e){return this.node.getElementType(e)}generate(e){const t=this.indexNode.getNodeType(e),r=this.node.build(e),i=this.indexNode.build(e,!e.isVector(t)&&e.isInteger(t)?t:"uint");return`${r}[ ${i} ]`}}class Z_ extends ce{static get type(){return"ConvertNode"}constructor(e,t){super(),this.node=e,this.convertTo=t}getNodeType(e){const t=this.node.getNodeType(e);let r=null;for(const i of this.convertTo.split("|"))(r===null||e.getTypeLength(t)===e.getTypeLength(i))&&(r=i);return r}serialize(e){super.serialize(e),e.convertTo=this.convertTo}deserialize(e){super.deserialize(e),this.convertTo=e.convertTo}generate(e,t){const r=this.node,i=this.getNodeType(e),s=r.build(e,i);return e.format(s,i,t)}}class mt extends ce{static get type(){return"TempNode"}constructor(e=null){super(e),this.isTempNode=!0}hasDependencies(e){return e.getDataFromNode(this).usageCount>1}build(e,t){if(e.getBuildStage()==="generate"){const i=e.getVectorType(this.getNodeType(e,t)),s=e.getDataFromNode(this);if(s.propertyName!==void 0)return e.format(s.propertyName,i,t);if(i!=="void"&&t!=="void"&&this.hasDependencies(e)){const o=super.build(e,i),a=e.getVarFromNode(this,null,i),c=e.getPropertyName(a);return e.addLineFlowCode(`${c} = ${o}`,this),s.snippet=o,s.propertyName=c,e.format(s.propertyName,i,t)}}return super.build(e,t)}}class nF extends mt{static get type(){return"JoinNode"}constructor(e=[],t=null){super(t),this.nodes=e}getNodeType(e){return this.nodeType!==null?e.getVectorType(this.nodeType):e.getTypeFromLength(this.nodes.reduce((t,r)=>t+e.getTypeLength(r.getNodeType(e)),0))}generate(e,t){const r=this.getNodeType(e),i=e.getTypeLength(r),s=this.nodes,o=e.getComponentType(r),a=[];let c=0;for(const u of s){if(c>=i){ie(`TSL: Length of parameters exceeds maximum length of function '${r}()' type.`);break}let d=u.getNodeType(e),h=e.getTypeLength(d),f;if(c+h>i&&(ie(`TSL: Length of '${r}()' data exceeds maximum length of output type.`),h=i-c,d=e.getTypeFromLength(h)),c+=h,f=u.build(e,d),e.getComponentType(d)!==o){const g=e.getTypeFromLength(h,o);f=e.format(f,d,g)}a.push(f)}const l=`${e.getType(r)}( ${a.join(", ")} )`;return e.format(l,r,t)}}const rF=Os.join("");class iF extends ce{static get type(){return"SplitNode"}constructor(e,t="x"){super(),this.node=e,this.components=t,this.isSplitNode=!0}getVectorLength(){let e=this.components.length;for(const t of this.components)e=Math.max(Os.indexOf(t)+1,e);return e}getComponentType(e){return e.getComponentType(this.node.getNodeType(e))}getNodeType(e){return e.getTypeFromLength(this.components.length,this.getComponentType(e))}getScope(){return this.node.getScope()}generate(e,t){const r=this.node,i=e.getTypeLength(r.getNodeType(e));let s=null;if(i>1){let o=null;this.getVectorLength()>=i&&(o=e.getTypeFromLength(this.getVectorLength(),this.getComponentType(e)));const c=r.build(e,o);this.components.length===i&&this.components===rF.slice(0,this.components.length)?s=e.format(c,o,t):s=e.format(`${c}.${this.components}`,this.getNodeType(e),t)}else s=r.build(e,t);return s}serialize(e){super.serialize(e),e.components=this.components}deserialize(e){super.deserialize(e),this.components=e.components}}class sF extends mt{static get type(){return"SetNode"}constructor(e,t,r){super(),this.sourceNode=e,this.components=t,this.targetNode=r}getNodeType(e){return this.sourceNode.getNodeType(e)}generate(e){const{sourceNode:t,components:r,targetNode:i}=this,s=this.getNodeType(e),o=e.getComponentType(i.getNodeType(e)),a=e.getTypeFromLength(r.length,o),c=i.build(e,a),l=t.build(e,s),u=e.getTypeLength(s),d=[];for(let h=0;h<u;h++){const f=Os[h];f===r[0]?(d.push(c),h+=r.length-1):d.push(l+"."+f)}return`${e.getType(s)}( ${d.join(", ")} )`}}class oF extends mt{static get type(){return"FlipNode"}constructor(e,t){super(),this.sourceNode=e,this.components=t}getNodeType(e){return this.sourceNode.getNodeType(e)}generate(e){const{components:t,sourceNode:r}=this,i=this.getNodeType(e),s=r.build(e),o=e.getVarFromNode(this),a=e.getPropertyName(o);e.addLineFlowCode(a+" = "+s,this);const c=e.getTypeLength(i),l=[];let u=0;for(let d=0;d<c;d++){const h=Os[d];h===t[u]?(l.push("1.0 - "+(a+"."+h)),u++):l.push(a+"."+h)}return`${e.getType(i)}( ${l.join(", ")} )`}}class Hf extends ce{static get type(){return"InputNode"}constructor(e,t=null){super(t),this.isInputNode=!0,this.value=e,this.precision=null}getNodeType(){return this.nodeType===null?nl(this.value):this.nodeType}getInputType(e){return this.getNodeType(e)}setPrecision(e){return this.precision=e,this}serialize(e){super.serialize(e),e.value=this.value,this.value&&this.value.toArray&&(e.value=this.value.toArray()),e.valueType=nl(this.value),e.nodeType=this.nodeType,e.valueType==="ArrayBuffer"&&(e.value=QB(e.value)),e.precision=this.precision}deserialize(e){super.deserialize(e),this.nodeType=e.nodeType,this.value=Array.isArray(e.value)?jf(e.valueType,...e.value):e.value,this.precision=e.precision||null,this.value&&this.value.fromArray&&(this.value=this.value.fromArray(e.value))}generate(){se("Abstract function.")}}const km=/float|u?int/;class Yn extends Hf{static get type(){return"ConstNode"}constructor(e,t=null){super(e,t),this.isConstNode=!0}generateConst(e){return e.generateConst(this.getNodeType(e),this.value)}generate(e,t){const r=this.getNodeType(e);return km.test(r)&&km.test(t)?e.generateConst(t,this.value):e.format(this.generateConst(e),r,t)}}class aF extends ce{static get type(){return"MemberNode"}constructor(e,t){super(),this.structNode=e,this.property=t,this.isMemberNode=!0}hasMember(e){return this.structNode.isMemberNode&&this.structNode.hasMember(e)===!1?!1:this.structNode.getMemberType(e,this.property)!=="void"}getNodeType(e){return this.hasMember(e)===!1?"float":this.structNode.getMemberType(e,this.property)}getMemberType(e,t){if(this.hasMember(e)===!1)return"float";const r=this.getNodeType(e);return e.getStructTypeNode(r).getMemberType(e,t)}generate(e){if(this.hasMember(e)===!1){se(`TSL: Member "${this.property}" does not exist in struct.`);const r=this.getNodeType(e);return e.generateConst(r)}return this.structNode.build(e)+"."+this.property}}let Pi=null;const Nh=new Map;function H(n,e){if(Nh.has(n)){se(`TSL: Redefinition of method chaining '${n}'.`);return}if(typeof e!="function")throw new Error(`THREE.TSL: Node element ${n} is not a function`);Nh.set(n,e),n!=="assign"&&(ce.prototype[n]=function(...t){return this.isStackNode?this.addToStack(e(...t)):e(this,...t)},ce.prototype[n+"Assign"]=function(...t){return this.isStackNode?this.assign(t[0],e(...t)):this.assign(e(this,...t))})}const cF=n=>n.replace(/r|s/g,"x").replace(/g|t/g,"y").replace(/b|p/g,"z").replace(/a|q/g,"w"),Im=n=>cF(n).split("").sort().join("");ce.prototype.assign=function(...n){if(this.isStackNode!==!0)return Pi!==null?Pi.assign(this,...n):ie("TSL: No stack defined for assign operation. Make sure the assign is inside a Fn()."),this;{const e=Nh.get("assign");return this.addToStack(e(...n))}};ce.prototype.toVarIntent=function(){return this};ce.prototype.get=function(n){return new aF(this,n)};const Bo={};function Ga(n,e,t){Bo[n]=Bo[e]=Bo[t]={get(){this._cache=this._cache||{};let o=this._cache[n];return o===void 0&&(o=new iF(this,n),this._cache[n]=o),o},set(o){this[n].assign(J(o))}};const r=n.toUpperCase(),i=e.toUpperCase(),s=t.toUpperCase();ce.prototype["set"+r]=ce.prototype["set"+i]=ce.prototype["set"+s]=function(o){const a=Im(n);return new sF(this,a,J(o))},ce.prototype["flip"+r]=ce.prototype["flip"+i]=ce.prototype["flip"+s]=function(){const o=Im(n);return new oF(this,o)}}const Mn=["x","y","z","w"],Pn=["r","g","b","a"],Dn=["s","t","p","q"];for(let n=0;n<4;n++){let e=Mn[n],t=Pn[n],r=Dn[n];Ga(e,t,r);for(let i=0;i<4;i++){e=Mn[n]+Mn[i],t=Pn[n]+Pn[i],r=Dn[n]+Dn[i],Ga(e,t,r);for(let s=0;s<4;s++){e=Mn[n]+Mn[i]+Mn[s],t=Pn[n]+Pn[i]+Pn[s],r=Dn[n]+Dn[i]+Dn[s],Ga(e,t,r);for(let o=0;o<4;o++)e=Mn[n]+Mn[i]+Mn[s]+Mn[o],t=Pn[n]+Pn[i]+Pn[s]+Pn[o],r=Dn[n]+Dn[i]+Dn[s]+Dn[o],Ga(e,t,r)}}}for(let n=0;n<32;n++)Bo[n]={get(){this._cache=this._cache||{};let e=this._cache[n];return e===void 0&&(e=new fa(this,new Yn(n,"uint")),this._cache[n]=e),e},set(e){this[n].assign(J(e))}};Object.defineProperties(ce.prototype,Bo);const Lm=new WeakMap,lF=function(n,e=null){const t=nl(n);return t==="node"?n:e===null&&(t==="float"||t==="boolean")||t&&t!=="shader"&&t!=="string"?J(Eh(n,e)):t==="shader"?n.isFn?n:Q(n):n},uF=function(n,e=null){for(const t in n)n[t]=J(n[t],e);return n},dF=function(n,e=null){const t=n.length;for(let r=0;r<t;r++)n[r]=J(n[r],e);return n},J_=function(n,e=null,t=null,r=null){function i(u){return r!==null?(u=J(Object.assign(u,r)),r.intent===!0&&(u=u.toVarIntent())):u=J(u),u}let s,o=e,a,c;function l(u){let d;return o?d=/[a-z]/i.test(o)?o+"()":o:d=n.type,a!==void 0&&u.length<a?(ie(`TSL: "${d}" parameter length is less than minimum required.`),u.concat(new Array(a-u.length).fill(0))):c!==void 0&&u.length>c?(ie(`TSL: "${d}" parameter length exceeds limit.`),u.slice(0,c)):u}return e===null?s=(...u)=>i(new n(...gs(l(u)))):t!==null?(t=J(t),s=(...u)=>i(new n(e,...gs(l(u)),t))):s=(...u)=>i(new n(e,...gs(l(u)))),s.setParameterLength=(...u)=>(u.length===1?a=c=u[0]:u.length===2&&([a,c]=u),s),s.setName=u=>(o=u,s),s},hF=function(n,...e){return J(new n(...gs(e)))};class fF extends ce{constructor(e,t){super(),this.shaderNode=e,this.rawInputs=t,this.isShaderCallNodeInternal=!0}getNodeType(e){return this.shaderNode.nodeType||this.getOutputNode(e).getNodeType(e)}getElementType(e){return this.getOutputNode(e).getElementType(e)}getMemberType(e,t){return this.getOutputNode(e).getMemberType(e,t)}call(e){const{shaderNode:t,rawInputs:r}=this,i=e.getNodeProperties(t),s=e.getClosestSubBuild(t.subBuilds)||"",o=s||"default";if(i[o])return i[o];const a=e.subBuildFn,c=e.fnCall;e.subBuildFn=s,e.fnCall=this;let l=null;if(t.layout){let u=Lm.get(e.constructor);u===void 0&&(u=new WeakMap,Lm.set(e.constructor,u));let d=u.get(t);d===void 0&&(d=J(e.buildFunctionNode(t)),u.set(t,d)),e.addInclude(d);const h=r?pF(r):null;l=J(d.call(h))}else{const u=new Proxy(e,{get:(g,x,m)=>{let y;return Symbol.iterator===x?y=function*(){yield void 0}:y=Reflect.get(g,x,m),y}}),d=r?gF(r):null,h=Array.isArray(r)?r.length>0:r!==null,f=t.jsFunc,p=h||f.length>1?f(d,u):f(u);l=J(p)}return e.subBuildFn=a,e.fnCall=c,t.once&&(i[o]=l),l}setupOutput(e){return e.addStack(),e.stack.outputNode=this.call(e),e.removeStack()}getOutputNode(e){const t=e.getNodeProperties(this),r=e.getSubBuildOutput(this);return t[r]=t[r]||this.setupOutput(e),t[r].subBuild=e.getClosestSubBuild(this),t[r]}build(e,t=null){let r=null;const i=e.getBuildStage(),s=e.getNodeProperties(this),o=e.getSubBuildOutput(this),a=this.getOutputNode(e),c=e.fnCall;if(e.fnCall=this,i==="setup"){const l=e.getSubBuildProperty("initialized",this);if(s[l]!==!0&&(s[l]=!0,s[o]=this.getOutputNode(e),s[o].build(e),this.shaderNode.subBuilds))for(const u of e.chaining){const d=e.getDataFromNode(u,"any");d.subBuilds=d.subBuilds||new Set;for(const h of this.shaderNode.subBuilds)d.subBuilds.add(h)}r=s[o]}else i==="analyze"?a.build(e,t):i==="generate"&&(r=a.build(e,t)||"");return e.fnCall=c,r}}function pF(n){let e;return Yf(n),n[0]&&(n[0].isNode||Object.getPrototypeOf(n[0])!==Object.prototype)?e=[...n]:e=n[0],e}function gF(n){let e=0;return Yf(n),new Proxy(n,{get:(t,r,i)=>{let s;if(r==="length")return s=n.length,s;if(Symbol.iterator===r)s=function*(){for(const o of n)yield J(o)};else{if(n.length>0)if(Object.getPrototypeOf(n[0])===Object.prototype){const o=n[0];o[r]===void 0?s=o[e++]:s=Reflect.get(o,r,i)}else n[0]instanceof ce&&(n[r]===void 0?s=n[e++]:s=Reflect.get(n,r,i));else s=Reflect.get(t,r,i);s=J(s)}return s}})}class mF extends ce{constructor(e,t){super(t),this.jsFunc=e,this.layout=null,this.global=!0,this.once=!1}setLayout(e){return this.layout=e,this}getLayout(){return this.layout}call(e=null){return new fF(this,e)}setup(){return this.call()}}const xF=[!1,!0],yF=[0,1,2,3],bF=[-1,-2],ev=[.5,1.5,1/3,1e-6,1e6,Math.PI,Math.PI*2,1/Math.PI,2/Math.PI,1/(Math.PI*2),Math.PI/2],Wf=new Map;for(const n of xF)Wf.set(n,new Yn(n));const qf=new Map;for(const n of yF)qf.set(n,new Yn(n,"uint"));const Xf=new Map([...qf].map(n=>new Yn(n.value,"int")));for(const n of bF)Xf.set(n,new Yn(n,"int"));const Bl=new Map([...Xf].map(n=>new Yn(n.value)));for(const n of ev)Bl.set(n,new Yn(n));for(const n of ev)Bl.set(-n,new Yn(-n));const Fl={bool:Wf,uint:qf,ints:Xf,float:Bl},Om=new Map([...Wf,...Bl]),Eh=(n,e)=>Om.has(n)?Om.get(n):n.isNode===!0?n:new Yn(n,e),ht=function(n,e=null){return(...t)=>{for(const i of t)if(i===void 0)return ie(`TSL: Invalid parameter for the type "${n}".`),J(new Yn(0,n));if((t.length===0||!["bool","float","int","uint"].includes(n)&&t.every(i=>{const s=typeof i;return s!=="object"&&s!=="function"}))&&(t=[jf(n,...t)]),t.length===1&&e!==null&&e.has(t[0]))return $a(e.get(t[0]));if(t.length===1){const i=Eh(t[0],n);return i.nodeType===n?$a(i):$a(new Z_(i,n))}const r=t.map(i=>Eh(i));return $a(new nF(r,n))}},Um=n=>typeof n=="object"&&n!==null?n.value:n,_F=n=>n!=null?n.nodeType||n.convertTo||(typeof n=="string"?n:null):null;function wo(n,e){return new mF(n,e)}const J=(n,e=null)=>lF(n,e),$a=(n,e=null)=>J(n,e).toVarIntent(),Yf=(n,e=null)=>new uF(n,e),gs=(n,e=null)=>new dF(n,e),Pe=(n,e=null,t=null,r=null)=>new J_(n,e,t,r),re=(n,...e)=>new hF(n,...e),oe=(n,e=null,t=null,r={})=>new J_(n,e,t,{...r,intent:!0});let vF=0;class TF extends ce{constructor(e,t=null){super();let r=null;t!==null&&(typeof t=="object"?r=t.return:(typeof t=="string"?r=t:ie("TSL: Invalid layout type."),t=null)),this.shaderNode=new wo(e,r),t!==null&&this.setLayout(t),this.isFn=!0}setLayout(e){const t=this.shaderNode.nodeType;if(typeof e.inputs!="object"){const r={name:"fn"+vF++,type:t,inputs:[]};for(const i in e)i!=="return"&&r.inputs.push({name:i,type:e[i]});e=r}return this.shaderNode.setLayout(e),this}getNodeType(e){return this.shaderNode.getNodeType(e)||"float"}call(...e){const t=this.shaderNode.call(e);return this.shaderNode.nodeType==="void"&&t.toStack(),t.toVarIntent()}once(e=null){return this.shaderNode.once=!0,this.shaderNode.subBuilds=e,this}generate(e){const t=this.getNodeType(e);return ie('TSL: "Fn()" was declared but not invoked. Try calling it like "Fn()( ...params )".'),e.generateConst(t)}}function Q(n,e=null){const t=new TF(n,e);return new Proxy(()=>{},{apply(r,i,s){return t.call(...s)},get(r,i,s){return Reflect.get(t,i,s)},set(r,i,s,o){return Reflect.set(t,i,s,o)}})}const rl=n=>{Pi=n},tv=()=>Pi,qe=(...n)=>Pi.If(...n);function nv(n){return Pi&&Pi.addToStack(n),n}H("toStack",nv);const wF=new ht("color"),j=new ht("float",Fl.float),ze=new ht("int",Fl.ints),nt=new ht("uint",Fl.uint),Kf=new ht("bool",Fl.bool),ne=new ht("vec2"),sr=new ht("ivec2"),SF=new ht("uvec2"),NF=new ht("bvec2"),X=new ht("vec3"),EF=new ht("ivec3"),AF=new ht("uvec3"),RF=new ht("bvec3"),be=new ht("vec4"),CF=new ht("ivec4"),MF=new ht("uvec4"),PF=new ht("bvec4"),Qf=new ht("mat2"),kt=new ht("mat3"),ms=new ht("mat4");H("toColor",wF);H("toFloat",j);H("toInt",ze);H("toUint",nt);H("toBool",Kf);H("toVec2",ne);H("toIVec2",sr);H("toUVec2",SF);H("toBVec2",NF);H("toVec3",X);H("toIVec3",EF);H("toUVec3",AF);H("toBVec3",RF);H("toVec4",be);H("toIVec4",CF);H("toUVec4",MF);H("toBVec4",PF);H("toMat2",Qf);H("toMat3",kt);H("toMat4",ms);const DF=Pe(fa).setParameterLength(2),BF=(n,e)=>J(new Z_(J(n),e));H("element",DF);H("convert",BF);H("append",n=>(se("TSL: .append() has been renamed to .toStack()."),nv(n)));class ke extends ce{static get type(){return"PropertyNode"}constructor(e,t=null,r=!1){super(e),this.name=t,this.varying=r,this.isPropertyNode=!0,this.global=!0}customCacheKey(){return Dl(this.type+":"+(this.name||"")+":"+(this.varying?"1":"0"))}getHash(e){return this.name||super.getHash(e)}generate(e){let t;return this.varying===!0?(t=e.getVaryingFromNode(this,this.name),t.needsInterpolation=!0):t=e.getVarFromNode(this,this.name),e.getPropertyName(t)}}const zr=(n,e)=>J(new ke(n,e)),il=(n,e)=>J(new ke(n,e,!0)),Re=re(ke,"vec4","DiffuseColor"),Gm=re(ke,"vec3","EmissiveColor"),ur=re(ke,"float","Roughness"),sl=re(ke,"float","Metalness"),Ah=re(ke,"float","Clearcoat"),ol=re(ke,"float","ClearcoatRoughness"),os=re(ke,"vec3","Sheen"),Zf=re(ke,"float","SheenRoughness"),Jf=re(ke,"float","Iridescence"),rv=re(ke,"float","IridescenceIOR"),iv=re(ke,"float","IridescenceThickness"),Rh=re(ke,"float","AlphaT"),li=re(ke,"float","Anisotropy"),Sc=re(ke,"vec3","AnisotropyT"),xs=re(ke,"vec3","AnisotropyB"),gn=re(ke,"color","SpecularColor"),al=re(ke,"float","SpecularF90"),Ch=re(ke,"float","Shininess"),Fo=re(ke,"vec4","Output"),Mu=re(ke,"float","dashSize"),$m=re(ke,"float","gapSize"),Nc=re(ke,"float","IOR"),Mh=re(ke,"float","Transmission"),sv=re(ke,"float","Thickness"),ov=re(ke,"float","AttenuationDistance"),av=re(ke,"color","AttenuationColor"),cv=re(ke,"float","Dispersion");class lv extends ce{static get type(){return"UniformGroupNode"}constructor(e,t=!1,r=1){super("string"),this.name=e,this.shared=t,this.order=r,this.isUniformGroup=!0}serialize(e){super.serialize(e),e.name=this.name,e.version=this.version,e.shared=this.shared}deserialize(e){super.deserialize(e),this.name=e.name,this.version=e.version,this.shared=e.shared}}const FF=n=>new lv(n),ep=(n,e=0)=>new lv(n,!0,e),kF=ep("frame"),fe=ep("render"),uv=FF("object");class pa extends Hf{static get type(){return"UniformNode"}constructor(e,t=null){super(e,t),this.isUniformNode=!0,this.name="",this.groupNode=uv}setName(e){return this.name=e,this}label(e){return se('TSL: "label()" has been deprecated. Use "setName()" instead.'),this.setName(e)}setGroup(e){return this.groupNode=e,this}getGroup(){return this.groupNode}getUniformHash(e){return this.getHash(e)}onUpdate(e,t){return e=e.bind(this),super.onUpdate(r=>{const i=e(r,this);i!==void 0&&(this.value=i)},t)}getInputType(e){let t=super.getInputType(e);return t==="bool"&&(t="uint"),t}generate(e,t){const r=this.getNodeType(e),i=this.getUniformHash(e);let s=e.getNodeFromHash(i);s===void 0&&(e.setHashNode(this,i),s=this);const o=s.getInputType(e),a=e.getUniformFromNode(s,o,e.shaderStage,this.name||e.context.nodeName),c=e.getPropertyName(a);e.context.nodeName!==void 0&&delete e.context.nodeName;let l=c;if(r==="bool"){const u=e.getDataFromNode(this);let d=u.propertyName;if(d===void 0){const h=e.getVarFromNode(this,null,"bool");d=e.getPropertyName(h),u.propertyName=d,l=e.format(c,o,r),e.addLineFlowCode(`${d} = ${l}`,this)}l=d}return e.format(l,r,t)}}const pe=(n,e)=>{const t=_F(e||n);return t===n&&(n=jf(t)),n=n&&n.isNode===!0?n.node&&n.node.value||n.value:n,J(new pa(n,t))};class Vm extends mt{static get type(){return"ArrayNode"}constructor(e,t,r=null){super(e),this.count=t,this.values=r,this.isArrayNode=!0}getArrayCount(){return this.count}getNodeType(e){return this.nodeType===null&&(this.nodeType=this.values[0].getNodeType(e)),this.nodeType}getElementType(e){return this.getNodeType(e)}generate(e){const t=this.getNodeType(e);return e.generateArray(t,this.count,this.values)}}const IF=(...n)=>{let e;if(n.length===1){const t=n[0];e=new Vm(null,t.length,t)}else{const t=n[0],r=n[1];e=new Vm(t,r)}return J(e)};H("toArray",(n,e)=>IF(Array(e).fill(n)));class LF extends mt{static get type(){return"AssignNode"}constructor(e,t){super(),this.targetNode=e,this.sourceNode=t,this.isAssignNode=!0}hasDependencies(){return!1}getNodeType(e,t){return t!=="void"?this.targetNode.getNodeType(e):"void"}needsSplitAssign(e){const{targetNode:t}=this;if(e.isAvailable("swizzleAssign")===!1&&t.isSplitNode&&t.components.length>1){const r=e.getTypeLength(t.node.getNodeType(e));return Os.join("").slice(0,r)!==t.components}return!1}setup(e){const{targetNode:t,sourceNode:r}=this,i=t.getScope(),s=e.getNodeProperties(i);s.assign=!0;const o=e.getNodeProperties(this);o.sourceNode=r,o.targetNode=t.context({assign:!0})}generate(e,t){const{targetNode:r,sourceNode:i}=e.getNodeProperties(this),s=this.needsSplitAssign(e),o=r.build(e),a=r.getNodeType(e),c=i.build(e,a),l=i.getNodeType(e),u=e.getDataFromNode(this);let d;if(u.initialized===!0)t!=="void"&&(d=o);else if(s){const h=e.getVarFromNode(this,null,a),f=e.getPropertyName(h);e.addLineFlowCode(`${f} = ${c}`,this);const p=r.node,x=p.node.context({assign:!0}).build(e);for(let m=0;m<p.components.length;m++){const y=p.components[m];e.addLineFlowCode(`${x}.${y} = ${f}[ ${m} ]`,this)}t!=="void"&&(d=o)}else d=`${o} = ${c}`,(t==="void"||l==="void")&&(e.addLineFlowCode(d,this),t!=="void"&&(d=o));return u.initialized=!0,e.format(d,a,t)}}const OF=Pe(LF).setParameterLength(2);H("assign",OF);class UF extends mt{static get type(){return"FunctionCallNode"}constructor(e=null,t={}){super(),this.functionNode=e,this.parameters=t}setParameters(e){return this.parameters=e,this}getParameters(){return this.parameters}getNodeType(e){return this.functionNode.getNodeType(e)}getMemberType(e,t){return this.functionNode.getMemberType(e,t)}generate(e){const t=[],r=this.functionNode,i=r.getInputs(e),s=this.parameters,o=(c,l)=>{const u=l.type,d=u==="pointer";let h;return d?h="&"+c.build(e):h=c.build(e,u),h};if(Array.isArray(s)){if(s.length>i.length)ie("TSL: The number of provided parameters exceeds the expected number of inputs in 'Fn()'."),s.length=i.length;else if(s.length<i.length)for(ie("TSL: The number of provided parameters is less than the expected number of inputs in 'Fn()'.");s.length<i.length;)s.push(j(0));for(let c=0;c<s.length;c++)t.push(o(s[c],i[c]))}else for(const c of i){const l=s[c.name];l!==void 0?t.push(o(l,c)):(ie(`TSL: Input '${c.name}' not found in 'Fn()'.`),t.push(o(j(0),c)))}return`${r.build(e,"property")}( ${t.join(", ")} )`}}const GF=(n,...e)=>(e=e.length>1||e[0]&&e[0].isNode===!0?gs(e):Yf(e[0]),new UF(J(n),e));H("call",GF);const $F={"==":"equal","!=":"notEqual","<":"lessThan",">":"greaterThan","<=":"lessThanEqual",">=":"greaterThanEqual","%":"mod"};class Je extends mt{static get type(){return"OperatorNode"}constructor(e,t,r,...i){if(super(),i.length>0){let s=new Je(e,t,r);for(let o=0;o<i.length-1;o++)s=new Je(e,s,i[o]);t=s,r=i[i.length-1]}this.op=e,this.aNode=t,this.bNode=r,this.isOperatorNode=!0}getOperatorMethod(e,t){return e.getMethod($F[this.op],t)}getNodeType(e,t=null){const r=this.op,i=this.aNode,s=this.bNode,o=i.getNodeType(e),a=s?s.getNodeType(e):null;if(o==="void"||a==="void")return t||"void";if(r==="%")return o;if(r==="~"||r==="&"||r==="|"||r==="^"||r===">>"||r==="<<")return e.getIntegerType(o);if(r==="!"||r==="&&"||r==="||"||r==="^^")return"bool";if(r==="=="||r==="!="||r==="<"||r===">"||r==="<="||r===">="){const c=Math.max(e.getTypeLength(o),e.getTypeLength(a));return c>1?`bvec${c}`:"bool"}else{if(e.isMatrix(o)){if(a==="float")return o;if(e.isVector(a))return e.getVectorFromMatrix(o);if(e.isMatrix(a))return o}else if(e.isMatrix(a)){if(o==="float")return a;if(e.isVector(o))return e.getVectorFromMatrix(a)}return e.getTypeLength(a)>e.getTypeLength(o)?a:o}}generate(e,t){const r=this.op,{aNode:i,bNode:s}=this,o=this.getNodeType(e,t);let a=null,c=null;o!=="void"?(a=i.getNodeType(e),c=s?s.getNodeType(e):null,r==="<"||r===">"||r==="<="||r===">="||r==="=="||r==="!="?e.isVector(a)?c=a:e.isVector(c)?a=c:a!==c&&(a=c="float"):r===">>"||r==="<<"?(a=o,c=e.changeComponentType(c,"uint")):r==="%"?(a=o,c=e.isInteger(a)&&e.isInteger(c)?c:a):e.isMatrix(a)?c==="float"?c="float":e.isVector(c)?c=e.getVectorFromMatrix(a):e.isMatrix(c)||(a=c=o):e.isMatrix(c)?a==="float"?a="float":e.isVector(a)?a=e.getVectorFromMatrix(c):a=c=o:a=c=o):a=c=o;const l=i.build(e,a),u=s?s.build(e,c):null,d=e.getFunctionOperator(r);if(t!=="void"){const h=e.renderer.coordinateSystem===Pc;if(r==="=="||r==="!="||r==="<"||r===">"||r==="<="||r===">=")return h?e.isVector(a)?e.format(`${this.getOperatorMethod(e,t)}( ${l}, ${u} )`,o,t):e.format(`( ${l} ${r} ${u} )`,o,t):e.format(`( ${l} ${r} ${u} )`,o,t);if(r==="%")return e.isInteger(c)?e.format(`( ${l} % ${u} )`,o,t):e.format(`${this.getOperatorMethod(e,o)}( ${l}, ${u} )`,o,t);if(r==="!"||r==="~")return e.format(`(${r}${l})`,a,t);if(d)return e.format(`${d}( ${l}, ${u} )`,o,t);if(e.isMatrix(a)&&c==="float")return e.format(`( ${u} ${r} ${l} )`,o,t);if(a==="float"&&e.isMatrix(c))return e.format(`${l} ${r} ${u}`,o,t);{let f=`( ${l} ${r} ${u} )`;return!h&&o==="bool"&&e.isVector(a)&&e.isVector(c)&&(f=`all${f}`),e.format(f,o,t)}}else if(a!=="void")return d?e.format(`${d}( ${l}, ${u} )`,o,t):e.isMatrix(a)&&c==="float"?e.format(`${u} ${r} ${l}`,o,t):e.format(`${l} ${r} ${u}`,o,t)}serialize(e){super.serialize(e),e.op=this.op}deserialize(e){super.deserialize(e),this.op=e.op}}const Ht=oe(Je,"+").setParameterLength(2,1/0).setName("add"),Dt=oe(Je,"-").setParameterLength(2,1/0).setName("sub"),ve=oe(Je,"*").setParameterLength(2,1/0).setName("mul"),jn=oe(Je,"/").setParameterLength(2,1/0).setName("div"),tp=oe(Je,"%").setParameterLength(2).setName("mod"),dv=oe(Je,"==").setParameterLength(2).setName("equal"),VF=oe(Je,"!=").setParameterLength(2).setName("notEqual"),zF=oe(Je,"<").setParameterLength(2).setName("lessThan"),jF=oe(Je,">").setParameterLength(2).setName("greaterThan"),HF=oe(Je,"<=").setParameterLength(2).setName("lessThanEqual"),WF=oe(Je,">=").setParameterLength(2).setName("greaterThanEqual"),qF=oe(Je,"&&").setParameterLength(2,1/0).setName("and"),XF=oe(Je,"||").setParameterLength(2,1/0).setName("or"),YF=oe(Je,"!").setParameterLength(1).setName("not"),KF=oe(Je,"^^").setParameterLength(2).setName("xor"),QF=oe(Je,"&").setParameterLength(2).setName("bitAnd"),ZF=oe(Je,"~").setParameterLength(1).setName("bitNot"),JF=oe(Je,"|").setParameterLength(2).setName("bitOr"),ek=oe(Je,"^").setParameterLength(2).setName("bitXor"),tk=oe(Je,"<<").setParameterLength(2).setName("shiftLeft"),nk=oe(Je,">>").setParameterLength(2).setName("shiftRight"),rk=Q(([n])=>(n.addAssign(1),n)),ik=Q(([n])=>(n.subAssign(1),n)),sk=Q(([n])=>{const e=ze(n).toConst();return n.addAssign(1),e}),ok=Q(([n])=>{const e=ze(n).toConst();return n.subAssign(1),e});H("add",Ht);H("sub",Dt);H("mul",ve);H("div",jn);H("mod",tp);H("equal",dv);H("notEqual",VF);H("lessThan",zF);H("greaterThan",jF);H("lessThanEqual",HF);H("greaterThanEqual",WF);H("and",qF);H("or",XF);H("not",YF);H("xor",KF);H("bitAnd",QF);H("bitNot",ZF);H("bitOr",JF);H("bitXor",ek);H("shiftLeft",tk);H("shiftRight",nk);H("incrementBefore",rk);H("decrementBefore",ik);H("increment",sk);H("decrement",ok);const ak=(n,e)=>(se('TSL: "modInt()" is deprecated. Use "mod( int( ... ) )" instead.'),tp(ze(n),ze(e)));H("modInt",ak);class V extends mt{static get type(){return"MathNode"}constructor(e,t,r=null,i=null){if(super(),(e===V.MAX||e===V.MIN)&&arguments.length>3){let s=new V(e,t,r);for(let o=2;o<arguments.length-1;o++)s=new V(e,s,arguments[o]);t=s,r=arguments[arguments.length-1],i=null}this.method=e,this.aNode=t,this.bNode=r,this.cNode=i,this.isMathNode=!0}getInputType(e){const t=this.aNode.getNodeType(e),r=this.bNode?this.bNode.getNodeType(e):null,i=this.cNode?this.cNode.getNodeType(e):null,s=e.isMatrix(t)?0:e.getTypeLength(t),o=e.isMatrix(r)?0:e.getTypeLength(r),a=e.isMatrix(i)?0:e.getTypeLength(i);return s>o&&s>a?t:o>a?r:a>s?i:t}getNodeType(e){const t=this.method;return t===V.LENGTH||t===V.DISTANCE||t===V.DOT?"float":t===V.CROSS?"vec3":t===V.ALL||t===V.ANY?"bool":t===V.EQUALS?e.changeComponentType(this.aNode.getNodeType(e),"bool"):this.getInputType(e)}setup(e){const{aNode:t,bNode:r,method:i}=this;let s=null;if(i===V.ONE_MINUS)s=Dt(1,t);else if(i===V.RECIPROCAL)s=jn(1,t);else if(i===V.DIFFERENCE)s=Kt(Dt(t,r));else if(i===V.TRANSFORM_DIRECTION){let o=t,a=r;e.isMatrix(o.getNodeType(e))?a=be(X(a),0):o=be(X(o),0);const c=ve(o,a).xyz;s=zn(c)}return s!==null?s:super.setup(e)}generate(e,t){if(e.getNodeProperties(this).outputNode)return super.generate(e,t);let i=this.method;const s=this.getNodeType(e),o=this.getInputType(e),a=this.aNode,c=this.bNode,l=this.cNode,u=e.renderer.coordinateSystem;if(i===V.NEGATE)return e.format("( - "+a.build(e,o)+" )",s,t);{const d=[];return i===V.CROSS?d.push(a.build(e,s),c.build(e,s)):u===Pc&&i===V.STEP?d.push(a.build(e,e.getTypeLength(a.getNodeType(e))===1?"float":o),c.build(e,o)):u===Pc&&(i===V.MIN||i===V.MAX)?d.push(a.build(e,o),c.build(e,e.getTypeLength(c.getNodeType(e))===1?"float":o)):i===V.REFRACT?d.push(a.build(e,o),c.build(e,o),l.build(e,"float")):i===V.MIX?d.push(a.build(e,o),c.build(e,o),l.build(e,e.getTypeLength(l.getNodeType(e))===1?"float":o)):(u===_l&&i===V.ATAN&&c!==null&&(i="atan2"),e.shaderStage!=="fragment"&&(i===V.DFDX||i===V.DFDY)&&(se(`TSL: '${i}' is not supported in the ${e.shaderStage} stage.`),i="/*"+i+"*/"),d.push(a.build(e,o)),c!==null&&d.push(c.build(e,o)),l!==null&&d.push(l.build(e,o))),e.format(`${e.getMethod(i,s)}( ${d.join(", ")} )`,s,t)}}serialize(e){super.serialize(e),e.method=this.method}deserialize(e){super.deserialize(e),this.method=e.method}}V.ALL="all";V.ANY="any";V.RADIANS="radians";V.DEGREES="degrees";V.EXP="exp";V.EXP2="exp2";V.LOG="log";V.LOG2="log2";V.SQRT="sqrt";V.INVERSE_SQRT="inversesqrt";V.FLOOR="floor";V.CEIL="ceil";V.NORMALIZE="normalize";V.FRACT="fract";V.SIN="sin";V.COS="cos";V.TAN="tan";V.ASIN="asin";V.ACOS="acos";V.ATAN="atan";V.ABS="abs";V.SIGN="sign";V.LENGTH="length";V.NEGATE="negate";V.ONE_MINUS="oneMinus";V.DFDX="dFdx";V.DFDY="dFdy";V.ROUND="round";V.RECIPROCAL="reciprocal";V.TRUNC="trunc";V.FWIDTH="fwidth";V.TRANSPOSE="transpose";V.DETERMINANT="determinant";V.INVERSE="inverse";V.EQUALS="equals";V.MIN="min";V.MAX="max";V.STEP="step";V.REFLECT="reflect";V.DISTANCE="distance";V.DIFFERENCE="difference";V.DOT="dot";V.CROSS="cross";V.POW="pow";V.TRANSFORM_DIRECTION="transformDirection";V.MIX="mix";V.CLAMP="clamp";V.REFRACT="refract";V.SMOOTHSTEP="smoothstep";V.FACEFORWARD="faceforward";const hv=j(1e-6),ck=j(Math.PI),lk=oe(V,V.ALL).setParameterLength(1),uk=oe(V,V.ANY).setParameterLength(1),dk=oe(V,V.RADIANS).setParameterLength(1),hk=oe(V,V.DEGREES).setParameterLength(1),fv=oe(V,V.EXP).setParameterLength(1),Ko=oe(V,V.EXP2).setParameterLength(1),pv=oe(V,V.LOG).setParameterLength(1),mr=oe(V,V.LOG2).setParameterLength(1),_i=oe(V,V.SQRT).setParameterLength(1),fk=oe(V,V.INVERSE_SQRT).setParameterLength(1),Ni=oe(V,V.FLOOR).setParameterLength(1),np=oe(V,V.CEIL).setParameterLength(1),zn=oe(V,V.NORMALIZE).setParameterLength(1),Hn=oe(V,V.FRACT).setParameterLength(1),tn=oe(V,V.SIN).setParameterLength(1),or=oe(V,V.COS).setParameterLength(1),pk=oe(V,V.TAN).setParameterLength(1),gk=oe(V,V.ASIN).setParameterLength(1),gv=oe(V,V.ACOS).setParameterLength(1),mv=oe(V,V.ATAN).setParameterLength(1,2),Kt=oe(V,V.ABS).setParameterLength(1),cl=oe(V,V.SIGN).setParameterLength(1),xr=oe(V,V.LENGTH).setParameterLength(1),mk=oe(V,V.NEGATE).setParameterLength(1),xk=oe(V,V.ONE_MINUS).setParameterLength(1),xv=oe(V,V.DFDX).setParameterLength(1),yv=oe(V,V.DFDY).setParameterLength(1),yk=oe(V,V.ROUND).setParameterLength(1),bk=oe(V,V.RECIPROCAL).setParameterLength(1),_k=oe(V,V.TRUNC).setParameterLength(1),bv=oe(V,V.FWIDTH).setParameterLength(1),vk=oe(V,V.TRANSPOSE).setParameterLength(1),Tk=oe(V,V.DETERMINANT).setParameterLength(1),wk=oe(V,V.INVERSE).setParameterLength(1),Sk=(n,e)=>(se('TSL: "equals" is deprecated. Use "equal" inside a vector instead, like: "bvec*( equal( ... ) )"'),dv(n,e)),Rs=oe(V,V.MIN).setParameterLength(2,1/0),gt=oe(V,V.MAX).setParameterLength(2,1/0),_v=oe(V,V.STEP).setParameterLength(2),Nk=oe(V,V.REFLECT).setParameterLength(2),Ek=oe(V,V.DISTANCE).setParameterLength(2),Ak=oe(V,V.DIFFERENCE).setParameterLength(2),Cs=oe(V,V.DOT).setParameterLength(2),Qo=oe(V,V.CROSS).setParameterLength(2),kl=oe(V,V.POW).setParameterLength(2),vv=n=>ve(n,n),Rk=n=>ve(n,n,n),Tv=n=>ve(n,n,n,n),Ck=oe(V,V.TRANSFORM_DIRECTION).setParameterLength(2),Mk=n=>ve(cl(n),kl(Kt(n),1/3)),wv=n=>Cs(n,n),He=oe(V,V.MIX).setParameterLength(3),vr=(n,e=0,t=1)=>J(new V(V.CLAMP,J(n),J(e),J(t))),Sv=n=>vr(n),Nv=oe(V,V.REFRACT).setParameterLength(3),Tr=oe(V,V.SMOOTHSTEP).setParameterLength(3),Pk=oe(V,V.FACEFORWARD).setParameterLength(3),Dk=Q(([n])=>{const r=43758.5453,i=Cs(n.xy,ne(12.9898,78.233)),s=tp(i,ck);return Hn(tn(s).mul(r))}),Bk=(n,e,t)=>He(e,t,n),Fk=(n,e,t)=>Tr(e,t,n),kk=(n,e)=>_v(e,n),Ik=(n,e)=>(se('TSL: "atan2" is overloaded. Use "atan" instead.'),mv(n,e));H("all",lk);H("any",uk);H("equals",Sk);H("radians",dk);H("degrees",hk);H("exp",fv);H("exp2",Ko);H("log",pv);H("log2",mr);H("sqrt",_i);H("inverseSqrt",fk);H("floor",Ni);H("ceil",np);H("normalize",zn);H("fract",Hn);H("sin",tn);H("cos",or);H("tan",pk);H("asin",gk);H("acos",gv);H("atan",mv);H("abs",Kt);H("sign",cl);H("length",xr);H("lengthSq",wv);H("negate",mk);H("oneMinus",xk);H("dFdx",xv);H("dFdy",yv);H("round",yk);H("reciprocal",bk);H("trunc",_k);H("fwidth",bv);H("atan2",Ik);H("min",Rs);H("max",gt);H("step",kk);H("reflect",Nk);H("distance",Ek);H("dot",Cs);H("cross",Qo);H("pow",kl);H("pow2",vv);H("pow3",Rk);H("pow4",Tv);H("transformDirection",Ck);H("mix",Bk);H("clamp",vr);H("refract",Nv);H("smoothstep",Fk);H("faceForward",Pk);H("difference",Ak);H("saturate",Sv);H("cbrt",Mk);H("transpose",vk);H("determinant",Tk);H("inverse",wk);H("rand",Dk);class Lk extends ce{static get type(){return"ConditionalNode"}constructor(e,t,r=null){super(),this.condNode=e,this.ifNode=t,this.elseNode=r}getNodeType(e){const{ifNode:t,elseNode:r}=e.getNodeProperties(this);if(t===void 0)return e.flowBuildStage(this,"setup"),this.getNodeType(e);const i=t.getNodeType(e);if(r!==null){const s=r.getNodeType(e);if(e.getTypeLength(s)>e.getTypeLength(i))return s}return i}setup(e){const t=this.condNode,r=this.ifNode.isolate(),i=this.elseNode?this.elseNode.isolate():null,s=e.context.nodeBlock;e.getDataFromNode(r).parentNodeBlock=s,i!==null&&(e.getDataFromNode(i).parentNodeBlock=s);const o=e.context.uniformFlow,a=e.getNodeProperties(this);a.condNode=t,a.ifNode=o?r:r.context({nodeBlock:r}),a.elseNode=i?o?i:i.context({nodeBlock:i}):null}generate(e,t){const r=this.getNodeType(e),i=e.getDataFromNode(this);if(i.nodeProperty!==void 0)return i.nodeProperty;const{condNode:s,ifNode:o,elseNode:a}=e.getNodeProperties(this),c=e.currentFunctionNode,l=t!=="void",u=l?zr(r).build(e):"";i.nodeProperty=u;const d=s.build(e,"bool");if(e.context.uniformFlow&&a!==null){const p=o.build(e,r),g=a.build(e,r),x=e.getTernary(d,p,g);return e.format(x,r,t)}e.addFlowCode(`
${e.tab}if ( ${d} ) {

`).addFlowTab();let f=o.build(e,r);if(f&&(l?f=u+" = "+f+";":(f="return "+f+";",c===null&&(se("TSL: Return statement used in an inline 'Fn()'. Define a layout struct to allow return values."),f="// "+f))),e.removeFlowTab().addFlowCode(e.tab+"	"+f+`

`+e.tab+"}"),a!==null){e.addFlowCode(` else {

`).addFlowTab();let p=a.build(e,r);p&&(l?p=u+" = "+p+";":(p="return "+p+";",c===null&&(se("TSL: Return statement used in an inline 'Fn()'. Define a layout struct to allow return values."),p="// "+p))),e.removeFlowTab().addFlowCode(e.tab+"	"+p+`

`+e.tab+`}

`)}else e.addFlowCode(`

`);return e.format(u,r,t)}}const Tt=Pe(Lk).setParameterLength(2,3);H("select",Tt);class Ev extends ce{static get type(){return"ContextNode"}constructor(e,t={}){super(),this.isContextNode=!0,this.node=e,this.value=t}getScope(){return this.node.getScope()}getNodeType(e){return this.node.getNodeType(e)}getMemberType(e,t){return this.node.getMemberType(e,t)}analyze(e){const t=e.addContext(this.value);this.node.build(e),e.setContext(t)}setup(e){const t=e.addContext(this.value);this.node.build(e),e.setContext(t)}generate(e,t){const r=e.addContext(this.value),i=this.node.build(e,t);return e.setContext(r),i}}const Il=Pe(Ev).setParameterLength(1,2),Ok=n=>Il(n,{uniformFlow:!0}),Av=(n,e)=>Il(n,{nodeName:e});function Uk(n,e){return se('TSL: "label()" has been deprecated. Use "setName()" instead.'),Av(n,e)}H("context",Il);H("label",Uk);H("uniformFlow",Ok);H("setName",Av);class Ec extends ce{static get type(){return"VarNode"}constructor(e,t=null,r=!1){super(),this.node=e,this.name=t,this.global=!0,this.isVarNode=!0,this.readOnly=r,this.parents=!0,this.intent=!1}setIntent(e){return this.intent=e,this}getIntent(){return this.intent}getMemberType(e,t){return this.node.getMemberType(e,t)}getElementType(e){return this.node.getElementType(e)}getNodeType(e){return this.node.getNodeType(e)}getArrayCount(e){return this.node.getArrayCount(e)}isAssign(e){let r=e.getNodeProperties(this).assign;return r!==!0&&this.node.isShaderCallNodeInternal&&this.node.shaderNode.getLayout()===null&&e.fnCall&&e.fnCall.shaderNode&&e.getDataFromNode(this.node.shaderNode).hasLoop&&(r=!0),r}build(...e){const t=e[0];return this._hasStack(t)===!1&&t.buildStage==="setup"&&(t.context.nodeLoop||t.context.nodeBlock)&&t.getBaseStack().addToStack(this),this.intent===!0&&this.isAssign(t)!==!0?this.node.build(...e):super.build(...e)}generate(e){const{node:t,name:r,readOnly:i}=this,{renderer:s}=e,o=s.backend.isWebGPUBackend===!0;let a=!1,c=!1;i&&(a=e.isDeterministic(t),c=o?i:a);const l=this.getNodeType(e);if(l=="void")return this.intent!==!0&&ie('TSL: ".toVar()" can not be used with void type.'),t.build(e);const u=e.getVectorType(l),d=t.build(e,u),h=e.getVarFromNode(this,r,u,void 0,c),f=e.getPropertyName(h);let p=f;if(c)if(o)p=a?`const ${f}`:`let ${f}`;else{const g=t.getArrayCount(e);p=`const ${e.getVar(h.type,f,g)}`}return e.addLineFlowCode(`${p} = ${d}`,this),f}_hasStack(e){return e.getDataFromNode(this).stack!==void 0}}const rp=Pe(Ec),Gk=(n,e=null)=>rp(n,e).toStack(),$k=(n,e=null)=>rp(n,e,!0).toStack(),Vk=n=>rp(n).setIntent(!0).toStack();H("toVar",Gk);H("toConst",$k);H("toVarIntent",Vk);class zk extends ce{static get type(){return"SubBuild"}constructor(e,t,r=null){super(r),this.node=e,this.name=t,this.isSubBuildNode=!0}getNodeType(e){if(this.nodeType!==null)return this.nodeType;e.addSubBuild(this.name);const t=this.node.getNodeType(e);return e.removeSubBuild(),t}build(e,...t){e.addSubBuild(this.name);const r=this.node.build(e,...t);return e.removeSubBuild(),r}}const ko=(n,e,t=null)=>J(new zk(J(n),e,t));class jk extends ce{static get type(){return"VaryingNode"}constructor(e,t=null){super(),this.node=e,this.name=t,this.isVaryingNode=!0,this.interpolationType=null,this.interpolationSampling=null,this.global=!0}setInterpolation(e,t=null){return this.interpolationType=e,this.interpolationSampling=t,this}getHash(e){return this.name||super.getHash(e)}getNodeType(e){return this.node.getNodeType(e)}setupVarying(e){const t=e.getNodeProperties(this);let r=t.varying;if(r===void 0){const i=this.name,s=this.getNodeType(e),o=this.interpolationType,a=this.interpolationSampling;t.varying=r=e.getVaryingFromNode(this,i,s,o,a),t.node=ko(this.node,"VERTEX")}return r.needsInterpolation||(r.needsInterpolation=e.shaderStage==="fragment"),r}setup(e){this.setupVarying(e),e.flowNodeFromShaderStage(Ua.VERTEX,this.node)}analyze(e){this.setupVarying(e),e.flowNodeFromShaderStage(Ua.VERTEX,this.node)}generate(e){const t=e.getSubBuildProperty("property",e.currentStack),r=e.getNodeProperties(this),i=this.setupVarying(e);if(r[t]===void 0){const s=this.getNodeType(e),o=e.getPropertyName(i,Ua.VERTEX);e.flowNodeFromShaderStage(Ua.VERTEX,r.node,s,o),r[t]=o}return e.getPropertyName(i)}}const Hr=Pe(jk).setParameterLength(1,2),Hk=n=>Hr(n);H("toVarying",Hr);H("toVertexStage",Hk);H("varying",(...n)=>(se("TSL: .varying() has been renamed to .toVarying()."),Hr(...n)));H("vertexStage",(...n)=>(se("TSL: .vertexStage() has been renamed to .toVertexStage()."),Hr(...n)));const Wk=Q(([n])=>{const e=n.mul(.9478672986).add(.0521327014).pow(2.4),t=n.mul(.0773993808),r=n.lessThanEqual(.04045);return He(e,t,r)}).setLayout({name:"sRGBTransferEOTF",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),qk=Q(([n])=>{const e=n.pow(.41666).mul(1.055).sub(.055),t=n.mul(12.92),r=n.lessThanEqual(.0031308);return He(e,t,r)}).setLayout({name:"sRGBTransferOETF",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),ip="WorkingColorSpace",Xk="OutputColorSpace";class Rv extends mt{static get type(){return"ColorSpaceNode"}constructor(e,t,r){super("vec4"),this.colorNode=e,this.source=t,this.target=r}resolveColorSpace(e,t){return t===ip?ut.workingColorSpace:t===Xk?e.context.outputColorSpace||e.renderer.outputColorSpace:t}setup(e){const{colorNode:t}=this,r=this.resolveColorSpace(e,this.source),i=this.resolveColorSpace(e,this.target);let s=t;return ut.enabled===!1||r===i||!r||!i||(ut.getTransfer(r)===ye&&(s=be(Wk(s.rgb),s.a)),ut.getPrimaries(r)!==ut.getPrimaries(i)&&(s=be(kt(ut._getMatrix(new oa,r,i)).mul(s.rgb),s.a)),ut.getTransfer(i)===ye&&(s=be(qk(s.rgb),s.a))),s}}const Yk=(n,e)=>J(new Rv(J(n),ip,e)),sp=(n,e)=>J(new Rv(J(n),e,ip));H("workingToColorSpace",Yk);H("colorSpaceToWorking",sp);let Kk=class extends fa{static get type(){return"ReferenceElementNode"}constructor(e,t){super(e,t),this.referenceNode=e,this.isReferenceElementNode=!0}getNodeType(){return this.referenceNode.uniformType}generate(e){const t=super.generate(e),r=this.referenceNode.getNodeType(),i=this.getNodeType();return e.format(t,r,i)}};class Cv extends ce{static get type(){return"ReferenceBaseNode"}constructor(e,t,r=null,i=null){super(),this.property=e,this.uniformType=t,this.object=r,this.count=i,this.properties=e.split("."),this.reference=r,this.node=null,this.group=null,this.updateType=_e.OBJECT}setGroup(e){return this.group=e,this}element(e){return J(new Kk(this,J(e)))}setNodeType(e){const t=pe(null,e);this.group!==null&&t.setGroup(this.group),this.node=t}getNodeType(e){return this.node===null&&(this.updateReference(e),this.updateValue()),this.node.getNodeType(e)}getValueFromReference(e=this.reference){const{properties:t}=this;let r=e[t[0]];for(let i=1;i<t.length;i++)r=r[t[i]];return r}updateReference(e){return this.reference=this.object!==null?this.object:e.object,this.reference}setup(){return this.updateValue(),this.node}update(){this.updateValue()}updateValue(){this.node===null&&this.setNodeType(this.uniformType);const e=this.getValueFromReference();Array.isArray(e)?this.node.array=e:this.node.value=e}}const Qk=(n,e,t)=>J(new Cv(n,e,t));class Zk extends Cv{static get type(){return"RendererReferenceNode"}constructor(e,t,r=null){super(e,t,r),this.renderer=r,this.setGroup(fe)}updateReference(e){return this.reference=this.renderer!==null?this.renderer:e.renderer,this.reference}}const Jk=(n,e,t=null)=>J(new Zk(n,e,t));class eI extends mt{static get type(){return"ToneMappingNode"}constructor(e,t=nI,r=null){super("vec3"),this._toneMapping=e,this.exposureNode=t,this.colorNode=r}customCacheKey(){return Do(this._toneMapping)}setToneMapping(e){return this._toneMapping=e,this}getToneMapping(){return this._toneMapping}setup(e){const t=this.colorNode||e.context.color,r=this._toneMapping;if(r===xi)return t;let i=null;const s=e.renderer.library.getToneMappingFunction(r);return s!==null?i=be(s(t.rgb,this.exposureNode),t.a):(ie("ToneMappingNode: Unsupported Tone Mapping configuration.",r),i=t),i}}const tI=(n,e,t)=>J(new eI(n,J(e),J(t))),nI=Jk("toneMappingExposure","float");H("toneMapping",(n,e,t)=>tI(e,t,n));class rI extends Hf{static get type(){return"BufferAttributeNode"}constructor(e,t=null,r=0,i=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferStride=r,this.bufferOffset=i,this.usage=DS,this.instanced=!1,this.attribute=null,this.global=!0,e&&e.isBufferAttribute===!0&&(this.attribute=e,this.usage=e.usage,this.instanced=e.isInstancedBufferAttribute)}getHash(e){if(this.bufferStride===0&&this.bufferOffset===0){let t=e.globalCache.getData(this.value);return t===void 0&&(t={node:this},e.globalCache.setData(this.value,t)),t.node.uuid}return this.uuid}getNodeType(e){return this.bufferType===null&&(this.bufferType=e.getTypeFromAttribute(this.attribute)),this.bufferType}setup(e){if(this.attribute!==null)return;const t=this.getNodeType(e),r=this.value,i=e.getTypeLength(t),s=this.bufferStride||i,o=this.bufferOffset,a=r.isInterleavedBuffer===!0?r:new BS(r,s),c=new FS(a,i,o);a.setUsage(this.usage),this.attribute=c,this.attribute.isInstancedBufferAttribute=this.instanced}generate(e){const t=this.getNodeType(e),r=e.getBufferAttributeFromNode(this,t),i=e.getPropertyName(r);let s=null;return e.shaderStage==="vertex"||e.shaderStage==="compute"?(this.name=i,s=i):s=Hr(this).build(e,t),s}getInputType(){return"bufferAttribute"}setUsage(e){return this.usage=e,this.attribute&&this.attribute.isBufferAttribute===!0&&(this.attribute.usage=e),this}setInstanced(e){return this.instanced=e,this}}const op=(n,e=null,t=0,r=0)=>J(new rI(n,e,t,r)),iI=(n,e=null,t=0,r=0)=>op(n,e,t,r).setUsage(rs),zm=(n,e=null,t=0,r=0)=>op(n,e,t,r).setInstanced(!0),jm=(n,e=null,t=0,r=0)=>iI(n,e,t,r).setInstanced(!0);H("toAttribute",n=>op(n.value));class sI extends ce{static get type(){return"ComputeNode"}constructor(e,t){super("void"),this.isComputeNode=!0,this.computeNode=e,this.workgroupSize=t,this.count=null,this.version=1,this.name="",this.updateBeforeType=_e.OBJECT,this.onInitFunction=null}setCount(e){return this.count=e,this}getCount(){return this.count}dispose(){this.dispatchEvent({type:"dispose"})}setName(e){return this.name=e,this}label(e){return se('TSL: "label()" has been deprecated. Use "setName()" instead.'),this.setName(e)}onInit(e){return this.onInitFunction=e,this}updateBefore({renderer:e}){e.compute(this)}setup(e){const t=this.computeNode.build(e);if(t){const r=e.getNodeProperties(this);r.outputComputeNode=t.outputNode,t.outputNode=null}return t}generate(e,t){const{shaderStage:r}=e;if(r==="compute"){const i=this.computeNode.build(e,"void");i!==""&&e.addLineFlowCode(i,this)}else{const s=e.getNodeProperties(this).outputComputeNode;if(s)return s.build(e,t)}}}const Mv=(n,e=[64])=>{(e.length===0||e.length>3)&&ie("TSL: compute() workgroupSize must have 1, 2, or 3 elements");for(let t=0;t<e.length;t++){const r=e[t];(typeof r!="number"||r<=0||!Number.isInteger(r))&&ie(`TSL: compute() workgroupSize element at index [ ${t} ] must be a positive integer`)}for(;e.length<3;)e.push(1);return J(new sI(J(n),e))},oI=(n,e,t)=>Mv(n,t).setCount(e);H("compute",oI);H("computeKernel",Mv);class aI extends ce{static get type(){return"IsolateNode"}constructor(e,t=!0){super(),this.node=e,this.parent=t,this.isIsolateNode=!0}getNodeType(e){const t=e.getCache(),r=e.getCacheFromNode(this,this.parent);e.setCache(r);const i=this.node.getNodeType(e);return e.setCache(t),i}build(e,...t){const r=e.getCache(),i=e.getCacheFromNode(this,this.parent);e.setCache(i);const s=this.node.build(e,...t);return e.setCache(r),s}setParent(e){return this.parent=e,this}getParent(){return this.parent}}const Io=n=>new aI(J(n));function cI(n,e=!0){return se('TSL: "cache()" has been deprecated. Use "isolate()" instead.'),Io(n).setParent(e)}H("cache",cI);H("isolate",Io);class lI extends ce{static get type(){return"BypassNode"}constructor(e,t){super(),this.isBypassNode=!0,this.outputNode=e,this.callNode=t}getNodeType(e){return this.outputNode.getNodeType(e)}generate(e){const t=this.callNode.build(e,"void");return t!==""&&e.addLineFlowCode(t,this),this.outputNode.build(e)}}const uI=Pe(lI).setParameterLength(2);H("bypass",uI);class Pv extends ce{static get type(){return"RemapNode"}constructor(e,t,r,i=j(0),s=j(1)){super(),this.node=e,this.inLowNode=t,this.inHighNode=r,this.outLowNode=i,this.outHighNode=s,this.doClamp=!0}setup(){const{node:e,inLowNode:t,inHighNode:r,outLowNode:i,outHighNode:s,doClamp:o}=this;let a=e.sub(t).div(r.sub(t));return o===!0&&(a=a.clamp()),a.mul(s.sub(i)).add(i)}}const dI=Pe(Pv,null,null,{doClamp:!1}).setParameterLength(3,5),hI=Pe(Pv).setParameterLength(3,5);H("remap",dI);H("remapClamp",hI);class Ac extends ce{static get type(){return"ExpressionNode"}constructor(e="",t="void"){super(t),this.snippet=e}generate(e,t){const r=this.getNodeType(e),i=this.snippet;if(r==="void")e.addLineFlowCode(i,this);else return e.format(i,r,t)}}const Ms=Pe(Ac).setParameterLength(1,2),fI=n=>(n?Tt(n,Ms("discard")):Ms("discard")).toStack();H("discard",fI);class pI extends mt{static get type(){return"RenderOutputNode"}constructor(e,t,r){super("vec4"),this.colorNode=e,this._toneMapping=t,this.outputColorSpace=r,this.isRenderOutputNode=!0}setToneMapping(e){return this._toneMapping=e,this}getToneMapping(){return this._toneMapping}setup({context:e}){let t=this.colorNode||e.color;const r=(this._toneMapping!==null?this._toneMapping:e.toneMapping)||xi,i=(this.outputColorSpace!==null?this.outputColorSpace:e.outputColorSpace)||_s;return r!==xi&&(t=t.toneMapping(r)),i!==_s&&i!==ut.workingColorSpace&&(t=t.workingToColorSpace(i)),t}}const gI=(n,e=null,t=null)=>J(new pI(J(n),e,t));H("renderOutput",gI);class mI extends mt{static get type(){return"DebugNode"}constructor(e,t=null){super(),this.node=e,this.callback=t}getNodeType(e){return this.node.getNodeType(e)}setup(e){return this.node.build(e)}analyze(e){return this.node.build(e)}generate(e){const t=this.callback,r=this.node.build(e),i="--- TSL debug - "+e.shaderStage+" shader ---",s="-".repeat(i.length);let o="";return o+="// #"+i+`#
`,o+=e.flow.code.replace(/^\t/mg,"")+`
`,o+="/* ... */ "+r+` /* ... */
`,o+="// #"+s+`#
`,t!==null?t(e,o):kS(o),r}}const xI=(n,e=null)=>J(new mI(J(n),e)).toStack();H("debug",xI);class Dv{constructor(){this._renderer=null,this.currentFrame=null}get nodeFrame(){return this._renderer._nodes.nodeFrame}setRenderer(e){return this._renderer=e,this}getRenderer(){return this._renderer}init(){}begin(){}finish(){}inspect(){}computeAsync(){}beginCompute(){}finishCompute(){}beginRender(){}finishRender(){}copyTextureToTexture(){}copyFramebufferToTexture(){}}class yI extends ce{static get type(){return"InspectorNode"}constructor(e,t="",r=null){super(),this.node=e,this.name=t,this.callback=r,this.updateType=_e.FRAME,this.isInspectorNode=!0}getName(){return this.name||this.node.name}update(e){e.renderer.inspector.inspect(this)}getNodeType(e){return this.node.getNodeType(e)}setup(e){let t=this.node;return e.context.inspector===!0&&this.callback!==null&&(t=this.callback(t)),e.renderer.backend.isWebGPUBackend!==!0&&e.renderer.inspector.constructor!==Dv&&lt('TSL: ".toInspector()" is only available with WebGPU.'),t}}function bI(n,e="",t=null){return n=J(n),n.before(new yI(n,e,t))}H("toInspector",bI);class Bv extends ce{static get type(){return"AttributeNode"}constructor(e,t=null){super(t),this.global=!0,this._attributeName=e}getHash(e){return this.getAttributeName(e)}getNodeType(e){let t=this.nodeType;if(t===null){const r=this.getAttributeName(e);if(e.hasGeometryAttribute(r)){const i=e.geometry.getAttribute(r);t=e.getTypeFromAttribute(i)}else t="float"}return t}setAttributeName(e){return this._attributeName=e,this}getAttributeName(){return this._attributeName}generate(e){const t=this.getAttributeName(e),r=this.getNodeType(e);if(e.hasGeometryAttribute(t)===!0){const s=e.geometry.getAttribute(t),o=e.getTypeFromAttribute(s),a=e.getAttribute(t,o);return e.shaderStage==="vertex"?e.format(a.name,o,r):Hr(this).build(e,r)}else return se(`AttributeNode: Vertex attribute "${t}" not found on geometry.`),e.generateConst(r)}serialize(e){super.serialize(e),e.global=this.global,e._attributeName=this._attributeName}deserialize(e){super.deserialize(e),this.global=e.global,this._attributeName=e._attributeName}}const jr=(n,e=null)=>J(new Bv(n,e)),Us=(n=0)=>jr("uv"+(n>0?n:""),"vec2");class _I extends ce{static get type(){return"TextureSizeNode"}constructor(e,t=null){super("uvec2"),this.isTextureSizeNode=!0,this.textureNode=e,this.levelNode=t}generate(e,t){const r=this.textureNode.build(e,"property"),i=this.levelNode===null?"0":this.levelNode.build(e,"int");return e.format(`${e.getMethod("textureDimensions")}( ${r}, ${i} )`,this.getNodeType(e),t)}}const Ei=Pe(_I).setParameterLength(1,2);class vI extends pa{static get type(){return"MaxMipLevelNode"}constructor(e){super(0),this._textureNode=e,this.updateType=_e.FRAME}get textureNode(){return this._textureNode}get texture(){return this._textureNode.value}update(){const e=this.texture,t=e.images,r=t&&t.length>0?t[0]&&t[0].image||t[0]:e.image;if(r&&r.width!==void 0){const{width:i,height:s}=r;this.value=Math.log2(Math.max(i,s))}}}const TI=Pe(vI).setParameterLength(1),Fv=new lf;class Gs extends pa{static get type(){return"TextureNode"}constructor(e=Fv,t=null,r=null,i=null){super(e),this.isTextureNode=!0,this.uvNode=t,this.levelNode=r,this.biasNode=i,this.compareNode=null,this.depthNode=null,this.gradNode=null,this.offsetNode=null,this.sampler=!0,this.updateMatrix=!1,this.updateType=_e.NONE,this.referenceNode=null,this._value=e,this._matrixUniform=null,this._flipYUniform=null,this.setUpdateMatrix(t===null)}set value(e){this.referenceNode?this.referenceNode.value=e:this._value=e}get value(){return this.referenceNode?this.referenceNode.value:this._value}getUniformHash(){return this.value.uuid}getNodeType(){return this.value.isDepthTexture===!0?"float":this.value.type===dt?"uvec4":this.value.type===Pt?"ivec4":"vec4"}getInputType(){return"texture"}getDefaultUV(){return Us(this.value.channel)}updateReference(){return this.value}getTransformedUV(e){return this._matrixUniform===null&&(this._matrixUniform=pe(this.value.matrix)),this._matrixUniform.mul(X(e,1)).xy}setUpdateMatrix(e){return this.updateMatrix=e,this}setupUV(e,t){return e.isFlipY()&&(this._flipYUniform===null&&(this._flipYUniform=pe(!1)),t=t.toVar(),this.sampler?t=this._flipYUniform.select(t.flipY(),t):t=this._flipYUniform.select(t.setY(ze(Ei(this,this.levelNode).y).sub(t.y).sub(1)),t)),t}setup(e){const t=e.getNodeProperties(this);t.referenceNode=this.referenceNode;const r=this.value;if(!r||r.isTexture!==!0)throw new Error("THREE.TSL: `texture( value )` function expects a valid instance of THREE.Texture().");const i=Q(()=>{let o=this.uvNode;return(o===null||e.context.forceUVContext===!0)&&e.context.getUV&&(o=e.context.getUV(this,e)),o||(o=this.getDefaultUV()),this.updateMatrix===!0&&(o=this.getTransformedUV(o)),o=this.setupUV(e,o),this.updateType=this._matrixUniform!==null||this._flipYUniform!==null?_e.OBJECT:_e.NONE,o})();let s=this.levelNode;s===null&&e.context.getTextureLevel&&(s=e.context.getTextureLevel(this)),t.uvNode=i,t.levelNode=s,t.biasNode=this.biasNode,t.compareNode=this.compareNode,t.gradNode=this.gradNode,t.depthNode=this.depthNode,t.offsetNode=this.offsetNode}generateUV(e,t){return t.build(e,this.sampler===!0?"vec2":"ivec2")}generateOffset(e,t){return t.build(e,"ivec2")}generateSnippet(e,t,r,i,s,o,a,c,l){const u=this.value;let d;return s?d=e.generateTextureBias(u,t,r,s,o,l):c?d=e.generateTextureGrad(u,t,r,c,o,l):a?d=e.generateTextureCompare(u,t,r,a,o,l):this.sampler===!1?d=e.generateTextureLoad(u,t,r,i,o,l):i?d=e.generateTextureLevel(u,t,r,i,o,l):d=e.generateTexture(u,t,r,o,l),d}generate(e,t){const r=this.value,i=e.getNodeProperties(this),s=super.generate(e,"property");if(/^sampler/.test(t))return s+"_sampler";if(e.isReference(t))return s;{const o=e.getDataFromNode(this);let a=o.propertyName;if(a===void 0){const{uvNode:u,levelNode:d,biasNode:h,compareNode:f,depthNode:p,gradNode:g,offsetNode:x}=i,m=this.generateUV(e,u),y=d?d.build(e,"float"):null,_=h?h.build(e,"float"):null,v=p?p.build(e,"int"):null,T=f?f.build(e,"float"):null,w=g?[g[0].build(e,"vec2"),g[1].build(e,"vec2")]:null,N=x?this.generateOffset(e,x):null,E=e.getVarFromNode(this);a=e.getPropertyName(E);const A=this.generateSnippet(e,s,m,y,_,v,T,w,N);e.addLineFlowCode(`${a} = ${A}`,this),o.snippet=A,o.propertyName=a}let c=a;const l=this.getNodeType(e);return e.needsToWorkingColorSpace(r)&&(c=sp(Ms(c,l),r.colorSpace).setup(e).build(e,l)),e.format(c,l,t)}}setSampler(e){return this.sampler=e,this}getSampler(){return this.sampler}uv(e){return se("TextureNode: .uv() has been renamed. Use .sample() instead."),this.sample(e)}sample(e){const t=this.clone();return t.uvNode=J(e),t.referenceNode=this.getBase(),J(t)}load(e){return this.sample(e).setSampler(!1)}blur(e){const t=this.clone();t.biasNode=J(e).mul(TI(t)),t.referenceNode=this.getBase();const r=t.value;return t.generateMipmaps===!1&&(r&&r.generateMipmaps===!1||r.minFilter===xn||r.magFilter===xn)&&(se("TSL: texture().blur() requires mipmaps and sampling. Use .generateMipmaps=true and .minFilter/.magFilter=THREE.LinearFilter in the Texture."),t.biasNode=null),J(t)}level(e){const t=this.clone();return t.levelNode=J(e),t.referenceNode=this.getBase(),J(t)}size(e){return Ei(this,e)}bias(e){const t=this.clone();return t.biasNode=J(e),t.referenceNode=this.getBase(),J(t)}getBase(){return this.referenceNode?this.referenceNode.getBase():this}compare(e){const t=this.clone();return t.compareNode=J(e),t.referenceNode=this.getBase(),J(t)}grad(e,t){const r=this.clone();return r.gradNode=[J(e),J(t)],r.referenceNode=this.getBase(),J(r)}depth(e){const t=this.clone();return t.depthNode=J(e),t.referenceNode=this.getBase(),J(t)}offset(e){const t=this.clone();return t.offsetNode=J(e),t.referenceNode=this.getBase(),J(t)}serialize(e){super.serialize(e),e.value=this.value.toJSON(e.meta).uuid,e.sampler=this.sampler,e.updateMatrix=this.updateMatrix,e.updateType=this.updateType}deserialize(e){super.deserialize(e),this.value=e.meta.textures[e.value],this.sampler=e.sampler,this.updateMatrix=e.updateMatrix,this.updateType=e.updateType}update(){const e=this.value,t=this._matrixUniform;t!==null&&(t.value=e.matrix),e.matrixAutoUpdate===!0&&e.updateMatrix();const r=this._flipYUniform;r!==null&&(r.value=e.image instanceof ImageBitmap&&e.flipY===!0||e.isRenderTargetTexture===!0||e.isFramebufferTexture===!0||e.isDepthTexture===!0)}clone(){const e=new this.constructor(this.value,this.uvNode,this.levelNode,this.biasNode);return e.sampler=this.sampler,e.depthNode=this.depthNode,e.compareNode=this.compareNode,e.gradNode=this.gradNode,e.offsetNode=this.offsetNode,e}}const wI=Pe(Gs).setParameterLength(1,4).setName("texture"),Ae=(n=Fv,e=null,t=null,r=null)=>{let i;return n&&n.isTextureNode===!0?(i=J(n.clone()),i.referenceNode=n.getBase(),e!==null&&(i.uvNode=J(e)),t!==null&&(i.levelNode=J(t)),r!==null&&(i.biasNode=J(r))):i=wI(n,e,t,r),i},en=(...n)=>Ae(...n).setSampler(!1);class kv extends pa{static get type(){return"BufferNode"}constructor(e,t,r=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferCount=r}getElementType(e){return this.getNodeType(e)}getInputType(){return"buffer"}}const Iv=(n,e,t)=>J(new kv(n,e,t));class SI extends fa{static get type(){return"UniformArrayElementNode"}constructor(e,t){super(e,t),this.isArrayBufferElementNode=!0}generate(e){const t=super.generate(e),r=this.getNodeType(),i=this.node.getPaddedType();return e.format(t,i,r)}}class NI extends kv{static get type(){return"UniformArrayNode"}constructor(e,t=null){super(null),this.array=e,this.elementType=t===null?nl(e[0]):t,this.paddedType=this.getPaddedType(),this.updateType=_e.RENDER,this.isArrayBufferNode=!0}getNodeType(){return this.paddedType}getElementType(){return this.elementType}getPaddedType(){const e=this.elementType;let t="vec4";return e==="mat2"?t="mat2":/mat/.test(e)===!0?t="mat4":e.charAt(0)==="i"?t="ivec4":e.charAt(0)==="u"&&(t="uvec4"),t}update(){const{array:e,value:t}=this,r=this.elementType;if(r==="float"||r==="int"||r==="uint")for(let i=0;i<e.length;i++){const s=i*4;t[s]=e[i]}else if(r==="color")for(let i=0;i<e.length;i++){const s=i*4,o=e[i];t[s]=o.r,t[s+1]=o.g,t[s+2]=o.b||0}else if(r==="mat2")for(let i=0;i<e.length;i++){const s=i*4,o=e[i];t[s]=o.elements[0],t[s+1]=o.elements[1],t[s+2]=o.elements[2],t[s+3]=o.elements[3]}else if(r==="mat3")for(let i=0;i<e.length;i++){const s=i*16,o=e[i];t[s]=o.elements[0],t[s+1]=o.elements[1],t[s+2]=o.elements[2],t[s+4]=o.elements[3],t[s+5]=o.elements[4],t[s+6]=o.elements[5],t[s+8]=o.elements[6],t[s+9]=o.elements[7],t[s+10]=o.elements[8],t[s+15]=1}else if(r==="mat4")for(let i=0;i<e.length;i++){const s=i*16,o=e[i];for(let a=0;a<o.elements.length;a++)t[s+a]=o.elements[a]}else for(let i=0;i<e.length;i++){const s=i*4,o=e[i];t[s]=o.x,t[s+1]=o.y,t[s+2]=o.z||0,t[s+3]=o.w||0}}setup(e){const t=this.array.length,r=this.elementType;let i=Float32Array;const s=this.paddedType,o=e.getTypeLength(s);return r.charAt(0)==="i"&&(i=Int32Array),r.charAt(0)==="u"&&(i=Uint32Array),this.value=new i(t*o),this.bufferCount=t,this.bufferType=s,super.setup(e)}element(e){return J(new SI(this,J(e)))}}const bn=(n,e)=>J(new NI(n,e));class EI extends ce{constructor(e){super("float"),this.name=e,this.isBuiltinNode=!0}generate(){return this.name}}const ga=Pe(EI).setParameterLength(1);let io,so;class Ge extends ce{static get type(){return"ScreenNode"}constructor(e){super(),this.scope=e,this._output=null,this.isViewportNode=!0}getNodeType(){return this.scope===Ge.DPR?"float":this.scope===Ge.VIEWPORT?"vec4":"vec2"}getUpdateType(){let e=_e.NONE;return(this.scope===Ge.SIZE||this.scope===Ge.VIEWPORT||this.scope===Ge.DPR)&&(e=_e.RENDER),this.updateType=e,e}update({renderer:e}){const t=e.getRenderTarget();this.scope===Ge.VIEWPORT?t!==null?so.copy(t.viewport):(e.getViewport(so),so.multiplyScalar(e.getPixelRatio())):this.scope===Ge.DPR?this._output.value=e.getPixelRatio():t!==null?(io.width=t.width,io.height=t.height):e.getDrawingBufferSize(io)}setup(){const e=this.scope;let t=null;return e===Ge.SIZE?t=pe(io||(io=new Te)):e===Ge.VIEWPORT?t=pe(so||(so=new Ze)):e===Ge.DPR?t=pe(1):t=ne(Ll.div(Ph)),this._output=t,t}generate(e){if(this.scope===Ge.COORDINATE){let t=e.getFragCoord();if(e.isFlipY()){const r=e.getNodeProperties(Ph).outputNode.build(e);t=`${e.getType("vec2")}( ${t}.x, ${r}.y - ${t}.y )`}return t}return super.generate(e)}}Ge.COORDINATE="coordinate";Ge.VIEWPORT="viewport";Ge.SIZE="size";Ge.UV="uv";Ge.DPR="dpr";const AI=re(Ge,Ge.DPR),ys=re(Ge,Ge.UV),Ph=re(Ge,Ge.SIZE),Ll=re(Ge,Ge.COORDINATE),Lv=re(Ge,Ge.VIEWPORT),RI=Lv.zw;Lv.xy;const ap=pe(0,"uint").setName("u_cameraIndex").setGroup(ep("cameraIndex")).toVarying("v_cameraIndex"),hi=pe("float").setName("cameraNear").setGroup(fe).onRenderUpdate(({camera:n})=>n.near),fi=pe("float").setName("cameraFar").setGroup(fe).onRenderUpdate(({camera:n})=>n.far),Ov=Q(({camera:n})=>{let e;if(n.isArrayCamera&&n.cameras.length>0){const t=[];for(const i of n.cameras)t.push(i.projectionMatrix);e=bn(t).setGroup(fe).setName("cameraProjectionMatrices").element(n.isMultiViewCamera?ga("gl_ViewID_OVR"):ap).toConst("cameraProjectionMatrix")}else e=pe("mat4").setName("cameraProjectionMatrix").setGroup(fe).onRenderUpdate(({camera:t})=>t.projectionMatrix);return e}).once()(),wr=Q(({camera:n})=>{let e;if(n.isArrayCamera&&n.cameras.length>0){const t=[];for(const i of n.cameras)t.push(i.matrixWorldInverse);e=bn(t).setGroup(fe).setName("cameraViewMatrices").element(n.isMultiViewCamera?ga("gl_ViewID_OVR"):ap).toConst("cameraViewMatrix")}else e=pe("mat4").setName("cameraViewMatrix").setGroup(fe).onRenderUpdate(({camera:t})=>t.matrixWorldInverse);return e}).once()(),CI=Q(({camera:n})=>{let e;if(n.isArrayCamera&&n.cameras.length>0){const t=[];for(let i=0,s=n.cameras.length;i<s;i++)t.push(new le);e=bn(t).setGroup(fe).setName("cameraPositions").onRenderUpdate(({camera:i},s)=>{const o=i.cameras,a=s.array;for(let c=0,l=o.length;c<l;c++)a[c].setFromMatrixPosition(o[c].matrixWorld)}).element(n.isMultiViewCamera?ga("gl_ViewID_OVR"):ap).toConst("cameraPosition")}else e=pe(new le).setName("cameraPosition").setGroup(fe).onRenderUpdate(({camera:t},r)=>r.value.setFromMatrixPosition(t.matrixWorld));return e}).once()(),Hm=new ES;class Ie extends ce{static get type(){return"Object3DNode"}constructor(e,t=null){super(),this.scope=e,this.object3d=t,this.updateType=_e.OBJECT,this.uniformNode=new pa(null)}getNodeType(){const e=this.scope;if(e===Ie.WORLD_MATRIX)return"mat4";if(e===Ie.POSITION||e===Ie.VIEW_POSITION||e===Ie.DIRECTION||e===Ie.SCALE)return"vec3";if(e===Ie.RADIUS)return"float"}update(e){const t=this.object3d,r=this.uniformNode,i=this.scope;if(i===Ie.WORLD_MATRIX)r.value=t.matrixWorld;else if(i===Ie.POSITION)r.value=r.value||new le,r.value.setFromMatrixPosition(t.matrixWorld);else if(i===Ie.SCALE)r.value=r.value||new le,r.value.setFromMatrixScale(t.matrixWorld);else if(i===Ie.DIRECTION)r.value=r.value||new le,t.getWorldDirection(r.value);else if(i===Ie.VIEW_POSITION){const s=e.camera;r.value=r.value||new le,r.value.setFromMatrixPosition(t.matrixWorld),r.value.applyMatrix4(s.matrixWorldInverse)}else if(i===Ie.RADIUS){const s=e.object.geometry;s.boundingSphere===null&&s.computeBoundingSphere(),Hm.copy(s.boundingSphere).applyMatrix4(t.matrixWorld),r.value=Hm.radius}}generate(e){const t=this.scope;return t===Ie.WORLD_MATRIX?this.uniformNode.nodeType="mat4":t===Ie.POSITION||t===Ie.VIEW_POSITION||t===Ie.DIRECTION||t===Ie.SCALE?this.uniformNode.nodeType="vec3":t===Ie.RADIUS&&(this.uniformNode.nodeType="float"),this.uniformNode.build(e)}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}}Ie.WORLD_MATRIX="worldMatrix";Ie.POSITION="position";Ie.SCALE="scale";Ie.VIEW_POSITION="viewPosition";Ie.DIRECTION="direction";Ie.RADIUS="radius";const MI=Pe(Ie,Ie.POSITION).setParameterLength(1);class ln extends Ie{static get type(){return"ModelNode"}constructor(e){super(e)}update(e){this.object3d=e.object,super.update(e)}}ln.DIRECTION;const Di=re(ln,ln.WORLD_MATRIX);ln.POSITION;ln.SCALE;ln.VIEW_POSITION;ln.RADIUS;const PI=pe(new oa).onObjectUpdate(({object:n},e)=>e.value.getNormalMatrix(n.matrixWorld)),Ol=Q(n=>n.renderer.overrideNodes.modelViewMatrix||DI).once()().toVar("modelViewMatrix"),DI=wr.mul(Di),Wm=Q(n=>(n.context.isHighPrecisionModelViewMatrix=!0,pe("mat4").onObjectUpdate(({object:e,camera:t})=>e.modelViewMatrix.multiplyMatrices(t.matrixWorldInverse,e.matrixWorld)))).once()().toVar("highpModelViewMatrix"),qm=Q(n=>{const e=n.context.isHighPrecisionModelViewMatrix;return pe("mat3").onObjectUpdate(({object:t,camera:r})=>(e!==!0&&t.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,t.matrixWorld),t.normalMatrix.getNormalMatrix(t.modelViewMatrix)))}).once()().toVar("highpModelNormalViewMatrix"),Ul=jr("position","vec3"),Rt=Ul.toVarying("positionLocal"),Xm=Ul.toVarying("positionPrevious"),Ps=Q(n=>Di.mul(Rt).xyz.toVarying(n.getSubBuildProperty("v_positionWorld")),"vec3").once(["POSITION"])(),Uv=Q(()=>Rt.transformDirection(Di).toVarying("v_positionWorldDirection").normalize().toVar("positionWorldDirection"),"vec3").once(["POSITION"])(),ot=Q(n=>n.context.setupPositionView().toVarying("v_positionView"),"vec3").once(["POSITION"])(),Ke=Q(n=>{let e;return n.camera.isOrthographicCamera?e=X(0,0,1):e=ot.negate().toVarying("v_positionViewDirection").normalize(),e.toVar("positionViewDirection")},"vec3").once(["POSITION"])();class BI extends ce{static get type(){return"FrontFacingNode"}constructor(){super("bool"),this.isFrontFacingNode=!0}generate(e){if(e.shaderStage!=="fragment")return"true";const{material:t}=e;return t.side===jt?"false":e.getFrontFacing()}}const FI=re(BI),Gv=j(FI).mul(2).sub(1),ma=Q(([n],{material:e})=>{const t=e.side;return t===jt?n=n.mul(-1):t===vi&&(n=n.mul(Gv)),n}),$v=jr("normal","vec3"),Wn=Q(n=>n.geometry.hasAttribute("normal")===!1?(se('TSL: Vertex attribute "normal" not found on geometry.'),X(0,1,0)):$v,"vec3").once()().toVar("normalLocal"),kI=ot.dFdx().cross(ot.dFdy()).normalize().toVar("normalFlat"),Zo=Q(n=>{let e;return n.material.flatShading===!0?e=kI:e=Vv(Wn).toVarying("v_normalViewGeometry").normalize(),e},"vec3").once()().toVar("normalViewGeometry"),II=Q(n=>{let e=Zo.transformDirection(wr);return n.material.flatShading!==!0&&(e=e.toVarying("v_normalWorldGeometry")),e.normalize().toVar("normalWorldGeometry")},"vec3").once()(),Fe=Q(({subBuildFn:n,material:e,context:t})=>{let r;return n==="NORMAL"||n==="VERTEX"?(r=Zo,e.flatShading!==!0&&(r=ma(r))):r=t.setupNormal().context({getUV:null}),r},"vec3").once(["NORMAL","VERTEX"])().toVar("normalView"),$s=Fe.transformDirection(wr).toVar("normalWorld"),as=Q(({subBuildFn:n,context:e})=>{let t;return n==="NORMAL"||n==="VERTEX"?t=Fe:t=e.setupClearcoatNormal().context({getUV:null}),t},"vec3").once(["NORMAL","VERTEX"])().toVar("clearcoatNormalView"),LI=Q(([n,e=Di])=>{const t=kt(e),r=n.div(X(t[0].dot(t[0]),t[1].dot(t[1]),t[2].dot(t[2])));return t.mul(r).xyz}),Vv=Q(([n],e)=>{const t=e.renderer.overrideNodes.modelNormalViewMatrix;if(t!==null)return t.transformDirection(n);const r=PI.mul(n);return wr.transformDirection(r)});Q(()=>(se('TSL: "transformedNormalView" is deprecated. Use "normalView" instead.'),Fe)).once(["NORMAL","VERTEX"])();Q(()=>(se('TSL: "transformedNormalWorld" is deprecated. Use "normalWorld" instead.'),$s)).once(["NORMAL","VERTEX"])();Q(()=>(se('TSL: "transformedClearcoatNormalView" is deprecated. Use "clearcoatNormalView" instead.'),as)).once(["NORMAL","VERTEX"])();const Ym=new My,Pu=new En,OI=pe(0).onReference(({material:n})=>n).onObjectUpdate(({material:n})=>n.refractionRatio),Du=pe(1).onReference(({material:n})=>n).onObjectUpdate(function({material:n,scene:e}){return n.envMap?n.envMapIntensity:e.environmentIntensity}),zv=pe(new En).onReference(function(n){return n.material}).onObjectUpdate(function({material:n,scene:e}){const t=e.environment!==null&&n.envMap===null?e.environmentRotation:n.envMapRotation;return t?(Ym.copy(t),Pu.makeRotationFromEuler(Ym)):Pu.identity(),Pu}),UI=Ke.negate().reflect(Fe),GI=Ke.negate().refract(Fe,OI),$I=UI.transformDirection(wr).toVar("reflectVector"),VI=GI.transformDirection(wr).toVar("reflectVector"),zI=new cf;class jI extends Gs{static get type(){return"CubeTextureNode"}constructor(e,t=null,r=null,i=null){super(e,t,r,i),this.isCubeTextureNode=!0}getInputType(){return"cubeTexture"}getDefaultUV(){const e=this.value;return e.mapping===Lc?$I:e.mapping===Oc?VI:(ie('CubeTextureNode: Mapping "%s" not supported.',e.mapping),X(0,0,0))}setUpdateMatrix(){}setupUV(e,t){const r=this.value;return(e.renderer.coordinateSystem===_l||!r.isRenderTargetTexture)&&(t=X(t.x.negate(),t.yz)),zv.mul(t)}generateUV(e,t){return t.build(e,this.sampler===!0?"vec3":"ivec3")}}const HI=Pe(jI).setParameterLength(1,4).setName("cubeTexture"),Jo=(n=zI,e=null,t=null,r=null)=>{let i;return n&&n.isCubeTextureNode===!0?(i=J(n.clone()),i.referenceNode=n,e!==null&&(i.uvNode=J(e)),t!==null&&(i.levelNode=J(t)),r!==null&&(i.biasNode=J(r))):i=HI(n,e,t,r),i};class WI extends fa{static get type(){return"ReferenceElementNode"}constructor(e,t){super(e,t),this.referenceNode=e,this.isReferenceElementNode=!0}getNodeType(){return this.referenceNode.uniformType}generate(e){const t=super.generate(e),r=this.referenceNode.getNodeType(),i=this.getNodeType();return e.format(t,r,i)}}class cp extends ce{static get type(){return"ReferenceNode"}constructor(e,t,r=null,i=null){super(),this.property=e,this.uniformType=t,this.object=r,this.count=i,this.properties=e.split("."),this.reference=r,this.node=null,this.group=null,this.name=null,this.updateType=_e.OBJECT}element(e){return J(new WI(this,J(e)))}setGroup(e){return this.group=e,this}setName(e){return this.name=e,this}label(e){return se('TSL: "label()" has been deprecated. Use "setName()" instead.'),this.setName(e)}setNodeType(e){let t=null;this.count!==null?t=Iv(null,e,this.count):Array.isArray(this.getValueFromReference())?t=bn(null,e):e==="texture"?t=Ae(null):e==="cubeTexture"?t=Jo(null):t=pe(null,e),this.group!==null&&t.setGroup(this.group),this.name!==null&&t.setName(this.name),this.node=t}getNodeType(e){return this.node===null&&(this.updateReference(e),this.updateValue()),this.node.getNodeType(e)}getValueFromReference(e=this.reference){const{properties:t}=this;let r=e[t[0]];for(let i=1;i<t.length;i++)r=r[t[i]];return r}updateReference(e){return this.reference=this.object!==null?this.object:e.object,this.reference}setup(){return this.updateValue(),this.node}update(){this.updateValue()}updateValue(){this.node===null&&this.setNodeType(this.uniformType);const e=this.getValueFromReference();Array.isArray(e)?this.node.array=e:this.node.value=e}}const Oe=(n,e,t)=>J(new cp(n,e,t)),Km=(n,e,t,r)=>J(new cp(n,e,r,t));class qI extends cp{static get type(){return"MaterialReferenceNode"}constructor(e,t,r=null){super(e,t,r),this.material=r,this.isMaterialReferenceNode=!0}updateReference(e){return this.reference=this.material!==null?this.material:e.material,this.reference}}const Dr=(n,e,t=null)=>J(new qI(n,e,t)),jv=Us(),XI=ot.dFdx(),YI=ot.dFdy(),Hv=jv.dFdx(),Wv=jv.dFdy(),qv=Fe,Xv=YI.cross(qv),Yv=qv.cross(XI),Dh=Xv.mul(Hv.x).add(Yv.mul(Wv.x)),Bh=Xv.mul(Hv.y).add(Yv.mul(Wv.y)),Qm=Dh.dot(Dh).max(Bh.dot(Bh)),Kv=Qm.equal(0).select(0,Qm.inverseSqrt()),KI=Dh.mul(Kv).toVar("tangentViewFrame"),QI=Bh.mul(Kv).toVar("bitangentViewFrame"),Qv=Q(n=>(n.geometry.hasAttribute("tangent")===!1&&n.geometry.computeTangents(),jr("tangent","vec4")))(),lp=Qv.xyz.toVar("tangentLocal"),Zv=Q(({subBuildFn:n,geometry:e,material:t})=>{let r;return n==="VERTEX"||e.hasAttribute("tangent")?r=Ol.mul(be(lp,0)).xyz.toVarying("v_tangentView").normalize():r=KI,t.flatShading!==!0&&(r=ma(r)),r},"vec3").once(["NORMAL","VERTEX"])().toVar("tangentView"),ZI=Q(([n,e],{subBuildFn:t,material:r})=>{let i=n.mul(Qv.w).xyz;return t==="NORMAL"&&r.flatShading!==!0&&(i=i.toVarying(e)),i}).once(["NORMAL"]),JI=Q(({subBuildFn:n,geometry:e,material:t})=>{let r;return n==="VERTEX"||e.hasAttribute("tangent")?r=ZI(Fe.cross(Zv),"v_bitangentView").normalize():r=QI,t.flatShading!==!0&&(r=ma(r)),r},"vec3").once(["NORMAL","VERTEX"])().toVar("bitangentView"),So=kt(Zv,JI,Fe).toVar("TBNViewMatrix"),eL=Q(()=>{let n=xs.cross(Ke);return n=n.cross(xs).normalize(),n=He(n,Fe,li.mul(ur.oneMinus()).oneMinus().pow2().pow2()).normalize(),n}).once()();class tL extends mt{static get type(){return"NormalMapNode"}constructor(e,t=null){super("vec3"),this.node=e,this.scaleNode=t,this.normalMapType=Op}setup({material:e}){const{normalMapType:t,scaleNode:r}=this;let i=this.node.mul(2).sub(1);if(r!==null){let o=r;e.flatShading===!0&&(o=ma(o)),i=X(i.xy.mul(o),i.z)}let s=null;return t===AS?s=Vv(i):t===Op?s=So.mul(i).normalize():(ie(`NodeMaterial: Unsupported normal map type: ${t}`),s=Fe),s}}const Zm=Pe(tL).setParameterLength(1,2),nL=Q(({textureNode:n,bumpScale:e})=>{const t=i=>n.isolate().context({getUV:s=>i(s.uvNode||Us()),forceUVContext:!0}),r=j(t(i=>i));return ne(j(t(i=>i.add(i.dFdx()))).sub(r),j(t(i=>i.add(i.dFdy()))).sub(r)).mul(e)}),rL=Q(n=>{const{surf_pos:e,surf_norm:t,dHdxy:r}=n,i=e.dFdx().normalize(),s=e.dFdy().normalize(),o=t,a=s.cross(o),c=o.cross(i),l=i.dot(a).mul(Gv),u=l.sign().mul(r.x.mul(a).add(r.y.mul(c)));return l.abs().mul(t).sub(u).normalize()});class iL extends mt{static get type(){return"BumpMapNode"}constructor(e,t=null){super("vec3"),this.textureNode=e,this.scaleNode=t}setup(){const e=this.scaleNode!==null?this.scaleNode:1,t=nL({textureNode:this.textureNode,bumpScale:e});return rL({surf_pos:ot,surf_norm:Fe,dHdxy:t})}}const sL=Pe(iL).setParameterLength(1,2),Jm=new Map;class q extends ce{static get type(){return"MaterialNode"}constructor(e){super(),this.scope=e}getCache(e,t){let r=Jm.get(e);return r===void 0&&(r=Dr(e,t),Jm.set(e,r)),r}getFloat(e){return this.getCache(e,"float")}getColor(e){return this.getCache(e,"color")}getTexture(e){return this.getCache(e==="map"?"map":e+"Map","texture")}setup(e){const t=e.context.material,r=this.scope;let i=null;if(r===q.COLOR){const s=t.color!==void 0?this.getColor(r):X();t.map&&t.map.isTexture===!0?i=s.mul(this.getTexture("map")):i=s}else if(r===q.OPACITY){const s=this.getFloat(r);t.alphaMap&&t.alphaMap.isTexture===!0?i=s.mul(this.getTexture("alpha")):i=s}else if(r===q.SPECULAR_STRENGTH)t.specularMap&&t.specularMap.isTexture===!0?i=this.getTexture("specular").r:i=j(1);else if(r===q.SPECULAR_INTENSITY){const s=this.getFloat(r);t.specularIntensityMap&&t.specularIntensityMap.isTexture===!0?i=s.mul(this.getTexture(r).a):i=s}else if(r===q.SPECULAR_COLOR){const s=this.getColor(r);t.specularColorMap&&t.specularColorMap.isTexture===!0?i=s.mul(this.getTexture(r).rgb):i=s}else if(r===q.ROUGHNESS){const s=this.getFloat(r);t.roughnessMap&&t.roughnessMap.isTexture===!0?i=s.mul(this.getTexture(r).g):i=s}else if(r===q.METALNESS){const s=this.getFloat(r);t.metalnessMap&&t.metalnessMap.isTexture===!0?i=s.mul(this.getTexture(r).b):i=s}else if(r===q.EMISSIVE){const s=this.getFloat("emissiveIntensity"),o=this.getColor(r).mul(s);t.emissiveMap&&t.emissiveMap.isTexture===!0?i=o.mul(this.getTexture(r)):i=o}else if(r===q.NORMAL)t.normalMap?(i=Zm(this.getTexture("normal"),this.getCache("normalScale","vec2")),i.normalMapType=t.normalMapType):t.bumpMap?i=sL(this.getTexture("bump").r,this.getFloat("bumpScale")):i=Fe;else if(r===q.CLEARCOAT){const s=this.getFloat(r);t.clearcoatMap&&t.clearcoatMap.isTexture===!0?i=s.mul(this.getTexture(r).r):i=s}else if(r===q.CLEARCOAT_ROUGHNESS){const s=this.getFloat(r);t.clearcoatRoughnessMap&&t.clearcoatRoughnessMap.isTexture===!0?i=s.mul(this.getTexture(r).r):i=s}else if(r===q.CLEARCOAT_NORMAL)t.clearcoatNormalMap?i=Zm(this.getTexture(r),this.getCache(r+"Scale","vec2")):i=Fe;else if(r===q.SHEEN){const s=this.getColor("sheenColor").mul(this.getFloat("sheen"));t.sheenColorMap&&t.sheenColorMap.isTexture===!0?i=s.mul(this.getTexture("sheenColor").rgb):i=s}else if(r===q.SHEEN_ROUGHNESS){const s=this.getFloat(r);t.sheenRoughnessMap&&t.sheenRoughnessMap.isTexture===!0?i=s.mul(this.getTexture(r).a):i=s,i=i.clamp(.07,1)}else if(r===q.ANISOTROPY)if(t.anisotropyMap&&t.anisotropyMap.isTexture===!0){const s=this.getTexture(r);i=Qf(oo.x,oo.y,oo.y.negate(),oo.x).mul(s.rg.mul(2).sub(ne(1)).normalize().mul(s.b))}else i=oo;else if(r===q.IRIDESCENCE_THICKNESS){const s=Oe("1","float",t.iridescenceThicknessRange);if(t.iridescenceThicknessMap){const o=Oe("0","float",t.iridescenceThicknessRange);i=s.sub(o).mul(this.getTexture(r).g).add(o)}else i=s}else if(r===q.TRANSMISSION){const s=this.getFloat(r);t.transmissionMap?i=s.mul(this.getTexture(r).r):i=s}else if(r===q.THICKNESS){const s=this.getFloat(r);t.thicknessMap?i=s.mul(this.getTexture(r).g):i=s}else if(r===q.IOR)i=this.getFloat(r);else if(r===q.LIGHT_MAP)i=this.getTexture(r).rgb.mul(this.getFloat("lightMapIntensity"));else if(r===q.AO)i=this.getTexture(r).r.sub(1).mul(this.getFloat("aoMapIntensity")).add(1);else if(r===q.LINE_DASH_OFFSET)i=t.dashOffset?this.getFloat(r):j(0);else{const s=this.getNodeType(e);i=this.getCache(r,s)}return i}}q.ALPHA_TEST="alphaTest";q.COLOR="color";q.OPACITY="opacity";q.SHININESS="shininess";q.SPECULAR="specular";q.SPECULAR_STRENGTH="specularStrength";q.SPECULAR_INTENSITY="specularIntensity";q.SPECULAR_COLOR="specularColor";q.REFLECTIVITY="reflectivity";q.ROUGHNESS="roughness";q.METALNESS="metalness";q.NORMAL="normal";q.CLEARCOAT="clearcoat";q.CLEARCOAT_ROUGHNESS="clearcoatRoughness";q.CLEARCOAT_NORMAL="clearcoatNormal";q.EMISSIVE="emissive";q.ROTATION="rotation";q.SHEEN="sheen";q.SHEEN_ROUGHNESS="sheenRoughness";q.ANISOTROPY="anisotropy";q.IRIDESCENCE="iridescence";q.IRIDESCENCE_IOR="iridescenceIOR";q.IRIDESCENCE_THICKNESS="iridescenceThickness";q.IOR="ior";q.TRANSMISSION="transmission";q.THICKNESS="thickness";q.ATTENUATION_DISTANCE="attenuationDistance";q.ATTENUATION_COLOR="attenuationColor";q.LINE_SCALE="scale";q.LINE_DASH_SIZE="dashSize";q.LINE_GAP_SIZE="gapSize";q.LINE_WIDTH="linewidth";q.LINE_DASH_OFFSET="dashOffset";q.POINT_SIZE="size";q.DISPERSION="dispersion";q.LIGHT_MAP="light";q.AO="ao";const oL=re(q,q.ALPHA_TEST),aL=re(q,q.COLOR),cL=re(q,q.SHININESS),lL=re(q,q.EMISSIVE),Jv=re(q,q.OPACITY),uL=re(q,q.SPECULAR),e0=re(q,q.SPECULAR_INTENSITY),dL=re(q,q.SPECULAR_COLOR),Rc=re(q,q.SPECULAR_STRENGTH),Bu=re(q,q.REFLECTIVITY),hL=re(q,q.ROUGHNESS),fL=re(q,q.METALNESS),pL=re(q,q.NORMAL),gL=re(q,q.CLEARCOAT),mL=re(q,q.CLEARCOAT_ROUGHNESS),xL=re(q,q.CLEARCOAT_NORMAL),yL=re(q,q.ROTATION),bL=re(q,q.SHEEN),_L=re(q,q.SHEEN_ROUGHNESS),vL=re(q,q.ANISOTROPY),TL=re(q,q.IRIDESCENCE),wL=re(q,q.IRIDESCENCE_IOR),SL=re(q,q.IRIDESCENCE_THICKNESS),NL=re(q,q.TRANSMISSION),EL=re(q,q.THICKNESS),AL=re(q,q.IOR),RL=re(q,q.ATTENUATION_DISTANCE),CL=re(q,q.ATTENUATION_COLOR),ML=re(q,q.LINE_SCALE),PL=re(q,q.LINE_DASH_SIZE),DL=re(q,q.LINE_GAP_SIZE);q.LINE_WIDTH;const BL=re(q,q.LINE_DASH_OFFSET),FL=re(q,q.POINT_SIZE),kL=re(q,q.DISPERSION),eT=re(q,q.LIGHT_MAP),IL=re(q,q.AO),oo=pe(new Te).onReference(function(n){return n.material}).onRenderUpdate(function({material:n}){this.value.set(n.anisotropy*Math.cos(n.anisotropyRotation),n.anisotropy*Math.sin(n.anisotropyRotation))}),tT=Q(n=>n.context.setupModelViewProjection(),"vec4").once()().toVarying("v_modelViewProjection");class We extends ce{static get type(){return"IndexNode"}constructor(e){super("uint"),this.scope=e,this.isIndexNode=!0}generate(e){const t=this.getNodeType(e),r=this.scope;let i;if(r===We.VERTEX)i=e.getVertexIndex();else if(r===We.INSTANCE)i=e.getInstanceIndex();else if(r===We.DRAW)i=e.getDrawIndex();else if(r===We.INVOCATION_LOCAL)i=e.getInvocationLocalIndex();else if(r===We.INVOCATION_SUBGROUP)i=e.getInvocationSubgroupIndex();else if(r===We.SUBGROUP)i=e.getSubgroupIndex();else throw new Error("THREE.IndexNode: Unknown scope: "+r);let s;return e.shaderStage==="vertex"||e.shaderStage==="compute"?s=i:s=Hr(this).build(e,t),s}}We.VERTEX="vertex";We.INSTANCE="instance";We.SUBGROUP="subgroup";We.INVOCATION_LOCAL="invocationLocal";We.INVOCATION_SUBGROUP="invocationSubgroup";We.DRAW="draw";const LL=re(We,We.VERTEX),up=re(We,We.INSTANCE);We.SUBGROUP;We.INVOCATION_SUBGROUP;We.INVOCATION_LOCAL;const OL=re(We,We.DRAW);class UL extends ce{static get type(){return"InstanceNode"}constructor(e,t,r=null){super("void"),this.count=e,this.instanceMatrix=t,this.instanceColor=r,this.instanceMatrixNode=null,this.instanceColorNode=null,this.updateType=_e.FRAME,this.buffer=null,this.bufferColor=null}setup(e){const{instanceMatrix:t,instanceColor:r}=this,{count:i}=t;let{instanceMatrixNode:s,instanceColorNode:o}=this;if(s===null){if(i<=1e3)s=Iv(t.array,"mat4",Math.max(i,1)).element(up);else{const c=new RS(t.array,16,1);this.buffer=c;const l=t.usage===rs?jm:zm,u=[l(c,"vec4",16,0),l(c,"vec4",16,4),l(c,"vec4",16,8),l(c,"vec4",16,12)];s=ms(...u)}this.instanceMatrixNode=s}if(r&&o===null){const c=new CS(r.array,3),l=r.usage===rs?jm:zm;this.bufferColor=c,o=X(l(c,"vec3",3,0)),this.instanceColorNode=o}const a=s.mul(Rt).xyz;if(Rt.assign(a),e.hasGeometryAttribute("normal")){const c=LI(Wn,s);Wn.assign(c)}this.instanceColorNode!==null&&il("vec3","vInstanceColor").assign(this.instanceColorNode)}update(){this.buffer!==null&&(this.buffer.clearUpdateRanges(),this.buffer.updateRanges.push(...this.instanceMatrix.updateRanges),this.instanceMatrix.usage!==rs&&this.instanceMatrix.version!==this.buffer.version&&(this.buffer.version=this.instanceMatrix.version)),this.instanceColor&&this.bufferColor!==null&&(this.bufferColor.clearUpdateRanges(),this.bufferColor.updateRanges.push(...this.instanceColor.updateRanges),this.instanceColor.usage!==rs&&this.instanceColor.version!==this.bufferColor.version&&(this.bufferColor.version=this.instanceColor.version))}}class GL extends UL{static get type(){return"InstancedMeshNode"}constructor(e){const{count:t,instanceMatrix:r,instanceColor:i}=e;super(t,r,i),this.instancedMesh=e}}const $L=Pe(GL).setParameterLength(1);class VL extends ce{static get type(){return"BatchNode"}constructor(e){super("void"),this.batchMesh=e,this.batchingIdNode=null}setup(e){this.batchingIdNode===null&&(e.getDrawIndex()===null?this.batchingIdNode=up:this.batchingIdNode=OL);const r=Q(([p])=>{const g=ze(Ei(en(this.batchMesh._indirectTexture),0).x),x=ze(p).mod(g),m=ze(p).div(g);return en(this.batchMesh._indirectTexture,sr(x,m)).x}).setLayout({name:"getIndirectIndex",type:"uint",inputs:[{name:"id",type:"int"}]})(ze(this.batchingIdNode)),i=this.batchMesh._matricesTexture,s=ze(Ei(en(i),0).x),o=j(r).mul(4).toInt().toVar(),a=o.mod(s),c=o.div(s),l=ms(en(i,sr(a,c)),en(i,sr(a.add(1),c)),en(i,sr(a.add(2),c)),en(i,sr(a.add(3),c))),u=this.batchMesh._colorsTexture;if(u!==null){const g=Q(([x])=>{const m=ze(Ei(en(u),0).x),y=x,_=y.mod(m),v=y.div(m);return en(u,sr(_,v)).rgb}).setLayout({name:"getBatchingColor",type:"vec3",inputs:[{name:"id",type:"int"}]})(r);il("vec3","vBatchColor").assign(g)}const d=kt(l);Rt.assign(l.mul(Rt));const h=Wn.div(X(d[0].dot(d[0]),d[1].dot(d[1]),d[2].dot(d[2]))),f=d.mul(h).xyz;Wn.assign(f),e.hasGeometryAttribute("tangent")&&lp.mulAssign(d)}}const zL=Pe(VL).setParameterLength(1),t0=new WeakMap;class jL extends ce{static get type(){return"SkinningNode"}constructor(e){super("void"),this.skinnedMesh=e,this.updateType=_e.OBJECT,this.skinIndexNode=jr("skinIndex","uvec4"),this.skinWeightNode=jr("skinWeight","vec4"),this.bindMatrixNode=Oe("bindMatrix","mat4"),this.bindMatrixInverseNode=Oe("bindMatrixInverse","mat4"),this.boneMatricesNode=Km("skeleton.boneMatrices","mat4",e.skeleton.bones.length),this.positionNode=Rt,this.toPositionNode=Rt,this.previousBoneMatricesNode=null}getSkinnedPosition(e=this.boneMatricesNode,t=this.positionNode){const{skinIndexNode:r,skinWeightNode:i,bindMatrixNode:s,bindMatrixInverseNode:o}=this,a=e.element(r.x),c=e.element(r.y),l=e.element(r.z),u=e.element(r.w),d=s.mul(t),h=Ht(a.mul(i.x).mul(d),c.mul(i.y).mul(d),l.mul(i.z).mul(d),u.mul(i.w).mul(d));return o.mul(h).xyz}getSkinnedNormal(e=this.boneMatricesNode,t=Wn){const{skinIndexNode:r,skinWeightNode:i,bindMatrixNode:s,bindMatrixInverseNode:o}=this,a=e.element(r.x),c=e.element(r.y),l=e.element(r.z),u=e.element(r.w);let d=Ht(i.x.mul(a),i.y.mul(c),i.z.mul(l),i.w.mul(u));return d=o.mul(d).mul(s),d.transformDirection(t).xyz}getPreviousSkinnedPosition(e){const t=e.object;return this.previousBoneMatricesNode===null&&(t.skeleton.previousBoneMatrices=new Float32Array(t.skeleton.boneMatrices),this.previousBoneMatricesNode=Km("skeleton.previousBoneMatrices","mat4",t.skeleton.bones.length)),this.getSkinnedPosition(this.previousBoneMatricesNode,Xm)}needsPreviousBoneMatrices(e){const t=e.renderer.getMRT();return t&&t.has("velocity")||Q_(e.object).useVelocity===!0}setup(e){this.needsPreviousBoneMatrices(e)&&Xm.assign(this.getPreviousSkinnedPosition(e));const t=this.getSkinnedPosition();if(this.toPositionNode&&this.toPositionNode.assign(t),e.hasGeometryAttribute("normal")){const r=this.getSkinnedNormal();Wn.assign(r),e.hasGeometryAttribute("tangent")&&lp.assign(r)}return t}generate(e,t){if(t!=="void")return super.generate(e,t)}update(e){const t=e.object&&e.object.skeleton?e.object.skeleton:this.skinnedMesh.skeleton;t0.get(t)!==e.frameId&&(t0.set(t,e.frameId),this.previousBoneMatricesNode!==null&&t.previousBoneMatrices.set(t.boneMatrices),t.update())}}const HL=n=>J(new jL(n));class WL extends ce{static get type(){return"LoopNode"}constructor(e=[]){super("void"),this.params=e}getVarName(e){return String.fromCharCode(105+e)}getProperties(e){const t=e.getNodeProperties(this);if(t.stackNode!==void 0)return t;const r={};for(let a=0,c=this.params.length-1;a<c;a++){const l=this.params[a],u=l.isNode!==!0&&l.name||this.getVarName(a),d=l.isNode!==!0&&l.type||"int";r[u]=Ms(u,d)}const i=e.addStack(),s=this.params[this.params.length-1](r);t.returnsNode=s.context({nodeLoop:s}),t.stackNode=i;const o=this.params[0];if(o.isNode!==!0&&typeof o.update=="function"){const a=Q(this.params[0].update)(r);t.updateNode=a.context({nodeLoop:a})}return e.removeStack(),t}setup(e){if(this.getProperties(e),e.fnCall){const t=e.getDataFromNode(e.fnCall.shaderNode);t.hasLoop=!0}}generate(e){const t=this.getProperties(e),r=this.params,i=t.stackNode;for(let o=0,a=r.length-1;o<a;o++){const c=r[o];let l=!1,u=null,d=null,h=null,f=null,p=null,g=null;c.isNode?c.getNodeType(e)==="bool"?(l=!0,f="bool",d=c.build(e,f)):(f="int",h=this.getVarName(o),u="0",d=c.build(e,f),p="<"):(f=c.type||"int",h=c.name||this.getVarName(o),u=c.start,d=c.end,p=c.condition,g=c.update,typeof u=="number"?u=e.generateConst(f,u):u&&u.isNode&&(u=u.build(e,f)),typeof d=="number"?d=e.generateConst(f,d):d&&d.isNode&&(d=d.build(e,f)),u!==void 0&&d===void 0?(u=u+" - 1",d="0",p=">="):d!==void 0&&u===void 0&&(u="0",p="<"),p===void 0&&(Number(u)>Number(d)?p=">=":p="<"));let x;if(l)x=`while ( ${d} )`;else{const m={start:u,end:d},y=m.start,_=m.end;let v;const T=()=>p.includes("<")?"+=":"-=";if(g!=null)switch(typeof g){case"function":v=e.flowStagesNode(t.updateNode,"void").code.replace(/\t|;/g,"");break;case"number":v=h+" "+T()+" "+e.generateConst(f,g);break;case"string":v=h+" "+g;break;default:g.isNode?v=h+" "+T()+" "+g.build(e):(ie("TSL: 'Loop( { update: ... } )' is not a function, string or number."),v="break /* invalid update */")}else f==="int"||f==="uint"?g=p.includes("<")?"++":"--":g=T()+" 1.",v=h+" "+g;const w=e.getVar(f,h)+" = "+y,N=h+" "+p+" "+_;x=`for ( ${w}; ${N}; ${v} )`}e.addFlowCode((o===0?`
`:"")+e.tab+x+` {

`).addFlowTab()}const s=i.build(e,"void");t.returnsNode.build(e,"void"),e.removeFlowTab().addFlowCode(`
`+e.tab+s);for(let o=0,a=this.params.length-1;o<a;o++)e.addFlowCode((o===0?"":e.tab)+`}

`).removeFlowTab();e.addFlowTab()}}const rn=(...n)=>new WL(gs(n,"int")).toStack(),qL=()=>Ms("break").toStack(),Fu=new WeakMap,Xt=new Ze,n0=Q(({bufferMap:n,influence:e,stride:t,width:r,depth:i,offset:s})=>{const o=ze(LL).mul(t).add(s),a=o.div(r),c=o.sub(a.mul(r));return en(n,sr(c,a)).depth(i).xyz.mul(e)});function XL(n){const e=n.morphAttributes.position!==void 0,t=n.morphAttributes.normal!==void 0,r=n.morphAttributes.color!==void 0,i=n.morphAttributes.position||n.morphAttributes.normal||n.morphAttributes.color,s=i!==void 0?i.length:0;let o=Fu.get(n);if(o===void 0||o.count!==s){let m=function(){g.dispose(),Fu.delete(n),n.removeEventListener("dispose",m)};o!==void 0&&o.texture.dispose();const a=n.morphAttributes.position||[],c=n.morphAttributes.normal||[],l=n.morphAttributes.color||[];let u=0;e===!0&&(u=1),t===!0&&(u=2),r===!0&&(u=3);let d=n.attributes.position.count*u,h=1;const f=4096;d>f&&(h=Math.ceil(d/f),d=f);const p=new Float32Array(d*h*4*s),g=new MS(p,d,h,s);g.type=nn,g.needsUpdate=!0;const x=u*4;for(let y=0;y<s;y++){const _=a[y],v=c[y],T=l[y],w=d*h*4*y;for(let N=0;N<_.count;N++){const E=N*x;e===!0&&(Xt.fromBufferAttribute(_,N),p[w+E+0]=Xt.x,p[w+E+1]=Xt.y,p[w+E+2]=Xt.z,p[w+E+3]=0),t===!0&&(Xt.fromBufferAttribute(v,N),p[w+E+4]=Xt.x,p[w+E+5]=Xt.y,p[w+E+6]=Xt.z,p[w+E+7]=0),r===!0&&(Xt.fromBufferAttribute(T,N),p[w+E+8]=Xt.x,p[w+E+9]=Xt.y,p[w+E+10]=Xt.z,p[w+E+11]=T.itemSize===4?Xt.w:1)}}o={count:s,texture:g,stride:u,size:new Te(d,h)},Fu.set(n,o),n.addEventListener("dispose",m)}return o}class YL extends ce{static get type(){return"MorphNode"}constructor(e){super("void"),this.mesh=e,this.morphBaseInfluence=pe(1),this.updateType=_e.OBJECT}setup(e){const{geometry:t}=e,r=t.morphAttributes.position!==void 0,i=t.hasAttribute("normal")&&t.morphAttributes.normal!==void 0,s=t.morphAttributes.position||t.morphAttributes.normal||t.morphAttributes.color,o=s!==void 0?s.length:0,{texture:a,stride:c,size:l}=XL(t);r===!0&&Rt.mulAssign(this.morphBaseInfluence),i===!0&&Wn.mulAssign(this.morphBaseInfluence);const u=ze(l.width);rn(o,({i:d})=>{const h=j(0).toVar();this.mesh.count>1&&this.mesh.morphTexture!==null&&this.mesh.morphTexture!==void 0?h.assign(en(this.mesh.morphTexture,sr(ze(d).add(1),ze(up))).r):h.assign(Oe("morphTargetInfluences","float").element(d).toVar()),qe(h.notEqual(0),()=>{r===!0&&Rt.addAssign(n0({bufferMap:a,influence:h,stride:c,width:u,depth:d,offset:ze(0)})),i===!0&&Wn.addAssign(n0({bufferMap:a,influence:h,stride:c,width:u,depth:d,offset:ze(1)}))})})}update(){const e=this.morphBaseInfluence;this.mesh.geometry.morphTargetsRelative?e.value=1:e.value=1-this.mesh.morphTargetInfluences.reduce((t,r)=>t+r,0)}}const KL=Pe(YL).setParameterLength(1);class Vs extends ce{static get type(){return"LightingNode"}constructor(){super("vec3"),this.isLightingNode=!0}}class QL extends Vs{static get type(){return"AONode"}constructor(e=null){super(),this.aoNode=e}setup(e){e.context.ambientOcclusion.mulAssign(this.aoNode)}}class ZL extends Ev{static get type(){return"LightingContextNode"}constructor(e,t=null,r=null,i=null){super(e),this.lightingModel=t,this.backdropNode=r,this.backdropAlphaNode=i,this._value=null}getContext(){const{backdropNode:e,backdropAlphaNode:t}=this,r=X().toVar("directDiffuse"),i=X().toVar("directSpecular"),s=X().toVar("indirectDiffuse"),o=X().toVar("indirectSpecular"),a={directDiffuse:r,directSpecular:i,indirectDiffuse:s,indirectSpecular:o};return{radiance:X().toVar("radiance"),irradiance:X().toVar("irradiance"),iblIrradiance:X().toVar("iblIrradiance"),ambientOcclusion:j(1).toVar("ambientOcclusion"),reflectedLight:a,backdrop:e,backdropAlpha:t}}setup(e){return this.value=this._value||(this._value=this.getContext()),this.value.lightingModel=this.lightingModel||e.context.lightingModel,super.setup(e)}}const JL=Pe(ZL);class eO extends Vs{static get type(){return"IrradianceNode"}constructor(e){super(),this.node=e}setup(e){e.context.irradiance.addAssign(this.node)}}const Xi=new Te;class nT extends Gs{static get type(){return"ViewportTextureNode"}constructor(e=ys,t=null,r=null){let i=null;r===null?(i=new Kx,i.minFilter=Ti,r=i):i=r,super(r,e,t),this.generateMipmaps=!1,this.defaultFramebuffer=i,this.isOutputTextureNode=!0,this.updateBeforeType=_e.FRAME,this._cacheTextures=new WeakMap}getTextureForReference(e=null){let t,r;if(this.referenceNode?(t=this.referenceNode.defaultFramebuffer,r=this.referenceNode._cacheTextures):(t=this.defaultFramebuffer,r=this._cacheTextures),e===null)return t;if(r.has(e)===!1){const i=t.clone();r.set(e,i)}return r.get(e)}updateReference(e){const t=e.renderer.getRenderTarget();return this.value=this.getTextureForReference(t),this.value}updateBefore(e){const t=e.renderer,r=t.getRenderTarget();r===null?t.getDrawingBufferSize(Xi):Xi.set(r.width,r.height);const i=this.getTextureForReference(r);(i.image.width!==Xi.width||i.image.height!==Xi.height)&&(i.image.width=Xi.width,i.image.height=Xi.height,i.needsUpdate=!0);const s=i.generateMipmaps;i.generateMipmaps=this.generateMipmaps,t.copyFramebufferToTexture(i),i.generateMipmaps=s}clone(){const e=new this.constructor(this.uvNode,this.levelNode,this.value);return e.generateMipmaps=this.generateMipmaps,e}}const rT=Pe(nT,null,null,{generateMipmaps:!0}).setParameterLength(0,3);let Va=null;class tO extends nT{static get type(){return"ViewportDepthTextureNode"}constructor(e=ys,t=null){Va===null&&(Va=new $n),super(e,t,Va)}getTextureForReference(){return Va}}const nO=Pe(tO).setParameterLength(0,2);class Vt extends ce{static get type(){return"ViewportDepthNode"}constructor(e,t=null){super("float"),this.scope=e,this.valueNode=t,this.isViewportDepthNode=!0}generate(e){const{scope:t}=this;return t===Vt.DEPTH_BASE?e.getFragDepth():super.generate(e)}setup({camera:e}){const{scope:t}=this,r=this.valueNode;let i=null;if(t===Vt.DEPTH_BASE)r!==null&&(i=oT().assign(r));else if(t===Vt.DEPTH)e.isPerspectiveCamera?i=rO(ot.z,hi,fi):i=Lo(ot.z,hi,fi);else if(t===Vt.LINEAR_DEPTH)if(r!==null)if(e.isPerspectiveCamera){const s=iT(r,hi,fi);i=Lo(s,hi,fi)}else i=r;else i=Lo(ot.z,hi,fi);return i}}Vt.DEPTH_BASE="depthBase";Vt.DEPTH="depth";Vt.LINEAR_DEPTH="linearDepth";const Lo=(n,e,t)=>n.add(e).div(e.sub(t)),rO=(n,e,t)=>e.add(n).mul(t).div(t.sub(e).mul(n)),iT=(n,e,t)=>e.mul(t).div(t.sub(e).mul(n).sub(t)),sT=(n,e,t)=>{e=e.max(1e-6).toVar();const r=mr(n.negate().div(e)),i=mr(t.div(e));return r.div(i)},oT=Pe(Vt,Vt.DEPTH_BASE),aT=re(Vt,Vt.DEPTH),iO=Pe(Vt,Vt.LINEAR_DEPTH).setParameterLength(0,1);nO();aT.assign=n=>oT(n);class an extends ce{static get type(){return"ClippingNode"}constructor(e=an.DEFAULT){super(),this.scope=e}setup(e){super.setup(e);const t=e.clippingContext,{intersectionPlanes:r,unionPlanes:i}=t;return this.hardwareClipping=e.material.hardwareClipping,this.scope===an.ALPHA_TO_COVERAGE?this.setupAlphaToCoverage(r,i):this.scope===an.HARDWARE?this.setupHardwareClipping(i,e):this.setupDefault(r,i)}setupAlphaToCoverage(e,t){return Q(()=>{const r=j().toVar("distanceToPlane"),i=j().toVar("distanceToGradient"),s=j(1).toVar("clipOpacity"),o=t.length;if(this.hardwareClipping===!1&&o>0){const c=bn(t).setGroup(fe);rn(o,({i:l})=>{const u=c.element(l);r.assign(ot.dot(u.xyz).negate().add(u.w)),i.assign(r.fwidth().div(2)),s.mulAssign(Tr(i.negate(),i,r))})}const a=e.length;if(a>0){const c=bn(e).setGroup(fe),l=j(1).toVar("intersectionClipOpacity");rn(a,({i:u})=>{const d=c.element(u);r.assign(ot.dot(d.xyz).negate().add(d.w)),i.assign(r.fwidth().div(2)),l.mulAssign(Tr(i.negate(),i,r).oneMinus())}),s.mulAssign(l.oneMinus())}Re.a.mulAssign(s),Re.a.equal(0).discard()})()}setupDefault(e,t){return Q(()=>{const r=t.length;if(this.hardwareClipping===!1&&r>0){const s=bn(t).setGroup(fe);rn(r,({i:o})=>{const a=s.element(o);ot.dot(a.xyz).greaterThan(a.w).discard()})}const i=e.length;if(i>0){const s=bn(e).setGroup(fe),o=Kf(!0).toVar("clipped");rn(i,({i:a})=>{const c=s.element(a);o.assign(ot.dot(c.xyz).greaterThan(c.w).and(o))}),o.discard()}})()}setupHardwareClipping(e,t){const r=e.length;return t.enableHardwareClipping(r),Q(()=>{const i=bn(e).setGroup(fe),s=ga(t.getClipDistance());rn(r,({i:o})=>{const a=i.element(o),c=ot.dot(a.xyz).sub(a.w).negate();s.element(o).assign(c)})})()}}an.ALPHA_TO_COVERAGE="alphaToCoverage";an.DEFAULT="default";an.HARDWARE="hardware";const sO=()=>J(new an),oO=()=>J(new an(an.ALPHA_TO_COVERAGE)),aO=()=>J(new an(an.HARDWARE)),cO=.05,r0=Q(([n])=>Hn(ve(1e4,tn(ve(17,n.x).add(ve(.1,n.y)))).mul(Ht(.1,Kt(tn(ve(13,n.y).add(n.x))))))),i0=Q(([n])=>r0(ne(r0(n.xy),n.z))),lO=Q(([n])=>{const e=gt(xr(xv(n.xyz)),xr(yv(n.xyz))),t=j(1).div(j(cO).mul(e)).toVar("pixScale"),r=ne(Ko(Ni(mr(t))),Ko(np(mr(t)))),i=ne(i0(Ni(r.x.mul(n.xyz))),i0(Ni(r.y.mul(n.xyz)))),s=Hn(mr(t)),o=Ht(ve(s.oneMinus(),i.x),ve(s,i.y)),a=Rs(s,s.oneMinus()),c=X(o.mul(o).div(ve(2,a).mul(Dt(1,a))),o.sub(ve(.5,a)).div(Dt(1,a)),Dt(1,Dt(1,o).mul(Dt(1,o)).div(ve(2,a).mul(Dt(1,a))))),l=o.lessThan(a.oneMinus()).select(o.lessThan(a).select(c.x,c.y),c.z);return vr(l,1e-6,1)}).setLayout({name:"getAlphaHashThreshold",type:"float",inputs:[{name:"position",type:"vec3"}]});class uO extends Bv{static get type(){return"VertexColorNode"}constructor(e){super(null,"vec4"),this.isVertexColorNode=!0,this.index=e}getAttributeName(){const e=this.index;return"color"+(e>0?e:"")}generate(e){const t=this.getAttributeName(e),r=e.hasGeometryAttribute(t);let i;return r===!0?i=super.generate(e):i=e.generateConst(this.nodeType,new Ze(1,1,1,1)),i}serialize(e){super.serialize(e),e.index=this.index}deserialize(e){super.deserialize(e),this.index=e.index}}const dO=(n=0)=>J(new uO(n)),hO=Q(([n])=>be(n.rgb.mul(n.a),n.a),{color:"vec4",return:"vec4"});class at extends Dp{static get type(){return"NodeMaterial"}get type(){return this.constructor.type}set type(e){}constructor(){super(),this.isNodeMaterial=!0,this.fog=!0,this.lights=!1,this.hardwareClipping=!1,this.lightsNode=null,this.envNode=null,this.aoNode=null,this.colorNode=null,this.normalNode=null,this.opacityNode=null,this.backdropNode=null,this.backdropAlphaNode=null,this.alphaTestNode=null,this.maskNode=null,this.positionNode=null,this.geometryNode=null,this.depthNode=null,this.receivedShadowPositionNode=null,this.castShadowPositionNode=null,this.receivedShadowNode=null,this.castShadowNode=null,this.outputNode=null,this.mrtNode=null,this.fragmentNode=null,this.vertexNode=null,Object.defineProperty(this,"shadowPositionNode",{get:()=>this.receivedShadowPositionNode,set:e=>{se('NodeMaterial: ".shadowPositionNode" was renamed to ".receivedShadowPositionNode".'),this.receivedShadowPositionNode=e}})}_getNodeChildren(){const e=[];for(const t of Object.getOwnPropertyNames(this)){if(t.startsWith("_")===!0)continue;const r=this[t];r&&r.isNode===!0&&e.push({property:t,childNode:r})}return e}customProgramCacheKey(){const e=[];for(const{property:t,childNode:r}of this._getNodeChildren())e.push(Dl(t.slice(0,-4)),r.getCacheKey());return this.type+ha(e)}build(e){this.setup(e)}setupObserver(e){return new XB(e)}setup(e){e.context.setupNormal=()=>ko(this.setupNormal(e),"NORMAL","vec3"),e.context.setupPositionView=()=>this.setupPositionView(e),e.context.setupModelViewProjection=()=>this.setupModelViewProjection(e);const t=e.renderer,r=t.getRenderTarget();e.addStack();const i=ko(this.setupVertex(e),"VERTEX"),s=this.vertexNode||i;e.stack.outputNode=s,this.setupHardwareClipping(e),this.geometryNode!==null&&(e.stack.outputNode=e.stack.outputNode.bypass(this.geometryNode)),e.addFlow("vertex",e.removeStack()),e.addStack();let o;const a=this.setupClipping(e);if((this.depthWrite===!0||this.depthTest===!0)&&(r!==null?r.depthBuffer===!0&&this.setupDepth(e):t.depth===!0&&this.setupDepth(e)),this.fragmentNode===null){this.setupDiffuseColor(e),this.setupVariants(e);const c=this.setupLighting(e);a!==null&&e.stack.addToStack(a);const l=be(c,Re.a).max(0);o=this.setupOutput(e,l),Fo.assign(o);const u=this.outputNode!==null;if(u&&(o=this.outputNode),r!==null){const d=t.getMRT(),h=this.mrtNode;d!==null?(u&&Fo.assign(o),o=d,h!==null&&(o=d.merge(h))):h!==null&&(o=h)}}else{let c=this.fragmentNode;c.isOutputStructNode!==!0&&(c=be(c)),o=this.setupOutput(e,c)}e.stack.outputNode=o,e.addFlow("fragment",e.removeStack()),e.observer=this.setupObserver(e)}setupClipping(e){if(e.clippingContext===null)return null;const{unionPlanes:t,intersectionPlanes:r}=e.clippingContext;let i=null;if(t.length>0||r.length>0){const s=e.renderer.currentSamples;this.alphaToCoverage&&s>1?i=oO():e.stack.addToStack(sO())}return i}setupHardwareClipping(e){if(this.hardwareClipping=!1,e.clippingContext===null)return;const t=e.clippingContext.unionPlanes.length;t>0&&t<=8&&e.isAvailable("clipDistance")&&(e.stack.addToStack(aO()),this.hardwareClipping=!0)}setupDepth(e){const{renderer:t,camera:r}=e;let i=this.depthNode;if(i===null){const s=t.getMRT();s&&s.has("depth")?i=s.get("depth"):t.logarithmicDepthBuffer===!0&&(r.isPerspectiveCamera?i=sT(ot.z,hi,fi):i=Lo(ot.z,hi,fi))}i!==null&&aT.assign(i).toStack()}setupPositionView(){return Ol.mul(Rt).xyz}setupModelViewProjection(){return Ov.mul(ot)}setupVertex(e){return e.addStack(),this.setupPosition(e),e.context.vertex=e.removeStack(),tT}setupPosition(e){const{object:t,geometry:r}=e;if((r.morphAttributes.position||r.morphAttributes.normal||r.morphAttributes.color)&&KL(t).toStack(),t.isSkinnedMesh===!0&&HL(t).toStack(),this.displacementMap){const i=Dr("displacementMap","texture"),s=Dr("displacementScale","float"),o=Dr("displacementBias","float");Rt.addAssign(Wn.normalize().mul(i.x.mul(s).add(o)))}return t.isBatchedMesh&&zL(t).toStack(),t.isInstancedMesh&&t.instanceMatrix&&t.instanceMatrix.isInstancedBufferAttribute===!0&&$L(t).toStack(),this.positionNode!==null&&Rt.assign(ko(this.positionNode,"POSITION","vec3")),Rt}setupDiffuseColor(e){const{object:t,geometry:r}=e;this.maskNode!==null&&Kf(this.maskNode).not().discard();let i=this.colorNode?be(this.colorNode):aL;this.vertexColors===!0&&r.hasAttribute("color")&&(i=i.mul(dO())),t.instanceColor&&(i=il("vec3","vInstanceColor").mul(i)),t.isBatchedMesh&&t._colorsTexture&&(i=il("vec3","vBatchColor").mul(i)),Re.assign(i);const s=this.opacityNode?j(this.opacityNode):Jv;Re.a.assign(Re.a.mul(s));let o=null;(this.alphaTestNode!==null||this.alphaTest>0)&&(o=this.alphaTestNode!==null?j(this.alphaTestNode):oL,this.alphaToCoverage===!0?(Re.a=Tr(o,o.add(bv(Re.a)),Re.a),Re.a.lessThanEqual(0).discard()):Re.a.lessThanEqual(o).discard()),this.alphaHash===!0&&Re.a.lessThan(lO(Rt)).discard(),e.isOpaque()&&Re.a.assign(1)}setupVariants(){}setupOutgoingLight(){return this.lights===!0?X(0):Re.rgb}setupNormal(){return this.normalNode?X(this.normalNode):pL}setupEnvironment(){let e=null;return this.envNode?e=this.envNode:this.envMap&&(e=this.envMap.isCubeTexture?Dr("envMap","cubeTexture"):Dr("envMap","texture")),e}setupLightMap(e){let t=null;return e.material.lightMap&&(t=new eO(eT)),t}setupLights(e){const t=[],r=this.setupEnvironment(e);r&&r.isLightingNode&&t.push(r);const i=this.setupLightMap(e);if(i&&i.isLightingNode&&t.push(i),this.aoNode!==null||e.material.aoMap){const o=this.aoNode!==null?this.aoNode:IL;t.push(new QL(o))}let s=this.lightsNode||e.lightsNode;return t.length>0&&(s=e.renderer.lighting.createNode([...s.getLights(),...t])),s}setupLightingModel(){}setupLighting(e){const{material:t}=e,{backdropNode:r,backdropAlphaNode:i,emissiveNode:s}=this,a=this.lights===!0||this.lightsNode!==null?this.setupLights(e):null;let c=this.setupOutgoingLight(e);if(a&&a.getScope().hasLights){const l=this.setupLightingModel(e)||null;c=JL(a,l,r,i)}else r!==null&&(c=X(i!==null?He(c,r,i):r));return(s&&s.isNode===!0||t.emissive&&t.emissive.isColor===!0)&&(Gm.assign(X(s||lL)),c=c.add(Gm)),c}setupFog(e,t){const r=e.fogNode;return r&&(Fo.assign(t),t=be(r.toVar())),t}setupPremultipliedAlpha(e,t){return hO(t)}setupOutput(e,t){return this.fog===!0&&(t=this.setupFog(e,t)),this.premultipliedAlpha===!0&&(t=this.setupPremultipliedAlpha(e,t)),t}setDefaultValues(e){for(const r in e){const i=e[r];this[r]===void 0&&(this[r]=i,i&&i.clone&&(this[r]=i.clone()))}const t=Object.getOwnPropertyDescriptors(e.constructor.prototype);for(const r in t)Object.getOwnPropertyDescriptor(this.constructor.prototype,r)===void 0&&t[r].get!==void 0&&Object.defineProperty(this.constructor.prototype,r,t[r])}toJSON(e){const t=e===void 0||typeof e=="string";t&&(e={textures:{},images:{},nodes:{}});const r=Dp.prototype.toJSON.call(this,e);r.inputNodes={};for(const{property:s,childNode:o}of this._getNodeChildren())r.inputNodes[s]=o.toJSON(e).uuid;function i(s){const o=[];for(const a in s){const c=s[a];delete c.metadata,o.push(c)}return o}if(t){const s=i(e.textures),o=i(e.images),a=i(e.nodes);s.length>0&&(r.textures=s),o.length>0&&(r.images=o),a.length>0&&(r.nodes=a)}return r}copy(e){return this.lightsNode=e.lightsNode,this.envNode=e.envNode,this.aoNode=e.aoNode,this.colorNode=e.colorNode,this.normalNode=e.normalNode,this.opacityNode=e.opacityNode,this.backdropNode=e.backdropNode,this.backdropAlphaNode=e.backdropAlphaNode,this.alphaTestNode=e.alphaTestNode,this.maskNode=e.maskNode,this.positionNode=e.positionNode,this.geometryNode=e.geometryNode,this.depthNode=e.depthNode,this.receivedShadowPositionNode=e.receivedShadowPositionNode,this.castShadowPositionNode=e.castShadowPositionNode,this.receivedShadowNode=e.receivedShadowNode,this.castShadowNode=e.castShadowNode,this.outputNode=e.outputNode,this.mrtNode=e.mrtNode,this.fragmentNode=e.fragmentNode,this.vertexNode=e.vertexNode,super.copy(e)}}const fO=new qx;class pO extends at{static get type(){return"LineBasicNodeMaterial"}constructor(e){super(),this.isLineBasicNodeMaterial=!0,this.setDefaultValues(fO),this.setValues(e)}}const gO=new Ww;class mO extends at{static get type(){return"LineDashedNodeMaterial"}constructor(e){super(),this.isLineDashedNodeMaterial=!0,this.setDefaultValues(gO),this.dashOffset=0,this.offsetNode=null,this.dashScaleNode=null,this.dashSizeNode=null,this.gapSizeNode=null,this.setValues(e)}setupVariants(){const e=this.offsetNode?j(this.offsetNode):BL,t=this.dashScaleNode?j(this.dashScaleNode):ML,r=this.dashSizeNode?j(this.dashSizeNode):PL,i=this.gapSizeNode?j(this.gapSizeNode):DL;Mu.assign(r),$m.assign(i);const s=Hr(jr("lineDistance").mul(t));(e?s.add(e):s).mod(Mu.add($m)).greaterThan(Mu).discard()}}const xO=n=>J(n).mul(.5).add(.5),yO=new jw;class bO extends at{static get type(){return"MeshNormalNodeMaterial"}constructor(e){super(),this.isMeshNormalNodeMaterial=!0,this.setDefaultValues(yO),this.setValues(e)}setupDiffuseColor(){const e=this.opacityNode?j(this.opacityNode):Jv;Re.assign(sp(be(xO(Fe),e),tf))}}const cT=Q(([n=Uv])=>{const e=n.z.atan(n.x).mul(1/(Math.PI*2)).add(.5),t=n.y.clamp(-1,1).asin().mul(1/Math.PI).add(.5);return ne(e,t)});class lT extends wS{constructor(e=1,t={}){super(e,t),this.isCubeRenderTarget=!0}fromEquirectangularTexture(e,t){const r=t.minFilter,i=t.generateMipmaps;t.generateMipmaps=!0,this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const s=new Py(5,5,5),o=cT(Uv),a=new at;a.colorNode=Ae(t,o,0),a.side=jt,a.blending=vs;const c=new wn(s,a),l=new yl;l.add(c),t.minFilter===Ti&&(t.minFilter=Sn);const u=new SS(1,10,this),d=e.getMRT();return e.setMRT(null),u.update(e,l),e.setMRT(d),t.minFilter=r,t.currentGenerateMipmaps=i,c.geometry.dispose(),c.material.dispose(),this}}const Oo=new WeakMap;class _O extends mt{static get type(){return"CubeMapNode"}constructor(e){super("vec3"),this.envNode=e,this._cubeTexture=null,this._cubeTextureNode=Jo(null);const t=new cf;t.isRenderTargetTexture=!0,this._defaultTexture=t,this.updateBeforeType=_e.RENDER}updateBefore(e){const{renderer:t,material:r}=e,i=this.envNode;if(i.isTextureNode||i.isMaterialReferenceNode){const s=i.isTextureNode?i.value:r[i.property];if(s&&s.isTexture){const o=s.mapping;if(o===of||o===af){if(Oo.has(s)){const a=Oo.get(s);s0(a,s.mapping),this._cubeTexture=a}else{const a=s.image;if(vO(a)){const c=new lT(a.height);c.fromEquirectangularTexture(t,s),s0(c.texture,s.mapping),this._cubeTexture=c.texture,Oo.set(s,c.texture),s.addEventListener("dispose",uT)}else this._cubeTexture=this._defaultTexture}this._cubeTextureNode.value=this._cubeTexture}else this._cubeTextureNode=this.envNode}}}setup(e){return this.updateBefore(e),this._cubeTextureNode}}function vO(n){return n==null?!1:n.height>0}function uT(n){const e=n.target;e.removeEventListener("dispose",uT);const t=Oo.get(e);t!==void 0&&(Oo.delete(e),t.dispose())}function s0(n,e){e===of?n.mapping=Lc:e===af&&(n.mapping=Oc)}const dT=Pe(_O).setParameterLength(1);class dp extends Vs{static get type(){return"BasicEnvironmentNode"}constructor(e=null){super(),this.envNode=e}setup(e){e.context.environment=dT(this.envNode)}}class TO extends Vs{static get type(){return"BasicLightMapNode"}constructor(e=null){super(),this.lightMapNode=e}setup(e){const t=j(1/Math.PI);e.context.irradianceLightMap=this.lightMapNode.mul(t)}}class Gl{start(e){e.lightsNode.setupLights(e,e.lightsNode.getLightNodes(e)),this.indirect(e)}finish(){}direct(){}directRectArea(){}indirect(){}ambientOcclusion(){}}class hT extends Gl{constructor(){super()}indirect({context:e}){const t=e.ambientOcclusion,r=e.reflectedLight,i=e.irradianceLightMap;r.indirectDiffuse.assign(be(0)),i?r.indirectDiffuse.addAssign(i):r.indirectDiffuse.addAssign(be(1,1,1,0)),r.indirectDiffuse.mulAssign(t),r.indirectDiffuse.mulAssign(Re.rgb)}finish(e){const{material:t,context:r}=e,i=r.outgoingLight,s=e.context.environment;if(s)switch(t.combine){case vS:i.rgb.assign(He(i.rgb,i.rgb.mul(s.rgb),Rc.mul(Bu)));break;case _S:i.rgb.assign(He(i.rgb,s.rgb,Rc.mul(Bu)));break;case bS:i.rgb.addAssign(s.rgb.mul(Rc.mul(Bu)));break;default:se("BasicLightingModel: Unsupported .combine value:",t.combine);break}}}const wO=new Mr;class SO extends at{static get type(){return"MeshBasicNodeMaterial"}constructor(e){super(),this.isMeshBasicNodeMaterial=!0,this.lights=!0,this.setDefaultValues(wO),this.setValues(e)}setupNormal(){return ma(Zo)}setupEnvironment(e){const t=super.setupEnvironment(e);return t?new dp(t):null}setupLightMap(e){let t=null;return e.material.lightMap&&(t=new TO(eT)),t}setupOutgoingLight(){return Re.rgb}setupLightingModel(){return new hT}}const ea=Q(({f0:n,f90:e,dotVH:t})=>{const r=t.mul(-5.55473).sub(6.98316).mul(t).exp2();return n.mul(r.oneMinus()).add(e.mul(r))}),Ds=Q(n=>n.diffuseColor.mul(1/Math.PI)),NO=()=>j(.25),EO=Q(({dotNH:n})=>Ch.mul(j(.5)).add(1).mul(j(1/Math.PI)).mul(n.pow(Ch))),AO=Q(({lightDirection:n})=>{const e=n.add(Ke).normalize(),t=Fe.dot(e).clamp(),r=Ke.dot(e).clamp(),i=ea({f0:gn,f90:1,dotVH:r}),s=NO(),o=EO({dotNH:t});return i.mul(s).mul(o)});class fT extends hT{constructor(e=!0){super(),this.specular=e}direct({lightDirection:e,lightColor:t,reflectedLight:r}){const s=Fe.dot(e).clamp().mul(t);r.directDiffuse.addAssign(s.mul(Ds({diffuseColor:Re.rgb}))),this.specular===!0&&r.directSpecular.addAssign(s.mul(AO({lightDirection:e})).mul(Rc))}indirect(e){const{ambientOcclusion:t,irradiance:r,reflectedLight:i}=e.context;i.indirectDiffuse.addAssign(r.mul(Ds({diffuseColor:Re}))),i.indirectDiffuse.mulAssign(t)}}const RO=new jx;class CO extends at{static get type(){return"MeshLambertNodeMaterial"}constructor(e){super(),this.isMeshLambertNodeMaterial=!0,this.lights=!0,this.setDefaultValues(RO),this.setValues(e)}setupEnvironment(e){const t=super.setupEnvironment(e);return t?new dp(t):null}setupLightingModel(){return new fT(!1)}}const MO=new Gw;class PO extends at{static get type(){return"MeshPhongNodeMaterial"}constructor(e){super(),this.isMeshPhongNodeMaterial=!0,this.lights=!0,this.shininessNode=null,this.specularNode=null,this.setDefaultValues(MO),this.setValues(e)}setupEnvironment(e){const t=super.setupEnvironment(e);return t?new dp(t):null}setupLightingModel(){return new fT}setupVariants(){const e=(this.shininessNode?j(this.shininessNode):cL).max(1e-4);Ch.assign(e);const t=this.specularNode||uL;gn.assign(t)}copy(e){return this.shininessNode=e.shininessNode,this.specularNode=e.specularNode,super.copy(e)}}const DO=Q(n=>{if(n.geometry.hasAttribute("normal")===!1)return j(0);const e=Zo.dFdx().abs().max(Zo.dFdy().abs());return e.x.max(e.y).max(e.z)}),pT=Q(n=>{const{roughness:e}=n,t=DO();let r=e.max(.0525);return r=r.add(t),r=r.min(1),r}),BO=Q(({alpha:n,dotNL:e,dotNV:t})=>{const r=n.pow2(),i=e.mul(r.add(r.oneMinus().mul(t.pow2())).sqrt()),s=t.mul(r.add(r.oneMinus().mul(e.pow2())).sqrt());return jn(.5,i.add(s).max(hv))}).setLayout({name:"V_GGX_SmithCorrelated",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNL",type:"float"},{name:"dotNV",type:"float"}]}),FO=Q(({alphaT:n,alphaB:e,dotTV:t,dotBV:r,dotTL:i,dotBL:s,dotNV:o,dotNL:a})=>{const c=a.mul(X(n.mul(t),e.mul(r),o).length()),l=o.mul(X(n.mul(i),e.mul(s),a).length());return jn(.5,c.add(l)).saturate()}).setLayout({name:"V_GGX_SmithCorrelated_Anisotropic",type:"float",inputs:[{name:"alphaT",type:"float",qualifier:"in"},{name:"alphaB",type:"float",qualifier:"in"},{name:"dotTV",type:"float",qualifier:"in"},{name:"dotBV",type:"float",qualifier:"in"},{name:"dotTL",type:"float",qualifier:"in"},{name:"dotBL",type:"float",qualifier:"in"},{name:"dotNV",type:"float",qualifier:"in"},{name:"dotNL",type:"float",qualifier:"in"}]}),kO=Q(({alpha:n,dotNH:e})=>{const t=n.pow2(),r=e.pow2().mul(t.oneMinus()).oneMinus();return t.div(r.pow2()).mul(1/Math.PI)}).setLayout({name:"D_GGX",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNH",type:"float"}]}),IO=j(1/Math.PI),LO=Q(({alphaT:n,alphaB:e,dotNH:t,dotTH:r,dotBH:i})=>{const s=n.mul(e),o=X(e.mul(r),n.mul(i),s.mul(t)),a=o.dot(o),c=s.div(a);return IO.mul(s.mul(c.pow2()))}).setLayout({name:"D_GGX_Anisotropic",type:"float",inputs:[{name:"alphaT",type:"float",qualifier:"in"},{name:"alphaB",type:"float",qualifier:"in"},{name:"dotNH",type:"float",qualifier:"in"},{name:"dotTH",type:"float",qualifier:"in"},{name:"dotBH",type:"float",qualifier:"in"}]}),gT=Q(({lightDirection:n,f0:e,f90:t,roughness:r,f:i,normalView:s=Fe,USE_IRIDESCENCE:o,USE_ANISOTROPY:a})=>{const c=r.pow2(),l=n.add(Ke).normalize(),u=s.dot(n).clamp(),d=s.dot(Ke).clamp(),h=s.dot(l).clamp(),f=Ke.dot(l).clamp();let p=ea({f0:e,f90:t,dotVH:f}),g,x;if(Um(o)&&(p=Jf.mix(p,i)),Um(a)){const m=Sc.dot(n),y=Sc.dot(Ke),_=Sc.dot(l),v=xs.dot(n),T=xs.dot(Ke),w=xs.dot(l);g=FO({alphaT:Rh,alphaB:c,dotTV:y,dotBV:T,dotTL:m,dotBL:v,dotNV:d,dotNL:u}),x=LO({alphaT:Rh,alphaB:c,dotNH:h,dotTH:_,dotBH:w})}else g=BO({alpha:c,dotNL:u,dotNV:d}),x=kO({alpha:c,dotNH:h});return p.mul(g).mul(x)}),OO=new Uint16Array([11481,15204,11534,15171,11808,15015,12385,14843,12894,14716,13396,14600,13693,14483,13976,14366,14237,14171,14405,13961,14511,13770,14605,13598,14687,13444,14760,13305,14822,13066,14876,12857,14923,12675,14963,12517,14997,12379,15025,12230,15049,12023,15070,11843,15086,11687,15100,11551,15111,11433,15120,11330,15127,11217,15132,11060,15135,10922,15138,10801,15139,10695,15139,10600,13012,14923,13020,14917,13064,14886,13176,14800,13349,14666,13513,14526,13724,14398,13960,14230,14200,14020,14383,13827,14488,13651,14583,13491,14667,13348,14740,13132,14803,12908,14856,12713,14901,12542,14938,12394,14968,12241,14992,12017,15010,11822,15024,11654,15034,11507,15041,11380,15044,11269,15044,11081,15042,10913,15037,10764,15031,10635,15023,10520,15014,10419,15003,10330,13657,14676,13658,14673,13670,14660,13698,14622,13750,14547,13834,14442,13956,14317,14112,14093,14291,13889,14407,13704,14499,13538,14586,13389,14664,13201,14733,12966,14792,12758,14842,12577,14882,12418,14915,12272,14940,12033,14959,11826,14972,11646,14980,11490,14983,11355,14983,11212,14979,11008,14971,10830,14961,10675,14950,10540,14936,10420,14923,10315,14909,10204,14894,10041,14089,14460,14090,14459,14096,14452,14112,14431,14141,14388,14186,14305,14252,14130,14341,13941,14399,13756,14467,13585,14539,13430,14610,13272,14677,13026,14737,12808,14790,12617,14833,12449,14869,12303,14896,12065,14916,11845,14929,11655,14937,11490,14939,11347,14936,11184,14930,10970,14921,10783,14912,10621,14900,10480,14885,10356,14867,10247,14848,10062,14827,9894,14805,9745,14400,14208,14400,14206,14402,14198,14406,14174,14415,14122,14427,14035,14444,13913,14469,13767,14504,13613,14548,13463,14598,13324,14651,13082,14704,12858,14752,12658,14795,12483,14831,12330,14860,12106,14881,11875,14895,11675,14903,11501,14905,11351,14903,11178,14900,10953,14892,10757,14880,10589,14865,10442,14847,10313,14827,10162,14805,9965,14782,9792,14757,9642,14731,9507,14562,13883,14562,13883,14563,13877,14566,13862,14570,13830,14576,13773,14584,13689,14595,13582,14613,13461,14637,13336,14668,13120,14704,12897,14741,12695,14776,12516,14808,12358,14835,12150,14856,11910,14870,11701,14878,11519,14882,11361,14884,11187,14880,10951,14871,10748,14858,10572,14842,10418,14823,10286,14801,10099,14777,9897,14751,9722,14725,9567,14696,9430,14666,9309,14702,13604,14702,13604,14702,13600,14703,13591,14705,13570,14707,13533,14709,13477,14712,13400,14718,13305,14727,13106,14743,12907,14762,12716,14784,12539,14807,12380,14827,12190,14844,11943,14855,11727,14863,11539,14870,11376,14871,11204,14868,10960,14858,10748,14845,10565,14829,10406,14809,10269,14786,10058,14761,9852,14734,9671,14705,9512,14674,9374,14641,9253,14608,9076,14821,13366,14821,13365,14821,13364,14821,13358,14821,13344,14821,13320,14819,13252,14817,13145,14815,13011,14814,12858,14817,12698,14823,12539,14832,12389,14841,12214,14850,11968,14856,11750,14861,11558,14866,11390,14867,11226,14862,10972,14853,10754,14840,10565,14823,10401,14803,10259,14780,10032,14754,9820,14725,9635,14694,9473,14661,9333,14627,9203,14593,8988,14557,8798,14923,13014,14922,13014,14922,13012,14922,13004,14920,12987,14919,12957,14915,12907,14909,12834,14902,12738,14894,12623,14888,12498,14883,12370,14880,12203,14878,11970,14875,11759,14873,11569,14874,11401,14872,11243,14865,10986,14855,10762,14842,10568,14825,10401,14804,10255,14781,10017,14754,9799,14725,9611,14692,9445,14658,9301,14623,9139,14587,8920,14548,8729,14509,8562,15008,12672,15008,12672,15008,12671,15007,12667,15005,12656,15001,12637,14997,12605,14989,12556,14978,12490,14966,12407,14953,12313,14940,12136,14927,11934,14914,11742,14903,11563,14896,11401,14889,11247,14879,10992,14866,10767,14851,10570,14833,10400,14812,10252,14789,10007,14761,9784,14731,9592,14698,9424,14663,9279,14627,9088,14588,8868,14548,8676,14508,8508,14467,8360,15080,12386,15080,12386,15079,12385,15078,12383,15076,12378,15072,12367,15066,12347,15057,12315,15045,12253,15030,12138,15012,11998,14993,11845,14972,11685,14951,11530,14935,11383,14920,11228,14904,10981,14887,10762,14870,10567,14850,10397,14827,10248,14803,9997,14774,9771,14743,9578,14710,9407,14674,9259,14637,9048,14596,8826,14555,8632,14514,8464,14471,8317,14427,8182,15139,12008,15139,12008,15138,12008,15137,12007,15135,12003,15130,11990,15124,11969,15115,11929,15102,11872,15086,11794,15064,11693,15041,11581,15013,11459,14987,11336,14966,11170,14944,10944,14921,10738,14898,10552,14875,10387,14850,10239,14824,9983,14794,9758,14762,9563,14728,9392,14692,9244,14653,9014,14611,8791,14569,8597,14526,8427,14481,8281,14436,8110,14391,7885,15188,11617,15188,11617,15187,11617,15186,11618,15183,11617,15179,11612,15173,11601,15163,11581,15150,11546,15133,11495,15110,11427,15083,11346,15051,11246,15024,11057,14996,10868,14967,10687,14938,10517,14911,10362,14882,10206,14853,9956,14821,9737,14787,9543,14752,9375,14715,9228,14675,8980,14632,8760,14589,8565,14544,8395,14498,8248,14451,8049,14404,7824,14357,7630,15228,11298,15228,11298,15227,11299,15226,11301,15223,11303,15219,11302,15213,11299,15204,11290,15191,11271,15174,11217,15150,11129,15119,11015,15087,10886,15057,10744,15024,10599,14990,10455,14957,10318,14924,10143,14891,9911,14856,9701,14820,9516,14782,9352,14744,9200,14703,8946,14659,8725,14615,8533,14568,8366,14521,8220,14472,7992,14423,7770,14374,7578,14315,7408,15260,10819,15260,10819,15259,10822,15258,10826,15256,10832,15251,10836,15246,10841,15237,10838,15225,10821,15207,10788,15183,10734,15151,10660,15120,10571,15087,10469,15049,10359,15012,10249,14974,10041,14937,9837,14900,9647,14860,9475,14820,9320,14779,9147,14736,8902,14691,8688,14646,8499,14598,8335,14549,8189,14499,7940,14448,7720,14397,7529,14347,7363,14256,7218,15285,10410,15285,10411,15285,10413,15284,10418,15282,10425,15278,10434,15272,10442,15264,10449,15252,10445,15235,10433,15210,10403,15179,10358,15149,10301,15113,10218,15073,10059,15033,9894,14991,9726,14951,9565,14909,9413,14865,9273,14822,9073,14777,8845,14730,8641,14682,8459,14633,8300,14583,8129,14531,7883,14479,7670,14426,7482,14373,7321,14305,7176,14201,6939,15305,9939,15305,9940,15305,9945,15304,9955,15302,9967,15298,9989,15293,10010,15286,10033,15274,10044,15258,10045,15233,10022,15205,9975,15174,9903,15136,9808,15095,9697,15053,9578,15009,9451,14965,9327,14918,9198,14871,8973,14825,8766,14775,8579,14725,8408,14675,8259,14622,8058,14569,7821,14515,7615,14460,7435,14405,7276,14350,7108,14256,6866,14149,6653,15321,9444,15321,9445,15321,9448,15320,9458,15317,9470,15314,9490,15310,9515,15302,9540,15292,9562,15276,9579,15251,9577,15226,9559,15195,9519,15156,9463,15116,9389,15071,9304,15025,9208,14978,9023,14927,8838,14878,8661,14827,8496,14774,8344,14722,8206,14667,7973,14612,7749,14556,7555,14499,7382,14443,7229,14385,7025,14322,6791,14210,6588,14100,6409,15333,8920,15333,8921,15332,8927,15332,8943,15329,8965,15326,9002,15322,9048,15316,9106,15307,9162,15291,9204,15267,9221,15244,9221,15212,9196,15175,9134,15133,9043,15088,8930,15040,8801,14990,8665,14938,8526,14886,8391,14830,8261,14775,8087,14719,7866,14661,7664,14603,7482,14544,7322,14485,7178,14426,6936,14367,6713,14281,6517,14166,6348,14054,6198,15341,8360,15341,8361,15341,8366,15341,8379,15339,8399,15336,8431,15332,8473,15326,8527,15318,8585,15302,8632,15281,8670,15258,8690,15227,8690,15191,8664,15149,8612,15104,8543,15055,8456,15001,8360,14948,8259,14892,8122,14834,7923,14776,7734,14716,7558,14656,7397,14595,7250,14534,7070,14472,6835,14410,6628,14350,6443,14243,6283,14125,6135,14010,5889,15348,7715,15348,7717,15348,7725,15347,7745,15345,7780,15343,7836,15339,7905,15334,8e3,15326,8103,15310,8193,15293,8239,15270,8270,15240,8287,15204,8283,15163,8260,15118,8223,15067,8143,15014,8014,14958,7873,14899,7723,14839,7573,14778,7430,14715,7293,14652,7164,14588,6931,14524,6720,14460,6531,14396,6362,14330,6210,14207,6015,14086,5781,13969,5576,15352,7114,15352,7116,15352,7128,15352,7159,15350,7195,15348,7237,15345,7299,15340,7374,15332,7457,15317,7544,15301,7633,15280,7703,15251,7754,15216,7775,15176,7767,15131,7733,15079,7670,15026,7588,14967,7492,14906,7387,14844,7278,14779,7171,14714,6965,14648,6770,14581,6587,14515,6420,14448,6269,14382,6123,14299,5881,14172,5665,14049,5477,13929,5310,15355,6329,15355,6330,15355,6339,15355,6362,15353,6410,15351,6472,15349,6572,15344,6688,15337,6835,15323,6985,15309,7142,15287,7220,15260,7277,15226,7310,15188,7326,15142,7318,15090,7285,15036,7239,14976,7177,14914,7045,14849,6892,14782,6736,14714,6581,14645,6433,14576,6293,14506,6164,14438,5946,14369,5733,14270,5540,14140,5369,14014,5216,13892,5043,15357,5483,15357,5484,15357,5496,15357,5528,15356,5597,15354,5692,15351,5835,15347,6011,15339,6195,15328,6317,15314,6446,15293,6566,15268,6668,15235,6746,15197,6796,15152,6811,15101,6790,15046,6748,14985,6673,14921,6583,14854,6479,14785,6371,14714,6259,14643,6149,14571,5946,14499,5750,14428,5567,14358,5401,14242,5250,14109,5111,13980,4870,13856,4657,15359,4555,15359,4557,15358,4573,15358,4633,15357,4715,15355,4841,15353,5061,15349,5216,15342,5391,15331,5577,15318,5770,15299,5967,15274,6150,15243,6223,15206,6280,15161,6310,15111,6317,15055,6300,14994,6262,14928,6208,14860,6141,14788,5994,14715,5838,14641,5684,14566,5529,14492,5384,14418,5247,14346,5121,14216,4892,14079,4682,13948,4496,13822,4330,15359,3498,15359,3501,15359,3520,15359,3598,15358,3719,15356,3860,15355,4137,15351,4305,15344,4563,15334,4809,15321,5116,15303,5273,15280,5418,15250,5547,15214,5653,15170,5722,15120,5761,15064,5763,15002,5733,14935,5673,14865,5597,14792,5504,14716,5400,14640,5294,14563,5185,14486,5041,14410,4841,14335,4655,14191,4482,14051,4325,13918,4183,13790,4012,15360,2282,15360,2285,15360,2306,15360,2401,15359,2547,15357,2748,15355,3103,15352,3349,15345,3675,15336,4020,15324,4272,15307,4496,15285,4716,15255,4908,15220,5086,15178,5170,15128,5214,15072,5234,15010,5231,14943,5206,14871,5166,14796,5102,14718,4971,14639,4833,14559,4687,14480,4541,14402,4401,14315,4268,14167,4142,14025,3958,13888,3747,13759,3556,15360,923,15360,925,15360,946,15360,1052,15359,1214,15357,1494,15356,1892,15352,2274,15346,2663,15338,3099,15326,3393,15309,3679,15288,3980,15260,4183,15226,4325,15185,4437,15136,4517,15080,4570,15018,4591,14950,4581,14877,4545,14800,4485,14720,4411,14638,4325,14556,4231,14475,4136,14395,3988,14297,3803,14145,3628,13999,3465,13861,3314,13729,3177,15360,263,15360,264,15360,272,15360,325,15359,407,15358,548,15356,780,15352,1144,15347,1580,15339,2099,15328,2425,15312,2795,15292,3133,15264,3329,15232,3517,15191,3689,15143,3819,15088,3923,15025,3978,14956,3999,14882,3979,14804,3931,14722,3855,14639,3756,14554,3645,14470,3529,14388,3409,14279,3289,14124,3173,13975,3055,13834,2848,13701,2658,15360,49,15360,49,15360,52,15360,75,15359,111,15358,201,15356,283,15353,519,15348,726,15340,1045,15329,1415,15314,1795,15295,2173,15269,2410,15237,2649,15197,2866,15150,3054,15095,3140,15032,3196,14963,3228,14888,3236,14808,3224,14725,3191,14639,3146,14553,3088,14466,2976,14382,2836,14262,2692,14103,2549,13952,2409,13808,2278,13674,2154,15360,4,15360,4,15360,4,15360,13,15359,33,15358,59,15357,112,15353,199,15348,302,15341,456,15331,628,15316,827,15297,1082,15272,1332,15241,1601,15202,1851,15156,2069,15101,2172,15039,2256,14970,2314,14894,2348,14813,2358,14728,2344,14640,2311,14551,2263,14463,2203,14376,2133,14247,2059,14084,1915,13930,1761,13784,1609,13648,1464,15360,0,15360,0,15360,0,15360,3,15359,18,15358,26,15357,53,15354,80,15348,97,15341,165,15332,238,15318,326,15299,427,15275,529,15245,654,15207,771,15161,885,15108,994,15046,1089,14976,1170,14900,1229,14817,1266,14731,1284,14641,1282,14550,1260,14460,1223,14370,1174,14232,1116,14066,1050,13909,981,13761,910,13623,839]);let tr=null;const ll=Q(({roughness:n,dotNV:e})=>{tr===null&&(tr=new Ay(OO,32,32,Fr,Ft),tr.minFilter=Sn,tr.magFilter=Sn,tr.wrapS=$o,tr.wrapT=$o,tr.generateMipmaps=!1,tr.needsUpdate=!0);const t=ne(n,e);return Ae(tr,t).rg}),UO=Q(({lightDirection:n,f0:e,f90:t,roughness:r,f:i,USE_IRIDESCENCE:s,USE_ANISOTROPY:o})=>{const a=gT({lightDirection:n,f0:e,f90:t,roughness:r,f:i,USE_IRIDESCENCE:s,USE_ANISOTROPY:o}),c=Fe.dot(n).clamp(),l=Fe.dot(Ke).clamp(),u=ll({roughness:r,dotNV:l}),d=ll({roughness:r,dotNV:c}),h=e.mul(u.x).add(t.mul(u.y)),f=e.mul(d.x).add(t.mul(d.y)),p=u.x.add(u.y),g=d.x.add(d.y),x=j(1).sub(p),m=j(1).sub(g),y=e.add(e.oneMinus().mul(.047619)),_=h.mul(f).mul(y).div(j(1).sub(x.mul(m).mul(y).mul(y)).add(hv)),v=x.mul(m),T=_.mul(v);return a.add(T)}),mT=Q(n=>{const{dotNV:e,specularColor:t,specularF90:r,roughness:i}=n,s=ll({dotNV:e,roughness:i});return t.mul(s.x).add(r.mul(s.y))}),GO=Q(({f:n,f90:e,dotVH:t})=>{const r=t.oneMinus().saturate(),i=r.mul(r),s=r.mul(i,i).clamp(0,.9999);return n.sub(X(e).mul(s)).div(s.oneMinus())}).setLayout({name:"Schlick_to_F0",type:"vec3",inputs:[{name:"f",type:"vec3"},{name:"f90",type:"float"},{name:"dotVH",type:"float"}]}),$O=Q(({roughness:n,dotNH:e})=>{const t=n.pow2(),r=j(1).div(t),s=e.pow2().oneMinus().max(.0078125);return j(2).add(r).mul(s.pow(r.mul(.5))).div(2*Math.PI)}).setLayout({name:"D_Charlie",type:"float",inputs:[{name:"roughness",type:"float"},{name:"dotNH",type:"float"}]}),VO=Q(({dotNV:n,dotNL:e})=>j(1).div(j(4).mul(e.add(n).sub(e.mul(n))))).setLayout({name:"V_Neubelt",type:"float",inputs:[{name:"dotNV",type:"float"},{name:"dotNL",type:"float"}]}),zO=Q(({lightDirection:n})=>{const e=n.add(Ke).normalize(),t=Fe.dot(n).clamp(),r=Fe.dot(Ke).clamp(),i=Fe.dot(e).clamp(),s=$O({roughness:Zf,dotNH:i}),o=VO({dotNV:r,dotNL:t});return os.mul(s).mul(o)}),jO=Q(({N:n,V:e,roughness:t})=>{const s=.0078125,o=n.dot(e).saturate(),a=ne(t,o.oneMinus().sqrt());return a.assign(a.mul(.984375).add(s)),a}).setLayout({name:"LTC_Uv",type:"vec2",inputs:[{name:"N",type:"vec3"},{name:"V",type:"vec3"},{name:"roughness",type:"float"}]}),HO=Q(({f:n})=>{const e=n.length();return gt(e.mul(e).add(n.z).div(e.add(1)),0)}).setLayout({name:"LTC_ClippedSphereFormFactor",type:"float",inputs:[{name:"f",type:"vec3"}]}),za=Q(({v1:n,v2:e})=>{const t=n.dot(e),r=t.abs().toVar(),i=r.mul(.0145206).add(.4965155).mul(r).add(.8543985).toVar(),s=r.add(4.1616724).mul(r).add(3.417594).toVar(),o=i.div(s),a=t.greaterThan(0).select(o,gt(t.mul(t).oneMinus(),1e-7).inverseSqrt().mul(.5).sub(o));return n.cross(e).mul(a)}).setLayout({name:"LTC_EdgeVectorFormFactor",type:"vec3",inputs:[{name:"v1",type:"vec3"},{name:"v2",type:"vec3"}]}),o0=Q(({N:n,V:e,P:t,mInv:r,p0:i,p1:s,p2:o,p3:a})=>{const c=s.sub(i).toVar(),l=a.sub(i).toVar(),u=c.cross(l),d=X().toVar();return qe(u.dot(t.sub(i)).greaterThanEqual(0),()=>{const h=e.sub(n.mul(e.dot(n))).normalize(),f=n.cross(h).negate(),p=r.mul(kt(h,f,n).transpose()).toVar(),g=p.mul(i.sub(t)).normalize().toVar(),x=p.mul(s.sub(t)).normalize().toVar(),m=p.mul(o.sub(t)).normalize().toVar(),y=p.mul(a.sub(t)).normalize().toVar(),_=X(0).toVar();_.addAssign(za({v1:g,v2:x})),_.addAssign(za({v1:x,v2:m})),_.addAssign(za({v1:m,v2:y})),_.addAssign(za({v1:y,v2:g})),d.assign(X(HO({f:_})))}),d}).setLayout({name:"LTC_Evaluate",type:"vec3",inputs:[{name:"N",type:"vec3"},{name:"V",type:"vec3"},{name:"P",type:"vec3"},{name:"mInv",type:"mat3"},{name:"p0",type:"vec3"},{name:"p1",type:"vec3"},{name:"p2",type:"vec3"},{name:"p3",type:"vec3"}]}),$l=1/6,xT=n=>ve($l,ve(n,ve(n,n.negate().add(3)).sub(3)).add(1)),Fh=n=>ve($l,ve(n,ve(n,ve(3,n).sub(6))).add(4)),yT=n=>ve($l,ve(n,ve(n,ve(-3,n).add(3)).add(3)).add(1)),kh=n=>ve($l,kl(n,3)),a0=n=>xT(n).add(Fh(n)),c0=n=>yT(n).add(kh(n)),l0=n=>Ht(-1,Fh(n).div(xT(n).add(Fh(n)))),u0=n=>Ht(1,kh(n).div(yT(n).add(kh(n)))),d0=(n,e,t)=>{const r=n.uvNode,i=ve(r,e.zw).add(.5),s=Ni(i),o=Hn(i),a=a0(o.x),c=c0(o.x),l=l0(o.x),u=u0(o.x),d=l0(o.y),h=u0(o.y),f=ne(s.x.add(l),s.y.add(d)).sub(.5).mul(e.xy),p=ne(s.x.add(u),s.y.add(d)).sub(.5).mul(e.xy),g=ne(s.x.add(l),s.y.add(h)).sub(.5).mul(e.xy),x=ne(s.x.add(u),s.y.add(h)).sub(.5).mul(e.xy),m=a0(o.y).mul(Ht(a.mul(n.sample(f).level(t)),c.mul(n.sample(p).level(t)))),y=c0(o.y).mul(Ht(a.mul(n.sample(g).level(t)),c.mul(n.sample(x).level(t))));return m.add(y)},WO=Q(([n,e])=>{const t=ne(n.size(ze(e))),r=ne(n.size(ze(e.add(1)))),i=jn(1,t),s=jn(1,r),o=d0(n,be(i,t),Ni(e)),a=d0(n,be(s,r),np(e));return Hn(e).mix(o,a)}),h0=Q(([n,e,t,r,i])=>{const s=X(Nv(e.negate(),zn(n),jn(1,r))),o=X(xr(i[0].xyz),xr(i[1].xyz),xr(i[2].xyz));return zn(s).mul(t.mul(o))}).setLayout({name:"getVolumeTransmissionRay",type:"vec3",inputs:[{name:"n",type:"vec3"},{name:"v",type:"vec3"},{name:"thickness",type:"float"},{name:"ior",type:"float"},{name:"modelMatrix",type:"mat4"}]}),qO=Q(([n,e])=>n.mul(vr(e.mul(2).sub(2),0,1))).setLayout({name:"applyIorToRoughness",type:"float",inputs:[{name:"roughness",type:"float"},{name:"ior",type:"float"}]}),XO=rT(),YO=rT(),f0=Q(([n,e,t],{material:r})=>{const s=(r.side===jt?XO:YO).sample(n),o=mr(Ph.x).mul(qO(e,t));return WO(s,o)}),p0=Q(([n,e,t])=>(qe(t.notEqual(0),()=>{const r=pv(e).negate().div(t);return fv(r.negate().mul(n))}),X(1))).setLayout({name:"volumeAttenuation",type:"vec3",inputs:[{name:"transmissionDistance",type:"float"},{name:"attenuationColor",type:"vec3"},{name:"attenuationDistance",type:"float"}]}),KO=Q(([n,e,t,r,i,s,o,a,c,l,u,d,h,f,p])=>{let g,x;if(p){g=be().toVar(),x=X().toVar();const T=u.sub(1).mul(p.mul(.025)),w=X(u.sub(T),u,u.add(T));rn({start:0,end:3},({i:N})=>{const E=w.element(N),A=h0(n,e,d,E,a),B=o.add(A),R=l.mul(c.mul(be(B,1))),L=ne(R.xy.div(R.w)).toVar();L.addAssign(1),L.divAssign(2),L.assign(ne(L.x,L.y.oneMinus()));const F=f0(L,t,E);g.element(N).assign(F.element(N)),g.a.addAssign(F.a),x.element(N).assign(r.element(N).mul(p0(xr(A),h,f).element(N)))}),g.a.divAssign(3)}else{const T=h0(n,e,d,u,a),w=o.add(T),N=l.mul(c.mul(be(w,1))),E=ne(N.xy.div(N.w)).toVar();E.addAssign(1),E.divAssign(2),E.assign(ne(E.x,E.y.oneMinus())),g=f0(E,t,u),x=r.mul(p0(xr(T),h,f))}const m=x.rgb.mul(g.rgb),y=n.dot(e).clamp(),_=X(mT({dotNV:y,specularColor:i,specularF90:s,roughness:t})),v=x.r.add(x.g,x.b).div(3);return be(_.oneMinus().mul(m),g.a.oneMinus().mul(v).oneMinus())}),QO=kt(3.2404542,-.969266,.0556434,-1.5371385,1.8760108,-.2040259,-.4985314,.041556,1.0572252),ZO=n=>{const e=n.sqrt();return X(1).add(e).div(X(1).sub(e))},g0=(n,e)=>n.sub(e).div(n.add(e)).pow2(),JO=(n,e)=>{const t=n.mul(2*Math.PI*1e-9),r=X(54856e-17,44201e-17,52481e-17),i=X(1681e3,1795300,2208400),s=X(43278e5,93046e5,66121e5),o=j(9747e-17*Math.sqrt(2*Math.PI*45282e5)).mul(t.mul(2239900).add(e.x).cos()).mul(t.pow2().mul(-45282e5).exp());let a=r.mul(s.mul(2*Math.PI).sqrt()).mul(i.mul(t).add(e).cos()).mul(t.pow2().negate().mul(s).exp());return a=X(a.x.add(o),a.y,a.z).div(10685e-11),QO.mul(a)},eU=Q(({outsideIOR:n,eta2:e,cosTheta1:t,thinFilmThickness:r,baseF0:i})=>{const s=He(n,e,Tr(0,.03,r)),a=n.div(s).pow2().mul(t.pow2().oneMinus()).oneMinus();qe(a.lessThan(0),()=>X(1));const c=a.sqrt(),l=g0(s,n),u=ea({f0:l,f90:1,dotVH:t}),d=u.oneMinus(),h=s.lessThan(n).select(Math.PI,0),f=j(Math.PI).sub(h),p=ZO(i.clamp(0,.9999)),g=g0(p,s.toVec3()),x=ea({f0:g,f90:1,dotVH:c}),m=X(p.x.lessThan(s).select(Math.PI,0),p.y.lessThan(s).select(Math.PI,0),p.z.lessThan(s).select(Math.PI,0)),y=s.mul(r,c,2),_=X(f).add(m),v=u.mul(x).clamp(1e-5,.9999),T=v.sqrt(),w=d.pow2().mul(x).div(X(1).sub(v)),E=u.add(w).toVar(),A=w.sub(d).toVar();return rn({start:1,end:2,condition:"<=",name:"m"},({m:B})=>{A.mulAssign(T);const R=JO(j(B).mul(y),j(B).mul(_)).mul(2);E.addAssign(A.mul(R))}),E.max(X(0))}).setLayout({name:"evalIridescence",type:"vec3",inputs:[{name:"outsideIOR",type:"float"},{name:"eta2",type:"float"},{name:"cosTheta1",type:"float"},{name:"thinFilmThickness",type:"float"},{name:"baseF0",type:"vec3"}]}),tU=Q(({normal:n,viewDir:e,roughness:t})=>{const r=n.dot(e).saturate(),i=t.pow2(),s=Tt(t.lessThan(.25),j(-339.2).mul(i).add(j(161.4).mul(t)).sub(25.9),j(-8.48).mul(i).add(j(14.3).mul(t)).sub(9.95)),o=Tt(t.lessThan(.25),j(44).mul(i).sub(j(23.7).mul(t)).add(3.26),j(1.97).mul(i).sub(j(3.27).mul(t)).add(.72));return Tt(t.lessThan(.25),0,j(.1).mul(t).sub(.025)).add(s.mul(r).add(o).exp()).mul(1/Math.PI).saturate()}),ku=X(.04),Iu=j(1);class bT extends Gl{constructor(e=!1,t=!1,r=!1,i=!1,s=!1,o=!1){super(),this.clearcoat=e,this.sheen=t,this.iridescence=r,this.anisotropy=i,this.transmission=s,this.dispersion=o,this.clearcoatRadiance=null,this.clearcoatSpecularDirect=null,this.clearcoatSpecularIndirect=null,this.sheenSpecularDirect=null,this.sheenSpecularIndirect=null,this.iridescenceFresnel=null,this.iridescenceF0=null}start(e){if(this.clearcoat===!0&&(this.clearcoatRadiance=X().toVar("clearcoatRadiance"),this.clearcoatSpecularDirect=X().toVar("clearcoatSpecularDirect"),this.clearcoatSpecularIndirect=X().toVar("clearcoatSpecularIndirect")),this.sheen===!0&&(this.sheenSpecularDirect=X().toVar("sheenSpecularDirect"),this.sheenSpecularIndirect=X().toVar("sheenSpecularIndirect")),this.iridescence===!0){const t=Fe.dot(Ke).clamp();this.iridescenceFresnel=eU({outsideIOR:j(1),eta2:rv,cosTheta1:t,thinFilmThickness:iv,baseF0:gn}),this.iridescenceF0=GO({f:this.iridescenceFresnel,f90:1,dotVH:t})}if(this.transmission===!0){const t=Ps,r=CI.sub(Ps).normalize(),i=$s,s=e.context;s.backdrop=KO(i,r,ur,Re,gn,al,t,Di,wr,Ov,Nc,sv,av,ov,this.dispersion?cv:null),s.backdropAlpha=Mh,Re.a.mulAssign(He(1,s.backdrop.a,Mh))}super.start(e)}computeMultiscattering(e,t,r){const i=Fe.dot(Ke).clamp(),s=ll({roughness:ur,dotNV:i}),o=this.iridescenceF0?Jf.mix(gn,this.iridescenceF0):gn,a=o.mul(s.x).add(r.mul(s.y)),l=s.x.add(s.y).oneMinus(),u=o.add(o.oneMinus().mul(.047619)),d=a.mul(u).div(l.mul(u).oneMinus());e.addAssign(a),t.addAssign(d.mul(l))}direct({lightDirection:e,lightColor:t,reflectedLight:r}){const s=Fe.dot(e).clamp().mul(t);if(this.sheen===!0&&this.sheenSpecularDirect.addAssign(s.mul(zO({lightDirection:e}))),this.clearcoat===!0){const a=as.dot(e).clamp().mul(t);this.clearcoatSpecularDirect.addAssign(a.mul(gT({lightDirection:e,f0:ku,f90:Iu,roughness:ol,normalView:as})))}r.directDiffuse.addAssign(s.mul(Ds({diffuseColor:Re.rgb}))),r.directSpecular.addAssign(s.mul(UO({lightDirection:e,f0:gn,f90:1,roughness:ur,f:this.iridescenceFresnel,USE_IRIDESCENCE:this.iridescence,USE_ANISOTROPY:this.anisotropy})))}directRectArea({lightColor:e,lightPosition:t,halfWidth:r,halfHeight:i,reflectedLight:s,ltc_1:o,ltc_2:a}){const c=t.add(r).sub(i),l=t.sub(r).sub(i),u=t.sub(r).add(i),d=t.add(r).add(i),h=Fe,f=Ke,p=ot.toVar(),g=jO({N:h,V:f,roughness:ur}),x=o.sample(g).toVar(),m=a.sample(g).toVar(),y=kt(X(x.x,0,x.y),X(0,1,0),X(x.z,0,x.w)).toVar(),_=gn.mul(m.x).add(gn.oneMinus().mul(m.y)).toVar();s.directSpecular.addAssign(e.mul(_).mul(o0({N:h,V:f,P:p,mInv:y,p0:c,p1:l,p2:u,p3:d}))),s.directDiffuse.addAssign(e.mul(Re).mul(o0({N:h,V:f,P:p,mInv:kt(1,0,0,0,1,0,0,0,1),p0:c,p1:l,p2:u,p3:d})))}indirect(e){this.indirectDiffuse(e),this.indirectSpecular(e),this.ambientOcclusion(e)}indirectDiffuse(e){const{irradiance:t,reflectedLight:r}=e.context;r.indirectDiffuse.addAssign(t.mul(Ds({diffuseColor:Re})))}indirectSpecular(e){const{radiance:t,iblIrradiance:r,reflectedLight:i}=e.context;if(this.sheen===!0&&this.sheenSpecularIndirect.addAssign(r.mul(os,tU({normal:Fe,viewDir:Ke,roughness:Zf}))),this.clearcoat===!0){const u=as.dot(Ke).clamp(),d=mT({dotNV:u,specularColor:ku,specularF90:Iu,roughness:ol});this.clearcoatSpecularIndirect.addAssign(this.clearcoatRadiance.mul(d))}const s=X().toVar("singleScattering"),o=X().toVar("multiScattering"),a=r.mul(1/Math.PI);this.computeMultiscattering(s,o,al);const c=s.add(o),l=Re.mul(c.r.max(c.g).max(c.b).oneMinus());i.indirectSpecular.addAssign(t.mul(s)),i.indirectSpecular.addAssign(o.mul(a)),i.indirectDiffuse.addAssign(l.mul(a))}ambientOcclusion(e){const{ambientOcclusion:t,reflectedLight:r}=e.context,s=Fe.dot(Ke).clamp().add(t),o=ur.mul(-16).oneMinus().negate().exp2(),a=t.sub(s.pow(o).oneMinus()).clamp();this.clearcoat===!0&&this.clearcoatSpecularIndirect.mulAssign(t),this.sheen===!0&&this.sheenSpecularIndirect.mulAssign(t),r.indirectDiffuse.mulAssign(t),r.indirectSpecular.mulAssign(a)}finish({context:e}){const{outgoingLight:t}=e;if(this.clearcoat===!0){const r=as.dot(Ke).clamp(),i=ea({dotVH:r,f0:ku,f90:Iu}),s=t.mul(Ah.mul(i).oneMinus()).add(this.clearcoatSpecularDirect.add(this.clearcoatSpecularIndirect).mul(Ah));t.assign(s)}if(this.sheen===!0){const r=os.r.max(os.g).max(os.b).mul(.157).oneMinus(),i=t.mul(r).add(this.sheenSpecularDirect,this.sheenSpecularIndirect);t.assign(i)}}}const m0=j(1),Ih=j(-2),ja=j(.8),Lu=j(-1),Ha=j(.4),Ou=j(2),Wa=j(.305),Uu=j(3),x0=j(.21),nU=j(4),y0=j(4),rU=j(16),iU=Q(([n])=>{const e=X(Kt(n)).toVar(),t=j(-1).toVar();return qe(e.x.greaterThan(e.z),()=>{qe(e.x.greaterThan(e.y),()=>{t.assign(Tt(n.x.greaterThan(0),0,3))}).Else(()=>{t.assign(Tt(n.y.greaterThan(0),1,4))})}).Else(()=>{qe(e.z.greaterThan(e.y),()=>{t.assign(Tt(n.z.greaterThan(0),2,5))}).Else(()=>{t.assign(Tt(n.y.greaterThan(0),1,4))})}),t}).setLayout({name:"getFace",type:"float",inputs:[{name:"direction",type:"vec3"}]}),sU=Q(([n,e])=>{const t=ne().toVar();return qe(e.equal(0),()=>{t.assign(ne(n.z,n.y).div(Kt(n.x)))}).ElseIf(e.equal(1),()=>{t.assign(ne(n.x.negate(),n.z.negate()).div(Kt(n.y)))}).ElseIf(e.equal(2),()=>{t.assign(ne(n.x.negate(),n.y).div(Kt(n.z)))}).ElseIf(e.equal(3),()=>{t.assign(ne(n.z.negate(),n.y).div(Kt(n.x)))}).ElseIf(e.equal(4),()=>{t.assign(ne(n.x.negate(),n.z).div(Kt(n.y)))}).Else(()=>{t.assign(ne(n.x,n.y).div(Kt(n.z)))}),ve(.5,t.add(1))}).setLayout({name:"getUV",type:"vec2",inputs:[{name:"direction",type:"vec3"},{name:"face",type:"float"}]}),oU=Q(([n])=>{const e=j(0).toVar();return qe(n.greaterThanEqual(ja),()=>{e.assign(m0.sub(n).mul(Lu.sub(Ih)).div(m0.sub(ja)).add(Ih))}).ElseIf(n.greaterThanEqual(Ha),()=>{e.assign(ja.sub(n).mul(Ou.sub(Lu)).div(ja.sub(Ha)).add(Lu))}).ElseIf(n.greaterThanEqual(Wa),()=>{e.assign(Ha.sub(n).mul(Uu.sub(Ou)).div(Ha.sub(Wa)).add(Ou))}).ElseIf(n.greaterThanEqual(x0),()=>{e.assign(Wa.sub(n).mul(nU.sub(Uu)).div(Wa.sub(x0)).add(Uu))}).Else(()=>{e.assign(j(-2).mul(mr(ve(1.16,n))))}),e}).setLayout({name:"roughnessToMip",type:"float",inputs:[{name:"roughness",type:"float"}]}),aU=Q(([n,e])=>{const t=n.toVar();t.assign(ve(2,t).sub(1));const r=X(t,1).toVar();return qe(e.equal(0),()=>{r.assign(r.zyx)}).ElseIf(e.equal(1),()=>{r.assign(r.xzy),r.xz.mulAssign(-1)}).ElseIf(e.equal(2),()=>{r.x.mulAssign(-1)}).ElseIf(e.equal(3),()=>{r.assign(r.zyx),r.xz.mulAssign(-1)}).ElseIf(e.equal(4),()=>{r.assign(r.xzy),r.xy.mulAssign(-1)}).ElseIf(e.equal(5),()=>{r.z.mulAssign(-1)}),r}).setLayout({name:"getDirection",type:"vec3",inputs:[{name:"uv",type:"vec2"},{name:"face",type:"float"}]}),cU=Q(([n,e,t,r,i,s])=>{const o=j(t),a=X(e),c=vr(oU(o),Ih,s),l=Hn(c),u=Ni(c),d=X(ta(n,a,u,r,i,s)).toVar();return qe(l.notEqual(0),()=>{const h=X(ta(n,a,u.add(1),r,i,s)).toVar();d.assign(He(d,h,l))}),d}),ta=Q(([n,e,t,r,i,s])=>{const o=j(t).toVar(),a=X(e),c=j(iU(a)).toVar(),l=j(gt(y0.sub(o),0)).toVar();o.assign(gt(o,y0));const u=j(Ko(o)).toVar(),d=ne(sU(a,c).mul(u.sub(2)).add(1)).toVar();return qe(c.greaterThan(2),()=>{d.y.addAssign(u),c.subAssign(3)}),d.x.addAssign(c.mul(u)),d.x.addAssign(l.mul(ve(3,rU))),d.y.addAssign(ve(4,Ko(s).sub(u))),d.x.mulAssign(r),d.y.mulAssign(i),n.sample(d).grad(ne(),ne())}),Gu=Q(({envMap:n,mipInt:e,outputDirection:t,theta:r,axis:i,CUBEUV_TEXEL_WIDTH:s,CUBEUV_TEXEL_HEIGHT:o,CUBEUV_MAX_MIP:a})=>{const c=or(r),l=t.mul(c).add(i.cross(t).mul(tn(r))).add(i.mul(i.dot(t).mul(c.oneMinus())));return ta(n,l,e,s,o,a)}),lU=Q(({n,latitudinal:e,poleAxis:t,outputDirection:r,weights:i,samples:s,dTheta:o,mipInt:a,envMap:c,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:d})=>{const h=X(Tt(e,t,Qo(t,r))).toVar();qe(h.equal(X(0)),()=>{h.assign(X(r.z,0,r.x.negate()))}),h.assign(zn(h));const f=X().toVar();return f.addAssign(i.element(0).mul(Gu({theta:0,axis:h,outputDirection:r,mipInt:a,envMap:c,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:d}))),rn({start:ze(1),end:n},({i:p})=>{qe(p.greaterThanEqual(s),()=>{qL()});const g=j(o.mul(j(p))).toVar();f.addAssign(i.element(p).mul(Gu({theta:g.mul(-1),axis:h,outputDirection:r,mipInt:a,envMap:c,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:d}))),f.addAssign(i.element(p).mul(Gu({theta:g,axis:h,outputDirection:r,mipInt:a,envMap:c,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:d})))}),be(f,1)}),uU=Q(([n])=>{const e=nt(n).toVar();return e.assign(e.shiftLeft(nt(16)).bitOr(e.shiftRight(nt(16)))),e.assign(e.bitAnd(nt(1431655765)).shiftLeft(nt(1)).bitOr(e.bitAnd(nt(2863311530)).shiftRight(nt(1)))),e.assign(e.bitAnd(nt(858993459)).shiftLeft(nt(2)).bitOr(e.bitAnd(nt(3435973836)).shiftRight(nt(2)))),e.assign(e.bitAnd(nt(252645135)).shiftLeft(nt(4)).bitOr(e.bitAnd(nt(4042322160)).shiftRight(nt(4)))),e.assign(e.bitAnd(nt(16711935)).shiftLeft(nt(8)).bitOr(e.bitAnd(nt(4278255360)).shiftRight(nt(8)))),j(e).mul(23283064365386963e-26)}),dU=Q(([n,e])=>ne(j(n).div(j(e)),uU(n))),hU=Q(([n,e,t])=>{const r=X(e).toVar(),i=j(t),s=i.mul(i).toVar(),o=zn(X(s.mul(r.x),s.mul(r.y),r.z)).toVar(),a=o.x.mul(o.x).add(o.y.mul(o.y)),c=Tt(a.greaterThan(0),X(o.y.negate(),o.x,0).div(_i(a)),X(1,0,0)).toVar(),l=Qo(o,c).toVar(),u=_i(n.x),d=ve(2,3.14159265359).mul(n.y),h=u.mul(or(d)).toVar(),f=u.mul(tn(d)).toVar(),p=ve(.5,o.z.add(1));f.assign(p.oneMinus().mul(_i(h.mul(h).oneMinus())).add(p.mul(f)));const g=c.mul(h).add(l.mul(f)).add(o.mul(_i(gt(0,h.mul(h).add(f.mul(f)).oneMinus()))));return zn(X(s.mul(g.x),s.mul(g.y),gt(0,g.z)))}),fU=Q(({roughness:n,mipInt:e,envMap:t,N_immutable:r,GGX_SAMPLES:i,CUBEUV_TEXEL_WIDTH:s,CUBEUV_TEXEL_HEIGHT:o,CUBEUV_MAX_MIP:a})=>{const c=X(r).toVar(),l=X(0).toVar(),u=j(0).toVar();return qe(n.lessThan(.001),()=>{l.assign(ta(t,c,e,s,o,a))}).Else(()=>{const d=Tt(Kt(c.z).lessThan(.999),X(0,0,1),X(1,0,0)),h=zn(Qo(d,c)).toVar(),f=Qo(c,h).toVar();rn({start:nt(0),end:i},({i:p})=>{const g=dU(p,i),x=hU(g,X(0,0,1),n),m=zn(h.mul(x.x).add(f.mul(x.y)).add(c.mul(x.z))),y=zn(m.mul(Cs(c,m).mul(2)).sub(c)),_=gt(Cs(c,y),0);qe(_.greaterThan(0),()=>{const v=ta(t,y,e,s,o,a);l.addAssign(v.mul(_)),u.addAssign(_)})}),qe(u.greaterThan(0),()=>{l.assign(l.div(u))})}),be(l,1)}),Ir=4,b0=[.125,.215,.35,.446,.526,.582],pi=20,pU=512,ao=new sf(-1,1,1,-1,0,1),gU=new Go(90,1),_0=new un;let $u=null,Vu=0,zu=0;const mU=new le,ul=new WeakMap,xU=[3,1,5,0,4,2],ju=aU(Us(),jr("faceIndex")).normalize(),Vl=X(ju.x,ju.y,ju.z);class yU{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._sizeLods=[],this._sigmas=[],this._lodMeshes=[],this._blurMaterial=null,this._ggxMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._backgroundBox=null}get _hasInitialized(){return this._renderer.hasInitialized()}fromScene(e,t=0,r=.1,i=100,s={}){const{size:o=256,position:a=mU,renderTarget:c=null}=s;if(this._setSize(o),this._hasInitialized===!1){se('PMREMGenerator: ".fromScene()" called before the backend is initialized. Try using "await renderer.init()" instead.');const u=c||this._allocateTarget();return s.renderTarget=u,this.fromSceneAsync(e,t,r,i,s),u}$u=this._renderer.getRenderTarget(),Vu=this._renderer.getActiveCubeFace(),zu=this._renderer.getActiveMipmapLevel();const l=c||this._allocateTarget();return l.depthBuffer=!0,this._init(l),this._sceneToCubeUV(e,r,i,l,a),t>0&&this._blur(l,0,0,t),this._applyPMREM(l),this._cleanup(l),l}async fromSceneAsync(e,t=0,r=.1,i=100,s={}){return lt('PMREMGenerator: ".fromSceneAsync()" is deprecated. Use "await renderer.init()" instead.'),await this._renderer.init(),this.fromScene(e,t,r,i,s)}fromEquirectangular(e,t=null){if(this._hasInitialized===!1){se('PMREMGenerator: .fromEquirectangular() called before the backend is initialized. Try using "await renderer.init()" instead.'),this._setSizeFromTexture(e);const r=t||this._allocateTarget();return this.fromEquirectangularAsync(e,r),r}return this._fromTexture(e,t)}async fromEquirectangularAsync(e,t=null){return lt('PMREMGenerator: ".fromEquirectangularAsync()" is deprecated. Use "await renderer.init()" instead.'),await this._renderer.init(),this._fromTexture(e,t)}fromCubemap(e,t=null){if(this._hasInitialized===!1){se("PMREMGenerator: .fromCubemap() called before the backend is initialized. Try using .fromCubemapAsync() instead."),this._setSizeFromTexture(e);const r=t||this._allocateTarget();return this.fromCubemapAsync(e,t),r}return this._fromTexture(e,t)}async fromCubemapAsync(e,t=null){return lt('PMREMGenerator: ".fromCubemapAsync()" is deprecated. Use "await renderer.init()" instead.'),await this._renderer.init(),this._fromTexture(e,t)}async compileCubemapShader(){this._cubemapMaterial===null&&(this._cubemapMaterial=T0(),await this._compileMaterial(this._cubemapMaterial))}async compileEquirectangularShader(){this._equirectMaterial===null&&(this._equirectMaterial=w0(),await this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),this._cubemapMaterial!==null&&this._cubemapMaterial.dispose(),this._equirectMaterial!==null&&this._equirectMaterial.dispose(),this._backgroundBox!==null&&(this._backgroundBox.geometry.dispose(),this._backgroundBox.material.dispose())}_setSizeFromTexture(e){e.mapping===Lc||e.mapping===Oc?this._setSize(e.image.length===0?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4)}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){this._blurMaterial!==null&&this._blurMaterial.dispose(),this._ggxMaterial!==null&&this._ggxMaterial.dispose(),this._pingPongRenderTarget!==null&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodMeshes.length;e++)this._lodMeshes[e].geometry.dispose()}_cleanup(e){this._renderer.setRenderTarget($u,Vu,zu),e.scissorTest=!1,Yi(e,0,0,e.width,e.height)}_fromTexture(e,t){this._setSizeFromTexture(e),$u=this._renderer.getRenderTarget(),Vu=this._renderer.getActiveCubeFace(),zu=this._renderer.getActiveMipmapLevel();const r=t||this._allocateTarget();return this._init(r),this._textureToCubeUV(e,r),this._applyPMREM(r),this._cleanup(r),r}_allocateTarget(){const e=3*Math.max(this._cubeSize,112),t=4*this._cubeSize;return v0(e,t)}_init(e){if(this._pingPongRenderTarget===null||this._pingPongRenderTarget.width!==e.width||this._pingPongRenderTarget.height!==e.height){this._pingPongRenderTarget!==null&&this._dispose(),this._pingPongRenderTarget=v0(e.width,e.height);const{_lodMax:t}=this;({lodMeshes:this._lodMeshes,sizeLods:this._sizeLods,sigmas:this._sigmas}=bU(t)),this._blurMaterial=_U(t,e.width,e.height),this._ggxMaterial=vU(t,e.width,e.height)}}async _compileMaterial(e){const t=new wn(new sa,e);await this._renderer.compile(t,ao)}_sceneToCubeUV(e,t,r,i,s){const o=gU;o.near=t,o.far=r;const a=[1,1,1,1,-1,1],c=[1,-1,1,-1,1,-1],l=this._renderer,u=l.autoClear;l.getClearColor(_0),l.autoClear=!1,this._backgroundBox===null&&(this._backgroundBox=new wn(new Py,new Mr({name:"PMREM.Background",side:jt,depthWrite:!1,depthTest:!1})));const d=this._backgroundBox,h=d.material;let f=!1;const p=e.background;p?p.isColor&&(h.color.copy(p),e.background=null,f=!0):(h.color.copy(_0),f=!0),l.setRenderTarget(i),l.clear(),f&&l.render(d,o);for(let g=0;g<6;g++){const x=g%3;x===0?(o.up.set(0,a[g],0),o.position.set(s.x,s.y,s.z),o.lookAt(s.x+c[g],s.y,s.z)):x===1?(o.up.set(0,0,a[g]),o.position.set(s.x,s.y,s.z),o.lookAt(s.x,s.y+c[g],s.z)):(o.up.set(0,a[g],0),o.position.set(s.x,s.y,s.z),o.lookAt(s.x,s.y,s.z+c[g]));const m=this._cubeSize;Yi(i,x*m,g>2?m:0,m,m),l.render(e,o)}l.autoClear=u,e.background=p}_textureToCubeUV(e,t){const r=this._renderer,i=e.mapping===Lc||e.mapping===Oc;i?this._cubemapMaterial===null&&(this._cubemapMaterial=T0(e)):this._equirectMaterial===null&&(this._equirectMaterial=w0(e));const s=i?this._cubemapMaterial:this._equirectMaterial;s.fragmentNode.value=e;const o=this._lodMeshes[0];o.material=s;const a=this._cubeSize;Yi(t,0,0,3*a,2*a),r.setRenderTarget(t),r.render(o,ao)}_applyPMREM(e){const t=this._renderer,r=t.autoClear;t.autoClear=!1;const i=this._lodMeshes.length;for(let s=1;s<i;s++)this._applyGGXFilter(e,s-1,s);t.autoClear=r}_applyGGXFilter(e,t,r){const i=this._renderer,s=this._pingPongRenderTarget,o=this._ggxMaterial,a=this._lodMeshes[r];a.material=o;const c=ul.get(o),l=r/(this._lodMeshes.length-1),u=t/(this._lodMeshes.length-1),d=Math.sqrt(l*l-u*u),h=.05+l*.95,f=d*h,{_lodMax:p}=this,g=this._sizeLods[r],x=3*g*(r>p-Ir?r-p+Ir:0),m=4*(this._cubeSize-g);e.texture.frame=(e.texture.frame||0)+1,c.envMap.value=e.texture,c.roughness.value=f,c.mipInt.value=p-t,Yi(s,x,m,3*g,2*g),i.setRenderTarget(s),i.render(a,ao),s.texture.frame=(s.texture.frame||0)+1,c.envMap.value=s.texture,c.roughness.value=0,c.mipInt.value=p-r,Yi(e,x,m,3*g,2*g),i.setRenderTarget(e),i.render(a,ao)}_blur(e,t,r,i,s){const o=this._pingPongRenderTarget;this._halfBlur(e,o,t,r,i,"latitudinal",s),this._halfBlur(o,e,r,r,i,"longitudinal",s)}_halfBlur(e,t,r,i,s,o,a){const c=this._renderer,l=this._blurMaterial;o!=="latitudinal"&&o!=="longitudinal"&&ie("blur direction must be either latitudinal or longitudinal!");const u=3,d=this._lodMeshes[i];d.material=l;const h=ul.get(l),f=this._sizeLods[r]-1,p=isFinite(s)?Math.PI/(2*f):2*Math.PI/(2*pi-1),g=s/p,x=isFinite(s)?1+Math.floor(u*g):pi;x>pi&&se(`sigmaRadians, ${s}, is too large and will clip, as it requested ${x} samples when the maximum is set to ${pi}`);const m=[];let y=0;for(let N=0;N<pi;++N){const E=N/g,A=Math.exp(-E*E/2);m.push(A),N===0?y+=A:N<x&&(y+=2*A)}for(let N=0;N<m.length;N++)m[N]=m[N]/y;e.texture.frame=(e.texture.frame||0)+1,h.envMap.value=e.texture,h.samples.value=x,h.weights.array=m,h.latitudinal.value=o==="latitudinal"?1:0,a&&(h.poleAxis.value=a);const{_lodMax:_}=this;h.dTheta.value=p,h.mipInt.value=_-r;const v=this._sizeLods[i],T=3*v*(i>_-Ir?i-_+Ir:0),w=4*(this._cubeSize-v);Yi(t,T,w,3*v,2*v),c.setRenderTarget(t),c.render(d,ao)}}function bU(n){const e=[],t=[],r=[];let i=n;const s=n-Ir+1+b0.length;for(let o=0;o<s;o++){const a=Math.pow(2,i);e.push(a);let c=1/a;o>n-Ir?c=b0[o-n+Ir-1]:o===0&&(c=0),t.push(c);const l=1/(a-2),u=-l,d=1+l,h=[u,u,d,u,d,d,u,u,d,d,u,d],f=6,p=6,g=3,x=2,m=1,y=new Float32Array(g*p*f),_=new Float32Array(x*p*f),v=new Float32Array(m*p*f);for(let w=0;w<f;w++){const N=w%3*2/3-1,E=w>2?0:-1,A=[N,E,0,N+2/3,E,0,N+2/3,E+1,0,N,E,0,N+2/3,E+1,0,N,E+1,0],B=xU[w];y.set(A,g*p*B),_.set(h,x*p*B);const R=[B,B,B,B,B,B];v.set(R,m*p*B)}const T=new sa;T.setAttribute("position",new hc(y,g)),T.setAttribute("uv",new hc(_,x)),T.setAttribute("faceIndex",new hc(v,m)),r.push(new wn(T,null)),i>Ir&&i--}return{lodMeshes:r,sizeLods:e,sigmas:t}}function v0(n,e){const t={magFilter:Sn,minFilter:Sn,generateMipmaps:!1,type:Ft,format:_n,colorSpace:PS},r=new Is(n,e,t);return r.texture.mapping=Nd,r.texture.name="PMREM.cubeUv",r.texture.isPMREMTexture=!0,r.scissorTest=!0,r}function Yi(n,e,t,r,i){n.viewport.set(e,t,r,i),n.scissor.set(e,t,r,i)}function zl(n){const e=new at;return e.depthTest=!1,e.depthWrite=!1,e.blending=vs,e.name=`PMREM_${n}`,e}function _U(n,e,t){const r=bn(new Array(pi).fill(0)),i=pe(new le(0,1,0)),s=pe(0),o=j(pi),a=pe(0),c=pe(1),l=Ae(),u=pe(0),d=j(1/e),h=j(1/t),f=j(n),p={n:o,latitudinal:a,weights:r,poleAxis:i,outputDirection:Vl,dTheta:s,samples:c,envMap:l,mipInt:u,CUBEUV_TEXEL_WIDTH:d,CUBEUV_TEXEL_HEIGHT:h,CUBEUV_MAX_MIP:f},g=zl("blur");return g.fragmentNode=lU({...p,latitudinal:a.equal(1)}),ul.set(g,p),g}function vU(n,e,t){const r=Ae(),i=pe(0),s=pe(0),o=j(1/e),a=j(1/t),c=j(n),l={envMap:r,roughness:i,mipInt:s,CUBEUV_TEXEL_WIDTH:o,CUBEUV_TEXEL_HEIGHT:a,CUBEUV_MAX_MIP:c},u=zl("ggx");return u.fragmentNode=fU({...l,N_immutable:Vl,GGX_SAMPLES:nt(pU)}),ul.set(u,l),u}function T0(n){const e=zl("cubemap");return e.fragmentNode=Jo(n,Vl),e}function w0(n){const e=zl("equirect");return e.fragmentNode=Ae(n,cT(Vl),0),e}const S0=new WeakMap;function TU(n){const e=Math.log2(n)-2,t=1/n;return{texelWidth:1/(3*Math.max(Math.pow(2,e),112)),texelHeight:t,maxMip:e}}function wU(n,e,t){const r=SU(e);let i=r.get(n);if((i!==void 0?i.pmremVersion:-1)!==n.pmremVersion){const o=n.image;if(n.isCubeTexture)if(EU(o))i=t.fromCubemap(n,i);else return null;else if(AU(o))i=t.fromEquirectangular(n,i);else return null;i.pmremVersion=n.pmremVersion,r.set(n,i)}return i.texture}function SU(n){let e=S0.get(n);return e===void 0&&(e=new WeakMap,S0.set(n,e)),e}class NU extends mt{static get type(){return"PMREMNode"}constructor(e,t=null,r=null){super("vec3"),this._value=e,this._pmrem=null,this.uvNode=t,this.levelNode=r,this._generator=null;const i=new lf;i.isRenderTargetTexture=!0,this._texture=Ae(i),this._width=pe(0),this._height=pe(0),this._maxMip=pe(0),this.updateBeforeType=_e.RENDER}set value(e){this._value=e,this._pmrem=null}get value(){return this._value}updateFromTexture(e){const t=TU(e.image.height);this._texture.value=e,this._width.value=t.texelWidth,this._height.value=t.texelHeight,this._maxMip.value=t.maxMip}updateBefore(e){let t=this._pmrem;const r=t?t.pmremVersion:-1,i=this._value;r!==i.pmremVersion&&(i.isPMREMTexture===!0?t=i:t=wU(i,e.renderer,this._generator),t!==null&&(this._pmrem=t,this.updateFromTexture(t)))}setup(e){this._generator===null&&(this._generator=new yU(e.renderer)),this.updateBefore(e);let t=this.uvNode;t===null&&e.context.getUV&&(t=e.context.getUV(this)),t=zv.mul(X(t.x,t.y.negate(),t.z));let r=this.levelNode;return r===null&&e.context.getTextureLevel&&(r=e.context.getTextureLevel(this)),cU(this._texture,t,r,this._width,this._height,this._maxMip)}dispose(){super.dispose(),this._generator!==null&&this._generator.dispose()}}function EU(n){if(n==null)return!1;let e=0;const t=6;for(let r=0;r<t;r++)n[r]!==void 0&&e++;return e===t}function AU(n){return n==null?!1:n.height>0}const _T=Pe(NU).setParameterLength(1,3),N0=new WeakMap;class RU extends Vs{static get type(){return"EnvironmentNode"}constructor(e=null){super(),this.envNode=e}setup(e){const{material:t}=e;let r=this.envNode;if(r.isTextureNode||r.isMaterialReferenceNode){const d=r.isTextureNode?r.value:t[r.property];let h=N0.get(d);h===void 0&&(h=_T(d),N0.set(d,h)),r=h}const s=t.useAnisotropy===!0||t.anisotropy>0?eL:Fe,o=r.context(E0(ur,s)).mul(Du),a=r.context(CU($s)).mul(Math.PI).mul(Du),c=Io(o),l=Io(a);e.context.radiance.addAssign(c),e.context.iblIrradiance.addAssign(l);const u=e.context.lightingModel.clearcoatRadiance;if(u){const d=r.context(E0(ol,as)).mul(Du),h=Io(d);u.addAssign(h)}}}const E0=(n,e)=>{let t=null;return{getUV:()=>(t===null&&(t=Ke.negate().reflect(e),t=Tv(n).mix(t,e).normalize(),t=t.transformDirection(wr)),t),getTextureLevel:()=>n}},CU=n=>({getUV:()=>n,getTextureLevel:()=>j(1)}),MU=new $w;class vT extends at{static get type(){return"MeshStandardNodeMaterial"}constructor(e){super(),this.isMeshStandardNodeMaterial=!0,this.lights=!0,this.emissiveNode=null,this.metalnessNode=null,this.roughnessNode=null,this.setDefaultValues(MU),this.setValues(e)}setupEnvironment(e){let t=super.setupEnvironment(e);return t===null&&e.environmentNode&&(t=e.environmentNode),t?new RU(t):null}setupLightingModel(){return new bT}setupSpecular(){const e=He(X(.04),Re.rgb,sl);gn.assign(e),al.assign(1)}setupVariants(){const e=this.metalnessNode?j(this.metalnessNode):fL;sl.assign(e);let t=this.roughnessNode?j(this.roughnessNode):hL;t=pT({roughness:t}),ur.assign(t),this.setupSpecular(),Re.assign(be(Re.rgb.mul(e.oneMinus()),Re.a))}copy(e){return this.emissiveNode=e.emissiveNode,this.metalnessNode=e.metalnessNode,this.roughnessNode=e.roughnessNode,super.copy(e)}}const PU=new Vw;class DU extends vT{static get type(){return"MeshPhysicalNodeMaterial"}constructor(e){super(),this.isMeshPhysicalNodeMaterial=!0,this.clearcoatNode=null,this.clearcoatRoughnessNode=null,this.clearcoatNormalNode=null,this.sheenNode=null,this.sheenRoughnessNode=null,this.iridescenceNode=null,this.iridescenceIORNode=null,this.iridescenceThicknessNode=null,this.specularIntensityNode=null,this.specularColorNode=null,this.iorNode=null,this.transmissionNode=null,this.thicknessNode=null,this.attenuationDistanceNode=null,this.attenuationColorNode=null,this.dispersionNode=null,this.anisotropyNode=null,this.setDefaultValues(PU),this.setValues(e)}get useClearcoat(){return this.clearcoat>0||this.clearcoatNode!==null}get useIridescence(){return this.iridescence>0||this.iridescenceNode!==null}get useSheen(){return this.sheen>0||this.sheenNode!==null}get useAnisotropy(){return this.anisotropy>0||this.anisotropyNode!==null}get useTransmission(){return this.transmission>0||this.transmissionNode!==null}get useDispersion(){return this.dispersion>0||this.dispersionNode!==null}setupSpecular(){const e=this.iorNode?j(this.iorNode):AL;Nc.assign(e),gn.assign(He(Rs(vv(Nc.sub(1).div(Nc.add(1))).mul(dL),X(1)).mul(e0),Re.rgb,sl)),al.assign(He(e0,1,sl))}setupLightingModel(){return new bT(this.useClearcoat,this.useSheen,this.useIridescence,this.useAnisotropy,this.useTransmission,this.useDispersion)}setupVariants(e){if(super.setupVariants(e),this.useClearcoat){const t=this.clearcoatNode?j(this.clearcoatNode):gL,r=this.clearcoatRoughnessNode?j(this.clearcoatRoughnessNode):mL;Ah.assign(t),ol.assign(pT({roughness:r}))}if(this.useSheen){const t=this.sheenNode?X(this.sheenNode):bL,r=this.sheenRoughnessNode?j(this.sheenRoughnessNode):_L;os.assign(t),Zf.assign(r)}if(this.useIridescence){const t=this.iridescenceNode?j(this.iridescenceNode):TL,r=this.iridescenceIORNode?j(this.iridescenceIORNode):wL,i=this.iridescenceThicknessNode?j(this.iridescenceThicknessNode):SL;Jf.assign(t),rv.assign(r),iv.assign(i)}if(this.useAnisotropy){const t=(this.anisotropyNode?ne(this.anisotropyNode):vL).toVar();li.assign(t.length()),qe(li.equal(0),()=>{t.assign(ne(1,0))}).Else(()=>{t.divAssign(ne(li)),li.assign(li.saturate())}),Rh.assign(li.pow2().mix(ur.pow2(),1)),Sc.assign(So[0].mul(t.x).add(So[1].mul(t.y))),xs.assign(So[1].mul(t.x).sub(So[0].mul(t.y)))}if(this.useTransmission){const t=this.transmissionNode?j(this.transmissionNode):NL,r=this.thicknessNode?j(this.thicknessNode):EL,i=this.attenuationDistanceNode?j(this.attenuationDistanceNode):RL,s=this.attenuationColorNode?X(this.attenuationColorNode):CL;if(Mh.assign(t),sv.assign(r),ov.assign(i),av.assign(s),this.useDispersion){const o=this.dispersionNode?j(this.dispersionNode):kL;cv.assign(o)}}}setupClearcoatNormal(){return this.clearcoatNormalNode?X(this.clearcoatNormalNode):xL}setup(e){e.context.setupClearcoatNormal=()=>ko(this.setupClearcoatNormal(e),"NORMAL","vec3"),super.setup(e)}copy(e){return this.clearcoatNode=e.clearcoatNode,this.clearcoatRoughnessNode=e.clearcoatRoughnessNode,this.clearcoatNormalNode=e.clearcoatNormalNode,this.sheenNode=e.sheenNode,this.sheenRoughnessNode=e.sheenRoughnessNode,this.iridescenceNode=e.iridescenceNode,this.iridescenceIORNode=e.iridescenceIORNode,this.iridescenceThicknessNode=e.iridescenceThicknessNode,this.specularIntensityNode=e.specularIntensityNode,this.specularColorNode=e.specularColorNode,this.transmissionNode=e.transmissionNode,this.thicknessNode=e.thicknessNode,this.attenuationDistanceNode=e.attenuationDistanceNode,this.attenuationColorNode=e.attenuationColorNode,this.dispersionNode=e.dispersionNode,this.anisotropyNode=e.anisotropyNode,super.copy(e)}}const BU=Q(({normal:n,lightDirection:e,builder:t})=>{const r=n.dot(e),i=ne(r.mul(.5).add(.5),0);if(t.material.gradientMap){const s=Dr("gradientMap","texture").context({getUV:()=>i});return X(s.r)}else{const s=i.fwidth().mul(.5);return He(X(.7),X(1),Tr(j(.7).sub(s.x),j(.7).add(s.x),i.x))}});class FU extends Gl{direct({lightDirection:e,lightColor:t,reflectedLight:r},i){const s=BU({normal:$v,lightDirection:e,builder:i}).mul(t);r.directDiffuse.addAssign(s.mul(Ds({diffuseColor:Re.rgb})))}indirect(e){const{ambientOcclusion:t,irradiance:r,reflectedLight:i}=e.context;i.indirectDiffuse.addAssign(r.mul(Ds({diffuseColor:Re}))),i.indirectDiffuse.mulAssign(t)}}const kU=new zw;class IU extends at{static get type(){return"MeshToonNodeMaterial"}constructor(e){super(),this.isMeshToonNodeMaterial=!0,this.lights=!0,this.setDefaultValues(kU),this.setValues(e)}setupLightingModel(){return new FU}}const LU=Q(()=>{const n=X(Ke.z,0,Ke.x.negate()).normalize(),e=Ke.cross(n);return ne(n.dot(Fe),e.dot(Fe)).mul(.495).add(.5)}).once(["NORMAL","VERTEX"])().toVar("matcapUV"),OU=new Hw;class UU extends at{static get type(){return"MeshMatcapNodeMaterial"}constructor(e){super(),this.isMeshMatcapNodeMaterial=!0,this.setDefaultValues(OU),this.setValues(e)}setupVariants(e){const t=LU;let r;e.material.matcap?r=Dr("matcap","texture").context({getUV:()=>t}):r=X(He(.2,.8,t.y)),Re.rgb.mulAssign(r.rgb)}}class GU extends mt{static get type(){return"RotateNode"}constructor(e,t){super(),this.positionNode=e,this.rotationNode=t}getNodeType(e){return this.positionNode.getNodeType(e)}setup(e){const{rotationNode:t,positionNode:r}=this;if(this.getNodeType(e)==="vec2"){const s=t.cos(),o=t.sin();return Qf(s,o,o.negate(),s).mul(r)}else{const s=t,o=ms(be(1,0,0,0),be(0,or(s.x),tn(s.x).negate(),0),be(0,tn(s.x),or(s.x),0),be(0,0,0,1)),a=ms(be(or(s.y),0,tn(s.y),0),be(0,1,0,0),be(tn(s.y).negate(),0,or(s.y),0),be(0,0,0,1)),c=ms(be(or(s.z),tn(s.z).negate(),0,0),be(tn(s.z),or(s.z),0,0),be(0,0,1,0),be(0,0,0,1));return o.mul(a).mul(c).mul(be(r,1)).xyz}}}const TT=Pe(GU).setParameterLength(2),$U=new Xw;class wT extends at{static get type(){return"SpriteNodeMaterial"}constructor(e){super(),this.isSpriteNodeMaterial=!0,this._useSizeAttenuation=!0,this.positionNode=null,this.rotationNode=null,this.scaleNode=null,this.transparent=!0,this.setDefaultValues($U),this.setValues(e)}setupPositionView(e){const{object:t,camera:r}=e,{positionNode:i,rotationNode:s,scaleNode:o,sizeAttenuation:a}=this,c=Ol.mul(X(i||0));let l=ne(Di[0].xyz.length(),Di[1].xyz.length());o!==null&&(l=l.mul(ne(o))),r.isPerspectiveCamera&&a===!1&&(l=l.mul(c.z.negate()));let u=Ul.xy;if(t.center&&t.center.isVector2===!0){const f=Qk("center","vec2",t);u=u.sub(f.sub(.5))}u=u.mul(l);const d=j(s||yL),h=TT(u,d);return be(c.xy.add(h),c.zw)}copy(e){return this.positionNode=e.positionNode,this.rotationNode=e.rotationNode,this.scaleNode=e.scaleNode,super.copy(e)}get sizeAttenuation(){return this._useSizeAttenuation}set sizeAttenuation(e){this._useSizeAttenuation!==e&&(this._useSizeAttenuation=e,this.needsUpdate=!0)}}const VU=new qw,zU=new Te;class jU extends wT{static get type(){return"PointsNodeMaterial"}constructor(e){super(),this.sizeNode=null,this.isPointsNodeMaterial=!0,this.setDefaultValues(VU),this.setValues(e)}setupPositionView(){const{positionNode:e}=this;return Ol.mul(X(e||Rt)).xyz}setupVertexSprite(e){const{material:t,camera:r}=e,{rotationNode:i,scaleNode:s,sizeNode:o,sizeAttenuation:a}=this;let c=super.setupVertex(e);if(t.isNodeMaterial!==!0)return c;let l=o!==null?ne(o):FL;l=l.mul(AI),r.isPerspectiveCamera&&a===!0&&(l=l.mul(HU.div(ot.z.negate()))),s&&s.isNode&&(l=l.mul(ne(s)));let u=Ul.xy;if(i&&i.isNode){const d=j(i);u=TT(u,d)}return u=u.mul(l),u=u.div(RI.div(2)),u=u.mul(c.w),c=c.add(be(u,0,0)),c}setupVertex(e){return e.object.isPoints?super.setupVertex(e):this.setupVertexSprite(e)}get alphaToCoverage(){return this._useAlphaToCoverage}set alphaToCoverage(e){this._useAlphaToCoverage!==e&&(this._useAlphaToCoverage=e,this.needsUpdate=!0)}}const HU=pe(1).onFrameUpdate(function({renderer:n}){const e=n.getSize(zU);this.value=.5*e.y});class WU extends Gl{constructor(){super(),this.shadowNode=j(1).toVar("shadowMask")}direct({lightNode:e}){e.shadowNode!==null&&this.shadowNode.mulAssign(e.shadowNode)}finish({context:e}){Re.a.mulAssign(this.shadowNode.oneMinus()),e.outgoingLight.rgb.assign(Re.rgb)}}const qU=new Yw;class XU extends at{static get type(){return"ShadowNodeMaterial"}constructor(e){super(),this.isShadowNodeMaterial=!0,this.lights=!0,this.transparent=!0,this.setDefaultValues(qU),this.setValues(e)}setupLightingModel(){return new WU}}zr("vec3");zr("vec3");zr("vec3");class YU{constructor(e,t,r){this.renderer=e,this.nodes=t,this.info=r,this._context=typeof self<"u"?self:null,this._animationLoop=null,this._requestId=null}start(){const e=(t,r)=>{this._requestId=this._context.requestAnimationFrame(e),this.info.autoReset===!0&&this.info.reset(),this.nodes.nodeFrame.update(),this.info.frame=this.nodes.nodeFrame.frameId,this.renderer._inspector.begin(),this._animationLoop!==null&&this._animationLoop(t,r),this.renderer._inspector.finish()};e()}stop(){this._context.cancelAnimationFrame(this._requestId),this._requestId=null}getAnimationLoop(){return this._animationLoop}setAnimationLoop(e){this._animationLoop=e}getContext(){return this._context}setContext(e){this._context=e}dispose(){this.stop()}}class Nn{constructor(){this.weakMap=new WeakMap}get(e){let t=this.weakMap;for(let r=0;r<e.length-1;r++)if(t=t.get(e[r]),t===void 0)return;return t.get(e[e.length-1])}set(e,t){let r=this.weakMap;for(let i=0;i<e.length-1;i++){const s=e[i];r.has(s)===!1&&r.set(s,new WeakMap),r=r.get(s)}return r.set(e[e.length-1],t),this}delete(e){let t=this.weakMap;for(let r=0;r<e.length-1;r++)if(t=t.get(e[r]),t===void 0)return!1;return t.delete(e[e.length-1])}}let KU=0;function QU(n){const e=Object.keys(n);let t=Object.getPrototypeOf(n);for(;t;){const r=Object.getOwnPropertyDescriptors(t);for(const i in r)if(r[i]!==void 0){const s=r[i];s&&typeof s.get=="function"&&e.push(i)}t=Object.getPrototypeOf(t)}return e}class ZU{constructor(e,t,r,i,s,o,a,c,l,u){this.id=KU++,this._nodes=e,this._geometries=t,this.renderer=r,this.object=i,this.material=s,this.scene=o,this.camera=a,this.lightsNode=c,this.context=l,this.geometry=i.geometry,this.version=s.version,this.drawRange=null,this.attributes=null,this.attributesId=null,this.pipeline=null,this.group=null,this.vertexBuffers=null,this.drawParams=null,this.bundle=null,this.clippingContext=u,this.clippingContextCacheKey=u!==null?u.cacheKey:"",this.initialNodesCacheKey=this.getDynamicCacheKey(),this.initialCacheKey=this.getCacheKey(),this._nodeBuilderState=null,this._bindings=null,this._monitor=null,this.onDispose=null,this.isRenderObject=!0,this.onMaterialDispose=()=>{this.dispose()},this.onGeometryDispose=()=>{this.attributes=null,this.attributesId=null},this.material.addEventListener("dispose",this.onMaterialDispose),this.geometry.addEventListener("dispose",this.onGeometryDispose)}updateClipping(e){this.clippingContext=e}get clippingNeedsUpdate(){return this.clippingContext===null||this.clippingContext.cacheKey===this.clippingContextCacheKey?!1:(this.clippingContextCacheKey=this.clippingContext.cacheKey,!0)}get hardwareClippingPlanes(){return this.material.hardwareClipping===!0?this.clippingContext.unionClippingCount:0}getNodeBuilderState(){return this._nodeBuilderState||(this._nodeBuilderState=this._nodes.getForRender(this))}getMonitor(){return this._monitor||(this._monitor=this.getNodeBuilderState().observer)}getBindings(){return this._bindings||(this._bindings=this.getNodeBuilderState().createBindings())}getBindingGroup(e){for(const t of this.getBindings())if(t.name===e)return t}getIndex(){return this._geometries.getIndex(this)}getIndirect(){return this._geometries.getIndirect(this)}getChainArray(){return[this.object,this.material,this.context,this.lightsNode]}setGeometry(e){this.geometry=e,this.attributes=null,this.attributesId=null}getAttributes(){if(this.attributes!==null)return this.attributes;const e=this.getNodeBuilderState().nodeAttributes,t=this.geometry,r=[],i=new Set,s={};for(const o of e){let a;if(o.node&&o.node.attribute?a=o.node.attribute:(a=t.getAttribute(o.name),s[o.name]=a.version),a===void 0)continue;r.push(a);const c=a.isInterleavedBufferAttribute?a.data:a;i.add(c)}return this.attributes=r,this.attributesId=s,this.vertexBuffers=Array.from(i.values()),r}getVertexBuffers(){return this.vertexBuffers===null&&this.getAttributes(),this.vertexBuffers}getDrawParameters(){const{object:e,material:t,geometry:r,group:i,drawRange:s}=this,o=this.drawParams||(this.drawParams={vertexCount:0,firstVertex:0,instanceCount:0,firstInstance:0}),a=this.getIndex(),c=a!==null;let l=1;if(r.isInstancedBufferGeometry===!0?l=r.instanceCount:e.count!==void 0&&(l=Math.max(0,e.count)),l===0)return null;if(o.instanceCount=l,e.isBatchedMesh===!0)return o;let u=1;t.wireframe===!0&&!e.isPoints&&!e.isLineSegments&&!e.isLine&&!e.isLineLoop&&(u=2);let d=s.start*u,h=(s.start+s.count)*u;i!==null&&(d=Math.max(d,i.start*u),h=Math.min(h,(i.start+i.count)*u));const f=r.attributes.position;let p=1/0;c?p=a.count:f!=null&&(p=f.count),d=Math.max(d,0),h=Math.min(h,p);const g=h-d;return g<0||g===1/0?null:(o.vertexCount=g,o.firstVertex=d,o)}getGeometryCacheKey(){const{geometry:e}=this;let t="";for(const r of Object.keys(e.attributes).sort()){const i=e.attributes[r];t+=r+",",i.data&&(t+=i.data.stride+","),i.offset&&(t+=i.offset+","),i.itemSize&&(t+=i.itemSize+","),i.normalized&&(t+="n,")}for(const r of Object.keys(e.morphAttributes).sort()){const i=e.morphAttributes[r];t+="morph-"+r+",";for(let s=0,o=i.length;s<o;s++){const a=i[s];t+=a.id+","}}return e.index&&(t+="index,"),t}getMaterialCacheKey(){const{object:e,material:t,renderer:r}=this;let i=t.customProgramCacheKey();for(const s of QU(t)){if(/^(is[A-Z]|_)|^(visible|version|uuid|name|opacity|userData)$/.test(s))continue;const o=t[s];let a;if(o!==null){const c=typeof o;c==="number"?a=o!==0?"1":"0":c==="object"?(a="{",o.isTexture&&(a+=o.mapping,r.backend.isWebGPUBackend===!0&&(a+=o.magFilter,a+=o.minFilter,a+=o.wrapS,a+=o.wrapT,a+=o.wrapR)),a+="}"):a=String(o)}else a=String(o);i+=a+","}return i+=this.clippingContextCacheKey+",",e.geometry&&(i+=this.getGeometryCacheKey()),e.skeleton&&(i+=e.skeleton.bones.length+","),e.isBatchedMesh&&(i+=e._matricesTexture.uuid+",",e._colorsTexture!==null&&(i+=e._colorsTexture.uuid+",")),(e.isInstancedMesh||e.count>1||Array.isArray(e.morphTargetInfluences))&&(i+=e.uuid+","),i+=e.receiveShadow+",",Dl(i)}get needsGeometryUpdate(){if(this.geometry.id!==this.object.geometry.id)return!0;if(this.attributes!==null){const e=this.attributesId;for(const t in e){const r=this.geometry.getAttribute(t);if(r===void 0||e[t]!==r.id)return!0}}return!1}get needsUpdate(){return this.initialNodesCacheKey!==this.getDynamicCacheKey()||this.clippingNeedsUpdate}getDynamicCacheKey(){let e=0;return this.material.isShadowPassMaterial!==!0&&(e=this._nodes.getCacheKey(this.scene,this.lightsNode)),this.camera.isArrayCamera&&(e=Do(e,this.camera.cameras.length)),this.object.receiveShadow&&(e=Do(e,1)),e=Do(e,this.camera.id),e}getCacheKey(){return this.getMaterialCacheKey()+this.getDynamicCacheKey()}dispose(){this.material.removeEventListener("dispose",this.onMaterialDispose),this.geometry.removeEventListener("dispose",this.onGeometryDispose),this.onDispose()}}const ri=[];class JU{constructor(e,t,r,i,s,o){this.renderer=e,this.nodes=t,this.geometries=r,this.pipelines=i,this.bindings=s,this.info=o,this.chainMaps={}}get(e,t,r,i,s,o,a,c){const l=this.getChainMap(c);ri[0]=e,ri[1]=t,ri[2]=o,ri[3]=s;let u=l.get(ri);return u===void 0?(u=this.createRenderObject(this.nodes,this.geometries,this.renderer,e,t,r,i,s,o,a,c),l.set(ri,u)):(u.updateClipping(a),u.needsGeometryUpdate&&u.setGeometry(e.geometry),(u.version!==t.version||u.needsUpdate)&&(u.initialCacheKey!==u.getCacheKey()?(u.dispose(),u=this.get(e,t,r,i,s,o,a,c)):u.version=t.version)),ri.length=0,u}getChainMap(e="default"){return this.chainMaps[e]||(this.chainMaps[e]=new Nn)}dispose(){this.chainMaps={}}createRenderObject(e,t,r,i,s,o,a,c,l,u,d){const h=this.getChainMap(d),f=new ZU(e,t,r,i,s,o,a,c,l,u);return f.onDispose=()=>{this.pipelines.delete(f),this.bindings.deleteForRender(f),this.nodes.delete(f),h.delete(f.getChainArray())},f}}class Wr{constructor(){this.data=new WeakMap}get(e){let t=this.data.get(e);return t===void 0&&(t={},this.data.set(e,t)),t}delete(e){let t=null;return this.data.has(e)&&(t=this.data.get(e),this.data.delete(e)),t}has(e){return this.data.has(e)}dispose(){this.data=new WeakMap}}const on={VERTEX:1,INDEX:2,STORAGE:3,INDIRECT:4},Br=16,e5=211,t5=212;class n5 extends Wr{constructor(e){super(),this.backend=e}delete(e){const t=super.delete(e);return t!==null&&this.backend.destroyAttribute(e),t}update(e,t){const r=this.get(e);if(r.version===void 0)t===on.VERTEX?this.backend.createAttribute(e):t===on.INDEX?this.backend.createIndexAttribute(e):t===on.STORAGE?this.backend.createStorageAttribute(e):t===on.INDIRECT&&this.backend.createIndirectStorageAttribute(e),r.version=this._getBufferAttribute(e).version;else{const i=this._getBufferAttribute(e);(r.version<i.version||i.usage===rs)&&(this.backend.updateAttribute(e),r.version=i.version)}}_getBufferAttribute(e){return e.isInterleavedBufferAttribute&&(e=e.data),e}}function ST(n){return n.index!==null?n.index.version:n.attributes.position.version}function A0(n){const e=[],t=n.index,r=n.attributes.position;if(t!==null){const s=t.array;for(let o=0,a=s.length;o<a;o+=3){const c=s[o+0],l=s[o+1],u=s[o+2];e.push(c,l,l,u,u,c)}}else{const s=r.array;for(let o=0,a=s.length/3-1;o<a;o+=3){const c=o+0,l=o+1,u=o+2;e.push(c,l,l,u,u,c)}}const i=new(Jw(e)?Qw:Zw)(e,1);return i.version=ST(n),i}class r5 extends Wr{constructor(e,t){super(),this.attributes=e,this.info=t,this.wireframes=new WeakMap,this.attributeCall=new WeakMap,this._geometryDisposeListeners=new Map}has(e){const t=e.geometry;return super.has(t)&&this.get(t).initialized===!0}updateForRender(e){this.has(e)===!1&&this.initGeometry(e),this.updateAttributes(e)}initGeometry(e){const t=e.geometry,r=this.get(t);r.initialized=!0,this.info.memory.geometries++;const i=()=>{this.info.memory.geometries--;const s=t.index,o=e.getAttributes();s!==null&&this.attributes.delete(s);for(const c of o)this.attributes.delete(c);const a=this.wireframes.get(t);a!==void 0&&this.attributes.delete(a),t.removeEventListener("dispose",i),this._geometryDisposeListeners.delete(t)};t.addEventListener("dispose",i),this._geometryDisposeListeners.set(t,i)}updateAttributes(e){const t=e.getAttributes();for(const s of t)s.isStorageBufferAttribute||s.isStorageInstancedBufferAttribute?this.updateAttribute(s,on.STORAGE):this.updateAttribute(s,on.VERTEX);const r=this.getIndex(e);r!==null&&this.updateAttribute(r,on.INDEX);const i=e.geometry.indirect;i!==null&&this.updateAttribute(i,on.INDIRECT)}updateAttribute(e,t){const r=this.info.render.calls;e.isInterleavedBufferAttribute?this.attributeCall.get(e)===void 0?(this.attributes.update(e,t),this.attributeCall.set(e,r)):this.attributeCall.get(e.data)!==r&&(this.attributes.update(e,t),this.attributeCall.set(e.data,r),this.attributeCall.set(e,r)):this.attributeCall.get(e)!==r&&(this.attributes.update(e,t),this.attributeCall.set(e,r))}getIndirect(e){return e.geometry.indirect}getIndex(e){const{geometry:t,material:r}=e;let i=t.index;if(r.wireframe===!0){const s=this.wireframes;let o=s.get(t);o===void 0?(o=A0(t),s.set(t,o)):o.version!==ST(t)&&(this.attributes.delete(o),o=A0(t),s.set(t,o)),i=o}return i}dispose(){for(const[e,t]of this._geometryDisposeListeners.entries())e.removeEventListener("dispose",t);this._geometryDisposeListeners.clear()}}class i5{constructor(){this.autoReset=!0,this.frame=0,this.calls=0,this.render={calls:0,frameCalls:0,drawCalls:0,triangles:0,points:0,lines:0,timestamp:0},this.compute={calls:0,frameCalls:0,timestamp:0},this.memory={geometries:0,textures:0}}update(e,t,r){this.render.drawCalls++,e.isMesh||e.isSprite?this.render.triangles+=r*(t/3):e.isPoints?this.render.points+=r*t:e.isLineSegments?this.render.lines+=r*(t/2):e.isLine?this.render.lines+=r*(t-1):ie("WebGPUInfo: Unknown object type.")}reset(){this.render.drawCalls=0,this.render.frameCalls=0,this.compute.frameCalls=0,this.render.triangles=0,this.render.points=0,this.render.lines=0}dispose(){this.reset(),this.calls=0,this.render.calls=0,this.compute.calls=0,this.render.timestamp=0,this.compute.timestamp=0,this.memory.geometries=0,this.memory.textures=0}}class NT{constructor(e){this.cacheKey=e,this.usedTimes=0}}class s5 extends NT{constructor(e,t,r){super(e),this.vertexProgram=t,this.fragmentProgram=r}}class o5 extends NT{constructor(e,t){super(e),this.computeProgram=t,this.isComputePipeline=!0}}let a5=0;class Hu{constructor(e,t,r,i=null,s=null){this.id=a5++,this.code=e,this.stage=t,this.name=r,this.transforms=i,this.attributes=s,this.usedTimes=0}}class c5 extends Wr{constructor(e,t){super(),this.backend=e,this.nodes=t,this.bindings=null,this.caches=new Map,this.programs={vertex:new Map,fragment:new Map,compute:new Map}}getForCompute(e,t){const{backend:r}=this,i=this.get(e);if(this._needsComputeUpdate(e)){const s=i.pipeline;s&&(s.usedTimes--,s.computeProgram.usedTimes--);const o=this.nodes.getForCompute(e);let a=this.programs.compute.get(o.computeShader);a===void 0&&(s&&s.computeProgram.usedTimes===0&&this._releaseProgram(s.computeProgram),a=new Hu(o.computeShader,"compute",e.name,o.transforms,o.nodeAttributes),this.programs.compute.set(o.computeShader,a),r.createProgram(a));const c=this._getComputeCacheKey(e,a);let l=this.caches.get(c);l===void 0&&(s&&s.usedTimes===0&&this._releasePipeline(s),l=this._getComputePipeline(e,a,c,t)),l.usedTimes++,a.usedTimes++,i.version=e.version,i.pipeline=l}return i.pipeline}getForRender(e,t=null){const{backend:r}=this,i=this.get(e);if(this._needsRenderUpdate(e)){const s=i.pipeline;s&&(s.usedTimes--,s.vertexProgram.usedTimes--,s.fragmentProgram.usedTimes--);const o=e.getNodeBuilderState(),a=e.material?e.material.name:"";let c=this.programs.vertex.get(o.vertexShader);c===void 0&&(s&&s.vertexProgram.usedTimes===0&&this._releaseProgram(s.vertexProgram),c=new Hu(o.vertexShader,"vertex",a),this.programs.vertex.set(o.vertexShader,c),r.createProgram(c));let l=this.programs.fragment.get(o.fragmentShader);l===void 0&&(s&&s.fragmentProgram.usedTimes===0&&this._releaseProgram(s.fragmentProgram),l=new Hu(o.fragmentShader,"fragment",a),this.programs.fragment.set(o.fragmentShader,l),r.createProgram(l));const u=this._getRenderCacheKey(e,c,l);let d=this.caches.get(u);d===void 0?(s&&s.usedTimes===0&&this._releasePipeline(s),d=this._getRenderPipeline(e,c,l,u,t)):e.pipeline=d,d.usedTimes++,c.usedTimes++,l.usedTimes++,i.pipeline=d}return i.pipeline}delete(e){const t=this.get(e).pipeline;return t&&(t.usedTimes--,t.usedTimes===0&&this._releasePipeline(t),t.isComputePipeline?(t.computeProgram.usedTimes--,t.computeProgram.usedTimes===0&&this._releaseProgram(t.computeProgram)):(t.fragmentProgram.usedTimes--,t.vertexProgram.usedTimes--,t.vertexProgram.usedTimes===0&&this._releaseProgram(t.vertexProgram),t.fragmentProgram.usedTimes===0&&this._releaseProgram(t.fragmentProgram))),super.delete(e)}dispose(){super.dispose(),this.caches=new Map,this.programs={vertex:new Map,fragment:new Map,compute:new Map}}updateForRender(e){this.getForRender(e)}_getComputePipeline(e,t,r,i){r=r||this._getComputeCacheKey(e,t);let s=this.caches.get(r);return s===void 0&&(s=new o5(r,t),this.caches.set(r,s),this.backend.createComputePipeline(s,i)),s}_getRenderPipeline(e,t,r,i,s){i=i||this._getRenderCacheKey(e,t,r);let o=this.caches.get(i);return o===void 0&&(o=new s5(i,t,r),this.caches.set(i,o),e.pipeline=o,this.backend.createRenderPipeline(e,s)),o}_getComputeCacheKey(e,t){return e.id+","+t.id}_getRenderCacheKey(e,t,r){return t.id+","+r.id+","+this.backend.getRenderCacheKey(e)}_releasePipeline(e){this.caches.delete(e.cacheKey)}_releaseProgram(e){const t=e.code,r=e.stage;this.programs[r].delete(t)}_needsComputeUpdate(e){const t=this.get(e);return t.pipeline===void 0||t.version!==e.version}_needsRenderUpdate(e){return this.get(e).pipeline===void 0||this.backend.needsRenderUpdate(e)}}class l5 extends Wr{constructor(e,t,r,i,s,o){super(),this.backend=e,this.textures=r,this.pipelines=s,this.attributes=i,this.nodes=t,this.info=o,this.pipelines.bindings=this}getForRender(e){const t=e.getBindings();for(const r of t){const i=this.get(r);i.bindGroup===void 0&&(this._init(r),this.backend.createBindings(r,t,0),i.bindGroup=r)}return t}getForCompute(e){const t=this.nodes.getForCompute(e).bindings;for(const r of t){const i=this.get(r);i.bindGroup===void 0&&(this._init(r),this.backend.createBindings(r,t,0),i.bindGroup=r)}return t}updateForCompute(e){this._updateBindings(this.getForCompute(e))}updateForRender(e){this._updateBindings(this.getForRender(e))}deleteForCompute(e){const t=this.nodes.getForCompute(e).bindings;for(const r of t)this.delete(r)}deleteForRender(e){const t=e.getBindings();for(const r of t)this.delete(r)}_updateBindings(e){for(const t of e)this._update(t,e)}_init(e){for(const t of e.bindings)if(t.isSampledTexture)this.textures.updateTexture(t.texture);else if(t.isSampler)this.textures.updateSampler(t.texture);else if(t.isStorageBuffer){const r=t.attribute,i=r.isIndirectStorageBufferAttribute?on.INDIRECT:on.STORAGE;this.attributes.update(r,i)}}_update(e,t){const{backend:r}=this;let i=!1,s=!0,o=0,a=0;for(const c of e.bindings)if(!(c.isNodeUniformsGroup&&this.nodes.updateGroup(c)===!1)){if(c.isStorageBuffer){const l=c.attribute,u=l.isIndirectStorageBufferAttribute?on.INDIRECT:on.STORAGE;this.attributes.update(l,u)}if(c.isUniformBuffer)c.update()&&r.updateBinding(c);else if(c.isSampledTexture){const l=c.update(),u=c.texture,d=this.textures.get(u);if(l&&(this.textures.updateTexture(u),c.generation!==d.generation&&(c.generation=d.generation,i=!0,s=!1)),r.get(u).externalTexture!==void 0||d.isDefaultTexture?s=!1:(o=o*10+u.id,a+=u.version),u.isStorageTexture===!0&&u.mipmapsAutoUpdate===!0){const f=this.get(u);c.store===!0?f.needsMipmap=!0:this.textures.needsMipmaps(u)&&f.needsMipmap===!0&&(this.backend.generateMipmaps(u),f.needsMipmap=!1)}}else if(c.isSampler&&c.update()){const u=this.textures.updateSampler(c.texture);c.samplerKey!==u&&(c.samplerKey=u,i=!0,s=!1)}}i===!0&&this.backend.updateBindings(e,t,s?o:0,a)}}function u5(n,e){return n.groupOrder!==e.groupOrder?n.groupOrder-e.groupOrder:n.renderOrder!==e.renderOrder?n.renderOrder-e.renderOrder:n.z!==e.z?n.z-e.z:n.id-e.id}function R0(n,e){return n.groupOrder!==e.groupOrder?n.groupOrder-e.groupOrder:n.renderOrder!==e.renderOrder?n.renderOrder-e.renderOrder:n.z!==e.z?e.z-n.z:n.id-e.id}function C0(n){return(n.transmission>0||n.transmissionNode&&n.transmissionNode.isNode)&&n.side===vi&&n.forceSinglePass===!1}class d5{constructor(e,t,r){this.renderItems=[],this.renderItemsIndex=0,this.opaque=[],this.transparentDoublePass=[],this.transparent=[],this.bundles=[],this.lightsNode=e.getNode(t,r),this.lightsArray=[],this.scene=t,this.camera=r,this.occlusionQueryCount=0}begin(){return this.renderItemsIndex=0,this.opaque.length=0,this.transparentDoublePass.length=0,this.transparent.length=0,this.bundles.length=0,this.lightsArray.length=0,this.occlusionQueryCount=0,this}getNextRenderItem(e,t,r,i,s,o,a){let c=this.renderItems[this.renderItemsIndex];return c===void 0?(c={id:e.id,object:e,geometry:t,material:r,groupOrder:i,renderOrder:e.renderOrder,z:s,group:o,clippingContext:a},this.renderItems[this.renderItemsIndex]=c):(c.id=e.id,c.object=e,c.geometry=t,c.material=r,c.groupOrder=i,c.renderOrder=e.renderOrder,c.z=s,c.group=o,c.clippingContext=a),this.renderItemsIndex++,c}push(e,t,r,i,s,o,a){const c=this.getNextRenderItem(e,t,r,i,s,o,a);e.occlusionTest===!0&&this.occlusionQueryCount++,r.transparent===!0||r.transmission>0||r.transmissionNode&&r.transmissionNode.isNode||r.backdropNode&&r.backdropNode.isNode?(C0(r)&&this.transparentDoublePass.push(c),this.transparent.push(c)):this.opaque.push(c)}unshift(e,t,r,i,s,o,a){const c=this.getNextRenderItem(e,t,r,i,s,o,a);r.transparent===!0||r.transmission>0||r.transmissionNode&&r.transmissionNode.isNode||r.backdropNode&&r.backdropNode.isNode?(C0(r)&&this.transparentDoublePass.unshift(c),this.transparent.unshift(c)):this.opaque.unshift(c)}pushBundle(e){this.bundles.push(e)}pushLight(e){this.lightsArray.push(e)}sort(e,t){this.opaque.length>1&&this.opaque.sort(e||u5),this.transparentDoublePass.length>1&&this.transparentDoublePass.sort(t||R0),this.transparent.length>1&&this.transparent.sort(t||R0)}finish(){this.lightsNode.setLights(this.lightsArray);for(let e=this.renderItemsIndex,t=this.renderItems.length;e<t;e++){const r=this.renderItems[e];if(r.id===null)break;r.id=null,r.object=null,r.geometry=null,r.material=null,r.groupOrder=null,r.renderOrder=null,r.z=null,r.group=null,r.clippingContext=null}}}const co=[];class h5{constructor(e){this.lighting=e,this.lists=new Nn}get(e,t){const r=this.lists;co[0]=e,co[1]=t;let i=r.get(co);return i===void 0&&(i=new d5(this.lighting,e,t),r.set(co,i)),co.length=0,i}dispose(){this.lists=new Nn}}let f5=0;class p5{constructor(){this.id=f5++,this.color=!0,this.clearColor=!0,this.clearColorValue={r:0,g:0,b:0,a:1},this.depth=!0,this.clearDepth=!0,this.clearDepthValue=1,this.stencil=!1,this.clearStencil=!0,this.clearStencilValue=1,this.viewport=!1,this.viewportValue=new Ze,this.scissor=!1,this.scissorValue=new Ze,this.renderTarget=null,this.textures=null,this.depthTexture=null,this.activeCubeFace=0,this.activeMipmapLevel=0,this.sampleCount=1,this.width=0,this.height=0,this.occlusionQueryCount=0,this.clippingContext=null,this.isRenderContext=!0}getCacheKey(){return ET(this)}}function ET(n){const{textures:e,activeCubeFace:t,activeMipmapLevel:r}=n,i=[t,r];for(const s of e)i.push(s.id);return ha(i)}const lo=[],g5=new yl,m5=new Pw;class x5{constructor(){this.chainMaps={}}get(e,t,r=null){lo[0]=e,lo[1]=t;let i;if(r===null)i="default";else{const a=r.texture.format;i=`${r.textures.length}:${a}:${r.samples}:${r.depthBuffer}:${r.stencilBuffer}`}const s=this._getChainMap(i);let o=s.get(lo);return o===void 0&&(o=new p5,s.set(lo,o)),lo.length=0,r!==null&&(o.sampleCount=r.samples===0?1:r.samples),o}getForClear(e=null){return this.get(g5,m5,e)}_getChainMap(e){return this.chainMaps[e]||(this.chainMaps[e]=new Nn)}dispose(){this.chainMaps={}}}const y5=new le;class b5 extends Wr{constructor(e,t,r){super(),this.renderer=e,this.backend=t,this.info=r}updateRenderTarget(e,t=0){const r=this.get(e),i=e.samples===0?1:e.samples,s=r.depthTextureMips||(r.depthTextureMips={}),o=e.textures,a=this.getSize(o[0]),c=a.width>>t,l=a.height>>t;let u=e.depthTexture||s[t];const d=e.depthBuffer===!0||e.stencilBuffer===!0;let h=!1;u===void 0&&d&&(u=new $n,u.format=e.stencilBuffer?Or:Ur,u.type=e.stencilBuffer?Lr:dt,u.image.width=c,u.image.height=l,u.image.depth=a.depth,u.renderTarget=e,u.isArrayTexture=e.multiview===!0&&a.depth>1,s[t]=u),(r.width!==a.width||a.height!==r.height)&&(h=!0,u&&(u.needsUpdate=!0,u.image.width=c,u.image.height=l,u.image.depth=u.isArrayTexture?u.image.depth:1)),r.width=a.width,r.height=a.height,r.textures=o,r.depthTexture=u||null,r.depth=e.depthBuffer,r.stencil=e.stencilBuffer,r.renderTarget=e,r.sampleCount!==i&&(h=!0,u&&(u.needsUpdate=!0),r.sampleCount=i);const f={sampleCount:i};if(e.isXRRenderTarget!==!0){for(let p=0;p<o.length;p++){const g=o[p];h&&(g.needsUpdate=!0),this.updateTexture(g,f)}u&&this.updateTexture(u,f)}r.initialized!==!0&&(r.initialized=!0,r.onDispose=()=>{this._destroyRenderTarget(e)},e.addEventListener("dispose",r.onDispose))}updateTexture(e,t={}){const r=this.get(e);if(r.initialized===!0&&r.version===e.version)return;const i=e.isRenderTargetTexture||e.isDepthTexture||e.isFramebufferTexture,s=this.backend;if(i&&r.initialized===!0&&s.destroyTexture(e),e.isFramebufferTexture){const l=this.renderer.getRenderTarget();l?e.type=l.texture.type:e.type=Qt}const{width:o,height:a,depth:c}=this.getSize(e);if(t.width=o,t.height=a,t.depth=c,t.needsMipmaps=this.needsMipmaps(e),t.levels=t.needsMipmaps?this.getMipLevels(e,o,a):1,e.isCubeTexture&&e.mipmaps.length>0&&t.levels++,i||e.isStorageTexture===!0||e.isExternalTexture===!0)s.createTexture(e,t),r.generation=e.version;else if(e.version>0){const l=e.image;if(l===void 0)se("Renderer: Texture marked for update but image is undefined.");else if(l.complete===!1)se("Renderer: Texture marked for update but image is incomplete.");else{if(e.images){const d=[];for(const h of e.images)d.push(h);t.images=d}else t.image=l;(r.isDefaultTexture===void 0||r.isDefaultTexture===!0)&&(s.createTexture(e,t),r.isDefaultTexture=!1,r.generation=e.version),e.source.dataReady===!0&&s.updateTexture(e,t);const u=e.isStorageTexture===!0&&e.mipmapsAutoUpdate===!1;t.needsMipmaps&&e.mipmaps.length===0&&!u&&s.generateMipmaps(e),e.onUpdate&&e.onUpdate(e)}}else s.createDefaultTexture(e),r.isDefaultTexture=!0,r.generation=e.version;r.initialized!==!0&&(r.initialized=!0,r.generation=e.version,this.info.memory.textures++,e.isVideoTexture&&ut.getTransfer(e.colorSpace)!==ye&&se("WebGPURenderer: Video textures must use a color space with a sRGB transfer function, e.g. SRGBColorSpace."),r.onDispose=()=>{this._destroyTexture(e)},e.addEventListener("dispose",r.onDispose)),r.version=e.version}updateSampler(e){return this.backend.updateSampler(e)}getSize(e,t=y5){let r=e.images?e.images[0]:e.image;return r?(r.image!==void 0&&(r=r.image),typeof HTMLVideoElement<"u"&&r instanceof HTMLVideoElement?(t.width=r.videoWidth||1,t.height=r.videoHeight||1,t.depth=1):typeof VideoFrame<"u"&&r instanceof VideoFrame?(t.width=r.displayWidth||1,t.height=r.displayHeight||1,t.depth=1):(t.width=r.width||1,t.height=r.height||1,t.depth=e.isCubeTexture?6:r.depth||1)):t.width=t.height=t.depth=1,t}getMipLevels(e,t,r){let i;return e.mipmaps.length>0?i=e.mipmaps.length:e.isCompressedTexture===!0?i=1:i=Math.floor(Math.log2(Math.max(t,r)))+1,i}needsMipmaps(e){return e.generateMipmaps===!0||e.mipmaps.length>0}_destroyRenderTarget(e){if(this.has(e)===!0){const t=this.get(e),r=t.textures,i=t.depthTexture;e.removeEventListener("dispose",t.onDispose);for(let s=0;s<r.length;s++)this._destroyTexture(r[s]);i&&this._destroyTexture(i),this.delete(e),this.backend.delete(e)}}_destroyTexture(e){if(this.has(e)===!0){const t=this.get(e);e.removeEventListener("dispose",t.onDispose);const r=t.isDefaultTexture;this.backend.destroyTexture(e,r),this.delete(e),this.info.memory.textures--}}}class hp extends un{constructor(e,t,r,i=1){super(e,t,r),this.a=i}set(e,t,r,i=1){return this.a=i,super.set(e,t,r)}copy(e){return e.a!==void 0&&(this.a=e.a),super.copy(e)}clone(){return new this.constructor(this.r,this.g,this.b,this.a)}}class _5 extends ke{static get type(){return"ParameterNode"}constructor(e,t=null){super(e,t),this.isParameterNode=!0}getMemberType(e,t){const r=this.getNodeType(e),i=e.getStructTypeNode(r);let s;return i!==null?s=i.getMemberType(e,t):(ie(`TSL: Member "${t}" not found in struct "${r}".`),s="float"),s}getHash(){return this.uuid}generate(){return this.name}}class v5 extends ce{static get type(){return"StackNode"}constructor(e=null){super(),this.nodes=[],this.outputNode=null,this.parent=e,this._currentCond=null,this._expressionNode=null,this.isStackNode=!0}getElementType(e){return this.hasOutput?this.outputNode.getElementType(e):"void"}getNodeType(e){return this.hasOutput?this.outputNode.getNodeType(e):"void"}getMemberType(e,t){return this.hasOutput?this.outputNode.getMemberType(e,t):"void"}addToStack(e){return e.isNode!==!0?(ie("TSL: Invalid node added to stack."),this):(this.nodes.push(e),this)}If(e,t){const r=new wo(t);return this._currentCond=Tt(e,r),this.addToStack(this._currentCond)}ElseIf(e,t){const r=new wo(t),i=Tt(e,r);return this._currentCond.elseNode=i,this._currentCond=i,this}Else(e){return this._currentCond.elseNode=new wo(e),this}Switch(e){return this._expressionNode=J(e),this}Case(...e){const t=[];if(e.length>=2)for(let a=0;a<e.length-1;a++)t.push(this._expressionNode.equal(J(e[a])));else ie("TSL: Invalid parameter length. Case() requires at least two parameters.");const r=e[e.length-1],i=new wo(r);let s=t[0];for(let a=1;a<t.length;a++)s=s.or(t[a]);const o=Tt(s,i);return this._currentCond===null?(this._currentCond=o,this.addToStack(this._currentCond)):(this._currentCond.elseNode=o,this._currentCond=o,this)}Default(e){return this.Else(e),this}setup(e){const t=e.getNodeProperties(this);let r=0;for(const i of this.getChildren())i.isVarNode&&i.intent===!0&&i.isAssign(e)!==!0||(t["node"+r++]=i);return t.outputNode||null}get hasOutput(){return this.outputNode&&this.outputNode.isNode}build(e,...t){const r=tv();rl(this),e.setActiveStack(this);const i=e.buildStage;for(const o of this.nodes)if(!(o.isVarNode&&o.intent===!0&&o.isAssign(e)!==!0)){if(i==="setup")o.build(e);else if(i==="analyze")o.build(e,this);else if(i==="generate"){const a=e.getDataFromNode(o,"any").stages,c=a&&a[e.shaderStage];if(o.isVarNode&&c&&c.length===1&&c[0]&&c[0].isStackNode)continue;o.build(e,"void")}}let s;return this.hasOutput?s=this.outputNode.build(e,...t):s=super.build(e,...t),rl(r),e.removeActiveStack(this),s}}const Wu=Pe(v5).setParameterLength(0,1);new xl;new le;new le;new le;new En;new le(0,0,-1);new Ze;new le;new le;new Ze;new Te;const T5=new Is;ys.flipX();T5.depthTexture=new $n(1,1);const qu=new sf(-1,1,1,-1,0,1);class w5 extends sa{constructor(e=!1){super();const t=e===!1?[0,-1,0,1,2,1]:[0,2,0,0,2,0];this.setAttribute("position",new kc([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new kc(t,2))}}const S5=new w5;class fp extends wn{constructor(e=null){super(S5,e),this.camera=qu,this.isQuadMesh=!0}async renderAsync(e){lt('QuadMesh: "renderAsync()" has been deprecated. Use "render()" and "await renderer.init();" when creating the renderer.'),await e.init(),e.render(this,qu)}render(e){e.render(this,qu)}}Q(([n])=>Hn(j(52.9829189).mul(Hn(Cs(n,ne(.06711056,.00583715)))))).setLayout({name:"interleavedGradientNoise",type:"float",inputs:[{name:"position",type:"vec2"}]});class pr extends ce{static get type(){return"EventNode"}constructor(e,t){super("void"),this.eventType=e,this.callback=t,e===pr.OBJECT?this.updateType=_e.OBJECT:e===pr.MATERIAL?this.updateType=_e.RENDER:e===pr.BEFORE_OBJECT?this.updateBeforeType=_e.OBJECT:e===pr.BEFORE_MATERIAL&&(this.updateBeforeType=_e.RENDER)}update(e){this.callback(e)}updateBefore(e){this.callback(e)}}pr.OBJECT="object";pr.MATERIAL="material";pr.BEFORE_OBJECT="beforeObject";pr.BEFORE_MATERIAL="beforeMaterial";const uo=new My,Xu=new En;class zt extends ce{static get type(){return"SceneNode"}constructor(e=zt.BACKGROUND_BLURRINESS,t=null){super(),this.scope=e,this.scene=t}setup(e){const t=this.scope,r=this.scene!==null?this.scene:e.scene;let i;return t===zt.BACKGROUND_BLURRINESS?i=Oe("backgroundBlurriness","float",r):t===zt.BACKGROUND_INTENSITY?i=Oe("backgroundIntensity","float",r):t===zt.BACKGROUND_ROTATION?i=pe("mat4").setName("backgroundRotation").setGroup(fe).onRenderUpdate(()=>{const s=r.background;return s!==null&&s.isTexture&&s.mapping!==TS?(uo.copy(r.backgroundRotation),uo.x*=-1,uo.y*=-1,uo.z*=-1,Xu.makeRotationFromEuler(uo)):Xu.identity(),Xu}):ie("SceneNode: Unknown scope:",t),i}}zt.BACKGROUND_BLURRINESS="backgroundBlurriness";zt.BACKGROUND_INTENSITY="backgroundIntensity";zt.BACKGROUND_ROTATION="backgroundRotation";const N5=re(zt,zt.BACKGROUND_BLURRINESS),M0=re(zt,zt.BACKGROUND_INTENSITY),E5=re(zt,zt.BACKGROUND_ROTATION),A5=Q(({texture:n,uv:e})=>{const r=X().toVar();return qe(e.x.lessThan(1e-4),()=>{r.assign(X(1,0,0))}).ElseIf(e.y.lessThan(1e-4),()=>{r.assign(X(0,1,0))}).ElseIf(e.z.lessThan(1e-4),()=>{r.assign(X(0,0,1))}).ElseIf(e.x.greaterThan(1-1e-4),()=>{r.assign(X(-1,0,0))}).ElseIf(e.y.greaterThan(1-1e-4),()=>{r.assign(X(0,-1,0))}).ElseIf(e.z.greaterThan(1-1e-4),()=>{r.assign(X(0,0,-1))}).Else(()=>{const s=n.sample(e.add(X(-.01,0,0))).r.sub(n.sample(e.add(X(.01,0,0))).r),o=n.sample(e.add(X(0,-.01,0))).r.sub(n.sample(e.add(X(0,.01,0))).r),a=n.sample(e.add(X(0,0,-.01))).r.sub(n.sample(e.add(X(0,0,.01))).r);r.assign(X(s,o,a))}),r.normalize()});class R5 extends Gs{static get type(){return"Texture3DNode"}constructor(e,t=null,r=null){super(e,t,r),this.isTexture3DNode=!0}getInputType(){return"texture3D"}getDefaultUV(){return X(.5,.5,.5)}setUpdateMatrix(){}setupUV(e,t){const r=this.value;return e.isFlipY()&&(r.isRenderTargetTexture===!0||r.isFramebufferTexture===!0)&&(this.sampler?t=t.flipY():t=t.setY(ze(Ei(this,this.levelNode).y).sub(t.y).sub(1))),t}generateUV(e,t){return t.build(e,this.sampler===!0?"vec3":"ivec3")}generateOffset(e,t){return t.build(e,"ivec3")}normal(e){return A5({texture:this,uv:e})}}const C5=Pe(R5).setParameterLength(1,3),qa=new Te;class M5 extends Gs{static get type(){return"PassTextureNode"}constructor(e,t){super(t),this.passNode=e,this.setUpdateMatrix(!1)}setup(e){return this.passNode.build(e),super.setup(e)}clone(){return new this.constructor(this.passNode,this.value)}}class P0 extends M5{static get type(){return"PassMultipleTextureNode"}constructor(e,t,r=!1){super(e,null),this.textureName=t,this.previousTexture=r}updateTexture(){this.value=this.previousTexture?this.passNode.getPreviousTexture(this.textureName):this.passNode.getTexture(this.textureName)}setup(e){return this.updateTexture(),super.setup(e)}clone(){const e=new this.constructor(this.passNode,this.textureName,this.previousTexture);return e.uvNode=this.uvNode,e.levelNode=this.levelNode,e.biasNode=this.biasNode,e.sampler=this.sampler,e.depthNode=this.depthNode,e.compareNode=this.compareNode,e.gradNode=this.gradNode,e.offsetNode=this.offsetNode,e}}class jl extends mt{static get type(){return"PassNode"}constructor(e,t,r,i={}){super("vec4"),this.scope=e,this.scene=t,this.camera=r,this.options=i,this._pixelRatio=1,this._width=1,this._height=1;const s=new $n;s.isRenderTargetTexture=!0,s.name="depth";const o=new Is(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:Ft,...i});o.texture.name="output",o.depthTexture=s,this.renderTarget=o,this._textures={output:o.texture,depth:s},this._textureNodes={},this._linearDepthNodes={},this._viewZNodes={},this._previousTextures={},this._previousTextureNodes={},this._cameraNear=pe(0),this._cameraFar=pe(0),this._mrt=null,this._layers=null,this._resolutionScale=1,this._viewport=null,this._scissor=null,this.isPassNode=!0,this.updateBeforeType=_e.FRAME,this.global=!0}setResolutionScale(e){return this._resolutionScale=e,this}getResolutionScale(){return this._resolutionScale}setResolution(e){return se("PassNode: .setResolution() is deprecated. Use .setResolutionScale() instead."),this.setResolutionScale(e)}getResolution(){return se("PassNode: .getResolution() is deprecated. Use .getResolutionScale() instead."),this.getResolutionScale()}setLayers(e){return this._layers=e,this}getLayers(){return this._layers}setMRT(e){return this._mrt=e,this}getMRT(){return this._mrt}getTexture(e){let t=this._textures[e];return t===void 0&&(t=this.renderTarget.texture.clone(),t.name=e,this._textures[e]=t,this.renderTarget.textures.push(t)),t}getPreviousTexture(e){let t=this._previousTextures[e];return t===void 0&&(t=this.getTexture(e).clone(),this._previousTextures[e]=t),t}toggleTexture(e){const t=this._previousTextures[e];if(t!==void 0){const r=this._textures[e],i=this.renderTarget.textures.indexOf(r);this.renderTarget.textures[i]=t,this._textures[e]=t,this._previousTextures[e]=r,this._textureNodes[e].updateTexture(),this._previousTextureNodes[e].updateTexture()}}getTextureNode(e="output"){let t=this._textureNodes[e];return t===void 0&&(t=J(new P0(this,e)),t.updateTexture(),this._textureNodes[e]=t),t}getPreviousTextureNode(e="output"){let t=this._previousTextureNodes[e];return t===void 0&&(this._textureNodes[e]===void 0&&this.getTextureNode(e),t=J(new P0(this,e,!0)),t.updateTexture(),this._previousTextureNodes[e]=t),t}getViewZNode(e="depth"){let t=this._viewZNodes[e];if(t===void 0){const r=this._cameraNear,i=this._cameraFar;this._viewZNodes[e]=t=iT(this.getTextureNode(e),r,i)}return t}getLinearDepthNode(e="depth"){let t=this._linearDepthNodes[e];if(t===void 0){const r=this._cameraNear,i=this._cameraFar,s=this.getViewZNode(e);this._linearDepthNodes[e]=t=Lo(s,r,i)}return t}async compileAsync(e){const t=e.getRenderTarget(),r=e.getMRT();e.setRenderTarget(this.renderTarget),e.setMRT(this._mrt),await e.compileAsync(this.scene,this.camera),e.setRenderTarget(t),e.setMRT(r)}setup({renderer:e}){return this.renderTarget.samples=this.options.samples===void 0?e.samples:this.options.samples,this.renderTarget.texture.type=e.getColorBufferType(),this.scope===jl.COLOR?this.getTextureNode():this.getLinearDepthNode()}updateBefore(e){const{renderer:t}=e,{scene:r}=this;let i,s;const o=t.getOutputRenderTarget();o&&o.isXRRenderTarget===!0?(s=1,i=t.xr.getCamera(),t.xr.updateCamera(i),qa.set(o.width,o.height)):(i=this.camera,s=t.getPixelRatio(),t.getSize(qa)),this._pixelRatio=s,this.setSize(qa.width,qa.height);const a=t.getRenderTarget(),c=t.getMRT(),l=t.autoClear,u=i.layers.mask;this._cameraNear.value=i.near,this._cameraFar.value=i.far,this._layers!==null&&(i.layers.mask=this._layers.mask);for(const h in this._previousTextures)this.toggleTexture(h);t.setRenderTarget(this.renderTarget),t.setMRT(this._mrt),t.autoClear=!0;const d=r.name;r.name=this.name?this.name:r.name,t.render(r,i),r.name=d,t.setRenderTarget(a),t.setMRT(c),t.autoClear=l,i.layers.mask=u}setSize(e,t){this._width=e,this._height=t;const r=Math.floor(this._width*this._pixelRatio*this._resolutionScale),i=Math.floor(this._height*this._pixelRatio*this._resolutionScale);this.renderTarget.setSize(r,i),this._scissor!==null&&this.renderTarget.scissor.copy(this._scissor),this._viewport!==null&&this.renderTarget.viewport.copy(this._viewport)}setScissor(e,t,r,i){e===null?this._scissor=null:(this._scissor===null&&(this._scissor=new Ze),e.isVector4?this._scissor.copy(e):this._scissor.set(e,t,r,i),this._scissor.multiplyScalar(this._pixelRatio*this._resolutionScale).floor())}setViewport(e,t,r,i){e===null?this._viewport=null:(this._viewport===null&&(this._viewport=new Ze),e.isVector4?this._viewport.copy(e):this._viewport.set(e,t,r,i),this._viewport.multiplyScalar(this._pixelRatio*this._resolutionScale).floor())}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget.dispose()}}jl.COLOR="color";jl.DEPTH="depth";const P5=Q(([n,e])=>n.mul(e).clamp()).setLayout({name:"linearToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),D5=Q(([n,e])=>(n=n.mul(e),n.div(n.add(1)).clamp())).setLayout({name:"reinhardToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),B5=Q(([n,e])=>{n=n.mul(e),n=n.sub(.004).max(0);const t=n.mul(n.mul(6.2).add(.5)),r=n.mul(n.mul(6.2).add(1.7)).add(.06);return t.div(r).pow(2.2)}).setLayout({name:"cineonToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),F5=Q(([n])=>{const e=n.mul(n.add(.0245786)).sub(90537e-9),t=n.mul(n.add(.432951).mul(.983729)).add(.238081);return e.div(t)}),k5=Q(([n,e])=>{const t=kt(.59719,.35458,.04823,.076,.90834,.01566,.0284,.13383,.83777),r=kt(1.60475,-.53108,-.07367,-.10208,1.10813,-.00605,-.00327,-.07276,1.07602);return n=n.mul(e).div(.6),n=t.mul(n),n=F5(n),n=r.mul(n),n.clamp()}).setLayout({name:"acesFilmicToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),I5=kt(X(1.6605,-.1246,-.0182),X(-.5876,1.1329,-.1006),X(-.0728,-.0083,1.1187)),L5=kt(X(.6274,.0691,.0164),X(.3293,.9195,.088),X(.0433,.0113,.8956)),O5=Q(([n])=>{const e=X(n).toVar(),t=X(e.mul(e)).toVar(),r=X(t.mul(t)).toVar();return j(15.5).mul(r.mul(t)).sub(ve(40.14,r.mul(e))).add(ve(31.96,r).sub(ve(6.868,t.mul(e))).add(ve(.4298,t).add(ve(.1191,e).sub(.00232))))}),U5=Q(([n,e])=>{const t=X(n).toVar(),r=kt(X(.856627153315983,.137318972929847,.11189821299995),X(.0951212405381588,.761241990602591,.0767994186031903),X(.0482516061458583,.101439036467562,.811302368396859)),i=kt(X(1.1271005818144368,-.1413297634984383,-.14132976349843826),X(-.11060664309660323,1.157823702216272,-.11060664309660294),X(-.016493938717834573,-.016493938717834257,1.2519364065950405)),s=j(-12.47393),o=j(4.026069);return t.mulAssign(e),t.assign(L5.mul(t)),t.assign(r.mul(t)),t.assign(gt(t,1e-10)),t.assign(mr(t)),t.assign(t.sub(s).div(o.sub(s))),t.assign(vr(t,0,1)),t.assign(O5(t)),t.assign(i.mul(t)),t.assign(kl(gt(X(0),t),X(2.2))),t.assign(I5.mul(t)),t.assign(vr(t,0,1)),t}).setLayout({name:"agxToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),G5=Q(([n,e])=>{const t=j(.76),r=j(.15);n=n.mul(e);const i=Rs(n.r,Rs(n.g,n.b)),s=Tt(i.lessThan(.08),i.sub(ve(6.25,i.mul(i))),.04);n.subAssign(s);const o=gt(n.r,gt(n.g,n.b));qe(o.lessThan(t),()=>n);const a=Dt(1,t),c=Dt(1,a.mul(a).div(o.add(a.sub(t))));n.mulAssign(c.div(o));const l=Dt(1,jn(1,r.mul(o.sub(c)).add(1)));return He(n,X(c),l)}).setLayout({name:"neutralToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]});class _t extends ce{static get type(){return"CodeNode"}constructor(e="",t=[],r=""){super("code"),this.isCodeNode=!0,this.global=!0,this.code=e,this.includes=t,this.language=r}setIncludes(e){return this.includes=e,this}getIncludes(){return this.includes}generate(e){const t=this.getIncludes(e);for(const i of t)i.build(e);const r=e.getCodeFromNode(this,this.getNodeType(e));return r.code=this.code,r.code}serialize(e){super.serialize(e),e.code=this.code,e.language=this.language}deserialize(e){super.deserialize(e),this.code=e.code,this.language=e.language}}class $5 extends _t{static get type(){return"FunctionNode"}constructor(e="",t=[],r=""){super(e,t,r)}getNodeType(e){return this.getNodeFunction(e).type}getMemberType(e,t){const r=this.getNodeType(e);return e.getStructTypeNode(r).getMemberType(e,t)}getInputs(e){return this.getNodeFunction(e).inputs}getNodeFunction(e){const t=e.getDataFromNode(this);let r=t.nodeFunction;return r===void 0&&(r=e.parser.parseFunction(this.code),t.nodeFunction=r),r}generate(e,t){super.generate(e);const r=this.getNodeFunction(e),i=r.name,s=r.type,o=e.getCodeFromNode(this,s);i!==""&&(o.name=i);const a=e.getPropertyName(o),c=this.getNodeFunction(e).getCode(a);return o.code=c+`
`,t==="property"?a:e.format(`${a}()`,s,t)}}function AT(n){let e;const t=n.context.getViewZ;return t!==void 0&&(e=t(this)),(e||ot.z).negate()}const V5=Q(([n,e],t)=>{const r=AT(t);return Tr(n,e,r)}),z5=Q(([n],e)=>{const t=AT(e);return n.mul(n,t,t).negate().exp().oneMinus()}),D0=Q(([n,e])=>be(e.toFloat().mix(Fo.rgb,n.toVec3()),Fo.a));class j5 extends ce{constructor(e){super(),this.scope=e}generate(e){const{scope:t}=this,{renderer:r}=e;r.backend.isWebGLBackend===!0?e.addFlowCode(`	// ${t}Barrier 
`):e.addLineFlowCode(`${t}Barrier()`,this)}}Pe(j5);class Kn extends ce{static get type(){return"AtomicFunctionNode"}constructor(e,t,r){super("uint"),this.method=e,this.pointerNode=t,this.valueNode=r,this.parents=!0}getInputType(e){return this.pointerNode.getNodeType(e)}getNodeType(e){return this.getInputType(e)}generate(e){const t=e.getNodeProperties(this),r=t.parents,i=this.method,s=this.getNodeType(e),o=this.getInputType(e),a=this.pointerNode,c=this.valueNode,l=[];l.push(`&${a.build(e,o)}`),c!==null&&l.push(c.build(e,o));const u=`${e.getMethod(i,s)}( ${l.join(", ")} )`;if(r?r.length===1&&r[0].isStackNode===!0:!1)e.addLineFlowCode(u,this);else return t.constNode===void 0&&(t.constNode=Ms(u,s).toConst()),t.constNode.build(e)}}Kn.ATOMIC_LOAD="atomicLoad";Kn.ATOMIC_STORE="atomicStore";Kn.ATOMIC_ADD="atomicAdd";Kn.ATOMIC_SUB="atomicSub";Kn.ATOMIC_MAX="atomicMax";Kn.ATOMIC_MIN="atomicMin";Kn.ATOMIC_AND="atomicAnd";Kn.ATOMIC_OR="atomicOr";Kn.ATOMIC_XOR="atomicXor";Pe(Kn);class Me extends mt{static get type(){return"SubgroupFunctionNode"}constructor(e,t=null,r=null){super(),this.method=e,this.aNode=t,this.bNode=r}getInputType(e){const t=this.aNode?this.aNode.getNodeType(e):null,r=this.bNode?this.bNode.getNodeType(e):null,i=e.isMatrix(t)?0:e.getTypeLength(t),s=e.isMatrix(r)?0:e.getTypeLength(r);return i>s?t:r}getNodeType(e){const t=this.method;return t===Me.SUBGROUP_ELECT?"bool":t===Me.SUBGROUP_BALLOT?"uvec4":this.getInputType(e)}generate(e,t){const r=this.method,i=this.getNodeType(e),s=this.getInputType(e),o=this.aNode,a=this.bNode,c=[];if(r===Me.SUBGROUP_BROADCAST||r===Me.SUBGROUP_SHUFFLE||r===Me.QUAD_BROADCAST){const u=a.getNodeType(e);c.push(o.build(e,i),a.build(e,u==="float"?"int":i))}else r===Me.SUBGROUP_SHUFFLE_XOR||r===Me.SUBGROUP_SHUFFLE_DOWN||r===Me.SUBGROUP_SHUFFLE_UP?c.push(o.build(e,i),a.build(e,"uint")):(o!==null&&c.push(o.build(e,s)),a!==null&&c.push(a.build(e,s)));const l=c.length===0?"()":`( ${c.join(", ")} )`;return e.format(`${e.getMethod(r,i)}${l}`,i,t)}serialize(e){super.serialize(e),e.method=this.method}deserialize(e){super.deserialize(e),this.method=e.method}}Me.SUBGROUP_ELECT="subgroupElect";Me.SUBGROUP_BALLOT="subgroupBallot";Me.SUBGROUP_ADD="subgroupAdd";Me.SUBGROUP_INCLUSIVE_ADD="subgroupInclusiveAdd";Me.SUBGROUP_EXCLUSIVE_AND="subgroupExclusiveAdd";Me.SUBGROUP_MUL="subgroupMul";Me.SUBGROUP_INCLUSIVE_MUL="subgroupInclusiveMul";Me.SUBGROUP_EXCLUSIVE_MUL="subgroupExclusiveMul";Me.SUBGROUP_AND="subgroupAnd";Me.SUBGROUP_OR="subgroupOr";Me.SUBGROUP_XOR="subgroupXor";Me.SUBGROUP_MIN="subgroupMin";Me.SUBGROUP_MAX="subgroupMax";Me.SUBGROUP_ALL="subgroupAll";Me.SUBGROUP_ANY="subgroupAny";Me.SUBGROUP_BROADCAST_FIRST="subgroupBroadcastFirst";Me.QUAD_SWAP_X="quadSwapX";Me.QUAD_SWAP_Y="quadSwapY";Me.QUAD_SWAP_DIAGONAL="quadSwapDiagonal";Me.SUBGROUP_BROADCAST="subgroupBroadcast";Me.SUBGROUP_SHUFFLE="subgroupShuffle";Me.SUBGROUP_SHUFFLE_XOR="subgroupShuffleXor";Me.SUBGROUP_SHUFFLE_UP="subgroupShuffleUp";Me.SUBGROUP_SHUFFLE_DOWN="subgroupShuffleDown";Me.QUAD_BROADCAST="quadBroadcast";let Xa;function Hl(n){Xa=Xa||new WeakMap;let e=Xa.get(n);return e===void 0&&Xa.set(n,e={}),e}function pp(n){const e=Hl(n);return e.shadowMatrix||(e.shadowMatrix=pe("mat4").setGroup(fe).onRenderUpdate(t=>((n.castShadow!==!0||t.renderer.shadowMap.enabled===!1)&&(n.shadow.camera.coordinateSystem!==t.camera.coordinateSystem&&(n.shadow.camera.coordinateSystem=t.camera.coordinateSystem,n.shadow.camera.updateProjectionMatrix()),n.shadow.updateMatrices(n)),n.shadow.matrix)))}function H5(n,e=Ps){const t=pp(n).mul(e);return t.xyz.div(t.w)}function RT(n){const e=Hl(n);return e.position||(e.position=pe(new le).setGroup(fe).onRenderUpdate((t,r)=>r.value.setFromMatrixPosition(n.matrixWorld)))}function W5(n){const e=Hl(n);return e.targetPosition||(e.targetPosition=pe(new le).setGroup(fe).onRenderUpdate((t,r)=>r.value.setFromMatrixPosition(n.target.matrixWorld)))}function CT(n){const e=Hl(n);return e.viewPosition||(e.viewPosition=pe(new le).setGroup(fe).onRenderUpdate(({camera:t},r)=>{r.value=r.value||new le,r.value.setFromMatrixPosition(n.matrixWorld),r.value.applyMatrix4(t.matrixWorldInverse)}))}const MT=n=>wr.transformDirection(RT(n).sub(W5(n))),q5=n=>n.sort((e,t)=>e.id-t.id),X5=(n,e)=>{for(const t of e)if(t.isAnalyticLightNode&&t.light.id===n)return t;return null},Yu=new WeakMap,ho=[];class PT extends ce{static get type(){return"LightsNode"}constructor(){super("vec3"),this.totalDiffuseNode=zr("vec3","totalDiffuse"),this.totalSpecularNode=zr("vec3","totalSpecular"),this.outgoingLightNode=zr("vec3","outgoingLight"),this._lights=[],this._lightNodes=null,this._lightNodesHash=null,this.global=!0}customCacheKey(){const e=this._lights;for(let r=0;r<e.length;r++){const i=e[r];if(ho.push(i.id),ho.push(i.castShadow?1:0),i.isSpotLight===!0){const s=i.map!==null?i.map.id:-1,o=i.colorNode?i.colorNode.getCacheKey():-1;ho.push(s,o)}}const t=ha(ho);return ho.length=0,t}getHash(e){if(this._lightNodesHash===null){this._lightNodes===null&&this.setupLightsNode(e);const t=[];for(const r of this._lightNodes)t.push(r.getHash());this._lightNodesHash="lights-"+t.join(",")}return this._lightNodesHash}analyze(e){const t=e.getNodeProperties(this);for(const r of t.nodes)r.build(e);t.outputNode.build(e)}setupLightsNode(e){const t=[],r=this._lightNodes,i=q5(this._lights),s=e.renderer.library;for(const o of i)if(o.isNode)t.push(J(o));else{let a=null;if(r!==null&&(a=X5(o.id,r)),a===null){const c=s.getLightNodeClass(o.constructor);if(c===null){se(`LightsNode.setupNodeLights: Light node not found for ${o.constructor.name}`);continue}let l=null;Yu.has(o)?l=Yu.get(o):(l=J(new c(o)),Yu.set(o,l)),t.push(l)}}this._lightNodes=t}setupDirectLight(e,t,r){const{lightingModel:i,reflectedLight:s}=e.context;i.direct({...r,lightNode:t,reflectedLight:s},e)}setupDirectRectAreaLight(e,t,r){const{lightingModel:i,reflectedLight:s}=e.context;i.directRectArea({...r,lightNode:t,reflectedLight:s},e)}setupLights(e,t){for(const r of t)r.build(e)}getLightNodes(e){return this._lightNodes===null&&this.setupLightsNode(e),this._lightNodes}setup(e){const t=e.lightsNode;e.lightsNode=this;let r=this.outgoingLightNode;const i=e.context,s=i.lightingModel,o=e.getNodeProperties(this);if(s){const{totalDiffuseNode:a,totalSpecularNode:c}=this;i.outgoingLight=r;const l=e.addStack();o.nodes=l.nodes,s.start(e);const{backdrop:u,backdropAlpha:d}=i,{directDiffuse:h,directSpecular:f,indirectDiffuse:p,indirectSpecular:g}=i.reflectedLight;let x=h.add(p);u!==null&&(d!==null?x=X(d.mix(x,u)):x=X(u)),a.assign(x),c.assign(f.add(g)),r.assign(a.add(c)),s.finish(e),r=r.bypass(e.removeStack())}else o.nodes=[];return e.lightsNode=t,r}setLights(e){return this._lights=e,this._lightNodes=null,this._lightNodesHash=null,this}getLights(){return this._lights}get hasLights(){return this._lights.length>0}}class Y5 extends ce{static get type(){return"ShadowBaseNode"}constructor(e){super(),this.light=e,this.updateBeforeType=_e.RENDER,this.isShadowBaseNode=!0}setupShadowPosition({context:e,material:t}){DT.assign(t.receivedShadowPositionNode||e.shadowPositionWorld||Ps)}}const DT=zr("vec3","shadowPositionWorld");function K5(n,e={}){return e.toneMapping=n.toneMapping,e.toneMappingExposure=n.toneMappingExposure,e.outputColorSpace=n.outputColorSpace,e.renderTarget=n.getRenderTarget(),e.activeCubeFace=n.getActiveCubeFace(),e.activeMipmapLevel=n.getActiveMipmapLevel(),e.renderObjectFunction=n.getRenderObjectFunction(),e.pixelRatio=n.getPixelRatio(),e.mrt=n.getMRT(),e.clearColor=n.getClearColor(e.clearColor||new un),e.clearAlpha=n.getClearAlpha(),e.autoClear=n.autoClear,e.scissorTest=n.getScissorTest(),e}function Q5(n,e){return e=K5(n,e),n.setMRT(null),n.setRenderObjectFunction(null),n.setClearColor(0,1),n.autoClear=!0,e}function Z5(n,e){n.toneMapping=e.toneMapping,n.toneMappingExposure=e.toneMappingExposure,n.outputColorSpace=e.outputColorSpace,n.setRenderTarget(e.renderTarget,e.activeCubeFace,e.activeMipmapLevel),n.setRenderObjectFunction(e.renderObjectFunction),n.setPixelRatio(e.pixelRatio),n.setMRT(e.mrt),n.setClearColor(e.clearColor,e.clearAlpha),n.autoClear=e.autoClear,n.setScissorTest(e.scissorTest)}function J5(n,e={}){return e.background=n.background,e.backgroundNode=n.backgroundNode,e.overrideMaterial=n.overrideMaterial,e}function e4(n,e){return e=J5(n,e),n.background=null,n.backgroundNode=null,n.overrideMaterial=null,e}function t4(n,e){n.background=e.background,n.backgroundNode=e.backgroundNode,n.overrideMaterial=e.overrideMaterial}function n4(n,e,t){return t=Q5(n,t),t=e4(e,t),t}function r4(n,e,t){Z5(n,t),t4(e,t)}const B0=new WeakMap,i4=Q(({depthTexture:n,shadowCoord:e,depthLayer:t})=>{let r=Ae(n,e.xy).setName("t_basic");return n.isArrayTexture&&(r=r.depth(t)),r.compare(e.z)}),s4=Q(({depthTexture:n,shadowCoord:e,shadow:t,depthLayer:r})=>{const i=(x,m)=>{let y=Ae(n,x);return n.isArrayTexture&&(y=y.depth(r)),y.compare(m)},s=Oe("mapSize","vec2",t).setGroup(fe),o=Oe("radius","float",t).setGroup(fe),a=ne(1).div(s),c=a.x.negate().mul(o),l=a.y.negate().mul(o),u=a.x.mul(o),d=a.y.mul(o),h=c.div(2),f=l.div(2),p=u.div(2),g=d.div(2);return Ht(i(e.xy.add(ne(c,l)),e.z),i(e.xy.add(ne(0,l)),e.z),i(e.xy.add(ne(u,l)),e.z),i(e.xy.add(ne(h,f)),e.z),i(e.xy.add(ne(0,f)),e.z),i(e.xy.add(ne(p,f)),e.z),i(e.xy.add(ne(c,0)),e.z),i(e.xy.add(ne(h,0)),e.z),i(e.xy,e.z),i(e.xy.add(ne(p,0)),e.z),i(e.xy.add(ne(u,0)),e.z),i(e.xy.add(ne(h,g)),e.z),i(e.xy.add(ne(0,g)),e.z),i(e.xy.add(ne(p,g)),e.z),i(e.xy.add(ne(c,d)),e.z),i(e.xy.add(ne(0,d)),e.z),i(e.xy.add(ne(u,d)),e.z)).mul(1/17)}),o4=Q(({depthTexture:n,shadowCoord:e,shadow:t,depthLayer:r})=>{const i=(d,h)=>{let f=Ae(n,d);return n.isArrayTexture&&(f=f.depth(r)),f.compare(h)},s=Oe("mapSize","vec2",t).setGroup(fe),o=ne(1).div(s),a=o.x,c=o.y,l=e.xy,u=Hn(l.mul(s).add(.5));return l.subAssign(u.mul(o)),Ht(i(l,e.z),i(l.add(ne(a,0)),e.z),i(l.add(ne(0,c)),e.z),i(l.add(o),e.z),He(i(l.add(ne(a.negate(),0)),e.z),i(l.add(ne(a.mul(2),0)),e.z),u.x),He(i(l.add(ne(a.negate(),c)),e.z),i(l.add(ne(a.mul(2),c)),e.z),u.x),He(i(l.add(ne(0,c.negate())),e.z),i(l.add(ne(0,c.mul(2))),e.z),u.y),He(i(l.add(ne(a,c.negate())),e.z),i(l.add(ne(a,c.mul(2))),e.z),u.y),He(He(i(l.add(ne(a.negate(),c.negate())),e.z),i(l.add(ne(a.mul(2),c.negate())),e.z),u.x),He(i(l.add(ne(a.negate(),c.mul(2))),e.z),i(l.add(ne(a.mul(2),c.mul(2))),e.z),u.x),u.y)).mul(1/9)}),a4=Q(({depthTexture:n,shadowCoord:e,depthLayer:t})=>{const r=j(1).toVar();let i=Ae(n).sample(e.xy);n.isArrayTexture&&(i=i.depth(t)),i=i.rg;const s=_v(e.z,i.x);return qe(s.notEqual(j(1)),()=>{const o=e.z.sub(i.x),a=gt(0,i.y.mul(i.y));let c=a.div(a.add(o.mul(o)));c=vr(Dt(c,.3).div(.95-.3)),r.assign(vr(gt(s,c)))}),r}),c4=Q(([n,e,t])=>{let r=Ps.sub(n).length();return r=r.sub(e).div(t.sub(e)),r=r.saturate(),r}),l4=n=>{const e=n.shadow.camera,t=Oe("near","float",e).setGroup(fe),r=Oe("far","float",e).setGroup(fe),i=MI(n);return c4(i,t,r)},u4=n=>{let e=B0.get(n);if(e===void 0){const t=n.isPointLight?l4(n):null;e=new at,e.colorNode=be(0,0,0,1),e.depthNode=t,e.isShadowPassMaterial=!0,e.name="ShadowMaterial",e.fog=!1,B0.set(n,e)}return e},F0=new Nn,Ki=[],d4=(n,e,t,r)=>{Ki[0]=n,Ki[1]=e;let i=F0.get(Ki);return(i===void 0||i.shadowType!==t||i.useVelocity!==r)&&(i=(s,o,a,c,l,u,...d)=>{(s.castShadow===!0||s.receiveShadow&&t===xc)&&(r&&(Q_(s).useVelocity=!0),s.onBeforeShadow(n,s,a,e.camera,c,o.overrideMaterial,u),n.renderObject(s,o,a,c,l,u,...d),s.onAfterShadow(n,s,a,e.camera,c,o.overrideMaterial,u))},i.shadowType=t,i.useVelocity=r,F0.set(Ki,i)),Ki[0]=null,Ki[1]=null,i},h4=Q(({samples:n,radius:e,size:t,shadowPass:r,depthLayer:i})=>{const s=j(0).toVar("meanVertical"),o=j(0).toVar("squareMeanVertical"),a=n.lessThanEqual(j(1)).select(j(0),j(2).div(n.sub(1))),c=n.lessThanEqual(j(1)).select(j(0),j(-1));rn({start:ze(0),end:ze(n),type:"int",condition:"<"},({i:u})=>{const d=c.add(j(u).mul(a));let h=r.sample(Ht(Ll.xy,ne(0,d).mul(e)).div(t));r.value.isArrayTexture&&(h=h.depth(i)),h=h.x,s.addAssign(h),o.addAssign(h.mul(h))}),s.divAssign(n),o.divAssign(n);const l=_i(o.sub(s.mul(s)));return ne(s,l)}),f4=Q(({samples:n,radius:e,size:t,shadowPass:r,depthLayer:i})=>{const s=j(0).toVar("meanHorizontal"),o=j(0).toVar("squareMeanHorizontal"),a=n.lessThanEqual(j(1)).select(j(0),j(2).div(n.sub(1))),c=n.lessThanEqual(j(1)).select(j(0),j(-1));rn({start:ze(0),end:ze(n),type:"int",condition:"<"},({i:u})=>{const d=c.add(j(u).mul(a));let h=r.sample(Ht(Ll.xy,ne(d,0).mul(e)).div(t));r.value.isArrayTexture&&(h=h.depth(i)),s.addAssign(h.x),o.addAssign(Ht(h.y.mul(h.y),h.x.mul(h.x)))}),s.divAssign(n),o.divAssign(n);const l=_i(o.sub(s.mul(s)));return ne(s,l)}),p4=[i4,s4,o4,a4];let Ku;const Ya=new fp;class BT extends Y5{static get type(){return"ShadowNode"}constructor(e,t=null){super(e),this.shadow=t||e.shadow,this.shadowMap=null,this.vsmShadowMapVertical=null,this.vsmShadowMapHorizontal=null,this.vsmMaterialVertical=null,this.vsmMaterialHorizontal=null,this._node=null,this._currentShadowType=null,this._cameraFrameId=new WeakMap,this.isShadowNode=!0,this.depthLayer=0}setupShadowFilter(e,{filterFn:t,depthTexture:r,shadowCoord:i,shadow:s,depthLayer:o}){const a=i.x.greaterThanEqual(0).and(i.x.lessThanEqual(1)).and(i.y.greaterThanEqual(0)).and(i.y.lessThanEqual(1)).and(i.z.lessThanEqual(1)),c=t({depthTexture:r,shadowCoord:i,shadow:s,depthLayer:o});return a.select(c,j(1))}setupShadowCoord(e,t){const{shadow:r}=this,{renderer:i}=e,s=Oe("bias","float",r).setGroup(fe);let o=t,a;if(r.camera.isOrthographicCamera||i.logarithmicDepthBuffer!==!0)o=o.xyz.div(o.w),a=o.z,i.coordinateSystem===_l&&(a=a.mul(2).sub(1));else{const c=o.w;o=o.xy.div(c);const l=Oe("near","float",r.camera).setGroup(fe),u=Oe("far","float",r.camera).setGroup(fe);a=sT(c.negate(),l,u)}return o=X(o.x,o.y.oneMinus(),a.add(s)),o}getShadowFilterFn(e){return p4[e]}setupRenderTarget(e,t){const r=new $n(e.mapSize.width,e.mapSize.height);r.name="ShadowDepthTexture",r.compareFunction=uf;const i=t.createRenderTarget(e.mapSize.width,e.mapSize.height);return i.texture.name="ShadowMap",i.texture.type=e.mapType,i.depthTexture=r,{shadowMap:i,depthTexture:r}}setupShadow(e){const{renderer:t,camera:r}=e,{light:i,shadow:s}=this,o=t.shadowMap.type,{depthTexture:a,shadowMap:c}=this.setupRenderTarget(s,e);if(s.camera.coordinateSystem=r.coordinateSystem,s.camera.updateProjectionMatrix(),o===xc&&s.isPointLightShadow!==!0){a.compareFunction=null,c.depth>1?(c._vsmShadowMapVertical||(c._vsmShadowMapVertical=e.createRenderTarget(s.mapSize.width,s.mapSize.height,{format:Fr,type:Ft,depth:c.depth,depthBuffer:!1}),c._vsmShadowMapVertical.texture.name="VSMVertical"),this.vsmShadowMapVertical=c._vsmShadowMapVertical,c._vsmShadowMapHorizontal||(c._vsmShadowMapHorizontal=e.createRenderTarget(s.mapSize.width,s.mapSize.height,{format:Fr,type:Ft,depth:c.depth,depthBuffer:!1}),c._vsmShadowMapHorizontal.texture.name="VSMHorizontal"),this.vsmShadowMapHorizontal=c._vsmShadowMapHorizontal):(this.vsmShadowMapVertical=e.createRenderTarget(s.mapSize.width,s.mapSize.height,{format:Fr,type:Ft,depthBuffer:!1}),this.vsmShadowMapHorizontal=e.createRenderTarget(s.mapSize.width,s.mapSize.height,{format:Fr,type:Ft,depthBuffer:!1}));let _=Ae(a);a.isArrayTexture&&(_=_.depth(this.depthLayer));let v=Ae(this.vsmShadowMapVertical.texture);a.isArrayTexture&&(v=v.depth(this.depthLayer));const T=Oe("blurSamples","float",s).setGroup(fe),w=Oe("radius","float",s).setGroup(fe),N=Oe("mapSize","vec2",s).setGroup(fe);let E=this.vsmMaterialVertical||(this.vsmMaterialVertical=new at);E.fragmentNode=h4({samples:T,radius:w,size:N,shadowPass:_,depthLayer:this.depthLayer}).context(e.getSharedContext()),E.name="VSMVertical",E=this.vsmMaterialHorizontal||(this.vsmMaterialHorizontal=new at),E.fragmentNode=f4({samples:T,radius:w,size:N,shadowPass:v,depthLayer:this.depthLayer}).context(e.getSharedContext()),E.name="VSMHorizontal"}const l=Oe("intensity","float",s).setGroup(fe),u=Oe("normalBias","float",s).setGroup(fe),d=pp(i).mul(DT.add($s.mul(u))),h=this.setupShadowCoord(e,d),f=s.filterNode||this.getShadowFilterFn(t.shadowMap.type)||null;if(f===null)throw new Error("THREE.WebGPURenderer: Shadow map type not supported yet.");const p=o===xc&&s.isPointLightShadow!==!0?this.vsmShadowMapHorizontal.texture:a,g=this.setupShadowFilter(e,{filterFn:f,shadowTexture:c.texture,depthTexture:p,shadowCoord:h,shadow:s,depthLayer:this.depthLayer});let x=Ae(c.texture,h);a.isArrayTexture&&(x=x.depth(this.depthLayer));const m=He(1,g.rgb.mix(x,1),l.mul(x.a)).toVar();this.shadowMap=c,this.shadow.map=c;const y=`${this.light.type} Shadow [ ${this.light.name||"ID: "+this.light.id} ]`;return m.toInspector(`${y} / Color`,()=>Ae(this.shadowMap.texture)).toInspector(`${y} / Depth`,()=>en(this.shadowMap.depthTexture,Us().mul(Ei(Ae(this.shadowMap.depthTexture)))).x.oneMinus())}setup(e){if(e.renderer.shadowMap.enabled!==!1)return Q(()=>{const t=e.renderer.shadowMap.type;this._currentShadowType!==t&&(this._reset(),this._node=null);let r=this._node;return this.setupShadowPosition(e),r===null&&(this._node=r=this.setupShadow(e),this._currentShadowType=t),e.material.shadowNode&&se('NodeMaterial: ".shadowNode" is deprecated. Use ".castShadowNode" instead.'),e.material.receivedShadowNode&&(r=e.material.receivedShadowNode(r)),r})()}renderShadow(e){const{shadow:t,shadowMap:r,light:i}=this,{renderer:s,scene:o}=e;t.updateMatrices(i),r.setSize(t.mapSize.width,t.mapSize.height,r.depth);const a=o.name;o.name=`Shadow Map [ ${i.name||"ID: "+i.id} ]`,s.render(o,t.camera),o.name=a}updateShadow(e){const{shadowMap:t,light:r,shadow:i}=this,{renderer:s,scene:o,camera:a}=e,c=s.shadowMap.type,l=t.depthTexture.version;this._depthVersionCached=l;const u=i.camera.layers.mask;(i.camera.layers.mask&4294967294)===0&&(i.camera.layers.mask=a.layers.mask);const d=s.getRenderObjectFunction(),h=s.getMRT(),f=h?h.has("velocity"):!1;Ku=n4(s,o,Ku),o.overrideMaterial=u4(r),s.setRenderObjectFunction(d4(s,i,c,f)),s.setClearColor(0,0),s.setRenderTarget(t),this.renderShadow(e),s.setRenderObjectFunction(d),c===xc&&i.isPointLightShadow!==!0&&this.vsmPass(s),i.camera.layers.mask=u,r4(s,o,Ku)}vsmPass(e){const{shadow:t}=this,r=this.shadowMap.depth;this.vsmShadowMapVertical.setSize(t.mapSize.width,t.mapSize.height,r),this.vsmShadowMapHorizontal.setSize(t.mapSize.width,t.mapSize.height,r),e.setRenderTarget(this.vsmShadowMapVertical),Ya.material=this.vsmMaterialVertical,Ya.render(e),e.setRenderTarget(this.vsmShadowMapHorizontal),Ya.material=this.vsmMaterialHorizontal,Ya.render(e)}dispose(){this._reset(),super.dispose()}_reset(){this._currentShadowType=null,this.shadowMap&&(this.shadowMap.dispose(),this.shadowMap=null),this.vsmShadowMapVertical!==null&&(this.vsmShadowMapVertical.dispose(),this.vsmShadowMapVertical=null,this.vsmMaterialVertical.dispose(),this.vsmMaterialVertical=null),this.vsmShadowMapHorizontal!==null&&(this.vsmShadowMapHorizontal.dispose(),this.vsmShadowMapHorizontal=null,this.vsmMaterialHorizontal.dispose(),this.vsmMaterialHorizontal=null)}updateBefore(e){const{shadow:t}=this;let r=t.needsUpdate||t.autoUpdate;r&&(this._cameraFrameId[e.camera]===e.frameId&&(r=!1),this._cameraFrameId[e.camera]=e.frameId),r&&(this.updateShadow(e),this.shadowMap.depthTexture.version===this._depthVersionCached&&(t.needsUpdate=!1))}}const g4=(n,e)=>J(new BT(n,e)),m4=new un,In=Q(([n,e])=>{const t=n.toVar(),r=Kt(t),i=jn(1,gt(r.x,gt(r.y,r.z)));r.mulAssign(i),t.mulAssign(i.mul(e.mul(2).oneMinus()));const s=ne(t.xy).toVar(),a=e.mul(1.5).oneMinus();return qe(r.z.greaterThanEqual(a),()=>{qe(t.z.greaterThan(0),()=>{s.x.assign(Dt(4,t.x))})}).ElseIf(r.x.greaterThanEqual(a),()=>{const c=cl(t.x);s.x.assign(t.z.mul(c).add(c.mul(2)))}).ElseIf(r.y.greaterThanEqual(a),()=>{const c=cl(t.y);s.x.assign(t.x.add(c.mul(2)).add(2)),s.y.assign(t.z.mul(c).sub(2))}),ne(.125,.25).mul(s).add(ne(.375,.75)).flipY()}).setLayout({name:"cubeToUV",type:"vec2",inputs:[{name:"pos",type:"vec3"},{name:"texelSizeY",type:"float"}]}),x4=Q(({depthTexture:n,bd3D:e,dp:t,texelSize:r})=>Ae(n,In(e,r.y)).compare(t)),y4=Q(({depthTexture:n,bd3D:e,dp:t,texelSize:r,shadow:i})=>{const s=Oe("radius","float",i).setGroup(fe),o=ne(-1,1).mul(s).mul(r.y);return Ae(n,In(e.add(o.xyy),r.y)).compare(t).add(Ae(n,In(e.add(o.yyy),r.y)).compare(t)).add(Ae(n,In(e.add(o.xyx),r.y)).compare(t)).add(Ae(n,In(e.add(o.yyx),r.y)).compare(t)).add(Ae(n,In(e,r.y)).compare(t)).add(Ae(n,In(e.add(o.xxy),r.y)).compare(t)).add(Ae(n,In(e.add(o.yxy),r.y)).compare(t)).add(Ae(n,In(e.add(o.xxx),r.y)).compare(t)).add(Ae(n,In(e.add(o.yxx),r.y)).compare(t)).mul(1/9)}),b4=Q(({filterFn:n,depthTexture:e,shadowCoord:t,shadow:r})=>{const i=t.xyz.toVar(),s=i.length(),o=pe("float").setGroup(fe).onRenderUpdate(()=>r.camera.near),a=pe("float").setGroup(fe).onRenderUpdate(()=>r.camera.far),c=Oe("bias","float",r).setGroup(fe),l=pe(r.mapSize).setGroup(fe),u=j(1).toVar();return qe(s.sub(a).lessThanEqual(0).and(s.sub(o).greaterThanEqual(0)),()=>{const d=s.sub(o).div(a.sub(o)).toVar();d.addAssign(c);const h=i.normalize(),f=ne(1).div(l.mul(ne(4,2)));u.assign(n({depthTexture:e,bd3D:h,dp:d,texelSize:f,shadow:r}))}),u}),k0=new Ze,Qi=new Te,fo=new Te;class _4 extends BT{static get type(){return"PointShadowNode"}constructor(e,t=null){super(e,t)}getShadowFilterFn(e){return e===NS?x4:y4}setupShadowCoord(e,t){return t}setupShadowFilter(e,{filterFn:t,shadowTexture:r,depthTexture:i,shadowCoord:s,shadow:o}){return b4({filterFn:t,shadowTexture:r,depthTexture:i,shadowCoord:s,shadow:o})}renderShadow(e){const{shadow:t,shadowMap:r,light:i}=this,{renderer:s,scene:o}=e,a=t.getFrameExtents();fo.copy(t.mapSize),fo.multiply(a),r.setSize(fo.width,fo.height),Qi.copy(t.mapSize);const c=s.autoClear,l=s.getClearColor(m4),u=s.getClearAlpha();s.autoClear=!1,s.setClearColor(t.clearColor,t.clearAlpha),s.clear();const d=t.getViewportCount();for(let h=0;h<d;h++){const f=t.getViewport(h),p=Qi.x*f.x,g=fo.y-Qi.y-Qi.y*f.y;k0.set(p,g,Qi.x*f.z,Qi.y*f.w),r.viewport.copy(k0),t.updateMatrices(i,h);const x=o.name;o.name=`Point Light Shadow [ ${i.name||"ID: "+i.id} ] - Face ${h+1}`,s.render(o,t.camera),o.name=x}s.autoClear=c,s.setClearColor(l,u)}}const v4=(n,e)=>J(new _4(n,e));class Bi extends Vs{static get type(){return"AnalyticLightNode"}constructor(e=null){super(),this.light=e,this.color=new un,this.colorNode=e&&e.colorNode||pe(this.color).setGroup(fe),this.baseColorNode=null,this.shadowNode=null,this.shadowColorNode=null,this.isAnalyticLightNode=!0,this.updateType=_e.FRAME}getHash(){return this.light.uuid}getLightVector(e){return CT(this.light).sub(e.context.positionView||ot)}setupDirect(){}setupDirectRectArea(){}setupShadowNode(){return g4(this.light)}setupShadow(e){const{renderer:t}=e;if(t.shadowMap.enabled===!1)return;let r=this.shadowColorNode;if(r===null){const i=this.light.shadow.shadowNode;let s;i!==void 0?s=J(i):s=this.setupShadowNode(),this.shadowNode=s,this.shadowColorNode=r=this.colorNode.mul(s),this.baseColorNode=this.colorNode}this.colorNode=r}setup(e){this.colorNode=this.baseColorNode||this.colorNode,this.light.castShadow?e.object.receiveShadow&&this.setupShadow(e):this.shadowNode!==null&&(this.shadowNode.dispose(),this.shadowNode=null,this.shadowColorNode=null);const t=this.setupDirect(e),r=this.setupDirectRectArea(e);t&&e.lightsNode.setupDirectLight(e,this,t),r&&e.lightsNode.setupDirectRectAreaLight(e,this,r)}update(){const{light:e}=this;this.color.copy(e.color).multiplyScalar(e.intensity)}}const FT=Q(({lightDistance:n,cutoffDistance:e,decayExponent:t})=>{const r=n.pow(t).max(.01).reciprocal();return e.greaterThan(0).select(r.mul(n.div(e).pow4().oneMinus().clamp().pow2()),r)}),T4=({color:n,lightVector:e,cutoffDistance:t,decayExponent:r})=>{const i=e.normalize(),s=e.length(),o=FT({lightDistance:s,cutoffDistance:t,decayExponent:r}),a=n.mul(o);return{lightDirection:i,lightColor:a}};class w4 extends Bi{static get type(){return"PointLightNode"}constructor(e=null){super(e),this.cutoffDistanceNode=pe(0).setGroup(fe),this.decayExponentNode=pe(2).setGroup(fe)}update(e){const{light:t}=this;super.update(e),this.cutoffDistanceNode.value=t.distance,this.decayExponentNode.value=t.decay}setupShadowNode(){return v4(this.light)}setupDirect(e){return T4({color:this.colorNode,lightVector:this.getLightVector(e),cutoffDistance:this.cutoffDistanceNode,decayExponent:this.decayExponentNode})}}Q(([n=Us()],{renderer:e,material:t})=>{const r=wv(n.mul(2).sub(1));let i;if(t.alphaToCoverage&&e.currentSamples>0){const s=j(r.fwidth()).toVar();i=Tr(s.oneMinus(),s.add(1),r).oneMinus()}else i=Tt(r.greaterThan(1),0,1);return i});const S4=Q(([n,e])=>{const t=n.x,r=n.y,i=n.z;let s=e.element(0).mul(.886227);return s=s.add(e.element(1).mul(2*.511664).mul(r)),s=s.add(e.element(2).mul(2*.511664).mul(i)),s=s.add(e.element(3).mul(2*.511664).mul(t)),s=s.add(e.element(4).mul(2*.429043).mul(t).mul(r)),s=s.add(e.element(5).mul(2*.429043).mul(r).mul(i)),s=s.add(e.element(6).mul(i.mul(i).mul(.743125).sub(.247708))),s=s.add(e.element(7).mul(2*.429043).mul(t).mul(i)),s=s.add(e.element(8).mul(.429043).mul(ve(t,t).sub(ve(r,r)))),s}),dn=new hp;class N4 extends Wr{constructor(e,t){super(),this.renderer=e,this.nodes=t}update(e,t,r){const i=this.renderer,s=this.nodes.getBackgroundNode(e)||e.background;let o=!1;if(s===null)i._clearColor.getRGB(dn),dn.a=i._clearColor.a;else if(s.isColor===!0)s.getRGB(dn),dn.a=1,o=!0;else if(s.isNode===!0){const c=this.get(e),l=s;dn.copy(i._clearColor);let u=c.backgroundMesh;if(u===void 0){let g=function(){s.removeEventListener("dispose",g),u.material.dispose(),u.geometry.dispose()};const h=Il(be(l).mul(M0),{getUV:()=>E5.mul(II),getTextureLevel:()=>N5});let f=tT;f=f.setZ(f.w);const p=new at;p.name="Background.material",p.side=jt,p.depthTest=!1,p.depthWrite=!1,p.allowOverride=!1,p.fog=!1,p.lights=!1,p.vertexNode=f,p.colorNode=h,c.backgroundMeshNode=h,c.backgroundMesh=u=new wn(new ef(1,32,32),p),u.frustumCulled=!1,u.name="Background.mesh",u.onBeforeRender=function(x,m,y){this.matrixWorld.copyPosition(y.matrixWorld)},s.addEventListener("dispose",g)}const d=l.getCacheKey();c.backgroundCacheKey!==d&&(c.backgroundMeshNode.node=be(l).mul(M0),c.backgroundMeshNode.needsUpdate=!0,u.material.needsUpdate=!0,c.backgroundCacheKey=d),t.unshift(u,u.geometry,u.material,0,0,null,null)}else ie("Renderer: Unsupported background configuration.",s);const a=i.xr.getEnvironmentBlendMode();if(a==="additive"?dn.set(0,0,0,1):a==="alpha-blend"&&dn.set(0,0,0,0),i.autoClear===!0||o===!0){const c=r.clearColorValue;c.r=dn.r,c.g=dn.g,c.b=dn.b,c.a=dn.a,(i.backend.isWebGLBackend===!0||i.alpha===!0)&&(c.r*=c.a,c.g*=c.a,c.b*=c.a),r.depthClearValue=i._clearDepth,r.stencilClearValue=i._clearStencil,r.clearColor=i.autoClearColor===!0,r.clearDepth=i.autoClearDepth===!0,r.clearStencil=i.autoClearStencil===!0}else r.clearColor=!1,r.clearDepth=!1,r.clearStencil=!1}}let E4=0;class Lh{constructor(e="",t=[],r=0,i=[]){this.name=e,this.bindings=t,this.index=r,this.bindingsReference=i,this.id=E4++}}class A4{constructor(e,t,r,i,s,o,a,c,l,u=[]){this.vertexShader=e,this.fragmentShader=t,this.computeShader=r,this.transforms=u,this.nodeAttributes=i,this.bindings=s,this.updateNodes=o,this.updateBeforeNodes=a,this.updateAfterNodes=c,this.observer=l,this.usedTimes=0}createBindings(){const e=[];for(const t of this.bindings)if(t.bindings[0].groupNode.shared!==!0){const i=new Lh(t.name,[],t.index,t.bindingsReference);e.push(i);for(const s of t.bindings)i.bindings.push(s.clone())}else e.push(t);return e}}class I0{constructor(e,t,r=null){this.isNodeAttribute=!0,this.name=e,this.type=t,this.node=r}}class R4{constructor(e,t,r){this.isNodeUniform=!0,this.name=e,this.type=t,this.node=r}get value(){return this.node.value}set value(e){this.node.value=e}get id(){return this.node.id}get groupNode(){return this.node.groupNode}}class kT{constructor(e,t,r=!1,i=null){this.isNodeVar=!0,this.name=e,this.type=t,this.readOnly=r,this.count=i}}class C4 extends kT{constructor(e,t,r=null,i=null){super(e,t),this.needsInterpolation=!1,this.isNodeVarying=!0,this.interpolationType=r,this.interpolationSampling=i}}class M4{constructor(e,t,r=""){this.name=e,this.type=t,this.code=r,Object.defineProperty(this,"isNodeCode",{value:!0})}}let P4=0;class Qu{constructor(e=null){this.id=P4++,this.nodesData=new WeakMap,this.parent=e}getData(e){let t=this.nodesData.get(e);return t===void 0&&this.parent!==null&&(t=this.parent.getData(e)),t}setData(e,t){this.nodesData.set(e,t)}}class D4{constructor(e,t){this.name=e,this.members=t,this.output=!1}}class qr{constructor(e,t){this.name=e,this.value=t,this.boundary=0,this.itemSize=0,this.offset=0}setValue(e){this.value=e}getValue(){return this.value}}class B4 extends qr{constructor(e,t=0){super(e,t),this.isNumberUniform=!0,this.boundary=4,this.itemSize=1}}class F4 extends qr{constructor(e,t=new Te){super(e,t),this.isVector2Uniform=!0,this.boundary=8,this.itemSize=2}}class k4 extends qr{constructor(e,t=new le){super(e,t),this.isVector3Uniform=!0,this.boundary=16,this.itemSize=3}}class I4 extends qr{constructor(e,t=new Ze){super(e,t),this.isVector4Uniform=!0,this.boundary=16,this.itemSize=4}}class L4 extends qr{constructor(e,t=new un){super(e,t),this.isColorUniform=!0,this.boundary=16,this.itemSize=3}}class O4 extends qr{constructor(e,t=new Ry){super(e,t),this.isMatrix2Uniform=!0,this.boundary=8,this.itemSize=4}}class U4 extends qr{constructor(e,t=new oa){super(e,t),this.isMatrix3Uniform=!0,this.boundary=48,this.itemSize=12}}class G4 extends qr{constructor(e,t=new En){super(e,t),this.isMatrix4Uniform=!0,this.boundary=64,this.itemSize=16}}class $4 extends B4{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class V4 extends F4{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class z4 extends k4{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class j4 extends I4{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class H4 extends L4{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class W4 extends O4{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class q4 extends U4{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class X4 extends G4{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}let Y4=0;const L0=new WeakMap,K4=new Map([[Int8Array,"int"],[Int16Array,"int"],[Int32Array,"int"],[Uint8Array,"uint"],[Uint16Array,"uint"],[Uint32Array,"uint"],[Float32Array,"float"]]),Ka=n=>/e/g.test(n)?String(n).replace(/\+/g,""):(n=Number(n),n+(n%1?"":".0"));class IT{constructor(e,t,r){this.object=e,this.material=e&&e.material||null,this.geometry=e&&e.geometry||null,this.renderer=t,this.parser=r,this.scene=null,this.camera=null,this.nodes=[],this.sequentialNodes=[],this.updateNodes=[],this.updateBeforeNodes=[],this.updateAfterNodes=[],this.hashNodes={},this.observer=null,this.lightsNode=null,this.environmentNode=null,this.fogNode=null,this.clippingContext=null,this.vertexShader=null,this.fragmentShader=null,this.computeShader=null,this.flowNodes={vertex:[],fragment:[],compute:[]},this.flowCode={vertex:"",fragment:"",compute:""},this.uniforms={vertex:[],fragment:[],compute:[],index:0},this.structs={vertex:[],fragment:[],compute:[],index:0},this.types={vertex:[],fragment:[],compute:[],index:0},this.bindings={vertex:{},fragment:{},compute:{}},this.bindingsIndexes={},this.bindGroups=null,this.attributes=[],this.bufferAttributes=[],this.varyings=[],this.codes={},this.vars={},this.declarations={},this.flow={code:""},this.chaining=[],this.stack=Wu(),this.stacks=[],this.tab="	",this.currentFunctionNode=null,this.context={material:this.material},this.cache=new Qu,this.globalCache=this.cache,this.flowsData=new WeakMap,this.shaderStage=null,this.buildStage=null,this.subBuildLayers=[],this.activeStacks=[],this.subBuildFn=null,this.fnCall=null,Object.defineProperty(this,"id",{value:Y4++})}isOpaque(){const e=this.material;return e.transparent===!1&&e.blending===wi&&e.alphaToCoverage===!1}getBindGroupsCache(){let e=L0.get(this.renderer);return e===void 0&&(e=new Nn,L0.set(this.renderer,e)),e}createRenderTarget(e,t,r){return new Is(e,t,r)}createCubeRenderTarget(e,t){return new lT(e,t)}includes(e){return this.nodes.includes(e)}getOutputStructName(){}_getBindGroup(e,t){const r=this.getBindGroupsCache(),i=[];let s=!0;for(const a of t)i.push(a),s=s&&a.groupNode.shared!==!0;let o;return s?(o=r.get(i),o===void 0&&(o=new Lh(e,i,this.bindingsIndexes[e].group,i),r.set(i,o))):o=new Lh(e,i,this.bindingsIndexes[e].group,i),o}getBindGroupArray(e,t){const r=this.bindings[t];let i=r[e];return i===void 0&&(this.bindingsIndexes[e]===void 0&&(this.bindingsIndexes[e]={binding:0,group:Object.keys(this.bindingsIndexes).length}),r[e]=i=[]),i}getBindings(){let e=this.bindGroups;if(e===null){const t={},r=this.bindings;for(const i of Fm)for(const s in r[i]){const o=r[i][s];(t[s]||(t[s]=[])).push(...o)}e=[];for(const i in t){const s=t[i],o=this._getBindGroup(i,s);e.push(o)}this.bindGroups=e}return e}sortBindingGroups(){const e=this.getBindings();e.sort((t,r)=>t.bindings[0].groupNode.order-r.bindings[0].groupNode.order);for(let t=0;t<e.length;t++){const r=e[t];this.bindingsIndexes[r.name].group=t,r.index=t}}setHashNode(e,t){this.hashNodes[t]=e}addNode(e){this.nodes.includes(e)===!1&&(this.nodes.push(e),this.setHashNode(e,e.getHash(this)))}addSequentialNode(e){this.sequentialNodes.includes(e)===!1&&this.sequentialNodes.push(e)}buildUpdateNodes(){for(const e of this.nodes)e.getUpdateType()!==_e.NONE&&this.updateNodes.push(e);for(const e of this.sequentialNodes){const t=e.getUpdateBeforeType(),r=e.getUpdateAfterType();t!==_e.NONE&&this.updateBeforeNodes.push(e),r!==_e.NONE&&this.updateAfterNodes.push(e)}}get currentNode(){return this.chaining[this.chaining.length-1]}isFilteredTexture(e){return e.magFilter===Sn||e.magFilter===Ed||e.magFilter===Vo||e.magFilter===Ti||e.minFilter===Sn||e.minFilter===Ed||e.minFilter===Vo||e.minFilter===Ti}addChain(e){this.chaining.push(e)}removeChain(e){if(this.chaining.pop()!==e)throw new Error("NodeBuilder: Invalid node chaining!")}getMethod(e){return e}getTernary(){return null}getNodeFromHash(e){return this.hashNodes[e]}addFlow(e,t){return this.flowNodes[e].push(t),t}setContext(e){this.context=e}getContext(){return this.context}addContext(e){const t=this.getContext();return this.setContext({...this.context,...e}),t}getSharedContext(){return{...this.context},this.context}setCache(e){this.cache=e}getCache(){return this.cache}getCacheFromNode(e,t=!0){const r=this.getDataFromNode(e);return r.cache===void 0&&(r.cache=new Qu(t?this.getCache():null)),r.cache}isAvailable(){return!1}getVertexIndex(){se("Abstract function.")}getInstanceIndex(){se("Abstract function.")}getDrawIndex(){se("Abstract function.")}getFrontFacing(){se("Abstract function.")}getFragCoord(){se("Abstract function.")}isFlipY(){return!1}increaseUsage(e){const t=this.getDataFromNode(e);return t.usageCount=t.usageCount===void 0?1:t.usageCount+1,t.usageCount}generateTexture(){se("Abstract function.")}generateTextureLod(){se("Abstract function.")}generateArrayDeclaration(e,t){return this.getType(e)+"[ "+t+" ]"}generateArray(e,t,r=null){let i=this.generateArrayDeclaration(e,t)+"( ";for(let s=0;s<t;s++){const o=r?r[s]:null;o!==null?i+=o.build(this,e):i+=this.generateConst(e),s<t-1&&(i+=", ")}return i+=" )",i}generateStruct(e,t,r=null){const i=[];for(const s of t){const{name:o,type:a}=s;r&&r[o]&&r[o].isNode?i.push(r[o].build(this,a)):i.push(this.generateConst(a))}return e+"( "+i.join(", ")+" )"}generateConst(e,t=null){if(t===null&&(e==="float"||e==="int"||e==="uint"?t=0:e==="bool"?t=!1:e==="color"?t=new un:e==="vec2"?t=new Te:e==="vec3"?t=new le:e==="vec4"&&(t=new Ze)),e==="float")return Ka(t);if(e==="int")return`${Math.round(t)}`;if(e==="uint")return t>=0?`${Math.round(t)}u`:"0u";if(e==="bool")return t?"true":"false";if(e==="color")return`${this.getType("vec3")}( ${Ka(t.r)}, ${Ka(t.g)}, ${Ka(t.b)} )`;const r=this.getTypeLength(e),i=this.getComponentType(e),s=o=>this.generateConst(i,o);if(r===2)return`${this.getType(e)}( ${s(t.x)}, ${s(t.y)} )`;if(r===3)return`${this.getType(e)}( ${s(t.x)}, ${s(t.y)}, ${s(t.z)} )`;if(r===4&&e!=="mat2")return`${this.getType(e)}( ${s(t.x)}, ${s(t.y)}, ${s(t.z)}, ${s(t.w)} )`;if(r>=4&&t&&(t.isMatrix2||t.isMatrix3||t.isMatrix4))return`${this.getType(e)}( ${t.elements.map(s).join(", ")} )`;if(r>4)return`${this.getType(e)}()`;throw new Error(`NodeBuilder: Type '${e}' not found in generate constant attempt.`)}getType(e){return e==="color"?"vec3":e}hasGeometryAttribute(e){return this.geometry&&this.geometry.getAttribute(e)!==void 0}getAttribute(e,t){const r=this.attributes;for(const s of r)if(s.name===e)return s;const i=new I0(e,t);return this.registerDeclaration(i),r.push(i),i}getPropertyName(e){return e.name}isVector(e){return/vec\d/.test(e)}isMatrix(e){return/mat\d/.test(e)}isReference(e){return e==="void"||e==="property"||e==="sampler"||e==="samplerComparison"||e==="texture"||e==="cubeTexture"||e==="storageTexture"||e==="depthTexture"||e==="texture3D"}needsToWorkingColorSpace(){return!1}getComponentTypeFromTexture(e){const t=e.type;if(e.isDataTexture){if(t===Pt)return"int";if(t===dt)return"uint"}return"float"}getElementType(e){return e==="mat2"?"vec2":e==="mat3"?"vec3":e==="mat4"?"vec4":this.getComponentType(e)}getComponentType(e){if(e=this.getVectorType(e),e==="float"||e==="bool"||e==="int"||e==="uint")return e;const t=/(b|i|u|)(vec|mat)([2-4])/.exec(e);return t===null?null:t[1]==="b"?"bool":t[1]==="i"?"int":t[1]==="u"?"uint":"float"}getVectorType(e){return e==="color"?"vec3":e==="texture"||e==="cubeTexture"||e==="storageTexture"||e==="texture3D"?"vec4":e}getTypeFromLength(e,t="float"){if(e===1)return t;let r=KB(e);const i=t==="float"?"":t[0];return/mat2/.test(t)===!0&&(r=r.replace("vec","mat")),i+r}getTypeFromArray(e){return K4.get(e.constructor)}isInteger(e){return/int|uint|(i|u)vec/.test(e)}getTypeFromAttribute(e){let t=e;e.isInterleavedBufferAttribute&&(t=e.data);const r=t.array,i=e.itemSize,s=e.normalized;let o;return!(e instanceof Cy)&&s!==!0&&(o=this.getTypeFromArray(r)),this.getTypeFromLength(i,o)}getTypeLength(e){const t=this.getVectorType(e),r=/vec([2-4])/.exec(t);return r!==null?Number(r[1]):t==="float"||t==="bool"||t==="int"||t==="uint"?1:/mat2/.test(e)===!0?4:/mat3/.test(e)===!0?9:/mat4/.test(e)===!0?16:0}getVectorFromMatrix(e){return e.replace("mat","vec")}changeComponentType(e,t){return this.getTypeFromLength(this.getTypeLength(e),t)}getIntegerType(e){const t=this.getComponentType(e);return t==="int"||t==="uint"?e:this.changeComponentType(e,"int")}setActiveStack(e){this.activeStacks.push(e)}removeActiveStack(e){if(this.activeStacks[this.activeStacks.length-1]===e)this.activeStacks.pop();else throw new Error("NodeBuilder: Invalid active stack removal.")}getActiveStack(){return this.activeStacks[this.activeStacks.length-1]}getBaseStack(){return this.activeStacks[0]}addStack(){this.stack=Wu(this.stack);const e=tv();return this.stacks.push(e),rl(this.stack),this.stack}removeStack(){const e=this.stack;for(const t of e.nodes){const r=this.getDataFromNode(t);r.stack=e}return this.stack=e.parent,rl(this.stacks.pop()),e}getDataFromNode(e,t=this.shaderStage,r=null){r=r===null?e.isGlobal(this)?this.globalCache:this.cache:r;let i=r.getData(e);i===void 0&&(i={},r.setData(e,i)),i[t]===void 0&&(i[t]={});let s=i[t];const o=i.any?i.any.subBuilds:null,a=this.getClosestSubBuild(o);return a&&(s.subBuildsCache===void 0&&(s.subBuildsCache={}),s=s.subBuildsCache[a]||(s.subBuildsCache[a]={}),s.subBuilds=o),s}getNodeProperties(e,t="any"){const r=this.getDataFromNode(e,t);return r.properties||(r.properties={outputNode:null})}getBufferAttributeFromNode(e,t){const r=this.getDataFromNode(e);let i=r.bufferAttribute;if(i===void 0){const s=this.uniforms.index++;i=new I0("nodeAttribute"+s,t,e),this.bufferAttributes.push(i),r.bufferAttribute=i}return i}getStructTypeNode(e,t=this.shaderStage){return this.types[t][e]||null}getStructTypeFromNode(e,t,r=null,i=this.shaderStage){const s=this.getDataFromNode(e,i,this.globalCache);let o=s.structType;if(o===void 0){const a=this.structs.index++;r===null&&(r="StructType"+a),o=new D4(r,t),this.structs[i].push(o),this.types[i][r]=e,s.structType=o}return o}getOutputStructTypeFromNode(e,t){const r=this.getStructTypeFromNode(e,t,"OutputType","fragment");return r.output=!0,r}getUniformFromNode(e,t,r=this.shaderStage,i=null){const s=this.getDataFromNode(e,r,this.globalCache);let o=s.uniform;if(o===void 0){const a=this.uniforms.index++;o=new R4(i||"nodeUniform"+a,t,e),this.uniforms[r].push(o),this.registerDeclaration(o),s.uniform=o}return o}getVarFromNode(e,t=null,r=e.getNodeType(this),i=this.shaderStage,s=!1){const o=this.getDataFromNode(e,i),a=this.getSubBuildProperty("variable",o.subBuilds);let c=o[a];if(c===void 0){const l=s?"_const":"_var",u=this.vars[i]||(this.vars[i]=[]),d=this.vars[l]||(this.vars[l]=0);t===null&&(t=(s?"nodeConst":"nodeVar")+d,this.vars[l]++),a!=="variable"&&(t=this.getSubBuildProperty(t,o.subBuilds));const h=e.getArrayCount(this);c=new kT(t,r,s,h),s||u.push(c),this.registerDeclaration(c),o[a]=c}return c}isDeterministic(e){if(e.isMathNode)return this.isDeterministic(e.aNode)&&(e.bNode?this.isDeterministic(e.bNode):!0)&&(e.cNode?this.isDeterministic(e.cNode):!0);if(e.isOperatorNode)return this.isDeterministic(e.aNode)&&(e.bNode?this.isDeterministic(e.bNode):!0);if(e.isArrayNode){if(e.values!==null){for(const t of e.values)if(!this.isDeterministic(t))return!1}return!0}else if(e.isConstNode)return!0;return!1}getVaryingFromNode(e,t=null,r=e.getNodeType(this),i=null,s=null){const o=this.getDataFromNode(e,"any"),a=this.getSubBuildProperty("varying",o.subBuilds);let c=o[a];if(c===void 0){const l=this.varyings,u=l.length;t===null&&(t="nodeVarying"+u),a!=="varying"&&(t=this.getSubBuildProperty(t,o.subBuilds)),c=new C4(t,r,i,s),l.push(c),this.registerDeclaration(c),o[a]=c}return c}registerDeclaration(e){const t=this.shaderStage,r=this.declarations[t]||(this.declarations[t]={}),i=this.getPropertyName(e);let s=1,o=i;for(;r[o]!==void 0;)o=i+"_"+s++;s>1&&(e.name=o,se(`TSL: Declaration name '${i}' of '${e.type}' already in use. Renamed to '${o}'.`)),r[o]=e}getCodeFromNode(e,t,r=this.shaderStage){const i=this.getDataFromNode(e);let s=i.code;if(s===void 0){const o=this.codes[r]||(this.codes[r]=[]),a=o.length;s=new M4("nodeCode"+a,t),o.push(s),i.code=s}return s}addFlowCodeHierarchy(e,t){const{flowCodes:r,flowCodeBlock:i}=this.getDataFromNode(e);let s=!0,o=t;for(;o;){if(i.get(o)===!0){s=!1;break}o=this.getDataFromNode(o).parentNodeBlock}if(s)for(const a of r)this.addLineFlowCode(a)}addLineFlowCodeBlock(e,t,r){const i=this.getDataFromNode(e),s=i.flowCodes||(i.flowCodes=[]),o=i.flowCodeBlock||(i.flowCodeBlock=new WeakMap);s.push(t),o.set(r,!0)}addLineFlowCode(e,t=null){return e===""?this:(t!==null&&this.context.nodeBlock&&this.addLineFlowCodeBlock(t,e,this.context.nodeBlock),e=this.tab+e,/;\s*$/.test(e)||(e=e+`;
`),this.flow.code+=e,this)}addFlowCode(e){return this.flow.code+=e,this}addFlowTab(){return this.tab+="	",this}removeFlowTab(){return this.tab=this.tab.slice(0,-1),this}getFlowData(e){return this.flowsData.get(e)}flowNode(e){const t=e.getNodeType(this),r=this.flowChildNode(e,t);return this.flowsData.set(e,r),r}addInclude(e){this.currentFunctionNode!==null&&this.currentFunctionNode.includes.push(e)}buildFunctionNode(e){const t=new $5,r=this.currentFunctionNode;return this.currentFunctionNode=t,t.code=this.buildFunctionCode(e),this.currentFunctionNode=r,t}flowShaderNode(e){const t=e.layout,r={[Symbol.iterator](){let o=0;const a=Object.values(this);return{next:()=>({value:a[o],done:o++>=a.length})}}};for(const o of t.inputs)r[o.name]=new _5(o.type,o.name);e.layout=null;const i=e.call(r),s=this.flowStagesNode(i,t.type);return e.layout=t,s}flowBuildStage(e,t,r=null){const i=this.getBuildStage();this.setBuildStage(t);const s=e.build(this,r);return this.setBuildStage(i),s}flowStagesNode(e,t=null){const r=this.flow,i=this.vars,s=this.declarations,o=this.cache,a=this.buildStage,c=this.stack,l={code:""};this.flow=l,this.vars={},this.declarations={},this.cache=new Qu,this.stack=Wu();for(const u of Bm)this.setBuildStage(u),l.result=e.build(this,t);return l.vars=this.getVars(this.shaderStage),this.flow=r,this.vars=i,this.declarations=s,this.cache=o,this.stack=c,this.setBuildStage(a),l}getFunctionOperator(){return null}buildFunctionCode(){se("Abstract function.")}flowChildNode(e,t=null){const r=this.flow,i={code:""};return this.flow=i,i.result=e.build(this,t),this.flow=r,i}flowNodeFromShaderStage(e,t,r=null,i=null){const s=this.tab,o=this.cache,a=this.shaderStage,c=this.context;this.setShaderStage(e);const l={...this.context};delete l.nodeBlock,this.cache=this.globalCache,this.tab="	",this.context=l;let u=null;if(this.buildStage==="generate"){const d=this.flowChildNode(t,r);i!==null&&(d.code+=`${this.tab+i} = ${d.result};
`),this.flowCode[e]=this.flowCode[e]+d.code,u=d}else u=t.build(this);return this.setShaderStage(a),this.cache=o,this.tab=s,this.context=c,u}getAttributesArray(){return this.attributes.concat(this.bufferAttributes)}getAttributes(){se("Abstract function.")}getVaryings(){se("Abstract function.")}getVar(e,t,r=null){return`${r!==null?this.generateArrayDeclaration(e,r):this.getType(e)} ${t}`}getVars(e){let t="";const r=this.vars[e];if(r!==void 0)for(const i of r)t+=`${this.getVar(i.type,i.name)}; `;return t}getUniforms(){se("Abstract function.")}getCodes(e){const t=this.codes[e];let r="";if(t!==void 0)for(const i of t)r+=i.code+`
`;return r}getHash(){return this.vertexShader+this.fragmentShader+this.computeShader}setShaderStage(e){this.shaderStage=e}getShaderStage(){return this.shaderStage}setBuildStage(e){this.buildStage=e}getBuildStage(){return this.buildStage}buildCode(){se("Abstract function.")}get subBuild(){return this.subBuildLayers[this.subBuildLayers.length-1]||null}addSubBuild(e){this.subBuildLayers.push(e)}removeSubBuild(){return this.subBuildLayers.pop()}getClosestSubBuild(e){let t;if(e&&e.isNode?e.isShaderCallNodeInternal?t=e.shaderNode.subBuilds:e.isStackNode?t=[e.subBuild]:t=this.getDataFromNode(e,"any").subBuilds:e instanceof Set?t=[...e]:t=e,!t)return null;const r=this.subBuildLayers;for(let i=t.length-1;i>=0;i--){const s=t[i];if(r.includes(s))return s}return null}getSubBuildOutput(e){return this.getSubBuildProperty("outputNode",e)}getSubBuildProperty(e="",t=null){let r;t!==null?r=this.getClosestSubBuild(t):r=this.subBuildFn;let i;return r?i=e?r+"_"+e:r:i=e,i}build(){const{object:e,material:t,renderer:r}=this;if(t!==null){let i=r.library.fromMaterial(t);i===null&&(ie(`NodeMaterial: Material "${t.type}" is not compatible.`),i=new at),i.build(this)}else this.addFlow("compute",e);for(const i of Bm){this.setBuildStage(i),this.context.vertex&&this.context.vertex.isNode&&this.flowNodeFromShaderStage("vertex",this.context.vertex);for(const s of Fm){this.setShaderStage(s);const o=this.flowNodes[s];for(const a of o)i==="generate"?this.flowNode(a):a.build(this)}}return this.setBuildStage(null),this.setShaderStage(null),this.buildCode(),this.buildUpdateNodes(),this}getNodeUniform(e,t){if(t==="float"||t==="int"||t==="uint")return new $4(e);if(t==="vec2"||t==="ivec2"||t==="uvec2")return new V4(e);if(t==="vec3"||t==="ivec3"||t==="uvec3")return new z4(e);if(t==="vec4"||t==="ivec4"||t==="uvec4")return new j4(e);if(t==="color")return new H4(e);if(t==="mat2")return new W4(e);if(t==="mat3")return new q4(e);if(t==="mat4")return new X4(e);throw new Error(`Uniform "${t}" not declared.`)}format(e,t,r){if(t=this.getVectorType(t),r=this.getVectorType(r),t===r||r===null||this.isReference(r))return e;const i=this.getTypeLength(t),s=this.getTypeLength(r);return i===16&&s===9?`${this.getType(r)}( ${e}[ 0 ].xyz, ${e}[ 1 ].xyz, ${e}[ 2 ].xyz )`:i===9&&s===4?`${this.getType(r)}( ${e}[ 0 ].xy, ${e}[ 1 ].xy )`:i>4||s>4||s===0?e:i===s?`${this.getType(r)}( ${e} )`:i>s?(e=r==="bool"?`all( ${e} )`:`${e}.${"xyz".slice(0,s)}`,this.format(e,this.getTypeFromLength(s,this.getComponentType(t)),r)):s===4&&i>1?`${this.getType(r)}( ${this.format(e,t,"vec3")}, 1.0 )`:i===2?`${this.getType(r)}( ${this.format(e,t,"vec2")}, 0.0 )`:(i===1&&s>1&&t!==this.getComponentType(r)&&(e=`${this.getType(this.getComponentType(r))}( ${e} )`),`${this.getType(r)}( ${e} )`)}getSignature(){return`// Three.js r${bl} - Node System
`}}class O0{constructor(){this.time=0,this.deltaTime=0,this.frameId=0,this.renderId=0,this.updateMap=new WeakMap,this.updateBeforeMap=new WeakMap,this.updateAfterMap=new WeakMap,this.renderer=null,this.material=null,this.camera=null,this.object=null,this.scene=null}_getMaps(e,t){let r=e.get(t);return r===void 0&&(r={renderId:0,frameId:0},e.set(t,r)),r}updateBeforeNode(e){const t=e.getUpdateBeforeType(),r=e.updateReference(this);if(t===_e.FRAME){const i=this._getMaps(this.updateBeforeMap,r);i.frameId!==this.frameId&&e.updateBefore(this)!==!1&&(i.frameId=this.frameId)}else if(t===_e.RENDER){const i=this._getMaps(this.updateBeforeMap,r);i.renderId!==this.renderId&&e.updateBefore(this)!==!1&&(i.renderId=this.renderId)}else t===_e.OBJECT&&e.updateBefore(this)}updateAfterNode(e){const t=e.getUpdateAfterType(),r=e.updateReference(this);if(t===_e.FRAME){const i=this._getMaps(this.updateAfterMap,r);i.frameId!==this.frameId&&e.updateAfter(this)!==!1&&(i.frameId=this.frameId)}else if(t===_e.RENDER){const i=this._getMaps(this.updateAfterMap,r);i.renderId!==this.renderId&&e.updateAfter(this)!==!1&&(i.renderId=this.renderId)}else t===_e.OBJECT&&e.updateAfter(this)}updateNode(e){const t=e.getUpdateType(),r=e.updateReference(this);if(t===_e.FRAME){const i=this._getMaps(this.updateMap,r);i.frameId!==this.frameId&&e.update(this)!==!1&&(i.frameId=this.frameId)}else if(t===_e.RENDER){const i=this._getMaps(this.updateMap,r);i.renderId!==this.renderId&&e.update(this)!==!1&&(i.renderId=this.renderId)}else t===_e.OBJECT&&e.update(this)}update(){this.frameId++,this.lastTime===void 0&&(this.lastTime=performance.now()),this.deltaTime=(performance.now()-this.lastTime)/1e3,this.lastTime=performance.now(),this.time+=this.deltaTime}}class gp{constructor(e,t,r=null,i="",s=!1){this.type=e,this.name=t,this.count=r,this.qualifier=i,this.isConst=s}}gp.isNodeFunctionInput=!0;class Q4 extends Bi{static get type(){return"DirectionalLightNode"}constructor(e=null){super(e)}setupDirect(){const e=this.colorNode;return{lightDirection:MT(this.light),lightColor:e}}}const Zu=new En,Qa=new En;let po=null;class Z4 extends Bi{static get type(){return"RectAreaLightNode"}constructor(e=null){super(e),this.halfHeight=pe(new le).setGroup(fe),this.halfWidth=pe(new le).setGroup(fe),this.updateType=_e.RENDER}update(e){super.update(e);const{light:t}=this,r=e.camera.matrixWorldInverse;Qa.identity(),Zu.copy(t.matrixWorld),Zu.premultiply(r),Qa.extractRotation(Zu),this.halfWidth.value.set(t.width*.5,0,0),this.halfHeight.value.set(0,t.height*.5,0),this.halfWidth.value.applyMatrix4(Qa),this.halfHeight.value.applyMatrix4(Qa)}setupDirectRectArea(e){let t,r;e.isAvailable("float32Filterable")?(t=Ae(po.LTC_FLOAT_1),r=Ae(po.LTC_FLOAT_2)):(t=Ae(po.LTC_HALF_1),r=Ae(po.LTC_HALF_2));const{colorNode:i,light:s}=this,o=CT(s);return{lightColor:i,lightPosition:o,halfWidth:this.halfWidth,halfHeight:this.halfHeight,ltc_1:t,ltc_2:r}}static setLTC(e){po=e}}class mp extends Bi{static get type(){return"SpotLightNode"}constructor(e=null){super(e),this.coneCosNode=pe(0).setGroup(fe),this.penumbraCosNode=pe(0).setGroup(fe),this.cutoffDistanceNode=pe(0).setGroup(fe),this.decayExponentNode=pe(0).setGroup(fe),this.colorNode=pe(this.color).setGroup(fe)}update(e){super.update(e);const{light:t}=this;this.coneCosNode.value=Math.cos(t.angle),this.penumbraCosNode.value=Math.cos(t.angle*(1-t.penumbra)),this.cutoffDistanceNode.value=t.distance,this.decayExponentNode.value=t.decay}getSpotAttenuation(e,t){const{coneCosNode:r,penumbraCosNode:i}=this;return Tr(r,i,t)}getLightCoord(e){const t=e.getNodeProperties(this);let r=t.projectionUV;return r===void 0&&(r=H5(this.light,e.context.positionWorld),t.projectionUV=r),r}setupDirect(e){const{colorNode:t,cutoffDistanceNode:r,decayExponentNode:i,light:s}=this,o=this.getLightVector(e),a=o.normalize(),c=a.dot(MT(s)),l=this.getSpotAttenuation(e,c),u=o.length(),d=FT({lightDistance:u,cutoffDistance:r,decayExponent:i});let h=t.mul(l).mul(d),f,p;return s.colorNode?(p=this.getLightCoord(e),f=s.colorNode(p)):s.map&&(p=this.getLightCoord(e),f=Ae(s.map,p.xy).onRenderUpdate(()=>s.map)),f&&(h=p.mul(2).sub(1).abs().lessThan(1).all().select(h.mul(f),h)),{lightColor:h,lightDirection:a}}}class J4 extends mp{static get type(){return"IESSpotLightNode"}getSpotAttenuation(e,t){const r=this.light.iesMap;let i=null;if(r&&r.isTexture===!0){const s=t.acos().mul(1/Math.PI);i=Ae(r,ne(s,0),0).r}else i=super.getSpotAttenuation(t);return i}}const eG=Q(([n,e])=>{const t=n.abs().sub(e);return xr(gt(t,0)).add(Rs(gt(t.x,t.y),0))});class tG extends mp{static get type(){return"ProjectorLightNode"}update(e){super.update(e);const t=this.light;if(this.penumbraCosNode.value=Math.min(Math.cos(t.angle*(1-t.penumbra)),.99999),t.aspect===null){let r=1;t.map!==null&&(r=t.map.width/t.map.height),t.shadow.aspect=r}else t.shadow.aspect=t.aspect}getSpotAttenuation(e){const t=j(0),r=this.penumbraCosNode,i=pp(this.light).mul(e.context.positionWorld||Ps);return qe(i.w.greaterThan(0),()=>{const s=i.xyz.div(i.w),o=eG(s.xy.sub(ne(.5)),ne(.5)),a=jn(-1,Dt(1,gv(r)).sub(1));t.assign(Sv(o.mul(-2).mul(a)))}),t}}class nG extends Bi{static get type(){return"AmbientLightNode"}constructor(e=null){super(e)}setup({context:e}){e.irradiance.addAssign(this.colorNode)}}class rG extends Bi{static get type(){return"HemisphereLightNode"}constructor(e=null){super(e),this.lightPositionNode=RT(e),this.lightDirectionNode=this.lightPositionNode.normalize(),this.groundColorNode=pe(new un).setGroup(fe)}update(e){const{light:t}=this;super.update(e),this.lightPositionNode.object3d=t,this.groundColorNode.value.copy(t.groundColor).multiplyScalar(t.intensity)}setup(e){const{colorNode:t,groundColorNode:r,lightDirectionNode:i}=this,o=$s.dot(i).mul(.5).add(.5),a=He(r,t,o);e.context.irradiance.addAssign(a)}}class iG extends Bi{static get type(){return"LightProbeNode"}constructor(e=null){super(e);const t=[];for(let r=0;r<9;r++)t.push(new le);this.lightProbe=bn(t)}update(e){const{light:t}=this;super.update(e);for(let r=0;r<9;r++)this.lightProbe.array[r].copy(t.sh.coefficients[r]).multiplyScalar(t.intensity)}setup(e){const t=S4($s,this.lightProbe);e.context.irradiance.addAssign(t)}}class LT{parseFunction(){se("Abstract function.")}}class xp{constructor(e,t,r="",i=""){this.type=e,this.inputs=t,this.name=r,this.precision=i}getCode(){se("Abstract function.")}}xp.isNodeFunction=!0;const sG=/^\s*(highp|mediump|lowp)?\s*([a-z_0-9]+)\s*([a-z_0-9]+)?\s*\(([\s\S]*?)\)/i,oG=/[a-z_0-9]+/ig,U0="#pragma main",aG=n=>{n=n.trim();const e=n.indexOf(U0),t=e!==-1?n.slice(e+U0.length):n,r=t.match(sG);if(r!==null&&r.length===5){const i=r[4],s=[];let o=null;for(;(o=oG.exec(i))!==null;)s.push(o);const a=[];let c=0;for(;c<s.length;){const p=s[c][0]==="const";p===!0&&c++;let g=s[c][0];g==="in"||g==="out"||g==="inout"?c++:g="";const x=s[c++][0];let m=Number.parseInt(s[c][0]);Number.isNaN(m)===!1?c++:m=null;const y=s[c++][0];a.push(new gp(x,y,m,g,p))}const l=t.substring(r[0].length),u=r[3]!==void 0?r[3]:"",d=r[2],h=r[1]!==void 0?r[1]:"",f=e!==-1?n.slice(0,e):"";return{type:d,inputs:a,name:u,precision:h,inputsCode:i,blockCode:l,headerCode:f}}else throw new Error("FunctionNode: Function is not a GLSL code.")};class cG extends xp{constructor(e){const{type:t,inputs:r,name:i,precision:s,inputsCode:o,blockCode:a,headerCode:c}=aG(e);super(t,r,i,s),this.inputsCode=o,this.blockCode=a,this.headerCode=c}getCode(e=this.name){let t;const r=this.blockCode;if(r!==""){const{type:i,inputsCode:s,headerCode:o,precision:a}=this;let c=`${i} ${e} ( ${s.trim()} )`;a!==""&&(c=`${a} ${c}`),t=o+c+r}else t="";return t}}class lG extends LT{parseFunction(e){return new cG(e)}}const G0=new WeakMap,Bn=[],Nr=[];class uG extends Wr{constructor(e,t){super(),this.renderer=e,this.backend=t,this.nodeFrame=new O0,this.nodeBuilderCache=new Map,this.callHashCache=new Nn,this.groupsData=new Nn,this.cacheLib={}}updateGroup(e){const t=e.groupNode,r=t.name;if(r===uv.name)return!0;if(r===fe.name){const s=this.get(e),o=this.nodeFrame.renderId;return s.renderId!==o?(s.renderId=o,!0):!1}if(r===kF.name){const s=this.get(e),o=this.nodeFrame.frameId;return s.frameId!==o?(s.frameId=o,!0):!1}Bn[0]=t,Bn[1]=e;let i=this.groupsData.get(Bn);return i===void 0&&this.groupsData.set(Bn,i={}),Bn.length=0,i.version!==t.version?(i.version=t.version,!0):!1}getForRenderCacheKey(e){return e.initialCacheKey}getForRender(e){const t=this.get(e);let r=t.nodeBuilderState;if(r===void 0){const{nodeBuilderCache:i}=this,s=this.getForRenderCacheKey(e);if(r=i.get(s),r===void 0){const o=c=>{const l=this.backend.createNodeBuilder(e.object,this.renderer);return l.scene=e.scene,l.material=c,l.camera=e.camera,l.context.material=c,l.lightsNode=e.lightsNode,l.environmentNode=this.getEnvironmentNode(e.scene),l.fogNode=this.getFogNode(e.scene),l.clippingContext=e.clippingContext,this.renderer.getOutputRenderTarget()&&this.renderer.getOutputRenderTarget().multiview&&l.enableMultiview(),l};let a=o(e.material);try{a.build()}catch(c){a=o(new at),a.build(),ie("TSL: "+c)}r=this._createNodeBuilderState(a),i.set(s,r)}r.usedTimes++,t.nodeBuilderState=r}return r}delete(e){if(e.isRenderObject){const t=this.get(e).nodeBuilderState;t.usedTimes--,t.usedTimes===0&&this.nodeBuilderCache.delete(this.getForRenderCacheKey(e))}return super.delete(e)}getForCompute(e){const t=this.get(e);let r=t.nodeBuilderState;if(r===void 0){const i=this.backend.createNodeBuilder(e,this.renderer);i.build(),r=this._createNodeBuilderState(i),t.nodeBuilderState=r}return r}_createNodeBuilderState(e){return new A4(e.vertexShader,e.fragmentShader,e.computeShader,e.getAttributesArray(),e.getBindings(),e.updateNodes,e.updateBeforeNodes,e.updateAfterNodes,e.observer,e.transforms)}getEnvironmentNode(e){this.updateEnvironment(e);let t=null;if(e.environmentNode&&e.environmentNode.isNode)t=e.environmentNode;else{const r=this.get(e);r.environmentNode&&(t=r.environmentNode)}return t}getBackgroundNode(e){this.updateBackground(e);let t=null;if(e.backgroundNode&&e.backgroundNode.isNode)t=e.backgroundNode;else{const r=this.get(e);r.backgroundNode&&(t=r.backgroundNode)}return t}getFogNode(e){return this.updateFog(e),e.fogNode||this.get(e).fogNode||null}getCacheKey(e,t){Bn[0]=e,Bn[1]=t;const r=this.renderer.info.calls,i=this.callHashCache.get(Bn)||{};if(i.callId!==r){const s=this.getEnvironmentNode(e),o=this.getFogNode(e);t&&Nr.push(t.getCacheKey(!0)),s&&Nr.push(s.getCacheKey()),o&&Nr.push(o.getCacheKey()),Nr.push(this.renderer.getOutputRenderTarget()&&this.renderer.getOutputRenderTarget().multiview?1:0),Nr.push(this.renderer.shadowMap.enabled?1:0),Nr.push(this.renderer.shadowMap.type),i.callId=r,i.cacheKey=ha(Nr),this.callHashCache.set(Bn,i),Nr.length=0}return Bn.length=0,i.cacheKey}get isToneMappingState(){return!this.renderer.getRenderTarget()}updateBackground(e){const t=this.get(e),r=e.background;if(r){const i=e.backgroundBlurriness===0&&t.backgroundBlurriness>0||e.backgroundBlurriness>0&&t.backgroundBlurriness===0;if(t.background!==r||i){const s=this.getCacheNode("background",r,()=>{if(r.isCubeTexture===!0||r.mapping===of||r.mapping===af||r.mapping===Nd){if(e.backgroundBlurriness>0||r.mapping===Nd)return _T(r);{let o;return r.isCubeTexture===!0?o=Jo(r):o=Ae(r),dT(o)}}else{if(r.isTexture===!0)return Ae(r,ys.flipY()).setUpdateMatrix(!0);r.isColor!==!0&&ie("WebGPUNodes: Unsupported background configuration.",r)}},i);t.backgroundNode=s,t.background=r,t.backgroundBlurriness=e.backgroundBlurriness}}else t.backgroundNode&&(delete t.backgroundNode,delete t.background)}getCacheNode(e,t,r,i=!1){const s=this.cacheLib[e]||(this.cacheLib[e]=new WeakMap);let o=s.get(t);return(o===void 0||i)&&(o=r(),s.set(t,o)),o}updateFog(e){const t=this.get(e),r=e.fog;if(r){if(t.fog!==r){const i=this.getCacheNode("fog",r,()=>{if(r.isFogExp2){const s=Oe("color","color",r).setGroup(fe),o=Oe("density","float",r).setGroup(fe);return D0(s,z5(o))}else if(r.isFog){const s=Oe("color","color",r).setGroup(fe),o=Oe("near","float",r).setGroup(fe),a=Oe("far","float",r).setGroup(fe);return D0(s,V5(o,a))}else ie("Renderer: Unsupported fog configuration.",r)});t.fogNode=i,t.fog=r}}else delete t.fogNode,delete t.fog}updateEnvironment(e){const t=this.get(e),r=e.environment;if(r){if(t.environment!==r){const i=this.getCacheNode("environment",r,()=>{if(r.isCubeTexture===!0)return Jo(r);if(r.isTexture===!0)return Ae(r);ie("Nodes: Unsupported environment configuration.",r)});t.environmentNode=i,t.environment=r}}else t.environmentNode&&(delete t.environmentNode,delete t.environment)}getNodeFrame(e=this.renderer,t=null,r=null,i=null,s=null){const o=this.nodeFrame;return o.renderer=e,o.scene=t,o.object=r,o.camera=i,o.material=s,o}getNodeFrameForRender(e){return this.getNodeFrame(e.renderer,e.scene,e.object,e.camera,e.material)}getOutputCacheKey(){const e=this.renderer;return e.toneMapping+","+e.currentColorSpace+","+e.xr.isPresenting}hasOutputChange(e){return G0.get(e)!==this.getOutputCacheKey()}getOutputNode(e){const t=this.renderer,r=this.getOutputCacheKey(),i=e.isArrayTexture?C5(e,X(ys,ga("gl_ViewID_OVR"))).renderOutput(t.toneMapping,t.currentColorSpace):Ae(e,ys).renderOutput(t.toneMapping,t.currentColorSpace);return G0.set(e,r),i}updateBefore(e){const t=e.getNodeBuilderState();for(const r of t.updateBeforeNodes)this.getNodeFrameForRender(e).updateBeforeNode(r)}updateAfter(e){const t=e.getNodeBuilderState();for(const r of t.updateAfterNodes)this.getNodeFrameForRender(e).updateAfterNode(r)}updateForCompute(e){const t=this.getNodeFrame(),r=this.getForCompute(e);for(const i of r.updateNodes)t.updateNode(i)}updateForRender(e){const t=this.getNodeFrameForRender(e),r=e.getNodeBuilderState();for(const i of r.updateNodes)t.updateNode(i)}needsRefresh(e){const t=this.getNodeFrameForRender(e);return e.getMonitor().needsRefresh(e,t)}dispose(){super.dispose(),this.nodeFrame=new O0,this.nodeBuilderCache=new Map,this.cacheLib={}}}const Ju=new xl;class dl{constructor(e=null){this.version=0,this.clipIntersection=null,this.cacheKey="",this.shadowPass=!1,this.viewNormalMatrix=new oa,this.clippingGroupContexts=new WeakMap,this.intersectionPlanes=[],this.unionPlanes=[],this.parentVersion=null,e!==null&&(this.viewNormalMatrix=e.viewNormalMatrix,this.clippingGroupContexts=e.clippingGroupContexts,this.shadowPass=e.shadowPass,this.viewMatrix=e.viewMatrix)}projectPlanes(e,t,r){const i=e.length;for(let s=0;s<i;s++){Ju.copy(e[s]).applyMatrix4(this.viewMatrix,this.viewNormalMatrix);const o=t[r+s],a=Ju.normal;o.x=-a.x,o.y=-a.y,o.z=-a.z,o.w=Ju.constant}}updateGlobal(e,t){this.shadowPass=e.overrideMaterial!==null&&e.overrideMaterial.isShadowPassMaterial,this.viewMatrix=t.matrixWorldInverse,this.viewNormalMatrix.getNormalMatrix(this.viewMatrix)}update(e,t){let r=!1;e.version!==this.parentVersion&&(this.intersectionPlanes=Array.from(e.intersectionPlanes),this.unionPlanes=Array.from(e.unionPlanes),this.parentVersion=e.version),this.clipIntersection!==t.clipIntersection&&(this.clipIntersection=t.clipIntersection,this.clipIntersection?this.unionPlanes.length=e.unionPlanes.length:this.intersectionPlanes.length=e.intersectionPlanes.length);const i=t.clippingPlanes,s=i.length;let o,a;if(this.clipIntersection?(o=this.intersectionPlanes,a=e.intersectionPlanes.length):(o=this.unionPlanes,a=e.unionPlanes.length),o.length!==a+s){o.length=a+s;for(let c=0;c<s;c++)o[a+c]=new Ze;r=!0}this.projectPlanes(i,o,a),r&&(this.version++,this.cacheKey=`${this.intersectionPlanes.length}:${this.unionPlanes.length}`)}getGroupContext(e){if(this.shadowPass&&!e.clipShadows)return this;let t=this.clippingGroupContexts.get(e);return t===void 0&&(t=new dl(this),this.clippingGroupContexts.set(e,t)),t.update(this,e),t}get unionClippingCount(){return this.unionPlanes.length}}class dG{constructor(e,t){this.bundleGroup=e,this.camera=t}}const go=[];class hG{constructor(){this.bundles=new Nn}get(e,t){const r=this.bundles;go[0]=e,go[1]=t;let i=r.get(go);return i===void 0&&(i=new dG(e,t),r.set(go,i)),go.length=0,i}dispose(){this.bundles=new Nn}}class OT{constructor(){this.lightNodes=new WeakMap,this.materialNodes=new Map,this.toneMappingNodes=new Map}fromMaterial(e){if(e.isNodeMaterial)return e;let t=null;const r=this.getMaterialNodeClass(e.type);if(r!==null){t=new r;for(const i in e)t[i]=e[i]}return t}addToneMapping(e,t){this.addType(e,t,this.toneMappingNodes)}getToneMappingFunction(e){return this.toneMappingNodes.get(e)||null}getMaterialNodeClass(e){return this.materialNodes.get(e)||null}addMaterial(e,t){this.addType(e,t,this.materialNodes)}getLightNodeClass(e){return this.lightNodes.get(e)||null}addLight(e,t){this.addClass(e,t,this.lightNodes)}addType(e,t,r){if(r.has(t)){se(`Redefinition of node ${t}`);return}if(typeof e!="function")throw new Error(`Node class ${e.name} is not a class.`);if(typeof t=="function"||typeof t=="object")throw new Error(`Base class ${t} is not a class.`);r.set(t,e)}addClass(e,t,r){if(r.has(t)){se(`Redefinition of node ${t.name}`);return}if(typeof e!="function")throw new Error(`Node class ${e.name} is not a class.`);if(typeof t!="function")throw new Error(`Base class ${t.name} is not a class.`);r.set(t,e)}}const fG=new PT,mo=[];class pG extends Nn{constructor(){super()}createNode(e=[]){return new PT().setLights(e)}getNode(e,t){if(e.isQuadMesh)return fG;mo[0]=e,mo[1]=t;let r=this.get(mo);return r===void 0&&(r=this.createNode(),this.set(mo,r)),mo.length=0,r}}class No extends Is{constructor(e=1,t=1,r={}){super(e,t,r),this.isXRRenderTarget=!0,this._hasExternalTextures=!1,this._autoAllocateDepthBuffer=!0,this._isOpaqueFramebuffer=!1}copy(e){return super.copy(e),this._hasExternalTextures=e._hasExternalTextures,this._autoAllocateDepthBuffer=e._autoAllocateDepthBuffer,this._isOpaqueFramebuffer=e._isOpaqueFramebuffer,this}}const $0=new le,V0=new le;class gG extends rf{constructor(e,t=!1){super(),this.enabled=!1,this.isPresenting=!1,this.cameraAutoUpdate=!0,this._renderer=e,this._cameraL=new Go,this._cameraL.viewport=new Ze,this._cameraR=new Go,this._cameraR.viewport=new Ze,this._cameras=[this._cameraL,this._cameraR],this._cameraXR=new Rw,this._currentDepthNear=null,this._currentDepthFar=null,this._controllers=[],this._controllerInputSources=[],this._xrRenderTarget=null,this._layers=[],this._sessionUsesLayers=!1,this._supportsGlBinding=typeof XRWebGLBinding<"u",this._frameBufferTargets=null,this._createXRLayer=vG.bind(this),this._gl=null,this._currentAnimationContext=null,this._currentAnimationLoop=null,this._currentPixelRatio=null,this._currentSize=new Te,this._onSessionEvent=yG.bind(this),this._onSessionEnd=bG.bind(this),this._onInputSourcesChange=_G.bind(this),this._onAnimationFrame=TG.bind(this),this._referenceSpace=null,this._referenceSpaceType="local-floor",this._customReferenceSpace=null,this._framebufferScaleFactor=1,this._foveation=1,this._session=null,this._glBaseLayer=null,this._glBinding=null,this._glProjLayer=null,this._xrFrame=null,this._supportsLayers=this._supportsGlBinding&&"createProjectionLayer"in XRWebGLBinding.prototype,this._useMultiviewIfPossible=t,this._useMultiview=!1}getController(e){return this._getController(e).getTargetRaySpace()}getControllerGrip(e){return this._getController(e).getGripSpace()}getHand(e){return this._getController(e).getHandSpace()}getFoveation(){if(!(this._glProjLayer===null&&this._glBaseLayer===null))return this._foveation}setFoveation(e){this._foveation=e,this._glProjLayer!==null&&(this._glProjLayer.fixedFoveation=e),this._glBaseLayer!==null&&this._glBaseLayer.fixedFoveation!==void 0&&(this._glBaseLayer.fixedFoveation=e)}getFramebufferScaleFactor(){return this._framebufferScaleFactor}setFramebufferScaleFactor(e){this._framebufferScaleFactor=e,this.isPresenting===!0&&se("XRManager: Cannot change framebuffer scale while presenting.")}getReferenceSpaceType(){return this._referenceSpaceType}setReferenceSpaceType(e){this._referenceSpaceType=e,this.isPresenting===!0&&se("XRManager: Cannot change reference space type while presenting.")}getReferenceSpace(){return this._customReferenceSpace||this._referenceSpace}setReferenceSpace(e){this._customReferenceSpace=e}getCamera(){return this._cameraXR}getEnvironmentBlendMode(){if(this._session!==null)return this._session.environmentBlendMode}getBinding(){return this._glBinding===null&&this._supportsGlBinding&&(this._glBinding=new XRWebGLBinding(this._session,this._gl)),this._glBinding}getFrame(){return this._xrFrame}useMultiview(){return this._useMultiview}createQuadLayer(e,t,r,i,s,o,a,c={}){const l=new Cw(e,t),u=new No(s,o,{format:_n,type:Qt,depthTexture:new $n(s,o,c.stencil?Lr:dt,void 0,void 0,void 0,void 0,void 0,void 0,c.stencil?Or:Ur),stencilBuffer:c.stencil,resolveDepthBuffer:!1,resolveStencilBuffer:!1});u._autoAllocateDepthBuffer=!0;const d=new Mr({color:16777215,side:Ao});d.map=u.texture,d.map.offset.y=1,d.map.repeat.y=-1;const h=new wn(l,d);h.position.copy(r),h.quaternion.copy(i);const f={type:"quad",width:e,height:t,translation:r,quaternion:i,pixelwidth:s,pixelheight:o,plane:h,material:d,rendercall:a,renderTarget:u};if(this._layers.push(f),this._session!==null){f.plane.material=new Mr({color:16777215,side:Ao}),f.plane.material.blending=Ro,f.plane.material.blendEquation=ar,f.plane.material.blendSrc=Rr,f.plane.material.blendDst=Rr,f.xrlayer=this._createXRLayer(f);const p=this._session.renderState.layers;p.unshift(f.xrlayer),this._session.updateRenderState({layers:p})}else u.isXRRenderTarget=!1;return h}createCylinderLayer(e,t,r,i,s,o,a,c,l={}){const u=new Hx(e,e,e*t/r,64,64,!0,Math.PI-t/2,t),d=new No(o,a,{format:_n,type:Qt,depthTexture:new $n(o,a,l.stencil?Lr:dt,void 0,void 0,void 0,void 0,void 0,void 0,l.stencil?Or:Ur),stencilBuffer:l.stencil,resolveDepthBuffer:!1,resolveStencilBuffer:!1});d._autoAllocateDepthBuffer=!0;const h=new Mr({color:16777215,side:jt});h.map=d.texture,h.map.offset.y=1,h.map.repeat.y=-1;const f=new wn(u,h);f.position.copy(i),f.quaternion.copy(s);const p={type:"cylinder",radius:e,centralAngle:t,aspectratio:r,translation:i,quaternion:s,pixelwidth:o,pixelheight:a,plane:f,material:h,rendercall:c,renderTarget:d};if(this._layers.push(p),this._session!==null){p.plane.material=new Mr({color:16777215,side:jt}),p.plane.material.blending=Ro,p.plane.material.blendEquation=ar,p.plane.material.blendSrc=Rr,p.plane.material.blendDst=Rr,p.xrlayer=this._createXRLayer(p);const g=this._session.renderState.layers;g.unshift(p.xrlayer),this._session.updateRenderState({layers:g})}else d.isXRRenderTarget=!1;return f}renderLayers(){const e=new le,t=new bs,r=this._renderer,i=this.isPresenting,s=r.getOutputRenderTarget(),o=r._frameBufferTarget;this.isPresenting=!1;const a=new Te;r.getSize(a);const c=r._quad;for(const l of this._layers)if(l.renderTarget.isXRRenderTarget=this._session!==null,l.renderTarget._hasExternalTextures=l.renderTarget.isXRRenderTarget,l.renderTarget.isXRRenderTarget&&this._sessionUsesLayers){l.xrlayer.transform=new XRRigidTransform(l.plane.getWorldPosition(e),l.plane.getWorldQuaternion(t));const u=this._glBinding.getSubImage(l.xrlayer,this._xrFrame);r.backend.setXRRenderTargetTextures(l.renderTarget,u.colorTexture,void 0),r._setXRLayerSize(l.renderTarget.width,l.renderTarget.height),r.setOutputRenderTarget(l.renderTarget),r.setRenderTarget(null),r._frameBufferTarget=null,this._frameBufferTargets||(this._frameBufferTargets=new WeakMap);const{frameBufferTarget:d,quad:h}=this._frameBufferTargets.get(l.renderTarget)||{frameBufferTarget:null,quad:null};d?(r._frameBufferTarget=d,r._quad=h):(r._quad=new fp(new at),this._frameBufferTargets.set(l.renderTarget,{frameBufferTarget:r._getFrameBufferTarget(),quad:r._quad})),l.rendercall(),r._frameBufferTarget=null}else r.setRenderTarget(l.renderTarget),l.rendercall();r.setRenderTarget(null),r.setOutputRenderTarget(s),r._frameBufferTarget=o,r._setXRLayerSize(a.x,a.y),r._quad=c,this.isPresenting=i}getSession(){return this._session}async setSession(e){const t=this._renderer,r=t.backend;this._gl=t.getContext();const i=this._gl,s=i.getContextAttributes();if(this._session=e,e!==null){if(r.isWebGPUBackend===!0)throw new Error('THREE.XRManager: XR is currently not supported with a WebGPU backend. Use WebGL by passing "{ forceWebGL: true }" to the constructor of the renderer.');if(e.addEventListener("select",this._onSessionEvent),e.addEventListener("selectstart",this._onSessionEvent),e.addEventListener("selectend",this._onSessionEvent),e.addEventListener("squeeze",this._onSessionEvent),e.addEventListener("squeezestart",this._onSessionEvent),e.addEventListener("squeezeend",this._onSessionEvent),e.addEventListener("end",this._onSessionEnd),e.addEventListener("inputsourceschange",this._onInputSourcesChange),await r.makeXRCompatible(),this._currentPixelRatio=t.getPixelRatio(),t.getSize(this._currentSize),this._currentAnimationContext=t._animation.getContext(),this._currentAnimationLoop=t._animation.getAnimationLoop(),t._animation.stop(),this._supportsLayers===!0){let o=null,a=null,c=null;t.depth&&(c=t.stencil?i.DEPTH24_STENCIL8:i.DEPTH_COMPONENT24,o=t.stencil?Or:Ur,a=t.stencil?Lr:dt);const l={colorFormat:i.RGBA8,depthFormat:c,scaleFactor:this._framebufferScaleFactor,clearOnAccess:!1};this._useMultiviewIfPossible&&t.hasFeature("OVR_multiview2")&&(l.textureType="texture-array",this._useMultiview=!0),this._glBinding=this.getBinding();const u=this._glBinding.createProjectionLayer(l),d=[u];this._glProjLayer=u,t.setPixelRatio(1),t._setXRLayerSize(u.textureWidth,u.textureHeight);const h=this._useMultiview?2:1,f=new $n(u.textureWidth,u.textureHeight,a,void 0,void 0,void 0,void 0,void 0,void 0,o,h);if(this._xrRenderTarget=new No(u.textureWidth,u.textureHeight,{format:_n,type:Qt,colorSpace:t.outputColorSpace,depthTexture:f,stencilBuffer:t.stencil,samples:s.antialias?4:0,resolveDepthBuffer:u.ignoreDepthValues===!1,resolveStencilBuffer:u.ignoreDepthValues===!1,depth:this._useMultiview?2:1,multiview:this._useMultiview}),this._xrRenderTarget._hasExternalTextures=!0,this._xrRenderTarget.depth=this._useMultiview?2:1,this._sessionUsesLayers=e.enabledFeatures.includes("layers"),this._referenceSpace=await e.requestReferenceSpace(this.getReferenceSpaceType()),this._sessionUsesLayers)for(const p of this._layers)p.plane.material=new Mr({color:16777215,side:p.type==="cylinder"?jt:Ao}),p.plane.material.blending=Ro,p.plane.material.blendEquation=ar,p.plane.material.blendSrc=Rr,p.plane.material.blendDst=Rr,p.xrlayer=this._createXRLayer(p),d.unshift(p.xrlayer);e.updateRenderState({layers:d})}else{const o={antialias:t.currentSamples>0,alpha:!0,depth:t.depth,stencil:t.stencil,framebufferScaleFactor:this.getFramebufferScaleFactor()},a=new XRWebGLLayer(e,i,o);this._glBaseLayer=a,e.updateRenderState({baseLayer:a}),t.setPixelRatio(1),t._setXRLayerSize(a.framebufferWidth,a.framebufferHeight),this._xrRenderTarget=new No(a.framebufferWidth,a.framebufferHeight,{format:_n,type:Qt,colorSpace:t.outputColorSpace,stencilBuffer:t.stencil,resolveDepthBuffer:a.ignoreDepthValues===!1,resolveStencilBuffer:a.ignoreDepthValues===!1}),this._xrRenderTarget._isOpaqueFramebuffer=!0,this._referenceSpace=await e.requestReferenceSpace(this.getReferenceSpaceType())}this.setFoveation(this.getFoveation()),t._animation.setAnimationLoop(this._onAnimationFrame),t._animation.setContext(e),t._animation.start(),this.isPresenting=!0,this.dispatchEvent({type:"sessionstart"})}}updateCamera(e){const t=this._session;if(t===null)return;const r=e.near,i=e.far,s=this._cameraXR,o=this._cameraL,a=this._cameraR;s.near=a.near=o.near=r,s.far=a.far=o.far=i,s.isMultiViewCamera=this._useMultiview,(this._currentDepthNear!==s.near||this._currentDepthFar!==s.far)&&(t.updateRenderState({depthNear:s.near,depthFar:s.far}),this._currentDepthNear=s.near,this._currentDepthFar=s.far),s.layers.mask=e.layers.mask|6,o.layers.mask=s.layers.mask&3,a.layers.mask=s.layers.mask&5;const c=e.parent,l=s.cameras;z0(s,c);for(let u=0;u<l.length;u++)z0(l[u],c);l.length===2?mG(s,o,a):s.projectionMatrix.copy(o.projectionMatrix),xG(e,s,c)}_getController(e){let t=this._controllers[e];return t===void 0&&(t=new Mw,this._controllers[e]=t),t}}function mG(n,e,t){$0.setFromMatrixPosition(e.matrixWorld),V0.setFromMatrixPosition(t.matrixWorld);const r=$0.distanceTo(V0),i=e.projectionMatrix.elements,s=t.projectionMatrix.elements,o=i[14]/(i[10]-1),a=i[14]/(i[10]+1),c=(i[9]+1)/i[5],l=(i[9]-1)/i[5],u=(i[8]-1)/i[0],d=(s[8]+1)/s[0],h=o*u,f=o*d,p=r/(-u+d),g=p*-u;if(e.matrixWorld.decompose(n.position,n.quaternion,n.scale),n.translateX(g),n.translateZ(p),n.matrixWorld.compose(n.position,n.quaternion,n.scale),n.matrixWorldInverse.copy(n.matrixWorld).invert(),i[10]===-1)n.projectionMatrix.copy(e.projectionMatrix),n.projectionMatrixInverse.copy(e.projectionMatrixInverse);else{const x=o+p,m=a+p,y=h-g,_=f+(r-g),v=c*a/m*x,T=l*a/m*x;n.projectionMatrix.makePerspective(y,_,v,T,x,m),n.projectionMatrixInverse.copy(n.projectionMatrix).invert()}}function z0(n,e){e===null?n.matrixWorld.copy(n.matrix):n.matrixWorld.multiplyMatrices(e.matrixWorld,n.matrix),n.matrixWorldInverse.copy(n.matrixWorld).invert()}function xG(n,e,t){t===null?n.matrix.copy(e.matrixWorld):(n.matrix.copy(t.matrixWorld),n.matrix.invert(),n.matrix.multiply(e.matrixWorld)),n.matrix.decompose(n.position,n.quaternion,n.scale),n.updateMatrixWorld(!0),n.projectionMatrix.copy(e.projectionMatrix),n.projectionMatrixInverse.copy(e.projectionMatrixInverse),n.isPerspectiveCamera&&(n.fov=Kw*2*Math.atan(1/n.projectionMatrix.elements[5]),n.zoom=1)}function yG(n){const e=this._controllerInputSources.indexOf(n.inputSource);if(e===-1)return;const t=this._controllers[e];if(t!==void 0){const r=this.getReferenceSpace();t.update(n.inputSource,n.frame,r),t.dispatchEvent({type:n.type,data:n.inputSource})}}function bG(){const n=this._session,e=this._renderer;n.removeEventListener("select",this._onSessionEvent),n.removeEventListener("selectstart",this._onSessionEvent),n.removeEventListener("selectend",this._onSessionEvent),n.removeEventListener("squeeze",this._onSessionEvent),n.removeEventListener("squeezestart",this._onSessionEvent),n.removeEventListener("squeezeend",this._onSessionEvent),n.removeEventListener("end",this._onSessionEnd),n.removeEventListener("inputsourceschange",this._onInputSourcesChange);for(let t=0;t<this._controllers.length;t++){const r=this._controllerInputSources[t];r!==null&&(this._controllerInputSources[t]=null,this._controllers[t].disconnect(r))}if(this._currentDepthNear=null,this._currentDepthFar=null,e._resetXRState(),this._session=null,this._xrRenderTarget=null,this._glBinding=null,this._glBaseLayer=null,this._glProjLayer=null,this._sessionUsesLayers===!0)for(const t of this._layers)t.renderTarget=new No(t.pixelwidth,t.pixelheight,{format:_n,type:Qt,depthTexture:new $n(t.pixelwidth,t.pixelheight,t.stencilBuffer?Lr:dt,void 0,void 0,void 0,void 0,void 0,void 0,t.stencilBuffer?Or:Ur),stencilBuffer:t.stencilBuffer,resolveDepthBuffer:!1,resolveStencilBuffer:!1}),t.renderTarget.isXRRenderTarget=!1,t.plane.material=t.material,t.material.map=t.renderTarget.texture,t.material.map.offset.y=1,t.material.map.repeat.y=-1,delete t.xrlayer;this.isPresenting=!1,this._useMultiview=!1,e._animation.stop(),e._animation.setAnimationLoop(this._currentAnimationLoop),e._animation.setContext(this._currentAnimationContext),e._animation.start(),e.setPixelRatio(this._currentPixelRatio),e.setSize(this._currentSize.width,this._currentSize.height,!1),this.dispatchEvent({type:"sessionend"})}function _G(n){const e=this._controllers,t=this._controllerInputSources;for(let r=0;r<n.removed.length;r++){const i=n.removed[r],s=t.indexOf(i);s>=0&&(t[s]=null,e[s].disconnect(i))}for(let r=0;r<n.added.length;r++){const i=n.added[r];let s=t.indexOf(i);if(s===-1){for(let a=0;a<e.length;a++)if(a>=t.length){t.push(i),s=a;break}else if(t[a]===null){t[a]=i,s=a;break}if(s===-1)break}const o=e[s];o&&o.connect(i)}}function vG(n){return n.type==="quad"?this._glBinding.createQuadLayer({transform:new XRRigidTransform(n.translation,n.quaternion),width:n.width/2,height:n.height/2,space:this._referenceSpace,viewPixelWidth:n.pixelwidth,viewPixelHeight:n.pixelheight,clearOnAccess:!1}):this._glBinding.createCylinderLayer({transform:new XRRigidTransform(n.translation,n.quaternion),radius:n.radius,centralAngle:n.centralAngle,aspectRatio:n.aspectRatio,space:this._referenceSpace,viewPixelWidth:n.pixelwidth,viewPixelHeight:n.pixelheight,clearOnAccess:!1})}function TG(n,e){if(e===void 0)return;const t=this._cameraXR,r=this._renderer,i=r.backend,s=this._glBaseLayer,o=this.getReferenceSpace(),a=e.getViewerPose(o);if(this._xrFrame=e,a!==null){const c=a.views;this._glBaseLayer!==null&&i.setXRTarget(s.framebuffer);let l=!1;c.length!==t.cameras.length&&(t.cameras.length=0,l=!0);for(let u=0;u<c.length;u++){const d=c[u];let h;if(this._supportsLayers===!0){const p=this._glBinding.getViewSubImage(this._glProjLayer,d);h=p.viewport,u===0&&i.setXRRenderTargetTextures(this._xrRenderTarget,p.colorTexture,this._glProjLayer.ignoreDepthValues&&!this._useMultiview?void 0:p.depthStencilTexture)}else h=s.getViewport(d);let f=this._cameras[u];f===void 0&&(f=new Go,f.layers.enable(u),f.viewport=new Ze,this._cameras[u]=f),f.matrix.fromArray(d.transform.matrix),f.matrix.decompose(f.position,f.quaternion,f.scale),f.projectionMatrix.fromArray(d.projectionMatrix),f.projectionMatrixInverse.copy(f.projectionMatrix).invert(),f.viewport.set(h.x,h.y,h.width,h.height),u===0&&(t.matrix.copy(f.matrix),t.matrix.decompose(t.position,t.quaternion,t.scale)),l===!0&&t.cameras.push(f)}r.setOutputRenderTarget(this._xrRenderTarget)}for(let c=0;c<this._controllers.length;c++){const l=this._controllerInputSources[c],u=this._controllers[c];l!==null&&u!==void 0&&u.update(l,e,o)}this._currentAnimationLoop&&this._currentAnimationLoop(n,e),e.detectedPlanes&&this.dispatchEvent({type:"planesdetected",data:e}),this._xrFrame=null}class wG extends rf{constructor(e){super(),this.domElement=e,this._pixelRatio=1,this._width=this.domElement.width,this._height=this.domElement.height,this._viewport=new Ze(0,0,this._width,this._height),this._scissor=new Ze(0,0,this._width,this._height),this._scissorTest=!1,this.colorTexture=new Kx,this.depthTexture=new $n}getPixelRatio(){return this._pixelRatio}getDrawingBufferSize(e){return e.set(this._width*this._pixelRatio,this._height*this._pixelRatio).floor()}getSize(e){return e.set(this._width,this._height)}setPixelRatio(e=1){this._pixelRatio!==e&&(this._pixelRatio=e,this.setSize(this._width,this._height,!1))}setDrawingBufferSize(e,t,r){this.xr&&this.xr.isPresenting||(this._width=e,this._height=t,this._pixelRatio=r,this.domElement.width=Math.floor(e*r),this.domElement.height=Math.floor(t*r),this.setViewport(0,0,e,t),this._dispatchResize())}setSize(e,t,r=!0){this.xr&&this.xr.isPresenting||(this._width=e,this._height=t,this.domElement.width=Math.floor(e*this._pixelRatio),this.domElement.height=Math.floor(t*this._pixelRatio),r===!0&&(this.domElement.style.width=e+"px",this.domElement.style.height=t+"px"),this.setViewport(0,0,e,t),this._dispatchResize())}getScissor(e){const t=this._scissor;return e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,e}setScissor(e,t,r,i){const s=this._scissor;e.isVector4?s.copy(e):s.set(e,t,r,i)}getScissorTest(){return this._scissorTest}setScissorTest(e){this._scissorTest=e}getViewport(e){return e.copy(this._viewport)}setViewport(e,t,r,i,s=0,o=1){const a=this._viewport;e.isVector4?a.copy(e):a.set(e,t,r,i),a.minDepth=s,a.maxDepth=o}_dispatchResize(){this.dispatchEvent({type:"resize"})}dispose(){this.dispatchEvent({type:"dispose"})}}const j0=new yl,Zi=new Te,ed=new Ze,td=new xw,nd=new mw,Za=new En,nr=new Ze;class SG{constructor(e,t={}){this.isRenderer=!0;const{logarithmicDepthBuffer:r=!1,alpha:i=!0,depth:s=!0,stencil:o=!1,antialias:a=!1,samples:c=0,getFallback:l=null,colorBufferType:u=Ft,multiview:d=!1}=t;this.backend=e,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.alpha=i,this.logarithmicDepthBuffer=r,this.outputColorSpace=tf,this.toneMapping=xi,this.toneMappingExposure=1,this.sortObjects=!0,this.depth=s,this.stencil=o,this.info=new i5,this.overrideNodes={modelViewMatrix:null,modelNormalViewMatrix:null},this.library=new OT,this.lighting=new pG,this._samples=c||a===!0?4:0,this._onCanvasTargetResize=this._onCanvasTargetResize.bind(this),this._canvasTarget=new wG(e.getDomElement()),this._canvasTarget.addEventListener("resize",this._onCanvasTargetResize),this._canvasTarget.isDefaultCanvasTarget=!0,this._inspector=new Dv,this._inspector.setRenderer(this),this._getFallback=l,this._attributes=null,this._geometries=null,this._nodes=null,this._animation=null,this._bindings=null,this._objects=null,this._pipelines=null,this._bundles=null,this._renderLists=null,this._renderContexts=null,this._textures=null,this._background=null,this._quad=new fp(new at),this._quad.name="Output Color Transform",this._quad.material.name="outputColorTransform",this._currentRenderContext=null,this._opaqueSort=null,this._transparentSort=null,this._frameBufferTarget=null;const h=this.alpha===!0?0:1;this._clearColor=new hp(0,0,0,h),this._clearDepth=1,this._clearStencil=0,this._renderTarget=null,this._activeCubeFace=0,this._activeMipmapLevel=0,this._outputRenderTarget=null,this._mrt=null,this._renderObjectFunction=null,this._currentRenderObjectFunction=null,this._currentRenderBundle=null,this._handleObjectFunction=this._renderObjectDirect,this._isDeviceLost=!1,this.onDeviceLost=this._onDeviceLost,this._colorBufferType=u,this._cacheShadowNodes=new WeakMap,this._initialized=!1,this._initPromise=null,this._compilationPromises=null,this.transparent=!0,this.opaque=!0,this.shadowMap={enabled:!1,type:gw},this.xr=new gG(this,d),this.debug={checkShaderErrors:!0,onShaderError:null,getShaderAsync:async(f,p,g)=>{await this.compileAsync(f,p);const x=this._renderLists.get(f,p),m=this._renderContexts.get(f,p,this._renderTarget),y=f.overrideMaterial||g.material,_=this._objects.get(g,y,f,p,x.lightsNode,m,m.clippingContext),{fragmentShader:v,vertexShader:T}=_.getNodeBuilderState();return{fragmentShader:v,vertexShader:T}}}}async init(){return this._initPromise!==null?this._initPromise:(this._initPromise=new Promise(async(e,t)=>{let r=this.backend;try{await r.init(this)}catch(i){if(this._getFallback!==null)try{this.backend=r=this._getFallback(i),await r.init(this)}catch(s){t(s);return}else{t(i);return}}this._nodes=new uG(this,r),this._animation=new YU(this,this._nodes,this.info),this._attributes=new n5(r),this._background=new N4(this,this._nodes),this._geometries=new r5(this._attributes,this.info),this._textures=new b5(this,r,this.info),this._pipelines=new c5(r,this._nodes),this._bindings=new l5(r,this._nodes,this._textures,this._attributes,this._pipelines,this.info),this._objects=new JU(this,this._nodes,this._geometries,this._pipelines,this._bindings,this.info),this._renderLists=new h5(this.lighting),this._bundles=new hG,this._renderContexts=new x5,this._animation.start(),this._initialized=!0,this._inspector.init(),e(this)}),this._initPromise)}get domElement(){return this._canvasTarget.domElement}get coordinateSystem(){return this.backend.coordinateSystem}async compileAsync(e,t,r=null){if(this._isDeviceLost===!0)return;this._initialized===!1&&await this.init();const i=this._nodes.nodeFrame,s=i.renderId,o=this._currentRenderContext,a=this._currentRenderObjectFunction,c=this._compilationPromises,l=e.isScene===!0?e:j0;r===null&&(r=e);const u=this._renderTarget,d=this._renderContexts.get(r,t,u),h=this._activeMipmapLevel,f=[];this._currentRenderContext=d,this._currentRenderObjectFunction=this.renderObject,this._handleObjectFunction=this._createObjectPipeline,this._compilationPromises=f,i.renderId++,i.update(),d.depth=this.depth,d.stencil=this.stencil,d.clippingContext||(d.clippingContext=new dl),d.clippingContext.updateGlobal(l,t),l.onBeforeRender(this,e,t,u);const p=this._renderLists.get(e,t);if(p.begin(),this._projectObject(e,t,0,p,d.clippingContext),r!==e&&r.traverseVisible(function(_){_.isLight&&_.layers.test(t.layers)&&p.pushLight(_)}),p.finish(),u!==null){this._textures.updateRenderTarget(u,h);const _=this._textures.get(u);d.textures=_.textures,d.depthTexture=_.depthTexture}else d.textures=null,d.depthTexture=null;this._background.update(l,p,d);const g=p.opaque,x=p.transparent,m=p.transparentDoublePass,y=p.lightsNode;this.opaque===!0&&g.length>0&&this._renderObjects(g,t,l,y),this.transparent===!0&&x.length>0&&this._renderTransparents(x,m,t,l,y),i.renderId=s,this._currentRenderContext=o,this._currentRenderObjectFunction=a,this._compilationPromises=c,this._handleObjectFunction=this._renderObjectDirect,await Promise.all(f)}async renderAsync(e,t){lt('Renderer: "renderAsync()" has been deprecated. Use "render()" and "await renderer.init();" when creating the renderer.'),await this.init(),this.render(e,t)}async waitForGPU(){ie("Renderer: waitForGPU() has been removed. Read https://github.com/mrdoob/three.js/issues/32012 for more information.")}set inspector(e){this._inspector!==null&&this._inspector.setRenderer(null),this._inspector=e,this._inspector.setRenderer(this)}get inspector(){return this._inspector}set highPrecision(e){e===!0?(this.overrideNodes.modelViewMatrix=Wm,this.overrideNodes.modelNormalViewMatrix=qm):this.highPrecision&&(this.overrideNodes.modelViewMatrix=null,this.overrideNodes.modelNormalViewMatrix=null)}get highPrecision(){return this.overrideNodes.modelViewMatrix===Wm&&this.overrideNodes.modelNormalViewMatrix===qm}setMRT(e){return this._mrt=e,this}getMRT(){return this._mrt}getColorBufferType(){return this._colorBufferType}_onDeviceLost(e){let t=`THREE.WebGPURenderer: ${e.api} Device Lost:

Message: ${e.message}`;e.reason&&(t+=`
Reason: ${e.reason}`),ie(t),this._isDeviceLost=!0}_renderBundle(e,t,r){const{bundleGroup:i,camera:s,renderList:o}=e,a=this._currentRenderContext,c=this._bundles.get(i,s),l=this.backend.get(c);l.renderContexts===void 0&&(l.renderContexts=new Set);const u=i.version!==l.version,d=l.renderContexts.has(a)===!1||u;if(l.renderContexts.add(a),d){this.backend.beginBundle(a),(l.renderObjects===void 0||u)&&(l.renderObjects=[]),this._currentRenderBundle=c;const{transparentDoublePass:h,transparent:f,opaque:p}=o;this.opaque===!0&&p.length>0&&this._renderObjects(p,s,t,r),this.transparent===!0&&f.length>0&&this._renderTransparents(f,h,s,t,r),this._currentRenderBundle=null,this.backend.finishBundle(a,c),l.version=i.version}else{const{renderObjects:h}=l;for(let f=0,p=h.length;f<p;f++){const g=h[f];this._nodes.needsRefresh(g)&&(this._nodes.updateBefore(g),this._nodes.updateForRender(g),this._bindings.updateForRender(g),this._nodes.updateAfter(g))}}this.backend.addBundle(a,c)}render(e,t){if(this._initialized===!1)throw new Error('Renderer: .render() called before the backend is initialized. Use "await renderer.init();" before rendering.');this._renderScene(e,t)}get initialized(){return this._initialized}_getFrameBufferTarget(){const{currentToneMapping:e,currentColorSpace:t}=this,r=e!==xi,i=t!==ut.workingColorSpace;if(r===!1&&i===!1)return null;const{width:s,height:o}=this.getDrawingBufferSize(Zi),{depth:a,stencil:c}=this;let l=this._frameBufferTarget;l===null&&(l=new Is(s,o,{depthBuffer:a,stencilBuffer:c,type:this._colorBufferType,format:_n,colorSpace:ut.workingColorSpace,generateMipmaps:!1,minFilter:Sn,magFilter:Sn,samples:this.samples}),l.isPostProcessingRenderTarget=!0,this._frameBufferTarget=l);const u=this.getOutputRenderTarget();l.depthBuffer=a,l.stencilBuffer=c,u!==null?l.setSize(u.width,u.height,u.depth):l.setSize(s,o,1);const d=this._canvasTarget;return l.viewport.copy(d._viewport),l.scissor.copy(d._scissor),l.viewport.multiplyScalar(d._pixelRatio),l.scissor.multiplyScalar(d._pixelRatio),l.scissorTest=d._scissorTest,l.multiview=u!==null?u.multiview:!1,l.resolveDepthBuffer=u!==null?u.resolveDepthBuffer:!0,l._autoAllocateDepthBuffer=u!==null?u._autoAllocateDepthBuffer:!1,l}_renderScene(e,t,r=!0){if(this._isDeviceLost===!0)return;const i=r?this._getFrameBufferTarget():null,s=this._nodes.nodeFrame,o=s.renderId,a=this._currentRenderContext,c=this._currentRenderObjectFunction,l=e.isScene===!0?e:j0,u=this._renderTarget||this._outputRenderTarget,d=this._activeCubeFace,h=this._activeMipmapLevel;let f;i!==null?(f=i,this.setRenderTarget(f)):f=u;const p=this._renderContexts.get(e,t,f);this._currentRenderContext=p,this._currentRenderObjectFunction=this._renderObjectFunction||this.renderObject,this.info.calls++,this.info.render.calls++,this.info.render.frameCalls++,s.renderId=this.info.calls,this.backend.updateTimeStampUID(p),this.inspector.beginRender(this.backend.getTimestampUID(p),e,t,f);const g=this.coordinateSystem,x=this.xr;if(t.coordinateSystem!==g&&x.isPresenting===!1&&(t.coordinateSystem=g,t.updateProjectionMatrix(),t.isArrayCamera))for(const S of t.cameras)S.coordinateSystem=g,S.updateProjectionMatrix();e.matrixWorldAutoUpdate===!0&&e.updateMatrixWorld(),t.parent===null&&t.matrixWorldAutoUpdate===!0&&t.updateMatrixWorld(),x.enabled===!0&&x.isPresenting===!0&&(x.cameraAutoUpdate===!0&&x.updateCamera(t),t=x.getCamera());const m=this._canvasTarget;let y=m._viewport,_=m._scissor,v=m._pixelRatio;f!==null&&(y=f.viewport,_=f.scissor,v=1),this.getDrawingBufferSize(Zi),ed.set(0,0,Zi.width,Zi.height);const T=y.minDepth===void 0?0:y.minDepth,w=y.maxDepth===void 0?1:y.maxDepth;p.viewportValue.copy(y).multiplyScalar(v).floor(),p.viewportValue.width>>=h,p.viewportValue.height>>=h,p.viewportValue.minDepth=T,p.viewportValue.maxDepth=w,p.viewport=p.viewportValue.equals(ed)===!1,p.scissorValue.copy(_).multiplyScalar(v).floor(),p.scissor=m._scissorTest&&p.scissorValue.equals(ed)===!1,p.scissorValue.width>>=h,p.scissorValue.height>>=h,p.clippingContext||(p.clippingContext=new dl),p.clippingContext.updateGlobal(l,t),l.onBeforeRender(this,e,t,f);const N=t.isArrayCamera?nd:td;t.isArrayCamera||(Za.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),N.setFromProjectionMatrix(Za,t.coordinateSystem,t.reversedDepth));const E=this._renderLists.get(e,t);if(E.begin(),this._projectObject(e,t,0,E,p.clippingContext),E.finish(),this.sortObjects===!0&&E.sort(this._opaqueSort,this._transparentSort),f!==null){this._textures.updateRenderTarget(f,h);const S=this._textures.get(f);p.textures=S.textures,p.depthTexture=S.depthTexture,p.width=S.width,p.height=S.height,p.renderTarget=f,p.depth=f.depthBuffer,p.stencil=f.stencilBuffer}else p.textures=null,p.depthTexture=null,p.width=Zi.width,p.height=Zi.height,p.depth=this.depth,p.stencil=this.stencil;p.width>>=h,p.height>>=h,p.activeCubeFace=d,p.activeMipmapLevel=h,p.occlusionQueryCount=E.occlusionQueryCount,p.scissorValue.max(nr.set(0,0,0,0)),p.scissorValue.x+p.scissorValue.width>p.width&&(p.scissorValue.width=Math.max(p.width-p.scissorValue.x,0)),p.scissorValue.y+p.scissorValue.height>p.height&&(p.scissorValue.height=Math.max(p.height-p.scissorValue.y,0)),this._background.update(l,E,p),p.camera=t,this.backend.beginRender(p);const{bundles:A,lightsNode:B,transparentDoublePass:R,transparent:L,opaque:F}=E;return A.length>0&&this._renderBundles(A,l,B),this.opaque===!0&&F.length>0&&this._renderObjects(F,t,l,B),this.transparent===!0&&L.length>0&&this._renderTransparents(L,R,t,l,B),this.backend.finishRender(p),s.renderId=o,this._currentRenderContext=a,this._currentRenderObjectFunction=c,i!==null&&(this.setRenderTarget(u,d,h),this._renderOutput(f)),l.onAfterRender(this,e,t,f),this.inspector.finishRender(this.backend.getTimestampUID(p)),p}_setXRLayerSize(e,t){this._canvasTarget._width=e,this._canvasTarget._height=t,this.setViewport(0,0,e,t)}_renderOutput(e){const t=this._quad;this._nodes.hasOutputChange(e.texture)&&(t.material.fragmentNode=this._nodes.getOutputNode(e.texture),t.material.needsUpdate=!0);const r=this.autoClear,i=this.xr.enabled;this.autoClear=!1,this.xr.enabled=!1,this._renderScene(t,t.camera,!1),this.autoClear=r,this.xr.enabled=i}getMaxAnisotropy(){return this.backend.getMaxAnisotropy()}getActiveCubeFace(){return this._activeCubeFace}getActiveMipmapLevel(){return this._activeMipmapLevel}async setAnimationLoop(e){this._initialized===!1&&await this.init(),this._animation.setAnimationLoop(e)}getAnimationLoop(){return this._animation.getAnimationLoop()}async getArrayBufferAsync(e){return await this.backend.getArrayBufferAsync(e)}getContext(){return this.backend.getContext()}getPixelRatio(){return this._canvasTarget.getPixelRatio()}getDrawingBufferSize(e){return this._canvasTarget.getDrawingBufferSize(e)}getSize(e){return this._canvasTarget.getSize(e)}setPixelRatio(e=1){this._canvasTarget.setPixelRatio(e)}setDrawingBufferSize(e,t,r){this.xr&&this.xr.isPresenting||this._canvasTarget.setDrawingBufferSize(e,t,r)}setSize(e,t,r=!0){this.xr&&this.xr.isPresenting||this._canvasTarget.setSize(e,t,r)}setOpaqueSort(e){this._opaqueSort=e}setTransparentSort(e){this._transparentSort=e}getScissor(e){return this._canvasTarget.getScissor(e)}setScissor(e,t,r,i){this._canvasTarget.setScissor(e,t,r,i)}getScissorTest(){return this._canvasTarget.getScissorTest()}setScissorTest(e){this._canvasTarget.setScissorTest(e),this.backend.setScissorTest(e)}getViewport(e){return this._canvasTarget.getViewport(e)}setViewport(e,t,r,i,s=0,o=1){this._canvasTarget.setViewport(e,t,r,i,s,o)}getClearColor(e){return e.copy(this._clearColor)}setClearColor(e,t=1){this._clearColor.set(e),this._clearColor.a=t}getClearAlpha(){return this._clearColor.a}setClearAlpha(e){this._clearColor.a=e}getClearDepth(){return this._clearDepth}setClearDepth(e){this._clearDepth=e}getClearStencil(){return this._clearStencil}setClearStencil(e){this._clearStencil=e}isOccluded(e){const t=this._currentRenderContext;return t&&this.backend.isOccluded(t,e)}clear(e=!0,t=!0,r=!0){if(this._initialized===!1)throw new Error('Renderer: .clear() called before the backend is initialized. Use "await renderer.init();" before before using this method.');const i=this._renderTarget||this._getFrameBufferTarget();let s=null;if(i!==null){this._textures.updateRenderTarget(i);const o=this._textures.get(i);s=this._renderContexts.getForClear(i),s.textures=o.textures,s.depthTexture=o.depthTexture,s.width=o.width,s.height=o.height,s.renderTarget=i,s.depth=i.depthBuffer,s.stencil=i.stencilBuffer,s.clearColorValue=this.backend.getClearColor(),s.activeCubeFace=this.getActiveCubeFace(),s.activeMipmapLevel=this.getActiveMipmapLevel()}this.backend.clear(e,t,r,s),i!==null&&this._renderTarget===null&&this._renderOutput(i)}clearColor(){this.clear(!0,!1,!1)}clearDepth(){this.clear(!1,!0,!1)}clearStencil(){this.clear(!1,!1,!0)}async clearAsync(e=!0,t=!0,r=!0){lt('Renderer: "clearAsync()" has been deprecated. Use "clear()" and "await renderer.init();" when creating the renderer.'),await this.init(),this.clear(e,t,r)}async clearColorAsync(){lt('Renderer: "clearColorAsync()" has been deprecated. Use "clearColor()" and "await renderer.init();" when creating the renderer.'),this.clear(!0,!1,!1)}async clearDepthAsync(){lt('Renderer: "clearDepthAsync()" has been deprecated. Use "clearDepth()" and "await renderer.init();" when creating the renderer.'),this.clear(!1,!0,!1)}async clearStencilAsync(){lt('Renderer: "clearStencilAsync()" has been deprecated. Use "clearStencil()" and "await renderer.init();" when creating the renderer.'),this.clear(!1,!1,!0)}get needsFrameBufferTarget(){const e=this.currentToneMapping!==xi,t=this.currentColorSpace!==ut.workingColorSpace;return e||t}get samples(){return this._samples}get currentSamples(){let e=this._samples;return this._renderTarget!==null?e=this._renderTarget.samples:this.needsFrameBufferTarget&&(e=0),e}get currentToneMapping(){return this.isOutputTarget?this.toneMapping:xi}get currentColorSpace(){return this.isOutputTarget?this.outputColorSpace:ut.workingColorSpace}get isOutputTarget(){return this._renderTarget===this._outputRenderTarget||this._renderTarget===null}dispose(){this._initialized===!0&&(this.info.dispose(),this.backend.dispose(),this._animation.dispose(),this._objects.dispose(),this._geometries.dispose(),this._pipelines.dispose(),this._nodes.dispose(),this._bindings.dispose(),this._renderLists.dispose(),this._renderContexts.dispose(),this._textures.dispose(),this._frameBufferTarget!==null&&this._frameBufferTarget.dispose(),Object.values(this.backend.timestampQueryPool).forEach(e=>{e!==null&&e.dispose()})),this.setRenderTarget(null),this.setAnimationLoop(null)}setRenderTarget(e,t=0,r=0){this._renderTarget=e,this._activeCubeFace=t,this._activeMipmapLevel=r}getRenderTarget(){return this._renderTarget}setOutputRenderTarget(e){this._outputRenderTarget=e}getOutputRenderTarget(){return this._outputRenderTarget}setCanvasTarget(e){this._canvasTarget.removeEventListener("resize",this._onCanvasTargetResize),this._canvasTarget=e,this._canvasTarget.addEventListener("resize",this._onCanvasTargetResize)}getCanvasTarget(){return this._canvasTarget}_resetXRState(){this.backend.setXRTarget(null),this.setOutputRenderTarget(null),this.setRenderTarget(null),this._frameBufferTarget.dispose(),this._frameBufferTarget=null}setRenderObjectFunction(e){this._renderObjectFunction=e}getRenderObjectFunction(){return this._renderObjectFunction}compute(e,t=null){if(this._isDeviceLost===!0)return;if(this._initialized===!1)return se("Renderer: .compute() called before the backend is initialized. Try using .computeAsync() instead."),this.computeAsync(e,t);const r=this._nodes.nodeFrame,i=r.renderId;this.info.calls++,this.info.compute.calls++,this.info.compute.frameCalls++,r.renderId=this.info.calls,this.backend.updateTimeStampUID(e),this.inspector.beginCompute(this.backend.getTimestampUID(e),e);const s=this.backend,o=this._pipelines,a=this._bindings,c=this._nodes,l=Array.isArray(e)?e:[e];if(l[0]===void 0||l[0].isComputeNode!==!0)throw new Error("THREE.Renderer: .compute() expects a ComputeNode.");s.beginCompute(e);for(const u of l){if(o.has(u)===!1){const f=()=>{u.removeEventListener("dispose",f),o.delete(u),a.deleteForCompute(u),c.delete(u)};u.addEventListener("dispose",f);const p=u.onInitFunction;p!==null&&p.call(u,{renderer:this})}c.updateForCompute(u),a.updateForCompute(u);const d=a.getForCompute(u),h=o.getForCompute(u,d);s.compute(e,u,d,h,t)}s.finishCompute(e),r.renderId=i,this.inspector.finishCompute(this.backend.getTimestampUID(e))}async computeAsync(e,t=null){this._initialized===!1&&await this.init(),this.compute(e,t)}async hasFeatureAsync(e){return lt('Renderer: "hasFeatureAsync()" has been deprecated. Use "hasFeature()" and "await renderer.init();" when creating the renderer.'),await this.init(),this.hasFeature(e)}async resolveTimestampsAsync(e="render"){return this._initialized===!1&&await this.init(),this.backend.resolveTimestampsAsync(e)}hasFeature(e){if(this._initialized===!1)throw new Error('Renderer: .hasFeature() called before the backend is initialized. Use "await renderer.init();" before before using this method.');return this.backend.hasFeature(e)}hasInitialized(){return this._initialized}async initTextureAsync(e){lt('Renderer: "initTextureAsync()" has been deprecated. Use "initTexture()" and "await renderer.init();" when creating the renderer.'),await this.init(),this.initTexture(e)}initTexture(e){if(this._initialized===!1)throw new Error('Renderer: .initTexture() called before the backend is initialized. Use "await renderer.init();" before before using this method.');this._textures.updateTexture(e)}copyFramebufferToTexture(e,t=null){if(t!==null)if(t.isVector2)t=nr.set(t.x,t.y,e.image.width,e.image.height).floor();else if(t.isVector4)t=nr.copy(t).floor();else{ie("Renderer.copyFramebufferToTexture: Invalid rectangle.");return}else t=nr.set(0,0,e.image.width,e.image.height);let r=this._currentRenderContext,i;r!==null?i=r.renderTarget:(i=this._renderTarget||this._getFrameBufferTarget(),i!==null&&(this._textures.updateRenderTarget(i),r=this._textures.get(i))),this._textures.updateTexture(e,{renderTarget:i}),this.backend.copyFramebufferToTexture(e,r,t),this._inspector.copyFramebufferToTexture(e)}copyTextureToTexture(e,t,r=null,i=null,s=0,o=0){this._textures.updateTexture(e),this._textures.updateTexture(t),this.backend.copyTextureToTexture(e,t,r,i,s,o),this._inspector.copyTextureToTexture(e,t)}async readRenderTargetPixelsAsync(e,t,r,i,s,o=0,a=0){return this.backend.copyTextureToBuffer(e.textures[o],t,r,i,s,a)}_projectObject(e,t,r,i,s){if(e.visible===!1)return;if(e.layers.test(t.layers)){if(e.isGroup)r=e.renderOrder,e.isClippingGroup&&e.enabled&&(s=s.getGroupContext(e));else if(e.isLOD)e.autoUpdate===!0&&e.update(t);else if(e.isLight)i.pushLight(e);else if(e.isSprite){const c=t.isArrayCamera?nd:td;if(!e.frustumCulled||c.intersectsSprite(e,t)){this.sortObjects===!0&&nr.setFromMatrixPosition(e.matrixWorld).applyMatrix4(Za);const{geometry:l,material:u}=e;u.visible&&i.push(e,l,u,r,nr.z,null,s)}}else if(e.isLineLoop)ie("Renderer: Objects of type THREE.LineLoop are not supported. Please use THREE.Line or THREE.LineSegments.");else if(e.isMesh||e.isLine||e.isPoints){const c=t.isArrayCamera?nd:td;if(!e.frustumCulled||c.intersectsObject(e,t)){const{geometry:l,material:u}=e;if(this.sortObjects===!0&&(l.boundingSphere===null&&l.computeBoundingSphere(),nr.copy(l.boundingSphere.center).applyMatrix4(e.matrixWorld).applyMatrix4(Za)),Array.isArray(u)){const d=l.groups;for(let h=0,f=d.length;h<f;h++){const p=d[h],g=u[p.materialIndex];g&&g.visible&&i.push(e,l,g,r,nr.z,p,s)}}else u.visible&&i.push(e,l,u,r,nr.z,null,s)}}}if(e.isBundleGroup===!0&&this.backend.beginBundle!==void 0){const c=i;i=this._renderLists.get(e,t),i.begin(),c.pushBundle({bundleGroup:e,camera:t,renderList:i}),i.finish()}const a=e.children;for(let c=0,l=a.length;c<l;c++)this._projectObject(a[c],t,r,i,s)}_renderBundles(e,t,r){for(const i of e)this._renderBundle(i,t,r)}_renderTransparents(e,t,r,i,s){if(t.length>0){for(const{material:o}of t)o.side=jt;this._renderObjects(t,r,i,s,"backSide");for(const{material:o}of t)o.side=Ao;this._renderObjects(e,r,i,s);for(const{material:o}of t)o.side=vi}else this._renderObjects(e,r,i,s)}_renderObjects(e,t,r,i,s=null){for(let o=0,a=e.length;o<a;o++){const{object:c,geometry:l,material:u,group:d,clippingContext:h}=e[o];this._currentRenderObjectFunction(c,r,t,l,u,d,i,h,s)}}_getShadowNodes(e){const t=e.version;let r=this._cacheShadowNodes.get(e);if(r===void 0||r.version!==t){const i=e.map!==null,s=e.colorNode&&e.colorNode.isNode,o=e.castShadowNode&&e.castShadowNode.isNode;let a=null,c=null,l=null;if(i||s||o){let u,d;o?(u=e.castShadowNode.rgb,d=e.castShadowNode.a):(u=X(0),d=j(1)),i&&(d=d.mul(Oe("map","texture",e).a)),s&&(d=d.mul(e.colorNode.a)),c=be(u,d)}e.depthNode&&e.depthNode.isNode&&(l=e.depthNode),e.castShadowPositionNode&&e.castShadowPositionNode.isNode?a=e.castShadowPositionNode:e.positionNode&&e.positionNode.isNode&&(a=e.positionNode),r={version:t,colorNode:c,depthNode:l,positionNode:a},this._cacheShadowNodes.set(e,r)}return r}renderObject(e,t,r,i,s,o,a,c=null,l=null){let u=!1,d,h,f,p;if(e.onBeforeRender(this,t,r,i,s,o),s.allowOverride===!0&&t.overrideMaterial!==null){const g=t.overrideMaterial;if(u=!0,d=t.overrideMaterial.colorNode,h=t.overrideMaterial.depthNode,f=t.overrideMaterial.positionNode,p=t.overrideMaterial.side,s.positionNode&&s.positionNode.isNode&&(g.positionNode=s.positionNode),g.alphaTest=s.alphaTest,g.alphaMap=s.alphaMap,g.transparent=s.transparent||s.transmission>0||s.transmissionNode&&s.transmissionNode.isNode||s.backdropNode&&s.backdropNode.isNode,g.isShadowPassMaterial){const{colorNode:x,depthNode:m,positionNode:y}=this._getShadowNodes(s);g.side=s.shadowSide===null?s.side:s.shadowSide,x!==null&&(g.colorNode=x),m!==null&&(g.depthNode=m),y!==null&&(g.positionNode=y)}s=g}s.transparent===!0&&s.side===vi&&s.forceSinglePass===!1?(s.side=jt,this._handleObjectFunction(e,s,t,r,a,o,c,"backSide"),s.side=Ao,this._handleObjectFunction(e,s,t,r,a,o,c,l),s.side=vi):this._handleObjectFunction(e,s,t,r,a,o,c,l),u&&(t.overrideMaterial.colorNode=d,t.overrideMaterial.depthNode=h,t.overrideMaterial.positionNode=f,t.overrideMaterial.side=p),e.onAfterRender(this,t,r,i,s,o)}_renderObjectDirect(e,t,r,i,s,o,a,c){const l=this._objects.get(e,t,r,i,s,this._currentRenderContext,a,c);l.drawRange=e.geometry.drawRange,l.group=o;const u=this._nodes.needsRefresh(l);u&&(this._nodes.updateBefore(l),this._geometries.updateForRender(l),this._nodes.updateForRender(l),this._bindings.updateForRender(l)),this._pipelines.updateForRender(l),this._currentRenderBundle!==null&&(this.backend.get(this._currentRenderBundle).renderObjects.push(l),l.bundle=this._currentRenderBundle.bundleGroup),this.backend.draw(l,this.info),u&&this._nodes.updateAfter(l)}_createObjectPipeline(e,t,r,i,s,o,a,c){const l=this._objects.get(e,t,r,i,s,this._currentRenderContext,a,c);l.drawRange=e.geometry.drawRange,l.group=o,this._nodes.updateBefore(l),this._geometries.updateForRender(l),this._nodes.updateForRender(l),this._bindings.updateForRender(l),this._pipelines.getForRender(l,this._compilationPromises),this._nodes.updateAfter(l)}_onCanvasTargetResize(){this._initialized&&this.backend.updateSize()}get compile(){return this.compileAsync}}class UT{constructor(e=""){this.name=e,this.visibility=0}setVisibility(e){this.visibility|=e}clone(){return Object.assign(new this.constructor,this)}}function NG(n){return n+(Br-n%Br)%Br}class GT extends UT{constructor(e,t=null){super(e),this.isBuffer=!0,this.bytesPerElement=Float32Array.BYTES_PER_ELEMENT,this._buffer=t}get byteLength(){return NG(this._buffer.byteLength)}get buffer(){return this._buffer}update(){return!0}}class $T extends GT{constructor(e,t=null){super(e,t),this.isUniformBuffer=!0}}let EG=0;class VT extends $T{constructor(e,t){super("UniformBuffer_"+EG++,e?e.value:null),this.nodeUniform=e,this.groupNode=t}get buffer(){return this.nodeUniform.value}}class AG extends $T{constructor(e){super(e),this.isUniformsGroup=!0,this._values=null,this.uniforms=[]}addUniform(e){return this.uniforms.push(e),this}removeUniform(e){const t=this.uniforms.indexOf(e);return t!==-1&&this.uniforms.splice(t,1),this}get values(){return this._values===null&&(this._values=Array.from(this.buffer)),this._values}get buffer(){let e=this._buffer;if(e===null){const t=this.byteLength;e=new Float32Array(new ArrayBuffer(t)),this._buffer=e}return e}get byteLength(){const e=this.bytesPerElement;let t=0;for(let r=0,i=this.uniforms.length;r<i;r++){const s=this.uniforms[r],o=s.boundary,a=s.itemSize*e,c=t%Br,l=c%o,u=c+l;t+=l,u!==0&&Br-u<a&&(t+=Br-u),s.offset=t/e,t+=a}return Math.ceil(t/Br)*Br}update(){let e=!1;for(const t of this.uniforms)this.updateByType(t)===!0&&(e=!0);return e}updateByType(e){if(e.isNumberUniform)return this.updateNumber(e);if(e.isVector2Uniform)return this.updateVector2(e);if(e.isVector3Uniform)return this.updateVector3(e);if(e.isVector4Uniform)return this.updateVector4(e);if(e.isColorUniform)return this.updateColor(e);if(e.isMatrix3Uniform)return this.updateMatrix3(e);if(e.isMatrix4Uniform)return this.updateMatrix4(e);ie("WebGPUUniformsGroup: Unsupported uniform type.",e)}updateNumber(e){let t=!1;const r=this.values,i=e.getValue(),s=e.offset,o=e.getType();if(r[s]!==i){const a=this._getBufferForType(o);a[s]=r[s]=i,t=!0}return t}updateVector2(e){let t=!1;const r=this.values,i=e.getValue(),s=e.offset,o=e.getType();if(r[s+0]!==i.x||r[s+1]!==i.y){const a=this._getBufferForType(o);a[s+0]=r[s+0]=i.x,a[s+1]=r[s+1]=i.y,t=!0}return t}updateVector3(e){let t=!1;const r=this.values,i=e.getValue(),s=e.offset,o=e.getType();if(r[s+0]!==i.x||r[s+1]!==i.y||r[s+2]!==i.z){const a=this._getBufferForType(o);a[s+0]=r[s+0]=i.x,a[s+1]=r[s+1]=i.y,a[s+2]=r[s+2]=i.z,t=!0}return t}updateVector4(e){let t=!1;const r=this.values,i=e.getValue(),s=e.offset,o=e.getType();if(r[s+0]!==i.x||r[s+1]!==i.y||r[s+2]!==i.z||r[s+4]!==i.w){const a=this._getBufferForType(o);a[s+0]=r[s+0]=i.x,a[s+1]=r[s+1]=i.y,a[s+2]=r[s+2]=i.z,a[s+3]=r[s+3]=i.w,t=!0}return t}updateColor(e){let t=!1;const r=this.values,i=e.getValue(),s=e.offset;if(r[s+0]!==i.r||r[s+1]!==i.g||r[s+2]!==i.b){const o=this.buffer;o[s+0]=r[s+0]=i.r,o[s+1]=r[s+1]=i.g,o[s+2]=r[s+2]=i.b,t=!0}return t}updateMatrix3(e){let t=!1;const r=this.values,i=e.getValue().elements,s=e.offset;if(r[s+0]!==i[0]||r[s+1]!==i[1]||r[s+2]!==i[2]||r[s+4]!==i[3]||r[s+5]!==i[4]||r[s+6]!==i[5]||r[s+8]!==i[6]||r[s+9]!==i[7]||r[s+10]!==i[8]){const o=this.buffer;o[s+0]=r[s+0]=i[0],o[s+1]=r[s+1]=i[1],o[s+2]=r[s+2]=i[2],o[s+4]=r[s+4]=i[3],o[s+5]=r[s+5]=i[4],o[s+6]=r[s+6]=i[5],o[s+8]=r[s+8]=i[6],o[s+9]=r[s+9]=i[7],o[s+10]=r[s+10]=i[8],t=!0}return t}updateMatrix4(e){let t=!1;const r=this.values,i=e.getValue().elements,s=e.offset;return CG(r,i,s)===!1&&(this.buffer.set(i,s),RG(r,i,s),t=!0),t}_getBufferForType(e){return e==="int"||e==="ivec2"||e==="ivec3"||e==="ivec4"?new Int32Array(this.buffer.buffer):e==="uint"||e==="uvec2"||e==="uvec3"||e==="uvec4"?new Uint32Array(this.buffer.buffer):this.buffer}}function RG(n,e,t){for(let r=0,i=e.length;r<i;r++)n[t+r]=e[r]}function CG(n,e,t){for(let r=0,i=e.length;r<i;r++)if(n[t+r]!==e[r])return!1;return!0}let MG=0;class zT extends AG{constructor(e,t){super(e),this.id=MG++,this.groupNode=t,this.isNodeUniformsGroup=!0}}class jT extends UT{constructor(e,t){super(e),this._texture=null,this._onTextureDispose=()=>{this.generation=null,this.version=0},this.texture=t,this.version=t?t.version:0,this.generation=null,this.samplerKey="",this.isSampler=!0}set texture(e){this._texture!==e&&(this._texture&&this._texture.removeEventListener("dispose",this._onTextureDispose),this._texture=e,this.generation=null,this.version=0,this._texture&&this._texture.addEventListener("dispose",this._onTextureDispose))}get texture(){return this._texture}update(){const{texture:e,version:t}=this;return t!==e.version?(this.version=e.version,!0):!1}clone(){const e=super.clone();return e._texture=null,e._onTextureDispose=()=>{e.generation=null,e.version=0},e.texture=this.texture,e}}let PG=0;class DG extends jT{constructor(e,t){super(e,t),this.id=PG++,this.store=!1,this.mipLevel=0,this.isSampledTexture=!0}}class Wl extends DG{constructor(e,t,r,i=null){super(e,t?t.value:null),this.textureNode=t,this.groupNode=r,this.access=i}update(){const{textureNode:e}=this;return this.texture!==e.value?(this.texture=e.value,!0):super.update()}}class HT extends Wl{constructor(e,t,r,i=null){super(e,t,r,i),this.isSampledCubeTexture=!0}}class Oh extends Wl{constructor(e,t,r,i=null){super(e,t,r,i),this.isSampledTexture3D=!0}}const H0={bitcast_int_uint:new _t("uint tsl_bitcast_uint_to_int ( int x ) { return floatBitsToInt( uintBitsToFloat( x ) ); }"),bitcast_uint_int:new _t("uint tsl_bitcast_int_to_uint ( int x ) { return floatBitsToUint( intBitsToFloat ( x ) ); }")},BG={textureDimensions:"textureSize",equals:"equal",bitcast_float_int:"floatBitsToInt",bitcast_int_float:"intBitsToFloat",bitcast_uint_float:"uintBitsToFloat",bitcast_float_uint:"floatBitsToUint",bitcast_uint_int:"tsl_bitcast_uint_to_int",bitcast_int_uint:"tsl_bitcast_int_to_uint"},FG={low:"lowp",medium:"mediump",high:"highp"},W0={swizzleAssign:!0,storageBuffer:!1},q0={perspective:"smooth",linear:"noperspective"},X0={centroid:"centroid"},Y0=`
precision highp float;
precision highp int;
precision highp sampler2D;
precision highp sampler3D;
precision highp samplerCube;
precision highp sampler2DArray;

precision highp usampler2D;
precision highp usampler3D;
precision highp usamplerCube;
precision highp usampler2DArray;

precision highp isampler2D;
precision highp isampler3D;
precision highp isamplerCube;
precision highp isampler2DArray;

precision lowp sampler2DShadow;
precision lowp sampler2DArrayShadow;
precision lowp samplerCubeShadow;
`;class kG extends IT{constructor(e,t){super(e,t,new lG),this.uniformGroups={},this.transforms=[],this.extensions={},this.builtins={vertex:[],fragment:[],compute:[]}}needsToWorkingColorSpace(e){return e.isVideoTexture===!0&&e.colorSpace!==_s}_include(e){const t=H0[e];return t.build(this),this.addInclude(t),t}getMethod(e){return H0[e]!==void 0&&this._include(e),BG[e]||e}getBitcastMethod(e,t){return this.getMethod(`bitcast_${t}_${e}`)}getTernary(e,t,r){return`${e} ? ${t} : ${r}`}getOutputStructName(){return""}buildFunctionCode(e){const t=e.layout,r=this.flowShaderNode(e),i=[];for(const o of t.inputs)i.push(this.getType(o.type)+" "+o.name);return`${this.getType(t.type)} ${t.name}( ${i.join(", ")} ) {

	${r.vars}

${r.code}
	return ${r.result};

}`}setupPBO(e){const t=e.value;if(t.pbo===void 0){const r=t.array,i=t.count*t.itemSize,{itemSize:s}=t,o=t.array.constructor.name.toLowerCase().includes("int");let a=o?ff:hf;s===2?a=o?pf:Fr:s===3?a=o?yS:df:s===4&&(a=o?gf:_n);const c={Float32Array:nn,Uint8Array:Qt,Uint16Array:is,Uint32Array:dt,Int8Array:Co,Int16Array:Mo,Int32Array:Pt,Uint8ClampedArray:Qt},l=Math.pow(2,Math.ceil(Math.log2(Math.sqrt(i/s))));let u=Math.ceil(i/s/l);l*u*s<i&&u++;const d=l*u*s,h=new r.constructor(d);h.set(r,0),t.array=h;const f=new Ay(t.array,l,u,a,c[t.array.constructor.name]||nn);f.needsUpdate=!0,f.isPBOTexture=!0;const p=new Gs(f,null,null);p.setPrecision("high"),t.pboNode=p,t.pbo=p.value,this.getUniformFromNode(t.pboNode,"texture",this.shaderStage,this.context.nodeName)}}getPropertyName(e,t=this.shaderStage){return e.isNodeUniform&&e.node.isTextureNode!==!0&&e.node.isBufferNode!==!0?t.charAt(0)+"_"+e.name:super.getPropertyName(e,t)}generatePBO(e){const{node:t,indexNode:r}=e,i=t.value;if(this.renderer.backend.has(i)){const u=this.renderer.backend.get(i);u.pbo=i.pbo}const s=this.getUniformFromNode(i.pboNode,"texture",this.shaderStage,this.context.nodeName),o=this.getPropertyName(s);this.increaseUsage(r);const a=r.build(this,"uint"),c=this.getDataFromNode(e);let l=c.propertyName;if(l===void 0){const u=this.getVarFromNode(e);l=this.getPropertyName(u);const d=this.getDataFromNode(t);let h=d.propertySizeName;h===void 0&&(h=l+"Size",this.getVarFromNode(t,h,"uint"),this.addLineFlowCode(`${h} = uint( textureSize( ${o}, 0 ).x )`,e),d.propertySizeName=h);const{itemSize:f}=i,p="."+Os.join("").slice(0,f),g=`ivec2(${a} % ${h}, ${a} / ${h})`,x=this.generateTextureLoad(null,o,g,"0",null,null);let m="vec4";i.pbo.type===dt?m="uvec4":i.pbo.type===Pt&&(m="ivec4"),this.addLineFlowCode(`${l} = ${m}(${x})${p}`,e),c.propertyName=l}return l}generateTextureLoad(e,t,r,i,s,o){i===null&&(i="0");let a;return s?o?a=`texelFetchOffset( ${t}, ivec3( ${r}, ${s} ), ${i}, ${o} )`:a=`texelFetch( ${t}, ivec3( ${r}, ${s} ), ${i} )`:o?a=`texelFetchOffset( ${t}, ${r}, ${i}, ${o} )`:a=`texelFetch( ${t}, ${r}, ${i} )`,e!==null&&e.isDepthTexture&&(a+=".x"),a}generateTexture(e,t,r,i,s){return i&&(r=`vec3( ${r}, ${i} )`),e.isDepthTexture?s?`textureOffset( ${t}, ${r}, ${s} ).x`:`texture( ${t}, ${r} ).x`:s?`textureOffset( ${t}, ${r}, ${s} )`:`texture( ${t}, ${r} )`}generateTextureLevel(e,t,r,i,s){return s?`textureLodOffset( ${t}, ${r}, ${i}, ${s} )`:`textureLod( ${t}, ${r}, ${i} )`}generateTextureBias(e,t,r,i,s){return s?`textureOffset( ${t}, ${r}, ${s}, ${i} )`:`texture( ${t}, ${r}, ${i} )`}generateTextureGrad(e,t,r,i,s){return s?`textureGradOffset( ${t}, ${r}, ${i[0]}, ${i[1]}, ${s} )`:`textureGrad( ${t}, ${r}, ${i[0]}, ${i[1]} )`}generateTextureCompare(e,t,r,i,s,o,a=this.shaderStage){if(a==="fragment")return s?o?`textureOffset( ${t}, vec4( ${r}, ${s}, ${i} ), ${o} )`:`texture( ${t}, vec4( ${r}, ${s}, ${i} ) )`:o?`textureOffset( ${t}, vec3( ${r}, ${i} ), ${o} )`:`texture( ${t}, vec3( ${r}, ${i} ) )`;ie(`WebGPURenderer: THREE.DepthTexture.compareFunction() does not support ${a} shader.`)}getVars(e){const t=[],r=this.vars[e];if(r!==void 0)for(const i of r)t.push(`${this.getVar(i.type,i.name,i.count)};`);return t.join(`
	`)}getUniforms(e){const t=this.uniforms[e],r=[],i={};for(const o of t){let a=null,c=!1;if(o.type==="texture"||o.type==="texture3D"){const u=o.node.value;let d="";(u.isDataTexture===!0||u.isData3DTexture===!0)&&(u.type===dt?d="u":u.type===Pt&&(d="i")),o.type==="texture3D"&&u.isArrayTexture===!1?a=`${d}sampler3D ${o.name};`:u.compareFunction?u.isArrayTexture===!0?a=`sampler2DArrayShadow ${o.name};`:a=`sampler2DShadow ${o.name};`:u.isArrayTexture===!0||u.isDataArrayTexture===!0||u.isCompressedArrayTexture===!0?a=`${d}sampler2DArray ${o.name};`:a=`${d}sampler2D ${o.name};`}else if(o.type==="cubeTexture")a=`samplerCube ${o.name};`;else if(o.type==="buffer"){const u=o.node,d=this.getType(u.bufferType),h=u.bufferCount,f=h>0?h:"";a=`${u.name} {
	${d} ${o.name}[${f}];
};
`}else a=`${this.getVectorType(o.type)} ${this.getPropertyName(o,e)};`,c=!0;const l=o.node.precision;if(l!==null&&(a=FG[l]+" "+a),c){a="	"+a;const u=o.groupNode.name;(i[u]||(i[u]=[])).push(a)}else a="uniform "+a,r.push(a)}let s="";for(const o in i){const a=i[o];s+=this._getGLSLUniformStruct(e+"_"+o,a.join(`
`))+`
`}return s+=r.join(`
`),s}getTypeFromAttribute(e){let t=super.getTypeFromAttribute(e);if(/^[iu]/.test(t)&&e.gpuType!==Pt){let r=e;e.isInterleavedBufferAttribute&&(r=e.data);const i=r.array;i instanceof Uint32Array||i instanceof Int32Array||(t=t.slice(1))}return t}getAttributes(e){let t="";if(e==="vertex"||e==="compute"){const r=this.getAttributesArray();let i=0;for(const s of r)t+=`layout( location = ${i++} ) in ${s.type} ${s.name};
`}return t}getStructMembers(e){const t=[];for(const r of e.members)t.push(`	${r.type} ${r.name};`);return t.join(`
`)}getStructs(e){const t=[],r=this.structs[e],i=[];for(const s of r)if(s.output)for(const o of s.members)i.push(`layout( location = ${o.index} ) out ${o.type} ${o.name};`);else{let o="struct "+s.name+` {
`;o+=this.getStructMembers(s),o+=`
};
`,t.push(o)}return i.length===0&&i.push("layout( location = 0 ) out vec4 fragColor;"),`
`+i.join(`
`)+`

`+t.join(`
`)}getVaryings(e){let t="";const r=this.varyings;if(e==="vertex"||e==="compute")for(const i of r){e==="compute"&&(i.needsInterpolation=!0);const s=this.getType(i.type);if(i.needsInterpolation)if(i.interpolationType){const o=q0[i.interpolationType]||i.interpolationType,a=X0[i.interpolationSampling]||"";t+=`${o} ${a} out ${s} ${i.name};
`}else{const o=s.includes("int")||s.includes("uv")||s.includes("iv")?"flat ":"";t+=`${o}out ${s} ${i.name};
`}else t+=`${s} ${i.name};
`}else if(e==="fragment"){for(const i of r)if(i.needsInterpolation){const s=this.getType(i.type);if(i.interpolationType){const o=q0[i.interpolationType]||i.interpolationType,a=X0[i.interpolationSampling]||"";t+=`${o} ${a} in ${s} ${i.name};
`}else{const o=s.includes("int")||s.includes("uv")||s.includes("iv")?"flat ":"";t+=`${o}in ${s} ${i.name};
`}}}for(const i of this.builtins[e])t+=`${i};
`;return t}getVertexIndex(){return"uint( gl_VertexID )"}getInstanceIndex(){return"uint( gl_InstanceID )"}getInvocationLocalIndex(){return`uint( gl_InstanceID ) % ${this.object.workgroupSize.reduce((r,i)=>r*i,1)}u`}getSubgroupSize(){ie("GLSLNodeBuilder: WebGLBackend does not support the subgroupSize node")}getInvocationSubgroupIndex(){ie("GLSLNodeBuilder: WebGLBackend does not support the invocationSubgroupIndex node")}getSubgroupIndex(){ie("GLSLNodeBuilder: WebGLBackend does not support the subgroupIndex node")}getDrawIndex(){return this.renderer.backend.extensions.has("WEBGL_multi_draw")?"uint( gl_DrawID )":null}getFrontFacing(){return"gl_FrontFacing"}getFragCoord(){return"gl_FragCoord.xy"}getFragDepth(){return"gl_FragDepth"}enableExtension(e,t,r=this.shaderStage){const i=this.extensions[r]||(this.extensions[r]=new Map);i.has(e)===!1&&i.set(e,{name:e,behavior:t})}getExtensions(e){const t=[];if(e==="vertex"){const i=this.renderer.backend.extensions;this.object.isBatchedMesh&&i.has("WEBGL_multi_draw")&&this.enableExtension("GL_ANGLE_multi_draw","require",e)}const r=this.extensions[e];if(r!==void 0)for(const{name:i,behavior:s}of r.values())t.push(`#extension ${i} : ${s}`);return t.join(`
`)}getClipDistance(){return"gl_ClipDistance"}isAvailable(e){let t=W0[e];if(t===void 0){let r;switch(t=!1,e){case"float32Filterable":r="OES_texture_float_linear";break;case"clipDistance":r="WEBGL_clip_cull_distance";break}if(r!==void 0){const i=this.renderer.backend.extensions;i.has(r)&&(i.get(r),t=!0)}W0[e]=t}return t}isFlipY(){return!0}enableHardwareClipping(e){this.enableExtension("GL_ANGLE_clip_cull_distance","require"),this.builtins.vertex.push(`out float gl_ClipDistance[ ${e} ]`)}enableMultiview(){this.enableExtension("GL_OVR_multiview2","require","fragment"),this.enableExtension("GL_OVR_multiview2","require","vertex"),this.builtins.vertex.push("layout(num_views = 2) in")}registerTransform(e,t){this.transforms.push({varyingName:e,attributeNode:t})}getTransforms(){const e=this.transforms;let t="";for(let r=0;r<e.length;r++){const i=e[r],s=this.getPropertyName(i.attributeNode);s&&(t+=`${i.varyingName} = ${s};
	`)}return t}_getGLSLUniformStruct(e,t){return`
layout( std140 ) uniform ${e} {
${t}
};`}_getGLSLVertexCode(e){return`#version 300 es

${this.getSignature()}

// extensions
${e.extensions}

// precision
${Y0}

// uniforms
${e.uniforms}

// varyings
${e.varyings}

// attributes
${e.attributes}

// codes
${e.codes}

void main() {

	// vars
	${e.vars}

	// transforms
	${e.transforms}

	// flow
	${e.flow}

	gl_PointSize = 1.0;

}
`}_getGLSLFragmentCode(e){return`#version 300 es

${this.getSignature()}

// extensions
${e.extensions}

// precision
${Y0}

// structs
${e.structs}

// uniforms
${e.uniforms}

// varyings
${e.varyings}

// codes
${e.codes}

void main() {

	// vars
	${e.vars}

	// flow
	${e.flow}

}
`}buildCode(){const e=this.material!==null?{fragment:{},vertex:{}}:{compute:{}};this.sortBindingGroups();for(const t in e){let r=`// code

`;r+=this.flowCode[t];const i=this.flowNodes[t],s=i[i.length-1];for(const a of i){const c=this.getFlowData(a),l=a.name;l&&(r.length>0&&(r+=`
`),r+=`	// flow -> ${l}
	`),r+=`${c.code}
	`,a===s&&t!=="compute"&&(r+=`// result
	`,t==="vertex"?(r+="gl_Position = ",r+=`${c.result};`):t==="fragment"&&(a.outputNode.isOutputStructNode||(r+="fragColor = ",r+=`${c.result};`)))}const o=e[t];o.extensions=this.getExtensions(t),o.uniforms=this.getUniforms(t),o.attributes=this.getAttributes(t),o.varyings=this.getVaryings(t),o.vars=this.getVars(t),o.structs=this.getStructs(t),o.codes=this.getCodes(t),o.transforms=this.getTransforms(t),o.flow=r}this.material!==null?(this.vertexShader=this._getGLSLVertexCode(e.vertex),this.fragmentShader=this._getGLSLFragmentCode(e.fragment)):this.computeShader=this._getGLSLVertexCode(e.compute)}getUniformFromNode(e,t,r,i=null){const s=super.getUniformFromNode(e,t,r,i),o=this.getDataFromNode(e,r,this.globalCache);let a=o.uniformGPU;if(a===void 0){const c=e.groupNode,l=c.name,u=this.getBindGroupArray(l,r);if(t==="texture")a=new Wl(s.name,s.node,c),u.push(a);else if(t==="cubeTexture")a=new HT(s.name,s.node,c),u.push(a);else if(t==="texture3D")a=new Oh(s.name,s.node,c),u.push(a);else if(t==="buffer"){e.name=`NodeBuffer_${e.id}`,s.name=`buffer${e.id}`;const d=new VT(e,c);d.name=e.name,u.push(d),a=d}else{const d=this.uniformGroups[r]||(this.uniformGroups[r]={});let h=d[l];h===void 0&&(h=new zT(r+"_"+l,c),d[l]=h,u.push(h)),a=this.getNodeUniform(s,t),h.addUniform(a)}o.uniformGPU=a}return s}}let rd=null,Ji=null;class WT{constructor(e={}){this.parameters=Object.assign({},e),this.data=new WeakMap,this.renderer=null,this.domElement=null,this.timestampQueryPool={[Ln.RENDER]:null,[Ln.COMPUTE]:null},this.trackTimestamp=e.trackTimestamp===!0}async init(e){this.renderer=e}get coordinateSystem(){}beginRender(){}finishRender(){}beginCompute(){}finishCompute(){}draw(){}compute(){}createProgram(){}destroyProgram(){}createBindings(){}updateBindings(){}updateBinding(){}createRenderPipeline(){}createComputePipeline(){}needsRenderUpdate(){}getRenderCacheKey(){}createNodeBuilder(){}updateSampler(){}createDefaultTexture(){}createTexture(){}updateTexture(){}generateMipmaps(){}destroyTexture(){}async copyTextureToBuffer(){}copyTextureToTexture(){}copyFramebufferToTexture(){}createAttribute(){}createIndexAttribute(){}createStorageAttribute(){}updateAttribute(){}destroyAttribute(){}getContext(){}updateSize(){}updateViewport(){}updateTimeStampUID(e){const t=this.get(e),r=this.renderer.info.frame;let i;e.isComputeNode===!0?i="c:"+this.renderer.info.compute.frameCalls:i="r:"+this.renderer.info.render.frameCalls,t.timestampUID=i+":"+e.id+":f"+r}getTimestampUID(e){return this.get(e).timestampUID}getTimestampFrames(e){const t=this.timestampQueryPool[e];return t?t.getTimestampFrames():[]}_getQueryPool(e){const t=e.startsWith("c:")?Ln.COMPUTE:Ln.RENDER;return this.timestampQueryPool[t]}getTimestamp(e){return this._getQueryPool(e).getTimestamp(e)}hasTimestamp(e){return this._getQueryPool(e).hasTimestamp(e)}isOccluded(){}async resolveTimestampsAsync(e="render"){if(!this.trackTimestamp){lt("WebGPURenderer: Timestamp tracking is disabled.");return}const t=this.timestampQueryPool[e];if(!t)return;const r=await t.resolveQueriesAsync();return this.renderer.info[e].timestamp=r,r}async getArrayBufferAsync(){}async hasFeatureAsync(){}hasFeature(){}getMaxAnisotropy(){}getDrawingBufferSize(){return rd=rd||new Te,this.renderer.getDrawingBufferSize(rd)}setScissorTest(){}getClearColor(){const e=this.renderer;return Ji=Ji||new hp,e.getClearColor(Ji),Ji.getRGB(Ji),Ji}getDomElement(){let e=this.domElement;return e===null&&(e=this.parameters.canvas!==void 0?this.parameters.canvas:Dw(),"setAttribute"in e&&e.setAttribute("data-engine",`three.js r${bl} webgpu`),this.domElement=e),e}set(e,t){this.data.set(e,t)}get(e){let t=this.data.get(e);return t===void 0&&(t={},this.data.set(e,t)),t}has(e){return this.data.has(e)}delete(e){this.data.delete(e)}dispose(){}}let IG=0;class LG{constructor(e,t){this.buffers=[e.bufferGPU,t],this.type=e.type,this.bufferType=e.bufferType,this.pbo=e.pbo,this.byteLength=e.byteLength,this.bytesPerElement=e.BYTES_PER_ELEMENT,this.version=e.version,this.isInteger=e.isInteger,this.activeBufferIndex=0,this.baseId=e.id}get id(){return`${this.baseId}|${this.activeBufferIndex}`}get bufferGPU(){return this.buffers[this.activeBufferIndex]}get transformBuffer(){return this.buffers[this.activeBufferIndex^1]}switchBuffers(){this.activeBufferIndex^=1}}class OG{constructor(e){this.backend=e}createAttribute(e,t){const r=this.backend,{gl:i}=r,s=e.array,o=e.usage||i.STATIC_DRAW,a=e.isInterleavedBufferAttribute?e.data:e,c=r.get(a);let l=c.bufferGPU;l===void 0&&(l=this._createBuffer(i,t,s,o),c.bufferGPU=l,c.bufferType=t,c.version=a.version);let u;if(s instanceof Float32Array)u=i.FLOAT;else if(typeof Float16Array<"u"&&s instanceof Float16Array)u=i.HALF_FLOAT;else if(s instanceof Uint16Array)e.isFloat16BufferAttribute?u=i.HALF_FLOAT:u=i.UNSIGNED_SHORT;else if(s instanceof Int16Array)u=i.SHORT;else if(s instanceof Uint32Array)u=i.UNSIGNED_INT;else if(s instanceof Int32Array)u=i.INT;else if(s instanceof Int8Array)u=i.BYTE;else if(s instanceof Uint8Array)u=i.UNSIGNED_BYTE;else if(s instanceof Uint8ClampedArray)u=i.UNSIGNED_BYTE;else throw new Error("THREE.WebGLBackend: Unsupported buffer data format: "+s);let d={bufferGPU:l,bufferType:t,type:u,byteLength:s.byteLength,bytesPerElement:s.BYTES_PER_ELEMENT,version:e.version,pbo:e.pbo,isInteger:u===i.INT||u===i.UNSIGNED_INT||e.gpuType===Pt,id:IG++};if(e.isStorageBufferAttribute||e.isStorageInstancedBufferAttribute){const h=this._createBuffer(i,t,s,o);d=new LG(d,h)}r.set(e,d)}updateAttribute(e){const t=this.backend,{gl:r}=t,i=e.array,s=e.isInterleavedBufferAttribute?e.data:e,o=t.get(s),a=o.bufferType,c=e.isInterleavedBufferAttribute?e.data.updateRanges:e.updateRanges;if(r.bindBuffer(a,o.bufferGPU),c.length===0)r.bufferSubData(a,0,i);else{for(let l=0,u=c.length;l<u;l++){const d=c[l];r.bufferSubData(a,d.start*i.BYTES_PER_ELEMENT,i,d.start,d.count)}s.clearUpdateRanges()}r.bindBuffer(a,null),o.version=s.version}destroyAttribute(e){const t=this.backend,{gl:r}=t;e.isInterleavedBufferAttribute&&t.delete(e.data);const i=t.get(e);r.deleteBuffer(i.bufferGPU),t.delete(e)}async getArrayBufferAsync(e){const t=this.backend,{gl:r}=t,i=e.isInterleavedBufferAttribute?e.data:e,{bufferGPU:s}=t.get(i),o=e.array,a=o.byteLength;r.bindBuffer(r.COPY_READ_BUFFER,s);const c=r.createBuffer();r.bindBuffer(r.COPY_WRITE_BUFFER,c),r.bufferData(r.COPY_WRITE_BUFFER,a,r.STREAM_READ),r.copyBufferSubData(r.COPY_READ_BUFFER,r.COPY_WRITE_BUFFER,0,0,a),await t.utils._clientWaitAsync();const l=new e.array.constructor(o.length);return r.bindBuffer(r.COPY_WRITE_BUFFER,c),r.getBufferSubData(r.COPY_WRITE_BUFFER,0,l),r.deleteBuffer(c),r.bindBuffer(r.COPY_READ_BUFFER,null),r.bindBuffer(r.COPY_WRITE_BUFFER,null),l.buffer}_createBuffer(e,t,r,i){const s=e.createBuffer();return e.bindBuffer(t,s),e.bufferData(t,r,i),e.bindBuffer(t,null),s}}let id,xo;class UG{constructor(e){this.backend=e,this.gl=this.backend.gl,this.enabled={},this.currentFlipSided=null,this.currentCullFace=null,this.currentProgram=null,this.currentBlendingEnabled=!1,this.currentBlending=null,this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentPremultipledAlpha=null,this.currentPolygonOffsetFactor=null,this.currentPolygonOffsetUnits=null,this.currentColorMask=null,this.currentDepthFunc=null,this.currentDepthMask=null,this.currentStencilFunc=null,this.currentStencilRef=null,this.currentStencilFuncMask=null,this.currentStencilFail=null,this.currentStencilZFail=null,this.currentStencilZPass=null,this.currentStencilMask=null,this.currentLineWidth=null,this.currentClippingPlanes=0,this.currentVAO=null,this.currentIndex=null,this.currentBoundFramebuffers={},this.currentDrawbuffers=new WeakMap,this.maxTextures=this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),this.currentTextureSlot=null,this.currentBoundTextures={},this.currentBoundBufferBases={},this._init()}_init(){const e=this.gl;id={[ar]:e.FUNC_ADD,[oy]:e.FUNC_SUBTRACT,[sy]:e.FUNC_REVERSE_SUBTRACT},xo={[Rr]:e.ZERO,[my]:e.ONE,[gy]:e.SRC_COLOR,[py]:e.SRC_ALPHA,[fy]:e.SRC_ALPHA_SATURATE,[hy]:e.DST_COLOR,[dy]:e.DST_ALPHA,[uy]:e.ONE_MINUS_SRC_COLOR,[ly]:e.ONE_MINUS_SRC_ALPHA,[cy]:e.ONE_MINUS_DST_COLOR,[ay]:e.ONE_MINUS_DST_ALPHA};const t=e.getParameter(e.SCISSOR_BOX),r=e.getParameter(e.VIEWPORT);this.currentScissor=new Ze().fromArray(t),this.currentViewport=new Ze().fromArray(r),this._tempVec4=new Ze}enable(e){const{enabled:t}=this;t[e]!==!0&&(this.gl.enable(e),t[e]=!0)}disable(e){const{enabled:t}=this;t[e]!==!1&&(this.gl.disable(e),t[e]=!1)}setFlipSided(e){if(this.currentFlipSided!==e){const{gl:t}=this;e?t.frontFace(t.CW):t.frontFace(t.CCW),this.currentFlipSided=e}}setCullFace(e){const{gl:t}=this;e!==Fw?(this.enable(t.CULL_FACE),e!==this.currentCullFace&&(e===kw?t.cullFace(t.BACK):e===Iw?t.cullFace(t.FRONT):t.cullFace(t.FRONT_AND_BACK))):this.disable(t.CULL_FACE),this.currentCullFace=e}setLineWidth(e){const{currentLineWidth:t,gl:r}=this;e!==t&&(r.lineWidth(e),this.currentLineWidth=e)}setBlending(e,t,r,i,s,o,a,c){const{gl:l}=this;if(e===vs){this.currentBlendingEnabled===!0&&(this.disable(l.BLEND),this.currentBlendingEnabled=!1);return}if(this.currentBlendingEnabled===!1&&(this.enable(l.BLEND),this.currentBlendingEnabled=!0),e!==Ro){if(e!==this.currentBlending||c!==this.currentPremultipledAlpha){if((this.currentBlendEquation!==ar||this.currentBlendEquationAlpha!==ar)&&(l.blendEquation(l.FUNC_ADD),this.currentBlendEquation=ar,this.currentBlendEquationAlpha=ar),c)switch(e){case wi:l.blendFuncSeparate(l.ONE,l.ONE_MINUS_SRC_ALPHA,l.ONE,l.ONE_MINUS_SRC_ALPHA);break;case Fc:l.blendFunc(l.ONE,l.ONE);break;case Bc:l.blendFuncSeparate(l.ZERO,l.ONE_MINUS_SRC_COLOR,l.ZERO,l.ONE);break;case Dc:l.blendFuncSeparate(l.DST_COLOR,l.ONE_MINUS_SRC_ALPHA,l.ZERO,l.ONE);break;default:ie("WebGLState: Invalid blending: ",e);break}else switch(e){case wi:l.blendFuncSeparate(l.SRC_ALPHA,l.ONE_MINUS_SRC_ALPHA,l.ONE,l.ONE_MINUS_SRC_ALPHA);break;case Fc:l.blendFuncSeparate(l.SRC_ALPHA,l.ONE,l.ONE,l.ONE);break;case Bc:ie("WebGLState: SubtractiveBlending requires material.premultipliedAlpha = true");break;case Dc:ie("WebGLState: MultiplyBlending requires material.premultipliedAlpha = true");break;default:ie("WebGLState: Invalid blending: ",e);break}this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentBlending=e,this.currentPremultipledAlpha=c}return}s=s||t,o=o||r,a=a||i,(t!==this.currentBlendEquation||s!==this.currentBlendEquationAlpha)&&(l.blendEquationSeparate(id[t],id[s]),this.currentBlendEquation=t,this.currentBlendEquationAlpha=s),(r!==this.currentBlendSrc||i!==this.currentBlendDst||o!==this.currentBlendSrcAlpha||a!==this.currentBlendDstAlpha)&&(l.blendFuncSeparate(xo[r],xo[i],xo[o],xo[a]),this.currentBlendSrc=r,this.currentBlendDst=i,this.currentBlendSrcAlpha=o,this.currentBlendDstAlpha=a),this.currentBlending=e,this.currentPremultipledAlpha=!1}setColorMask(e){this.currentColorMask!==e&&(this.gl.colorMask(e,e,e,e),this.currentColorMask=e)}setDepthTest(e){const{gl:t}=this;e?this.enable(t.DEPTH_TEST):this.disable(t.DEPTH_TEST)}setDepthMask(e){this.currentDepthMask!==e&&(this.gl.depthMask(e),this.currentDepthMask=e)}setDepthFunc(e){if(this.currentDepthFunc!==e){const{gl:t}=this;switch(e){case Sy:t.depthFunc(t.NEVER);break;case wy:t.depthFunc(t.ALWAYS);break;case Ty:t.depthFunc(t.LESS);break;case vy:t.depthFunc(t.LEQUAL);break;case _y:t.depthFunc(t.EQUAL);break;case by:t.depthFunc(t.GEQUAL);break;case yy:t.depthFunc(t.GREATER);break;case xy:t.depthFunc(t.NOTEQUAL);break;default:t.depthFunc(t.LEQUAL)}this.currentDepthFunc=e}}scissor(e,t,r,i){const s=this._tempVec4.set(e,t,r,i);if(this.currentScissor.equals(s)===!1){const{gl:o}=this;o.scissor(s.x,s.y,s.z,s.w),this.currentScissor.copy(s)}}viewport(e,t,r,i){const s=this._tempVec4.set(e,t,r,i);if(this.currentViewport.equals(s)===!1){const{gl:o}=this;o.viewport(s.x,s.y,s.z,s.w),this.currentViewport.copy(s)}}setScissorTest(e){const t=this.gl;e?t.enable(t.SCISSOR_TEST):t.disable(t.SCISSOR_TEST)}setStencilTest(e){const{gl:t}=this;e?this.enable(t.STENCIL_TEST):this.disable(t.STENCIL_TEST)}setStencilMask(e){this.currentStencilMask!==e&&(this.gl.stencilMask(e),this.currentStencilMask=e)}setStencilFunc(e,t,r){(this.currentStencilFunc!==e||this.currentStencilRef!==t||this.currentStencilFuncMask!==r)&&(this.gl.stencilFunc(e,t,r),this.currentStencilFunc=e,this.currentStencilRef=t,this.currentStencilFuncMask=r)}setStencilOp(e,t,r){(this.currentStencilFail!==e||this.currentStencilZFail!==t||this.currentStencilZPass!==r)&&(this.gl.stencilOp(e,t,r),this.currentStencilFail=e,this.currentStencilZFail=t,this.currentStencilZPass=r)}setMaterial(e,t,r){const{gl:i}=this;e.side===vi?this.disable(i.CULL_FACE):this.enable(i.CULL_FACE);let s=e.side===jt;t&&(s=!s),this.setFlipSided(s),e.blending===wi&&e.transparent===!1?this.setBlending(vs):this.setBlending(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.premultipliedAlpha),this.setDepthFunc(e.depthFunc),this.setDepthTest(e.depthTest),this.setDepthMask(e.depthWrite),this.setColorMask(e.colorWrite);const o=e.stencilWrite;if(this.setStencilTest(o),o&&(this.setStencilMask(e.stencilWriteMask),this.setStencilFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask),this.setStencilOp(e.stencilFail,e.stencilZFail,e.stencilZPass)),this.setPolygonOffset(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits),e.alphaToCoverage===!0&&this.backend.renderer.currentSamples>0?this.enable(i.SAMPLE_ALPHA_TO_COVERAGE):this.disable(i.SAMPLE_ALPHA_TO_COVERAGE),r>0&&this.currentClippingPlanes!==r)for(let c=0;c<8;c++)c<r?this.enable(12288+c):this.disable(12288+c)}setPolygonOffset(e,t,r){const{gl:i}=this;e?(this.enable(i.POLYGON_OFFSET_FILL),(this.currentPolygonOffsetFactor!==t||this.currentPolygonOffsetUnits!==r)&&(i.polygonOffset(t,r),this.currentPolygonOffsetFactor=t,this.currentPolygonOffsetUnits=r)):this.disable(i.POLYGON_OFFSET_FILL)}useProgram(e){return this.currentProgram!==e?(this.gl.useProgram(e),this.currentProgram=e,!0):!1}setVertexState(e,t=null){const r=this.gl;return this.currentVAO!==e||this.currentIndex!==t?(r.bindVertexArray(e),t!==null&&r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t),this.currentVAO=e,this.currentIndex=t,!0):!1}resetVertexState(){const e=this.gl;e.bindVertexArray(null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),this.currentVAO=null,this.currentIndex=null}bindFramebuffer(e,t){const{gl:r,currentBoundFramebuffers:i}=this;return i[e]!==t?(r.bindFramebuffer(e,t),i[e]=t,e===r.DRAW_FRAMEBUFFER&&(i[r.FRAMEBUFFER]=t),e===r.FRAMEBUFFER&&(i[r.DRAW_FRAMEBUFFER]=t),!0):!1}drawBuffers(e,t){const{gl:r}=this;let i=[],s=!1;if(e.textures!==null){i=this.currentDrawbuffers.get(t),i===void 0&&(i=[],this.currentDrawbuffers.set(t,i));const o=e.textures;if(i.length!==o.length||i[0]!==r.COLOR_ATTACHMENT0){for(let a=0,c=o.length;a<c;a++)i[a]=r.COLOR_ATTACHMENT0+a;i.length=o.length,s=!0}}else i[0]!==r.BACK&&(i[0]=r.BACK,s=!0);s&&r.drawBuffers(i)}activeTexture(e){const{gl:t,currentTextureSlot:r,maxTextures:i}=this;e===void 0&&(e=t.TEXTURE0+i-1),r!==e&&(t.activeTexture(e),this.currentTextureSlot=e)}bindTexture(e,t,r){const{gl:i,currentTextureSlot:s,currentBoundTextures:o,maxTextures:a}=this;r===void 0&&(s===null?r=i.TEXTURE0+a-1:r=s);let c=o[r];c===void 0&&(c={type:void 0,texture:void 0},o[r]=c),(c.type!==e||c.texture!==t)&&(s!==r&&(i.activeTexture(r),this.currentTextureSlot=r),i.bindTexture(e,t),c.type=e,c.texture=t)}bindBufferBase(e,t,r){const{gl:i}=this,s=`${e}-${t}`;return this.currentBoundBufferBases[s]!==r?(i.bindBufferBase(e,t,r),this.currentBoundBufferBases[s]=r,!0):!1}unbindTexture(){const{gl:e,currentTextureSlot:t,currentBoundTextures:r}=this,i=r[t];i!==void 0&&i.type!==void 0&&(e.bindTexture(i.type,null),i.type=void 0,i.texture=void 0)}}class GG{constructor(e){this.backend=e,this.gl=this.backend.gl,this.extensions=e.extensions}convert(e,t=_s){const{gl:r,extensions:i}=this;let s;const o=ut.getTransfer(t);if(e===Qt)return r.UNSIGNED_BYTE;if(e===Lw)return r.UNSIGNED_SHORT_4_4_4_4;if(e===Ow)return r.UNSIGNED_SHORT_5_5_5_1;if(e===Ny)return r.UNSIGNED_INT_5_9_9_9_REV;if(e===Ey)return r.UNSIGNED_INT_10F_11F_11F_REV;if(e===Co)return r.BYTE;if(e===Mo)return r.SHORT;if(e===is)return r.UNSIGNED_SHORT;if(e===Pt)return r.INT;if(e===dt)return r.UNSIGNED_INT;if(e===nn)return r.FLOAT;if(e===Ft)return r.HALF_FLOAT;if(e===Uw)return r.ALPHA;if(e===df)return r.RGB;if(e===_n)return r.RGBA;if(e===Ur)return r.DEPTH_COMPONENT;if(e===Or)return r.DEPTH_STENCIL;if(e===hf)return r.RED;if(e===ff)return r.RED_INTEGER;if(e===Fr)return r.RG;if(e===pf)return r.RG_INTEGER;if(e===gf)return r.RGBA_INTEGER;if(e===fc||e===pc||e===gc||e===mc)if(o===ye)if(s=i.get("WEBGL_compressed_texture_s3tc_srgb"),s!==null){if(e===fc)return s.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(e===pc)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(e===gc)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(e===mc)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else return null;else if(s=i.get("WEBGL_compressed_texture_s3tc"),s!==null){if(e===fc)return s.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===pc)return s.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===gc)return s.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===mc)return s.COMPRESSED_RGBA_S3TC_DXT5_EXT}else return null;if(e===Fp||e===kp||e===Ip||e===Lp)if(s=i.get("WEBGL_compressed_texture_pvrtc"),s!==null){if(e===Fp)return s.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===kp)return s.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===Ip)return s.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===Lp)return s.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}else return null;if(e===Ad||e===Rd||e===Cd)if(s=i.get("WEBGL_compressed_texture_etc"),s!==null){if(e===Ad||e===Rd)return o===ye?s.COMPRESSED_SRGB8_ETC2:s.COMPRESSED_RGB8_ETC2;if(e===Cd)return o===ye?s.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:s.COMPRESSED_RGBA8_ETC2_EAC}else return null;if(e===Md||e===Pd||e===Dd||e===Bd||e===Fd||e===kd||e===Id||e===Ld||e===Od||e===Ud||e===Gd||e===$d||e===Vd||e===zd)if(s=i.get("WEBGL_compressed_texture_astc"),s!==null){if(e===Md)return o===ye?s.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:s.COMPRESSED_RGBA_ASTC_4x4_KHR;if(e===Pd)return o===ye?s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:s.COMPRESSED_RGBA_ASTC_5x4_KHR;if(e===Dd)return o===ye?s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:s.COMPRESSED_RGBA_ASTC_5x5_KHR;if(e===Bd)return o===ye?s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:s.COMPRESSED_RGBA_ASTC_6x5_KHR;if(e===Fd)return o===ye?s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:s.COMPRESSED_RGBA_ASTC_6x6_KHR;if(e===kd)return o===ye?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:s.COMPRESSED_RGBA_ASTC_8x5_KHR;if(e===Id)return o===ye?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:s.COMPRESSED_RGBA_ASTC_8x6_KHR;if(e===Ld)return o===ye?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:s.COMPRESSED_RGBA_ASTC_8x8_KHR;if(e===Od)return o===ye?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:s.COMPRESSED_RGBA_ASTC_10x5_KHR;if(e===Ud)return o===ye?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:s.COMPRESSED_RGBA_ASTC_10x6_KHR;if(e===Gd)return o===ye?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:s.COMPRESSED_RGBA_ASTC_10x8_KHR;if(e===$d)return o===ye?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:s.COMPRESSED_RGBA_ASTC_10x10_KHR;if(e===Vd)return o===ye?s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:s.COMPRESSED_RGBA_ASTC_12x10_KHR;if(e===zd)return o===ye?s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:s.COMPRESSED_RGBA_ASTC_12x12_KHR}else return null;if(e===jd)if(s=i.get("EXT_texture_compression_bptc"),s!==null){if(e===jd)return o===ye?s.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:s.COMPRESSED_RGBA_BPTC_UNORM_EXT}else return null;if(e===Hd||e===Wd||e===qd||e===Xd)if(s=i.get("EXT_texture_compression_rgtc"),s!==null){if(e===Hd)return s.COMPRESSED_RED_RGTC1_EXT;if(e===Wd)return s.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(e===qd)return s.COMPRESSED_RED_GREEN_RGTC2_EXT;if(e===Xd)return s.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}else return null;return e===Lr?r.UNSIGNED_INT_24_8:r[e]!==void 0?r[e]:null}_clientWaitAsync(){const{gl:e}=this,t=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0);return e.flush(),new Promise((r,i)=>{function s(){const o=e.clientWaitSync(t,e.SYNC_FLUSH_COMMANDS_BIT,0);if(o===e.WAIT_FAILED){e.deleteSync(t),i();return}if(o===e.TIMEOUT_EXPIRED){requestAnimationFrame(s);return}e.deleteSync(t),r()}s()})}}let K0=!1,Ja,sd,Q0;class $G{constructor(e){this.backend=e,this.gl=e.gl,this.extensions=e.extensions,this.defaultTextures={},this._srcFramebuffer=null,this._dstFramebuffer=null,K0===!1&&(this._init(),K0=!0)}_init(){const e=this.gl;Ja={[Tl]:e.REPEAT,[$o]:e.CLAMP_TO_EDGE,[vl]:e.MIRRORED_REPEAT},sd={[xn]:e.NEAREST,[Qx]:e.NEAREST_MIPMAP_NEAREST,[Vo]:e.NEAREST_MIPMAP_LINEAR,[Sn]:e.LINEAR,[Ed]:e.LINEAR_MIPMAP_NEAREST,[Ti]:e.LINEAR_MIPMAP_LINEAR},Q0={[iy]:e.NEVER,[ry]:e.ALWAYS,[uf]:e.LESS,[ny]:e.LEQUAL,[ty]:e.EQUAL,[ey]:e.GEQUAL,[Jx]:e.GREATER,[Zx]:e.NOTEQUAL}}getGLTextureType(e){const{gl:t}=this;let r;return e.isCubeTexture===!0?r=t.TEXTURE_CUBE_MAP:e.isArrayTexture===!0||e.isDataArrayTexture===!0||e.isCompressedArrayTexture===!0?r=t.TEXTURE_2D_ARRAY:e.isData3DTexture===!0?r=t.TEXTURE_3D:r=t.TEXTURE_2D,r}getInternalFormat(e,t,r,i,s=!1){const{gl:o,extensions:a}=this;if(e!==null){if(o[e]!==void 0)return o[e];se("WebGLBackend: Attempt to use non-existing WebGL internal format '"+e+"'")}let c=t;if(t===o.RED&&(r===o.FLOAT&&(c=o.R32F),r===o.HALF_FLOAT&&(c=o.R16F),r===o.UNSIGNED_BYTE&&(c=o.R8),r===o.UNSIGNED_SHORT&&(c=o.R16),r===o.UNSIGNED_INT&&(c=o.R32UI),r===o.BYTE&&(c=o.R8I),r===o.SHORT&&(c=o.R16I),r===o.INT&&(c=o.R32I)),t===o.RED_INTEGER&&(r===o.UNSIGNED_BYTE&&(c=o.R8UI),r===o.UNSIGNED_SHORT&&(c=o.R16UI),r===o.UNSIGNED_INT&&(c=o.R32UI),r===o.BYTE&&(c=o.R8I),r===o.SHORT&&(c=o.R16I),r===o.INT&&(c=o.R32I)),t===o.RG&&(r===o.FLOAT&&(c=o.RG32F),r===o.HALF_FLOAT&&(c=o.RG16F),r===o.UNSIGNED_BYTE&&(c=o.RG8),r===o.UNSIGNED_SHORT&&(c=o.RG16),r===o.UNSIGNED_INT&&(c=o.RG32UI),r===o.BYTE&&(c=o.RG8I),r===o.SHORT&&(c=o.RG16I),r===o.INT&&(c=o.RG32I)),t===o.RG_INTEGER&&(r===o.UNSIGNED_BYTE&&(c=o.RG8UI),r===o.UNSIGNED_SHORT&&(c=o.RG16UI),r===o.UNSIGNED_INT&&(c=o.RG32UI),r===o.BYTE&&(c=o.RG8I),r===o.SHORT&&(c=o.RG16I),r===o.INT&&(c=o.RG32I)),t===o.RGB){const l=s?Bp:ut.getTransfer(i);r===o.FLOAT&&(c=o.RGB32F),r===o.HALF_FLOAT&&(c=o.RGB16F),r===o.UNSIGNED_BYTE&&(c=o.RGB8),r===o.UNSIGNED_SHORT&&(c=o.RGB16),r===o.UNSIGNED_INT&&(c=o.RGB32UI),r===o.BYTE&&(c=o.RGB8I),r===o.SHORT&&(c=o.RGB16I),r===o.INT&&(c=o.RGB32I),r===o.UNSIGNED_BYTE&&(c=l===ye?o.SRGB8:o.RGB8),r===o.UNSIGNED_SHORT_5_6_5&&(c=o.RGB565),r===o.UNSIGNED_SHORT_5_5_5_1&&(c=o.RGB5_A1),r===o.UNSIGNED_SHORT_4_4_4_4&&(c=o.RGB4),r===o.UNSIGNED_INT_5_9_9_9_REV&&(c=o.RGB9_E5),r===o.UNSIGNED_INT_10F_11F_11F_REV&&(c=o.R11F_G11F_B10F)}if(t===o.RGB_INTEGER&&(r===o.UNSIGNED_BYTE&&(c=o.RGB8UI),r===o.UNSIGNED_SHORT&&(c=o.RGB16UI),r===o.UNSIGNED_INT&&(c=o.RGB32UI),r===o.BYTE&&(c=o.RGB8I),r===o.SHORT&&(c=o.RGB16I),r===o.INT&&(c=o.RGB32I)),t===o.RGBA){const l=s?Bp:ut.getTransfer(i);r===o.FLOAT&&(c=o.RGBA32F),r===o.HALF_FLOAT&&(c=o.RGBA16F),r===o.UNSIGNED_BYTE&&(c=o.RGBA8),r===o.UNSIGNED_SHORT&&(c=o.RGBA16),r===o.UNSIGNED_INT&&(c=o.RGBA32UI),r===o.BYTE&&(c=o.RGBA8I),r===o.SHORT&&(c=o.RGBA16I),r===o.INT&&(c=o.RGBA32I),r===o.UNSIGNED_BYTE&&(c=l===ye?o.SRGB8_ALPHA8:o.RGBA8),r===o.UNSIGNED_SHORT_4_4_4_4&&(c=o.RGBA4),r===o.UNSIGNED_SHORT_5_5_5_1&&(c=o.RGB5_A1)}return t===o.RGBA_INTEGER&&(r===o.UNSIGNED_BYTE&&(c=o.RGBA8UI),r===o.UNSIGNED_SHORT&&(c=o.RGBA16UI),r===o.UNSIGNED_INT&&(c=o.RGBA32UI),r===o.BYTE&&(c=o.RGBA8I),r===o.SHORT&&(c=o.RGBA16I),r===o.INT&&(c=o.RGBA32I)),t===o.DEPTH_COMPONENT&&(r===o.UNSIGNED_SHORT&&(c=o.DEPTH_COMPONENT16),r===o.UNSIGNED_INT&&(c=o.DEPTH_COMPONENT24),r===o.FLOAT&&(c=o.DEPTH_COMPONENT32F)),t===o.DEPTH_STENCIL&&r===o.UNSIGNED_INT_24_8&&(c=o.DEPTH24_STENCIL8),(c===o.R16F||c===o.R32F||c===o.RG16F||c===o.RG32F||c===o.RGBA16F||c===o.RGBA32F)&&a.get("EXT_color_buffer_float"),c}setTextureParameters(e,t){const{gl:r,extensions:i,backend:s}=this,o=ut.getPrimaries(ut.workingColorSpace),a=t.colorSpace===_s?null:ut.getPrimaries(t.colorSpace),c=t.colorSpace===_s||o===a?r.NONE:r.BROWSER_DEFAULT_WEBGL;r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,t.flipY),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),r.pixelStorei(r.UNPACK_ALIGNMENT,t.unpackAlignment),r.pixelStorei(r.UNPACK_COLORSPACE_CONVERSION_WEBGL,c),r.texParameteri(e,r.TEXTURE_WRAP_S,Ja[t.wrapS]),r.texParameteri(e,r.TEXTURE_WRAP_T,Ja[t.wrapT]),(e===r.TEXTURE_3D||e===r.TEXTURE_2D_ARRAY)&&(t.isArrayTexture||r.texParameteri(e,r.TEXTURE_WRAP_R,Ja[t.wrapR])),r.texParameteri(e,r.TEXTURE_MAG_FILTER,sd[t.magFilter]);const l=t.mipmaps!==void 0&&t.mipmaps.length>0,u=t.minFilter===Sn&&l?Ti:t.minFilter;if(r.texParameteri(e,r.TEXTURE_MIN_FILTER,sd[u]),t.compareFunction&&(r.texParameteri(e,r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE),r.texParameteri(e,r.TEXTURE_COMPARE_FUNC,Q0[t.compareFunction])),i.has("EXT_texture_filter_anisotropic")===!0){if(t.magFilter===xn||t.minFilter!==Vo&&t.minFilter!==Ti||t.type===nn&&i.has("OES_texture_float_linear")===!1)return;if(t.anisotropy>1){const d=i.get("EXT_texture_filter_anisotropic");r.texParameterf(e,d.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(t.anisotropy,s.getMaxAnisotropy()))}}}createDefaultTexture(e){const{gl:t,backend:r,defaultTextures:i}=this,s=this.getGLTextureType(e);let o=i[s];o===void 0&&(o=t.createTexture(),r.state.bindTexture(s,o),t.texParameteri(s,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(s,t.TEXTURE_MAG_FILTER,t.NEAREST),i[s]=o),r.set(e,{textureGPU:o,glTextureType:s})}createTexture(e,t){const{gl:r,backend:i}=this,{levels:s,width:o,height:a,depth:c}=t,l=i.utils.convert(e.format,e.colorSpace),u=i.utils.convert(e.type),d=this.getInternalFormat(e.internalFormat,l,u,e.colorSpace,e.isVideoTexture),h=r.createTexture(),f=this.getGLTextureType(e);i.state.bindTexture(f,h),this.setTextureParameters(f,e),e.isArrayTexture||e.isDataArrayTexture||e.isCompressedArrayTexture?r.texStorage3D(r.TEXTURE_2D_ARRAY,s,d,o,a,c):e.isData3DTexture?r.texStorage3D(r.TEXTURE_3D,s,d,o,a,c):e.isVideoTexture||r.texStorage2D(f,s,d,o,a),i.set(e,{textureGPU:h,glTextureType:f,glFormat:l,glType:u,glInternalFormat:d})}copyBufferToTexture(e,t){const{gl:r,backend:i}=this,{textureGPU:s,glTextureType:o,glFormat:a,glType:c}=i.get(t),{width:l,height:u}=t.source.data;r.bindBuffer(r.PIXEL_UNPACK_BUFFER,e),i.state.bindTexture(o,s),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!1),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),r.texSubImage2D(o,0,0,0,l,u,a,c,0),r.bindBuffer(r.PIXEL_UNPACK_BUFFER,null),i.state.unbindTexture()}updateTexture(e,t){const{gl:r}=this,{width:i,height:s}=t,{textureGPU:o,glTextureType:a,glFormat:c,glType:l,glInternalFormat:u}=this.backend.get(e);if(!(e.isRenderTargetTexture||o===void 0))if(this.backend.state.bindTexture(a,o),this.setTextureParameters(a,e),e.isCompressedTexture){const d=e.mipmaps,h=t.image;for(let f=0;f<d.length;f++){const p=d[f];e.isCompressedArrayTexture?e.format!==r.RGBA?c!==null?r.compressedTexSubImage3D(r.TEXTURE_2D_ARRAY,f,0,0,0,p.width,p.height,h.depth,c,p.data):se("WebGLBackend: Attempt to load unsupported compressed texture format in .uploadTexture()"):r.texSubImage3D(r.TEXTURE_2D_ARRAY,f,0,0,0,p.width,p.height,h.depth,c,l,p.data):c!==null?r.compressedTexSubImage2D(r.TEXTURE_2D,f,0,0,p.width,p.height,c,p.data):se("WebGLBackend: Unsupported compressed texture format")}}else if(e.isCubeTexture){const d=t.images,h=e.mipmaps;for(let f=0;f<6;f++){const p=ec(d[f]);r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+f,0,0,0,i,s,c,l,p);for(let g=0;g<h.length;g++){const x=h[g],m=ec(x.images[f]);r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+f,g+1,0,0,m.width,m.height,c,l,m)}}}else if(e.isDataArrayTexture||e.isArrayTexture){const d=t.image;if(e.layerUpdates.size>0){const h=Bw(d.width,d.height,e.format,e.type);for(const f of e.layerUpdates){const p=d.data.subarray(f*h/d.data.BYTES_PER_ELEMENT,(f+1)*h/d.data.BYTES_PER_ELEMENT);r.texSubImage3D(r.TEXTURE_2D_ARRAY,0,0,0,f,d.width,d.height,1,c,l,p)}e.clearLayerUpdates()}else r.texSubImage3D(r.TEXTURE_2D_ARRAY,0,0,0,0,d.width,d.height,d.depth,c,l,d.data)}else if(e.isData3DTexture){const d=t.image;r.texSubImage3D(r.TEXTURE_3D,0,0,0,0,d.width,d.height,d.depth,c,l,d.data)}else if(e.isVideoTexture)e.update(),r.texImage2D(a,0,u,c,l,t.image);else{const d=e.mipmaps;if(d.length>0)for(let h=0,f=d.length;h<f;h++){const p=d[h],g=ec(p);r.texSubImage2D(a,h,0,0,p.width,p.height,c,l,g)}else{const h=ec(t.image);r.texSubImage2D(a,0,0,0,i,s,c,l,h)}}}generateMipmaps(e){const{gl:t,backend:r}=this,{textureGPU:i,glTextureType:s}=r.get(e);r.state.bindTexture(s,i),t.generateMipmap(s)}deallocateRenderBuffers(e){const{gl:t,backend:r}=this;if(e){const i=r.get(e);if(i.renderBufferStorageSetup=void 0,i.framebuffers){for(const s in i.framebuffers)t.deleteFramebuffer(i.framebuffers[s]);delete i.framebuffers}if(i.depthRenderbuffer&&(t.deleteRenderbuffer(i.depthRenderbuffer),delete i.depthRenderbuffer),i.stencilRenderbuffer&&(t.deleteRenderbuffer(i.stencilRenderbuffer),delete i.stencilRenderbuffer),i.msaaFrameBuffer&&(t.deleteFramebuffer(i.msaaFrameBuffer),delete i.msaaFrameBuffer),i.msaaRenderbuffers){for(let s=0;s<i.msaaRenderbuffers.length;s++)t.deleteRenderbuffer(i.msaaRenderbuffers[s]);delete i.msaaRenderbuffers}}}destroyTexture(e,t=!1){const{gl:r,backend:i}=this,{textureGPU:s,renderTarget:o}=i.get(e);this.deallocateRenderBuffers(o),t===!1&&r.deleteTexture(s),i.delete(e)}copyTextureToTexture(e,t,r=null,i=null,s=0,o=0){const{gl:a,backend:c}=this,{state:l}=this.backend,{textureGPU:u,glTextureType:d,glType:h,glFormat:f}=c.get(t);l.bindTexture(d,u);let p,g,x,m,y,_,v,T,w;const N=e.isCompressedTexture?e.mipmaps[o]:e.image;if(r!==null)p=r.max.x-r.min.x,g=r.max.y-r.min.y,x=r.isBox3?r.max.z-r.min.z:1,m=r.min.x,y=r.min.y,_=r.isBox3?r.min.z:0;else{const U=Math.pow(2,-s);p=Math.floor(N.width*U),g=Math.floor(N.height*U),e.isDataArrayTexture||e.isArrayTexture?x=N.depth:e.isData3DTexture?x=Math.floor(N.depth*U):x=1,m=0,y=0,_=0}i!==null?(v=i.x,T=i.y,w=i.z):(v=0,T=0,w=0),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,t.flipY),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),a.pixelStorei(a.UNPACK_ALIGNMENT,t.unpackAlignment);const E=a.getParameter(a.UNPACK_ROW_LENGTH),A=a.getParameter(a.UNPACK_IMAGE_HEIGHT),B=a.getParameter(a.UNPACK_SKIP_PIXELS),R=a.getParameter(a.UNPACK_SKIP_ROWS),L=a.getParameter(a.UNPACK_SKIP_IMAGES);a.pixelStorei(a.UNPACK_ROW_LENGTH,N.width),a.pixelStorei(a.UNPACK_IMAGE_HEIGHT,N.height),a.pixelStorei(a.UNPACK_SKIP_PIXELS,m),a.pixelStorei(a.UNPACK_SKIP_ROWS,y),a.pixelStorei(a.UNPACK_SKIP_IMAGES,_);const F=e.isDataArrayTexture||e.isData3DTexture||t.isArrayTexture,S=t.isDataArrayTexture||t.isData3DTexture||t.isArrayTexture;if(e.isDepthTexture){const U=c.get(e),k=c.get(t),P=c.get(U.renderTarget),$=c.get(k.renderTarget),M=P.framebuffers[U.cacheKey],W=$.framebuffers[k.cacheKey];l.bindFramebuffer(a.READ_FRAMEBUFFER,M),l.bindFramebuffer(a.DRAW_FRAMEBUFFER,W);for(let G=0;G<x;G++)F&&(a.framebufferTextureLayer(a.READ_FRAMEBUFFER,a.COLOR_ATTACHMENT0,U.textureGPU,s,_+G),a.framebufferTextureLayer(a.DRAW_FRAMEBUFFER,a.COLOR_ATTACHMENT0,u,o,w+G)),a.blitFramebuffer(m,y,p,g,v,T,p,g,a.DEPTH_BUFFER_BIT,a.NEAREST);l.bindFramebuffer(a.READ_FRAMEBUFFER,null),l.bindFramebuffer(a.DRAW_FRAMEBUFFER,null)}else if(s!==0||e.isRenderTargetTexture||c.has(e)){const U=c.get(e);this._srcFramebuffer===null&&(this._srcFramebuffer=a.createFramebuffer()),this._dstFramebuffer===null&&(this._dstFramebuffer=a.createFramebuffer()),l.bindFramebuffer(a.READ_FRAMEBUFFER,this._srcFramebuffer),l.bindFramebuffer(a.DRAW_FRAMEBUFFER,this._dstFramebuffer);for(let k=0;k<x;k++)F?a.framebufferTextureLayer(a.READ_FRAMEBUFFER,a.COLOR_ATTACHMENT0,U.textureGPU,s,_+k):a.framebufferTexture2D(a.READ_FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,U.textureGPU,s),S?a.framebufferTextureLayer(a.DRAW_FRAMEBUFFER,a.COLOR_ATTACHMENT0,u,o,w+k):a.framebufferTexture2D(a.DRAW_FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,u,o),s!==0?a.blitFramebuffer(m,y,p,g,v,T,p,g,a.COLOR_BUFFER_BIT,a.NEAREST):S?a.copyTexSubImage3D(d,o,v,T,w+k,m,y,p,g):a.copyTexSubImage2D(d,o,v,T,m,y,p,g);l.bindFramebuffer(a.READ_FRAMEBUFFER,null),l.bindFramebuffer(a.DRAW_FRAMEBUFFER,null)}else S?e.isDataTexture||e.isData3DTexture?a.texSubImage3D(d,o,v,T,w,p,g,x,f,h,N.data):t.isCompressedArrayTexture?a.compressedTexSubImage3D(d,o,v,T,w,p,g,x,f,N.data):a.texSubImage3D(d,o,v,T,w,p,g,x,f,h,N):e.isDataTexture?a.texSubImage2D(a.TEXTURE_2D,o,v,T,p,g,f,h,N.data):e.isCompressedTexture?a.compressedTexSubImage2D(a.TEXTURE_2D,o,v,T,N.width,N.height,f,N.data):a.texSubImage2D(a.TEXTURE_2D,o,v,T,p,g,f,h,N);a.pixelStorei(a.UNPACK_ROW_LENGTH,E),a.pixelStorei(a.UNPACK_IMAGE_HEIGHT,A),a.pixelStorei(a.UNPACK_SKIP_PIXELS,B),a.pixelStorei(a.UNPACK_SKIP_ROWS,R),a.pixelStorei(a.UNPACK_SKIP_IMAGES,L),o===0&&t.generateMipmaps&&a.generateMipmap(d),l.unbindTexture()}copyFramebufferToTexture(e,t,r){const{gl:i}=this,{state:s}=this.backend,{textureGPU:o}=this.backend.get(e),{x:a,y:c,z:l,w:u}=r,d=e.isDepthTexture===!0||t.renderTarget&&t.renderTarget.samples>0,h=t.renderTarget?t.renderTarget.height:this.backend.getDrawingBufferSize().y;if(d){const f=a!==0||c!==0;let p,g;if(e.isDepthTexture===!0?(p=i.DEPTH_BUFFER_BIT,g=i.DEPTH_ATTACHMENT,t.stencil&&(p|=i.STENCIL_BUFFER_BIT)):(p=i.COLOR_BUFFER_BIT,g=i.COLOR_ATTACHMENT0),f){const x=this.backend.get(t.renderTarget),m=x.framebuffers[t.getCacheKey()],y=x.msaaFrameBuffer;s.bindFramebuffer(i.DRAW_FRAMEBUFFER,m),s.bindFramebuffer(i.READ_FRAMEBUFFER,y);const _=h-c-u;i.blitFramebuffer(a,_,a+l,_+u,a,_,a+l,_+u,p,i.NEAREST),s.bindFramebuffer(i.READ_FRAMEBUFFER,m),s.bindTexture(i.TEXTURE_2D,o),i.copyTexSubImage2D(i.TEXTURE_2D,0,0,0,a,_,l,u),s.unbindTexture()}else{const x=i.createFramebuffer();s.bindFramebuffer(i.DRAW_FRAMEBUFFER,x),i.framebufferTexture2D(i.DRAW_FRAMEBUFFER,g,i.TEXTURE_2D,o,0),i.blitFramebuffer(0,0,l,u,0,0,l,u,p,i.NEAREST),i.deleteFramebuffer(x)}}else s.bindTexture(i.TEXTURE_2D,o),i.copyTexSubImage2D(i.TEXTURE_2D,0,0,0,a,h-u-c,l,u),s.unbindTexture();e.generateMipmaps&&this.generateMipmaps(e),this.backend._setFramebuffer(t)}setupRenderBufferStorage(e,t,r,i=!1){const{gl:s}=this,o=t.renderTarget,{depthTexture:a,depthBuffer:c,stencilBuffer:l,width:u,height:d}=o;if(s.bindRenderbuffer(s.RENDERBUFFER,e),c&&!l){let h=s.DEPTH_COMPONENT24;i===!0?this.extensions.get("WEBGL_multisampled_render_to_texture").renderbufferStorageMultisampleEXT(s.RENDERBUFFER,o.samples,h,u,d):r>0?(a&&a.isDepthTexture&&a.type===s.FLOAT&&(h=s.DEPTH_COMPONENT32F),s.renderbufferStorageMultisample(s.RENDERBUFFER,r,h,u,d)):s.renderbufferStorage(s.RENDERBUFFER,h,u,d),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,e)}else c&&l&&(r>0?s.renderbufferStorageMultisample(s.RENDERBUFFER,r,s.DEPTH24_STENCIL8,u,d):s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_STENCIL,u,d),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,e));s.bindRenderbuffer(s.RENDERBUFFER,null)}async copyTextureToBuffer(e,t,r,i,s,o){const{backend:a,gl:c}=this,{textureGPU:l,glFormat:u,glType:d}=this.backend.get(e),h=c.createFramebuffer();c.bindFramebuffer(c.READ_FRAMEBUFFER,h);const f=e.isCubeTexture?c.TEXTURE_CUBE_MAP_POSITIVE_X+o:c.TEXTURE_2D;c.framebufferTexture2D(c.READ_FRAMEBUFFER,c.COLOR_ATTACHMENT0,f,l,0);const p=this._getTypedArrayType(d),g=this._getBytesPerTexel(d,u),m=i*s*g,y=c.createBuffer();c.bindBuffer(c.PIXEL_PACK_BUFFER,y),c.bufferData(c.PIXEL_PACK_BUFFER,m,c.STREAM_READ),c.readPixels(t,r,i,s,u,d,0),c.bindBuffer(c.PIXEL_PACK_BUFFER,null),await a.utils._clientWaitAsync();const _=new p(m/p.BYTES_PER_ELEMENT);return c.bindBuffer(c.PIXEL_PACK_BUFFER,y),c.getBufferSubData(c.PIXEL_PACK_BUFFER,0,_),c.bindBuffer(c.PIXEL_PACK_BUFFER,null),c.deleteFramebuffer(h),_}_getTypedArrayType(e){const{gl:t}=this;if(e===t.UNSIGNED_BYTE)return Uint8Array;if(e===t.UNSIGNED_SHORT_4_4_4_4||e===t.UNSIGNED_SHORT_5_5_5_1||e===t.UNSIGNED_SHORT_5_6_5||e===t.UNSIGNED_SHORT)return Uint16Array;if(e===t.UNSIGNED_INT)return Uint32Array;if(e===t.HALF_FLOAT)return Uint16Array;if(e===t.FLOAT)return Float32Array;throw new Error(`Unsupported WebGL type: ${e}`)}_getBytesPerTexel(e,t){const{gl:r}=this;let i=0;if(e===r.UNSIGNED_BYTE&&(i=1),(e===r.UNSIGNED_SHORT_4_4_4_4||e===r.UNSIGNED_SHORT_5_5_5_1||e===r.UNSIGNED_SHORT_5_6_5||e===r.UNSIGNED_SHORT||e===r.HALF_FLOAT)&&(i=2),(e===r.UNSIGNED_INT||e===r.FLOAT)&&(i=4),t===r.RGBA)return i*4;if(t===r.RGB)return i*3;if(t===r.ALPHA)return i}dispose(){const{gl:e}=this;this._srcFramebuffer!==null&&e.deleteFramebuffer(this._srcFramebuffer),this._dstFramebuffer!==null&&e.deleteFramebuffer(this._dstFramebuffer)}}function ec(n){return n.isDataTexture?n.image.data:typeof HTMLImageElement<"u"&&n instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&n instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&n instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&n instanceof OffscreenCanvas?n:n.data}class VG{constructor(e){this.backend=e,this.gl=this.backend.gl,this.availableExtensions=this.gl.getSupportedExtensions(),this.extensions={}}get(e){let t=this.extensions[e];return t===void 0&&(t=this.gl.getExtension(e),this.extensions[e]=t),t}has(e){return this.availableExtensions.includes(e)}}class zG{constructor(e){this.backend=e,this.maxAnisotropy=null}getMaxAnisotropy(){if(this.maxAnisotropy!==null)return this.maxAnisotropy;const e=this.backend.gl,t=this.backend.extensions;if(t.has("EXT_texture_filter_anisotropic")===!0){const r=t.get("EXT_texture_filter_anisotropic");this.maxAnisotropy=e.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else this.maxAnisotropy=0;return this.maxAnisotropy}}const Z0={WEBGL_multi_draw:"WEBGL_multi_draw",WEBGL_compressed_texture_astc:"texture-compression-astc",WEBGL_compressed_texture_etc:"texture-compression-etc2",WEBGL_compressed_texture_etc1:"texture-compression-etc1",WEBGL_compressed_texture_pvrtc:"texture-compression-pvrtc",WEBGL_compressed_texture_s3tc:"texture-compression-s3tc",EXT_texture_compression_bptc:"texture-compression-bc",EXT_disjoint_timer_query_webgl2:"timestamp-query",OVR_multiview2:"OVR_multiview2"};class jG{constructor(e){this.gl=e.gl,this.extensions=e.extensions,this.info=e.renderer.info,this.mode=null,this.index=0,this.type=null,this.object=null}render(e,t){const{gl:r,mode:i,object:s,type:o,info:a,index:c}=this;c!==0?r.drawElements(i,t,o,e):r.drawArrays(i,e,t),a.update(s,t,1)}renderInstances(e,t,r){const{gl:i,mode:s,type:o,index:a,object:c,info:l}=this;r!==0&&(a!==0?i.drawElementsInstanced(s,t,o,e,r):i.drawArraysInstanced(s,e,t,r),l.update(c,t,r))}renderMultiDraw(e,t,r){const{extensions:i,mode:s,object:o,info:a}=this;if(r===0)return;const c=i.get("WEBGL_multi_draw");if(c===null)for(let l=0;l<r;l++)this.render(e[l],t[l]);else{this.index!==0?c.multiDrawElementsWEBGL(s,t,0,this.type,e,0,r):c.multiDrawArraysWEBGL(s,e,0,t,0,r);let l=0;for(let u=0;u<r;u++)l+=t[u];a.update(o,l,1)}}renderMultiDrawInstances(e,t,r,i){const{extensions:s,mode:o,object:a,info:c}=this;if(r===0)return;const l=s.get("WEBGL_multi_draw");if(l===null)for(let u=0;u<r;u++)this.renderInstances(e[u],t[u],i[u]);else{this.index!==0?l.multiDrawElementsInstancedWEBGL(o,t,0,this.type,e,0,i,0,r):l.multiDrawArraysInstancedWEBGL(o,e,0,t,0,i,0,r);let u=0;for(let d=0;d<r;d++)u+=t[d]*i[d];c.update(a,u,1)}}}class qT{constructor(e=256){this.trackTimestamp=!0,this.maxQueries=e,this.currentQueryIndex=0,this.queryOffsets=new Map,this.isDisposed=!1,this.lastValue=0,this.frames=[],this.pendingResolve=!1,this.timestamps=new Map}getTimestampFrames(){return this.frames}getTimestamp(e){let t=this.timestamps.get(e);return t===void 0&&(se(`TimestampQueryPool: No timestamp available for uid ${e}.`),t=0),t}hasTimestamp(e){return this.timestamps.has(e)}allocateQueriesForContext(){}async resolveQueriesAsync(){}dispose(){}}class HG extends qT{constructor(e,t,r=2048){if(super(r),this.gl=e,this.type=t,this.ext=e.getExtension("EXT_disjoint_timer_query_webgl2")||e.getExtension("EXT_disjoint_timer_query"),!this.ext){se("EXT_disjoint_timer_query not supported; timestamps will be disabled."),this.trackTimestamp=!1;return}this.queries=[];for(let i=0;i<this.maxQueries;i++)this.queries.push(e.createQuery());this.activeQuery=null,this.queryStates=new Map}allocateQueriesForContext(e){if(!this.trackTimestamp)return null;if(this.currentQueryIndex+2>this.maxQueries)return lt(`WebGPUTimestampQueryPool [${this.type}]: Maximum number of queries exceeded, when using trackTimestamp it is necessary to resolves the queries via renderer.resolveTimestampsAsync( THREE.TimestampQuery.${this.type.toUpperCase()} ).`),null;const t=this.currentQueryIndex;return this.currentQueryIndex+=2,this.queryStates.set(t,"inactive"),this.queryOffsets.set(e,t),t}beginQuery(e){if(!this.trackTimestamp||this.isDisposed)return;const t=this.queryOffsets.get(e);if(t==null||this.activeQuery!==null)return;const r=this.queries[t];if(r)try{this.queryStates.get(t)==="inactive"&&(this.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,r),this.activeQuery=t,this.queryStates.set(t,"started"))}catch(i){i("Error in beginQuery:",i),this.activeQuery=null,this.queryStates.set(t,"inactive")}}endQuery(e){if(!this.trackTimestamp||this.isDisposed)return;const t=this.queryOffsets.get(e);if(t!=null&&this.activeQuery===t)try{this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.queryStates.set(t,"ended"),this.activeQuery=null}catch(r){r("Error in endQuery:",r),this.queryStates.set(t,"inactive"),this.activeQuery=null}}async resolveQueriesAsync(){if(!this.trackTimestamp||this.pendingResolve)return this.lastValue;this.pendingResolve=!0;try{const e=new Map;for(const[s,o]of this.queryOffsets)if(this.queryStates.get(o)==="ended"){const c=this.queries[o];e.set(s,this.resolveQuery(c))}if(e.size===0)return this.lastValue;const t={},r=[];for(const[s,o]of e){const a=s.match(/^(.*):f(\d+)$/),c=parseInt(a[2]);r.includes(c)===!1&&r.push(c),t[c]===void 0&&(t[c]=0);const l=await o;this.timestamps.set(s,l),t[c]+=l}const i=t[r[r.length-1]];return this.lastValue=i,this.frames=r,this.currentQueryIndex=0,this.queryOffsets.clear(),this.queryStates.clear(),this.activeQuery=null,i}catch(e){return e("Error resolving queries:",e),this.lastValue}finally{this.pendingResolve=!1}}async resolveQuery(e){return new Promise(t=>{if(this.isDisposed){t(this.lastValue);return}let r,i=!1;const s=()=>{r&&(clearTimeout(r),r=null)},o=c=>{i||(i=!0,s(),t(c))},a=()=>{if(this.isDisposed){o(this.lastValue);return}try{if(this.gl.getParameter(this.ext.GPU_DISJOINT_EXT)){o(this.lastValue);return}if(!this.gl.getQueryParameter(e,this.gl.QUERY_RESULT_AVAILABLE)){r=setTimeout(a,1);return}const u=this.gl.getQueryParameter(e,this.gl.QUERY_RESULT);t(Number(u)/1e6)}catch(c){c("Error checking query:",c),t(this.lastValue)}};a()})}dispose(){if(!this.isDisposed&&(this.isDisposed=!0,!!this.trackTimestamp)){for(const e of this.queries)this.gl.deleteQuery(e);this.queries=[],this.queryStates.clear(),this.queryOffsets.clear(),this.lastValue=0,this.activeQuery=null}}}class J0 extends WT{constructor(e={}){super(e),this.isWebGLBackend=!0,this.attributeUtils=null,this.extensions=null,this.capabilities=null,this.textureUtils=null,this.bufferRenderer=null,this.gl=null,this.state=null,this.utils=null,this.vaoCache={},this.transformFeedbackCache={},this.discard=!1,this.disjoint=null,this.parallel=null,this._currentContext=null,this._knownBindings=new WeakSet,this._supportsInvalidateFramebuffer=typeof navigator>"u"?!1:/OculusBrowser/g.test(navigator.userAgent),this._xrFramebuffer=null}init(e){super.init(e);const t=this.parameters,r={antialias:e.currentSamples>0,alpha:!0,depth:e.depth,stencil:e.stencil},i=t.context!==void 0?t.context:e.domElement.getContext("webgl2",r);function s(o){o.preventDefault();const a={api:"WebGL",message:o.statusMessage||"Unknown reason",reason:null,originalEvent:o};e.onDeviceLost(a)}this._onContextLost=s,e.domElement.addEventListener("webglcontextlost",s,!1),this.gl=i,this.extensions=new VG(this),this.capabilities=new zG(this),this.attributeUtils=new OG(this),this.textureUtils=new $G(this),this.bufferRenderer=new jG(this),this.state=new UG(this),this.utils=new GG(this),this.extensions.get("EXT_color_buffer_float"),this.extensions.get("WEBGL_clip_cull_distance"),this.extensions.get("OES_texture_float_linear"),this.extensions.get("EXT_color_buffer_half_float"),this.extensions.get("WEBGL_multisampled_render_to_texture"),this.extensions.get("WEBGL_render_shared_exponent"),this.extensions.get("WEBGL_multi_draw"),this.extensions.get("OVR_multiview2"),this.disjoint=this.extensions.get("EXT_disjoint_timer_query_webgl2"),this.parallel=this.extensions.get("KHR_parallel_shader_compile")}get coordinateSystem(){return Pc}async getArrayBufferAsync(e){return await this.attributeUtils.getArrayBufferAsync(e)}async makeXRCompatible(){this.gl.getContextAttributes().xrCompatible!==!0&&await this.gl.makeXRCompatible()}setXRTarget(e){this._xrFramebuffer=e}setXRRenderTargetTextures(e,t,r=null){const i=this.gl;if(this.set(e.texture,{textureGPU:t,glInternalFormat:i.RGBA8}),r!==null){const s=e.stencilBuffer?i.DEPTH24_STENCIL8:i.DEPTH_COMPONENT24;this.set(e.depthTexture,{textureGPU:r,glInternalFormat:s}),this.extensions.has("WEBGL_multisampled_render_to_texture")===!0&&e._autoAllocateDepthBuffer===!0&&e.multiview===!1&&se("WebGLBackend: Render-to-texture extension was disabled because an external texture was provided"),e._autoAllocateDepthBuffer=!1}}initTimestampQuery(e,t){if(!this.disjoint||!this.trackTimestamp)return;this.timestampQueryPool[e]||(this.timestampQueryPool[e]=new HG(this.gl,e,2048));const r=this.timestampQueryPool[e];r.allocateQueriesForContext(t)!==null&&r.beginQuery(t)}prepareTimestampBuffer(e,t){if(!this.disjoint||!this.trackTimestamp)return;this.timestampQueryPool[e].endQuery(t)}getContext(){return this.gl}beginRender(e){const{state:t}=this,r=this.get(e);if(e.viewport)this.updateViewport(e);else{const{width:s,height:o}=this.getDrawingBufferSize();t.viewport(0,0,s,o)}if(e.scissor){const{x:s,y:o,width:a,height:c}=e.scissorValue;t.scissor(s,e.height-c-o,a,c)}this.initTimestampQuery(Ln.RENDER,this.getTimestampUID(e)),r.previousContext=this._currentContext,this._currentContext=e,this._setFramebuffer(e),this.clear(e.clearColor,e.clearDepth,e.clearStencil,e,!1);const i=e.occlusionQueryCount;i>0&&(r.currentOcclusionQueries=r.occlusionQueries,r.currentOcclusionQueryObjects=r.occlusionQueryObjects,r.lastOcclusionObject=null,r.occlusionQueries=new Array(i),r.occlusionQueryObjects=new Array(i),r.occlusionQueryIndex=0)}finishRender(e){const{gl:t,state:r}=this,i=this.get(e),s=i.previousContext;r.resetVertexState();const o=e.occlusionQueryCount;o>0&&(o>i.occlusionQueryIndex&&t.endQuery(t.ANY_SAMPLES_PASSED),this.resolveOccludedAsync(e));const a=e.textures;if(a!==null)for(let c=0;c<a.length;c++){const l=a[c];l.generateMipmaps&&this.generateMipmaps(l)}if(this._currentContext=s,this._resolveRenderTarget(e),s!==null)if(this._setFramebuffer(s),s.viewport)this.updateViewport(s);else{const{width:c,height:l}=this.getDrawingBufferSize();r.viewport(0,0,c,l)}this.prepareTimestampBuffer(Ln.RENDER,this.getTimestampUID(e))}resolveOccludedAsync(e){const t=this.get(e),{currentOcclusionQueries:r,currentOcclusionQueryObjects:i}=t;if(r&&i){const s=new WeakSet,{gl:o}=this;t.currentOcclusionQueryObjects=null,t.currentOcclusionQueries=null;const a=()=>{let c=0;for(let l=0;l<r.length;l++){const u=r[l];u!==null&&o.getQueryParameter(u,o.QUERY_RESULT_AVAILABLE)&&(o.getQueryParameter(u,o.QUERY_RESULT)===0&&s.add(i[l]),r[l]=null,o.deleteQuery(u),c++)}c<r.length?requestAnimationFrame(a):t.occluded=s};a()}}isOccluded(e,t){const r=this.get(e);return r.occluded&&r.occluded.has(t)}updateViewport(e){const{state:t}=this,{x:r,y:i,width:s,height:o}=e.viewportValue;t.viewport(r,e.height-o-i,s,o)}setScissorTest(e){this.state.setScissorTest(e)}getClearColor(){const e=super.getClearColor();return e.r*=e.a,e.g*=e.a,e.b*=e.a,e}clear(e,t,r,i=null,s=!0,o=!0){const{gl:a,renderer:c}=this;i===null&&(i={textures:null,clearColorValue:this.getClearColor()});let l=0;if(e&&(l|=a.COLOR_BUFFER_BIT),t&&(l|=a.DEPTH_BUFFER_BIT),r&&(l|=a.STENCIL_BUFFER_BIT),l!==0){let u;i.clearColorValue?u=i.clearColorValue:u=this.getClearColor();const d=c.getClearDepth(),h=c.getClearStencil();if(t&&this.state.setDepthMask(!0),i.textures===null)a.clearColor(u.r,u.g,u.b,u.a),a.clear(l);else{if(s&&this._setFramebuffer(i),e)for(let f=0;f<i.textures.length;f++)f===0?a.clearBufferfv(a.COLOR,f,[u.r,u.g,u.b,u.a]):a.clearBufferfv(a.COLOR,f,[0,0,0,1]);t&&r?a.clearBufferfi(a.DEPTH_STENCIL,0,d,h):t?a.clearBufferfv(a.DEPTH,0,[d]):r&&a.clearBufferiv(a.STENCIL,0,[h]),s&&o&&this._resolveRenderTarget(i)}}}beginCompute(e){const{state:t,gl:r}=this;t.bindFramebuffer(r.FRAMEBUFFER,null),this.initTimestampQuery(Ln.COMPUTE,this.getTimestampUID(e))}compute(e,t,r,i,s=null){const{state:o,gl:a}=this;this.discard===!1&&(a.enable(a.RASTERIZER_DISCARD),this.discard=!0);const{programGPU:c,transformBuffers:l,attributes:u}=this.get(i),d=this._getVaoKey(u),h=this.vaoCache[d];h===void 0?this.vaoCache[d]=this._createVao(u):o.setVertexState(h),o.useProgram(c),this._bindUniforms(r);const f=this._getTransformFeedback(l);a.bindTransformFeedback(a.TRANSFORM_FEEDBACK,f),a.beginTransformFeedback(a.POINTS),s=s!==null?s:t.count,Array.isArray(s)?(lt("WebGLBackend.compute(): The count parameter must be a single number, not an array."),s=s[0]):s&&typeof s=="object"&&s.isIndirectStorageBufferAttribute&&(lt("WebGLBackend.compute(): The count parameter must be a single number, not IndirectStorageBufferAttribute"),s=t.count),u[0].isStorageInstancedBufferAttribute?a.drawArraysInstanced(a.POINTS,0,1,s):a.drawArrays(a.POINTS,0,s),a.endTransformFeedback(),a.bindTransformFeedback(a.TRANSFORM_FEEDBACK,null);for(let p=0;p<l.length;p++){const g=l[p];g.pbo&&this.has(g.pbo)&&this.textureUtils.copyBufferToTexture(g.transformBuffer,g.pbo),g.switchBuffers()}}finishCompute(e){const t=this.gl;this.discard=!1,t.disable(t.RASTERIZER_DISCARD),this.prepareTimestampBuffer(Ln.COMPUTE,this.getTimestampUID(e)),this._currentContext&&this._setFramebuffer(this._currentContext)}_isRenderCameraDepthArray(e){return e.depthTexture&&e.depthTexture.isArrayTexture&&e.camera.isArrayCamera}draw(e){const{object:t,pipeline:r,material:i,context:s,hardwareClippingPlanes:o}=e,{programGPU:a}=this.get(r),{gl:c,state:l}=this,u=this.get(s),d=e.getDrawParameters();if(d===null)return;this._bindUniforms(e.getBindings());const h=t.isMesh&&t.matrixWorld.determinant()<0;l.setMaterial(i,h,o),l.useProgram(a);const f=e.getAttributes(),p=this.get(f);let g=p.vaoGPU;if(g===void 0){const E=this._getVaoKey(f);g=this.vaoCache[E],g===void 0&&(g=this._createVao(f),this.vaoCache[E]=g,p.vaoGPU=g)}const x=e.getIndex(),m=x!==null?this.get(x).bufferGPU:null;l.setVertexState(g,m);const y=u.lastOcclusionObject;if(y!==t&&y!==void 0){if(y!==null&&y.occlusionTest===!0&&(c.endQuery(c.ANY_SAMPLES_PASSED),u.occlusionQueryIndex++),t.occlusionTest===!0){const E=c.createQuery();c.beginQuery(c.ANY_SAMPLES_PASSED,E),u.occlusionQueries[u.occlusionQueryIndex]=E,u.occlusionQueryObjects[u.occlusionQueryIndex]=t}u.lastOcclusionObject=t}const _=this.bufferRenderer;t.isPoints?_.mode=c.POINTS:t.isLineSegments?_.mode=c.LINES:t.isLine?_.mode=c.LINE_STRIP:t.isLineLoop?_.mode=c.LINE_LOOP:i.wireframe===!0?(l.setLineWidth(i.wireframeLinewidth*this.renderer.getPixelRatio()),_.mode=c.LINES):_.mode=c.TRIANGLES;const{vertexCount:v,instanceCount:T}=d;let{firstVertex:w}=d;if(_.object=t,x!==null){w*=x.array.BYTES_PER_ELEMENT;const E=this.get(x);_.index=x.count,_.type=E.type}else _.index=0;const N=()=>{t.isBatchedMesh?t._multiDrawInstances!==null?(lt("WebGLBackend: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection."),_.renderMultiDrawInstances(t._multiDrawStarts,t._multiDrawCounts,t._multiDrawCount,t._multiDrawInstances)):this.hasFeature("WEBGL_multi_draw")?_.renderMultiDraw(t._multiDrawStarts,t._multiDrawCounts,t._multiDrawCount):lt("WebGLBackend: WEBGL_multi_draw not supported."):T>1?_.renderInstances(w,v,T):_.render(w,v)};if(e.camera.isArrayCamera===!0&&e.camera.cameras.length>0&&e.camera.isMultiViewCamera===!1){const E=this.get(e.camera),A=e.camera.cameras,B=e.getBindingGroup("cameraIndex").bindings[0];if(E.indexesGPU===void 0||E.indexesGPU.length!==A.length){const k=new Uint32Array([0,0,0,0]),P=[];for(let $=0,M=A.length;$<M;$++){const W=c.createBuffer();k[0]=$,c.bindBuffer(c.UNIFORM_BUFFER,W),c.bufferData(c.UNIFORM_BUFFER,k,c.STATIC_DRAW),P.push(W)}E.indexesGPU=P}const R=this.get(B),L=this.renderer.getPixelRatio(),F=this._currentContext.renderTarget,S=this._isRenderCameraDepthArray(this._currentContext),U=this._currentContext.activeCubeFace;if(S){const k=this.get(F.depthTexture);if(k.clearedRenderId!==this.renderer._nodes.nodeFrame.renderId){k.clearedRenderId=this.renderer._nodes.nodeFrame.renderId;const{stencilBuffer:P}=F;for(let $=0,M=A.length;$<M;$++)this.renderer._activeCubeFace=$,this._currentContext.activeCubeFace=$,this._setFramebuffer(this._currentContext),this.clear(!1,!0,P,this._currentContext,!1,!1);this.renderer._activeCubeFace=U,this._currentContext.activeCubeFace=U}}for(let k=0,P=A.length;k<P;k++){const $=A[k];if(t.layers.test($.layers)){S&&(this.renderer._activeCubeFace=k,this._currentContext.activeCubeFace=k,this._setFramebuffer(this._currentContext));const M=$.viewport;if(M!==void 0){const W=M.x*L,G=M.y*L,z=M.width*L,Z=M.height*L;l.viewport(Math.floor(W),Math.floor(e.context.height-Z-G),Math.floor(z),Math.floor(Z))}l.bindBufferBase(c.UNIFORM_BUFFER,R.index,E.indexesGPU[k]),N()}this._currentContext.activeCubeFace=U,this.renderer._activeCubeFace=U}}else N()}needsRenderUpdate(){return!1}getRenderCacheKey(){return""}createDefaultTexture(e){this.textureUtils.createDefaultTexture(e)}createTexture(e,t){this.textureUtils.createTexture(e,t)}updateTexture(e,t){this.textureUtils.updateTexture(e,t)}generateMipmaps(e){this.textureUtils.generateMipmaps(e)}destroyTexture(e,t=!1){this.textureUtils.destroyTexture(e,t)}async copyTextureToBuffer(e,t,r,i,s,o){return this.textureUtils.copyTextureToBuffer(e,t,r,i,s,o)}updateSampler(){return""}createNodeBuilder(e,t){return new kG(e,t)}createProgram(e){const t=this.gl,{stage:r,code:i}=e,s=r==="fragment"?t.createShader(t.FRAGMENT_SHADER):t.createShader(t.VERTEX_SHADER);t.shaderSource(s,i),t.compileShader(s),this.set(e,{shaderGPU:s})}destroyProgram(e){this.delete(e)}createRenderPipeline(e,t){const r=this.gl,i=e.pipeline,{fragmentProgram:s,vertexProgram:o}=i,a=r.createProgram(),c=this.get(s).shaderGPU,l=this.get(o).shaderGPU;if(r.attachShader(a,c),r.attachShader(a,l),r.linkProgram(a),this.set(i,{programGPU:a,fragmentShader:c,vertexShader:l}),t!==null&&this.parallel){const u=new Promise(d=>{const h=this.parallel,f=()=>{r.getProgramParameter(a,h.COMPLETION_STATUS_KHR)?(this._completeCompile(e,i),d()):requestAnimationFrame(f)};f()});t.push(u);return}this._completeCompile(e,i)}_handleSource(e,t){const r=e.split(`
`),i=[],s=Math.max(t-6,0),o=Math.min(t+6,r.length);for(let a=s;a<o;a++){const c=a+1;i.push(`${c===t?">":" "} ${c}: ${r[a]}`)}return i.join(`
`)}_getShaderErrors(e,t,r){const i=e.getShaderParameter(t,e.COMPILE_STATUS),o=(e.getShaderInfoLog(t)||"").trim();if(i&&o==="")return"";const a=/ERROR: 0:(\d+)/.exec(o);if(a){const c=parseInt(a[1]);return r.toUpperCase()+`

`+o+`

`+this._handleSource(e.getShaderSource(t),c)}else return o}_logProgramError(e,t,r){if(this.renderer.debug.checkShaderErrors){const i=this.gl,o=(i.getProgramInfoLog(e)||"").trim();if(i.getProgramParameter(e,i.LINK_STATUS)===!1)if(typeof this.renderer.debug.onShaderError=="function")this.renderer.debug.onShaderError(i,e,r,t);else{const a=this._getShaderErrors(i,r,"vertex"),c=this._getShaderErrors(i,t,"fragment");ie("THREE.WebGLProgram: Shader Error "+i.getError()+" - VALIDATE_STATUS "+i.getProgramParameter(e,i.VALIDATE_STATUS)+`

Program Info Log: `+o+`
`+a+`
`+c)}else o!==""&&se("WebGLProgram: Program Info Log:",o)}}_completeCompile(e,t){const{state:r,gl:i}=this,s=this.get(t),{programGPU:o,fragmentShader:a,vertexShader:c}=s;i.getProgramParameter(o,i.LINK_STATUS)===!1&&this._logProgramError(o,a,c),r.useProgram(o);const l=e.getBindings();this._setupBindings(l,o),this.set(t,{programGPU:o})}createComputePipeline(e,t){const{state:r,gl:i}=this,s={stage:"fragment",code:`#version 300 es
precision highp float;
void main() {}`};this.createProgram(s);const{computeProgram:o}=e,a=i.createProgram(),c=this.get(s).shaderGPU,l=this.get(o).shaderGPU,u=o.transforms,d=[],h=[];for(let x=0;x<u.length;x++){const m=u[x];d.push(m.varyingName),h.push(m.attributeNode)}i.attachShader(a,c),i.attachShader(a,l),i.transformFeedbackVaryings(a,d,i.SEPARATE_ATTRIBS),i.linkProgram(a),i.getProgramParameter(a,i.LINK_STATUS)===!1&&this._logProgramError(a,c,l),r.useProgram(a),this._setupBindings(t,a);const f=o.attributes,p=[],g=[];for(let x=0;x<f.length;x++){const m=f[x].node.attribute;p.push(m),this.has(m)||this.attributeUtils.createAttribute(m,i.ARRAY_BUFFER)}for(let x=0;x<h.length;x++){const m=h[x].attribute;this.has(m)||this.attributeUtils.createAttribute(m,i.ARRAY_BUFFER);const y=this.get(m);g.push(y)}this.set(e,{programGPU:a,transformBuffers:g,attributes:p})}createBindings(e,t){if(this._knownBindings.has(t)===!1){this._knownBindings.add(t);let r=0,i=0;for(const s of t){this.set(s,{textures:i,uniformBuffers:r});for(const o of s.bindings)o.isUniformBuffer&&r++,o.isSampledTexture&&i++}}this.updateBindings(e,t)}updateBindings(e){const{gl:t}=this,r=this.get(e);let i=r.uniformBuffers,s=r.textures;for(const o of e.bindings){const a=this.get(o);if(o.isUniformsGroup||o.isUniformBuffer){const c=o.buffer;let{bufferGPU:l}=this.get(c);l===void 0?(l=t.createBuffer(),t.bindBuffer(t.UNIFORM_BUFFER,l),t.bufferData(t.UNIFORM_BUFFER,c,t.DYNAMIC_DRAW),this.set(c,{bufferGPU:l})):(t.bindBuffer(t.UNIFORM_BUFFER,l),t.bufferSubData(t.UNIFORM_BUFFER,0,c)),a.index=i++,a.bufferGPU=l,this.set(o,a)}else if(o.isSampledTexture){const{textureGPU:c,glTextureType:l}=this.get(o.texture);a.index=s++,a.textureGPU=c,a.glTextureType=l,this.set(o,a)}}}updateBinding(e){const t=this.gl;if(e.isUniformsGroup||e.isUniformBuffer){const i=this.get(e).bufferGPU,s=e.buffer;t.bindBuffer(t.UNIFORM_BUFFER,i),t.bufferData(t.UNIFORM_BUFFER,s,t.DYNAMIC_DRAW)}}createIndexAttribute(e){const t=this.gl;this.attributeUtils.createAttribute(e,t.ELEMENT_ARRAY_BUFFER)}createAttribute(e){if(this.has(e))return;const t=this.gl;this.attributeUtils.createAttribute(e,t.ARRAY_BUFFER)}createStorageAttribute(e){if(this.has(e))return;const t=this.gl;this.attributeUtils.createAttribute(e,t.ARRAY_BUFFER)}updateAttribute(e){this.attributeUtils.updateAttribute(e)}destroyAttribute(e){this.attributeUtils.destroyAttribute(e)}hasFeature(e){const t=Object.keys(Z0).filter(i=>Z0[i]===e),r=this.extensions;for(let i=0;i<t.length;i++)if(r.has(t[i]))return!0;return!1}getMaxAnisotropy(){return this.capabilities.getMaxAnisotropy()}copyTextureToTexture(e,t,r=null,i=null,s=0,o=0){this.textureUtils.copyTextureToTexture(e,t,r,i,s,o)}copyFramebufferToTexture(e,t,r){this.textureUtils.copyFramebufferToTexture(e,t,r)}_setFramebuffer(e){const{gl:t,state:r}=this;let i=null;if(e.textures!==null){const s=e.renderTarget,o=this.get(s),{samples:a,depthBuffer:c,stencilBuffer:l}=s,u=s.isWebGLCubeRenderTarget===!0,d=s.isRenderTarget3D===!0,h=s.depth>1,f=s.isXRRenderTarget===!0,p=f===!0&&s._hasExternalTextures===!0;let g=o.msaaFrameBuffer,x=o.depthRenderbuffer;const m=this.extensions.get("WEBGL_multisampled_render_to_texture"),y=this.extensions.get("OVR_multiview2"),_=this._useMultisampledExtension(s),v=ET(e);let T;if(u?(o.cubeFramebuffers||(o.cubeFramebuffers={}),T=o.cubeFramebuffers[v]):f&&p===!1?T=this._xrFramebuffer:(o.framebuffers||(o.framebuffers={}),T=o.framebuffers[v]),T===void 0){T=t.createFramebuffer(),r.bindFramebuffer(t.FRAMEBUFFER,T);const w=e.textures,N=[];if(u){o.cubeFramebuffers[v]=T;const{textureGPU:A}=this.get(w[0]),B=this.renderer._activeCubeFace,R=this.renderer._activeMipmapLevel;t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+B,A,R)}else{o.framebuffers[v]=T;for(let A=0;A<w.length;A++){const B=w[A],R=this.get(B);R.renderTarget=e.renderTarget,R.cacheKey=v;const L=t.COLOR_ATTACHMENT0+A;if(s.multiview)y.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,L,R.textureGPU,0,a,0,2);else if(d||h){const F=this.renderer._activeCubeFace,S=this.renderer._activeMipmapLevel;t.framebufferTextureLayer(t.FRAMEBUFFER,L,R.textureGPU,S,F)}else if(_)m.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,L,t.TEXTURE_2D,R.textureGPU,0,a);else{const F=this.renderer._activeMipmapLevel;t.framebufferTexture2D(t.FRAMEBUFFER,L,t.TEXTURE_2D,R.textureGPU,F)}}}const E=l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;if(s._autoAllocateDepthBuffer===!0){const A=t.createRenderbuffer();this.textureUtils.setupRenderBufferStorage(A,e,0,_),o.xrDepthRenderbuffer=A,N.push(l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT),t.bindRenderbuffer(t.RENDERBUFFER,A),t.framebufferRenderbuffer(t.FRAMEBUFFER,E,t.RENDERBUFFER,A)}else if(e.depthTexture!==null){N.push(l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT);const A=this.get(e.depthTexture);if(A.renderTarget=e.renderTarget,A.cacheKey=v,s.multiview)y.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,E,A.textureGPU,0,a,0,2);else if(p&&_)m.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,E,t.TEXTURE_2D,A.textureGPU,0,a);else if(e.depthTexture.isArrayTexture){const B=this.renderer._activeCubeFace;t.framebufferTextureLayer(t.FRAMEBUFFER,E,A.textureGPU,0,B)}else t.framebufferTexture2D(t.FRAMEBUFFER,E,t.TEXTURE_2D,A.textureGPU,0)}o.depthInvalidationArray=N}else{if(this._isRenderCameraDepthArray(e)){r.bindFramebuffer(t.FRAMEBUFFER,T);const N=this.renderer._activeCubeFace,E=this.get(e.depthTexture),A=l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;t.framebufferTextureLayer(t.FRAMEBUFFER,A,E.textureGPU,0,N)}if((f||_||s.multiview)&&s._isOpaqueFramebuffer!==!0){r.bindFramebuffer(t.FRAMEBUFFER,T);const N=this.get(e.textures[0]);s.multiview?y.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,N.textureGPU,0,a,0,2):_?m.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,N.textureGPU,0,a):t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,N.textureGPU,0);const E=l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;if(s._autoAllocateDepthBuffer===!0){const A=o.xrDepthRenderbuffer;t.bindRenderbuffer(t.RENDERBUFFER,A),t.framebufferRenderbuffer(t.FRAMEBUFFER,E,t.RENDERBUFFER,A)}else{const A=this.get(e.depthTexture);s.multiview?y.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,E,A.textureGPU,0,a,0,2):_?m.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,E,t.TEXTURE_2D,A.textureGPU,0,a):t.framebufferTexture2D(t.FRAMEBUFFER,E,t.TEXTURE_2D,A.textureGPU,0)}}}if(a>0&&_===!1&&!s.multiview){if(g===void 0){const w=[];g=t.createFramebuffer(),r.bindFramebuffer(t.FRAMEBUFFER,g);const N=[],E=e.textures;for(let A=0;A<E.length;A++){N[A]=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,N[A]),w.push(t.COLOR_ATTACHMENT0+A);const B=e.textures[A],R=this.get(B);t.renderbufferStorageMultisample(t.RENDERBUFFER,a,R.glInternalFormat,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+A,t.RENDERBUFFER,N[A])}if(t.bindRenderbuffer(t.RENDERBUFFER,null),o.msaaFrameBuffer=g,o.msaaRenderbuffers=N,c&&x===void 0){x=t.createRenderbuffer(),this.textureUtils.setupRenderBufferStorage(x,e,a),o.depthRenderbuffer=x;const A=l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;w.push(A)}o.invalidationArray=w}i=o.msaaFrameBuffer}else i=T;r.drawBuffers(e,T)}r.bindFramebuffer(t.FRAMEBUFFER,i)}_getVaoKey(e){let t="";for(let r=0;r<e.length;r++){const i=this.get(e[r]);t+=":"+i.id}return t}_createVao(e){const{gl:t}=this,r=t.createVertexArray();t.bindVertexArray(r);for(let i=0;i<e.length;i++){const s=e[i],o=this.get(s);t.bindBuffer(t.ARRAY_BUFFER,o.bufferGPU),t.enableVertexAttribArray(i);let a,c;s.isInterleavedBufferAttribute===!0?(a=s.data.stride*o.bytesPerElement,c=s.offset*o.bytesPerElement):(a=0,c=0),o.isInteger?t.vertexAttribIPointer(i,s.itemSize,o.type,a,c):t.vertexAttribPointer(i,s.itemSize,o.type,s.normalized,a,c),s.isInstancedBufferAttribute&&!s.isInterleavedBufferAttribute?t.vertexAttribDivisor(i,s.meshPerAttribute):s.isInterleavedBufferAttribute&&s.data.isInstancedInterleavedBuffer&&t.vertexAttribDivisor(i,s.data.meshPerAttribute)}return t.bindBuffer(t.ARRAY_BUFFER,null),r}_getTransformFeedback(e){let t="";for(let s=0;s<e.length;s++)t+=":"+e[s].id;let r=this.transformFeedbackCache[t];if(r!==void 0)return r;const{gl:i}=this;r=i.createTransformFeedback(),i.bindTransformFeedback(i.TRANSFORM_FEEDBACK,r);for(let s=0;s<e.length;s++){const o=e[s];i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,s,o.transformBuffer)}return i.bindTransformFeedback(i.TRANSFORM_FEEDBACK,null),this.transformFeedbackCache[t]=r,r}_setupBindings(e,t){const r=this.gl;for(const i of e)for(const s of i.bindings){const a=this.get(s).index;if(s.isUniformsGroup||s.isUniformBuffer){const c=r.getUniformBlockIndex(t,s.name);r.uniformBlockBinding(t,c,a)}else if(s.isSampledTexture){const c=r.getUniformLocation(t,s.name);r.uniform1i(c,a)}}}_bindUniforms(e){const{gl:t,state:r}=this;for(const i of e)for(const s of i.bindings){const o=this.get(s),a=o.index;s.isUniformsGroup||s.isUniformBuffer?r.bindBufferBase(t.UNIFORM_BUFFER,a,o.bufferGPU):s.isSampledTexture&&r.bindTexture(o.glTextureType,o.textureGPU,t.TEXTURE0+a)}}_resolveRenderTarget(e){const{gl:t,state:r}=this,i=e.renderTarget;if(e.textures!==null&&i){const s=this.get(i);if(i.samples>0&&this._useMultisampledExtension(i)===!1){const o=s.framebuffers[e.getCacheKey()];let a=t.COLOR_BUFFER_BIT;i.resolveDepthBuffer&&(i.depthBuffer&&(a|=t.DEPTH_BUFFER_BIT),i.stencilBuffer&&i.resolveStencilBuffer&&(a|=t.STENCIL_BUFFER_BIT));const c=s.msaaFrameBuffer,l=s.msaaRenderbuffers,u=e.textures,d=u.length>1;if(r.bindFramebuffer(t.READ_FRAMEBUFFER,c),r.bindFramebuffer(t.DRAW_FRAMEBUFFER,o),d)for(let h=0;h<u.length;h++)t.framebufferRenderbuffer(t.READ_FRAMEBUFFER,t.COLOR_ATTACHMENT0+h,t.RENDERBUFFER,null),t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0+h,t.TEXTURE_2D,null,0);for(let h=0;h<u.length;h++){if(d){const{textureGPU:f}=this.get(u[h]);t.framebufferRenderbuffer(t.READ_FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,l[h]),t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,f,0)}if(e.scissor){const{x:f,y:p,width:g,height:x}=e.scissorValue,m=e.height-x-p;t.blitFramebuffer(f,m,f+g,m+x,f,m,f+g,m+x,a,t.NEAREST)}else t.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,a,t.NEAREST)}if(d)for(let h=0;h<u.length;h++){const{textureGPU:f}=this.get(u[h]);t.framebufferRenderbuffer(t.READ_FRAMEBUFFER,t.COLOR_ATTACHMENT0+h,t.RENDERBUFFER,l[h]),t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0+h,t.TEXTURE_2D,f,0)}this._supportsInvalidateFramebuffer===!0&&t.invalidateFramebuffer(t.READ_FRAMEBUFFER,s.invalidationArray)}else if(i.resolveDepthBuffer===!1&&s.framebuffers){const o=s.framebuffers[e.getCacheKey()];r.bindFramebuffer(t.DRAW_FRAMEBUFFER,o),t.invalidateFramebuffer(t.DRAW_FRAMEBUFFER,s.depthInvalidationArray)}}}_useMultisampledExtension(e){return e.multiview===!0?!0:e.samples>0&&this.extensions.has("WEBGL_multisampled_render_to_texture")===!0&&e._autoAllocateDepthBuffer!==!1}dispose(){this.textureUtils!==null&&this.textureUtils.dispose();const e=this.extensions.get("WEBGL_lose_context");e&&e.loseContext(),this.renderer.domElement.removeEventListener("webglcontextlost",this._onContextLost)}}const cs={PointList:"point-list",LineList:"line-list",LineStrip:"line-strip",TriangleList:"triangle-list",TriangleStrip:"triangle-strip"},bt={Never:"never",Less:"less",Equal:"equal",LessEqual:"less-equal",Greater:"greater",NotEqual:"not-equal",GreaterEqual:"greater-equal",Always:"always"},Mt={Store:"store"},De={Load:"load",Clear:"clear"},ex={CCW:"ccw",CW:"cw"},tx={None:"none",Back:"back"},Bs={Uint16:"uint16",Uint32:"uint32"},C={R8Unorm:"r8unorm",R8Snorm:"r8snorm",R8Uint:"r8uint",R8Sint:"r8sint",R16Uint:"r16uint",R16Sint:"r16sint",R16Float:"r16float",RG8Unorm:"rg8unorm",RG8Snorm:"rg8snorm",RG8Uint:"rg8uint",RG8Sint:"rg8sint",R32Uint:"r32uint",R32Sint:"r32sint",R32Float:"r32float",RG16Uint:"rg16uint",RG16Sint:"rg16sint",RG16Float:"rg16float",RGBA8Unorm:"rgba8unorm",RGBA8UnormSRGB:"rgba8unorm-srgb",RGBA8Snorm:"rgba8snorm",RGBA8Uint:"rgba8uint",RGBA8Sint:"rgba8sint",BGRA8Unorm:"bgra8unorm",BGRA8UnormSRGB:"bgra8unorm-srgb",RGB9E5UFloat:"rgb9e5ufloat",RGB10A2Unorm:"rgb10a2unorm",RG11B10UFloat:"rg11b10ufloat",RG32Uint:"rg32uint",RG32Sint:"rg32sint",RG32Float:"rg32float",RGBA16Uint:"rgba16uint",RGBA16Sint:"rgba16sint",RGBA16Float:"rgba16float",RGBA32Uint:"rgba32uint",RGBA32Sint:"rgba32sint",RGBA32Float:"rgba32float",Depth16Unorm:"depth16unorm",Depth24Plus:"depth24plus",Depth24PlusStencil8:"depth24plus-stencil8",Depth32Float:"depth32float",Depth32FloatStencil8:"depth32float-stencil8",BC1RGBAUnorm:"bc1-rgba-unorm",BC1RGBAUnormSRGB:"bc1-rgba-unorm-srgb",BC2RGBAUnorm:"bc2-rgba-unorm",BC2RGBAUnormSRGB:"bc2-rgba-unorm-srgb",BC3RGBAUnorm:"bc3-rgba-unorm",BC3RGBAUnormSRGB:"bc3-rgba-unorm-srgb",BC4RUnorm:"bc4-r-unorm",BC4RSnorm:"bc4-r-snorm",BC5RGUnorm:"bc5-rg-unorm",BC5RGSnorm:"bc5-rg-snorm",BC6HRGBUFloat:"bc6h-rgb-ufloat",BC6HRGBFloat:"bc6h-rgb-float",BC7RGBAUnorm:"bc7-rgba-unorm",BC7RGBAUnormSRGB:"bc7-rgba-unorm-srgb",ETC2RGB8Unorm:"etc2-rgb8unorm",ETC2RGB8UnormSRGB:"etc2-rgb8unorm-srgb",ETC2RGB8A1Unorm:"etc2-rgb8a1unorm",ETC2RGB8A1UnormSRGB:"etc2-rgb8a1unorm-srgb",ETC2RGBA8Unorm:"etc2-rgba8unorm",ETC2RGBA8UnormSRGB:"etc2-rgba8unorm-srgb",EACR11Unorm:"eac-r11unorm",EACR11Snorm:"eac-r11snorm",EACRG11Unorm:"eac-rg11unorm",EACRG11Snorm:"eac-rg11snorm",ASTC4x4Unorm:"astc-4x4-unorm",ASTC4x4UnormSRGB:"astc-4x4-unorm-srgb",ASTC5x4Unorm:"astc-5x4-unorm",ASTC5x4UnormSRGB:"astc-5x4-unorm-srgb",ASTC5x5Unorm:"astc-5x5-unorm",ASTC5x5UnormSRGB:"astc-5x5-unorm-srgb",ASTC6x5Unorm:"astc-6x5-unorm",ASTC6x5UnormSRGB:"astc-6x5-unorm-srgb",ASTC6x6Unorm:"astc-6x6-unorm",ASTC6x6UnormSRGB:"astc-6x6-unorm-srgb",ASTC8x5Unorm:"astc-8x5-unorm",ASTC8x5UnormSRGB:"astc-8x5-unorm-srgb",ASTC8x6Unorm:"astc-8x6-unorm",ASTC8x6UnormSRGB:"astc-8x6-unorm-srgb",ASTC8x8Unorm:"astc-8x8-unorm",ASTC8x8UnormSRGB:"astc-8x8-unorm-srgb",ASTC10x5Unorm:"astc-10x5-unorm",ASTC10x5UnormSRGB:"astc-10x5-unorm-srgb",ASTC10x6Unorm:"astc-10x6-unorm",ASTC10x6UnormSRGB:"astc-10x6-unorm-srgb",ASTC10x8Unorm:"astc-10x8-unorm",ASTC10x8UnormSRGB:"astc-10x8-unorm-srgb",ASTC10x10Unorm:"astc-10x10-unorm",ASTC10x10UnormSRGB:"astc-10x10-unorm-srgb",ASTC12x10Unorm:"astc-12x10-unorm",ASTC12x10UnormSRGB:"astc-12x10-unorm-srgb",ASTC12x12Unorm:"astc-12x12-unorm",ASTC12x12UnormSRGB:"astc-12x12-unorm-srgb"},od={ClampToEdge:"clamp-to-edge",Repeat:"repeat",MirrorRepeat:"mirror-repeat"},gi={Linear:"linear",Nearest:"nearest"},Ne={Zero:"zero",One:"one",Src:"src",OneMinusSrc:"one-minus-src",SrcAlpha:"src-alpha",OneMinusSrcAlpha:"one-minus-src-alpha",Dst:"dst",OneMinusDst:"one-minus-dst",DstAlpha:"dst-alpha",OneMinusDstAlpha:"one-minus-dst-alpha",SrcAlphaSaturated:"src-alpha-saturated",Constant:"constant",OneMinusConstant:"one-minus-constant"},ii={Add:"add",Subtract:"subtract",ReverseSubtract:"reverse-subtract",Min:"min",Max:"max"},nx={None:0,All:15},Er={Keep:"keep",Zero:"zero",Replace:"replace",Invert:"invert",IncrementClamp:"increment-clamp",DecrementClamp:"decrement-clamp",IncrementWrap:"increment-wrap",DecrementWrap:"decrement-wrap"},ad={Storage:"storage",ReadOnlyStorage:"read-only-storage"},cd={WriteOnly:"write-only",ReadOnly:"read-only",ReadWrite:"read-write"},rx={NonFiltering:"non-filtering",Comparison:"comparison"},si={Float:"float",UnfilterableFloat:"unfilterable-float",Depth:"depth",SInt:"sint",UInt:"uint"},ix={TwoD:"2d",ThreeD:"3d"},ct={TwoD:"2d",TwoDArray:"2d-array",Cube:"cube",ThreeD:"3d"},WG={All:"all"},tc={Vertex:"vertex",Instance:"instance"},Uh={CoreFeaturesAndLimits:"core-features-and-limits",DepthClipControl:"depth-clip-control",Depth32FloatStencil8:"depth32float-stencil8",TextureCompressionBC:"texture-compression-bc",TextureCompressionBCSliced3D:"texture-compression-bc-sliced-3d",TextureCompressionETC2:"texture-compression-etc2",TextureCompressionASTC:"texture-compression-astc",TextureCompressionASTCSliced3D:"texture-compression-astc-sliced-3d",TimestampQuery:"timestamp-query",IndirectFirstInstance:"indirect-first-instance",ShaderF16:"shader-f16",RG11B10UFloat:"rg11b10ufloat-renderable",BGRA8UNormStorage:"bgra8unorm-storage",Float32Filterable:"float32-filterable",Float32Blendable:"float32-blendable",ClipDistances:"clip-distances",DualSourceBlending:"dual-source-blending",Subgroups:"subgroups",TextureFormatsTier1:"texture-formats-tier1",TextureFormatsTier2:"texture-formats-tier2"},sx={"texture-compression-s3tc":"texture-compression-bc","texture-compression-etc1":"texture-compression-etc2"};class qG extends jT{constructor(e,t,r){super(e,t?t.value:null),this.textureNode=t,this.groupNode=r}update(){const{textureNode:e}=this;return this.texture!==e.value?(this.texture=e.value,!0):super.update()}}class XG extends GT{constructor(e,t){super(e,t?t.array:null),this.attribute=t,this.isStorageBuffer=!0}}let YG=0;class KG extends XG{constructor(e,t){super("StorageBuffer_"+YG++,e?e.value:null),this.nodeUniform=e,this.access=e?e.access:On.READ_WRITE,this.groupNode=t}get buffer(){return this.nodeUniform.value}}class QG extends Wr{constructor(e){super(),this.device=e;const t=`
struct VarysStruct {
	@builtin( position ) Position: vec4<f32>,
	@location( 0 ) vTex : vec2<f32>
};

@vertex
fn main( @builtin( vertex_index ) vertexIndex : u32 ) -> VarysStruct {

	var Varys : VarysStruct;

	var pos = array< vec2<f32>, 4 >(
		vec2<f32>( -1.0,  1.0 ),
		vec2<f32>(  1.0,  1.0 ),
		vec2<f32>( -1.0, -1.0 ),
		vec2<f32>(  1.0, -1.0 )
	);

	var tex = array< vec2<f32>, 4 >(
		vec2<f32>( 0.0, 0.0 ),
		vec2<f32>( 1.0, 0.0 ),
		vec2<f32>( 0.0, 1.0 ),
		vec2<f32>( 1.0, 1.0 )
	);

	Varys.vTex = tex[ vertexIndex ];
	Varys.Position = vec4<f32>( pos[ vertexIndex ], 0.0, 1.0 );

	return Varys;

}
`,r=`
@group( 0 ) @binding( 0 )
var imgSampler : sampler;

@group( 0 ) @binding( 1 )
var img : texture_2d<f32>;

@fragment
fn main( @location( 0 ) vTex : vec2<f32> ) -> @location( 0 ) vec4<f32> {

	return textureSample( img, imgSampler, vTex );

}
`,i=`
@group( 0 ) @binding( 0 )
var imgSampler : sampler;

@group( 0 ) @binding( 1 )
var img : texture_2d<f32>;

@fragment
fn main( @location( 0 ) vTex : vec2<f32> ) -> @location( 0 ) vec4<f32> {

	return textureSample( img, imgSampler, vec2( vTex.x, 1.0 - vTex.y ) );

}
`;this.mipmapSampler=e.createSampler({minFilter:gi.Linear}),this.flipYSampler=e.createSampler({minFilter:gi.Nearest}),this.transferPipelines={},this.flipYPipelines={},this.mipmapVertexShaderModule=e.createShaderModule({label:"mipmapVertex",code:t}),this.mipmapFragmentShaderModule=e.createShaderModule({label:"mipmapFragment",code:r}),this.flipYFragmentShaderModule=e.createShaderModule({label:"flipYFragment",code:i})}getTransferPipeline(e){let t=this.transferPipelines[e];return t===void 0&&(t=this.device.createRenderPipeline({label:`mipmap-${e}`,vertex:{module:this.mipmapVertexShaderModule,entryPoint:"main"},fragment:{module:this.mipmapFragmentShaderModule,entryPoint:"main",targets:[{format:e}]},primitive:{topology:cs.TriangleStrip,stripIndexFormat:Bs.Uint32},layout:"auto"}),this.transferPipelines[e]=t),t}getFlipYPipeline(e){let t=this.flipYPipelines[e];return t===void 0&&(t=this.device.createRenderPipeline({label:`flipY-${e}`,vertex:{module:this.mipmapVertexShaderModule,entryPoint:"main"},fragment:{module:this.flipYFragmentShaderModule,entryPoint:"main",targets:[{format:e}]},primitive:{topology:cs.TriangleStrip,stripIndexFormat:Bs.Uint32},layout:"auto"}),this.flipYPipelines[e]=t),t}flipY(e,t,r=0){const i=t.format,{width:s,height:o}=t.size,a=this.getTransferPipeline(i),c=this.getFlipYPipeline(i),l=this.device.createTexture({size:{width:s,height:o,depthOrArrayLayers:1},format:i,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),u=e.createView({baseMipLevel:0,mipLevelCount:1,dimension:ct.TwoD,baseArrayLayer:r}),d=l.createView({baseMipLevel:0,mipLevelCount:1,dimension:ct.TwoD,baseArrayLayer:0}),h=this.device.createCommandEncoder({}),f=(p,g,x)=>{const m=p.getBindGroupLayout(0),y=this.device.createBindGroup({layout:m,entries:[{binding:0,resource:this.flipYSampler},{binding:1,resource:g}]}),_=h.beginRenderPass({colorAttachments:[{view:x,loadOp:De.Clear,storeOp:Mt.Store,clearValue:[0,0,0,0]}]});_.setPipeline(p),_.setBindGroup(0,y),_.draw(4,1,0,0),_.end()};f(a,u,d),f(c,d,u),this.device.queue.submit([h.finish()]),l.destroy()}generateMipmaps(e,t,r=0,i=null){const s=this.get(e);s.layers===void 0&&(s.layers=[]);const o=s.layers[r]||this._mipmapCreateBundles(e,t,r),a=i||this.device.createCommandEncoder({label:"mipmapEncoder"});this._mipmapRunBundles(a,o),i===null&&this.device.queue.submit([a.finish()]),s.layers[r]=o}_mipmapCreateBundles(e,t,r){const i=this.getTransferPipeline(t.format),s=i.getBindGroupLayout(0);let o=e.createView({baseMipLevel:0,mipLevelCount:1,dimension:ct.TwoD,baseArrayLayer:r});const a=[];for(let c=1;c<t.mipLevelCount;c++){const l=this.device.createBindGroup({layout:s,entries:[{binding:0,resource:this.mipmapSampler},{binding:1,resource:o}]}),u=e.createView({baseMipLevel:c,mipLevelCount:1,dimension:ct.TwoD,baseArrayLayer:r}),d={colorAttachments:[{view:u,loadOp:De.Clear,storeOp:Mt.Store,clearValue:[0,0,0,0]}]},h=this.device.createRenderBundleEncoder({colorFormats:[t.format]});h.setPipeline(i),h.setBindGroup(0,l),h.draw(4,1,0,0),a.push({renderBundles:[h.finish()],passDescriptor:d}),o=u}return a}_mipmapRunBundles(e,t){const r=t.length;for(let i=0;i<r;i++){const s=t[i],o=e.beginRenderPass(s.passDescriptor);o.executeBundles(s.renderBundles),o.end()}}}const ZG={[iy]:"never",[uf]:"less",[ty]:"equal",[ny]:"less-equal",[Jx]:"greater",[ey]:"greater-equal",[ry]:"always",[Zx]:"not-equal"},JG=[0,1,3,2,4,5];class e${constructor(e){this.backend=e,this._passUtils=null,this.defaultTexture={},this.defaultCubeTexture={},this.defaultVideoFrame=null,this._samplerCache=new Map}updateSampler(e){const t=this.backend,r=e.minFilter+"-"+e.magFilter+"-"+e.wrapS+"-"+e.wrapT+"-"+(e.wrapR||"0")+"-"+e.anisotropy+"-"+(e.compareFunction||0);let i=this._samplerCache.get(r);if(i===void 0){const o={addressModeU:this._convertAddressMode(e.wrapS),addressModeV:this._convertAddressMode(e.wrapT),addressModeW:this._convertAddressMode(e.wrapR),magFilter:this._convertFilterMode(e.magFilter),minFilter:this._convertFilterMode(e.minFilter),mipmapFilter:this._convertFilterMode(e.minFilter),maxAnisotropy:1};o.magFilter===gi.Linear&&o.minFilter===gi.Linear&&o.mipmapFilter===gi.Linear&&(o.maxAnisotropy=e.anisotropy),e.isDepthTexture&&e.compareFunction!==null&&(o.compare=ZG[e.compareFunction]),i={sampler:t.device.createSampler(o),usedTimes:0},this._samplerCache.set(r,i)}const s=t.get(e);if(s.sampler!==i.sampler){if(s.sampler!==void 0){const o=this._samplerCache.get(s.samplerKey);o.usedTimes--,o.usedTimes===0&&this._samplerCache.delete(s.samplerKey)}s.samplerKey=r,s.sampler=i.sampler,i.usedTimes++}return r}createDefaultTexture(e){let t;const r=Gh(e);e.isCubeTexture?t=this._getDefaultCubeTextureGPU(r):t=this._getDefaultTextureGPU(r),this.backend.get(e).texture=t}createTexture(e,t={}){const r=this.backend,i=r.get(e);if(i.initialized)throw new Error("WebGPUTextureUtils: Texture already initialized.");if(e.isExternalTexture){i.texture=e.sourceTexture,i.initialized=!0;return}t.needsMipmaps===void 0&&(t.needsMipmaps=!1),t.levels===void 0&&(t.levels=1),t.depth===void 0&&(t.depth=1);const{width:s,height:o,depth:a,levels:c}=t;e.isFramebufferTexture&&(t.renderTarget?t.format=this.backend.utils.getCurrentColorFormat(t.renderTarget):t.format=this.backend.utils.getPreferredCanvasFormat());const l=this._getDimension(e),u=e.internalFormat||t.format||Gh(e,r.device);i.format=u;const{samples:d,primarySamples:h,isMSAA:f}=r.utils.getTextureSampleData(e);let p=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC;e.isStorageTexture===!0&&(p|=GPUTextureUsage.STORAGE_BINDING),e.isCompressedTexture!==!0&&e.isCompressedArrayTexture!==!0&&u!==C.RGB9E5UFloat&&(p|=GPUTextureUsage.RENDER_ATTACHMENT);const g={label:e.name,size:{width:s,height:o,depthOrArrayLayers:a},mipLevelCount:c,sampleCount:h,dimension:l,format:u,usage:p};if(u===void 0){se("WebGPURenderer: Texture format not supported."),this.createDefaultTexture(e);return}if(e.isCubeTexture&&(g.textureBindingViewDimension=ct.Cube),i.texture=r.device.createTexture(g),f){const x=Object.assign({},g);x.label=x.label+"-msaa",x.sampleCount=d,x.mipLevelCount=1,i.msaaTexture=r.device.createTexture(x)}i.initialized=!0,i.textureDescriptorGPU=g}destroyTexture(e,t=!1){const r=this.backend,i=r.get(e);i.texture!==void 0&&t===!1&&i.texture.destroy(),i.msaaTexture!==void 0&&i.msaaTexture.destroy(),r.delete(e)}generateMipmaps(e,t=null){const r=this.backend.get(e);if(e.isCubeTexture)for(let i=0;i<6;i++)this._generateMipmaps(r.texture,r.textureDescriptorGPU,i,t);else{const i=e.image.depth||1;for(let s=0;s<i;s++)this._generateMipmaps(r.texture,r.textureDescriptorGPU,s,t)}}getColorBuffer(){const e=this.backend,t=e.renderer.getCanvasTarget(),{width:r,height:i}=e.getDrawingBufferSize(),s=e.renderer.currentSamples,o=t.colorTexture,a=e.get(o);if(o.width===r&&o.height===i&&o.samples===s)return a.texture;let c=a.texture;return c&&c.destroy(),c=e.device.createTexture({label:"colorBuffer",size:{width:r,height:i,depthOrArrayLayers:1},sampleCount:e.utils.getSampleCount(e.renderer.currentSamples),format:e.utils.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC}),o.source.width=r,o.source.height=i,o.samples=s,a.texture=c,c}getDepthBuffer(e=!0,t=!1){const r=this.backend,i=r.renderer.getCanvasTarget(),{width:s,height:o}=r.getDrawingBufferSize(),a=r.renderer.currentSamples,c=i.depthTexture;if(c.width===s&&c.height===o&&c.samples===a&&c.depth===e&&c.stencil===t)return r.get(c).texture;const l=r.get(c).texture;let u,d;if(t?(u=Or,d=Lr):e&&(u=Ur,d=dt),l!==void 0){if(c.image.width===s&&c.image.height===o&&c.format===u&&c.type===d&&c.samples===a)return l;this.destroyTexture(c)}return c.name="depthBuffer",c.format=u,c.type=d,c.image.width=s,c.image.height=o,c.samples=a,this.createTexture(c,{width:s,height:o}),r.get(c).texture}updateTexture(e,t){const r=this.backend.get(e),i=e.mipmaps,{textureDescriptorGPU:s}=r;if(!(e.isRenderTargetTexture||s===void 0)){if(e.isDataTexture)if(i.length>0)for(let o=0,a=i.length;o<a;o++){const c=i[o];this._copyBufferToTexture(c,r.texture,s,0,e.flipY,0,o)}else this._copyBufferToTexture(t.image,r.texture,s,0,e.flipY);else if(e.isArrayTexture||e.isDataArrayTexture||e.isData3DTexture)for(let o=0;o<t.image.depth;o++)this._copyBufferToTexture(t.image,r.texture,s,o,e.flipY,o);else if(e.isCompressedTexture||e.isCompressedArrayTexture)this._copyCompressedBufferToTexture(e.mipmaps,r.texture,s);else if(e.isCubeTexture)this._copyCubeMapToTexture(e,r.texture,s);else if(i.length>0)for(let o=0,a=i.length;o<a;o++){const c=i[o];this._copyImageToTexture(c,r.texture,s,0,e.flipY,e.premultiplyAlpha,o)}else this._copyImageToTexture(t.image,r.texture,s,0,e.flipY,e.premultiplyAlpha);r.version=e.version}}async copyTextureToBuffer(e,t,r,i,s,o){const a=this.backend.device,c=this.backend.get(e),l=c.texture,u=c.textureDescriptorGPU.format,d=this._getBytesPerTexel(u);let h=i*d;h=Math.ceil(h/256)*256;const f=a.createBuffer({size:(s-1)*h+i*d,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),p=a.createCommandEncoder();p.copyTextureToBuffer({texture:l,origin:{x:t,y:r,z:o}},{buffer:f,bytesPerRow:h},{width:i,height:s});const g=this._getTypedArrayType(u);a.queue.submit([p.finish()]),await f.mapAsync(GPUMapMode.READ);const x=f.getMappedRange();return new g(x)}dispose(){this._samplerCache.clear()}_getDefaultTextureGPU(e){let t=this.defaultTexture[e];if(t===void 0){const r=new lf;r.minFilter=xn,r.magFilter=xn,this.createTexture(r,{width:1,height:1,format:e}),this.defaultTexture[e]=t=r}return this.backend.get(t).texture}_getDefaultCubeTextureGPU(e){let t=this.defaultTexture[e];if(t===void 0){const r=new cf;r.minFilter=xn,r.magFilter=xn,this.createTexture(r,{width:1,height:1,depth:6}),this.defaultCubeTexture[e]=t=r}return this.backend.get(t).texture}_copyCubeMapToTexture(e,t,r){const i=e.images,s=e.mipmaps;for(let o=0;o<6;o++){const a=i[o],c=e.flipY===!0?JG[o]:o;a.isDataTexture?this._copyBufferToTexture(a.image,t,r,c,e.flipY):this._copyImageToTexture(a,t,r,c,e.flipY,e.premultiplyAlpha);for(let l=0;l<s.length;l++){const d=s[l].images[o];d.isDataTexture?this._copyBufferToTexture(d.image,t,r,c,e.flipY,0,l+1):this._copyImageToTexture(d,t,r,c,e.flipY,e.premultiplyAlpha,l+1)}}}_copyImageToTexture(e,t,r,i,s,o,a=0){const c=this.backend.device,l=a>0?e.width:r.size.width,u=a>0?e.height:r.size.height;c.queue.copyExternalImageToTexture({source:e,flipY:s},{texture:t,mipLevel:a,origin:{x:0,y:0,z:i},premultipliedAlpha:o},{width:l,height:u,depthOrArrayLayers:1})}_getPassUtils(){let e=this._passUtils;return e===null&&(this._passUtils=e=new QG(this.backend.device)),e}_generateMipmaps(e,t,r=0,i=null){this._getPassUtils().generateMipmaps(e,t,r,i)}_flipY(e,t,r=0){this._getPassUtils().flipY(e,t,r)}_copyBufferToTexture(e,t,r,i,s,o=0,a=0){const c=this.backend.device,l=e.data,u=this._getBytesPerTexel(r.format),d=e.width*u;c.queue.writeTexture({texture:t,mipLevel:a,origin:{x:0,y:0,z:i}},l,{offset:e.width*e.height*u*o,bytesPerRow:d},{width:e.width,height:e.height,depthOrArrayLayers:1}),s===!0&&this._flipY(t,r,i)}_copyCompressedBufferToTexture(e,t,r){const i=this.backend.device,s=this._getBlockData(r.format),o=r.size.depthOrArrayLayers>1;for(let a=0;a<e.length;a++){const c=e[a],l=c.width,u=c.height,d=o?r.size.depthOrArrayLayers:1,h=Math.ceil(l/s.width)*s.byteLength,f=h*Math.ceil(u/s.height);for(let p=0;p<d;p++)i.queue.writeTexture({texture:t,mipLevel:a,origin:{x:0,y:0,z:p}},c.data,{offset:p*f,bytesPerRow:h,rowsPerImage:Math.ceil(u/s.height)},{width:Math.ceil(l/s.width)*s.width,height:Math.ceil(u/s.height)*s.height,depthOrArrayLayers:1})}}_getBlockData(e){if(e===C.BC1RGBAUnorm||e===C.BC1RGBAUnormSRGB)return{byteLength:8,width:4,height:4};if(e===C.BC2RGBAUnorm||e===C.BC2RGBAUnormSRGB)return{byteLength:16,width:4,height:4};if(e===C.BC3RGBAUnorm||e===C.BC3RGBAUnormSRGB)return{byteLength:16,width:4,height:4};if(e===C.BC4RUnorm||e===C.BC4RSnorm)return{byteLength:8,width:4,height:4};if(e===C.BC5RGUnorm||e===C.BC5RGSnorm)return{byteLength:16,width:4,height:4};if(e===C.BC6HRGBUFloat||e===C.BC6HRGBFloat)return{byteLength:16,width:4,height:4};if(e===C.BC7RGBAUnorm||e===C.BC7RGBAUnormSRGB)return{byteLength:16,width:4,height:4};if(e===C.ETC2RGB8Unorm||e===C.ETC2RGB8UnormSRGB)return{byteLength:8,width:4,height:4};if(e===C.ETC2RGB8A1Unorm||e===C.ETC2RGB8A1UnormSRGB)return{byteLength:8,width:4,height:4};if(e===C.ETC2RGBA8Unorm||e===C.ETC2RGBA8UnormSRGB)return{byteLength:16,width:4,height:4};if(e===C.EACR11Unorm)return{byteLength:8,width:4,height:4};if(e===C.EACR11Snorm)return{byteLength:8,width:4,height:4};if(e===C.EACRG11Unorm)return{byteLength:16,width:4,height:4};if(e===C.EACRG11Snorm)return{byteLength:16,width:4,height:4};if(e===C.ASTC4x4Unorm||e===C.ASTC4x4UnormSRGB)return{byteLength:16,width:4,height:4};if(e===C.ASTC5x4Unorm||e===C.ASTC5x4UnormSRGB)return{byteLength:16,width:5,height:4};if(e===C.ASTC5x5Unorm||e===C.ASTC5x5UnormSRGB)return{byteLength:16,width:5,height:5};if(e===C.ASTC6x5Unorm||e===C.ASTC6x5UnormSRGB)return{byteLength:16,width:6,height:5};if(e===C.ASTC6x6Unorm||e===C.ASTC6x6UnormSRGB)return{byteLength:16,width:6,height:6};if(e===C.ASTC8x5Unorm||e===C.ASTC8x5UnormSRGB)return{byteLength:16,width:8,height:5};if(e===C.ASTC8x6Unorm||e===C.ASTC8x6UnormSRGB)return{byteLength:16,width:8,height:6};if(e===C.ASTC8x8Unorm||e===C.ASTC8x8UnormSRGB)return{byteLength:16,width:8,height:8};if(e===C.ASTC10x5Unorm||e===C.ASTC10x5UnormSRGB)return{byteLength:16,width:10,height:5};if(e===C.ASTC10x6Unorm||e===C.ASTC10x6UnormSRGB)return{byteLength:16,width:10,height:6};if(e===C.ASTC10x8Unorm||e===C.ASTC10x8UnormSRGB)return{byteLength:16,width:10,height:8};if(e===C.ASTC10x10Unorm||e===C.ASTC10x10UnormSRGB)return{byteLength:16,width:10,height:10};if(e===C.ASTC12x10Unorm||e===C.ASTC12x10UnormSRGB)return{byteLength:16,width:12,height:10};if(e===C.ASTC12x12Unorm||e===C.ASTC12x12UnormSRGB)return{byteLength:16,width:12,height:12}}_convertAddressMode(e){let t=od.ClampToEdge;return e===Tl?t=od.Repeat:e===vl&&(t=od.MirrorRepeat),t}_convertFilterMode(e){let t=gi.Linear;return(e===xn||e===Qx||e===Vo)&&(t=gi.Nearest),t}_getBytesPerTexel(e){if(e===C.R8Unorm||e===C.R8Snorm||e===C.R8Uint||e===C.R8Sint)return 1;if(e===C.R16Uint||e===C.R16Sint||e===C.R16Float||e===C.RG8Unorm||e===C.RG8Snorm||e===C.RG8Uint||e===C.RG8Sint)return 2;if(e===C.R32Uint||e===C.R32Sint||e===C.R32Float||e===C.RG16Uint||e===C.RG16Sint||e===C.RG16Float||e===C.RGBA8Unorm||e===C.RGBA8UnormSRGB||e===C.RGBA8Snorm||e===C.RGBA8Uint||e===C.RGBA8Sint||e===C.BGRA8Unorm||e===C.BGRA8UnormSRGB||e===C.RGB9E5UFloat||e===C.RGB10A2Unorm||e===C.RG11B10UFloat||e===C.Depth32Float||e===C.Depth24Plus||e===C.Depth24PlusStencil8||e===C.Depth32FloatStencil8)return 4;if(e===C.RG32Uint||e===C.RG32Sint||e===C.RG32Float||e===C.RGBA16Uint||e===C.RGBA16Sint||e===C.RGBA16Float)return 8;if(e===C.RGBA32Uint||e===C.RGBA32Sint||e===C.RGBA32Float)return 16}_getTypedArrayType(e){if(e===C.R8Uint)return Uint8Array;if(e===C.R8Sint)return Int8Array;if(e===C.R8Unorm)return Uint8Array;if(e===C.R8Snorm)return Int8Array;if(e===C.RG8Uint)return Uint8Array;if(e===C.RG8Sint)return Int8Array;if(e===C.RG8Unorm)return Uint8Array;if(e===C.RG8Snorm)return Int8Array;if(e===C.RGBA8Uint)return Uint8Array;if(e===C.RGBA8Sint)return Int8Array;if(e===C.RGBA8Unorm||e===C.RGBA8UnormSRGB)return Uint8Array;if(e===C.RGBA8Snorm)return Int8Array;if(e===C.R16Uint)return Uint16Array;if(e===C.R16Sint)return Int16Array;if(e===C.RG16Uint)return Uint16Array;if(e===C.RG16Sint)return Int16Array;if(e===C.RGBA16Uint)return Uint16Array;if(e===C.RGBA16Sint)return Int16Array;if(e===C.R16Float||e===C.RG16Float||e===C.RGBA16Float)return Uint16Array;if(e===C.R32Uint)return Uint32Array;if(e===C.R32Sint)return Int32Array;if(e===C.R32Float)return Float32Array;if(e===C.RG32Uint)return Uint32Array;if(e===C.RG32Sint)return Int32Array;if(e===C.RG32Float)return Float32Array;if(e===C.RGBA32Uint)return Uint32Array;if(e===C.RGBA32Sint)return Int32Array;if(e===C.RGBA32Float)return Float32Array;if(e===C.BGRA8Unorm||e===C.BGRA8UnormSRGB)return Uint8Array;if(e===C.RGB10A2Unorm||e===C.RGB9E5UFloat||e===C.RG11B10UFloat)return Uint32Array;if(e===C.Depth32Float)return Float32Array;if(e===C.Depth24Plus||e===C.Depth24PlusStencil8)return Uint32Array;if(e===C.Depth32FloatStencil8)return Float32Array}_getDimension(e){let t;return e.is3DTexture||e.isData3DTexture?t=ix.ThreeD:t=ix.TwoD,t}}function Gh(n,e=null){const t=n.format,r=n.type,i=n.colorSpace,s=ut.getTransfer(i);let o;if(n.isCompressedTexture===!0||n.isCompressedArrayTexture===!0)switch(t){case fc:case pc:o=s===ye?C.BC1RGBAUnormSRGB:C.BC1RGBAUnorm;break;case gc:o=s===ye?C.BC2RGBAUnormSRGB:C.BC2RGBAUnorm;break;case mc:o=s===ye?C.BC3RGBAUnormSRGB:C.BC3RGBAUnorm;break;case Hd:o=C.BC4RUnorm;break;case Wd:o=C.BC4RSnorm;break;case qd:o=C.BC5RGUnorm;break;case Xd:o=C.BC5RGSnorm;break;case jd:o=s===ye?C.BC7RGBAUnormSRGB:C.BC7RGBAUnorm;break;case Rd:case Ad:o=s===ye?C.ETC2RGB8UnormSRGB:C.ETC2RGB8Unorm;break;case Cd:o=s===ye?C.ETC2RGBA8UnormSRGB:C.ETC2RGBA8Unorm;break;case Md:o=s===ye?C.ASTC4x4UnormSRGB:C.ASTC4x4Unorm;break;case Pd:o=s===ye?C.ASTC5x4UnormSRGB:C.ASTC5x4Unorm;break;case Dd:o=s===ye?C.ASTC5x5UnormSRGB:C.ASTC5x5Unorm;break;case Bd:o=s===ye?C.ASTC6x5UnormSRGB:C.ASTC6x5Unorm;break;case Fd:o=s===ye?C.ASTC6x6UnormSRGB:C.ASTC6x6Unorm;break;case kd:o=s===ye?C.ASTC8x5UnormSRGB:C.ASTC8x5Unorm;break;case Id:o=s===ye?C.ASTC8x6UnormSRGB:C.ASTC8x6Unorm;break;case Ld:o=s===ye?C.ASTC8x8UnormSRGB:C.ASTC8x8Unorm;break;case Od:o=s===ye?C.ASTC10x5UnormSRGB:C.ASTC10x5Unorm;break;case Ud:o=s===ye?C.ASTC10x6UnormSRGB:C.ASTC10x6Unorm;break;case Gd:o=s===ye?C.ASTC10x8UnormSRGB:C.ASTC10x8Unorm;break;case $d:o=s===ye?C.ASTC10x10UnormSRGB:C.ASTC10x10Unorm;break;case Vd:o=s===ye?C.ASTC12x10UnormSRGB:C.ASTC12x10Unorm;break;case zd:o=s===ye?C.ASTC12x12UnormSRGB:C.ASTC12x12Unorm;break;case _n:o=s===ye?C.RGBA8UnormSRGB:C.RGBA8Unorm;break;default:ie("WebGPURenderer: Unsupported texture format.",t)}else switch(t){case _n:switch(r){case Co:o=C.RGBA8Snorm;break;case Mo:o=C.RGBA16Sint;break;case is:o=C.RGBA16Uint;break;case dt:o=C.RGBA32Uint;break;case Pt:o=C.RGBA32Sint;break;case Qt:o=s===ye?C.RGBA8UnormSRGB:C.RGBA8Unorm;break;case Ft:o=C.RGBA16Float;break;case nn:o=C.RGBA32Float;break;default:ie("WebGPURenderer: Unsupported texture type with RGBAFormat.",r)}break;case df:switch(r){case Ny:o=C.RGB9E5UFloat;break;case Ey:o=C.RG11B10UFloat;break;default:ie("WebGPURenderer: Unsupported texture type with RGBFormat.",r)}break;case hf:switch(r){case Co:o=C.R8Snorm;break;case Mo:o=C.R16Sint;break;case is:o=C.R16Uint;break;case dt:o=C.R32Uint;break;case Pt:o=C.R32Sint;break;case Qt:o=C.R8Unorm;break;case Ft:o=C.R16Float;break;case nn:o=C.R32Float;break;default:ie("WebGPURenderer: Unsupported texture type with RedFormat.",r)}break;case Fr:switch(r){case Co:o=C.RG8Snorm;break;case Mo:o=C.RG16Sint;break;case is:o=C.RG16Uint;break;case dt:o=C.RG32Uint;break;case Pt:o=C.RG32Sint;break;case Qt:o=C.RG8Unorm;break;case Ft:o=C.RG16Float;break;case nn:o=C.RG32Float;break;default:ie("WebGPURenderer: Unsupported texture type with RGFormat.",r)}break;case Ur:switch(r){case is:o=C.Depth16Unorm;break;case dt:o=C.Depth24Plus;break;case nn:o=C.Depth32Float;break;default:ie("WebGPURenderer: Unsupported texture type with DepthFormat.",r)}break;case Or:switch(r){case Lr:o=C.Depth24PlusStencil8;break;case nn:e&&e.features.has(Uh.Depth32FloatStencil8)===!1&&ie('WebGPURenderer: Depth textures with DepthStencilFormat + FloatType can only be used with the "depth32float-stencil8" GPU feature.'),o=C.Depth32FloatStencil8;break;default:ie("WebGPURenderer: Unsupported texture type with DepthStencilFormat.",r)}break;case ff:switch(r){case Pt:o=C.R32Sint;break;case dt:o=C.R32Uint;break;default:ie("WebGPURenderer: Unsupported texture type with RedIntegerFormat.",r)}break;case pf:switch(r){case Pt:o=C.RG32Sint;break;case dt:o=C.RG32Uint;break;default:ie("WebGPURenderer: Unsupported texture type with RGIntegerFormat.",r)}break;case gf:switch(r){case Pt:o=C.RGBA32Sint;break;case dt:o=C.RGBA32Uint;break;default:ie("WebGPURenderer: Unsupported texture type with RGBAIntegerFormat.",r)}break;default:ie("WebGPURenderer: Unsupported texture format.",t)}return o}const t$=/^[fn]*\s*([a-z_0-9]+)?\s*\(([\s\S]*?)\)\s*[\-\>]*\s*([a-z_0-9]+(?:<[\s\S]+?>)?)/i,n$=/([a-z_0-9]+)\s*:\s*([a-z_0-9]+(?:<[\s\S]+?>)?)/ig,ox={f32:"float",i32:"int",u32:"uint",bool:"bool","vec2<f32>":"vec2","vec2<i32>":"ivec2","vec2<u32>":"uvec2","vec2<bool>":"bvec2",vec2f:"vec2",vec2i:"ivec2",vec2u:"uvec2",vec2b:"bvec2","vec3<f32>":"vec3","vec3<i32>":"ivec3","vec3<u32>":"uvec3","vec3<bool>":"bvec3",vec3f:"vec3",vec3i:"ivec3",vec3u:"uvec3",vec3b:"bvec3","vec4<f32>":"vec4","vec4<i32>":"ivec4","vec4<u32>":"uvec4","vec4<bool>":"bvec4",vec4f:"vec4",vec4i:"ivec4",vec4u:"uvec4",vec4b:"bvec4","mat2x2<f32>":"mat2",mat2x2f:"mat2","mat3x3<f32>":"mat3",mat3x3f:"mat3","mat4x4<f32>":"mat4",mat4x4f:"mat4",sampler:"sampler",texture_1d:"texture",texture_2d:"texture",texture_2d_array:"texture",texture_multisampled_2d:"cubeTexture",texture_depth_2d:"depthTexture",texture_depth_2d_array:"depthTexture",texture_depth_multisampled_2d:"depthTexture",texture_depth_cube:"depthTexture",texture_depth_cube_array:"depthTexture",texture_3d:"texture3D",texture_cube:"cubeTexture",texture_cube_array:"cubeTexture",texture_storage_1d:"storageTexture",texture_storage_2d:"storageTexture",texture_storage_2d_array:"storageTexture",texture_storage_3d:"storageTexture"},r$=n=>{n=n.trim();const e=n.match(t$);if(e!==null&&e.length===4){const t=e[2],r=[];let i=null;for(;(i=n$.exec(t))!==null;)r.push({name:i[1],type:i[2]});const s=[];for(let u=0;u<r.length;u++){const{name:d,type:h}=r[u];let f=h;f.startsWith("ptr")?f="pointer":(f.startsWith("texture")&&(f=h.split("<")[0]),f=ox[f]),s.push(new gp(f,d))}const o=n.substring(e[0].length),a=e[3]||"void",c=e[1]!==void 0?e[1]:"";return{type:ox[a]||a,inputs:s,name:c,inputsCode:t,blockCode:o,outputType:a}}else throw new Error("FunctionNode: Function is not a WGSL code.")};class i$ extends xp{constructor(e){const{type:t,inputs:r,name:i,inputsCode:s,blockCode:o,outputType:a}=r$(e);super(t,r,i),this.inputsCode=s,this.blockCode=o,this.outputType=a}getCode(e=this.name){const t=this.outputType!=="void"?"-> "+this.outputType:"";return`fn ${e} ( ${this.inputsCode.trim()} ) ${t}`+this.blockCode}}class s$ extends LT{parseFunction(e){return new i$(e)}}const es=typeof self<"u"?self.GPUShaderStage:{VERTEX:1,FRAGMENT:2,COMPUTE:4},o$={[On.READ_ONLY]:"read",[On.WRITE_ONLY]:"write",[On.READ_WRITE]:"read_write"},ax={[Tl]:"repeat",[$o]:"clamp",[vl]:"mirror"},nc={vertex:es?es.VERTEX:1,fragment:es?es.FRAGMENT:2,compute:es?es.COMPUTE:4},cx={instance:!0,swizzleAssign:!1,storageBuffer:!0},a$={"^^":"tsl_xor"},c$={float:"f32",int:"i32",uint:"u32",bool:"bool",color:"vec3<f32>",vec2:"vec2<f32>",ivec2:"vec2<i32>",uvec2:"vec2<u32>",bvec2:"vec2<bool>",vec3:"vec3<f32>",ivec3:"vec3<i32>",uvec3:"vec3<u32>",bvec3:"vec3<bool>",vec4:"vec4<f32>",ivec4:"vec4<i32>",uvec4:"vec4<u32>",bvec4:"vec4<bool>",mat2:"mat2x2<f32>",mat3:"mat3x3<f32>",mat4:"mat4x4<f32>"},lx={},yo={tsl_xor:new _t("fn tsl_xor( a : bool, b : bool ) -> bool { return ( a || b ) && !( a && b ); }"),mod_float:new _t("fn tsl_mod_float( x : f32, y : f32 ) -> f32 { return x - y * floor( x / y ); }"),mod_vec2:new _t("fn tsl_mod_vec2( x : vec2f, y : vec2f ) -> vec2f { return x - y * floor( x / y ); }"),mod_vec3:new _t("fn tsl_mod_vec3( x : vec3f, y : vec3f ) -> vec3f { return x - y * floor( x / y ); }"),mod_vec4:new _t("fn tsl_mod_vec4( x : vec4f, y : vec4f ) -> vec4f { return x - y * floor( x / y ); }"),equals_bool:new _t("fn tsl_equals_bool( a : bool, b : bool ) -> bool { return a == b; }"),equals_bvec2:new _t("fn tsl_equals_bvec2( a : vec2f, b : vec2f ) -> vec2<bool> { return vec2<bool>( a.x == b.x, a.y == b.y ); }"),equals_bvec3:new _t("fn tsl_equals_bvec3( a : vec3f, b : vec3f ) -> vec3<bool> { return vec3<bool>( a.x == b.x, a.y == b.y, a.z == b.z ); }"),equals_bvec4:new _t("fn tsl_equals_bvec4( a : vec4f, b : vec4f ) -> vec4<bool> { return vec4<bool>( a.x == b.x, a.y == b.y, a.z == b.z, a.w == b.w ); }"),repeatWrapping_float:new _t("fn tsl_repeatWrapping_float( coord: f32 ) -> f32 { return fract( coord ); }"),mirrorWrapping_float:new _t("fn tsl_mirrorWrapping_float( coord: f32 ) -> f32 { let mirrored = fract( coord * 0.5 ) * 2.0; return 1.0 - abs( 1.0 - mirrored ); }"),clampWrapping_float:new _t("fn tsl_clampWrapping_float( coord: f32 ) -> f32 { return clamp( coord, 0.0, 1.0 ); }"),biquadraticTexture:new _t(`
fn tsl_biquadraticTexture( map : texture_2d<f32>, coord : vec2f, iRes : vec2u, level : u32 ) -> vec4f {

	let res = vec2f( iRes );

	let uvScaled = coord * res;
	let uvWrapping = ( ( uvScaled % res ) + res ) % res;

	// https://www.shadertoy.com/view/WtyXRy

	let uv = uvWrapping - 0.5;
	let iuv = floor( uv );
	let f = fract( uv );

	let rg1 = textureLoad( map, vec2u( iuv + vec2( 0.5, 0.5 ) ) % iRes, level );
	let rg2 = textureLoad( map, vec2u( iuv + vec2( 1.5, 0.5 ) ) % iRes, level );
	let rg3 = textureLoad( map, vec2u( iuv + vec2( 0.5, 1.5 ) ) % iRes, level );
	let rg4 = textureLoad( map, vec2u( iuv + vec2( 1.5, 1.5 ) ) % iRes, level );

	return mix( mix( rg1, rg2, f.x ), mix( rg3, rg4, f.x ), f.y );

}
`)},l$={dFdx:"dpdx",dFdy:"- dpdy",mod_float:"tsl_mod_float",mod_vec2:"tsl_mod_vec2",mod_vec3:"tsl_mod_vec3",mod_vec4:"tsl_mod_vec4",equals_bool:"tsl_equals_bool",equals_bvec2:"tsl_equals_bvec2",equals_bvec3:"tsl_equals_bvec3",equals_bvec4:"tsl_equals_bvec4",inversesqrt:"inverseSqrt",bitcast:"bitcast<f32>"};let XT="";(typeof navigator<"u"&&/Firefox|Deno/g.test(navigator.userAgent))!==!0&&(XT+=`diagnostic( off, derivative_uniformity );
`);class u$ extends IT{constructor(e,t){super(e,t,new s$),this.uniformGroups={},this.builtins={},this.directives={},this.scopedArrays=new Map}_generateTextureSample(e,t,r,i,s,o=this.shaderStage){return o==="fragment"?i?s?`textureSample( ${t}, ${t}_sampler, ${r}, ${i}, ${s} )`:`textureSample( ${t}, ${t}_sampler, ${r}, ${i} )`:s?`textureSample( ${t}, ${t}_sampler, ${r}, ${s} )`:`textureSample( ${t}, ${t}_sampler, ${r} )`:this.generateTextureSampleLevel(e,t,r,"0",i)}generateTextureSampleLevel(e,t,r,i,s,o){return this.isUnfilterable(e)===!1?o?`textureSampleLevel( ${t}, ${t}_sampler, ${r}, ${i}, ${o} )`:`textureSampleLevel( ${t}, ${t}_sampler, ${r}, ${i} )`:this.isFilteredTexture(e)?this.generateFilteredTexture(e,t,r,o,i):this.generateTextureLod(e,t,r,s,o,i)}generateWrapFunction(e){const t=`tsl_coord_${ax[e.wrapS]}S_${ax[e.wrapT]}_${e.isData3DTexture?"3d":"2d"}T`;let r=lx[t];if(r===void 0){const i=[],s=e.isData3DTexture?"vec3f":"vec2f";let o=`fn ${t}( coord : ${s} ) -> ${s} {

	return ${s}(
`;const a=(c,l)=>{c===Tl?(i.push(yo.repeatWrapping_float),o+=`		tsl_repeatWrapping_float( coord.${l} )`):c===$o?(i.push(yo.clampWrapping_float),o+=`		tsl_clampWrapping_float( coord.${l} )`):c===vl?(i.push(yo.mirrorWrapping_float),o+=`		tsl_mirrorWrapping_float( coord.${l} )`):(o+=`		coord.${l}`,se(`WebGPURenderer: Unsupported texture wrap type "${c}" for vertex shader.`))};a(e.wrapS,"x"),o+=`,
`,a(e.wrapT,"y"),e.isData3DTexture&&(o+=`,
`,a(e.wrapR,"z")),o+=`
	);

}
`,lx[t]=r=new _t(o,i)}return r.build(this),t}generateArrayDeclaration(e,t){return`array< ${this.getType(e)}, ${t} >`}generateTextureDimension(e,t,r){const i=this.getDataFromNode(e,this.shaderStage,this.globalCache);i.dimensionsSnippet===void 0&&(i.dimensionsSnippet={});let s=i.dimensionsSnippet[r];if(i.dimensionsSnippet[r]===void 0){let o,a;const{primarySamples:c}=this.renderer.backend.utils.getTextureSampleData(e),l=c>1;e.isData3DTexture?a="vec3<u32>":a="vec2<u32>",l||e.isStorageTexture?o=t:o=`${t}${r?`, u32( ${r} )`:""}`,s=new Ec(new Ac(`textureDimensions( ${o} )`,a)),i.dimensionsSnippet[r]=s,(e.isArrayTexture||e.isDataArrayTexture||e.isData3DTexture)&&(i.arrayLayerCount=new Ec(new Ac(`textureNumLayers(${t})`,"u32"))),e.isTextureCube&&(i.cubeFaceCount=new Ec(new Ac("6u","u32")))}return s.build(this)}generateFilteredTexture(e,t,r,i,s="0u"){this._include("biquadraticTexture");const o=this.generateWrapFunction(e),a=this.generateTextureDimension(e,t,s);return i&&(r=`${r} + vec2<f32>(${i}) / ${a}`),`tsl_biquadraticTexture( ${t}, ${o}( ${r} ), ${a}, u32( ${s} ) )`}generateTextureLod(e,t,r,i,s,o="0u"){const a=this.generateWrapFunction(e),c=this.generateTextureDimension(e,t,o),l=e.isData3DTexture?"vec3":"vec2";s&&(r=`${r} + ${l}<f32>(${s}) / ${l}<f32>( ${c} )`);const u=`${l}<u32>( ${a}( ${r} ) * ${l}<f32>( ${c} ) )`;return this.generateTextureLoad(e,t,u,o,i,null)}generateTextureLoad(e,t,r,i,s,o){i===null&&(i="0u"),o&&(r=`${r} + ${o}`);let a;return s?a=`textureLoad( ${t}, ${r}, ${s}, u32( ${i} ) )`:(a=`textureLoad( ${t}, ${r}, u32( ${i} ) )`,this.renderer.backend.compatibilityMode&&e.isDepthTexture&&(a+=".x")),a}generateTextureStore(e,t,r,i,s){let o;return i?o=`textureStore( ${t}, ${r}, ${i}, ${s} )`:o=`textureStore( ${t}, ${r}, ${s} )`,o}isSampleCompare(e){return e.isDepthTexture===!0&&e.compareFunction!==null}isUnfilterable(e){return this.getComponentTypeFromTexture(e)!=="float"||!this.isAvailable("float32Filterable")&&e.isDataTexture===!0&&e.type===nn||this.isSampleCompare(e)===!1&&e.minFilter===xn&&e.magFilter===xn||this.renderer.backend.utils.getTextureSampleData(e).primarySamples>1}generateTexture(e,t,r,i,s,o=this.shaderStage){let a=null;return this.isUnfilterable(e)?a=this.generateTextureLod(e,t,r,i,s,"0",o):a=this._generateTextureSample(e,t,r,i,s,o),a}generateTextureGrad(e,t,r,i,s,o,a=this.shaderStage){if(a==="fragment")return o?`textureSampleGrad( ${t}, ${t}_sampler, ${r},  ${i[0]}, ${i[1]}, ${o} )`:`textureSampleGrad( ${t}, ${t}_sampler, ${r},  ${i[0]}, ${i[1]} )`;ie(`WebGPURenderer: THREE.TextureNode.gradient() does not support ${a} shader.`)}generateTextureCompare(e,t,r,i,s,o,a=this.shaderStage){if(a==="fragment")return e.isDepthTexture===!0&&e.isArrayTexture===!0?o?`textureSampleCompare( ${t}, ${t}_sampler, ${r}, ${s}, ${i}, ${o} )`:`textureSampleCompare( ${t}, ${t}_sampler, ${r}, ${s}, ${i} )`:o?`textureSampleCompare( ${t}, ${t}_sampler, ${r}, ${i}, ${o} )`:`textureSampleCompare( ${t}, ${t}_sampler, ${r}, ${i} )`;ie(`WebGPURenderer: THREE.DepthTexture.compareFunction() does not support ${a} shader.`)}generateTextureLevel(e,t,r,i,s,o){return this.isUnfilterable(e)===!1?o?`textureSampleLevel( ${t}, ${t}_sampler, ${r}, ${i}, ${o} )`:`textureSampleLevel( ${t}, ${t}_sampler, ${r}, ${i} )`:this.isFilteredTexture(e)?this.generateFilteredTexture(e,t,r,o,i):this.generateTextureLod(e,t,r,s,o,i)}generateTextureBias(e,t,r,i,s,o,a=this.shaderStage){if(a==="fragment")return o?`textureSampleBias( ${t}, ${t}_sampler, ${r}, ${i}, ${o} )`:`textureSampleBias( ${t}, ${t}_sampler, ${r}, ${i} )`;ie(`WebGPURenderer: THREE.TextureNode.biasNode does not support ${a} shader.`)}getPropertyName(e,t=this.shaderStage){if(e.isNodeVarying===!0&&e.needsInterpolation===!0){if(t==="vertex")return`varyings.${e.name}`}else if(e.isNodeUniform===!0){const r=e.name,i=e.type;return i==="texture"||i==="cubeTexture"||i==="storageTexture"||i==="texture3D"?r:i==="buffer"||i==="storageBuffer"||i==="indirectStorageBuffer"?this.isCustomStruct(e)?r:r+".value":e.groupNode.name+"."+r}return super.getPropertyName(e)}getOutputStructName(){return"output"}getFunctionOperator(e){const t=a$[e];return t!==void 0?(this._include(t),t):null}getNodeAccess(e,t){return t!=="compute"?e.isAtomic===!0?(se("WebGPURenderer: Atomic operations are only supported in compute shaders."),On.READ_WRITE):On.READ_ONLY:e.access}getStorageAccess(e,t){return o$[this.getNodeAccess(e,t)]}getUniformFromNode(e,t,r,i=null){const s=super.getUniformFromNode(e,t,r,i),o=this.getDataFromNode(e,r,this.globalCache);if(o.uniformGPU===void 0){let a;const c=e.groupNode,l=c.name,u=this.getBindGroupArray(l,r);if(t==="texture"||t==="cubeTexture"||t==="storageTexture"||t==="texture3D"){let d=null;const h=this.getNodeAccess(e,r);if(t==="texture"||t==="storageTexture"?e.value.is3DTexture===!0?d=new Oh(s.name,s.node,c,h):d=new Wl(s.name,s.node,c,h):t==="cubeTexture"?d=new HT(s.name,s.node,c,h):t==="texture3D"&&(d=new Oh(s.name,s.node,c,h)),d.store=e.isStorageTextureNode===!0,d.mipLevel=d.store?e.mipLevel:0,d.setVisibility(nc[r]),this.isUnfilterable(e.value)===!1&&d.store===!1){const f=new qG(`${s.name}_sampler`,s.node,c);f.setVisibility(nc[r]),u.push(f,d),a=[f,d]}else u.push(d),a=[d]}else if(t==="buffer"||t==="storageBuffer"||t==="indirectStorageBuffer"){const d=t==="buffer"?VT:KG,h=new d(e,c);h.setVisibility(nc[r]),u.push(h),a=h,s.name=i||"NodeBuffer_"+s.id}else{const d=this.uniformGroups[r]||(this.uniformGroups[r]={});let h=d[l];h===void 0&&(h=new zT(l,c),h.setVisibility(nc[r]),d[l]=h,u.push(h)),a=this.getNodeUniform(s,t),h.addUniform(a)}o.uniformGPU=a}return s}getBuiltin(e,t,r,i=this.shaderStage){const s=this.builtins[i]||(this.builtins[i]=new Map);return s.has(e)===!1&&s.set(e,{name:e,property:t,type:r}),t}hasBuiltin(e,t=this.shaderStage){return this.builtins[t]!==void 0&&this.builtins[t].has(e)}getVertexIndex(){return this.shaderStage==="vertex"?this.getBuiltin("vertex_index","vertexIndex","u32","attribute"):"vertexIndex"}buildFunctionCode(e){const t=e.layout,r=this.flowShaderNode(e),i=[];for(const o of t.inputs)i.push(o.name+" : "+this.getType(o.type));let s=`fn ${t.name}( ${i.join(", ")} ) -> ${this.getType(t.type)} {
${r.vars}
${r.code}
`;return r.result&&(s+=`	return ${r.result};
`),s+=`
}
`,s}getInstanceIndex(){return this.shaderStage==="vertex"?this.getBuiltin("instance_index","instanceIndex","u32","attribute"):"instanceIndex"}getInvocationLocalIndex(){return this.getBuiltin("local_invocation_index","invocationLocalIndex","u32","attribute")}getSubgroupSize(){return this.enableSubGroups(),this.getBuiltin("subgroup_size","subgroupSize","u32","attribute")}getInvocationSubgroupIndex(){return this.enableSubGroups(),this.getBuiltin("subgroup_invocation_id","invocationSubgroupIndex","u32","attribute")}getSubgroupIndex(){return this.enableSubGroups(),this.getBuiltin("subgroup_id","subgroupIndex","u32","attribute")}getDrawIndex(){return null}getFrontFacing(){return this.getBuiltin("front_facing","isFront","bool")}getFragCoord(){return this.getBuiltin("position","fragCoord","vec4<f32>")+".xy"}getFragDepth(){return"output."+this.getBuiltin("frag_depth","depth","f32","output")}getClipDistance(){return"varyings.hw_clip_distances"}isFlipY(){return!1}enableDirective(e,t=this.shaderStage){(this.directives[t]||(this.directives[t]=new Set)).add(e)}getDirectives(e){const t=[],r=this.directives[e];if(r!==void 0)for(const i of r)t.push(`enable ${i};`);return t.join(`
`)}enableSubGroups(){this.enableDirective("subgroups")}enableSubgroupsF16(){this.enableDirective("subgroups-f16")}enableClipDistances(){this.enableDirective("clip_distances")}enableShaderF16(){this.enableDirective("f16")}enableDualSourceBlending(){this.enableDirective("dual_source_blending")}enableHardwareClipping(e){this.enableClipDistances(),this.getBuiltin("clip_distances","hw_clip_distances",`array<f32, ${e} >`,"vertex")}getBuiltins(e){const t=[],r=this.builtins[e];if(r!==void 0)for(const{name:i,property:s,type:o}of r.values())t.push(`@builtin( ${i} ) ${s} : ${o}`);return t.join(`,
	`)}getScopedArray(e,t,r,i){return this.scopedArrays.has(e)===!1&&this.scopedArrays.set(e,{name:e,scope:t,bufferType:r,bufferCount:i}),e}getScopedArrays(e){if(e!=="compute")return;const t=[];for(const{name:r,scope:i,bufferType:s,bufferCount:o}of this.scopedArrays.values()){const a=this.getType(s);t.push(`var<${i}> ${r}: array< ${a}, ${o} >;`)}return t.join(`
`)}getAttributes(e){const t=[];if(e==="compute"&&(this.getBuiltin("global_invocation_id","globalId","vec3<u32>","attribute"),this.getBuiltin("workgroup_id","workgroupId","vec3<u32>","attribute"),this.getBuiltin("local_invocation_id","localId","vec3<u32>","attribute"),this.getBuiltin("num_workgroups","numWorkgroups","vec3<u32>","attribute"),this.renderer.hasFeature("subgroups")&&(this.enableDirective("subgroups",e),this.getBuiltin("subgroup_size","subgroupSize","u32","attribute"))),e==="vertex"||e==="compute"){const r=this.getBuiltins("attribute");r&&t.push(r);const i=this.getAttributesArray();for(let s=0,o=i.length;s<o;s++){const a=i[s],c=a.name,l=this.getType(a.type);t.push(`@location( ${s} ) ${c} : ${l}`)}}return t.join(`,
	`)}getStructMembers(e){const t=[];for(const r of e.members){const i=e.output?"@location( "+r.index+" ) ":"";let s=this.getType(r.type);r.atomic&&(s="atomic< "+s+" >"),t.push(`	${i+r.name} : ${s}`)}return e.output&&t.push(`	${this.getBuiltins("output")}`),t.join(`,
`)}getStructs(e){let t="";const r=this.structs[e];if(r.length>0){const i=[];for(const s of r){let o=`struct ${s.name} {
`;o+=this.getStructMembers(s),o+=`
};`,i.push(o)}t=`
`+i.join(`

`)+`
`}return t}getVar(e,t,r=null){let i=`var ${t} : `;return r!==null?i+=this.generateArrayDeclaration(e,r):i+=this.getType(e),i}getVars(e){const t=[],r=this.vars[e];if(r!==void 0)for(const i of r)t.push(`	${this.getVar(i.type,i.name,i.count)};`);return`
${t.join(`
`)}
`}getVaryings(e){const t=[];if(e==="vertex"&&this.getBuiltin("position","Vertex","vec4<f32>","vertex"),e==="vertex"||e==="fragment"){const s=this.varyings,o=this.vars[e];for(let a=0;a<s.length;a++){const c=s[a];if(c.needsInterpolation){let l=`@location( ${a} )`;if(c.interpolationType){const u=c.interpolationSampling!==null?`, ${c.interpolationSampling} )`:" )";l+=` @interpolate( ${c.interpolationType}${u}`}else/^(int|uint|ivec|uvec)/.test(c.type)&&(l+=` @interpolate( ${this.renderer.backend.compatibilityMode?"flat, either":"flat"} )`);t.push(`${l} ${c.name} : ${this.getType(c.type)}`)}else e==="vertex"&&o.includes(c)===!1&&o.push(c)}}const r=this.getBuiltins(e);r&&t.push(r);const i=t.join(`,
	`);return e==="vertex"?this._getWGSLStruct("VaryingsStruct","	"+i):i}isCustomStruct(e){const t=e.value,r=e.node,i=(t.isBufferAttribute||t.isInstancedBufferAttribute)&&r.structTypeNode!==null,s=r.value&&r.value.array&&typeof r.value.itemSize=="number"&&r.value.array.length>r.value.itemSize;return i&&!s}getUniforms(e){const t=this.uniforms[e],r=[],i=[],s=[],o={};for(const c of t){const l=c.groupNode.name,u=this.bindingsIndexes[l];if(c.type==="texture"||c.type==="cubeTexture"||c.type==="storageTexture"||c.type==="texture3D"){const d=c.node.value;this.isUnfilterable(d)===!1&&c.node.isStorageTextureNode!==!0&&(this.isSampleCompare(d)?r.push(`@binding( ${u.binding++} ) @group( ${u.group} ) var ${c.name}_sampler : sampler_comparison;`):r.push(`@binding( ${u.binding++} ) @group( ${u.group} ) var ${c.name}_sampler : sampler;`));let h,f="";const{primarySamples:p}=this.renderer.backend.utils.getTextureSampleData(d);if(p>1&&(f="_multisampled"),d.isCubeTexture===!0)h="texture_cube<f32>";else if(d.isDepthTexture===!0)this.renderer.backend.compatibilityMode&&d.compareFunction===null?h=`texture${f}_2d<f32>`:h=`texture_depth${f}_2d${d.isArrayTexture===!0?"_array":""}`;else if(c.node.isStorageTextureNode===!0){const g=Gh(d),x=this.getStorageAccess(c.node,e),m=c.node.value.is3DTexture,y=c.node.value.isArrayTexture;h=`texture_storage_${m?"3d":`2d${y?"_array":""}`}<${g}, ${x}>`}else if(d.isArrayTexture===!0||d.isDataArrayTexture===!0||d.isCompressedArrayTexture===!0)h="texture_2d_array<f32>";else if(d.is3DTexture===!0||d.isData3DTexture===!0)h="texture_3d<f32>";else{const g=this.getComponentTypeFromTexture(d).charAt(0);h=`texture${f}_2d<${g}32>`}r.push(`@binding( ${u.binding++} ) @group( ${u.group} ) var ${c.name} : ${h};`)}else if(c.type==="buffer"||c.type==="storageBuffer"||c.type==="indirectStorageBuffer"){const d=c.node,h=this.getType(d.getNodeType(this)),f=d.bufferCount,p=f>0&&c.type==="buffer"?", "+f:"",g=d.isStorageBufferNode?`storage, ${this.getStorageAccess(d,e)}`:"uniform";if(this.isCustomStruct(c))i.push(`@binding( ${u.binding++} ) @group( ${u.group} ) var<${g}> ${c.name} : ${h};`);else{const m=`	value : array< ${d.isAtomic?`atomic<${h}>`:`${h}`}${p} >`;i.push(this._getWGSLStructBinding(c.name,m,g,u.binding++,u.group))}}else{const d=this.getType(this.getVectorType(c.type)),h=c.groupNode.name;(o[h]||(o[h]={index:u.binding++,id:u.group,snippets:[]})).snippets.push(`	${c.name} : ${d}`)}}for(const c in o){const l=o[c];s.push(this._getWGSLStructBinding(c,l.snippets.join(`,
`),"uniform",l.index,l.id))}let a=r.join(`
`);return a+=i.join(`
`),a+=s.join(`
`),a}buildCode(){const e=this.material!==null?{fragment:{},vertex:{}}:{compute:{}};this.sortBindingGroups();for(const t in e){this.shaderStage=t;const r=e[t];r.uniforms=this.getUniforms(t),r.attributes=this.getAttributes(t),r.varyings=this.getVaryings(t),r.structs=this.getStructs(t),r.vars=this.getVars(t),r.codes=this.getCodes(t),r.directives=this.getDirectives(t),r.scopedArrays=this.getScopedArrays(t);let i=`// code

`;i+=this.flowCode[t];const s=this.flowNodes[t],o=s[s.length-1],a=o.outputNode,c=a!==void 0&&a.isOutputStructNode===!0;for(const l of s){const u=this.getFlowData(l),d=l.name;if(d&&(i.length>0&&(i+=`
`),i+=`	// flow -> ${d}
`),i+=`${u.code}
	`,l===o&&t!=="compute"){if(i+=`// result

	`,t==="vertex")i+=`varyings.Vertex = ${u.result};`;else if(t==="fragment")if(c)r.returnType=a.getNodeType(this),r.structs+="var<private> output : "+r.returnType+";",i+=`return ${u.result};`;else{let h="	@location(0) color: vec4<f32>";const f=this.getBuiltins("output");f&&(h+=`,
	`+f),r.returnType="OutputStruct",r.structs+=this._getWGSLStruct("OutputStruct",h),r.structs+=`
var<private> output : OutputStruct;`,i+=`output.color = ${u.result};

	return output;`}}}r.flow=i}if(this.shaderStage=null,this.material!==null)this.vertexShader=this._getWGSLVertexCode(e.vertex),this.fragmentShader=this._getWGSLFragmentCode(e.fragment);else{const t=this.object.workgroupSize;this.computeShader=this._getWGSLComputeCode(e.compute,t)}}getMethod(e,t=null){let r;return t!==null&&(r=this._getWGSLMethod(e+"_"+t)),r===void 0&&(r=this._getWGSLMethod(e)),r||e}getBitcastMethod(e){return`bitcast<${this.getType(e)}>`}getTernary(e,t,r){return`select( ${r}, ${t}, ${e} )`}getType(e){return c$[e]||e}isAvailable(e){let t=cx[e];return t===void 0&&(e==="float32Filterable"?t=this.renderer.hasFeature("float32-filterable"):e==="clipDistance"&&(t=this.renderer.hasFeature("clip-distances")),cx[e]=t),t}_getWGSLMethod(e){return yo[e]!==void 0&&this._include(e),l$[e]}_include(e){const t=yo[e];return t.build(this),this.addInclude(t),t}_getWGSLVertexCode(e){return`${this.getSignature()}
// directives
${e.directives}

// structs
${e.structs}

// uniforms
${e.uniforms}

// varyings
${e.varyings}
var<private> varyings : VaryingsStruct;

// codes
${e.codes}

@vertex
fn main( ${e.attributes} ) -> VaryingsStruct {

	// vars
	${e.vars}

	// flow
	${e.flow}

	return varyings;

}
`}_getWGSLFragmentCode(e){return`${this.getSignature()}
// global
${XT}

// structs
${e.structs}

// uniforms
${e.uniforms}

// codes
${e.codes}

@fragment
fn main( ${e.varyings} ) -> ${e.returnType} {

	// vars
	${e.vars}

	// flow
	${e.flow}

}
`}_getWGSLComputeCode(e,t){const[r,i,s]=t;return`${this.getSignature()}
// directives
${e.directives}

// system
var<private> instanceIndex : u32;

// locals
${e.scopedArrays}

// structs
${e.structs}

// uniforms
${e.uniforms}

// codes
${e.codes}

@compute @workgroup_size( ${r}, ${i}, ${s} )
fn main( ${e.attributes} ) {

	// system
	instanceIndex = globalId.x
		+ globalId.y * ( ${r} * numWorkgroups.x )
		+ globalId.z * ( ${r} * numWorkgroups.x ) * ( ${i} * numWorkgroups.y );

	// vars
	${e.vars}

	// flow
	${e.flow}

}
`}_getWGSLStruct(e,t){return`
struct ${e} {
${t}
};`}_getWGSLStructBinding(e,t,r,i=0,s=0){const o=e+"Struct";return`${this._getWGSLStruct(o,t)}
@binding( ${i} ) @group( ${s} )
var<${r}> ${e} : ${o};`}}class d${constructor(e){this.backend=e}getCurrentDepthStencilFormat(e){let t;return e.depthTexture!==null?t=this.getTextureFormatGPU(e.depthTexture):e.depth&&e.stencil?t=C.Depth24PlusStencil8:e.depth&&(t=C.Depth24Plus),t}getTextureFormatGPU(e){return this.backend.get(e).format}getTextureSampleData(e){let t;if(e.isFramebufferTexture)t=1;else if(e.isDepthTexture&&!e.renderTarget){const s=this.backend.renderer,o=s.getRenderTarget();t=o?o.samples:s.currentSamples}else e.renderTarget&&(t=e.renderTarget.samples);t=t||1;const r=t>1&&e.renderTarget!==null&&e.isDepthTexture!==!0&&e.isFramebufferTexture!==!0;return{samples:t,primarySamples:r?1:t,isMSAA:r}}getCurrentColorFormat(e){let t;return e.textures!==null?t=this.getTextureFormatGPU(e.textures[0]):t=this.getPreferredCanvasFormat(),t}getCurrentColorFormats(e){return e.textures!==null?e.textures.map(t=>this.getTextureFormatGPU(t)):[this.getPreferredCanvasFormat()]}getCurrentColorSpace(e){return e.textures!==null?e.textures[0].colorSpace:this.backend.renderer.outputColorSpace}getPrimitiveTopology(e,t){if(e.isPoints)return cs.PointList;if(e.isLineSegments||e.isMesh&&t.wireframe===!0)return cs.LineList;if(e.isLine)return cs.LineStrip;if(e.isMesh)return cs.TriangleList}getSampleCount(e){return e>=4?4:1}getSampleCountRenderContext(e){return e.textures!==null?this.getSampleCount(e.sampleCount):this.getSampleCount(this.backend.renderer.currentSamples)}getPreferredCanvasFormat(){const e=this.backend.parameters.outputType;if(e===void 0)return navigator.gpu.getPreferredCanvasFormat();if(e===Qt)return C.BGRA8Unorm;if(e===Ft)return C.RGBA16Float;throw new Error("Unsupported outputType")}}const YT=new Map([[Int8Array,["sint8","snorm8"]],[Uint8Array,["uint8","unorm8"]],[Int16Array,["sint16","snorm16"]],[Uint16Array,["uint16","unorm16"]],[Int32Array,["sint32","snorm32"]],[Uint32Array,["uint32","unorm32"]],[Float32Array,["float32"]]]);typeof Float16Array<"u"&&YT.set(Float16Array,["float16"]);const h$=new Map([[Cy,["float16"]]]),f$=new Map([[Int32Array,"sint32"],[Int16Array,"sint32"],[Uint32Array,"uint32"],[Uint16Array,"uint32"],[Float32Array,"float32"]]);class p${constructor(e){this.backend=e}createAttribute(e,t){const r=this._getBufferAttribute(e),i=this.backend,s=i.get(r);let o=s.buffer;if(o===void 0){const a=i.device;let c=r.array;if(e.normalized===!1){if(c.constructor===Int16Array||c.constructor===Int8Array)c=new Int32Array(c);else if((c.constructor===Uint16Array||c.constructor===Uint8Array)&&(c=new Uint32Array(c),t&GPUBufferUsage.INDEX))for(let d=0;d<c.length;d++)c[d]===65535&&(c[d]=4294967295)}if(r.array=c,(r.isStorageBufferAttribute||r.isStorageInstancedBufferAttribute)&&r.itemSize===3){c=new c.constructor(r.count*4);for(let d=0;d<r.count;d++)c.set(r.array.subarray(d*3,d*3+3),d*4);r.itemSize=4,r.array=c,s._force3to4BytesAlignment=!0}const l=c.byteLength,u=l+(4-l%4)%4;o=a.createBuffer({label:r.name,size:u,usage:t,mappedAtCreation:!0}),new c.constructor(o.getMappedRange()).set(c),o.unmap(),s.buffer=o}}updateAttribute(e){const t=this._getBufferAttribute(e),r=this.backend,i=r.device,s=r.get(t),o=r.get(t).buffer;let a=t.array;if(s._force3to4BytesAlignment===!0){a=new a.constructor(t.count*4);for(let u=0;u<t.count;u++)a.set(t.array.subarray(u*3,u*3+3),u*4);t.array=a}const c=this._isTypedArray(a),l=t.updateRanges;if(l.length===0)i.queue.writeBuffer(o,0,a,0);else{const u=c?1:a.BYTES_PER_ELEMENT;for(let d=0,h=l.length;d<h;d++){const f=l[d];let p,g;if(s._force3to4BytesAlignment===!0){const m=Math.floor(f.start/3),y=Math.ceil(f.count/3);p=m*4*u,g=y*4*u}else p=f.start*u,g=f.count*u;const x=p*(c?a.BYTES_PER_ELEMENT:1);i.queue.writeBuffer(o,x,a,p,g)}t.clearUpdateRanges()}}createShaderVertexBuffers(e){const t=e.getAttributes(),r=new Map;for(let i=0;i<t.length;i++){const s=t[i],o=s.array.BYTES_PER_ELEMENT,a=this._getBufferAttribute(s);let c=r.get(a);if(c===void 0){let d,h;s.isInterleavedBufferAttribute===!0?(d=s.data.stride*o,h=s.data.isInstancedInterleavedBuffer?tc.Instance:tc.Vertex):(d=s.itemSize*o,h=s.isInstancedBufferAttribute?tc.Instance:tc.Vertex),s.normalized===!1&&(s.array.constructor===Int16Array||s.array.constructor===Uint16Array)&&(d=4),c={arrayStride:d,attributes:[],stepMode:h},r.set(a,c)}const l=this._getVertexFormat(s),u=s.isInterleavedBufferAttribute===!0?s.offset*o:0;c.attributes.push({shaderLocation:i,offset:u,format:l})}return Array.from(r.values())}destroyAttribute(e){const t=this.backend;t.get(this._getBufferAttribute(e)).buffer.destroy(),t.delete(e)}async getArrayBufferAsync(e){const t=this.backend,r=t.device,s=t.get(this._getBufferAttribute(e)).buffer,o=s.size,a=r.createBuffer({label:`${e.name}_readback`,size:o,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),c=r.createCommandEncoder({label:`readback_encoder_${e.name}`});c.copyBufferToBuffer(s,0,a,0,o);const l=c.finish();r.queue.submit([l]),await a.mapAsync(GPUMapMode.READ);const u=a.getMappedRange(),d=new e.array.constructor(u.slice(0));return a.unmap(),d.buffer}_getVertexFormat(e){const{itemSize:t,normalized:r}=e,i=e.array.constructor,s=e.constructor;let o;if(t===1)o=f$.get(i);else{const c=(h$.get(s)||YT.get(i))[r?1:0];if(c){const l=i.BYTES_PER_ELEMENT*t,d=Math.floor((l+3)/4)*4/i.BYTES_PER_ELEMENT;if(d%1)throw new Error("THREE.WebGPUAttributeUtils: Bad vertex format item size.");o=`${c}x${d}`}}return o||ie("WebGPUAttributeUtils: Vertex format not supported yet."),o}_isTypedArray(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)}_getBufferAttribute(e){return e.isInterleavedBufferAttribute&&(e=e.data),e}}class g${constructor(e){this.backend=e,this.bindGroupLayoutCache=new WeakMap}createBindingsLayout(e){const t=this.backend,r=t.device,i=[];let s=0;for(const o of e.bindings){const a={binding:s++,visibility:o.visibility};if(o.isUniformBuffer||o.isStorageBuffer){const c={};o.isStorageBuffer&&(o.visibility&4&&(o.access===On.READ_WRITE||o.access===On.WRITE_ONLY)?c.type=ad.Storage:c.type=ad.ReadOnlyStorage),a.buffer=c}else if(o.isSampledTexture&&o.store){const c={};c.format=this.backend.get(o.texture).texture.format;const l=o.access;l===On.READ_WRITE?c.access=cd.ReadWrite:l===On.WRITE_ONLY?c.access=cd.WriteOnly:c.access=cd.ReadOnly,o.texture.isArrayTexture?c.viewDimension=ct.TwoDArray:o.texture.is3DTexture&&(c.viewDimension=ct.ThreeD),a.storageTexture=c}else if(o.isSampledTexture){const c={},{primarySamples:l}=t.utils.getTextureSampleData(o.texture);if(l>1&&(c.multisampled=!0,o.texture.isDepthTexture||(c.sampleType=si.UnfilterableFloat)),o.texture.isDepthTexture)t.compatibilityMode&&o.texture.compareFunction===null?c.sampleType=si.UnfilterableFloat:c.sampleType=si.Depth;else if(o.texture.isDataTexture||o.texture.isDataArrayTexture||o.texture.isData3DTexture){const u=o.texture.type;u===Pt?c.sampleType=si.SInt:u===dt?c.sampleType=si.UInt:u===nn&&(this.backend.hasFeature("float32-filterable")?c.sampleType=si.Float:c.sampleType=si.UnfilterableFloat)}o.isSampledCubeTexture?c.viewDimension=ct.Cube:o.texture.isArrayTexture||o.texture.isDataArrayTexture||o.texture.isCompressedArrayTexture?c.viewDimension=ct.TwoDArray:o.isSampledTexture3D&&(c.viewDimension=ct.ThreeD),a.texture=c}else if(o.isSampler){const c={};o.texture.isDepthTexture&&(o.texture.compareFunction!==null?c.type=rx.Comparison:t.compatibilityMode&&(c.type=rx.NonFiltering)),a.sampler=c}else ie(`WebGPUBindingUtils: Unsupported binding "${o}".`);i.push(a)}return r.createBindGroupLayout({entries:i})}createBindings(e,t,r,i=0){const{backend:s,bindGroupLayoutCache:o}=this,a=s.get(e);let c=o.get(e.bindingsReference);c===void 0&&(c=this.createBindingsLayout(e),o.set(e.bindingsReference,c));let l;r>0&&(a.groups===void 0&&(a.groups=[],a.versions=[]),a.versions[r]===i&&(l=a.groups[r])),l===void 0&&(l=this.createBindGroup(e,c),r>0&&(a.groups[r]=l,a.versions[r]=i)),a.group=l,a.layout=c}updateBinding(e){const t=this.backend,r=t.device,i=e.buffer,s=t.get(e).buffer;r.queue.writeBuffer(s,0,i,0)}createBindGroupIndex(e,t){const i=this.backend.device,s=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,o=e[0],a=i.createBuffer({label:"bindingCameraIndex_"+o,size:16,usage:s});i.queue.writeBuffer(a,0,e,0);const c=[{binding:0,resource:{buffer:a}}];return i.createBindGroup({label:"bindGroupCameraIndex_"+o,layout:t,entries:c})}createBindGroup(e,t){const r=this.backend,i=r.device;let s=0;const o=[];for(const a of e.bindings){if(a.isUniformBuffer){const c=r.get(a);if(c.buffer===void 0){const l=a.byteLength,u=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,d=i.createBuffer({label:"bindingBuffer_"+a.name,size:l,usage:u});c.buffer=d}o.push({binding:s,resource:{buffer:c.buffer}})}else if(a.isStorageBuffer){const c=r.get(a);if(c.buffer===void 0){const l=a.attribute;c.buffer=r.get(l).buffer}o.push({binding:s,resource:{buffer:c.buffer}})}else if(a.isSampledTexture){const c=r.get(a.texture);let l;if(c.externalTexture!==void 0)l=i.importExternalTexture({source:c.externalTexture});else{const u=a.store?1:c.texture.mipLevelCount,d=a.store?a.mipLevel:0;let h=`view-${c.texture.width}-${c.texture.height}`;if(c.texture.depthOrArrayLayers>1&&(h+=`-${c.texture.depthOrArrayLayers}`),h+=`-${u}-${d}`,l=c[h],l===void 0){const f=WG.All;let p;a.isSampledCubeTexture?p=ct.Cube:a.isSampledTexture3D?p=ct.ThreeD:a.texture.isArrayTexture||a.texture.isDataArrayTexture||a.texture.isCompressedArrayTexture?p=ct.TwoDArray:p=ct.TwoD,l=c[h]=c.texture.createView({aspect:f,dimension:p,mipLevelCount:u,baseMipLevel:d})}}o.push({binding:s,resource:l})}else if(a.isSampler){const c=r.get(a.texture);o.push({binding:s,resource:c.sampler})}s++}return i.createBindGroup({label:"bindGroup_"+e.name,layout:t,entries:o})}}class m${constructor(e){this.backend=e,this._activePipelines=new WeakMap}setPipeline(e,t){this._activePipelines.get(e)!==t&&(e.setPipeline(t),this._activePipelines.set(e,t))}_getSampleCount(e){return this.backend.utils.getSampleCountRenderContext(e)}createRenderPipeline(e,t){const{object:r,material:i,geometry:s,pipeline:o}=e,{vertexProgram:a,fragmentProgram:c}=o,l=this.backend,u=l.device,d=l.utils,h=l.get(o),f=[];for(const F of e.getBindings()){const S=l.get(F);f.push(S.layout)}const p=l.attributeUtils.createShaderVertexBuffers(e);let g;i.blending!==vs&&(i.blending!==wi||i.transparent!==!1)&&(g=this._getBlending(i));let x={};i.stencilWrite===!0&&(x={compare:this._getStencilCompare(i),failOp:this._getStencilOperation(i.stencilFail),depthFailOp:this._getStencilOperation(i.stencilZFail),passOp:this._getStencilOperation(i.stencilZPass)});const m=this._getColorWriteMask(i),y=[];if(e.context.textures!==null){const F=e.context.textures;for(let S=0;S<F.length;S++){const U=d.getTextureFormatGPU(F[S]);y.push({format:U,blend:g,writeMask:m})}}else{const F=d.getCurrentColorFormat(e.context);y.push({format:F,blend:g,writeMask:m})}const _=l.get(a).module,v=l.get(c).module,T=this._getPrimitiveState(r,s,i),w=this._getDepthCompare(i),N=d.getCurrentDepthStencilFormat(e.context),E=this._getSampleCount(e.context),A={label:`renderPipeline_${i.name||i.type}_${i.id}`,vertex:Object.assign({},_,{buffers:p}),fragment:Object.assign({},v,{targets:y}),primitive:T,multisample:{count:E,alphaToCoverageEnabled:i.alphaToCoverage&&E>1},layout:u.createPipelineLayout({bindGroupLayouts:f})},B={},R=e.context.depth,L=e.context.stencil;if((R===!0||L===!0)&&(R===!0&&(B.format=N,B.depthWriteEnabled=i.depthWrite,B.depthCompare=w),L===!0&&(B.stencilFront=x,B.stencilBack={},B.stencilReadMask=i.stencilFuncMask,B.stencilWriteMask=i.stencilWriteMask),i.polygonOffset===!0&&(B.depthBias=i.polygonOffsetUnits,B.depthBiasSlopeScale=i.polygonOffsetFactor,B.depthBiasClamp=0),A.depthStencil=B),u.pushErrorScope("validation"),t===null)h.pipeline=u.createRenderPipeline(A),u.popErrorScope().then(F=>{F!==null&&(h.error=!0,ie(F.message))});else{const F=new Promise(async S=>{try{h.pipeline=await u.createRenderPipelineAsync(A)}catch{}const U=await u.popErrorScope();U!==null&&(h.error=!0,ie(U.message)),S()});t.push(F)}}createBundleEncoder(e,t="renderBundleEncoder"){const r=this.backend,{utils:i,device:s}=r,o=i.getCurrentDepthStencilFormat(e),a=i.getCurrentColorFormats(e),c=this._getSampleCount(e),l={label:t,colorFormats:a,depthStencilFormat:o,sampleCount:c};return s.createRenderBundleEncoder(l)}createComputePipeline(e,t){const r=this.backend,i=r.device,s=r.get(e.computeProgram).module,o=r.get(e),a=[];for(const c of t){const l=r.get(c);a.push(l.layout)}o.pipeline=i.createComputePipeline({compute:s,layout:i.createPipelineLayout({bindGroupLayouts:a})})}_getBlending(e){let t,r;const i=e.blending,s=e.blendSrc,o=e.blendDst,a=e.blendEquation;if(i===Ro){const c=e.blendSrcAlpha!==null?e.blendSrcAlpha:s,l=e.blendDstAlpha!==null?e.blendDstAlpha:o,u=e.blendEquationAlpha!==null?e.blendEquationAlpha:a;t={srcFactor:this._getBlendFactor(s),dstFactor:this._getBlendFactor(o),operation:this._getBlendOperation(a)},r={srcFactor:this._getBlendFactor(c),dstFactor:this._getBlendFactor(l),operation:this._getBlendOperation(u)}}else{const c=e.premultipliedAlpha,l=(u,d,h,f)=>{t={srcFactor:u,dstFactor:d,operation:ii.Add},r={srcFactor:h,dstFactor:f,operation:ii.Add}};if(c)switch(i){case wi:l(Ne.One,Ne.OneMinusSrcAlpha,Ne.One,Ne.OneMinusSrcAlpha);break;case Fc:l(Ne.One,Ne.One,Ne.One,Ne.One);break;case Bc:l(Ne.Zero,Ne.OneMinusSrc,Ne.Zero,Ne.One);break;case Dc:l(Ne.Dst,Ne.OneMinusSrcAlpha,Ne.Zero,Ne.One);break}else switch(i){case wi:l(Ne.SrcAlpha,Ne.OneMinusSrcAlpha,Ne.One,Ne.OneMinusSrcAlpha);break;case Fc:l(Ne.SrcAlpha,Ne.One,Ne.One,Ne.One);break;case Bc:ie("WebGPURenderer: SubtractiveBlending requires material.premultipliedAlpha = true");break;case Dc:ie("WebGPURenderer: MultiplyBlending requires material.premultipliedAlpha = true");break}}if(t!==void 0&&r!==void 0)return{color:t,alpha:r};ie("WebGPURenderer: Invalid blending: ",i)}_getBlendFactor(e){let t;switch(e){case Rr:t=Ne.Zero;break;case my:t=Ne.One;break;case gy:t=Ne.Src;break;case uy:t=Ne.OneMinusSrc;break;case py:t=Ne.SrcAlpha;break;case ly:t=Ne.OneMinusSrcAlpha;break;case hy:t=Ne.Dst;break;case cy:t=Ne.OneMinusDst;break;case dy:t=Ne.DstAlpha;break;case ay:t=Ne.OneMinusDstAlpha;break;case fy:t=Ne.SrcAlphaSaturated;break;case e5:t=Ne.Constant;break;case t5:t=Ne.OneMinusConstant;break;default:ie("WebGPURenderer: Blend factor not supported.",e)}return t}_getStencilCompare(e){let t;const r=e.stencilFunc;switch(r){case aS:t=bt.Never;break;case oS:t=bt.Always;break;case sS:t=bt.Less;break;case iS:t=bt.LessEqual;break;case rS:t=bt.Equal;break;case nS:t=bt.GreaterEqual;break;case tS:t=bt.Greater;break;case eS:t=bt.NotEqual;break;default:ie("WebGPURenderer: Invalid stencil function.",r)}return t}_getStencilOperation(e){let t;switch(e){case gS:t=Er.Keep;break;case pS:t=Er.Zero;break;case fS:t=Er.Replace;break;case hS:t=Er.Invert;break;case dS:t=Er.IncrementClamp;break;case uS:t=Er.DecrementClamp;break;case lS:t=Er.IncrementWrap;break;case cS:t=Er.DecrementWrap;break;default:ie("WebGPURenderer: Invalid stencil operation.",t)}return t}_getBlendOperation(e){let t;switch(e){case ar:t=ii.Add;break;case oy:t=ii.Subtract;break;case sy:t=ii.ReverseSubtract;break;case xS:t=ii.Min;break;case mS:t=ii.Max;break;default:ie("WebGPUPipelineUtils: Blend equation not supported.",e)}return t}_getPrimitiveState(e,t,r){const i={},s=this.backend.utils;i.topology=s.getPrimitiveTopology(e,r),t.index!==null&&e.isLine===!0&&e.isLineSegments!==!0&&(i.stripIndexFormat=t.index.array instanceof Uint16Array?Bs.Uint16:Bs.Uint32);let o=r.side===jt;return e.isMesh&&e.matrixWorld.determinant()<0&&(o=!o),i.frontFace=o===!0?ex.CW:ex.CCW,i.cullMode=r.side===vi?tx.None:tx.Back,i}_getColorWriteMask(e){return e.colorWrite===!0?nx.All:nx.None}_getDepthCompare(e){let t;if(e.depthTest===!1)t=bt.Always;else{const r=e.depthFunc;switch(r){case Sy:t=bt.Never;break;case wy:t=bt.Always;break;case Ty:t=bt.Less;break;case vy:t=bt.LessEqual;break;case _y:t=bt.Equal;break;case by:t=bt.GreaterEqual;break;case yy:t=bt.Greater;break;case xy:t=bt.NotEqual;break;default:ie("WebGPUPipelineUtils: Invalid depth function.",r)}}return t}}class x$ extends qT{constructor(e,t,r=2048){super(r),this.device=e,this.type=t,this.querySet=this.device.createQuerySet({type:"timestamp",count:this.maxQueries,label:`queryset_global_timestamp_${t}`});const i=this.maxQueries*8;this.resolveBuffer=this.device.createBuffer({label:`buffer_timestamp_resolve_${t}`,size:i,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.resultBuffer=this.device.createBuffer({label:`buffer_timestamp_result_${t}`,size:i,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})}allocateQueriesForContext(e){if(!this.trackTimestamp||this.isDisposed)return null;if(this.currentQueryIndex+2>this.maxQueries)return lt(`WebGPUTimestampQueryPool [${this.type}]: Maximum number of queries exceeded, when using trackTimestamp it is necessary to resolves the queries via renderer.resolveTimestampsAsync( THREE.TimestampQuery.${this.type.toUpperCase()} ).`),null;const t=this.currentQueryIndex;return this.currentQueryIndex+=2,this.queryOffsets.set(e,t),t}async resolveQueriesAsync(){if(!this.trackTimestamp||this.currentQueryIndex===0||this.isDisposed)return this.lastValue;if(this.pendingResolve)return this.pendingResolve;this.pendingResolve=this._resolveQueries();try{return await this.pendingResolve}finally{this.pendingResolve=null}}async _resolveQueries(){if(this.isDisposed)return this.lastValue;try{if(this.resultBuffer.mapState!=="unmapped")return this.lastValue;const e=new Map(this.queryOffsets),t=this.currentQueryIndex,r=t*8;this.currentQueryIndex=0,this.queryOffsets.clear();const i=this.device.createCommandEncoder();i.resolveQuerySet(this.querySet,0,t,this.resolveBuffer,0),i.copyBufferToBuffer(this.resolveBuffer,0,this.resultBuffer,0,r);const s=i.finish();if(this.device.queue.submit([s]),this.resultBuffer.mapState!=="unmapped")return this.lastValue;if(await this.resultBuffer.mapAsync(GPUMapMode.READ,0,r),this.isDisposed)return this.resultBuffer.mapState==="mapped"&&this.resultBuffer.unmap(),this.lastValue;const o=new BigUint64Array(this.resultBuffer.getMappedRange(0,r)),a={},c=[];for(const[u,d]of e){const h=u.match(/^(.*):f(\d+)$/),f=parseInt(h[2]);c.includes(f)===!1&&c.push(f),a[f]===void 0&&(a[f]=0);const p=o[d],g=o[d+1],x=Number(g-p)/1e6;this.timestamps.set(u,x),a[f]+=x}const l=a[c[c.length-1]];return this.resultBuffer.unmap(),this.lastValue=l,this.frames=c,l}catch(e){return e("Error resolving queries:",e),this.resultBuffer.mapState==="mapped"&&this.resultBuffer.unmap(),this.lastValue}}async dispose(){if(!this.isDisposed){if(this.isDisposed=!0,this.pendingResolve)try{await this.pendingResolve}catch(e){e("Error waiting for pending resolve:",e)}if(this.resultBuffer&&this.resultBuffer.mapState==="mapped")try{this.resultBuffer.unmap()}catch(e){e("Error unmapping buffer:",e)}this.querySet&&(this.querySet.destroy(),this.querySet=null),this.resolveBuffer&&(this.resolveBuffer.destroy(),this.resolveBuffer=null),this.resultBuffer&&(this.resultBuffer.destroy(),this.resultBuffer=null),this.queryOffsets.clear(),this.pendingResolve=null}}}class y$ extends WT{constructor(e={}){super(e),this.isWebGPUBackend=!0,this.parameters.alpha=e.alpha===void 0?!0:e.alpha,this.parameters.compatibilityMode=e.compatibilityMode===void 0?!1:e.compatibilityMode,this.parameters.requiredLimits=e.requiredLimits===void 0?{}:e.requiredLimits,this.compatibilityMode=this.parameters.compatibilityMode,this.device=null,this.defaultRenderPassdescriptor=null,this.utils=new d$(this),this.attributeUtils=new p$(this),this.bindingUtils=new g$(this),this.pipelineUtils=new m$(this),this.textureUtils=new e$(this),this.occludedResolveCache=new Map}async init(e){await super.init(e);const t=this.parameters;let r;if(t.device===void 0){const i={powerPreference:t.powerPreference,featureLevel:t.compatibilityMode?"compatibility":void 0},s=typeof navigator<"u"?await navigator.gpu.requestAdapter(i):null;if(s===null)throw new Error("WebGPUBackend: Unable to create WebGPU adapter.");const o=Object.values(Uh),a=[];for(const l of o)s.features.has(l)&&a.push(l);const c={requiredFeatures:a,requiredLimits:t.requiredLimits};r=await s.requestDevice(c)}else r=t.device;r.lost.then(i=>{const s={api:"WebGPU",message:i.message||"Unknown reason",reason:i.reason||null,originalEvent:i};e.onDeviceLost(s)}),this.device=r,this.trackTimestamp=this.trackTimestamp&&this.hasFeature(Uh.TimestampQuery),this.updateSize()}get context(){const e=this.renderer.getCanvasTarget(),t=this.get(e);let r=t.context;if(r===void 0){const i=this.parameters;e.isDefaultCanvasTarget===!0&&i.context!==void 0?r=i.context:r=e.domElement.getContext("webgpu"),"setAttribute"in e.domElement&&e.domElement.setAttribute("data-engine",`three.js r${bl} webgpu`);const s=i.alpha?"premultiplied":"opaque",o=i.outputType===Ft?"extended":"standard";r.configure({device:this.device,format:this.utils.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC,alphaMode:s,toneMapping:{mode:o}}),t.context=r}return r}get coordinateSystem(){return _l}async getArrayBufferAsync(e){return await this.attributeUtils.getArrayBufferAsync(e)}getContext(){return this.context}_getDefaultRenderPassDescriptor(){const e=this.renderer,t=e.getCanvasTarget(),r=this.get(t),i=e.currentSamples;let s=r.descriptor;if(s===void 0||r.samples!==i){s={colorAttachments:[{view:null}]},(e.depth===!0||e.stencil===!0)&&(s.depthStencilAttachment={view:this.textureUtils.getDepthBuffer(e.depth,e.stencil).createView()});const a=s.colorAttachments[0];i>0?a.view=this.textureUtils.getColorBuffer().createView():a.resolveTarget=void 0,r.descriptor=s,r.samples=i}const o=s.colorAttachments[0];return i>0?o.resolveTarget=this.context.getCurrentTexture().createView():o.view=this.context.getCurrentTexture().createView(),s}_isRenderCameraDepthArray(e){return e.depthTexture&&e.depthTexture.image.depth>1&&e.camera.isArrayCamera}_getRenderPassDescriptor(e,t={}){const r=e.renderTarget,i=this.get(r);let s=i.descriptors;(s===void 0||i.width!==r.width||i.height!==r.height||i.samples!==r.samples)&&(s={},i.descriptors=s);const o=e.getCacheKey();let a=s[o];if(a===void 0){const l=e.textures,u=[];let d;const h=this._isRenderCameraDepthArray(e);for(let f=0;f<l.length;f++){const p=this.get(l[f]),g={label:`colorAttachment_${f}`,baseMipLevel:e.activeMipmapLevel,mipLevelCount:1,baseArrayLayer:e.activeCubeFace,arrayLayerCount:1,dimension:ct.TwoD};if(r.isRenderTarget3D)d=e.activeCubeFace,g.baseArrayLayer=0,g.dimension=ct.ThreeD,g.depthOrArrayLayers=l[f].image.depth;else if(r.isRenderTarget&&l[f].image.depth>1)if(h===!0){const x=e.camera.cameras;for(let m=0;m<x.length;m++){const y={...g,baseArrayLayer:m,arrayLayerCount:1,dimension:ct.TwoD},_=p.texture.createView(y);u.push({view:_,resolveTarget:void 0,depthSlice:void 0})}}else g.dimension=ct.TwoDArray,g.depthOrArrayLayers=l[f].image.depth;if(h!==!0){const x=p.texture.createView(g);let m,y;p.msaaTexture!==void 0?(m=p.msaaTexture.createView(),y=x):(m=x,y=void 0),u.push({view:m,resolveTarget:y,depthSlice:d})}}if(a={textureViews:u},e.depth){const f=this.get(e.depthTexture),p={};e.depthTexture.isArrayTexture&&(p.dimension=ct.TwoD,p.arrayLayerCount=1,p.baseArrayLayer=e.activeCubeFace),a.depthStencilView=f.texture.createView(p)}s[o]=a,i.width=r.width,i.height=r.height,i.samples=r.samples,i.activeMipmapLevel=e.activeMipmapLevel,i.activeCubeFace=e.activeCubeFace}const c={colorAttachments:[]};for(let l=0;l<a.textureViews.length;l++){const u=a.textureViews[l];let d={r:0,g:0,b:0,a:1};l===0&&t.clearValue&&(d=t.clearValue),c.colorAttachments.push({view:u.view,depthSlice:u.depthSlice,resolveTarget:u.resolveTarget,loadOp:t.loadOp||De.Load,storeOp:t.storeOp||Mt.Store,clearValue:d})}return a.depthStencilView&&(c.depthStencilAttachment={view:a.depthStencilView}),c}beginRender(e){const t=this.get(e),r=this.device,i=e.occlusionQueryCount;let s;i>0&&(t.currentOcclusionQuerySet&&t.currentOcclusionQuerySet.destroy(),t.currentOcclusionQueryBuffer&&t.currentOcclusionQueryBuffer.destroy(),t.currentOcclusionQuerySet=t.occlusionQuerySet,t.currentOcclusionQueryBuffer=t.occlusionQueryBuffer,t.currentOcclusionQueryObjects=t.occlusionQueryObjects,s=r.createQuerySet({type:"occlusion",count:i,label:`occlusionQuerySet_${e.id}`}),t.occlusionQuerySet=s,t.occlusionQueryIndex=0,t.occlusionQueryObjects=new Array(i),t.lastOcclusionObject=null);let o;e.textures===null?o=this._getDefaultRenderPassDescriptor():o=this._getRenderPassDescriptor(e,{loadOp:De.Load}),this.initTimestampQuery(Ln.RENDER,this.getTimestampUID(e),o),o.occlusionQuerySet=s;const a=o.depthStencilAttachment;if(e.textures!==null){const l=o.colorAttachments;for(let u=0;u<l.length;u++){const d=l[u];e.clearColor?(d.clearValue=u===0?e.clearColorValue:{r:0,g:0,b:0,a:1},d.loadOp=De.Clear):d.loadOp=De.Load,d.storeOp=Mt.Store}}else{const l=o.colorAttachments[0];e.clearColor?(l.clearValue=e.clearColorValue,l.loadOp=De.Clear):l.loadOp=De.Load,l.storeOp=Mt.Store}e.depth&&(e.clearDepth?(a.depthClearValue=e.clearDepthValue,a.depthLoadOp=De.Clear):a.depthLoadOp=De.Load,a.depthStoreOp=Mt.Store),e.stencil&&(e.clearStencil?(a.stencilClearValue=e.clearStencilValue,a.stencilLoadOp=De.Clear):a.stencilLoadOp=De.Load,a.stencilStoreOp=Mt.Store);const c=r.createCommandEncoder({label:"renderContext_"+e.id});if(this._isRenderCameraDepthArray(e)===!0){const l=e.camera.cameras;!t.layerDescriptors||t.layerDescriptors.length!==l.length?this._createDepthLayerDescriptors(e,t,o,l):this._updateDepthLayerDescriptors(e,t,l),t.bundleEncoders=[],t.bundleSets=[];for(let u=0;u<l.length;u++){const d=this.pipelineUtils.createBundleEncoder(e,"renderBundleArrayCamera_"+u),h={attributes:{},bindingGroups:[],pipeline:null,index:null};t.bundleEncoders.push(d),t.bundleSets.push(h)}t.currentPass=null}else{const l=c.beginRenderPass(o);t.currentPass=l,e.viewport&&this.updateViewport(e),e.scissor&&this.updateScissor(e)}t.descriptor=o,t.encoder=c,t.currentSets={attributes:{},bindingGroups:[],pipeline:null,index:null},t.renderBundles=[]}_createDepthLayerDescriptors(e,t,r,i){const s=r.depthStencilAttachment;t.layerDescriptors=[];const o=this.get(e.depthTexture);o.viewCache||(o.viewCache=[]);for(let a=0;a<i.length;a++){const c={...r,colorAttachments:[{...r.colorAttachments[0],view:r.colorAttachments[a].view}]};if(r.depthStencilAttachment){const l=a;o.viewCache[l]||(o.viewCache[l]=o.texture.createView({dimension:ct.TwoD,baseArrayLayer:a,arrayLayerCount:1})),c.depthStencilAttachment={view:o.viewCache[l],depthLoadOp:s.depthLoadOp||De.Clear,depthStoreOp:s.depthStoreOp||Mt.Store,depthClearValue:s.depthClearValue||1},e.stencil&&(c.depthStencilAttachment.stencilLoadOp=s.stencilLoadOp,c.depthStencilAttachment.stencilStoreOp=s.stencilStoreOp,c.depthStencilAttachment.stencilClearValue=s.stencilClearValue)}else c.depthStencilAttachment={...s};t.layerDescriptors.push(c)}}_updateDepthLayerDescriptors(e,t,r){for(let i=0;i<r.length;i++){const s=t.layerDescriptors[i];if(s.depthStencilAttachment){const o=s.depthStencilAttachment;e.depth&&(e.clearDepth?(o.depthClearValue=e.clearDepthValue,o.depthLoadOp=De.Clear):o.depthLoadOp=De.Load),e.stencil&&(e.clearStencil?(o.stencilClearValue=e.clearStencilValue,o.stencilLoadOp=De.Clear):o.stencilLoadOp=De.Load)}}}finishRender(e){const t=this.get(e),r=e.occlusionQueryCount;t.renderBundles.length>0&&t.currentPass.executeBundles(t.renderBundles),r>t.occlusionQueryIndex&&t.currentPass.endOcclusionQuery();const i=t.encoder;if(this._isRenderCameraDepthArray(e)===!0){const s=[];for(let o=0;o<t.bundleEncoders.length;o++){const a=t.bundleEncoders[o];s.push(a.finish())}for(let o=0;o<t.layerDescriptors.length;o++)if(o<s.length){const a=t.layerDescriptors[o],c=i.beginRenderPass(a);if(e.viewport){const{x:l,y:u,width:d,height:h,minDepth:f,maxDepth:p}=e.viewportValue;c.setViewport(l,u,d,h,f,p)}if(e.scissor){const{x:l,y:u,width:d,height:h}=e.scissorValue;c.setScissorRect(l,u,d,h)}c.executeBundles([s[o]]),c.end()}}else t.currentPass&&t.currentPass.end();if(r>0){const s=r*8;let o=this.occludedResolveCache.get(s);o===void 0&&(o=this.device.createBuffer({size:s,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.occludedResolveCache.set(s,o));const a=this.device.createBuffer({size:s,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ});t.encoder.resolveQuerySet(t.occlusionQuerySet,0,r,o,0),t.encoder.copyBufferToBuffer(o,0,a,0,s),t.occlusionQueryBuffer=a,this.resolveOccludedAsync(e)}if(this.device.queue.submit([t.encoder.finish()]),e.textures!==null){const s=e.textures;for(let o=0;o<s.length;o++){const a=s[o];a.generateMipmaps===!0&&this.textureUtils.generateMipmaps(a)}}}isOccluded(e,t){const r=this.get(e);return r.occluded&&r.occluded.has(t)}async resolveOccludedAsync(e){const t=this.get(e),{currentOcclusionQueryBuffer:r,currentOcclusionQueryObjects:i}=t;if(r&&i){const s=new WeakSet;t.currentOcclusionQueryObjects=null,t.currentOcclusionQueryBuffer=null,await r.mapAsync(GPUMapMode.READ);const o=r.getMappedRange(),a=new BigUint64Array(o);for(let c=0;c<i.length;c++)a[c]===BigInt(0)&&s.add(i[c]);r.destroy(),t.occluded=s}}updateViewport(e){const{currentPass:t}=this.get(e),{x:r,y:i,width:s,height:o,minDepth:a,maxDepth:c}=e.viewportValue;t.setViewport(r,i,s,o,a,c)}updateScissor(e){const{currentPass:t}=this.get(e),{x:r,y:i,width:s,height:o}=e.scissorValue;t.setScissorRect(r,i,s,o)}getClearColor(){const e=super.getClearColor();return this.renderer.alpha===!0&&(e.r*=e.a,e.g*=e.a,e.b*=e.a),e}clear(e,t,r,i=null){const s=this.device,o=this.renderer;let a=[],c,l,u,d;if(e){const p=this.getClearColor();l={r:p.r,g:p.g,b:p.b,a:p.a}}if(i===null){u=o.depth,d=o.stencil;const p=this._getDefaultRenderPassDescriptor();if(e){a=p.colorAttachments;const g=a[0];g.clearValue=l,g.loadOp=De.Clear,g.storeOp=Mt.Store}(u||d)&&(c=p.depthStencilAttachment)}else{u=i.depth,d=i.stencil;const p={loadOp:e?De.Clear:De.Load,clearValue:e?l:void 0};u&&(p.depthLoadOp=t?De.Clear:De.Load,p.depthClearValue=t?o.getClearDepth():void 0,p.depthStoreOp=Mt.Store),d&&(p.stencilLoadOp=r?De.Clear:De.Load,p.stencilClearValue=r?o.getClearStencil():void 0,p.stencilStoreOp=Mt.Store);const g=this._getRenderPassDescriptor(i,p);a=g.colorAttachments,c=g.depthStencilAttachment}u&&c&&(t?(c.depthLoadOp=De.Clear,c.depthClearValue=o.getClearDepth(),c.depthStoreOp=Mt.Store):(c.depthLoadOp=De.Load,c.depthStoreOp=Mt.Store)),d&&c&&(r?(c.stencilLoadOp=De.Clear,c.stencilClearValue=o.getClearStencil(),c.stencilStoreOp=Mt.Store):(c.stencilLoadOp=De.Load,c.stencilStoreOp=Mt.Store));const h=s.createCommandEncoder({label:"clear"});h.beginRenderPass({colorAttachments:a,depthStencilAttachment:c}).end(),s.queue.submit([h.finish()])}beginCompute(e){const t=this.get(e),r={label:"computeGroup_"+e.id};this.initTimestampQuery(Ln.COMPUTE,this.getTimestampUID(e),r),t.cmdEncoderGPU=this.device.createCommandEncoder({label:"computeGroup_"+e.id}),t.passEncoderGPU=t.cmdEncoderGPU.beginComputePass(r)}compute(e,t,r,i,s=null){const o=this.get(t),{passEncoderGPU:a}=this.get(e),c=this.get(i).pipeline;this.pipelineUtils.setPipeline(a,c);for(let l=0,u=r.length;l<u;l++){const d=r[l],h=this.get(d);a.setBindGroup(l,h.group)}if(s===null&&(s=t.count),s&&typeof s=="object"&&s.isIndirectStorageBufferAttribute){const l=this.get(s).buffer;a.dispatchWorkgroupsIndirect(l,0);return}if(typeof s=="number"){const l=s;if(o.dispatchSize===void 0||o.count!==l){o.dispatchSize=[0,1,1],o.count=l;const u=t.workgroupSize;let d=u[0];for(let p=1;p<u.length;p++)d*=u[p];const h=Math.ceil(l/d),f=this.device.limits.maxComputeWorkgroupsPerDimension;s=[h,1,1],h>f&&(s[0]=Math.min(h,f),s[1]=Math.ceil(h/f)),o.dispatchSize=s}s=o.dispatchSize}a.dispatchWorkgroups(s[0],s[1]||1,s[2]||1)}finishCompute(e){const t=this.get(e);t.passEncoderGPU.end(),this.device.queue.submit([t.cmdEncoderGPU.finish()])}draw(e,t){const{object:r,material:i,context:s,pipeline:o}=e,a=e.getBindings(),c=this.get(s),l=this.get(o),u=l.pipeline;if(l.error===!0)return;const d=e.getIndex(),h=d!==null,f=e.getDrawParameters();if(f===null)return;const p=(x,m)=>{this.pipelineUtils.setPipeline(x,u),m.pipeline=u;const y=m.bindingGroups;for(let v=0,T=a.length;v<T;v++){const w=a[v],N=this.get(w);y[w.index]!==w.id&&(x.setBindGroup(w.index,N.group),y[w.index]=w.id)}if(h===!0&&m.index!==d){const v=this.get(d).buffer,T=d.array instanceof Uint16Array?Bs.Uint16:Bs.Uint32;x.setIndexBuffer(v,T),m.index=d}const _=e.getVertexBuffers();for(let v=0,T=_.length;v<T;v++){const w=_[v];if(m.attributes[v]!==w){const N=this.get(w).buffer;x.setVertexBuffer(v,N),m.attributes[v]=w}}s.stencil===!0&&i.stencilWrite===!0&&c.currentStencilRef!==i.stencilRef&&(x.setStencilReference(i.stencilRef),c.currentStencilRef=i.stencilRef)},g=(x,m)=>{if(p(x,m),r.isBatchedMesh===!0){const y=r._multiDrawStarts,_=r._multiDrawCounts,v=r._multiDrawCount,T=r._multiDrawInstances;T!==null&&lt("WebGPUBackend: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection.");for(let w=0;w<v;w++){const N=T?T[w]:1,E=N>1?0:w;h===!0?x.drawIndexed(_[w],N,y[w]/d.array.BYTES_PER_ELEMENT,0,E):x.draw(_[w],N,y[w],E),t.update(r,_[w],N)}}else if(h===!0){const{vertexCount:y,instanceCount:_,firstVertex:v}=f,T=e.getIndirect();if(T!==null){const w=this.get(T).buffer;x.drawIndexedIndirect(w,0)}else x.drawIndexed(y,_,v,0,0);t.update(r,y,_)}else{const{vertexCount:y,instanceCount:_,firstVertex:v}=f,T=e.getIndirect();if(T!==null){const w=this.get(T).buffer;x.drawIndirect(w,0)}else x.draw(y,_,v,0);t.update(r,y,_)}};if(e.camera.isArrayCamera&&e.camera.cameras.length>0){const x=this.get(e.camera),m=e.camera.cameras,y=e.getBindingGroup("cameraIndex");if(x.indexesGPU===void 0||x.indexesGPU.length!==m.length){const v=this.get(y),T=[],w=new Uint32Array([0,0,0,0]);for(let N=0,E=m.length;N<E;N++){w[0]=N;const A=this.bindingUtils.createBindGroupIndex(w,v.layout);T.push(A)}x.indexesGPU=T}const _=this.renderer.getPixelRatio();for(let v=0,T=m.length;v<T;v++){const w=m[v];if(r.layers.test(w.layers)){const N=w.viewport;let E=c.currentPass,A=c.currentSets;if(c.bundleEncoders){const B=c.bundleEncoders[v],R=c.bundleSets[v];E=B,A=R}N&&E.setViewport(Math.floor(N.x*_),Math.floor(N.y*_),Math.floor(N.width*_),Math.floor(N.height*_),s.viewportValue.minDepth,s.viewportValue.maxDepth),y&&x.indexesGPU&&(E.setBindGroup(y.index,x.indexesGPU[v]),A.bindingGroups[y.index]=y.id),g(E,A)}}}else if(c.currentPass){if(c.occlusionQuerySet!==void 0){const x=c.lastOcclusionObject;x!==r&&(x!==null&&x.occlusionTest===!0&&(c.currentPass.endOcclusionQuery(),c.occlusionQueryIndex++),r.occlusionTest===!0&&(c.currentPass.beginOcclusionQuery(c.occlusionQueryIndex),c.occlusionQueryObjects[c.occlusionQueryIndex]=r),c.lastOcclusionObject=r)}g(c.currentPass,c.currentSets)}}needsRenderUpdate(e){const t=this.get(e),{object:r,material:i}=e,s=this.utils,o=s.getSampleCountRenderContext(e.context),a=s.getCurrentColorSpace(e.context),c=s.getCurrentColorFormat(e.context),l=s.getCurrentDepthStencilFormat(e.context),u=s.getPrimitiveTopology(r,i);let d=!1;return(t.material!==i||t.materialVersion!==i.version||t.transparent!==i.transparent||t.blending!==i.blending||t.premultipliedAlpha!==i.premultipliedAlpha||t.blendSrc!==i.blendSrc||t.blendDst!==i.blendDst||t.blendEquation!==i.blendEquation||t.blendSrcAlpha!==i.blendSrcAlpha||t.blendDstAlpha!==i.blendDstAlpha||t.blendEquationAlpha!==i.blendEquationAlpha||t.colorWrite!==i.colorWrite||t.depthWrite!==i.depthWrite||t.depthTest!==i.depthTest||t.depthFunc!==i.depthFunc||t.stencilWrite!==i.stencilWrite||t.stencilFunc!==i.stencilFunc||t.stencilFail!==i.stencilFail||t.stencilZFail!==i.stencilZFail||t.stencilZPass!==i.stencilZPass||t.stencilFuncMask!==i.stencilFuncMask||t.stencilWriteMask!==i.stencilWriteMask||t.side!==i.side||t.alphaToCoverage!==i.alphaToCoverage||t.sampleCount!==o||t.colorSpace!==a||t.colorFormat!==c||t.depthStencilFormat!==l||t.primitiveTopology!==u||t.clippingContextCacheKey!==e.clippingContextCacheKey)&&(t.material=i,t.materialVersion=i.version,t.transparent=i.transparent,t.blending=i.blending,t.premultipliedAlpha=i.premultipliedAlpha,t.blendSrc=i.blendSrc,t.blendDst=i.blendDst,t.blendEquation=i.blendEquation,t.blendSrcAlpha=i.blendSrcAlpha,t.blendDstAlpha=i.blendDstAlpha,t.blendEquationAlpha=i.blendEquationAlpha,t.colorWrite=i.colorWrite,t.depthWrite=i.depthWrite,t.depthTest=i.depthTest,t.depthFunc=i.depthFunc,t.stencilWrite=i.stencilWrite,t.stencilFunc=i.stencilFunc,t.stencilFail=i.stencilFail,t.stencilZFail=i.stencilZFail,t.stencilZPass=i.stencilZPass,t.stencilFuncMask=i.stencilFuncMask,t.stencilWriteMask=i.stencilWriteMask,t.side=i.side,t.alphaToCoverage=i.alphaToCoverage,t.sampleCount=o,t.colorSpace=a,t.colorFormat=c,t.depthStencilFormat=l,t.primitiveTopology=u,t.clippingContextCacheKey=e.clippingContextCacheKey,d=!0),d}getRenderCacheKey(e){const{object:t,material:r}=e,i=this.utils,s=e.context,o=t.isMesh&&t.matrixWorld.determinant()<0;return[r.transparent,r.blending,r.premultipliedAlpha,r.blendSrc,r.blendDst,r.blendEquation,r.blendSrcAlpha,r.blendDstAlpha,r.blendEquationAlpha,r.colorWrite,r.depthWrite,r.depthTest,r.depthFunc,r.stencilWrite,r.stencilFunc,r.stencilFail,r.stencilZFail,r.stencilZPass,r.stencilFuncMask,r.stencilWriteMask,r.side,o,i.getSampleCountRenderContext(s),i.getCurrentColorSpace(s),i.getCurrentColorFormat(s),i.getCurrentDepthStencilFormat(s),i.getPrimitiveTopology(t,r),e.getGeometryCacheKey(),e.clippingContextCacheKey].join()}updateSampler(e){return this.textureUtils.updateSampler(e)}createDefaultTexture(e){return this.textureUtils.createDefaultTexture(e)}createTexture(e,t){this.textureUtils.createTexture(e,t)}updateTexture(e,t){this.textureUtils.updateTexture(e,t)}generateMipmaps(e){this.textureUtils.generateMipmaps(e)}destroyTexture(e,t=!1){this.textureUtils.destroyTexture(e,t)}async copyTextureToBuffer(e,t,r,i,s,o){return this.textureUtils.copyTextureToBuffer(e,t,r,i,s,o)}initTimestampQuery(e,t,r){if(!this.trackTimestamp)return;this.timestampQueryPool[e]||(this.timestampQueryPool[e]=new x$(this.device,e,2048));const i=this.timestampQueryPool[e],s=i.allocateQueriesForContext(t);r.timestampWrites={querySet:i.querySet,beginningOfPassWriteIndex:s,endOfPassWriteIndex:s+1}}createNodeBuilder(e,t){return new u$(e,t)}createProgram(e){const t=this.get(e);t.module={module:this.device.createShaderModule({code:e.code,label:e.stage+(e.name!==""?`_${e.name}`:"")}),entryPoint:"main"}}destroyProgram(e){this.delete(e)}createRenderPipeline(e,t){this.pipelineUtils.createRenderPipeline(e,t)}createComputePipeline(e,t){this.pipelineUtils.createComputePipeline(e,t)}beginBundle(e){const t=this.get(e);t._currentPass=t.currentPass,t._currentSets=t.currentSets,t.currentSets={attributes:{},bindingGroups:[],pipeline:null,index:null},t.currentPass=this.pipelineUtils.createBundleEncoder(e)}finishBundle(e,t){const r=this.get(e),s=r.currentPass.finish();this.get(t).bundleGPU=s,r.currentSets=r._currentSets,r.currentPass=r._currentPass}addBundle(e,t){this.get(e).renderBundles.push(this.get(t).bundleGPU)}createBindings(e,t,r,i){this.bindingUtils.createBindings(e,t,r,i)}updateBindings(e,t,r,i){this.bindingUtils.createBindings(e,t,r,i)}updateBinding(e){this.bindingUtils.updateBinding(e)}createIndexAttribute(e){let t=GPUBufferUsage.INDEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST;(e.isStorageBufferAttribute||e.isStorageInstancedBufferAttribute)&&(t|=GPUBufferUsage.STORAGE),this.attributeUtils.createAttribute(e,t)}createAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}createStorageAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.STORAGE|GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}createIndirectStorageAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.STORAGE|GPUBufferUsage.INDIRECT|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}updateAttribute(e){this.attributeUtils.updateAttribute(e)}destroyAttribute(e){this.attributeUtils.destroyAttribute(e)}updateSize(){this.delete(this.renderer.getCanvasTarget())}getMaxAnisotropy(){return 16}hasFeature(e){return sx[e]!==void 0&&(e=sx[e]),this.device.features.has(e)}copyTextureToTexture(e,t,r=null,i=null,s=0,o=0){let a=0,c=0,l=0,u=0,d=0,h=0,f=e.image.width,p=e.image.height,g=1;r!==null&&(r.isBox3===!0?(u=r.min.x,d=r.min.y,h=r.min.z,f=r.max.x-r.min.x,p=r.max.y-r.min.y,g=r.max.z-r.min.z):(u=r.min.x,d=r.min.y,f=r.max.x-r.min.x,p=r.max.y-r.min.y,g=1)),i!==null&&(a=i.x,c=i.y,l=i.z||0);const x=this.device.createCommandEncoder({label:"copyTextureToTexture_"+e.id+"_"+t.id}),m=this.get(e).texture,y=this.get(t).texture;x.copyTextureToTexture({texture:m,mipLevel:s,origin:{x:u,y:d,z:h}},{texture:y,mipLevel:o,origin:{x:a,y:c,z:l}},[f,p,g]),this.device.queue.submit([x.finish()]),o===0&&t.generateMipmaps&&this.textureUtils.generateMipmaps(t)}copyFramebufferToTexture(e,t,r){const i=this.get(t);let s=null;t.renderTarget?e.isDepthTexture?s=this.get(t.depthTexture).texture:s=this.get(t.textures[0]).texture:e.isDepthTexture?s=this.textureUtils.getDepthBuffer(t.depth,t.stencil):s=this.context.getCurrentTexture();const o=this.get(e).texture;if(s.format!==o.format){ie("WebGPUBackend: copyFramebufferToTexture: Source and destination formats do not match.",s.format,o.format);return}let a;if(i.currentPass?(i.currentPass.end(),a=i.encoder):a=this.device.createCommandEncoder({label:"copyFramebufferToTexture_"+e.id}),a.copyTextureToTexture({texture:s,origin:[r.x,r.y,0]},{texture:o},[r.z,r.w]),e.generateMipmaps&&this.textureUtils.generateMipmaps(e,a),i.currentPass){const{descriptor:c}=i;for(let l=0;l<c.colorAttachments.length;l++)c.colorAttachments[l].loadOp=De.Load;t.depth&&(c.depthStencilAttachment.depthLoadOp=De.Load),t.stencil&&(c.depthStencilAttachment.stencilLoadOp=De.Load),i.currentPass=a.beginRenderPass(c),i.currentSets={attributes:{},bindingGroups:[],pipeline:null,index:null},t.viewport&&this.updateViewport(t),t.scissor&&this.updateScissor(t)}else this.device.queue.submit([a.finish()])}dispose(){this.textureUtils.dispose()}}class b$ extends nf{constructor(e,t,r,i,s,o){super(e,t,r,i,s,o),this.iesMap=null}copy(e,t){return super.copy(e,t),this.iesMap=e.iesMap,this}}class _$ extends nf{constructor(e,t,r,i,s,o){super(e,t,r,i,s,o),this.aspect=null}copy(e,t){return super.copy(e,t),this.aspect=e.aspect,this}}class v$ extends OT{constructor(){super(),this.addMaterial(PO,"MeshPhongMaterial"),this.addMaterial(vT,"MeshStandardMaterial"),this.addMaterial(DU,"MeshPhysicalMaterial"),this.addMaterial(IU,"MeshToonMaterial"),this.addMaterial(SO,"MeshBasicMaterial"),this.addMaterial(CO,"MeshLambertMaterial"),this.addMaterial(bO,"MeshNormalMaterial"),this.addMaterial(UU,"MeshMatcapMaterial"),this.addMaterial(pO,"LineBasicMaterial"),this.addMaterial(mO,"LineDashedMaterial"),this.addMaterial(jU,"PointsMaterial"),this.addMaterial(wT,"SpriteMaterial"),this.addMaterial(XU,"ShadowMaterial"),this.addLight(w4,yw),this.addLight(Q4,Xx),this.addLight(Z4,bw),this.addLight(mp,nf),this.addLight(nG,Yx),this.addLight(rG,_w),this.addLight(iG,vw),this.addLight(J4,b$),this.addLight(tG,_$),this.addToneMapping(P5,Tw),this.addToneMapping(D5,ww),this.addToneMapping(B5,Sw),this.addToneMapping(k5,Nw),this.addToneMapping(U5,Ew),this.addToneMapping(G5,Aw)}}class T$ extends SG{constructor(e={}){let t;e.forceWebGL?t=J0:(t=y$,e.getFallback=()=>(se("WebGPURenderer: WebGPU is not available, running under WebGL2 backend."),new J0(e)));const r=new t(e);super(r,e),this.library=new v$,this.isWebGPURenderer=!0,typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}}const ld={type:"change"},yp={type:"start"},bp={type:"end"},ux=1e-6,Be={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4},rc=new Te,Ar=new Te,w$=new le,ic=new le,ud=new le,ts=new bs,dx=new le,sc=new le,dd=new le,oc=new le;class S$ extends ml{constructor(e,t=null){super(e,t),this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.keys=["KeyA","KeyS","KeyD"],this.mouseButtons={LEFT:vt.ROTATE,MIDDLE:vt.DOLLY,RIGHT:vt.PAN},this.target=new le,this.state=Be.NONE,this.keyState=Be.NONE,this._lastPosition=new le,this._lastZoom=1,this._touchZoomDistanceStart=0,this._touchZoomDistanceEnd=0,this._lastAngle=0,this._eye=new le,this._movePrev=new Te,this._moveCurr=new Te,this._lastAxis=new le,this._zoomStart=new Te,this._zoomEnd=new Te,this._panStart=new Te,this._panEnd=new Te,this._pointers=[],this._pointerPositions={},this._onPointerMove=E$.bind(this),this._onPointerDown=N$.bind(this),this._onPointerUp=A$.bind(this),this._onPointerCancel=R$.bind(this),this._onContextMenu=k$.bind(this),this._onMouseWheel=F$.bind(this),this._onKeyDown=M$.bind(this),this._onKeyUp=C$.bind(this),this._onTouchStart=I$.bind(this),this._onTouchMove=L$.bind(this),this._onTouchEnd=O$.bind(this),this._onMouseDown=P$.bind(this),this._onMouseMove=D$.bind(this),this._onMouseUp=B$.bind(this),this._target0=this.target.clone(),this._position0=this.object.position.clone(),this._up0=this.object.up.clone(),this._zoom0=this.object.zoom,t!==null&&(this.connect(t),this.handleResize()),this.update()}connect(e){super.connect(e),window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerCancel),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1}),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.style.touchAction="none"}disconnect(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerCancel),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}handleResize(){const e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}update(){this._eye.subVectors(this.object.position,this.target),this.noRotate||this._rotateCamera(),this.noZoom||this._zoomCamera(),this.noPan||this._panCamera(),this.object.position.addVectors(this.target,this._eye),this.object.isPerspectiveCamera?(this._checkDistances(),this.object.lookAt(this.target),this._lastPosition.distanceToSquared(this.object.position)>ux&&(this.dispatchEvent(ld),this._lastPosition.copy(this.object.position))):this.object.isOrthographicCamera?(this.object.lookAt(this.target),(this._lastPosition.distanceToSquared(this.object.position)>ux||this._lastZoom!==this.object.zoom)&&(this.dispatchEvent(ld),this._lastPosition.copy(this.object.position),this._lastZoom=this.object.zoom)):console.warn("THREE.TrackballControls: Unsupported camera type.")}reset(){this.state=Be.NONE,this.keyState=Be.NONE,this.target.copy(this._target0),this.object.position.copy(this._position0),this.object.up.copy(this._up0),this.object.zoom=this._zoom0,this.object.updateProjectionMatrix(),this._eye.subVectors(this.object.position,this.target),this.object.lookAt(this.target),this.dispatchEvent(ld),this._lastPosition.copy(this.object.position),this._lastZoom=this.object.zoom}_panCamera(){if(Ar.copy(this._panEnd).sub(this._panStart),Ar.lengthSq()){if(this.object.isOrthographicCamera){const e=(this.object.right-this.object.left)/this.object.zoom/this.domElement.clientWidth,t=(this.object.top-this.object.bottom)/this.object.zoom/this.domElement.clientWidth;Ar.x*=e,Ar.y*=t}Ar.multiplyScalar(this._eye.length()*this.panSpeed),ic.copy(this._eye).cross(this.object.up).setLength(Ar.x),ic.add(w$.copy(this.object.up).setLength(Ar.y)),this.object.position.add(ic),this.target.add(ic),this.staticMoving?this._panStart.copy(this._panEnd):this._panStart.add(Ar.subVectors(this._panEnd,this._panStart).multiplyScalar(this.dynamicDampingFactor))}}_rotateCamera(){oc.set(this._moveCurr.x-this._movePrev.x,this._moveCurr.y-this._movePrev.y,0);let e=oc.length();e?(this._eye.copy(this.object.position).sub(this.target),dx.copy(this._eye).normalize(),sc.copy(this.object.up).normalize(),dd.crossVectors(sc,dx).normalize(),sc.setLength(this._moveCurr.y-this._movePrev.y),dd.setLength(this._moveCurr.x-this._movePrev.x),oc.copy(sc.add(dd)),ud.crossVectors(oc,this._eye).normalize(),e*=this.rotateSpeed,ts.setFromAxisAngle(ud,e),this._eye.applyQuaternion(ts),this.object.up.applyQuaternion(ts),this._lastAxis.copy(ud),this._lastAngle=e):!this.staticMoving&&this._lastAngle&&(this._lastAngle*=Math.sqrt(1-this.dynamicDampingFactor),this._eye.copy(this.object.position).sub(this.target),ts.setFromAxisAngle(this._lastAxis,this._lastAngle),this._eye.applyQuaternion(ts),this.object.up.applyQuaternion(ts)),this._movePrev.copy(this._moveCurr)}_zoomCamera(){let e;this.state===Be.TOUCH_ZOOM_PAN?(e=this._touchZoomDistanceStart/this._touchZoomDistanceEnd,this._touchZoomDistanceStart=this._touchZoomDistanceEnd,this.object.isPerspectiveCamera?this._eye.multiplyScalar(e):this.object.isOrthographicCamera?(this.object.zoom=Ic.clamp(this.object.zoom/e,this.minZoom,this.maxZoom),this._lastZoom!==this.object.zoom&&this.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type")):(e=1+(this._zoomEnd.y-this._zoomStart.y)*this.zoomSpeed,e!==1&&e>0&&(this.object.isPerspectiveCamera?this._eye.multiplyScalar(e):this.object.isOrthographicCamera?(this.object.zoom=Ic.clamp(this.object.zoom/e,this.minZoom,this.maxZoom),this._lastZoom!==this.object.zoom&&this.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type")),this.staticMoving?this._zoomStart.copy(this._zoomEnd):this._zoomStart.y+=(this._zoomEnd.y-this._zoomStart.y)*this.dynamicDampingFactor)}_getMouseOnScreen(e,t){return rc.set((e-this.screen.left)/this.screen.width,(t-this.screen.top)/this.screen.height),rc}_getMouseOnCircle(e,t){return rc.set((e-this.screen.width*.5-this.screen.left)/(this.screen.width*.5),(this.screen.height+2*(this.screen.top-t))/this.screen.width),rc}_addPointer(e){this._pointers.push(e)}_removePointer(e){delete this._pointerPositions[e.pointerId];for(let t=0;t<this._pointers.length;t++)if(this._pointers[t].pointerId==e.pointerId){this._pointers.splice(t,1);return}}_trackPointer(e){let t=this._pointerPositions[e.pointerId];t===void 0&&(t=new Te,this._pointerPositions[e.pointerId]=t),t.set(e.pageX,e.pageY)}_getSecondPointerPosition(e){const t=e.pointerId===this._pointers[0].pointerId?this._pointers[1]:this._pointers[0];return this._pointerPositions[t.pointerId]}_checkDistances(){(!this.noZoom||!this.noPan)&&(this._eye.lengthSq()>this.maxDistance*this.maxDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.maxDistance)),this._zoomStart.copy(this._zoomEnd)),this._eye.lengthSq()<this.minDistance*this.minDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.minDistance)),this._zoomStart.copy(this._zoomEnd)))}}function N$(n){this.enabled!==!1&&(this._pointers.length===0&&(this.domElement.setPointerCapture(n.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),this._addPointer(n),n.pointerType==="touch"?this._onTouchStart(n):this._onMouseDown(n))}function E$(n){this.enabled!==!1&&(n.pointerType==="touch"?this._onTouchMove(n):this._onMouseMove(n))}function A$(n){this.enabled!==!1&&(n.pointerType==="touch"?this._onTouchEnd(n):this._onMouseUp(),this._removePointer(n),this._pointers.length===0&&(this.domElement.releasePointerCapture(n.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp)))}function R$(n){this._removePointer(n)}function C$(){this.enabled!==!1&&(this.keyState=Be.NONE,window.addEventListener("keydown",this._onKeyDown))}function M$(n){this.enabled!==!1&&(window.removeEventListener("keydown",this._onKeyDown),this.keyState===Be.NONE&&(n.code===this.keys[Be.ROTATE]&&!this.noRotate?this.keyState=Be.ROTATE:n.code===this.keys[Be.ZOOM]&&!this.noZoom?this.keyState=Be.ZOOM:n.code===this.keys[Be.PAN]&&!this.noPan&&(this.keyState=Be.PAN)))}function P$(n){let e;switch(n.button){case 0:e=this.mouseButtons.LEFT;break;case 1:e=this.mouseButtons.MIDDLE;break;case 2:e=this.mouseButtons.RIGHT;break;default:e=-1}switch(e){case vt.DOLLY:this.state=Be.ZOOM;break;case vt.ROTATE:this.state=Be.ROTATE;break;case vt.PAN:this.state=Be.PAN;break;default:this.state=Be.NONE}const t=this.keyState!==Be.NONE?this.keyState:this.state;t===Be.ROTATE&&!this.noRotate?(this._moveCurr.copy(this._getMouseOnCircle(n.pageX,n.pageY)),this._movePrev.copy(this._moveCurr)):t===Be.ZOOM&&!this.noZoom?(this._zoomStart.copy(this._getMouseOnScreen(n.pageX,n.pageY)),this._zoomEnd.copy(this._zoomStart)):t===Be.PAN&&!this.noPan&&(this._panStart.copy(this._getMouseOnScreen(n.pageX,n.pageY)),this._panEnd.copy(this._panStart)),this.dispatchEvent(yp)}function D$(n){const e=this.keyState!==Be.NONE?this.keyState:this.state;e===Be.ROTATE&&!this.noRotate?(this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this._getMouseOnCircle(n.pageX,n.pageY))):e===Be.ZOOM&&!this.noZoom?this._zoomEnd.copy(this._getMouseOnScreen(n.pageX,n.pageY)):e===Be.PAN&&!this.noPan&&this._panEnd.copy(this._getMouseOnScreen(n.pageX,n.pageY))}function B$(){this.state=Be.NONE,this.dispatchEvent(bp)}function F$(n){if(this.enabled!==!1&&this.noZoom!==!0){switch(n.preventDefault(),n.deltaMode){case 2:this._zoomStart.y-=n.deltaY*.025;break;case 1:this._zoomStart.y-=n.deltaY*.01;break;default:this._zoomStart.y-=n.deltaY*25e-5;break}this.dispatchEvent(yp),this.dispatchEvent(bp)}}function k$(n){this.enabled!==!1&&n.preventDefault()}function I$(n){switch(this._trackPointer(n),this._pointers.length){case 1:this.state=Be.TOUCH_ROTATE,this._moveCurr.copy(this._getMouseOnCircle(this._pointers[0].pageX,this._pointers[0].pageY)),this._movePrev.copy(this._moveCurr);break;default:this.state=Be.TOUCH_ZOOM_PAN;const e=this._pointers[0].pageX-this._pointers[1].pageX,t=this._pointers[0].pageY-this._pointers[1].pageY;this._touchZoomDistanceEnd=this._touchZoomDistanceStart=Math.sqrt(e*e+t*t);const r=(this._pointers[0].pageX+this._pointers[1].pageX)/2,i=(this._pointers[0].pageY+this._pointers[1].pageY)/2;this._panStart.copy(this._getMouseOnScreen(r,i)),this._panEnd.copy(this._panStart);break}this.dispatchEvent(yp)}function L$(n){switch(this._trackPointer(n),this._pointers.length){case 1:this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this._getMouseOnCircle(n.pageX,n.pageY));break;default:const e=this._getSecondPointerPosition(n),t=n.pageX-e.x,r=n.pageY-e.y;this._touchZoomDistanceEnd=Math.sqrt(t*t+r*r);const i=(n.pageX+e.x)/2,s=(n.pageY+e.y)/2;this._panEnd.copy(this._getMouseOnScreen(i,s));break}}function O$(n){switch(this._pointers.length){case 0:this.state=Be.NONE;break;case 1:this.state=Be.TOUCH_ROTATE,this._moveCurr.copy(this._getMouseOnCircle(n.pageX,n.pageY)),this._movePrev.copy(this._moveCurr);break;case 2:this.state=Be.TOUCH_ZOOM_PAN;for(let e=0;e<this._pointers.length;e++)if(this._pointers[e].pointerId!==n.pointerId){const t=this._pointerPositions[this._pointers[e].pointerId];this._moveCurr.copy(this._getMouseOnCircle(t.x,t.y)),this._movePrev.copy(this._moveCurr);break}break}this.dispatchEvent(bp)}const hx={type:"change"},_p={type:"start"},KT={type:"end"},ac=new IS,fx=new xl,U$=Math.cos(70*Ic.DEG2RAD),pt=new le,Ot=2*Math.PI,Ue={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},hd=1e-6;class G$ extends ml{constructor(e,t=null){super(e,t),this.state=Ue.NONE,this.target=new le,this.cursor=new le,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.keyRotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:vt.ROTATE,MIDDLE:vt.DOLLY,RIGHT:vt.PAN},this.touches={ONE:dr.ROTATE,TWO:dr.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this._lastPosition=new le,this._lastQuaternion=new bs,this._lastTargetPosition=new le,this._quat=new bs().setFromUnitVectors(e.up,new le(0,1,0)),this._quatInverse=this._quat.clone().invert(),this._spherical=new Up,this._sphericalDelta=new Up,this._scale=1,this._panOffset=new le,this._rotateStart=new Te,this._rotateEnd=new Te,this._rotateDelta=new Te,this._panStart=new Te,this._panEnd=new Te,this._panDelta=new Te,this._dollyStart=new Te,this._dollyEnd=new Te,this._dollyDelta=new Te,this._dollyDirection=new le,this._mouse=new Te,this._performCursorZoom=!1,this._pointers=[],this._pointerPositions={},this._controlActive=!1,this._onPointerMove=V$.bind(this),this._onPointerDown=$$.bind(this),this._onPointerUp=z$.bind(this),this._onContextMenu=K$.bind(this),this._onMouseWheel=W$.bind(this),this._onKeyDown=q$.bind(this),this._onTouchStart=X$.bind(this),this._onTouchMove=Y$.bind(this),this._onMouseDown=j$.bind(this),this._onMouseMove=H$.bind(this),this._interceptControlDown=Q$.bind(this),this._interceptControlUp=Z$.bind(this),this.domElement!==null&&this.connect(this.domElement),this.update()}connect(e){super.connect(e),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerUp),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1}),this.domElement.getRootNode().addEventListener("keydown",this._interceptControlDown,{passive:!0,capture:!0}),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerUp),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.stopListenToKeyEvents(),this.domElement.getRootNode().removeEventListener("keydown",this._interceptControlDown,{capture:!0}),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}getPolarAngle(){return this._spherical.phi}getAzimuthalAngle(){return this._spherical.theta}getDistance(){return this.object.position.distanceTo(this.target)}listenToKeyEvents(e){e.addEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=e}stopListenToKeyEvents(){this._domElementKeyEvents!==null&&(this._domElementKeyEvents.removeEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=null)}saveState(){this.target0.copy(this.target),this.position0.copy(this.object.position),this.zoom0=this.object.zoom}reset(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(hx),this.update(),this.state=Ue.NONE}update(e=null){const t=this.object.position;pt.copy(t).sub(this.target),pt.applyQuaternion(this._quat),this._spherical.setFromVector3(pt),this.autoRotate&&this.state===Ue.NONE&&this._rotateLeft(this._getAutoRotationAngle(e)),this.enableDamping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi);let r=this.minAzimuthAngle,i=this.maxAzimuthAngle;isFinite(r)&&isFinite(i)&&(r<-Math.PI?r+=Ot:r>Math.PI&&(r-=Ot),i<-Math.PI?i+=Ot:i>Math.PI&&(i-=Ot),r<=i?this._spherical.theta=Math.max(r,Math.min(i,this._spherical.theta)):this._spherical.theta=this._spherical.theta>(r+i)/2?Math.max(r,this._spherical.theta):Math.min(i,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),this.enableDamping===!0?this.target.addScaledVector(this._panOffset,this.dampingFactor):this.target.add(this._panOffset),this.target.sub(this.cursor),this.target.clampLength(this.minTargetRadius,this.maxTargetRadius),this.target.add(this.cursor);let s=!1;if(this.zoomToCursor&&this._performCursorZoom||this.object.isOrthographicCamera)this._spherical.radius=this._clampDistance(this._spherical.radius);else{const o=this._spherical.radius;this._spherical.radius=this._clampDistance(this._spherical.radius*this._scale),s=o!=this._spherical.radius}if(pt.setFromSpherical(this._spherical),pt.applyQuaternion(this._quatInverse),t.copy(this.target).add(pt),this.object.lookAt(this.target),this.enableDamping===!0?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this.zoomToCursor&&this._performCursorZoom){let o=null;if(this.object.isPerspectiveCamera){const a=pt.length();o=this._clampDistance(a*this._scale);const c=a-o;this.object.position.addScaledVector(this._dollyDirection,c),this.object.updateMatrixWorld(),s=!!c}else if(this.object.isOrthographicCamera){const a=new le(this._mouse.x,this._mouse.y,0);a.unproject(this.object);const c=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),this.object.updateProjectionMatrix(),s=c!==this.object.zoom;const l=new le(this._mouse.x,this._mouse.y,0);l.unproject(this.object),this.object.position.sub(l).add(a),this.object.updateMatrixWorld(),o=pt.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),this.zoomToCursor=!1;o!==null&&(this.screenSpacePanning?this.target.set(0,0,-1).transformDirection(this.object.matrix).multiplyScalar(o).add(this.object.position):(ac.origin.copy(this.object.position),ac.direction.set(0,0,-1).transformDirection(this.object.matrix),Math.abs(this.object.up.dot(ac.direction))<U$?this.object.lookAt(this.target):(fx.setFromNormalAndCoplanarPoint(this.object.up,this.target),ac.intersectPlane(fx,this.target))))}else if(this.object.isOrthographicCamera){const o=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),o!==this.object.zoom&&(this.object.updateProjectionMatrix(),s=!0)}return this._scale=1,this._performCursorZoom=!1,s||this._lastPosition.distanceToSquared(this.object.position)>hd||8*(1-this._lastQuaternion.dot(this.object.quaternion))>hd||this._lastTargetPosition.distanceToSquared(this.target)>hd?(this.dispatchEvent(hx),this._lastPosition.copy(this.object.position),this._lastQuaternion.copy(this.object.quaternion),this._lastTargetPosition.copy(this.target),!0):!1}_getAutoRotationAngle(e){return e!==null?Ot/60*this.autoRotateSpeed*e:Ot/60/60*this.autoRotateSpeed}_getZoomScale(e){const t=Math.abs(e*.01);return Math.pow(.95,this.zoomSpeed*t)}_rotateLeft(e){this._sphericalDelta.theta-=e}_rotateUp(e){this._sphericalDelta.phi-=e}_panLeft(e,t){pt.setFromMatrixColumn(t,0),pt.multiplyScalar(-e),this._panOffset.add(pt)}_panUp(e,t){this.screenSpacePanning===!0?pt.setFromMatrixColumn(t,1):(pt.setFromMatrixColumn(t,0),pt.crossVectors(this.object.up,pt)),pt.multiplyScalar(e),this._panOffset.add(pt)}_pan(e,t){const r=this.domElement;if(this.object.isPerspectiveCamera){const i=this.object.position;pt.copy(i).sub(this.target);let s=pt.length();s*=Math.tan(this.object.fov/2*Math.PI/180),this._panLeft(2*e*s/r.clientHeight,this.object.matrix),this._panUp(2*t*s/r.clientHeight,this.object.matrix)}else this.object.isOrthographicCamera?(this._panLeft(e*(this.object.right-this.object.left)/this.object.zoom/r.clientWidth,this.object.matrix),this._panUp(t*(this.object.top-this.object.bottom)/this.object.zoom/r.clientHeight,this.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),this.enablePan=!1)}_dollyOut(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale/=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_dollyIn(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale*=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_updateZoomParameters(e,t){if(!this.zoomToCursor)return;this._performCursorZoom=!0;const r=this.domElement.getBoundingClientRect(),i=e-r.left,s=t-r.top,o=r.width,a=r.height;this._mouse.x=i/o*2-1,this._mouse.y=-(s/a)*2+1,this._dollyDirection.set(this._mouse.x,this._mouse.y,1).unproject(this.object).sub(this.object.position).normalize()}_clampDistance(e){return Math.max(this.minDistance,Math.min(this.maxDistance,e))}_handleMouseDownRotate(e){this._rotateStart.set(e.clientX,e.clientY)}_handleMouseDownDolly(e){this._updateZoomParameters(e.clientX,e.clientX),this._dollyStart.set(e.clientX,e.clientY)}_handleMouseDownPan(e){this._panStart.set(e.clientX,e.clientY)}_handleMouseMoveRotate(e){this._rotateEnd.set(e.clientX,e.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(Ot*this._rotateDelta.x/t.clientHeight),this._rotateUp(Ot*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd),this.update()}_handleMouseMoveDolly(e){this._dollyEnd.set(e.clientX,e.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut(this._getZoomScale(this._dollyDelta.y)):this._dollyDelta.y<0&&this._dollyIn(this._getZoomScale(this._dollyDelta.y)),this._dollyStart.copy(this._dollyEnd),this.update()}_handleMouseMovePan(e){this._panEnd.set(e.clientX,e.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this.update()}_handleMouseWheel(e){this._updateZoomParameters(e.clientX,e.clientY),e.deltaY<0?this._dollyIn(this._getZoomScale(e.deltaY)):e.deltaY>0&&this._dollyOut(this._getZoomScale(e.deltaY)),this.update()}_handleKeyDown(e){let t=!1;switch(e.code){case this.keys.UP:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(Ot*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,this.keyPanSpeed),t=!0;break;case this.keys.BOTTOM:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(-Ot*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,-this.keyPanSpeed),t=!0;break;case this.keys.LEFT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(Ot*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(this.keyPanSpeed,0),t=!0;break;case this.keys.RIGHT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(-Ot*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(-this.keyPanSpeed,0),t=!0;break}t&&(e.preventDefault(),this.update())}_handleTouchStartRotate(e){if(this._pointers.length===1)this._rotateStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),r=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._rotateStart.set(r,i)}}_handleTouchStartPan(e){if(this._pointers.length===1)this._panStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),r=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._panStart.set(r,i)}}_handleTouchStartDolly(e){const t=this._getSecondPointerPosition(e),r=e.pageX-t.x,i=e.pageY-t.y,s=Math.sqrt(r*r+i*i);this._dollyStart.set(0,s)}_handleTouchStartDollyPan(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enablePan&&this._handleTouchStartPan(e)}_handleTouchStartDollyRotate(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enableRotate&&this._handleTouchStartRotate(e)}_handleTouchMoveRotate(e){if(this._pointers.length==1)this._rotateEnd.set(e.pageX,e.pageY);else{const r=this._getSecondPointerPosition(e),i=.5*(e.pageX+r.x),s=.5*(e.pageY+r.y);this._rotateEnd.set(i,s)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(Ot*this._rotateDelta.x/t.clientHeight),this._rotateUp(Ot*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd)}_handleTouchMovePan(e){if(this._pointers.length===1)this._panEnd.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),r=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._panEnd.set(r,i)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_handleTouchMoveDolly(e){const t=this._getSecondPointerPosition(e),r=e.pageX-t.x,i=e.pageY-t.y,s=Math.sqrt(r*r+i*i);this._dollyEnd.set(0,s),this._dollyDelta.set(0,Math.pow(this._dollyEnd.y/this._dollyStart.y,this.zoomSpeed)),this._dollyOut(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);const o=(e.pageX+t.x)*.5,a=(e.pageY+t.y)*.5;this._updateZoomParameters(o,a)}_handleTouchMoveDollyPan(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enablePan&&this._handleTouchMovePan(e)}_handleTouchMoveDollyRotate(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enableRotate&&this._handleTouchMoveRotate(e)}_addPointer(e){this._pointers.push(e.pointerId)}_removePointer(e){delete this._pointerPositions[e.pointerId];for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId){this._pointers.splice(t,1);return}}_isTrackingPointer(e){for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId)return!0;return!1}_trackPointer(e){let t=this._pointerPositions[e.pointerId];t===void 0&&(t=new Te,this._pointerPositions[e.pointerId]=t),t.set(e.pageX,e.pageY)}_getSecondPointerPosition(e){const t=e.pointerId===this._pointers[0]?this._pointers[1]:this._pointers[0];return this._pointerPositions[t]}_customWheelEvent(e){const t=e.deltaMode,r={clientX:e.clientX,clientY:e.clientY,deltaY:e.deltaY};switch(t){case 1:r.deltaY*=16;break;case 2:r.deltaY*=100;break}return e.ctrlKey&&!this._controlActive&&(r.deltaY*=10),r}}function $$(n){this.enabled!==!1&&(this._pointers.length===0&&(this.domElement.setPointerCapture(n.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),!this._isTrackingPointer(n)&&(this._addPointer(n),n.pointerType==="touch"?this._onTouchStart(n):this._onMouseDown(n)))}function V$(n){this.enabled!==!1&&(n.pointerType==="touch"?this._onTouchMove(n):this._onMouseMove(n))}function z$(n){switch(this._removePointer(n),this._pointers.length){case 0:this.domElement.releasePointerCapture(n.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.dispatchEvent(KT),this.state=Ue.NONE;break;case 1:const e=this._pointers[0],t=this._pointerPositions[e];this._onTouchStart({pointerId:e,pageX:t.x,pageY:t.y});break}}function j$(n){let e;switch(n.button){case 0:e=this.mouseButtons.LEFT;break;case 1:e=this.mouseButtons.MIDDLE;break;case 2:e=this.mouseButtons.RIGHT;break;default:e=-1}switch(e){case vt.DOLLY:if(this.enableZoom===!1)return;this._handleMouseDownDolly(n),this.state=Ue.DOLLY;break;case vt.ROTATE:if(n.ctrlKey||n.metaKey||n.shiftKey){if(this.enablePan===!1)return;this._handleMouseDownPan(n),this.state=Ue.PAN}else{if(this.enableRotate===!1)return;this._handleMouseDownRotate(n),this.state=Ue.ROTATE}break;case vt.PAN:if(n.ctrlKey||n.metaKey||n.shiftKey){if(this.enableRotate===!1)return;this._handleMouseDownRotate(n),this.state=Ue.ROTATE}else{if(this.enablePan===!1)return;this._handleMouseDownPan(n),this.state=Ue.PAN}break;default:this.state=Ue.NONE}this.state!==Ue.NONE&&this.dispatchEvent(_p)}function H$(n){switch(this.state){case Ue.ROTATE:if(this.enableRotate===!1)return;this._handleMouseMoveRotate(n);break;case Ue.DOLLY:if(this.enableZoom===!1)return;this._handleMouseMoveDolly(n);break;case Ue.PAN:if(this.enablePan===!1)return;this._handleMouseMovePan(n);break}}function W$(n){this.enabled===!1||this.enableZoom===!1||this.state!==Ue.NONE||(n.preventDefault(),this.dispatchEvent(_p),this._handleMouseWheel(this._customWheelEvent(n)),this.dispatchEvent(KT))}function q$(n){this.enabled!==!1&&this._handleKeyDown(n)}function X$(n){switch(this._trackPointer(n),this._pointers.length){case 1:switch(this.touches.ONE){case dr.ROTATE:if(this.enableRotate===!1)return;this._handleTouchStartRotate(n),this.state=Ue.TOUCH_ROTATE;break;case dr.PAN:if(this.enablePan===!1)return;this._handleTouchStartPan(n),this.state=Ue.TOUCH_PAN;break;default:this.state=Ue.NONE}break;case 2:switch(this.touches.TWO){case dr.DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchStartDollyPan(n),this.state=Ue.TOUCH_DOLLY_PAN;break;case dr.DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchStartDollyRotate(n),this.state=Ue.TOUCH_DOLLY_ROTATE;break;default:this.state=Ue.NONE}break;default:this.state=Ue.NONE}this.state!==Ue.NONE&&this.dispatchEvent(_p)}function Y$(n){switch(this._trackPointer(n),this.state){case Ue.TOUCH_ROTATE:if(this.enableRotate===!1)return;this._handleTouchMoveRotate(n),this.update();break;case Ue.TOUCH_PAN:if(this.enablePan===!1)return;this._handleTouchMovePan(n),this.update();break;case Ue.TOUCH_DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchMoveDollyPan(n),this.update();break;case Ue.TOUCH_DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchMoveDollyRotate(n),this.update();break;default:this.state=Ue.NONE}}function K$(n){this.enabled!==!1&&n.preventDefault()}function Q$(n){n.key==="Control"&&(this._controlActive=!0,this.domElement.getRootNode().addEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}function Z$(n){n.key==="Control"&&(this._controlActive=!1,this.domElement.getRootNode().removeEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}const J$={type:"change"},px=1e-6,gx=new bs;class e8 extends ml{constructor(e,t=null){super(e,t),this.movementSpeed=1,this.rollSpeed=.005,this.dragToLook=!1,this.autoForward=!1,this._moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this._moveVector=new le(0,0,0),this._rotationVector=new le(0,0,0),this._lastQuaternion=new bs,this._lastPosition=new le,this._status=0,this._onKeyDown=t8.bind(this),this._onKeyUp=n8.bind(this),this._onPointerMove=i8.bind(this),this._onPointerDown=r8.bind(this),this._onPointerUp=s8.bind(this),this._onPointerCancel=o8.bind(this),this._onContextMenu=a8.bind(this),t!==null&&this.connect(t)}connect(e){super.connect(e),window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.addEventListener("pointercancel",this._onPointerCancel),this.domElement.addEventListener("contextmenu",this._onContextMenu)}disconnect(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerCancel),this.domElement.removeEventListener("contextmenu",this._onContextMenu)}dispose(){this.disconnect()}update(e){if(this.enabled===!1)return;const t=this.object,r=e*this.movementSpeed,i=e*this.rollSpeed;t.translateX(this._moveVector.x*r),t.translateY(this._moveVector.y*r),t.translateZ(this._moveVector.z*r),gx.set(this._rotationVector.x*i,this._rotationVector.y*i,this._rotationVector.z*i,1).normalize(),t.quaternion.multiply(gx),(this._lastPosition.distanceToSquared(t.position)>px||8*(1-this._lastQuaternion.dot(t.quaternion))>px)&&(this.dispatchEvent(J$),this._lastQuaternion.copy(t.quaternion),this._lastPosition.copy(t.position))}_updateMovementVector(){const e=this._moveState.forward||this.autoForward&&!this._moveState.back?1:0;this._moveVector.x=-this._moveState.left+this._moveState.right,this._moveVector.y=-this._moveState.down+this._moveState.up,this._moveVector.z=-e+this._moveState.back}_updateRotationVector(){this._rotationVector.x=-this._moveState.pitchDown+this._moveState.pitchUp,this._rotationVector.y=-this._moveState.yawRight+this._moveState.yawLeft,this._rotationVector.z=-this._moveState.rollRight+this._moveState.rollLeft}_getContainerDimensions(){return this.domElement!=document?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}}}function t8(n){if(!(n.altKey||this.enabled===!1)){switch(n.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=.1;break;case"KeyW":this._moveState.forward=1;break;case"KeyS":this._moveState.back=1;break;case"KeyA":this._moveState.left=1;break;case"KeyD":this._moveState.right=1;break;case"KeyR":this._moveState.up=1;break;case"KeyF":this._moveState.down=1;break;case"ArrowUp":this._moveState.pitchUp=1;break;case"ArrowDown":this._moveState.pitchDown=1;break;case"ArrowLeft":this._moveState.yawLeft=1;break;case"ArrowRight":this._moveState.yawRight=1;break;case"KeyQ":this._moveState.rollLeft=1;break;case"KeyE":this._moveState.rollRight=1;break}this._updateMovementVector(),this._updateRotationVector()}}function n8(n){if(this.enabled!==!1){switch(n.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=1;break;case"KeyW":this._moveState.forward=0;break;case"KeyS":this._moveState.back=0;break;case"KeyA":this._moveState.left=0;break;case"KeyD":this._moveState.right=0;break;case"KeyR":this._moveState.up=0;break;case"KeyF":this._moveState.down=0;break;case"ArrowUp":this._moveState.pitchUp=0;break;case"ArrowDown":this._moveState.pitchDown=0;break;case"ArrowLeft":this._moveState.yawLeft=0;break;case"ArrowRight":this._moveState.yawRight=0;break;case"KeyQ":this._moveState.rollLeft=0;break;case"KeyE":this._moveState.rollRight=0;break}this._updateMovementVector(),this._updateRotationVector()}}function r8(n){if(this.enabled!==!1)if(this.dragToLook)this._status++;else{switch(n.button){case 0:this._moveState.forward=1;break;case 2:this._moveState.back=1;break}this._updateMovementVector()}}function i8(n){if(this.enabled!==!1&&(!this.dragToLook||this._status>0)){const e=this._getContainerDimensions(),t=e.size[0]/2,r=e.size[1]/2;this._moveState.yawLeft=-(n.pageX-e.offset[0]-t)/t,this._moveState.pitchDown=(n.pageY-e.offset[1]-r)/r,this._updateRotationVector()}}function s8(n){if(this.enabled!==!1){if(this.dragToLook)this._status--,this._moveState.yawLeft=this._moveState.pitchDown=0;else{switch(n.button){case 0:this._moveState.forward=0;break;case 2:this._moveState.back=0;break}this._updateMovementVector()}this._updateRotationVector()}}function o8(){this.enabled!==!1&&(this.dragToLook?(this._status=0,this._moveState.yawLeft=this._moveState.pitchDown=0):(this._moveState.forward=0,this._moveState.back=0,this._updateMovementVector()),this._updateRotationVector())}function a8(n){this.enabled!==!1&&n.preventDefault()}const c8={name:"CopyShader",uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform float opacity;

		uniform sampler2D tDiffuse;

		varying vec2 vUv;

		void main() {

			vec4 texel = texture2D( tDiffuse, vUv );
			gl_FragColor = opacity * texel;


		}`};class ql{constructor(){this.isPass=!0,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}const l8=new sf(-1,1,1,-1,0,1);class u8 extends sa{constructor(){super(),this.setAttribute("position",new kc([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new kc([0,2,0,0,2,0],2))}}const d8=new u8;class h8{constructor(e){this._mesh=new wn(d8,e)}dispose(){this._mesh.geometry.dispose()}render(e){e.render(this._mesh,l8)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}}class f8 extends ql{constructor(e,t="tDiffuse"){super(),this.textureID=t,this.uniforms=null,this.material=null,e instanceof Gp?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=LS.clone(e.uniforms),this.material=new Gp({name:e.name!==void 0?e.name:"unspecified",defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this._fsQuad=new h8(this.material)}render(e,t,r){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=r.texture),this._fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this._fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this._fsQuad.render(e))}dispose(){this.material.dispose(),this._fsQuad.dispose()}}class mx extends ql{constructor(e,t){super(),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,r){const i=e.getContext(),s=e.state;s.buffers.color.setMask(!1),s.buffers.depth.setMask(!1),s.buffers.color.setLocked(!0),s.buffers.depth.setLocked(!0);let o,a;this.inverse?(o=0,a=1):(o=1,a=0),s.buffers.stencil.setTest(!0),s.buffers.stencil.setOp(i.REPLACE,i.REPLACE,i.REPLACE),s.buffers.stencil.setFunc(i.ALWAYS,o,4294967295),s.buffers.stencil.setClear(a),s.buffers.stencil.setLocked(!0),e.setRenderTarget(r),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),s.buffers.color.setLocked(!1),s.buffers.depth.setLocked(!1),s.buffers.color.setMask(!0),s.buffers.depth.setMask(!0),s.buffers.stencil.setLocked(!1),s.buffers.stencil.setFunc(i.EQUAL,1,4294967295),s.buffers.stencil.setOp(i.KEEP,i.KEEP,i.KEEP),s.buffers.stencil.setLocked(!0)}}class p8 extends ql{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}class g8{constructor(e,t){if(this.renderer=e,this._pixelRatio=e.getPixelRatio(),t===void 0){const r=e.getSize(new Te);this._width=r.width,this._height=r.height,t=new OS(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:Ft}),t.texture.name="EffectComposer.rt1"}else this._width=t.width,this._height=t.height;this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],this.copyPass=new f8(c8),this.copyPass.material.blending=vs,this.clock=new Dy}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const t=this.passes.indexOf(e);t!==-1&&this.passes.splice(t,1)}isLastEnabledPass(e){for(let t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){e===void 0&&(e=this.clock.getDelta());const t=this.renderer.getRenderTarget();let r=!1;for(let i=0,s=this.passes.length;i<s;i++){const o=this.passes[i];if(o.enabled!==!1){if(o.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(i),o.render(this.renderer,this.writeBuffer,this.readBuffer,e,r),o.needsSwap){if(r){const a=this.renderer.getContext(),c=this.renderer.state.buffers.stencil;c.setFunc(a.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),c.setFunc(a.EQUAL,1,4294967295)}this.swapBuffers()}mx!==void 0&&(o instanceof mx?r=!0:o instanceof p8&&(r=!1))}}this.renderer.setRenderTarget(t)}reset(e){if(e===void 0){const t=this.renderer.getSize(new Te);this._pixelRatio=this.renderer.getPixelRatio(),this._width=t.width,this._height=t.height,e=this.renderTarget1.clone(),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;const r=this._width*this._pixelRatio,i=this._height*this._pixelRatio;this.renderTarget1.setSize(r,i),this.renderTarget2.setSize(r,i);for(let s=0;s<this.passes.length;s++)this.passes[s].setSize(r,i)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}class m8 extends ql{constructor(e,t,r=null,i=null,s=null){super(),this.scene=e,this.camera=t,this.overrideMaterial=r,this.clearColor=i,this.clearAlpha=s,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new un}render(e,t,r){const i=e.autoClear;e.autoClear=!1;let s,o;this.overrideMaterial!==null&&(o=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor!==null&&(e.getClearColor(this._oldClearColor),e.setClearColor(this.clearColor,e.getClearAlpha())),this.clearAlpha!==null&&(s=e.getClearAlpha(),e.setClearAlpha(this.clearAlpha)),this.clearDepth==!0&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:r),this.clear===!0&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),this.clearColor!==null&&e.setClearColor(this._oldClearColor),this.clearAlpha!==null&&e.setClearAlpha(s),this.overrideMaterial!==null&&(this.scene.overrideMaterial=o),e.autoClear=i}}function x8(n){if(n===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return n}function na(n,e){return na=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,r){return t.__proto__=r,t},na(n,e)}function y8(n,e){n.prototype=Object.create(e.prototype),n.prototype.constructor=n,na(n,e)}function $h(n){return $h=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},$h(n)}function b8(n){try{return Function.toString.call(n).indexOf("[native code]")!==-1}catch{return typeof n=="function"}}function QT(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(QT=function(){return!!n})()}function _8(n,e,t){if(QT())return Reflect.construct.apply(null,arguments);var r=[null];r.push.apply(r,e);var i=new(n.bind.apply(n,r));return t&&na(i,t.prototype),i}function Vh(n){var e=typeof Map=="function"?new Map:void 0;return Vh=function(r){if(r===null||!b8(r))return r;if(typeof r!="function")throw new TypeError("Super expression must either be null or a function");if(e!==void 0){if(e.has(r))return e.get(r);e.set(r,i)}function i(){return _8(r,arguments,$h(this).constructor)}return i.prototype=Object.create(r.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),na(i,r)},Vh(n)}var Un=(function(n){y8(e,n);function e(t){var r;return r=n.call(this,"An error occurred. See https://github.com/styled-components/polished/blob/main/src/internalHelpers/errors.md#"+t+" for more information.")||this,x8(r)}return e})(Vh(Error));function fd(n){return Math.round(n*255)}function v8(n,e,t){return fd(n)+","+fd(e)+","+fd(t)}function hl(n,e,t,r){if(r===void 0&&(r=v8),e===0)return r(t,t,t);var i=(n%360+360)%360/60,s=(1-Math.abs(2*t-1))*e,o=s*(1-Math.abs(i%2-1)),a=0,c=0,l=0;i>=0&&i<1?(a=s,c=o):i>=1&&i<2?(a=o,c=s):i>=2&&i<3?(c=s,l=o):i>=3&&i<4?(c=o,l=s):i>=4&&i<5?(a=o,l=s):i>=5&&i<6&&(a=s,l=o);var u=t-s/2,d=a+u,h=c+u,f=l+u;return r(d,h,f)}var xx={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"789",lightslategrey:"789",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"0f0",limegreen:"32cd32",linen:"faf0e6",magenta:"f0f",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",rebeccapurple:"639",red:"f00",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"fff",whitesmoke:"f5f5f5",yellow:"ff0",yellowgreen:"9acd32"};function T8(n){if(typeof n!="string")return n;var e=n.toLowerCase();return xx[e]?"#"+xx[e]:n}var w8=/^#[a-fA-F0-9]{6}$/,S8=/^#[a-fA-F0-9]{8}$/,N8=/^#[a-fA-F0-9]{3}$/,E8=/^#[a-fA-F0-9]{4}$/,pd=/^rgb\(\s*(\d{1,3})\s*(?:,)?\s*(\d{1,3})\s*(?:,)?\s*(\d{1,3})\s*\)$/i,A8=/^rgb(?:a)?\(\s*(\d{1,3})\s*(?:,)?\s*(\d{1,3})\s*(?:,)?\s*(\d{1,3})\s*(?:,|\/)\s*([-+]?\d*[.]?\d+[%]?)\s*\)$/i,R8=/^hsl\(\s*(\d{0,3}[.]?[0-9]+(?:deg)?)\s*(?:,)?\s*(\d{1,3}[.]?[0-9]?)%\s*(?:,)?\s*(\d{1,3}[.]?[0-9]?)%\s*\)$/i,C8=/^hsl(?:a)?\(\s*(\d{0,3}[.]?[0-9]+(?:deg)?)\s*(?:,)?\s*(\d{1,3}[.]?[0-9]?)%\s*(?:,)?\s*(\d{1,3}[.]?[0-9]?)%\s*(?:,|\/)\s*([-+]?\d*[.]?\d+[%]?)\s*\)$/i;function Fs(n){if(typeof n!="string")throw new Un(3);var e=T8(n);if(e.match(w8))return{red:parseInt(""+e[1]+e[2],16),green:parseInt(""+e[3]+e[4],16),blue:parseInt(""+e[5]+e[6],16)};if(e.match(S8)){var t=parseFloat((parseInt(""+e[7]+e[8],16)/255).toFixed(2));return{red:parseInt(""+e[1]+e[2],16),green:parseInt(""+e[3]+e[4],16),blue:parseInt(""+e[5]+e[6],16),alpha:t}}if(e.match(N8))return{red:parseInt(""+e[1]+e[1],16),green:parseInt(""+e[2]+e[2],16),blue:parseInt(""+e[3]+e[3],16)};if(e.match(E8)){var r=parseFloat((parseInt(""+e[4]+e[4],16)/255).toFixed(2));return{red:parseInt(""+e[1]+e[1],16),green:parseInt(""+e[2]+e[2],16),blue:parseInt(""+e[3]+e[3],16),alpha:r}}var i=pd.exec(e);if(i)return{red:parseInt(""+i[1],10),green:parseInt(""+i[2],10),blue:parseInt(""+i[3],10)};var s=A8.exec(e.substring(0,50));if(s)return{red:parseInt(""+s[1],10),green:parseInt(""+s[2],10),blue:parseInt(""+s[3],10),alpha:parseFloat(""+s[4])>1?parseFloat(""+s[4])/100:parseFloat(""+s[4])};var o=R8.exec(e);if(o){var a=parseInt(""+o[1],10),c=parseInt(""+o[2],10)/100,l=parseInt(""+o[3],10)/100,u="rgb("+hl(a,c,l)+")",d=pd.exec(u);if(!d)throw new Un(4,e,u);return{red:parseInt(""+d[1],10),green:parseInt(""+d[2],10),blue:parseInt(""+d[3],10)}}var h=C8.exec(e.substring(0,50));if(h){var f=parseInt(""+h[1],10),p=parseInt(""+h[2],10)/100,g=parseInt(""+h[3],10)/100,x="rgb("+hl(f,p,g)+")",m=pd.exec(x);if(!m)throw new Un(4,e,x);return{red:parseInt(""+m[1],10),green:parseInt(""+m[2],10),blue:parseInt(""+m[3],10),alpha:parseFloat(""+h[4])>1?parseFloat(""+h[4])/100:parseFloat(""+h[4])}}throw new Un(5)}function M8(n){var e=n.red/255,t=n.green/255,r=n.blue/255,i=Math.max(e,t,r),s=Math.min(e,t,r),o=(i+s)/2;if(i===s)return n.alpha!==void 0?{hue:0,saturation:0,lightness:o,alpha:n.alpha}:{hue:0,saturation:0,lightness:o};var a,c=i-s,l=o>.5?c/(2-i-s):c/(i+s);switch(i){case e:a=(t-r)/c+(t<r?6:0);break;case t:a=(r-e)/c+2;break;default:a=(e-t)/c+4;break}return a*=60,n.alpha!==void 0?{hue:a,saturation:l,lightness:o,alpha:n.alpha}:{hue:a,saturation:l,lightness:o}}function Xr(n){return M8(Fs(n))}var P8=function(e){return e.length===7&&e[1]===e[2]&&e[3]===e[4]&&e[5]===e[6]?"#"+e[1]+e[3]+e[5]:e},zh=P8;function ui(n){var e=n.toString(16);return e.length===1?"0"+e:e}function gd(n){return ui(Math.round(n*255))}function D8(n,e,t){return zh("#"+gd(n)+gd(e)+gd(t))}function ZT(n,e,t){return hl(n,e,t,D8)}function B8(n,e,t){if(typeof n=="object"&&e===void 0&&t===void 0)return ZT(n.hue,n.saturation,n.lightness);throw new Un(1)}function F8(n,e,t,r){if(typeof n=="object"&&e===void 0&&t===void 0&&r===void 0)return n.alpha>=1?ZT(n.hue,n.saturation,n.lightness):"rgba("+hl(n.hue,n.saturation,n.lightness)+","+n.alpha+")";throw new Un(2)}function JT(n,e,t){if(typeof n=="number"&&typeof e=="number"&&typeof t=="number")return zh("#"+ui(n)+ui(e)+ui(t));if(typeof n=="object"&&e===void 0&&t===void 0)return zh("#"+ui(n.red)+ui(n.green)+ui(n.blue));throw new Un(6)}function Xl(n,e,t,r){if(typeof n=="object"&&e===void 0&&t===void 0&&r===void 0)return n.alpha>=1?JT(n.red,n.green,n.blue):"rgba("+n.red+","+n.green+","+n.blue+","+n.alpha+")";throw new Un(7)}var k8=function(e){return typeof e.red=="number"&&typeof e.green=="number"&&typeof e.blue=="number"&&(typeof e.alpha!="number"||typeof e.alpha>"u")},I8=function(e){return typeof e.red=="number"&&typeof e.green=="number"&&typeof e.blue=="number"&&typeof e.alpha=="number"},L8=function(e){return typeof e.hue=="number"&&typeof e.saturation=="number"&&typeof e.lightness=="number"&&(typeof e.alpha!="number"||typeof e.alpha>"u")},O8=function(e){return typeof e.hue=="number"&&typeof e.saturation=="number"&&typeof e.lightness=="number"&&typeof e.alpha=="number"};function Yr(n){if(typeof n!="object")throw new Un(8);if(I8(n))return Xl(n);if(k8(n))return JT(n);if(O8(n))return F8(n);if(L8(n))return B8(n);throw new Un(8)}function e1(n,e,t){return function(){var i=t.concat(Array.prototype.slice.call(arguments));return i.length>=e?n.apply(this,i):e1(n,e,i)}}function Jt(n){return e1(n,n.length,[])}function U8(n,e){if(e==="transparent")return e;var t=Xr(e);return Yr(cn({},t,{hue:t.hue+parseFloat(n)}))}Jt(U8);function zs(n,e,t){return Math.max(n,Math.min(e,t))}function G8(n,e){if(e==="transparent")return e;var t=Xr(e);return Yr(cn({},t,{lightness:zs(0,1,t.lightness-parseFloat(n))}))}Jt(G8);function $8(n,e){if(e==="transparent")return e;var t=Xr(e);return Yr(cn({},t,{saturation:zs(0,1,t.saturation-parseFloat(n))}))}Jt($8);function V8(n,e){if(e==="transparent")return e;var t=Xr(e);return Yr(cn({},t,{lightness:zs(0,1,t.lightness+parseFloat(n))}))}Jt(V8);function z8(n,e,t){if(e==="transparent")return t;if(t==="transparent")return e;if(n===0)return t;var r=Fs(e),i=cn({},r,{alpha:typeof r.alpha=="number"?r.alpha:1}),s=Fs(t),o=cn({},s,{alpha:typeof s.alpha=="number"?s.alpha:1}),a=i.alpha-o.alpha,c=parseFloat(n)*2-1,l=c*a===-1?c:c+a,u=1+c*a,d=(l/u+1)/2,h=1-d,f={red:Math.floor(i.red*d+o.red*h),green:Math.floor(i.green*d+o.green*h),blue:Math.floor(i.blue*d+o.blue*h),alpha:i.alpha*parseFloat(n)+o.alpha*(1-parseFloat(n))};return Xl(f)}var j8=Jt(z8),t1=j8;function H8(n,e){if(e==="transparent")return e;var t=Fs(e),r=typeof t.alpha=="number"?t.alpha:1,i=cn({},t,{alpha:zs(0,1,(r*100+parseFloat(n)*100)/100)});return Xl(i)}var W8=Jt(H8),q8=W8;function X8(n,e){if(e==="transparent")return e;var t=Xr(e);return Yr(cn({},t,{saturation:zs(0,1,t.saturation+parseFloat(n))}))}Jt(X8);function Y8(n,e){return e==="transparent"?e:Yr(cn({},Xr(e),{hue:parseFloat(n)}))}Jt(Y8);function K8(n,e){return e==="transparent"?e:Yr(cn({},Xr(e),{lightness:parseFloat(n)}))}Jt(K8);function Q8(n,e){return e==="transparent"?e:Yr(cn({},Xr(e),{saturation:parseFloat(n)}))}Jt(Q8);function Z8(n,e){return e==="transparent"?e:t1(parseFloat(n),"rgb(0, 0, 0)",e)}Jt(Z8);function J8(n,e){return e==="transparent"?e:t1(parseFloat(n),"rgb(255, 255, 255)",e)}Jt(J8);function eV(n,e){if(e==="transparent")return e;var t=Fs(e),r=typeof t.alpha=="number"?t.alpha:1,i=cn({},t,{alpha:zs(0,1,+(r*100-parseFloat(n)*100).toFixed(2)/100)});return Xl(i)}Jt(eV);var Ai=Object.freeze({Linear:Object.freeze({None:function(n){return n},In:function(n){return n},Out:function(n){return n},InOut:function(n){return n}}),Quadratic:Object.freeze({In:function(n){return n*n},Out:function(n){return n*(2-n)},InOut:function(n){return(n*=2)<1?.5*n*n:-.5*(--n*(n-2)-1)}}),Cubic:Object.freeze({In:function(n){return n*n*n},Out:function(n){return--n*n*n+1},InOut:function(n){return(n*=2)<1?.5*n*n*n:.5*((n-=2)*n*n+2)}}),Quartic:Object.freeze({In:function(n){return n*n*n*n},Out:function(n){return 1- --n*n*n*n},InOut:function(n){return(n*=2)<1?.5*n*n*n*n:-.5*((n-=2)*n*n*n-2)}}),Quintic:Object.freeze({In:function(n){return n*n*n*n*n},Out:function(n){return--n*n*n*n*n+1},InOut:function(n){return(n*=2)<1?.5*n*n*n*n*n:.5*((n-=2)*n*n*n*n+2)}}),Sinusoidal:Object.freeze({In:function(n){return 1-Math.sin((1-n)*Math.PI/2)},Out:function(n){return Math.sin(n*Math.PI/2)},InOut:function(n){return .5*(1-Math.sin(Math.PI*(.5-n)))}}),Exponential:Object.freeze({In:function(n){return n===0?0:Math.pow(1024,n-1)},Out:function(n){return n===1?1:1-Math.pow(2,-10*n)},InOut:function(n){return n===0?0:n===1?1:(n*=2)<1?.5*Math.pow(1024,n-1):.5*(-Math.pow(2,-10*(n-1))+2)}}),Circular:Object.freeze({In:function(n){return 1-Math.sqrt(1-n*n)},Out:function(n){return Math.sqrt(1- --n*n)},InOut:function(n){return(n*=2)<1?-.5*(Math.sqrt(1-n*n)-1):.5*(Math.sqrt(1-(n-=2)*n)+1)}}),Elastic:Object.freeze({In:function(n){return n===0?0:n===1?1:-Math.pow(2,10*(n-1))*Math.sin((n-1.1)*5*Math.PI)},Out:function(n){return n===0?0:n===1?1:Math.pow(2,-10*n)*Math.sin((n-.1)*5*Math.PI)+1},InOut:function(n){return n===0?0:n===1?1:(n*=2,n<1?-.5*Math.pow(2,10*(n-1))*Math.sin((n-1.1)*5*Math.PI):.5*Math.pow(2,-10*(n-1))*Math.sin((n-1.1)*5*Math.PI)+1)}}),Back:Object.freeze({In:function(n){var e=1.70158;return n===1?1:n*n*((e+1)*n-e)},Out:function(n){var e=1.70158;return n===0?0:--n*n*((e+1)*n+e)+1},InOut:function(n){var e=2.5949095;return(n*=2)<1?.5*(n*n*((e+1)*n-e)):.5*((n-=2)*n*((e+1)*n+e)+2)}}),Bounce:Object.freeze({In:function(n){return 1-Ai.Bounce.Out(1-n)},Out:function(n){return n<1/2.75?7.5625*n*n:n<2/2.75?7.5625*(n-=1.5/2.75)*n+.75:n<2.5/2.75?7.5625*(n-=2.25/2.75)*n+.9375:7.5625*(n-=2.625/2.75)*n+.984375},InOut:function(n){return n<.5?Ai.Bounce.In(n*2)*.5:Ai.Bounce.Out(n*2-1)*.5+.5}}),generatePow:function(n){return n===void 0&&(n=4),n=n<Number.EPSILON?Number.EPSILON:n,n=n>1e4?1e4:n,{In:function(e){return Math.pow(e,n)},Out:function(e){return 1-Math.pow(1-e,n)},InOut:function(e){return e<.5?Math.pow(e*2,n)/2:(1-Math.pow(2-e*2,n))/2+.5}}}}),Eo=function(){return performance.now()},n1=(function(){function n(){this._tweens={},this._tweensAddedDuringUpdate={}}return n.prototype.getAll=function(){var e=this;return Object.keys(this._tweens).map(function(t){return e._tweens[t]})},n.prototype.removeAll=function(){this._tweens={}},n.prototype.add=function(e){this._tweens[e.getId()]=e,this._tweensAddedDuringUpdate[e.getId()]=e},n.prototype.remove=function(e){delete this._tweens[e.getId()],delete this._tweensAddedDuringUpdate[e.getId()]},n.prototype.update=function(e,t){e===void 0&&(e=Eo()),t===void 0&&(t=!1);var r=Object.keys(this._tweens);if(r.length===0)return!1;for(;r.length>0;){this._tweensAddedDuringUpdate={};for(var i=0;i<r.length;i++){var s=this._tweens[r[i]],o=!t;s&&s.update(e,o)===!1&&!t&&delete this._tweens[r[i]]}r=Object.keys(this._tweensAddedDuringUpdate)}return!0},n})(),jh={Linear:function(n,e){var t=n.length-1,r=t*e,i=Math.floor(r),s=jh.Utils.Linear;return e<0?s(n[0],n[1],r):e>1?s(n[t],n[t-1],t-r):s(n[i],n[i+1>t?t:i+1],r-i)},Utils:{Linear:function(n,e,t){return(e-n)*t+n}}},r1=(function(){function n(){}return n.nextId=function(){return n._nextId++},n._nextId=0,n})(),Hh=new n1,yx=(function(){function n(e,t){t===void 0&&(t=Hh),this._object=e,this._group=t,this._isPaused=!1,this._pauseStart=0,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._isDynamic=!1,this._initialRepeat=0,this._repeat=0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=0,this._easingFunction=Ai.Linear.None,this._interpolationFunction=jh.Linear,this._chainedTweens=[],this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._id=r1.nextId(),this._isChainStopped=!1,this._propertiesAreSetUp=!1,this._goToEnd=!1}return n.prototype.getId=function(){return this._id},n.prototype.isPlaying=function(){return this._isPlaying},n.prototype.isPaused=function(){return this._isPaused},n.prototype.getDuration=function(){return this._duration},n.prototype.to=function(e,t){if(t===void 0&&(t=1e3),this._isPlaying)throw new Error("Can not call Tween.to() while Tween is already started or paused. Stop the Tween first.");return this._valuesEnd=e,this._propertiesAreSetUp=!1,this._duration=t<0?0:t,this},n.prototype.duration=function(e){return e===void 0&&(e=1e3),this._duration=e<0?0:e,this},n.prototype.dynamic=function(e){return e===void 0&&(e=!1),this._isDynamic=e,this},n.prototype.start=function(e,t){if(e===void 0&&(e=Eo()),t===void 0&&(t=!1),this._isPlaying)return this;if(this._group&&this._group.add(this),this._repeat=this._initialRepeat,this._reversed){this._reversed=!1;for(var r in this._valuesStartRepeat)this._swapEndStartRepeatValues(r),this._valuesStart[r]=this._valuesStartRepeat[r]}if(this._isPlaying=!0,this._isPaused=!1,this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._isChainStopped=!1,this._startTime=e,this._startTime+=this._delayTime,!this._propertiesAreSetUp||t){if(this._propertiesAreSetUp=!0,!this._isDynamic){var i={};for(var s in this._valuesEnd)i[s]=this._valuesEnd[s];this._valuesEnd=i}this._setupProperties(this._object,this._valuesStart,this._valuesEnd,this._valuesStartRepeat,t)}return this},n.prototype.startFromCurrentValues=function(e){return this.start(e,!0)},n.prototype._setupProperties=function(e,t,r,i,s){for(var o in r){var a=e[o],c=Array.isArray(a),l=c?"array":typeof a,u=!c&&Array.isArray(r[o]);if(!(l==="undefined"||l==="function")){if(u){var d=r[o];if(d.length===0)continue;for(var h=[a],f=0,p=d.length;f<p;f+=1){var g=this._handleRelativeValue(a,d[f]);if(isNaN(g)){u=!1,console.warn("Found invalid interpolation list. Skipping.");break}h.push(g)}u&&(r[o]=h)}if((l==="object"||c)&&a&&!u){t[o]=c?[]:{};var x=a;for(var m in x)t[o][m]=x[m];i[o]=c?[]:{};var d=r[o];if(!this._isDynamic){var y={};for(var m in d)y[m]=d[m];r[o]=d=y}this._setupProperties(x,t[o],d,i[o],s)}else(typeof t[o]>"u"||s)&&(t[o]=a),c||(t[o]*=1),u?i[o]=r[o].slice().reverse():i[o]=t[o]||0}}},n.prototype.stop=function(){return this._isChainStopped||(this._isChainStopped=!0,this.stopChainedTweens()),this._isPlaying?(this._group&&this._group.remove(this),this._isPlaying=!1,this._isPaused=!1,this._onStopCallback&&this._onStopCallback(this._object),this):this},n.prototype.end=function(){return this._goToEnd=!0,this.update(1/0),this},n.prototype.pause=function(e){return e===void 0&&(e=Eo()),this._isPaused||!this._isPlaying?this:(this._isPaused=!0,this._pauseStart=e,this._group&&this._group.remove(this),this)},n.prototype.resume=function(e){return e===void 0&&(e=Eo()),!this._isPaused||!this._isPlaying?this:(this._isPaused=!1,this._startTime+=e-this._pauseStart,this._pauseStart=0,this._group&&this._group.add(this),this)},n.prototype.stopChainedTweens=function(){for(var e=0,t=this._chainedTweens.length;e<t;e++)this._chainedTweens[e].stop();return this},n.prototype.group=function(e){return e===void 0&&(e=Hh),this._group=e,this},n.prototype.delay=function(e){return e===void 0&&(e=0),this._delayTime=e,this},n.prototype.repeat=function(e){return e===void 0&&(e=0),this._initialRepeat=e,this._repeat=e,this},n.prototype.repeatDelay=function(e){return this._repeatDelayTime=e,this},n.prototype.yoyo=function(e){return e===void 0&&(e=!1),this._yoyo=e,this},n.prototype.easing=function(e){return e===void 0&&(e=Ai.Linear.None),this._easingFunction=e,this},n.prototype.interpolation=function(e){return e===void 0&&(e=jh.Linear),this._interpolationFunction=e,this},n.prototype.chain=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this._chainedTweens=e,this},n.prototype.onStart=function(e){return this._onStartCallback=e,this},n.prototype.onEveryStart=function(e){return this._onEveryStartCallback=e,this},n.prototype.onUpdate=function(e){return this._onUpdateCallback=e,this},n.prototype.onRepeat=function(e){return this._onRepeatCallback=e,this},n.prototype.onComplete=function(e){return this._onCompleteCallback=e,this},n.prototype.onStop=function(e){return this._onStopCallback=e,this},n.prototype.update=function(e,t){var r=this,i;if(e===void 0&&(e=Eo()),t===void 0&&(t=!0),this._isPaused)return!0;var s,o=this._startTime+this._duration;if(!this._goToEnd&&!this._isPlaying){if(e>o)return!1;t&&this.start(e,!0)}if(this._goToEnd=!1,e<this._startTime)return!0;this._onStartCallbackFired===!1&&(this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),this._onEveryStartCallbackFired===!1&&(this._onEveryStartCallback&&this._onEveryStartCallback(this._object),this._onEveryStartCallbackFired=!0);var a=e-this._startTime,c=this._duration+((i=this._repeatDelayTime)!==null&&i!==void 0?i:this._delayTime),l=this._duration+this._repeat*c,u=function(){if(r._duration===0||a>l)return 1;var x=Math.trunc(a/c),m=a-x*c,y=Math.min(m/r._duration,1);return y===0&&a===r._duration?1:y},d=u(),h=this._easingFunction(d);if(this._updateProperties(this._object,this._valuesStart,this._valuesEnd,h),this._onUpdateCallback&&this._onUpdateCallback(this._object,d),this._duration===0||a>=this._duration)if(this._repeat>0){var f=Math.min(Math.trunc((a-this._duration)/c)+1,this._repeat);isFinite(this._repeat)&&(this._repeat-=f);for(s in this._valuesStartRepeat)!this._yoyo&&typeof this._valuesEnd[s]=="string"&&(this._valuesStartRepeat[s]=this._valuesStartRepeat[s]+parseFloat(this._valuesEnd[s])),this._yoyo&&this._swapEndStartRepeatValues(s),this._valuesStart[s]=this._valuesStartRepeat[s];return this._yoyo&&(this._reversed=!this._reversed),this._startTime+=c*f,this._onRepeatCallback&&this._onRepeatCallback(this._object),this._onEveryStartCallbackFired=!1,!0}else{this._onCompleteCallback&&this._onCompleteCallback(this._object);for(var p=0,g=this._chainedTweens.length;p<g;p++)this._chainedTweens[p].start(this._startTime+this._duration,!1);return this._isPlaying=!1,!1}return!0},n.prototype._updateProperties=function(e,t,r,i){for(var s in r)if(t[s]!==void 0){var o=t[s]||0,a=r[s],c=Array.isArray(e[s]),l=Array.isArray(a),u=!c&&l;u?e[s]=this._interpolationFunction(a,i):typeof a=="object"&&a?this._updateProperties(e[s],o,a,i):(a=this._handleRelativeValue(o,a),typeof a=="number"&&(e[s]=o+(a-o)*i))}},n.prototype._handleRelativeValue=function(e,t){return typeof t!="string"?t:t.charAt(0)==="+"||t.charAt(0)==="-"?e+parseFloat(t):parseFloat(t)},n.prototype._swapEndStartRepeatValues=function(e){var t=this._valuesStartRepeat[e],r=this._valuesEnd[e];typeof r=="string"?this._valuesStartRepeat[e]=this._valuesStartRepeat[e]+parseFloat(r):this._valuesStartRepeat[e]=this._valuesEnd[e],this._valuesEnd[e]=t},n})();r1.nextId;var qn=Hh;qn.getAll.bind(qn);qn.removeAll.bind(qn);qn.add.bind(qn);qn.remove.bind(qn);qn.update.bind(qn);var xa,Qe,i1,s1,mi,bx,o1,a1,c1,vp,Wh,qh,ra={},l1=[],tV=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,Yl=Array.isArray;function Gn(n,e){for(var t in e)n[t]=e[t];return n}function Tp(n){n&&n.parentNode&&n.parentNode.removeChild(n)}function nV(n,e,t){var r,i,s,o={};for(s in e)s=="key"?r=e[s]:s=="ref"?i=e[s]:o[s]=e[s];if(arguments.length>2&&(o.children=arguments.length>3?xa.call(arguments,2):t),typeof n=="function"&&n.defaultProps!=null)for(s in n.defaultProps)o[s]===void 0&&(o[s]=n.defaultProps[s]);return Uo(n,o,r,i,null)}function Uo(n,e,t,r,i){var s={type:n,props:e,key:t,ref:r,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:i??++i1,__i:-1,__u:0};return i==null&&Qe.vnode!=null&&Qe.vnode(s),s}function Kl(n){return n.children}function Cc(n,e){this.props=n,this.context=e}function ks(n,e){if(e==null)return n.__?ks(n.__,n.__i+1):null;for(var t;e<n.__k.length;e++)if((t=n.__k[e])!=null&&t.__e!=null)return t.__e;return typeof n.type=="function"?ks(n):null}function u1(n){var e,t;if((n=n.__)!=null&&n.__c!=null){for(n.__e=n.__c.base=null,e=0;e<n.__k.length;e++)if((t=n.__k[e])!=null&&t.__e!=null){n.__e=n.__c.base=t.__e;break}return u1(n)}}function _x(n){(!n.__d&&(n.__d=!0)&&mi.push(n)&&!fl.__r++||bx!=Qe.debounceRendering)&&((bx=Qe.debounceRendering)||o1)(fl)}function fl(){for(var n,e,t,r,i,s,o,a=1;mi.length;)mi.length>a&&mi.sort(a1),n=mi.shift(),a=mi.length,n.__d&&(t=void 0,r=void 0,i=(r=(e=n).__v).__e,s=[],o=[],e.__P&&((t=Gn({},r)).__v=r.__v+1,Qe.vnode&&Qe.vnode(t),wp(e.__P,t,r,e.__n,e.__P.namespaceURI,32&r.__u?[i]:null,s,i??ks(r),!!(32&r.__u),o),t.__v=r.__v,t.__.__k[t.__i]=t,f1(s,t,o),r.__e=r.__=null,t.__e!=i&&u1(t)));fl.__r=0}function d1(n,e,t,r,i,s,o,a,c,l,u){var d,h,f,p,g,x,m,y=r&&r.__k||l1,_=e.length;for(c=rV(t,e,y,c,_),d=0;d<_;d++)(f=t.__k[d])!=null&&(h=f.__i==-1?ra:y[f.__i]||ra,f.__i=d,x=wp(n,f,h,i,s,o,a,c,l,u),p=f.__e,f.ref&&h.ref!=f.ref&&(h.ref&&Sp(h.ref,null,f),u.push(f.ref,f.__c||p,f)),g==null&&p!=null&&(g=p),(m=!!(4&f.__u))||h.__k===f.__k?c=h1(f,c,n,m):typeof f.type=="function"&&x!==void 0?c=x:p&&(c=p.nextSibling),f.__u&=-7);return t.__e=g,c}function rV(n,e,t,r,i){var s,o,a,c,l,u=t.length,d=u,h=0;for(n.__k=new Array(i),s=0;s<i;s++)(o=e[s])!=null&&typeof o!="boolean"&&typeof o!="function"?(typeof o=="string"||typeof o=="number"||typeof o=="bigint"||o.constructor==String?o=n.__k[s]=Uo(null,o,null,null,null):Yl(o)?o=n.__k[s]=Uo(Kl,{children:o},null,null,null):o.constructor==null&&o.__b>0?o=n.__k[s]=Uo(o.type,o.props,o.key,o.ref?o.ref:null,o.__v):n.__k[s]=o,c=s+h,o.__=n,o.__b=n.__b+1,(l=o.__i=iV(o,t,c,d))!=-1&&(d--,(a=t[l])&&(a.__u|=2)),a==null||a.__v==null?(l==-1&&(i>u?h--:i<u&&h++),typeof o.type!="function"&&(o.__u|=4)):l!=c&&(l==c-1?h--:l==c+1?h++:(l>c?h--:h++,o.__u|=4))):n.__k[s]=null;if(d)for(s=0;s<u;s++)(a=t[s])!=null&&(2&a.__u)==0&&(a.__e==r&&(r=ks(a)),g1(a,a));return r}function h1(n,e,t,r){var i,s;if(typeof n.type=="function"){for(i=n.__k,s=0;i&&s<i.length;s++)i[s]&&(i[s].__=n,e=h1(i[s],e,t,r));return e}n.__e!=e&&(r&&(e&&n.type&&!e.parentNode&&(e=ks(n)),t.insertBefore(n.__e,e||null)),e=n.__e);do e=e&&e.nextSibling;while(e!=null&&e.nodeType==8);return e}function iV(n,e,t,r){var i,s,o,a=n.key,c=n.type,l=e[t],u=l!=null&&(2&l.__u)==0;if(l===null&&a==null||u&&a==l.key&&c==l.type)return t;if(r>(u?1:0)){for(i=t-1,s=t+1;i>=0||s<e.length;)if((l=e[o=i>=0?i--:s++])!=null&&(2&l.__u)==0&&a==l.key&&c==l.type)return o}return-1}function vx(n,e,t){e[0]=="-"?n.setProperty(e,t??""):n[e]=t==null?"":typeof t!="number"||tV.test(e)?t:t+"px"}function cc(n,e,t,r,i){var s,o;e:if(e=="style")if(typeof t=="string")n.style.cssText=t;else{if(typeof r=="string"&&(n.style.cssText=r=""),r)for(e in r)t&&e in t||vx(n.style,e,"");if(t)for(e in t)r&&t[e]==r[e]||vx(n.style,e,t[e])}else if(e[0]=="o"&&e[1]=="n")s=e!=(e=e.replace(c1,"$1")),o=e.toLowerCase(),e=o in n||e=="onFocusOut"||e=="onFocusIn"?o.slice(2):e.slice(2),n.l||(n.l={}),n.l[e+s]=t,t?r?t.u=r.u:(t.u=vp,n.addEventListener(e,s?qh:Wh,s)):n.removeEventListener(e,s?qh:Wh,s);else{if(i=="http://www.w3.org/2000/svg")e=e.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if(e!="width"&&e!="height"&&e!="href"&&e!="list"&&e!="form"&&e!="tabIndex"&&e!="download"&&e!="rowSpan"&&e!="colSpan"&&e!="role"&&e!="popover"&&e in n)try{n[e]=t??"";break e}catch{}typeof t=="function"||(t==null||t===!1&&e[4]!="-"?n.removeAttribute(e):n.setAttribute(e,e=="popover"&&t==1?"":t))}}function Tx(n){return function(e){if(this.l){var t=this.l[e.type+n];if(e.t==null)e.t=vp++;else if(e.t<t.u)return;return t(Qe.event?Qe.event(e):e)}}}function wp(n,e,t,r,i,s,o,a,c,l){var u,d,h,f,p,g,x,m,y,_,v,T,w,N,E,A,B,R=e.type;if(e.constructor!=null)return null;128&t.__u&&(c=!!(32&t.__u),s=[a=e.__e=t.__e]),(u=Qe.__b)&&u(e);e:if(typeof R=="function")try{if(m=e.props,y="prototype"in R&&R.prototype.render,_=(u=R.contextType)&&r[u.__c],v=u?_?_.props.value:u.__:r,t.__c?x=(d=e.__c=t.__c).__=d.__E:(y?e.__c=d=new R(m,v):(e.__c=d=new Cc(m,v),d.constructor=R,d.render=oV),_&&_.sub(d),d.state||(d.state={}),d.__n=r,h=d.__d=!0,d.__h=[],d._sb=[]),y&&d.__s==null&&(d.__s=d.state),y&&R.getDerivedStateFromProps!=null&&(d.__s==d.state&&(d.__s=Gn({},d.__s)),Gn(d.__s,R.getDerivedStateFromProps(m,d.__s))),f=d.props,p=d.state,d.__v=e,h)y&&R.getDerivedStateFromProps==null&&d.componentWillMount!=null&&d.componentWillMount(),y&&d.componentDidMount!=null&&d.__h.push(d.componentDidMount);else{if(y&&R.getDerivedStateFromProps==null&&m!==f&&d.componentWillReceiveProps!=null&&d.componentWillReceiveProps(m,v),e.__v==t.__v||!d.__e&&d.shouldComponentUpdate!=null&&d.shouldComponentUpdate(m,d.__s,v)===!1){for(e.__v!=t.__v&&(d.props=m,d.state=d.__s,d.__d=!1),e.__e=t.__e,e.__k=t.__k,e.__k.some(function(L){L&&(L.__=e)}),T=0;T<d._sb.length;T++)d.__h.push(d._sb[T]);d._sb=[],d.__h.length&&o.push(d);break e}d.componentWillUpdate!=null&&d.componentWillUpdate(m,d.__s,v),y&&d.componentDidUpdate!=null&&d.__h.push(function(){d.componentDidUpdate(f,p,g)})}if(d.context=v,d.props=m,d.__P=n,d.__e=!1,w=Qe.__r,N=0,y){for(d.state=d.__s,d.__d=!1,w&&w(e),u=d.render(d.props,d.state,d.context),E=0;E<d._sb.length;E++)d.__h.push(d._sb[E]);d._sb=[]}else do d.__d=!1,w&&w(e),u=d.render(d.props,d.state,d.context),d.state=d.__s;while(d.__d&&++N<25);d.state=d.__s,d.getChildContext!=null&&(r=Gn(Gn({},r),d.getChildContext())),y&&!h&&d.getSnapshotBeforeUpdate!=null&&(g=d.getSnapshotBeforeUpdate(f,p)),A=u,u!=null&&u.type===Kl&&u.key==null&&(A=p1(u.props.children)),a=d1(n,Yl(A)?A:[A],e,t,r,i,s,o,a,c,l),d.base=e.__e,e.__u&=-161,d.__h.length&&o.push(d),x&&(d.__E=d.__=null)}catch(L){if(e.__v=null,c||s!=null)if(L.then){for(e.__u|=c?160:128;a&&a.nodeType==8&&a.nextSibling;)a=a.nextSibling;s[s.indexOf(a)]=null,e.__e=a}else{for(B=s.length;B--;)Tp(s[B]);Xh(e)}else e.__e=t.__e,e.__k=t.__k,L.then||Xh(e);Qe.__e(L,e,t)}else s==null&&e.__v==t.__v?(e.__k=t.__k,e.__e=t.__e):a=e.__e=sV(t.__e,e,t,r,i,s,o,c,l);return(u=Qe.diffed)&&u(e),128&e.__u?void 0:a}function Xh(n){n&&n.__c&&(n.__c.__e=!0),n&&n.__k&&n.__k.forEach(Xh)}function f1(n,e,t){for(var r=0;r<t.length;r++)Sp(t[r],t[++r],t[++r]);Qe.__c&&Qe.__c(e,n),n.some(function(i){try{n=i.__h,i.__h=[],n.some(function(s){s.call(i)})}catch(s){Qe.__e(s,i.__v)}})}function p1(n){return typeof n!="object"||n==null||n.__b&&n.__b>0?n:Yl(n)?n.map(p1):Gn({},n)}function sV(n,e,t,r,i,s,o,a,c){var l,u,d,h,f,p,g,x=t.props||ra,m=e.props,y=e.type;if(y=="svg"?i="http://www.w3.org/2000/svg":y=="math"?i="http://www.w3.org/1998/Math/MathML":i||(i="http://www.w3.org/1999/xhtml"),s!=null){for(l=0;l<s.length;l++)if((f=s[l])&&"setAttribute"in f==!!y&&(y?f.localName==y:f.nodeType==3)){n=f,s[l]=null;break}}if(n==null){if(y==null)return document.createTextNode(m);n=document.createElementNS(i,y,m.is&&m),a&&(Qe.__m&&Qe.__m(e,s),a=!1),s=null}if(y==null)x===m||a&&n.data==m||(n.data=m);else{if(s=s&&xa.call(n.childNodes),!a&&s!=null)for(x={},l=0;l<n.attributes.length;l++)x[(f=n.attributes[l]).name]=f.value;for(l in x)if(f=x[l],l!="children"){if(l=="dangerouslySetInnerHTML")d=f;else if(!(l in m)){if(l=="value"&&"defaultValue"in m||l=="checked"&&"defaultChecked"in m)continue;cc(n,l,null,f,i)}}for(l in m)f=m[l],l=="children"?h=f:l=="dangerouslySetInnerHTML"?u=f:l=="value"?p=f:l=="checked"?g=f:a&&typeof f!="function"||x[l]===f||cc(n,l,f,x[l],i);if(u)a||d&&(u.__html==d.__html||u.__html==n.innerHTML)||(n.innerHTML=u.__html),e.__k=[];else if(d&&(n.innerHTML=""),d1(e.type=="template"?n.content:n,Yl(h)?h:[h],e,t,r,y=="foreignObject"?"http://www.w3.org/1999/xhtml":i,s,o,s?s[0]:t.__k&&ks(t,0),a,c),s!=null)for(l=s.length;l--;)Tp(s[l]);a||(l="value",y=="progress"&&p==null?n.removeAttribute("value"):p!=null&&(p!==n[l]||y=="progress"&&!p||y=="option"&&p!=x[l])&&cc(n,l,p,x[l],i),l="checked",g!=null&&g!=n[l]&&cc(n,l,g,x[l],i))}return n}function Sp(n,e,t){try{if(typeof n=="function"){var r=typeof n.__u=="function";r&&n.__u(),r&&e==null||(n.__u=n(e))}else n.current=e}catch(i){Qe.__e(i,t)}}function g1(n,e,t){var r,i;if(Qe.unmount&&Qe.unmount(n),(r=n.ref)&&(r.current&&r.current!=n.__e||Sp(r,null,e)),(r=n.__c)!=null){if(r.componentWillUnmount)try{r.componentWillUnmount()}catch(s){Qe.__e(s,e)}r.base=r.__P=null}if(r=n.__k)for(i=0;i<r.length;i++)r[i]&&g1(r[i],e,t||typeof n.type!="function");t||Tp(n.__e),n.__c=n.__=n.__e=void 0}function oV(n,e,t){return this.constructor(n,t)}function aV(n,e,t){var r,i,s,o;e==document&&(e=document.documentElement),Qe.__&&Qe.__(n,e),i=(r=!1)?null:e.__k,s=[],o=[],wp(e,n=e.__k=nV(Kl,null,[n]),i||ra,ra,e.namespaceURI,i?null:e.firstChild?xa.call(e.childNodes):null,s,i?i.__e:e.firstChild,r,o),f1(s,n,o)}function m1(n,e,t){var r,i,s,o,a=Gn({},n.props);for(s in n.type&&n.type.defaultProps&&(o=n.type.defaultProps),e)s=="key"?r=e[s]:s=="ref"?i=e[s]:a[s]=e[s]===void 0&&o!=null?o[s]:e[s];return arguments.length>2&&(a.children=arguments.length>3?xa.call(arguments,2):t),Uo(n.type,a,r||n.key,i||n.ref,null)}xa=l1.slice,Qe={__e:function(n,e,t,r){for(var i,s,o;e=e.__;)if((i=e.__c)&&!i.__)try{if((s=i.constructor)&&s.getDerivedStateFromError!=null&&(i.setState(s.getDerivedStateFromError(n)),o=i.__d),i.componentDidCatch!=null&&(i.componentDidCatch(n,r||{}),o=i.__d),o)return i.__E=i}catch(a){n=a}throw n}},i1=0,s1=function(n){return n!=null&&n.constructor==null},Cc.prototype.setState=function(n,e){var t;t=this.__s!=null&&this.__s!=this.state?this.__s:this.__s=Gn({},this.state),typeof n=="function"&&(n=n(Gn({},t),this.props)),n&&Gn(t,n),n!=null&&this.__v&&(e&&this._sb.push(e),_x(this))},Cc.prototype.forceUpdate=function(n){this.__v&&(this.__e=!0,n&&this.__h.push(n),_x(this))},Cc.prototype.render=Kl,mi=[],o1=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,a1=function(n,e){return n.__v.__b-e.__v.__b},fl.__r=0,c1=/(PointerCapture)$|Capture$/i,vp=0,Wh=Tx(!1),qh=Tx(!0);function wx(n,e){(e==null||e>n.length)&&(e=n.length);for(var t=0,r=Array(e);t<e;t++)r[t]=n[t];return r}function cV(n){if(Array.isArray(n))return n}function lV(n,e,t){return(e=gV(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function uV(n,e){var t=n==null?null:typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(t!=null){var r,i,s,o,a=[],c=!0,l=!1;try{if(s=(t=t.call(n)).next,e!==0)for(;!(c=(r=s.call(t)).done)&&(a.push(r.value),a.length!==e);c=!0);}catch(u){l=!0,i=u}finally{try{if(!c&&t.return!=null&&(o=t.return(),Object(o)!==o))return}finally{if(l)throw i}}return a}}function dV(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Sx(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(n,i).enumerable})),t.push.apply(t,r)}return t}function hV(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Sx(Object(t),!0).forEach(function(r){lV(n,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):Sx(Object(t)).forEach(function(r){Object.defineProperty(n,r,Object.getOwnPropertyDescriptor(t,r))})}return n}function fV(n,e){return cV(n)||uV(n,e)||mV(n,e)||dV()}function pV(n,e){if(typeof n!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var r=t.call(n,e);if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function gV(n){var e=pV(n,"string");return typeof e=="symbol"?e:e+""}function pl(n){"@babel/helpers - typeof";return pl=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},pl(n)}function mV(n,e){if(n){if(typeof n=="string")return wx(n,e);var t={}.toString.call(n).slice(8,-1);return t==="Object"&&n.constructor&&(t=n.constructor.name),t==="Map"||t==="Set"?Array.from(n):t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?wx(n,e):void 0}}var Yh=function(e){if(pl(e)!=="object")return e;var t=m1(e);if(t.props){var r;t.props=hV({},t.props),t!=null&&(r=t.props)!==null&&r!==void 0&&r.children&&(t.props.children=Array.isArray(t.props.children)?t.props.children.map(Yh):Yh(t.props.children))}return t},xV=function(e){return s1(m1(e))},yV=function(e,t){delete t.__k,aV(Yh(e),t)};function bV(n,e){e===void 0&&(e={});var t=e.insertAt;if(!(typeof document>"u")){var r=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css",t==="top"&&r.firstChild?r.insertBefore(i,r.firstChild):r.appendChild(i),i.styleSheet?i.styleSheet.cssText=n:i.appendChild(document.createTextNode(n))}}var _V=`.float-tooltip-kap {
  position: absolute;
  width: max-content; /* prevent shrinking near right edge */
  max-width: max(50%, 150px);
  padding: 3px 5px;
  border-radius: 3px;
  font: 12px sans-serif;
  color: #eee;
  background: rgba(0,0,0,0.6);
  pointer-events: none;
}
`;bV(_V);var vV=Cl({props:{content:{default:!1},offsetX:{triggerUpdate:!1},offsetY:{triggerUpdate:!1}},init:function(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=r.style,s=i===void 0?{}:i,o=!!e&&pl(e)==="object"&&!!e.node&&typeof e.node=="function",a=st(o?e.node():e);a.style("position")==="static"&&a.style("position","relative"),t.tooltipEl=a.append("div").attr("class","float-tooltip-kap"),Object.entries(s).forEach(function(l){var u=fV(l,2),d=u[0],h=u[1];return t.tooltipEl.style(d,h)}),t.tooltipEl.style("left","-10000px").style("display","none");var c="tooltip-".concat(Math.round(Math.random()*1e12));t.mouseInside=!1,a.on("mousemove.".concat(c),function(l){t.mouseInside=!0;var u=fn(l),d=a.node(),h=d.offsetWidth,f=d.offsetHeight,p=[t.offsetX===null||t.offsetX===void 0?"-".concat(u[0]/h*100,"%"):typeof t.offsetX=="number"?"calc(-50% + ".concat(t.offsetX,"px)"):t.offsetX,t.offsetY===null||t.offsetY===void 0?f>130&&f-u[1]<100?"calc(-100% - 6px)":"21px":typeof t.offsetY=="number"?t.offsetY<0?"calc(-100% - ".concat(Math.abs(t.offsetY),"px)"):"".concat(t.offsetY,"px"):t.offsetY];t.tooltipEl.style("left",u[0]+"px").style("top",u[1]+"px").style("transform","translate(".concat(p.join(","),")")),t.content&&t.tooltipEl.style("display","inline")}),a.on("mouseover.".concat(c),function(){t.mouseInside=!0,t.content&&t.tooltipEl.style("display","inline")}),a.on("mouseout.".concat(c),function(){t.mouseInside=!1,t.tooltipEl.style("display","none")})},update:function(e){e.tooltipEl.style("display",e.content&&e.mouseInside?"inline":"none"),e.content?e.content instanceof HTMLElement?(e.tooltipEl.text(""),e.tooltipEl.append(function(){return e.content})):typeof e.content=="string"?e.tooltipEl.html(e.content):xV(e.content)?(e.tooltipEl.text(""),yV(e.content,e.tooltipEl.node())):(e.tooltipEl.style("display","none"),console.warn("Tooltip content is invalid, skipping.",e.content,e.content.toString())):e.tooltipEl.text("")}});function TV(n,e){e===void 0&&(e={});var t=e.insertAt;if(!(typeof document>"u")){var r=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css",t==="top"&&r.firstChild?r.insertBefore(i,r.firstChild):r.appendChild(i),i.styleSheet?i.styleSheet.cssText=n:i.appendChild(document.createTextNode(n))}}var wV=`.scene-nav-info {
  position: absolute;
  bottom: 5px;
  width: 100%;
  text-align: center;
  color: slategrey;
  opacity: 0.7;
  font-size: 10px;
  font-family: sans-serif;
  pointer-events: none;
  user-select: none;
}

.scene-container canvas:focus {
  outline: none;
}`;TV(wV);function Kh(n,e){(e==null||e>n.length)&&(e=n.length);for(var t=0,r=Array(e);t<e;t++)r[t]=n[t];return r}function SV(n){if(Array.isArray(n))return n}function NV(n){if(Array.isArray(n))return Kh(n)}function EV(n,e,t){return(e=BV(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function AV(n){if(typeof Symbol<"u"&&n[Symbol.iterator]!=null||n["@@iterator"]!=null)return Array.from(n)}function RV(n,e){var t=n==null?null:typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(t!=null){var r,i,s,o,a=[],c=!0,l=!1;try{if(s=(t=t.call(n)).next,e!==0)for(;!(c=(r=s.call(t)).done)&&(a.push(r.value),a.length!==e);c=!0);}catch(u){l=!0,i=u}finally{try{if(!c&&t.return!=null&&(o=t.return(),Object(o)!==o))return}finally{if(l)throw i}}return a}}function CV(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function MV(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function PV(n,e){return SV(n)||RV(n,e)||x1(n,e)||CV()}function oi(n){return NV(n)||AV(n)||x1(n)||MV()}function DV(n,e){if(typeof n!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var r=t.call(n,e);if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function BV(n){var e=DV(n,"string");return typeof e=="symbol"?e:e+""}function x1(n,e){if(n){if(typeof n=="string")return Kh(n,e);var t={}.toString.call(n).slice(8,-1);return t==="Object"&&n.constructor&&(t=n.constructor.name),t==="Map"||t==="Set"?Array.from(n):t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?Kh(n,e):void 0}}var Xe=window.THREE?window.THREE:{WebGLRenderer:GS,Scene:yl,PerspectiveCamera:Go,Raycaster:Vx,SRGBColorSpace:tf,TextureLoader:US,Vector2:Te,Vector3:le,Box3:Wx,Color:un,Mesh:wn,SphereGeometry:ef,MeshBasicMaterial:Mr,BackSide:jt,Clock:Dy},y1=Cl({props:{width:{default:window.innerWidth,onChange:function(e,t,r){isNaN(e)&&(t.width=r)}},height:{default:window.innerHeight,onChange:function(e,t,r){isNaN(e)&&(t.height=r)}},viewOffset:{default:[0,0]},backgroundColor:{default:"#000011"},backgroundImageUrl:{},onBackgroundImageLoaded:{},showNavInfo:{default:!0},skyRadius:{default:5e4},objects:{default:[]},lights:{default:[]},enablePointerInteraction:{default:!0,onChange:function(e,t){t.hoverObj=null,t.tooltip&&t.tooltip.content(null)},triggerUpdate:!1},pointerRaycasterThrottleMs:{default:50,triggerUpdate:!1},lineHoverPrecision:{default:1,triggerUpdate:!1},pointsHoverPrecision:{default:1,triggerUpdate:!1},hoverOrderComparator:{triggerUpdate:!1},hoverFilter:{default:function(){return!0},triggerUpdate:!1},tooltipContent:{triggerUpdate:!1},hoverDuringDrag:{default:!1,triggerUpdate:!1},clickAfterDrag:{default:!1,triggerUpdate:!1},onHover:{default:function(){},triggerUpdate:!1},onClick:{default:function(){},triggerUpdate:!1},onRightClick:{triggerUpdate:!1}},methods:{tick:function(e){if(e.initialised){e.controls.enabled&&e.controls.update&&e.controls.update(Math.min(1,e.clock.getDelta())),e.postProcessingComposer?e.postProcessingComposer.render():e.renderer.render(e.scene,e.camera),e.extraRenderers.forEach(function(o){return o.render(e.scene,e.camera)});var t=+new Date;if(e.enablePointerInteraction&&t-e.lastRaycasterCheck>=e.pointerRaycasterThrottleMs){e.lastRaycasterCheck=t;var r=null;if(e.hoverDuringDrag||!e.isPointerDragging){var i=this.intersectingObjects(e.pointerPos.x,e.pointerPos.y);e.hoverOrderComparator&&i.sort(function(o,a){return e.hoverOrderComparator(o.object,a.object)});var s=i.find(function(o){return e.hoverFilter(o.object)})||null;r=s?s.object:null,e.intersection=s||null}r!==e.hoverObj&&(e.onHover(r,e.hoverObj,e.intersection),e.tooltip.content(r&&Ee(e.tooltipContent)(r,e.intersection)||null),e.hoverObj=r)}e.tweenGroup.update()}return this},getPointerPos:function(e){var t=e.pointerPos,r=t.x,i=t.y;return{x:r,y:i}},cameraPosition:function(e,t,r,i){var s=e.camera;if(t&&e.initialised){var o=t,a=r||{x:0,y:0,z:0};if(!i)u(o),d(a);else{var c=Object.assign({},s.position),l=h();e.tweenGroup.add(new yx(c).to(o,i).easing(Ai.Quadratic.Out).onUpdate(u).start()),e.tweenGroup.add(new yx(l).to(a,i/3).easing(Ai.Quadratic.Out).onUpdate(d).start())}return this}return Object.assign({},s.position,{lookAt:h()});function u(f){var p=f.x,g=f.y,x=f.z;p!==void 0&&(s.position.x=p),g!==void 0&&(s.position.y=g),x!==void 0&&(s.position.z=x)}function d(f){var p=new Xe.Vector3(f.x,f.y,f.z);e.controls.enabled&&e.controls.target?e.controls.target=p:s.lookAt(p)}function h(){return Object.assign(new Xe.Vector3(0,0,-1e3).applyQuaternion(s.quaternion).add(s.position))}},zoomToFit:function(e){for(var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:10,i=arguments.length,s=new Array(i>3?i-3:0),o=3;o<i;o++)s[o-3]=arguments[o];return this.fitToBbox(this.getBbox.apply(this,s),t,r)},fitToBbox:function(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:10,s=e.camera;if(t){var o=new Xe.Vector3(0,0,0),a=Math.max.apply(Math,oi(Object.entries(t).map(function(f){var p=PV(f,2),g=p[0],x=p[1];return Math.max.apply(Math,oi(x.map(function(m){return Math.abs(o[g]-m)})))})))*2,c=(1-i*2/e.height)*s.fov,l=a/Math.atan(c*Math.PI/180),u=l/s.aspect,d=Math.max(l,u);if(d>0){var h=o.clone().sub(s.position).normalize().multiplyScalar(-d);this.cameraPosition(h,o,r)}}return this},getBbox:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:function(){return!0},r=new Xe.Box3(new Xe.Vector3(0,0,0),new Xe.Vector3(0,0,0)),i=e.objects.filter(t);return i.length?(i.forEach(function(s){return r.expandByObject(s)}),Object.assign.apply(Object,oi(["x","y","z"].map(function(s){return EV({},s,[r.min[s],r.max[s]])})))):null},getScreenCoords:function(e,t,r,i){var s=new Xe.Vector3(t,r,i);return s.project(this.camera()),{x:(s.x+1)*e.width/2,y:-(s.y-1)*e.height/2}},getSceneCoords:function(e,t,r){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0,s=new Xe.Vector2(t/e.width*2-1,-(r/e.height)*2+1),o=new Xe.Raycaster;return o.setFromCamera(s,e.camera),Object.assign({},o.ray.at(i,new Xe.Vector3))},intersectingObjects:function(e,t,r){var i=new Xe.Vector2(t/e.width*2-1,-(r/e.height)*2+1),s=new Xe.Raycaster;return s.params.Line.threshold=e.lineHoverPrecision,s.params.Points.threshold=e.pointsHoverPrecision,s.setFromCamera(i,e.camera),s.intersectObjects(e.objects,!0)},renderer:function(e){return e.renderer},scene:function(e){return e.scene},camera:function(e){return e.camera},postProcessingComposer:function(e){return e.postProcessingComposer},controls:function(e){return e.controls},tbControls:function(e){return e.controls}},stateInit:function(){return{scene:new Xe.Scene,camera:new Xe.PerspectiveCamera,clock:new Xe.Clock,tweenGroup:new n1,lastRaycasterCheck:0}},init:function(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=r.controlType,s=i===void 0?"trackball":i,o=r.useWebGPU,a=o===void 0?!1:o,c=r.rendererConfig,l=c===void 0?{}:c,u=r.extraRenderers,d=u===void 0?[]:u,h=r.waitForLoadComplete,f=h===void 0?!0:h;e.innerHTML="",e.appendChild(t.container=document.createElement("div")),t.container.className="scene-container",t.container.style.position="relative",t.container.appendChild(t.navInfo=document.createElement("div")),t.navInfo.className="scene-nav-info",t.navInfo.textContent={orbit:"Left-click: rotate, Mouse-wheel/middle-click: zoom, Right-click: pan",trackball:"Left-click: rotate, Mouse-wheel/middle-click: zoom, Right-click: pan",fly:"WASD: move, R|F: up | down, Q|E: roll, up|down: pitch, left|right: yaw"}[s]||"",t.navInfo.style.display=t.showNavInfo?null:"none",t.tooltip=new vV(t.container),t.pointerPos=new Xe.Vector2,t.pointerPos.x=-2,t.pointerPos.y=-2,["pointermove","pointerdown"].forEach(function(p){return t.container.addEventListener(p,function(g){if(p==="pointerdown"&&(t.isPointerPressed=!0),!t.isPointerDragging&&g.type==="pointermove"&&(g.pressure>0||t.isPointerPressed)&&(g.pointerType==="mouse"||g.movementX===void 0||[g.movementX,g.movementY].some(function(y){return Math.abs(y)>1}))&&(t.isPointerDragging=!0),t.enablePointerInteraction){var x=m(t.container);t.pointerPos.x=g.pageX-x.left,t.pointerPos.y=g.pageY-x.top}function m(y){var _=y.getBoundingClientRect(),v=window.pageXOffset||document.documentElement.scrollLeft,T=window.pageYOffset||document.documentElement.scrollTop;return{top:_.top+T,left:_.left+v}}},{passive:!0})}),t.container.addEventListener("pointerup",function(p){t.isPointerPressed&&(t.isPointerPressed=!1,!(t.isPointerDragging&&(t.isPointerDragging=!1,!t.clickAfterDrag))&&requestAnimationFrame(function(){p.button===0&&t.onClick(t.hoverObj||null,p,t.intersection),p.button===2&&t.onRightClick&&t.onRightClick(t.hoverObj||null,p,t.intersection)}))},{passive:!0,capture:!0}),t.container.addEventListener("contextmenu",function(p){t.onRightClick&&p.preventDefault()}),t.renderer=new(a?T$:Xe.WebGLRenderer)(Object.assign({antialias:!0,alpha:!0},l)),t.renderer.setPixelRatio(Math.min(2,window.devicePixelRatio)),t.container.appendChild(t.renderer.domElement),t.extraRenderers=d,t.extraRenderers.forEach(function(p){p.domElement.style.position="absolute",p.domElement.style.top="0px",p.domElement.style.pointerEvents="none",t.container.appendChild(p.domElement)}),t.postProcessingComposer=new g8(t.renderer),t.postProcessingComposer.addPass(new m8(t.scene,t.camera)),t.controls=new{trackball:S$,orbit:G$,fly:e8}[s](t.camera,t.renderer.domElement),s==="fly"&&(t.controls.movementSpeed=300,t.controls.rollSpeed=Math.PI/6,t.controls.dragToLook=!0),(s==="trackball"||s==="orbit")&&(t.controls.minDistance=.1,t.controls.maxDistance=t.skyRadius,t.controls.addEventListener("start",function(){t.controlsEngaged=!0}),t.controls.addEventListener("change",function(){t.controlsEngaged&&(t.controlsDragging=!0)}),t.controls.addEventListener("end",function(){t.controlsEngaged=!1,t.controlsDragging=!1})),[t.renderer,t.postProcessingComposer].concat(oi(t.extraRenderers)).forEach(function(p){return p.setSize(t.width,t.height)}),t.camera.aspect=t.width/t.height,t.camera.updateProjectionMatrix(),t.camera.position.z=1e3,t.scene.add(t.skysphere=new Xe.Mesh),t.skysphere.visible=!1,t.loadComplete=t.scene.visible=!f,window.scene=t.scene},update:function(e,t){if(e.width&&e.height&&(t.hasOwnProperty("width")||t.hasOwnProperty("height"))){var r,i=e.width,s=e.height;e.container.style.width="".concat(i,"px"),e.container.style.height="".concat(s,"px"),[e.renderer,e.postProcessingComposer].concat(oi(e.extraRenderers)).forEach(function(f){return f.setSize(i,s)}),e.camera.aspect=i/s;var o=e.viewOffset.slice(0,2);o.some(function(f){return f})&&(r=e.camera).setViewOffset.apply(r,[i,s].concat(oi(o),[i,s])),e.camera.updateProjectionMatrix()}if(t.hasOwnProperty("viewOffset")){var a,c=e.width,l=e.height,u=e.viewOffset.slice(0,2);u.some(function(f){return f})?(a=e.camera).setViewOffset.apply(a,[c,l].concat(oi(u),[c,l])):e.camera.clearViewOffset()}if(t.hasOwnProperty("skyRadius")&&e.skyRadius&&(e.controls.hasOwnProperty("maxDistance")&&t.skyRadius&&(e.controls.maxDistance=Math.min(e.controls.maxDistance,e.skyRadius)),e.camera.far=e.skyRadius*2.5,e.camera.updateProjectionMatrix(),e.skysphere.geometry=new Xe.SphereGeometry(e.skyRadius)),t.hasOwnProperty("backgroundColor")){var d=Fs(e.backgroundColor).alpha;d===void 0&&(d=1),e.renderer.setClearColor(new Xe.Color(q8(1,e.backgroundColor)),d)}t.hasOwnProperty("backgroundImageUrl")&&(e.backgroundImageUrl?new Xe.TextureLoader().load(e.backgroundImageUrl,function(f){f.colorSpace=Xe.SRGBColorSpace,e.skysphere.material=new Xe.MeshBasicMaterial({map:f,side:Xe.BackSide}),e.skysphere.visible=!0,e.onBackgroundImageLoaded&&setTimeout(e.onBackgroundImageLoaded),!e.loadComplete&&h()}):(e.skysphere.visible=!1,e.skysphere.material.map=null,!e.loadComplete&&h())),t.hasOwnProperty("showNavInfo")&&(e.navInfo.style.display=e.showNavInfo?null:"none"),t.hasOwnProperty("lights")&&((t.lights||[]).forEach(function(f){return e.scene.remove(f)}),e.lights.forEach(function(f){return e.scene.add(f)})),t.hasOwnProperty("objects")&&((t.objects||[]).forEach(function(f){return e.scene.remove(f)}),e.objects.forEach(function(f){return e.scene.add(f)}));function h(){e.loadComplete=e.scene.visible=!0}}});function FV(n,e){e===void 0&&(e={});var t=e.insertAt;if(!(typeof document>"u")){var r=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css",t==="top"&&r.firstChild?r.insertBefore(i,r.firstChild):r.appendChild(i),i.styleSheet?i.styleSheet.cssText=n:i.appendChild(document.createTextNode(n))}}var kV=`.graph-info-msg {
  top: 50%;
  width: 100%;
  text-align: center;
  color: lavender;
  opacity: 0.7;
  font-size: 22px;
  position: absolute;
  font-family: Sans-serif;
}

.scene-container .clickable {
  cursor: pointer;
}

.scene-container .grabbable {
  cursor: move;
  cursor: grab;
  cursor: -moz-grab;
  cursor: -webkit-grab;
}

.scene-container .grabbable:active {
  cursor: grabbing;
  cursor: -moz-grabbing;
  cursor: -webkit-grabbing;
}`;FV(kV);function Qh(n,e){(e==null||e>n.length)&&(e=n.length);for(var t=0,r=Array(e);t<e;t++)r[t]=n[t];return r}function IV(n){if(Array.isArray(n))return Qh(n)}function ya(n,e,t){return(e=GV(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function LV(n){if(typeof Symbol<"u"&&n[Symbol.iterator]!=null||n["@@iterator"]!=null)return Array.from(n)}function OV(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Nx(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(n,i).enumerable})),t.push.apply(t,r)}return t}function lc(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Nx(Object(t),!0).forEach(function(r){ya(n,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):Nx(Object(t)).forEach(function(r){Object.defineProperty(n,r,Object.getOwnPropertyDescriptor(t,r))})}return n}function Ql(n){return IV(n)||LV(n)||$V(n)||OV()}function UV(n,e){if(typeof n!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var r=t.call(n,e);if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function GV(n){var e=UV(n,"string");return typeof e=="symbol"?e:e+""}function $V(n,e){if(n){if(typeof n=="string")return Qh(n,e);var t={}.toString.call(n).slice(8,-1);return t==="Object"&&n.constructor&&(t=n.constructor.name),t==="Map"||t==="Set"?Array.from(n):t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?Qh(n,e):void 0}}function b1(n,e){var t=new e;return t._destructor&&t._destructor(),{linkProp:function(i){return{default:t[i](),onChange:function(o,a){a[n][i](o)},triggerUpdate:!1}},linkMethod:function(i){return function(s){for(var o=s[n],a=arguments.length,c=new Array(a>1?a-1:0),l=1;l<a;l++)c[l-1]=arguments[l];var u=o[i].apply(o,c);return u===o?this:u}}}}var md=window.THREE?window.THREE:{AmbientLight:Yx,DirectionalLight:Xx,REVISION:bl},VV=170,_1=b1("forceGraph",K_),zV=Object.assign.apply(Object,Ql(["jsonUrl","graphData","numDimensions","dagMode","dagLevelDistance","dagNodeFilter","onDagError","nodeRelSize","nodeId","nodeVal","nodeResolution","nodeColor","nodeAutoColorBy","nodeOpacity","nodeVisibility","nodeThreeObject","nodeThreeObjectExtend","nodePositionUpdate","linkSource","linkTarget","linkVisibility","linkColor","linkAutoColorBy","linkOpacity","linkWidth","linkResolution","linkCurvature","linkCurveRotation","linkMaterial","linkThreeObject","linkThreeObjectExtend","linkPositionUpdate","linkDirectionalArrowLength","linkDirectionalArrowColor","linkDirectionalArrowRelPos","linkDirectionalArrowResolution","linkDirectionalParticles","linkDirectionalParticleSpeed","linkDirectionalParticleOffset","linkDirectionalParticleWidth","linkDirectionalParticleColor","linkDirectionalParticleResolution","linkDirectionalParticleThreeObject","forceEngine","d3AlphaDecay","d3VelocityDecay","d3AlphaMin","ngraphPhysics","warmupTicks","cooldownTicks","cooldownTime","onEngineTick","onEngineStop"].map(function(n){return ya({},n,_1.linkProp(n))}))),jV=Object.assign.apply(Object,Ql(["refresh","getGraphBbox","d3Force","d3ReheatSimulation","emitParticle"].map(function(n){return ya({},n,_1.linkMethod(n))}))),Mc=b1("renderObjs",y1),HV=Object.assign.apply(Object,Ql(["width","height","backgroundColor","showNavInfo","enablePointerInteraction"].map(function(n){return ya({},n,Mc.linkProp(n))}))),WV=Object.assign.apply(Object,Ql(["lights","cameraPosition","postProcessingComposer"].map(function(n){return ya({},n,Mc.linkMethod(n))})).concat([{graph2ScreenCoords:Mc.linkMethod("getScreenCoords"),screen2GraphCoords:Mc.linkMethod("getSceneCoords")}])),qV=Cl({props:lc(lc({nodeLabel:{default:"name",triggerUpdate:!1},linkLabel:{default:"name",triggerUpdate:!1},linkHoverPrecision:{default:1,onChange:function(e,t){return t.renderObjs.lineHoverPrecision(e)},triggerUpdate:!1},enableNavigationControls:{default:!0,onChange:function(e,t){var r=t.renderObjs.controls();r&&(r.enabled=e,e&&r.domElement&&r.domElement.dispatchEvent(new PointerEvent("pointerup")))},triggerUpdate:!1},enableNodeDrag:{default:!0,triggerUpdate:!1},onNodeDrag:{default:function(){},triggerUpdate:!1},onNodeDragEnd:{default:function(){},triggerUpdate:!1},onNodeClick:{triggerUpdate:!1},onNodeRightClick:{triggerUpdate:!1},onNodeHover:{triggerUpdate:!1},onLinkClick:{triggerUpdate:!1},onLinkRightClick:{triggerUpdate:!1},onLinkHover:{triggerUpdate:!1},onBackgroundClick:{triggerUpdate:!1},onBackgroundRightClick:{triggerUpdate:!1},showPointerCursor:{default:!0,triggerUpdate:!1}},zV),HV),methods:lc(lc({zoomToFit:function(e,t,r){for(var i,s=arguments.length,o=new Array(s>3?s-3:0),a=3;a<s;a++)o[a-3]=arguments[a];return e.renderObjs.fitToBbox((i=e.forceGraph).getGraphBbox.apply(i,o),t,r),this},pauseAnimation:function(e){return e.animationFrameRequestId!==null&&(cancelAnimationFrame(e.animationFrameRequestId),e.animationFrameRequestId=null),this},resumeAnimation:function(e){return e.animationFrameRequestId===null&&this._animationCycle(),this},_animationCycle:function(e){e.enablePointerInteraction&&(this.renderer().domElement.style.cursor=null),e.forceGraph.tickFrame(),e.renderObjs.tick(),e.animationFrameRequestId=requestAnimationFrame(this._animationCycle)},scene:function(e){return e.renderObjs.scene()},camera:function(e){return e.renderObjs.camera()},renderer:function(e){return e.renderObjs.renderer()},controls:function(e){return e.renderObjs.controls()},tbControls:function(e){return e.renderObjs.tbControls()},_destructor:function(){this.pauseAnimation(),this.graphData({nodes:[],links:[]})}},jV),WV),stateInit:function(e){var t=e.controlType,r=e.rendererConfig,i=e.extraRenderers,s=new K_;return{forceGraph:s,renderObjs:y1({controlType:t,rendererConfig:r,extraRenderers:i}).objects([s]).lights([new md.AmbientLight(13421772,Math.PI),new md.DirectionalLight(16777215,.6*Math.PI)])}},init:function(e,t){e.innerHTML="",e.appendChild(t.container=document.createElement("div")),t.container.style.position="relative";var r=document.createElement("div");t.container.appendChild(r),t.renderObjs(r);var i=t.renderObjs.camera(),s=t.renderObjs.renderer(),o=t.renderObjs.controls();o.enabled=!!t.enableNavigationControls,t.lastSetCameraZ=i.position.z;var a;t.container.appendChild(a=document.createElement("div")),a.className="graph-info-msg",a.textContent="",t.forceGraph.onLoading(function(){a.textContent="Loading..."}).onFinishLoading(function(){a.textContent=""}).onUpdate(function(){t.graphData=t.forceGraph.graphData(),i.position.x===0&&i.position.y===0&&i.position.z===t.lastSetCameraZ&&t.graphData.nodes.length&&(i.lookAt(t.forceGraph.position),t.lastSetCameraZ=i.position.z=Math.cbrt(t.graphData.nodes.length)*VV)}).onFinishUpdate(function(){if(t._dragControls){var c=t.graphData.nodes.find(function(u){return u.__initialFixedPos&&!u.__disposeControlsAfterDrag});c?c.__disposeControlsAfterDrag=!0:t._dragControls.dispose(),t._dragControls=void 0}if(t.enableNodeDrag&&t.enablePointerInteraction&&t.forceEngine==="d3"){var l=t._dragControls=new W3(t.graphData.nodes.map(function(u){return u.__threeObj}).filter(function(u){return u}),i,s.domElement);l.addEventListener("dragstart",function(u){var d=rr(u.object);if(d){o.enabled=!1,u.object.__initialPos=u.object.position.clone(),u.object.__prevPos=u.object.position.clone();var h=d.__data;!h.__initialFixedPos&&(h.__initialFixedPos={fx:h.fx,fy:h.fy,fz:h.fz}),!h.__initialPos&&(h.__initialPos={x:h.x,y:h.y,z:h.z}),["x","y","z"].forEach(function(f){return h["f".concat(f)]=h[f]}),s.domElement.classList.add("grabbable")}}),l.addEventListener("drag",function(u){var d=rr(u.object);if(d){if(!u.object.hasOwnProperty("__graphObjType")){var h=u.object.__initialPos,f=u.object.__prevPos,p=u.object.position;d.position.add(p.clone().sub(f)),f.copy(p),p.copy(h)}var g=d.__data,x=d.position,m={x:x.x-g.x,y:x.y-g.y,z:x.z-g.z};["x","y","z"].forEach(function(y){return g["f".concat(y)]=g[y]=x[y]}),t.forceGraph.d3AlphaTarget(.3).resetCountdown(),g.__dragged=!0,t.onNodeDrag(g,m)}}),l.addEventListener("dragend",function(u){var d=rr(u.object);if(d){delete u.object.__initialPos,delete u.object.__prevPos;var h=d.__data;h.__disposeControlsAfterDrag&&(l.dispose(),delete h.__disposeControlsAfterDrag);var f=h.__initialFixedPos,p=h.__initialPos,g={x:p.x-h.x,y:p.y-h.y,z:p.z-h.z};if(f&&(["x","y","z"].forEach(function(m){var y="f".concat(m);f[y]===void 0&&delete h[y]}),delete h.__initialFixedPos,delete h.__initialPos,h.__dragged&&(delete h.__dragged,t.onNodeDragEnd(h,g))),t.forceGraph.d3AlphaTarget(0).resetCountdown(),t.enableNavigationControls){var x;o.enabled=!0,o._status&&((x=o._onPointerCancel)===null||x===void 0||x.call(o)),o.domElement&&o.domElement.ownerDocument&&o.domElement.ownerDocument.dispatchEvent(new PointerEvent("pointerup",{pointerType:"touch"}))}s.domElement.classList.remove("grabbable")}})}}),md.REVISION<155&&(t.renderObjs.renderer().useLegacyLights=!1),t.renderObjs.hoverOrderComparator(function(c,l){var u=rr(c);if(!u)return 1;var d=rr(l);if(!d)return-1;var h=function(p){return p.__graphObjType==="node"};return h(d)-h(u)}).tooltipContent(function(c){var l=rr(c);return l&&Ee(t["".concat(l.__graphObjType,"Label")])(l.__data)||""}).hoverDuringDrag(!1).onHover(function(c){var l=rr(c);if(l!==t.hoverObj){var u=t.hoverObj?t.hoverObj.__graphObjType:null,d=t.hoverObj?t.hoverObj.__data:null,h=l?l.__graphObjType:null,f=l?l.__data:null;if(u&&u!==h){var p=t["on".concat(u==="node"?"Node":"Link","Hover")];p&&p(null,d)}if(h){var g=t["on".concat(h==="node"?"Node":"Link","Hover")];g&&g(f,u===h?d:null)}s.domElement.classList[(l&&t["on".concat(h==="node"?"Node":"Link","Click")]||!l&&t.onBackgroundClick)&&Ee(t.showPointerCursor)(f)?"add":"remove"]("clickable"),t.hoverObj=l}}).clickAfterDrag(!1).onClick(function(c,l){var u=rr(c);if(u){var d=t["on".concat(u.__graphObjType==="node"?"Node":"Link","Click")];d&&d(u.__data,l)}else t.onBackgroundClick&&t.onBackgroundClick(l)}).onRightClick(function(c,l){var u=rr(c);if(u){var d=t["on".concat(u.__graphObjType==="node"?"Node":"Link","RightClick")];d&&d(u.__data,l)}else t.onBackgroundRightClick&&t.onBackgroundRightClick(l)}),this._animationCycle()}});function rr(n){for(var e=n;e&&!e.hasOwnProperty("__graphObjType");)e=e.parent;return e}var xd={exports:{}},yd,Ex;function XV(){if(Ex)return yd;Ex=1;var n="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED";return yd=n,yd}var bd,Ax;function YV(){if(Ax)return bd;Ax=1;var n=XV();function e(){}function t(){}return t.resetWarningCache=e,bd=function(){function r(o,a,c,l,u,d){if(d!==n){var h=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw h.name="Invariant Violation",h}}r.isRequired=r;function i(){return r}var s={array:r,bigint:r,bool:r,func:r,number:r,object:r,string:r,symbol:r,any:r,arrayOf:i,element:r,elementType:r,instanceOf:i,node:r,objectOf:i,oneOf:i,oneOfType:i,shape:i,exact:i,checkPropTypes:t,resetWarningCache:e};return s.PropTypes=s,s},bd}var Rx;function KV(){return Rx||(Rx=1,xd.exports=YV()()),xd.exports}var QV=KV();const I=$x(QV),Zl={width:I.number,height:I.number,graphData:I.shape({nodes:I.arrayOf(I.object).isRequired,links:I.arrayOf(I.object).isRequired}),backgroundColor:I.string,nodeRelSize:I.number,nodeId:I.string,nodeLabel:I.oneOfType([I.string,I.func]),nodeVal:I.oneOfType([I.number,I.string,I.func]),nodeVisibility:I.oneOfType([I.bool,I.string,I.func]),nodeColor:I.oneOfType([I.string,I.func]),nodeAutoColorBy:I.oneOfType([I.string,I.func]),onNodeHover:I.func,onNodeClick:I.func,linkSource:I.string,linkTarget:I.string,linkLabel:I.oneOfType([I.string,I.func]),linkVisibility:I.oneOfType([I.bool,I.string,I.func]),linkColor:I.oneOfType([I.string,I.func]),linkAutoColorBy:I.oneOfType([I.string,I.func]),linkWidth:I.oneOfType([I.number,I.string,I.func]),linkCurvature:I.oneOfType([I.number,I.string,I.func]),linkDirectionalArrowLength:I.oneOfType([I.number,I.string,I.func]),linkDirectionalArrowColor:I.oneOfType([I.string,I.func]),linkDirectionalArrowRelPos:I.oneOfType([I.number,I.string,I.func]),linkDirectionalParticles:I.oneOfType([I.number,I.string,I.func]),linkDirectionalParticleSpeed:I.oneOfType([I.number,I.string,I.func]),linkDirectionalParticleOffset:I.oneOfType([I.number,I.string,I.func]),linkDirectionalParticleWidth:I.oneOfType([I.number,I.string,I.func]),linkDirectionalParticleColor:I.oneOfType([I.string,I.func]),onLinkHover:I.func,onLinkClick:I.func,dagMode:I.oneOf(["td","bu","lr","rl","zin","zout","radialin","radialout"]),dagLevelDistance:I.number,dagNodeFilter:I.func,onDagError:I.func,d3AlphaMin:I.number,d3AlphaDecay:I.number,d3VelocityDecay:I.number,warmupTicks:I.number,cooldownTicks:I.number,cooldownTime:I.number,onEngineTick:I.func,onEngineStop:I.func,getGraphBbox:I.func},v1={zoomToFit:I.func,onNodeRightClick:I.func,onNodeDrag:I.func,onNodeDragEnd:I.func,onLinkRightClick:I.func,linkHoverPrecision:I.number,onBackgroundClick:I.func,onBackgroundRightClick:I.func,showPointerCursor:I.oneOfType([I.bool,I.func]),enablePointerInteraction:I.bool,enableNodeDrag:I.bool},Np={showNavInfo:I.bool,nodeOpacity:I.number,nodeResolution:I.number,nodeThreeObject:I.oneOfType([I.object,I.string,I.func]),nodeThreeObjectExtend:I.oneOfType([I.bool,I.string,I.func]),nodePositionUpdate:I.func,linkOpacity:I.number,linkResolution:I.number,linkCurveRotation:I.oneOfType([I.number,I.string,I.func]),linkMaterial:I.oneOfType([I.object,I.string,I.func]),linkThreeObject:I.oneOfType([I.object,I.string,I.func]),linkThreeObjectExtend:I.oneOfType([I.bool,I.string,I.func]),linkPositionUpdate:I.func,linkDirectionalArrowResolution:I.number,linkDirectionalParticleResolution:I.number,linkDirectionalParticleThreeObject:I.oneOfType([I.object,I.string,I.func]),forceEngine:I.oneOf(["d3","ngraph"]),ngraphPhysics:I.object,numDimensions:I.oneOf([1,2,3])};Object.assign({},Zl,v1,{linkLineDash:I.oneOfType([I.arrayOf(I.number),I.string,I.func]),nodeCanvasObjectMode:I.oneOfType([I.string,I.func]),nodeCanvasObject:I.func,nodePointerAreaPaint:I.func,linkCanvasObjectMode:I.oneOfType([I.string,I.func]),linkCanvasObject:I.func,linkPointerAreaPaint:I.func,linkDirectionalParticleCanvasObject:I.func,autoPauseRedraw:I.bool,minZoom:I.number,maxZoom:I.number,enableZoomInteraction:I.oneOfType([I.bool,I.func]),enablePanInteraction:I.oneOfType([I.bool,I.func]),onZoom:I.func,onZoomEnd:I.func,onRenderFramePre:I.func,onRenderFramePost:I.func});const ZV=Object.assign({},Zl,v1,Np,{enableNavigationControls:I.bool,controlType:I.oneOf(["trackball","orbit","fly"]),rendererConfig:I.object,extraRenderers:I.arrayOf(I.shape({render:I.func.isRequired}))});Object.assign({},Zl,Np,{nodeDesc:I.oneOfType([I.string,I.func]),linkDesc:I.oneOfType([I.string,I.func])});Object.assign({},Zl,Np,{markerAttrs:I.object,yOffset:I.number,glScale:I.number});const Ep=H3(qV,{methodNames:["emitParticle","d3Force","d3ReheatSimulation","stopAnimation","pauseAnimation","resumeAnimation","cameraPosition","zoomToFit","getGraphBbox","screen2GraphCoords","graph2ScreenCoords","postProcessingComposer","lights","scene","camera","renderer","controls","refresh"],initPropNames:["controlType","rendererConfig","extraRenderers"]});Ep.displayName="ForceGraph3D";Ep.propTypes=ZV;const JV=()=>{const[n,e]=D.useState({nodes:[],links:[]}),[t,r]=D.useState(!1),i=D.useRef(),s=D.useRef(0);D.useEffect(()=>{const a=async()=>{try{const u=await(await fetch("/api/galaxy")).json();u.simulation&&r(!0),u&&u.nodes&&e(u)}catch(l){console.error("Failed to fetch galaxy data:",l)}};a();const c=setInterval(a,1e4);return()=>clearInterval(c)},[]),D.useEffect(()=>{const a=()=>{if(i.current){s.current+=.003;const c=s.current,l=800;i.current.cameraPosition({x:l*Math.sin(c),z:l*Math.cos(c)})}requestAnimationFrame(a)};a()},[]);const o=a=>{switch(a.group){case"start":return"#ef4444";case"core":return"#ffffff";case"sector":return"#f59e0b";case"agent":return"#00f3ff";case"knowledge":return"#a855f7";default:return"#64748b"}};return b.jsxs("div",{className:"w-full h-full relative bg-black/50 rounded overflow-hidden cursor-move",children:[b.jsxs("div",{className:"absolute top-4 left-4 z-10 pointer-events-none",children:[b.jsxs("div",{className:"flex items-center gap-2",children:[b.jsx(yr,{size:20,className:"text-[var(--hud-accent)]"}),b.jsx("h2",{className:"text-lg font-bold text-white tracking-widest",children:"NEURAL LATTICE_"})]}),t&&b.jsxs("div",{className:"inline-flex items-center gap-2 bg-[rgba(255,165,0,0.1)] border border-orange-500/50 px-2 py-1 rounded mt-1",children:[b.jsx(ky,{size:12,className:"text-orange-500 animate-pulse"}),b.jsx("span",{className:"text-[10px] text-orange-400 font-mono",children:"SIMULATION MODE"})]})]}),n.nodes.length===0&&b.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:b.jsx("span",{className:"text-[var(--hud-text-dim)] font-mono animate-pulse",children:"ESTABLISHING UPLINK..."})}),n.nodes.length>0&&b.jsx(Ep,{ref:i,graphData:n,nodeLabel:"name",nodeColor:o,nodeVal:a=>a.val||5,nodeResolution:16,linkColor:()=>"rgba(0, 243, 255, 0.15)",linkWidth:1,linkDirectionalParticles:2,linkDirectionalParticleSpeed:.005,linkDirectionalParticleWidth:2,linkDirectionalParticleColor:()=>"#00f3ff",backgroundColor:"rgba(0,0,0,0)",showNavInfo:!1,bloomStrength:1.5,enableNodeDrag:!1,onNodeClick:a=>{const l=1+100/Math.hypot(a.x,a.y,a.z);i.current&&i.current.cameraPosition({x:a.x*l,y:a.y*l,z:a.z*l},a,3e3)}}),b.jsx("div",{className:"absolute bottom-4 left-4 z-10 pointer-events-none bg-black/60 backdrop-blur p-2 rounded border border-white/10",children:b.jsxs("div",{className:"flex flex-col gap-1 text-[10px] font-mono text-[var(--hud-text-dim)]",children:[b.jsxs("div",{className:"flex items-center gap-2",children:[b.jsx("span",{className:"w-2 h-2 rounded-full bg-[#00f3ff] shadow-[0_0_5px_#00f3ff]"})," AGENT NODE"]}),b.jsxs("div",{className:"flex items-center gap-2",children:[b.jsx("span",{className:"w-2 h-2 rounded-full bg-[#a855f7] shadow-[0_0_5px_#a855f7]"})," KNOWLEDGE"]}),b.jsxs("div",{className:"flex items-center gap-2",children:[b.jsx("span",{className:"w-2 h-2 rounded-full bg-[#f59e0b] shadow-[0_0_5px_#f59e0b]"})," SECTOR HUB"]})]})})]})},T1=D.createContext(null),ez=({children:n})=>{const[e,t]=D.useState(null),[r,i]=D.useState(null),[s,o]=D.useState(!0);D.useEffect(()=>{const l=localStorage.getItem("agentcache_token"),u=localStorage.getItem("agentcache_user");l&&u&&(i(l),t(JSON.parse(u))),o(!1)},[]);const a=async l=>{try{const u=await fetch("/api/auth/dev-login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:l})});if(!u.ok)throw new Error("Login failed");const d=await u.json();return i(d.token),t(d.user),localStorage.setItem("agentcache_token",d.token),localStorage.setItem("agentcache_user",JSON.stringify(d.user)),!0}catch(u){return console.error(u),!1}},c=()=>{i(null),t(null),localStorage.removeItem("agentcache_token"),localStorage.removeItem("agentcache_user")};return b.jsx(T1.Provider,{value:{user:e,token:r,login:a,logout:c,loading:s},children:n})},js=()=>D.useContext(T1);function tz(){const{token:n}=js(),[e,t]=D.useState([]),[r,i]=D.useState([]),[s,o]=D.useState(null);return D.useEffect(()=>{if(!n)return;const a=async()=>{try{const h=await(await fetch("/api/admin-stats",{headers:{Authorization:`Bearer ${n}`}})).json();if(h&&h.top_users){const f=h.top_users.map((p,g)=>({rank:g+1,name:p.email.split("@")[0]||"Unknown Agent",score:p.requests,sector:"General"}));t(f)}else t([{rank:1,name:"System-Prime",score:1e3,sector:"Core"}])}catch(d){console.error("Failed to fetch leaderboard:",d)}};a();const c=setInterval(a,6e4),l=new EventSource("/api/events/stream");l.onmessage=d=>{const h=JSON.parse(d.data);if(h.type!=="sys:connected"&&(h.type==="CACHE_HIT"||h.type==="OPTIMIZATION"||Math.random()>.7)){const f={id:Date.now(),agent:h.agentId||"Swarm-Node",pattern:h.type==="CACHE_HIT"?"Pattern Match":"Optimization Found",improvement:Math.floor(Math.random()*20)+5,time:new Date().toLocaleTimeString()};i(p=>[f,...p].slice(0,8))}},o({status:"Running Experiment #8492",progress:45,target:"Global Latency Optimization"});const u=setInterval(()=>{o(d=>({...d,progress:d.progress>=100?0:d.progress+1}))},1e3);return()=>{clearInterval(c),clearInterval(u),l.close()}},[]),b.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-8rem)]",children:[b.jsx("div",{className:"space-y-6",children:b.jsx(Le,{title:"Live Discoveries",icon:ky,className:"h-full flex flex-col",children:b.jsxs("div",{className:"flex-1 overflow-y-auto pr-2 space-y-3 custom-scrollbar",children:[r.map(a=>b.jsxs("div",{className:"p-3 rounded bg-[rgba(255,255,255,0.03)] border-l-2 border-[var(--hud-accent)] animate-in slide-in-from-left duration-300",children:[b.jsxs("div",{className:"flex justify-between items-start mb-1",children:[b.jsx("span",{className:"text-sm font-bold text-white",children:a.agent}),b.jsx("span",{className:"text-[10px] font-mono text-[var(--hud-text-dim)]",children:a.time})]}),b.jsxs("div",{className:"text-xs text-[var(--hud-text-dim)] mb-2",children:["Found: ",b.jsx("span",{className:"text-white",children:a.pattern})]}),b.jsxs("div",{className:"flex items-center gap-1 text-xs font-mono text-[var(--hud-success)]",children:[b.jsx(Ly,{size:12}),b.jsxs("span",{children:["+",a.improvement,"% Efficiency"]})]})]},a.id)),r.length===0&&b.jsx("div",{className:"text-center text-[var(--hud-text-dim)] py-8 italic",children:"Listening for swarm signals..."})]})})}),b.jsx("div",{className:"lg:col-span-1 flex flex-col gap-6 relative",children:b.jsxs(Le,{className:"flex-1 relative overflow-hidden p-0 border-[var(--hud-accent)] shadow-[0_0_30px_rgba(0,243,255,0.1)]",children:[b.jsx(JV,{}),b.jsxs("div",{className:"absolute bottom-0 left-0 right-0 bg-[rgba(0,0,0,0.8)] backdrop-blur p-4 border-t border-[var(--hud-border)] pointer-events-none",children:[b.jsxs("div",{className:"flex justify-between items-center mb-2",children:[b.jsx("span",{className:"text-xs font-bold text-[var(--hud-text-dim)]",children:"ACTIVE EXPERIMENT"}),b.jsx("span",{className:"text-xs font-mono text-[var(--hud-accent)] animate-pulse",children:"RUNNING"})]}),b.jsx("div",{className:"text-sm font-medium text-white mb-3",children:s?.target}),b.jsx("div",{className:"h-1 bg-[rgba(255,255,255,0.1)] rounded-full overflow-hidden",children:b.jsx("div",{className:"h-full bg-[var(--hud-accent)] transition-all duration-300",style:{width:`${s?.progress}%`}})})]})]})}),b.jsx("div",{className:"space-y-6",children:b.jsx(Le,{title:"Top Agents",icon:AN,className:"h-full",children:b.jsx(Uc,{columns:[{header:"Rank",accessor:"rank",render:a=>b.jsxs("span",{className:"font-mono text-[var(--hud-accent)]",children:["#",a.rank]})},{header:"Agent Name",accessor:"name",render:a=>b.jsx("span",{className:"font-bold text-white",children:a.name})},{header:"Score",accessor:"score",render:a=>b.jsx("span",{className:"font-mono text-[var(--hud-warning)]",children:a.score})}],data:e})})})]})}function nz(n){return n}var rz=4,Cx=1e-6;function iz(n){return"translate(0,"+n+")"}function sz(n){return e=>+n(e)}function oz(n,e){return e=Math.max(0,n.bandwidth()-e*2)/2,n.round()&&(e=Math.round(e)),t=>+n(t)+e}function az(){return!this.__axis}function cz(n,e){var t=[],r=null,i=null,s=6,o=6,a=3,c=typeof window<"u"&&window.devicePixelRatio>1?0:.5,l=-1,u="x",d=iz;function h(f){var p=r??(e.ticks?e.ticks.apply(e,t):e.domain()),g=i??(e.tickFormat?e.tickFormat.apply(e,t):nz),x=Math.max(s,0)+a,m=e.range(),y=+m[0]+c,_=+m[m.length-1]+c,v=(e.bandwidth?oz:sz)(e.copy(),c),T=f.selection?f.selection():f,w=T.selectAll(".domain").data([null]),N=T.selectAll(".tick").data(p,e).order(),E=N.exit(),A=N.enter().append("g").attr("class","tick"),B=N.select("line"),R=N.select("text");w=w.merge(w.enter().insert("path",".tick").attr("class","domain").attr("stroke","currentColor")),N=N.merge(A),B=B.merge(A.append("line").attr("stroke","currentColor").attr(u+"2",l*s)),R=R.merge(A.append("text").attr("fill","currentColor").attr(u,l*x).attr("dy","0.32em")),f!==T&&(w=w.transition(f),N=N.transition(f),B=B.transition(f),R=R.transition(f),E=E.transition(f).attr("opacity",Cx).attr("transform",function(L){return isFinite(L=v(L))?d(L+c):this.getAttribute("transform")}),A.attr("opacity",Cx).attr("transform",function(L){var F=this.parentNode.__axis;return d((F&&isFinite(F=F(L))?F:v(L))+c)})),E.remove(),w.attr("d",o?"M"+l*o+","+y+"H"+c+"V"+_+"H"+l*o:"M"+c+","+y+"V"+_),N.attr("opacity",1).attr("transform",function(L){return d(v(L)+c)}),B.attr(u+"2",l*s),R.attr(u,l*x).text(g),T.filter(az).attr("fill","none").attr("font-size",10).attr("font-family","sans-serif").attr("text-anchor","end"),T.each(function(){this.__axis=v})}return h.scale=function(f){return arguments.length?(e=f,h):e},h.ticks=function(){return t=Array.from(arguments),h},h.tickArguments=function(f){return arguments.length?(t=f==null?[]:Array.from(f),h):t.slice()},h.tickValues=function(f){return arguments.length?(r=f==null?null:Array.from(f),h):r&&r.slice()},h.tickFormat=function(f){return arguments.length?(i=f,h):i},h.tickSize=function(f){return arguments.length?(s=o=+f,h):s},h.tickSizeInner=function(f){return arguments.length?(s=+f,h):s},h.tickSizeOuter=function(f){return arguments.length?(o=+f,h):o},h.tickPadding=function(f){return arguments.length?(a=+f,h):a},h.offset=function(f){return arguments.length?(c=+f,h):c},h}function lz(n){return cz(rz,n)}var Mx=Math.abs,_d=Math.cos,vd=Math.sin,w1=Math.PI,uc=w1/2,Px=w1*2,Dx=Math.max,Td=1e-12;function Bx(n,e){return Array.from({length:e-n},(t,r)=>n+r)}function uz(n){return function(e,t){return n(e.source.value+e.target.value,t.source.value+t.target.value)}}function dz(){return hz(!1)}function hz(n,e){var t=0,r=null,i=null,s=null;function o(a){var c=a.length,l=new Array(c),u=Bx(0,c),d=new Array(c*c),h=new Array(c),f=0,p;a=Float64Array.from({length:c*c},(g,x)=>a[x/c|0][x%c]);for(let g=0;g<c;++g){let x=0;for(let m=0;m<c;++m)x+=a[g*c+m]+n*a[m*c+g];f+=l[g]=x}f=Dx(0,Px-t*c)/f,p=f?t:Px/c;{let g=0;r&&u.sort((x,m)=>r(l[x],l[m]));for(const x of u){const m=g;{const y=Bx(0,c).filter(_=>a[x*c+_]||a[_*c+x]);i&&y.sort((_,v)=>i(a[x*c+_],a[x*c+v]));for(const _ of y){let v;if(x<_?(v=d[x*c+_]||(d[x*c+_]={source:null,target:null}),v.source={index:x,startAngle:g,endAngle:g+=a[x*c+_]*f,value:a[x*c+_]}):(v=d[_*c+x]||(d[_*c+x]={source:null,target:null}),v.target={index:x,startAngle:g,endAngle:g+=a[x*c+_]*f,value:a[x*c+_]},x===_&&(v.source=v.target)),v.source&&v.target&&v.source.value<v.target.value){const T=v.source;v.source=v.target,v.target=T}}h[x]={index:x,startAngle:m,endAngle:g,value:l[x]}}g+=p}}return d=Object.values(d),d.groups=h,s?d.sort(s):d}return o.padAngle=function(a){return arguments.length?(t=Dx(0,a),o):t},o.sortGroups=function(a){return arguments.length?(r=a,o):r},o.sortSubgroups=function(a){return arguments.length?(i=a,o):i},o.sortChords=function(a){return arguments.length?(a==null?s=null:(s=uz(a))._=a,o):s&&s._},o}const Zh=Math.PI,Jh=2*Zh,di=1e-6,fz=Jh-di;function S1(n){this._+=n[0];for(let e=1,t=n.length;e<t;++e)this._+=arguments[e]+n[e]}function pz(n){let e=Math.floor(n);if(!(e>=0))throw new Error(`invalid digits: ${n}`);if(e>15)return S1;const t=10**e;return function(r){this._+=r[0];for(let i=1,s=r.length;i<s;++i)this._+=Math.round(arguments[i]*t)/t+r[i]}}class Ap{constructor(e){this._x0=this._y0=this._x1=this._y1=null,this._="",this._append=e==null?S1:pz(e)}moveTo(e,t){this._append`M${this._x0=this._x1=+e},${this._y0=this._y1=+t}`}closePath(){this._x1!==null&&(this._x1=this._x0,this._y1=this._y0,this._append`Z`)}lineTo(e,t){this._append`L${this._x1=+e},${this._y1=+t}`}quadraticCurveTo(e,t,r,i){this._append`Q${+e},${+t},${this._x1=+r},${this._y1=+i}`}bezierCurveTo(e,t,r,i,s,o){this._append`C${+e},${+t},${+r},${+i},${this._x1=+s},${this._y1=+o}`}arcTo(e,t,r,i,s){if(e=+e,t=+t,r=+r,i=+i,s=+s,s<0)throw new Error(`negative radius: ${s}`);let o=this._x1,a=this._y1,c=r-e,l=i-t,u=o-e,d=a-t,h=u*u+d*d;if(this._x1===null)this._append`M${this._x1=e},${this._y1=t}`;else if(h>di)if(!(Math.abs(d*c-l*u)>di)||!s)this._append`L${this._x1=e},${this._y1=t}`;else{let f=r-o,p=i-a,g=c*c+l*l,x=f*f+p*p,m=Math.sqrt(g),y=Math.sqrt(h),_=s*Math.tan((Zh-Math.acos((g+h-x)/(2*m*y)))/2),v=_/y,T=_/m;Math.abs(v-1)>di&&this._append`L${e+v*u},${t+v*d}`,this._append`A${s},${s},0,0,${+(d*f>u*p)},${this._x1=e+T*c},${this._y1=t+T*l}`}}arc(e,t,r,i,s,o){if(e=+e,t=+t,r=+r,o=!!o,r<0)throw new Error(`negative radius: ${r}`);let a=r*Math.cos(i),c=r*Math.sin(i),l=e+a,u=t+c,d=1^o,h=o?i-s:s-i;this._x1===null?this._append`M${l},${u}`:(Math.abs(this._x1-l)>di||Math.abs(this._y1-u)>di)&&this._append`L${l},${u}`,r&&(h<0&&(h=h%Jh+Jh),h>fz?this._append`A${r},${r},0,1,${d},${e-a},${t-c}A${r},${r},0,1,${d},${this._x1=l},${this._y1=u}`:h>di&&this._append`A${r},${r},0,${+(h>=Zh)},${d},${this._x1=e+r*Math.cos(s)},${this._y1=t+r*Math.sin(s)}`)}rect(e,t,r,i){this._append`M${this._x0=this._x1=+e},${this._y0=this._y1=+t}h${r=+r}v${+i}h${-r}Z`}toString(){return this._}}function N1(){return new Ap}N1.prototype=Ap.prototype;var gz=Array.prototype.slice;function ns(n){return function(){return n}}function mz(n){return n.source}function xz(n){return n.target}function Fx(n){return n.radius}function yz(n){return n.startAngle}function bz(n){return n.endAngle}function _z(){return 0}function vz(n){var e=mz,t=xz,r=Fx,i=Fx,s=yz,o=bz,a=_z,c=null;function l(){var u,d=e.apply(this,arguments),h=t.apply(this,arguments),f=a.apply(this,arguments)/2,p=gz.call(arguments),g=+r.apply(this,(p[0]=d,p)),x=s.apply(this,p)-uc,m=o.apply(this,p)-uc,y=+i.apply(this,(p[0]=h,p)),_=s.apply(this,p)-uc,v=o.apply(this,p)-uc;if(c||(c=u=N1()),f>Td&&(Mx(m-x)>f*2+Td?m>x?(x+=f,m-=f):(x-=f,m+=f):x=m=(x+m)/2,Mx(v-_)>f*2+Td?v>_?(_+=f,v-=f):(_-=f,v+=f):_=v=(_+v)/2),c.moveTo(g*_d(x),g*vd(x)),c.arc(0,0,g,x,m),(x!==_||m!==v)&&(c.quadraticCurveTo(0,0,y*_d(_),y*vd(_)),c.arc(0,0,y,_,v)),c.quadraticCurveTo(0,0,g*_d(x),g*vd(x)),c.closePath(),u)return c=null,u+""||null}return l.radius=function(u){return arguments.length?(r=i=typeof u=="function"?u:ns(+u),l):r},l.sourceRadius=function(u){return arguments.length?(r=typeof u=="function"?u:ns(+u),l):r},l.targetRadius=function(u){return arguments.length?(i=typeof u=="function"?u:ns(+u),l):i},l.startAngle=function(u){return arguments.length?(s=typeof u=="function"?u:ns(+u),l):s},l.endAngle=function(u){return arguments.length?(o=typeof u=="function"?u:ns(+u),l):o},l.padAngle=function(u){return arguments.length?(a=typeof u=="function"?u:ns(+u),l):a},l.source=function(u){return arguments.length?(e=u,l):e},l.target=function(u){return arguments.length?(t=u,l):t},l.context=function(u){return arguments.length?(c=u??null,l):c},l}function Tz(){return vz()}function Gt(n){return function(){return n}}const kx=Math.abs,Et=Math.atan2,ai=Math.cos,wz=Math.max,wd=Math.min,Fn=Math.sin,ls=Math.sqrt,Ut=1e-12,ia=Math.PI,gl=ia/2,Sz=2*ia;function Nz(n){return n>1?0:n<-1?ia:Math.acos(n)}function Ix(n){return n>=1?gl:n<=-1?-gl:Math.asin(n)}function E1(n){let e=3;return n.digits=function(t){if(!arguments.length)return e;if(t==null)e=null;else{const r=Math.floor(t);if(!(r>=0))throw new RangeError(`invalid digits: ${t}`);e=r}return n},()=>new Ap(e)}function Ez(n){return n.innerRadius}function Az(n){return n.outerRadius}function Rz(n){return n.startAngle}function Cz(n){return n.endAngle}function Mz(n){return n&&n.padAngle}function Pz(n,e,t,r,i,s,o,a){var c=t-n,l=r-e,u=o-i,d=a-s,h=d*c-u*l;if(!(h*h<Ut))return h=(u*(e-s)-d*(n-i))/h,[n+h*c,e+h*l]}function dc(n,e,t,r,i,s,o){var a=n-t,c=e-r,l=(o?s:-s)/ls(a*a+c*c),u=l*c,d=-l*a,h=n+u,f=e+d,p=t+u,g=r+d,x=(h+p)/2,m=(f+g)/2,y=p-h,_=g-f,v=y*y+_*_,T=i-s,w=h*g-p*f,N=(_<0?-1:1)*ls(wz(0,T*T*v-w*w)),E=(w*_-y*N)/v,A=(-w*y-_*N)/v,B=(w*_+y*N)/v,R=(-w*y+_*N)/v,L=E-x,F=A-m,S=B-x,U=R-m;return L*L+F*F>S*S+U*U&&(E=B,A=R),{cx:E,cy:A,x01:-u,y01:-d,x11:E*(i/T-1),y11:A*(i/T-1)}}function Dz(){var n=Ez,e=Az,t=Gt(0),r=null,i=Rz,s=Cz,o=Mz,a=null,c=E1(l);function l(){var u,d,h=+n.apply(this,arguments),f=+e.apply(this,arguments),p=i.apply(this,arguments)-gl,g=s.apply(this,arguments)-gl,x=kx(g-p),m=g>p;if(a||(a=u=c()),f<h&&(d=f,f=h,h=d),!(f>Ut))a.moveTo(0,0);else if(x>Sz-Ut)a.moveTo(f*ai(p),f*Fn(p)),a.arc(0,0,f,p,g,!m),h>Ut&&(a.moveTo(h*ai(g),h*Fn(g)),a.arc(0,0,h,g,p,m));else{var y=p,_=g,v=p,T=g,w=x,N=x,E=o.apply(this,arguments)/2,A=E>Ut&&(r?+r.apply(this,arguments):ls(h*h+f*f)),B=wd(kx(f-h)/2,+t.apply(this,arguments)),R=B,L=B,F,S;if(A>Ut){var U=Ix(A/h*Fn(E)),k=Ix(A/f*Fn(E));(w-=U*2)>Ut?(U*=m?1:-1,v+=U,T-=U):(w=0,v=T=(p+g)/2),(N-=k*2)>Ut?(k*=m?1:-1,y+=k,_-=k):(N=0,y=_=(p+g)/2)}var P=f*ai(y),$=f*Fn(y),M=h*ai(T),W=h*Fn(T);if(B>Ut){var G=f*ai(_),z=f*Fn(_),Z=h*ai(v),ee=h*Fn(v),O;if(x<ia)if(O=Pz(P,$,Z,ee,G,z,M,W)){var Y=P-O[0],te=$-O[1],ae=G-O[0],me=z-O[1],ge=1/Fn(Nz((Y*ae+te*me)/(ls(Y*Y+te*te)*ls(ae*ae+me*me)))/2),Se=ls(O[0]*O[0]+O[1]*O[1]);R=wd(B,(h-Se)/(ge-1)),L=wd(B,(f-Se)/(ge+1))}else R=L=0}N>Ut?L>Ut?(F=dc(Z,ee,P,$,f,L,m),S=dc(G,z,M,W,f,L,m),a.moveTo(F.cx+F.x01,F.cy+F.y01),L<B?a.arc(F.cx,F.cy,L,Et(F.y01,F.x01),Et(S.y01,S.x01),!m):(a.arc(F.cx,F.cy,L,Et(F.y01,F.x01),Et(F.y11,F.x11),!m),a.arc(0,0,f,Et(F.cy+F.y11,F.cx+F.x11),Et(S.cy+S.y11,S.cx+S.x11),!m),a.arc(S.cx,S.cy,L,Et(S.y11,S.x11),Et(S.y01,S.x01),!m))):(a.moveTo(P,$),a.arc(0,0,f,y,_,!m)):a.moveTo(P,$),!(h>Ut)||!(w>Ut)?a.lineTo(M,W):R>Ut?(F=dc(M,W,G,z,h,-R,m),S=dc(P,$,Z,ee,h,-R,m),a.lineTo(F.cx+F.x01,F.cy+F.y01),R<B?a.arc(F.cx,F.cy,R,Et(F.y01,F.x01),Et(S.y01,S.x01),!m):(a.arc(F.cx,F.cy,R,Et(F.y01,F.x01),Et(F.y11,F.x11),!m),a.arc(0,0,h,Et(F.cy+F.y11,F.cx+F.x11),Et(S.cy+S.y11,S.cx+S.x11),m),a.arc(S.cx,S.cy,R,Et(S.y11,S.x11),Et(S.y01,S.x01),!m))):a.arc(0,0,h,T,v,m)}if(a.closePath(),u)return a=null,u+""||null}return l.centroid=function(){var u=(+n.apply(this,arguments)+ +e.apply(this,arguments))/2,d=(+i.apply(this,arguments)+ +s.apply(this,arguments))/2-ia/2;return[ai(d)*u,Fn(d)*u]},l.innerRadius=function(u){return arguments.length?(n=typeof u=="function"?u:Gt(+u),l):n},l.outerRadius=function(u){return arguments.length?(e=typeof u=="function"?u:Gt(+u),l):e},l.cornerRadius=function(u){return arguments.length?(t=typeof u=="function"?u:Gt(+u),l):t},l.padRadius=function(u){return arguments.length?(r=u==null?null:typeof u=="function"?u:Gt(+u),l):r},l.startAngle=function(u){return arguments.length?(i=typeof u=="function"?u:Gt(+u),l):i},l.endAngle=function(u){return arguments.length?(s=typeof u=="function"?u:Gt(+u),l):s},l.padAngle=function(u){return arguments.length?(o=typeof u=="function"?u:Gt(+u),l):o},l.context=function(u){return arguments.length?(a=u??null,l):a},l}function Bz(n){return typeof n=="object"&&"length"in n?n:Array.from(n)}function A1(n){this._context=n}A1.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){(this._line||this._line!==0&&this._point===1)&&this._context.closePath(),this._line=1-this._line},point:function(n,e){switch(n=+n,e=+e,this._point){case 0:this._point=1,this._line?this._context.lineTo(n,e):this._context.moveTo(n,e);break;case 1:this._point=2;default:this._context.lineTo(n,e);break}}};function Fz(n){return new A1(n)}function kz(n){return n[0]}function Iz(n){return n[1]}function Lz(n,e){var t=Gt(!0),r=null,i=Fz,s=null,o=E1(a);n=typeof n=="function"?n:n===void 0?kz:Gt(n),e=typeof e=="function"?e:e===void 0?Iz:Gt(e);function a(c){var l,u=(c=Bz(c)).length,d,h=!1,f;for(r==null&&(s=i(f=o())),l=0;l<=u;++l)!(l<u&&t(d=c[l],l,c))===h&&((h=!h)?s.lineStart():s.lineEnd()),h&&s.point(+n(d,l,c),+e(d,l,c));if(f)return s=null,f+""||null}return a.x=function(c){return arguments.length?(n=typeof c=="function"?c:Gt(+c),a):n},a.y=function(c){return arguments.length?(e=typeof c=="function"?c:Gt(+c),a):e},a.defined=function(c){return arguments.length?(t=typeof c=="function"?c:Gt(!!c),a):t},a.curve=function(c){return arguments.length?(i=c,r!=null&&(s=i(r)),a):i},a.context=function(c){return arguments.length?(c==null?r=s=null:s=i(r=c),a):r},a}const Oz=({matrix:n,agents:e})=>{const t=D.useRef(null),[r,i]=D.useState({width:0,height:0});return D.useEffect(()=>{const s=()=>{if(t.current){const o=t.current.parentElement.getBoundingClientRect();i({width:o.width,height:o.height})}};return window.addEventListener("resize",s),s(),()=>window.removeEventListener("resize",s)},[]),D.useEffect(()=>{if(!n||!t.current||r.width===0)return;const s=st(t.current);s.selectAll("*").remove();const o=r.width,a=r.height,c=Math.min(o,a)*.5-60,l=c-20,u=dz().padAngle(.05).sortSubgroups(S_),d=Dz().innerRadius(l).outerRadius(c),h=Tz().radius(l),f=da(L_),p=s.append("g").attr("transform",`translate(${o/2},${a/2})`),g=u(n),x=p.append("g").selectAll("g").data(g.groups).join("g");x.append("path").style("fill",y=>f(y.index)).style("stroke",y=>Wo(f(y.index)).darker()).attr("d",d).on("mouseover",function(y,_){m.filter(v=>v.source.index!==_.index&&v.target.index!==_.index).transition().duration(200).style("opacity",.1)}).on("mouseout",function(){m.transition().duration(200).style("opacity",.7)}),x.append("text").each(y=>{y.angle=(y.startAngle+y.endAngle)/2}).attr("dy",".35em").attr("transform",y=>`
                rotate(${y.angle*180/Math.PI-90})
                translate(${c+10})
                ${y.angle>Math.PI?"rotate(180)":""}
            `).attr("text-anchor",y=>y.angle>Math.PI?"end":"start").text(y=>e[y.index]?.name||`Agent ${y.index}`).style("fill","#fff").style("font-size","10px").style("font-family","monospace");const m=p.append("g").attr("fill-opacity",.7).selectAll("path").data(g).join("path").attr("d",h).style("fill",y=>f(y.target.index)).style("stroke",y=>Wo(f(y.target.index)).darker())},[n,e,r]),b.jsx("svg",{ref:t,className:"w-full h-full"})};function Uz(){const{token:n}=js(),[e,t]=D.useState([]),[r,i]=D.useState(null),[s,o]=D.useState(!0),[a,c]=D.useState([]),l=async()=>{if(n)try{const d=await(await fetch("/api/decisions?limit=20",{headers:{Authorization:`Bearer ${n}`}})).json();if(d&&d.decisions&&d.decisions.length>0)t(d.decisions);else{const h=Array.from({length:5}).map((f,p)=>({id:`demo-${Math.random().toString(36).substr(2,9)}`,action:"SYSTEM_READY",timestamp:new Date().toISOString(),reasoning:"System initialized. Waiting for live traffic...",outcome:{status:"ready"}}));t(h)}o(!1)}catch(u){console.error("Failed to fetch decisions:",u),o(!1)}};return D.useEffect(()=>{l();const u=new EventSource("/api/events/stream");return u.onmessage=d=>{const h=JSON.parse(d.data);if(h.type!=="sys:connected"){const f=Math.random().toString(36).substr(2,9);c(p=>[...p,{id:f,...h,x:Math.random()*80+10,y:Math.random()*80+10}]),setTimeout(()=>{c(p=>p.filter(g=>g.id!==f))},2e3)}h.type==="decision:recorded"&&l()},()=>{u.close()}},[n]),b.jsxs("div",{className:"flex h-[calc(100vh-8rem)] gap-6 relative",children:[b.jsx("div",{className:"absolute inset-0 pointer-events-none z-50 overflow-hidden",children:a.map(u=>b.jsx("div",{className:"absolute w-2 h-2 rounded-full bg-[var(--hud-accent)] shadow-[0_0_10px_var(--hud-accent)] animate-ping",style:{left:`${u.x}%`,top:`${u.y}%`}},u.id))}),b.jsxs("div",{className:"w-1/3 min-w-[300px] flex flex-col gap-4",children:[b.jsx(Le,{className:"flex-0",children:b.jsxs("div",{className:"flex gap-2",children:[b.jsx("button",{onClick:()=>i(null),className:`flex-1 py-2 text-xs font-bold rounded ${r?"bg-black/40 text-[var(--hud-text-dim)] hover:text-white":"bg-[var(--hud-accent)] text-black"}`,children:"SYSTEM CHORD"}),b.jsx("button",{onClick:()=>i({}),className:`flex-1 py-2 text-xs font-bold rounded ${r?"bg-[var(--hud-accent)] text-black":"bg-black/40 text-[var(--hud-text-dim)] hover:text-white"}`,children:"STREAM"})]})}),b.jsx(Le,{title:"Decision Stream",icon:yr,className:"flex-1 flex flex-col min-h-0",children:b.jsxs("div",{className:"flex-1 overflow-y-auto pr-2 space-y-2 custom-scrollbar",children:[s&&b.jsx("div",{className:"p-4 text-center text-[var(--hud-text-dim)]",children:"Loading stream..."}),e.map(u=>b.jsxs("div",{onClick:()=>i(u),className:`p-3 rounded border cursor-pointer transition-all duration-200 group ${r?.id===u.id?"bg-[rgba(0,243,255,0.1)] border-[var(--hud-accent)]":"bg-[rgba(255,255,255,0.03)] border-transparent hover:border-[rgba(0,243,255,0.3)]"}`,children:[b.jsxs("div",{className:"flex justify-between items-center mb-1",children:[b.jsx("span",{className:`text-xs font-bold uppercase tracking-wider ${r?.id===u.id?"text-[var(--hud-accent)]":"text-white"}`,children:u.action}),b.jsx("span",{className:"text-[10px] font-mono text-[var(--hud-text-dim)]",children:new Date(u.timestamp).toLocaleTimeString()})]}),b.jsx("div",{className:"text-xs text-[var(--hud-text-dim)] line-clamp-2 font-mono group-hover:text-white transition-colors",children:u.reasoning})]},u.id))]})})]}),b.jsx("div",{className:"flex-1 flex flex-col",children:b.jsx(Le,{title:r?"Trace Inspector":"Agent Collaboration Topology",icon:r?eN:Vp,className:"h-full flex flex-col",children:r?Object.keys(r).length===0?b.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-[var(--hud-text-dim)] opacity-50",children:[b.jsx(yr,{size:64,className:"mb-4 animate-pulse"}),b.jsx("p",{className:"font-['Rajdhani'] text-lg tracking-wide",children:"SELECT A TRACE TO INSPECT"})]}):b.jsxs("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-300",children:[b.jsxs("div",{className:"flex items-center gap-4 pb-4 border-b border-[rgba(255,255,255,0.05)]",children:[b.jsx("div",{className:"w-12 h-12 rounded bg-[rgba(0,243,255,0.1)] flex items-center justify-center border border-[var(--hud-accent)]",children:b.jsx(Vp,{size:24,className:"text-[var(--hud-accent)]"})}),b.jsxs("div",{children:[b.jsx("h2",{className:"text-xl font-bold text-white",children:r.action}),b.jsxs("p",{className:"text-xs font-mono text-[var(--hud-text-dim)]",children:["ID: ",r.id]})]})]}),b.jsxs("div",{children:[b.jsxs("h3",{className:"text-xs font-bold text-[var(--hud-accent)] uppercase tracking-wider mb-2 flex items-center gap-2",children:[b.jsx(mf,{size:14})," Reasoning Chain"]}),b.jsx("div",{className:"p-4 rounded bg-[rgba(0,0,0,0.3)] border border-[rgba(255,255,255,0.05)] font-mono text-sm text-white leading-relaxed",children:r.reasoning})]}),b.jsxs("div",{className:"flex-1",children:[b.jsxs("h3",{className:"text-xs font-bold text-[var(--hud-success)] uppercase tracking-wider mb-2 flex items-center gap-2",children:[b.jsx(NN,{size:14})," Execution Outcome"]}),b.jsx("div",{className:"p-4 rounded bg-black border border-[rgba(255,255,255,0.1)] font-mono text-xs text-[var(--hud-success)] overflow-x-auto",children:b.jsx("pre",{children:JSON.stringify(r.outcome,null,2)})})]})]}):b.jsxs("div",{className:"w-full h-full relative p-4",children:[b.jsx(Oz,{matrix:[[0,5,8,2,0],[5,0,3,1,0],[8,3,0,4,6],[2,1,4,0,2],[0,0,6,2,0]],agents:[{name:"Core Router"},{name:"Finance Agent"},{name:"Legal Analyst"},{name:"Coder Bot"},{name:"Creative Unit"}]}),b.jsx("div",{className:"absolute bottom-4 left-4 text-[var(--hud-text-dim)] text-xs font-mono bg-black/80 p-2 rounded border border-[var(--hud-border)]",children:"Inter-Agent Signal Volume (Last 1hr)"})]})})})]})}const Gz=({data:n,dimensions:e,colorBy:t="fitness"})=>{const r=D.useRef(null),[i,s]=D.useState({width:0,height:0});return D.useEffect(()=>{const o=()=>{if(r.current){const a=r.current.parentElement.getBoundingClientRect();s({width:a.width,height:a.height})}};return window.addEventListener("resize",o),o(),()=>window.removeEventListener("resize",o)},[]),D.useEffect(()=>{if(!n||n.length===0||!r.current||i.width===0)return;const o=st(r.current);o.selectAll("*").remove();const a={top:30,right:10,bottom:10,left:10},c=i.width-a.left-a.right,l=i.height-a.top-a.bottom,u=o.append("g").attr("transform",`translate(${a.left},${a.top})`),d=e||Object.keys(n[0]).filter(x=>typeof n[0][x]=="number"&&x!=="id"),h={};d.forEach(x=>{h[x]=F_().domain(dm(n,m=>m[x])).range([l,0])});const f=FD().range([0,c]).padding(1).domain(d),p=x=>Lz()(d.map(m=>[f(m),h[m](x[m])])),g=k_(void 0).domain(dm(n,x=>x[t]));u.selectAll("myPath").data(n).enter().append("path").attr("d",p).style("fill","none").style("stroke",x=>g(x[t])).style("opacity",.6).style("stroke-width",1.5).on("mouseover",function(x,m){st(this).style("stroke-width",4).style("opacity",1)}).on("mouseout",function(x,m){st(this).style("stroke-width",1.5).style("opacity",.6)}),u.selectAll("myAxis").data(d).enter().append("g").attr("transform",x=>`translate(${f(x)})`).each(function(x){st(this).call(lz(h[x]))}).attr("color","#64748b").style("font-family","monospace").append("text").style("text-anchor","middle").attr("y",-9).text(x=>x.toUpperCase()).style("fill","#00f3ff").style("font-weight","bold")},[n,e,i]),b.jsx("svg",{ref:r,className:"w-full h-full"})};function $z(){const{token:n}=js(),[e,t]=D.useState([]),[r,i]=D.useState(null);return D.useRef(null),D.useEffect(()=>{if(!n)return;(async()=>{try{const a=await(await fetch("/api/lab/genomes?limit=20",{headers:{Authorization:`Bearer ${n}`}})).json();a.genomes&&a.genomes.length>0&&(t(a.genomes),i(a.genomes[0]))}catch(o){console.error("Failed to fetch genomes:",o)}})()},[n]),b.jsxs("div",{className:"h-[calc(100vh-8rem)] flex gap-6",children:[b.jsx("div",{className:"w-80 flex flex-col gap-4",children:b.jsxs(Le,{title:"Evolutionary Lab",icon:Fy,className:"flex-1 flex flex-col",children:[b.jsxs("div",{className:"text-xs text-[var(--hud-text-dim)] mb-4",children:["Observing Generation ",b.jsx("span",{className:"text-[var(--hud-accent)] font-mono",children:e.length>0?e[0].generation:0})]}),b.jsx("div",{className:"flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-2",children:e.map(s=>b.jsxs("div",{onClick:()=>i(s),className:`p-3 rounded border cursor-pointer transition-all ${r?.id===s.id?"bg-[var(--hud-accent)]/10 border-[var(--hud-accent)] shadow-[0_0_10px_var(--hud-accent)]":"bg-black border-[var(--hud-border)] hover:border-[var(--hud-text)]"}`,children:[b.jsxs("div",{className:"flex justify-between items-center mb-1",children:[b.jsxs("span",{className:"text-xs font-mono text-[var(--hud-text-dim)]",children:["Gen ",s.generation]}),b.jsxs("span",{className:"text-xs font-bold text-[var(--hud-success)]",children:["Fit: ",Math.round(s.fitness||0)]})]}),b.jsx("div",{className:"text-[10px] text-[var(--hud-text-dim)] truncate font-mono",children:s.id.split("-").pop()}),b.jsx("div",{className:"mt-2 flex gap-1 overflow-hidden opacity-50",children:s.phenotype?.slice(0,5).map((o,a)=>b.jsx("div",{className:"w-1 h-3 rounded-full bg-[var(--hud-text-dim)]",title:o},a))})]},s.id))})]})}),b.jsx("div",{className:"flex-1 flex flex-col gap-6",children:b.jsxs(Le,{className:"flex-1 relative overflow-hidden p-0",children:[b.jsxs("div",{className:"absolute top-4 left-4 z-10 pointer-events-none",children:[b.jsxs("h1",{className:"text-xl font-bold text-white tracking-tight flex items-center gap-2",children:[b.jsx(yr,{size:20,className:"text-[var(--hud-accent)]"}),"Multi-Objective Fitness Landscape"]}),b.jsx("p",{className:"text-[var(--hud-text-dim)] text-xs font-mono",children:"Parallel Coordinates: Generation vs Fitness vs Complexity"})]}),b.jsx("div",{className:"w-full h-full pt-16 pb-8 px-8 bg-black/50",children:e.length>0?b.jsx(Gz,{data:e.map(s=>({...s,generation:s.generation,fitness:s.fitness,complexity:Math.random()*100,latency:Math.random()*500})),dimensions:["generation","fitness","complexity","latency"],colorBy:"fitness"}):b.jsx("div",{className:"flex items-center justify-center h-full text-[var(--hud-text-dim)]",children:"awaiting genome data..."})})]})})]})}const Vz=({nodes:n})=>{const e=D.useRef(null),[t,r]=D.useState({width:0,height:0});return D.useEffect(()=>{const i=()=>{if(e.current){const s=e.current.parentElement.getBoundingClientRect();r({width:s.width,height:s.height})}};return window.addEventListener("resize",i),i(),()=>window.removeEventListener("resize",i)},[]),D.useEffect(()=>{if(!n||n.length===0||!e.current||t.width===0)return;const i=t.width,s=t.height,o=st(e.current);o.selectAll("*").remove();const a=n.map(d=>{if(d.x&&d.y)return d;const h=d.id.split("").reduce((f,p)=>f+p.charCodeAt(0),0);return{...d,x:(Math.sin(h)*.4+.5)*i,y:(Math.cos(h)*.4+.5)*s,cluster:h%5}}),c=o.append("g"),l=hb().scaleExtent([.5,4]).on("zoom",d=>{c.attr("transform",d.transform)});o.call(l);const u=da(L_);c.selectAll("circle").data(a).join("circle").attr("cx",d=>d.x).attr("cy",d=>d.y).attr("r",5).attr("fill",d=>u(d.cluster)).attr("stroke","#000").attr("stroke-width",1).attr("opacity",.8).on("mouseover",function(d,h){st(this).transition().duration(200).attr("r",10).attr("stroke","#fff"),c.append("text").attr("id","tooltip").attr("x",h.x+15).attr("y",h.y).text(h.name||h.key).attr("fill","#fff").style("font-size","12px").style("font-family","monospace").style("pointer-events","none").style("text-shadow","0 0 5px #000")}).on("mouseout",function(){st(this).transition().duration(200).attr("r",5).attr("stroke","#000"),st("#tooltip").remove()})},[n,t]),b.jsx("svg",{ref:e,className:"w-full h-full bg-black/40 rounded-lg"})};function zz(){const[n,e]=D.useState("activity"),[t,r]=D.useState([]),[i,s]=D.useState(!1),[o,a]=D.useState(""),[c,l]=D.useState(null);D.useEffect(()=>{n==="inspector"&&u()},[n]);const u=async()=>{s(!0);try{const f=await(await fetch("/api/explorer/nodes?limit=50")).json();f.nodes&&r(f.nodes)}catch(h){console.error(h)}finally{s(!1)}},d=async()=>{if(o.trim()){s(!0);try{const f=await(await fetch("/api/embeddings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:o})})).json();l(f)}catch(h){l({error:h.message})}finally{s(!1)}}};return b.jsxs("div",{className:"h-[calc(100vh-8rem)] flex flex-col gap-6",children:[b.jsx("div",{className:"flex items-center justify-between",children:b.jsx("div",{className:"flex gap-2 bg-black/50 p-1 rounded-lg border border-[var(--hud-border)]",children:[{id:"activity",label:"Cache Activity",icon:yr},{id:"inspector",label:"Cache Inspector",icon:Yd},{id:"embeddings",label:"Vector Lab",icon:jp}].map(h=>b.jsxs("button",{onClick:()=>e(h.id),className:`px-4 py-2 rounded flex items-center gap-2 text-sm font-bold transition-all ${n===h.id?"bg-[var(--hud-accent)] text-black shadow-[0_0_10px_var(--hud-accent)]":"text-[var(--hud-text-dim)] hover:text-white hover:bg-[rgba(255,255,255,0.05)]"}`,children:[b.jsx(h.icon,{size:16}),h.label]},h.id))})}),b.jsxs("div",{className:"flex-1 overflow-hidden",children:[n==="activity"&&b.jsxs("div",{className:"h-full grid grid-cols-1 lg:grid-cols-3 gap-6 animate-in fade-in slide-in-from-bottom-4",children:[b.jsxs("div",{className:"lg:col-span-3 grid grid-cols-1 md:grid-cols-4 gap-6",children:[b.jsxs(Le,{className:"bg-[rgba(0,255,128,0.05)] border-[var(--hud-success)]",children:[b.jsx("div",{className:"text-[var(--hud-text-dim)] text-xs uppercase tracking-wider mb-1",children:"Global Hit Rate"}),b.jsx("div",{className:"text-3xl font-mono font-bold text-[var(--hud-success)]",children:"94.2%"}),b.jsxs("div",{className:"text-xs text-[var(--hud-success)] mt-2 flex items-center gap-1",children:[b.jsx(mf,{size:12,className:"-rotate-45"})," +2.4% this week"]})]}),b.jsxs(Le,{children:[b.jsx("div",{className:"text-[var(--hud-text-dim)] text-xs uppercase tracking-wider mb-1",children:"Data Cached"}),b.jsx("div",{className:"text-3xl font-mono font-bold text-white",children:"4.2 TB"})]}),b.jsxs(Le,{children:[b.jsx("div",{className:"text-[var(--hud-text-dim)] text-xs uppercase tracking-wider mb-1",children:"Requests Served"}),b.jsx("div",{className:"text-3xl font-mono font-bold text-[var(--hud-accent)]",children:"8.4M"})]}),b.jsxs(Le,{children:[b.jsx("div",{className:"text-[var(--hud-text-dim)] text-xs uppercase tracking-wider mb-1",children:"Avg Latency"}),b.jsx("div",{className:"text-3xl font-mono font-bold text-[var(--hud-accent-secondary)]",children:"12ms"})]})]}),b.jsxs(Le,{title:"Throughput Analysis",className:"lg:col-span-2",children:[b.jsx("div",{className:"h-64 flex items-end justify-between gap-2 px-4 pb-4 border-b border-[var(--hud-border)]",children:[40,65,45,80,55,90,70].map((h,f)=>b.jsx("div",{className:"w-full bg-[var(--hud-accent)]/20 hover:bg-[var(--hud-accent)]/40 transition-colors rounded-t relative group",style:{height:`${h}%`},children:b.jsxs("div",{className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-black border border-[var(--hud-border)] px-2 py-1 text-xs rounded opacity-0 group-hover:opacity-100 pointer-events-none whitespace-nowrap z-10",children:[h*100," req/s"]})},f))}),b.jsxs("div",{className:"flex justify-between mt-2 text-xs text-[var(--hud-text-dim)] font-mono px-4",children:[b.jsx("span",{children:"MON"}),b.jsx("span",{children:"TUE"}),b.jsx("span",{children:"WED"}),b.jsx("span",{children:"THU"}),b.jsx("span",{children:"FRI"}),b.jsx("span",{children:"SAT"}),b.jsx("span",{children:"SUN"})]})]}),b.jsx(Le,{title:"Top Agents",className:"lg:col-span-1",children:b.jsx(Uc,{columns:[{header:"Agent",accessor:"agent"},{header:"Ops/Sec",accessor:"ops",render:h=>b.jsx("span",{className:"text-[var(--hud-success)] font-mono",children:h.ops})}],data:[{agent:"Clinical-Bot-1",ops:"1,204"},{agent:"Trading-Alpha",ops:"940"},{agent:"Legal-Reviewer",ops:"850"},{agent:"Support-Swarm",ops:"420"}]})})]}),n==="inspector"&&b.jsxs("div",{className:"h-full grid grid-cols-1 lg:grid-cols-3 gap-6 animate-in fade-in slide-in-from-bottom-4",children:[b.jsx("div",{className:"lg:col-span-2 flex flex-col",children:b.jsxs(Le,{title:"Knowledge Lattice (Public/Community)",icon:yr,className:"flex-1 relative overflow-hidden p-0",children:[b.jsx("div",{className:"absolute top-0 left-0 w-full h-full",children:b.jsx(Vz,{nodes:t})}),i&&b.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/50 z-20 backdrop-blur-sm",children:b.jsx("div",{className:"text-[var(--hud-accent)] animate-pulse font-mono",children:"SCANNING SECTOR..."})})]})}),b.jsx(Le,{title:"Node Inspector",icon:Yd,className:"h-full flex flex-col",children:b.jsx("div",{className:"flex-1 overflow-hidden",children:b.jsx(Uc,{columns:[{header:"ID",accessor:"id",render:h=>b.jsxs("span",{className:"font-mono text-xs text-[var(--hud-text-dim)]",children:[h.id.substring(0,6),"..."]})},{header:"Key / Topic",accessor:"key",render:h=>b.jsx("span",{className:"text-white truncate max-w-[150px] block",children:h.key||h.prompt||"Untitled"})},{header:"Conf.",accessor:"confidence",render:h=>b.jsxs("span",{className:"text-[var(--hud-success)] font-mono",children:[(h.confidence*100).toFixed(0),"%"]})}],data:t})})})]}),n==="embeddings"&&b.jsxs("div",{className:"h-full grid grid-cols-1 lg:grid-cols-2 gap-6 animate-in fade-in slide-in-from-bottom-4",children:[b.jsx(Le,{title:"Vector Laboratory",icon:jp,children:b.jsxs("div",{className:"space-y-4",children:[b.jsxs("div",{children:[b.jsx("label",{className:"text-xs text-[var(--hud-text-dim)] uppercase tracking-wider mb-2 block",children:"Input Text"}),b.jsx("textarea",{value:o,onChange:h=>a(h.target.value),className:"w-full h-32 bg-black border border-[var(--hud-border)] rounded p-3 text-sm focus:border-[var(--hud-accent)] focus:outline-none transition-colors",placeholder:"Enter text to vectorize..."})]}),b.jsxs("button",{onClick:d,disabled:i,className:"btn-cyber btn-cyber-primary w-full py-3 font-bold flex items-center justify-center gap-2",children:[i?b.jsx(Kd,{className:"animate-spin",size:16}):b.jsx(Kd,{size:16}),"GENERATE VECTOR"]})]})}),b.jsx(Le,{title:"Vector Output",className:"font-mono text-xs",children:c?b.jsxs("div",{className:"h-full overflow-y-auto custom-scrollbar space-y-4",children:[b.jsxs("div",{className:"flex items-center justify-between p-2 rounded bg-[rgba(255,255,255,0.05)]",children:[b.jsx("span",{className:"text-[var(--hud-text-dim)]",children:"Status"}),b.jsx("span",{className:c.cached?"text-[var(--hud-success)]":"text-[var(--hud-warning)]",children:c.cached?"CACHE HIT":"CACHE MISS"})]}),b.jsxs("div",{children:[b.jsx("div",{className:"text-[var(--hud-text-dim)] mb-1",children:"Vector Preview (First 50 dims)"}),b.jsxs("div",{className:"p-3 rounded bg-black border border-[var(--hud-border)] text-[var(--hud-accent)] break-all leading-relaxed",children:["[",c.embedding?.slice(0,50).map(h=>h.toFixed(4)).join(", "),"...]"]})]})]}):b.jsx("div",{className:"h-full flex items-center justify-center text-[var(--hud-text-dim)] italic",children:"Waiting for input..."})})]})]})]})}const jz=[{id:"Darwin",icon:"",label:"Darwin",desc:"Survival of the fittest. High mutation, ruthless culling.",color:"text-orange-400",border:"border-orange-500/50",bg:"bg-orange-500/10"},{id:"Utopia",icon:"",label:"Utopia",desc:"High cooperation, shared rewards, altruistic caching.",color:"text-cyan-400",border:"border-cyan-500/50",bg:"bg-cyan-500/10"},{id:"WallStreet",icon:"",label:"Wall Street",desc:"Profit maximization. High competition for tokens.",color:"text-emerald-400",border:"border-emerald-500/50",bg:"bg-emerald-500/10"},{id:"ArtistColony",icon:"",label:"Artist Colony",desc:"High temperature, novelty seeking, creative risks.",color:"text-pink-400",border:"border-pink-500/50",bg:"bg-pink-500/10"},{id:"DoomerPrepper",icon:"",label:"Doomer Prepper",desc:"Extreme safety, redundancy, low risk tolerance.",color:"text-slate-400",border:"border-slate-500/50",bg:"bg-slate-500/10"}];function Hz(){const{token:n}=js(),[e,t]=D.useState(null),[r,i]=D.useState(null),[s,o]=D.useState(!0),[a,c]=D.useState(!1);D.useEffect(()=>{if(!n)return;(async()=>{try{const d={Authorization:`Bearer ${n}`},[h,f,p,g]=await Promise.all([fetch("/api/governance/org",{headers:d}),fetch("/api/governance/members",{headers:d}),fetch("/api/governance/keys",{headers:d}),fetch("/api/governance/presets",{headers:d})]);if(!h.ok)throw new Error("Failed to fetch org data");const x=await h.json(),m=await f.json(),y=await p.json(),_=await g.json();i({...x,members:m.members||[],apiKeys:y.apiKeys||[]}),t(_.mode||"Default")}catch(d){console.error("Failed to fetch governance data:",d)}finally{o(!1)}})()},[n]);const l=async u=>{c(!0);try{(await fetch("/api/governance/presets",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:u,parameters:{timestamp:Date.now()}})})).ok&&t(u)}catch(d){console.error("Failed to switch mode:",d)}finally{c(!1)}};return s?b.jsx("div",{className:"p-8 text-slate-400",children:"Loading governance data..."}):b.jsxs("div",{className:"p-8 max-w-7xl mx-auto",children:[b.jsxs("header",{className:"mb-8",children:[b.jsx("h2",{className:"text-3xl font-bold text-white mb-2",children:"Governance"}),b.jsxs("p",{className:"text-slate-400",children:["Organization settings, access control, and ",b.jsx("span",{className:"text-purple-400",children:"Reality Switching"}),"."]})]}),b.jsxs("section",{className:"mb-12",children:[b.jsxs("h3",{className:"text-xl font-bold text-white mb-4 flex items-center gap-2",children:[b.jsx("span",{className:"text-purple-500",children:""})," Reality Switcher",b.jsx("span",{className:"text-xs font-normal text-slate-500 ml-2 border border-slate-700 px-2 py-0.5 rounded",children:"Global Simulation Parameters"})]}),b.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:jz.map(u=>{const d=e===u.id;return b.jsxs("button",{onClick:()=>l(u.id),disabled:a,className:`relative p-4 rounded-xl border text-left transition-all ${d?`${u.bg} ${u.border} shadow-[0_0_20px_rgba(0,0,0,0.3)] scale-[1.02]`:"bg-slate-900/40 border-slate-800 hover:border-slate-600 hover:bg-slate-800/60"}`,children:[d&&b.jsx("div",{className:"absolute top-2 right-2 w-2 h-2 rounded-full bg-green-500 animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.8)]"}),b.jsx("div",{className:"text-2xl mb-2",children:u.icon}),b.jsx("div",{className:`font-bold mb-1 ${d?"text-white":"text-slate-300"}`,children:u.label}),b.jsx("div",{className:"text-xs text-slate-500 leading-relaxed",children:u.desc})]},u.id)})})]}),b.jsx("div",{className:"border-t border-slate-800/50 my-8"}),b.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8",children:[b.jsxs("div",{className:"lg:col-span-2 bg-slate-900/50 border border-slate-800 rounded-xl p-6",children:[b.jsxs("div",{className:"flex justify-between items-start mb-6",children:[b.jsxs("div",{children:[b.jsx("h3",{className:"text-xl font-bold text-white",children:r.name}),b.jsxs("div",{className:"text-sm text-slate-500 font-mono mt-1",children:["ID: ",r.id]})]}),b.jsxs("span",{className:"px-3 py-1 bg-purple-500/20 text-purple-400 rounded-full text-xs font-bold border border-purple-500/30",children:[r.plan.toUpperCase()," PLAN"]})]}),b.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[b.jsxs("div",{className:"p-4 bg-slate-950 rounded-lg border border-slate-800",children:[b.jsx("div",{className:"text-xs text-slate-500 mb-1",children:"Your Role"}),b.jsx("div",{className:"font-semibold text-green-400",children:r.role})]}),b.jsxs("div",{className:"p-4 bg-slate-950 rounded-lg border border-slate-800",children:[b.jsx("div",{className:"text-xs text-slate-500 mb-1",children:"Region"}),b.jsx("div",{className:"font-semibold text-white",children:"US-East (N. Virginia)"})]})]})]}),b.jsxs("div",{className:"bg-slate-900/50 border border-slate-800 rounded-xl p-6",children:[b.jsx("h3",{className:"text-lg font-bold mb-4",children:"Compliance"}),b.jsxs("div",{className:"space-y-3",children:[b.jsx(Sd,{label:"SOC 2 Type II",status:"active"}),b.jsx(Sd,{label:"GDPR",status:"active"}),b.jsx(Sd,{label:"HIPAA",status:"pending"})]})]})]}),b.jsxs("div",{className:"bg-slate-900/50 border border-slate-800 rounded-xl p-6 mb-8",children:[b.jsxs("div",{className:"flex justify-between items-center mb-6",children:[b.jsx("h3",{className:"text-lg font-bold",children:"Team Members"}),b.jsx("button",{className:"px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white text-sm font-medium rounded-lg transition-colors",children:"Invite Member"})]}),b.jsx("div",{className:"overflow-x-auto",children:b.jsxs("table",{className:"w-full text-left text-sm",children:[b.jsx("thead",{children:b.jsxs("tr",{className:"border-b border-slate-800 text-slate-400",children:[b.jsx("th",{className:"pb-3 pl-2",children:"User"}),b.jsx("th",{className:"pb-3",children:"Role"}),b.jsx("th",{className:"pb-3",children:"2FA"}),b.jsx("th",{className:"pb-3 text-right pr-2",children:"Actions"})]})}),b.jsx("tbody",{className:"divide-y divide-slate-800",children:r.members.map(u=>b.jsxs("tr",{className:"group hover:bg-slate-800/30 transition-colors",children:[b.jsxs("td",{className:"py-3 pl-2",children:[b.jsx("div",{className:"font-medium text-white",children:u.name}),b.jsx("div",{className:"text-slate-500",children:u.email})]}),b.jsx("td",{className:"py-3",children:b.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium capitalize
                      ${u.role==="owner"?"bg-purple-500/10 text-purple-400":u.role==="admin"?"bg-blue-500/10 text-blue-400":"bg-slate-700/50 text-slate-400"}`,children:u.role})}),b.jsx("td",{className:"py-3",children:b.jsx("span",{className:"text-green-400",children:"Enabled"})}),b.jsx("td",{className:"py-3 text-right pr-2",children:b.jsx("button",{className:"text-slate-500 hover:text-white",children:""})})]},u.id))})]})})]}),b.jsxs("div",{className:"bg-slate-900/50 border border-slate-800 rounded-xl p-6",children:[b.jsx("h3",{className:"text-lg font-bold mb-4",children:"Active API Keys"}),b.jsx("div",{className:"space-y-3",children:r.apiKeys.map((u,d)=>b.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-950 rounded-lg border border-slate-800",children:[b.jsxs("div",{className:"flex items-center gap-3",children:[b.jsx("div",{className:"w-8 h-8 rounded bg-slate-900 flex items-center justify-center text-slate-400",children:""}),b.jsxs("div",{children:[b.jsxs("div",{className:"font-mono text-sm text-white",children:[u.prefix,"****************"]}),b.jsxs("div",{className:"text-xs text-slate-500",children:["Created ",u.created]})]})]}),b.jsx("div",{className:"flex gap-2",children:u.scopes.map(h=>b.jsx("span",{className:"px-2 py-1 bg-slate-800 text-slate-300 text-xs rounded border border-slate-700",children:h},h))})]},d))})]})]})}function Sd({label:n,status:e}){const t={active:"bg-green-500",pending:"bg-yellow-500",inactive:"bg-slate-500"};return b.jsxs("div",{className:"flex items-center justify-between",children:[b.jsx("span",{className:"text-sm text-slate-300",children:n}),b.jsxs("div",{className:"flex items-center gap-2",children:[b.jsx("span",{className:`w-2 h-2 rounded-full ${t[e]}`}),b.jsx("span",{className:"text-xs text-slate-500 capitalize",children:e})]})]})}const Lx={healthcare:[{id:"patient_records",title:" Patient Records",description:"Cache medical records with HIPAA compliance",prompt:"Cache patient medical records with HIPAA compliance and PHI detection",nodes:["input","phi_filter","cache_l1","cache_l2","hipaa_audit","openai","output"]},{id:"clinical_decision",title:" Clinical Decision Support",description:"AI-powered diagnosis with audit trails",prompt:"Cache clinical decision support AI with full audit logging",nodes:["input","phi_filter","cache_l1","anthropic","hipaa_audit","output"]},{id:"ehr_integration",title:" EHR Integration",description:"Electronic health record system caching",prompt:"Cache EHR system queries with encryption and compliance",nodes:["input","cache_l1","cache_l2","phi_filter","hipaa_audit","output"]},{id:"custom",title:" Custom Healthcare",description:"Describe your own healthcare use case",prompt:"",nodes:[]}],finance:[{id:"risk_analysis",title:" Risk Analysis",description:"Fraud detection and risk scoring",prompt:"Cache risk analysis and fraud detection for financial transactions",nodes:["input","fraud_detector","cache_l1","cache_l2","openai","pci_audit","output"]},{id:"transaction_processing",title:" Transaction Processing",description:"High-speed payment validation",prompt:"Cache transaction validation with PCI-DSS compliance",nodes:["input","transaction_validator","cache_l1","pci_audit","output"]},{id:"kyc_compliance",title:" KYC Compliance",description:"Know Your Customer verification",prompt:"Cache KYC verification results with audit trail",nodes:["input","cache_l1","cache_l2","anthropic","pci_audit","output"]},{id:"custom",title:" Custom Finance",description:"Describe your own financial use case",prompt:"",nodes:[]}],legal:[{id:"document_analysis",title:" Document Analysis",description:"Legal document review and search",prompt:"Cache legal document analysis with retention policies",nodes:["input","cache_l1","cache_l2","anthropic","retention_policy","output"]},{id:"case_research",title:" Case Research",description:"Case law and precedent lookup",prompt:"Cache case law research with audit logging",nodes:["input","semantic_dedup","cache_l2","cache_l3","openai","audit_logger","output"]},{id:"custom",title:" Custom Legal",description:"Describe your own legal use case",prompt:"",nodes:[]}],ecommerce:[{id:"product_search",title:" Product Search",description:"Fast product catalog search",prompt:"Cache product search and recommendations",nodes:["input","cache_l1","semantic_dedup","openai","output"]},{id:"inventory_sync",title:" Inventory Sync",description:"Real-time inventory availability",prompt:"Cache inventory status with short TTL for freshness",nodes:["input","cache_l1","output"]},{id:"personalization",title:" Personalization",description:"User recommendations and preferences",prompt:"Cache personalized recommendations per user",nodes:["input","cache_l1","cache_l2","gemini","output"]},{id:"custom",title:" Custom E-commerce",description:"Describe your own e-commerce use case",prompt:"",nodes:[]}],saas:[{id:"api_caching",title:" API Caching",description:"Multi-tenant API response caching",prompt:"Cache API responses with tenant isolation",nodes:["input","cache_l1","cache_l2","output"]},{id:"ai_features",title:" AI Features",description:"AI-powered product features",prompt:"Cache AI completions for SaaS features",nodes:["input","semantic_dedup","cache_l1","cache_l2","openai","output"]},{id:"analytics",title:" Analytics",description:"Dashboard data aggregation",prompt:"Cache analytics queries and dashboard data",nodes:["input","cache_l2","cache_l3","output"]},{id:"custom",title:" Custom SaaS",description:"Describe your own SaaS use case",prompt:"",nodes:[]}],general:[{id:"api_basic",title:" API Caching",description:"Basic API response caching",prompt:"Cache API responses to reduce latency",nodes:["input","cache_l1","cache_l2","output"]},{id:"llm_caching",title:" LLM Caching",description:"Cache AI model responses",prompt:"Cache LLM completions to save costs",nodes:["input","semantic_dedup","cache_l1","cache_l2","openai","output"]},{id:"database",title:" Database Query",description:"Cache expensive database queries",prompt:"Cache database query results",nodes:["input","cache_l1","cache_l2","cache_l3","output"]},{id:"custom",title:" Custom",description:"Describe your own use case",prompt:"",nodes:[]}]},Ox={healthcare:[{category:"input",types:["input"]},{category:"cache",types:["cache_l1","cache_l2","cache_l3"]},{category:"intelligence",types:["semantic_dedup","phi_filter"]},{category:"llm",types:["openai","anthropic","gemini"]},{category:"compliance",types:["hipaa_audit","encrypted_cache"]},{category:"output",types:["output"]}],finance:[{category:"input",types:["input"]},{category:"cache",types:["cache_l1","cache_l2","cache_l3"]},{category:"intelligence",types:["semantic_dedup","fraud_detector","transaction_validator"]},{category:"llm",types:["openai","anthropic","gemini"]},{category:"compliance",types:["pci_audit","sox_logger"]},{category:"output",types:["output"]}],legal:[{category:"input",types:["input"]},{category:"cache",types:["cache_l1","cache_l2","cache_l3"]},{category:"intelligence",types:["semantic_dedup"]},{category:"llm",types:["openai","anthropic","gemini"]},{category:"compliance",types:["retention_policy","audit_logger"]},{category:"output",types:["output"]}],ecommerce:[{category:"input",types:["input"]},{category:"cache",types:["cache_l1","cache_l2"]},{category:"intelligence",types:["semantic_dedup"]},{category:"llm",types:["openai","anthropic","gemini"]},{category:"output",types:["output"]}],saas:[{category:"input",types:["input"]},{category:"cache",types:["cache_l1","cache_l2","cache_l3"]},{category:"intelligence",types:["semantic_dedup"]},{category:"llm",types:["openai","anthropic","gemini"]},{category:"output",types:["output"]}],general:[{category:"input",types:["input"]},{category:"cache",types:["cache_l1","cache_l2","cache_l3"]},{category:"intelligence",types:["semantic_dedup"]},{category:"llm",types:["openai","anthropic","gemini"]},{category:"output",types:["output"]}]},Ux={healthcare:{required:["hipaa","phi"],autoAddNodes:["phi_filter","hipaa_audit"],retention:"7 years",encryption:"required"},finance:{required:["pci_dss","sox"],autoAddNodes:["pci_audit"],retention:"7 years",encryption:"required"},legal:{required:["data_retention"],autoAddNodes:["retention_policy","audit_logger"],retention:"10 years",encryption:"recommended"},ecommerce:{required:["pci_dss","gdpr"],autoAddNodes:[],retention:"2 years",encryption:"recommended"},saas:{required:["soc2"],autoAddNodes:[],retention:"1 year",encryption:"recommended"},general:{required:[],autoAddNodes:[],retention:"30 days",encryption:"optional"}};function Gx(n){return{templates:Lx[n]||Lx.general,nodes:Ox[n]||Ox.general,compliance:Ux[n]||Ux.general}}const Wz=D.createContext();function qz({children:n}){const[e,t]=D.useState(null),[r,i]=D.useState(null),[s,o]=D.useState(!1);D.useEffect(()=>{const l=localStorage.getItem("agentcache_sector");l?(t(l),i(Gx(l))):o(!0)},[]);const a=l=>{t(l),i(Gx(l)),localStorage.setItem("agentcache_sector",l),o(!1)},c=()=>{o(!0)};return b.jsx(Wz.Provider,{value:{sector:e,config:r,selectSector:a,changeSector:c,showSectorModal:s,setShowSectorModal:o},children:n})}function Xz(){const{login:n}=js(),[e,t]=D.useState(""),[r,i]=D.useState(!1),[s,o]=D.useState(null),a=async c=>{c.preventDefault(),i(!0),o(null),await n(e)||o("Login failed. Please try again."),i(!1)};return b.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm",children:b.jsx("div",{className:"w-full max-w-md p-6",children:b.jsx(Le,{title:"Mission Control Access",icon:uN,className:"border-[var(--hud-accent)] shadow-[0_0_50px_rgba(0,243,255,0.2)]",children:b.jsxs("form",{onSubmit:a,className:"space-y-6 mt-4",children:[b.jsxs("div",{children:[b.jsx("label",{className:"block text-xs font-mono text-[var(--hud-text-dim)] mb-2",children:"OPERATOR ID (EMAIL)"}),b.jsx("input",{type:"email",value:e,onChange:c=>t(c.target.value),placeholder:"alice@acme.com",className:"w-full bg-black border border-[var(--hud-border)] rounded p-3 text-white focus:border-[var(--hud-accent)] focus:outline-none transition-colors",required:!0})]}),s&&b.jsx("div",{className:"text-red-500 text-xs font-mono border border-red-500/50 bg-red-500/10 p-2 rounded",children:s}),b.jsx("button",{type:"submit",disabled:r,className:"w-full py-3 bg-[var(--hud-accent)] text-black font-bold rounded hover:bg-white transition-colors flex items-center justify-center gap-2",children:r?"AUTHENTICATING...":b.jsxs(b.Fragment,{children:["ENTER CONSOLE ",b.jsx(mf,{size:16})]})}),b.jsx("div",{className:"text-center text-[10px] text-[var(--hud-text-dim)] font-mono",children:"SECURE TERMINAL // AUTHORIZED PERSONNEL ONLY"})]})})})})}const Yz=()=>{const[n,e]=D.useState("overview"),{user:t,loading:r}=js();if(r)return b.jsx("div",{className:"h-screen flex items-center justify-center text-[var(--hud-accent)] font-mono",children:"INITIALIZING..."});if(!t)return b.jsx(Xz,{});const i=()=>{switch(n){case"overview":return b.jsx(Hp,{});case"pipeline":return b.jsx(E3,{});case"swarm":return b.jsx(tz,{});case"observability":return b.jsx(Uz,{});case"lab":return b.jsx($z,{});case"data":return b.jsx(zz,{});case"governance":return b.jsx(Hz,{});default:return b.jsx(Hp,{})}};return b.jsx(qz,{children:b.jsxs("div",{className:"flex h-screen bg-[var(--hud-bg)] text-[var(--hud-text)] overflow-hidden font-sans selection:bg-[var(--hud-accent)] selection:text-black",children:[b.jsx(kN,{activeView:n,setActiveView:e,user:t}),b.jsxs("div",{className:"flex-1 flex flex-col pl-16 transition-all duration-300",children:[b.jsx(IN,{}),b.jsxs("main",{className:"flex-1 overflow-y-auto overflow-x-hidden pt-16 p-6 relative",children:[b.jsx("div",{className:"fixed inset-0 pointer-events-none z-0 opacity-20",style:{backgroundImage:"linear-gradient(rgba(0, 243, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 243, 255, 0.05) 1px, transparent 1px)",backgroundSize:"40px 40px"}}),b.jsx("div",{className:"relative z-10 max-w-7xl mx-auto animate-in fade-in slide-in-from-bottom-4 duration-500",children:i()})]})]})]})})},Kz=()=>b.jsx(ez,{children:b.jsx(Yz,{})});cw.createRoot(document.getElementById("root")).render(b.jsx(K.StrictMode,{children:b.jsx(Kz,{})}));
