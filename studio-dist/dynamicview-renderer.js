/**
 * Dynamic View Renderer
 * 
 * Vanilla JavaScript renderer for Dynamic View schemas
 * Renders declarative JSON schemas into interactive DOM elements
 */

class DynamicViewRenderer {
  constructor(containerElement, options = {}) {
    this.container = containerElement;
    this.options = {
      onEvent: options.onEvent || (() => {}),
      theme: options.theme || 'dark',
      maxDepth: options.maxDepth || 10,
    };
    this.eventHandlers = new Map();
  }

  /**
   * Render a Dynamic View schema into the container
   */
  render(schema) {
    // Validate schema
    if (!schema || !schema.root) {
      this.renderError('Invalid schema: missing root component');
      return;
    }

    // Clear container
    this.container.innerHTML = '';
    
    // Add metadata badges if present
    if (schema.metadata) {
      this.renderMetadataBadges(schema.metadata);
    }

    // Render root component
    try {
      const rootElement = this.renderComponent(schema.root, 0);
      this.container.appendChild(rootElement);
    } catch (error) {
      console.error('Error rendering Dynamic View:', error);
      this.renderError(`Rendering error: ${error.message}`);
    }
  }

  /**
   * Render metadata badges at the top
   */
  renderMetadataBadges(metadata) {
    const badgeContainer = document.createElement('div');
    badgeContainer.className = 'flex items-center gap-2 mb-4 text-xs';

    if (metadata.generatedBy) {
      const badge = document.createElement('span');
      badge.className = 'px-2 py-1 rounded-full bg-slate-700 text-slate-300';
      badge.textContent = `Generated by: ${metadata.generatedBy}`;
      badgeContainer.appendChild(badge);
    }

    if (metadata.freshness) {
      const freshnessIcons = {
        fresh: 'ðŸŸ¢',
        stale: 'ðŸŸ¡',
        expired: 'ðŸ”´',
      };
      const badge = document.createElement('span');
      badge.className = 'px-2 py-1 rounded-full bg-slate-700 text-slate-300';
      badge.textContent = `${freshnessIcons[metadata.freshness] || ''} ${metadata.freshness}`;
      badgeContainer.appendChild(badge);
    }

    if (metadata.cached) {
      const badge = document.createElement('span');
      badge.className = 'px-2 py-1 rounded-full bg-emerald-500/20 text-emerald-300';
      badge.textContent = 'âš¡ Cached';
      badgeContainer.appendChild(badge);
    }

    this.container.appendChild(badgeContainer);
  }

  /**
   * Recursively render a component
   */
  renderComponent(component, depth) {
    if (depth > this.options.maxDepth) {
      throw new Error('Maximum component depth exceeded');
    }

    if (!component.type) {
      throw new Error('Component missing type');
    }

    // Skip hidden components
    if (component.hidden) {
      return document.createDocumentFragment();
    }

    // Route to appropriate renderer
    const renderer = this.componentRenderers[component.type];
    if (!renderer) {
      console.warn(`Unknown component type: ${component.type}`);
      return this.renderUnknown(component);
    }

    const element = renderer.call(this, component, depth);
    
    // Apply common styles
    if (component.style) {
      this.applyStyles(element, component.style);
    }

    return element;
  }

  /**
   * Component-specific renderers
   */
  componentRenderers = {
    // Layout components
    container: (comp, depth) => {
      const div = document.createElement('div');
      div.className = 'dynamic-container';
      if (comp.layout === 'horizontal') {
        div.classList.add('flex', 'flex-row');
      } else {
        div.classList.add('flex', 'flex-col');
      }
      comp.children?.forEach(child => {
        div.appendChild(this.renderComponent(child, depth + 1));
      });
      return div;
    },

    row: (comp, depth) => {
      const div = document.createElement('div');
      div.className = 'flex flex-row';
      if (comp.gap) div.style.gap = `${comp.gap}px`;
      if (comp.align) {
        const alignMap = { start: 'start', center: 'center', end: 'end', stretch: 'stretch' };
        div.style.alignItems = alignMap[comp.align];
      }
      comp.children?.forEach(child => {
        div.appendChild(this.renderComponent(child, depth + 1));
      });
      return div;
    },

    column: (comp, depth) => {
      const div = document.createElement('div');
      div.className = 'flex flex-col';
      if (comp.gap) div.style.gap = `${comp.gap}px`;
      if (comp.align) {
        const alignMap = { start: 'start', center: 'center', end: 'end', stretch: 'stretch' };
        div.style.alignItems = alignMap[comp.align];
      }
      comp.children?.forEach(child => {
        div.appendChild(this.renderComponent(child, depth + 1));
      });
      return div;
    },

    grid: (comp, depth) => {
      const div = document.createElement('div');
      div.className = 'grid';
      div.style.gridTemplateColumns = `repeat(${comp.columns || 2}, 1fr)`;
      if (comp.gap) div.style.gap = `${comp.gap}px`;
      comp.children?.forEach(child => {
        div.appendChild(this.renderComponent(child, depth + 1));
      });
      return div;
    },

    // Display components
    text: (comp) => {
      const span = document.createElement('span');
      const sizeMap = { sm: 'text-sm', md: 'text-base', lg: 'text-lg' };
      const weightMap = { normal: 'font-normal', medium: 'font-medium', semibold: 'font-semibold', bold: 'font-bold' };
      span.className = `${sizeMap[comp.size] || 'text-base'} ${weightMap[comp.weight] || 'font-normal'}`;
      span.textContent = comp.content || '';
      return span;
    },

    heading: (comp) => {
      const h = document.createElement(`h${comp.level || 2}`);
      h.className = `text-${6 - (comp.level || 2)}xl font-semibold`;
      h.textContent = comp.content || '';
      return h;
    },

    badge: (comp) => {
      const span = document.createElement('span');
      const variantMap = {
        success: 'bg-emerald-500/20 text-emerald-300 border-emerald-500/40',
        warning: 'bg-yellow-500/20 text-yellow-300 border-yellow-500/40',
        error: 'bg-red-500/20 text-red-300 border-red-500/40',
        info: 'bg-blue-500/20 text-blue-300 border-blue-500/40',
        neutral: 'bg-slate-500/20 text-slate-300 border-slate-500/40',
      };
      span.className = `inline-flex items-center gap-1 px-2 py-1 rounded-full border text-xs font-medium ${variantMap[comp.variant] || variantMap.neutral}`;
      if (comp.icon) {
        const icon = document.createElement('span');
        icon.textContent = comp.icon;
        span.appendChild(icon);
      }
      span.appendChild(document.createTextNode(comp.label || ''));
      return span;
    },

    metric: (comp) => {
      const div = document.createElement('div');
      div.className = 'flex flex-col gap-1';
      
      const label = document.createElement('p');
      label.className = 'text-xs text-slate-500 uppercase';
      label.textContent = comp.label || '';
      
      const valueDiv = document.createElement('div');
      valueDiv.className = 'flex items-baseline gap-1';
      
      const value = document.createElement('span');
      value.className = 'text-2xl font-semibold';
      value.textContent = comp.value;
      
      if (comp.unit) {
        const unit = document.createElement('span');
        unit.className = 'text-sm text-slate-400';
        unit.textContent = comp.unit;
        valueDiv.appendChild(value);
        valueDiv.appendChild(unit);
      } else {
        valueDiv.appendChild(value);
      }
      
      div.appendChild(label);
      div.appendChild(valueDiv);
      
      if (comp.trendValue) {
        const trend = document.createElement('span');
        const trendColors = { up: 'text-emerald-400', down: 'text-red-400', neutral: 'text-slate-400' };
        trend.className = `text-xs ${trendColors[comp.trend] || trendColors.neutral}`;
        trend.textContent = comp.trendValue;
        div.appendChild(trend);
      }
      
      return div;
    },

    card: (comp, depth) => {
      const div = document.createElement('div');
      const variantMap = {
        default: 'bg-slate-900/50 border-slate-800',
        outlined: 'bg-transparent border-slate-700',
        elevated: 'bg-slate-900/80 border-slate-700 shadow-lg',
      };
      div.className = `rounded-xl border p-4 ${variantMap[comp.variant] || variantMap.default}`;
      
      if (comp.title) {
        const title = document.createElement('h3');
        title.className = 'text-sm font-semibold mb-3';
        title.textContent = comp.title;
        div.appendChild(title);
      }
      
      const content = document.createElement('div');
      content.className = 'flex flex-col gap-2';
      comp.children?.forEach(child => {
        content.appendChild(this.renderComponent(child, depth + 1));
      });
      div.appendChild(content);
      
      return div;
    },

    // Interactive components
    button: (comp) => {
      const button = document.createElement('button');
      const variantMap = {
        primary: 'bg-sky-600 hover:bg-sky-500 text-white',
        secondary: 'bg-slate-700 hover:bg-slate-600 text-slate-200',
        danger: 'bg-red-600 hover:bg-red-500 text-white',
      };
      button.className = `px-4 py-2 rounded-lg font-semibold text-sm transition-colors ${variantMap[comp.variant] || variantMap.primary}`;
      button.textContent = comp.label || 'Button';
      button.disabled = comp.disabled || false;
      
      if (comp.onClick) {
        button.addEventListener('click', () => {
          this.handleEvent(comp.onClick, { type: 'click', componentId: comp.id });
        });
      }
      
      return button;
    },

    input: (comp) => {
      const div = document.createElement('div');
      div.className = 'flex flex-col gap-1';
      
      if (comp.label) {
        const label = document.createElement('label');
        label.className = 'text-sm font-medium';
        label.textContent = comp.label;
        div.appendChild(label);
      }
      
      const input = document.createElement('input');
      input.type = comp.inputType || 'text';
      input.className = 'rounded-lg border border-slate-700 bg-slate-900/50 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none';
      input.value = comp.value || '';
      input.placeholder = comp.placeholder || '';
      
      if (comp.onChange) {
        input.addEventListener('input', (e) => {
          this.handleEvent(comp.onChange, { type: 'change', componentId: comp.id, value: e.target.value });
        });
      }
      
      div.appendChild(input);
      return div;
    },

    slider: (comp) => {
      const div = document.createElement('div');
      div.className = 'flex flex-col gap-2';
      
      const labelRow = document.createElement('div');
      labelRow.className = 'flex items-center justify-between text-sm';
      
      if (comp.label) {
        const label = document.createElement('span');
        label.className = 'font-medium';
        label.textContent = comp.label;
        labelRow.appendChild(label);
      }
      
      const valueSpan = document.createElement('span');
      valueSpan.className = 'text-slate-400';
      valueSpan.textContent = comp.value;
      labelRow.appendChild(valueSpan);
      
      const input = document.createElement('input');
      input.type = 'range';
      input.className = 'w-full';
      input.min = comp.min;
      input.max = comp.max;
      input.step = comp.step || 1;
      input.value = comp.value;
      
      input.addEventListener('input', (e) => {
        valueSpan.textContent = e.target.value;
        if (comp.onChange) {
          this.handleEvent(comp.onChange, { type: 'change', componentId: comp.id, value: e.target.value });
        }
      });
      
      div.appendChild(labelRow);
      div.appendChild(input);
      return div;
    },

    toggle: (comp) => {
      const label = document.createElement('label');
      label.className = 'flex items-center gap-2 cursor-pointer';
      
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.className = 'sr-only peer';
      input.checked = comp.checked || false;
      
      const toggle = document.createElement('div');
      toggle.className = 'relative w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:bg-sky-600 after:content-[""] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all';
      
      if (comp.onChange) {
        input.addEventListener('change', (e) => {
          this.handleEvent(comp.onChange, { type: 'change', componentId: comp.id, checked: e.target.checked });
        });
      }
      
      label.appendChild(input);
      label.appendChild(toggle);
      
      if (comp.label) {
        const text = document.createElement('span');
        text.className = 'text-sm font-medium';
        text.textContent = comp.label;
        label.appendChild(text);
      }
      
      return label;
    },

    select: (comp) => {
      const div = document.createElement('div');
      div.className = 'flex flex-col gap-1';
      
      if (comp.label) {
        const label = document.createElement('label');
        label.className = 'text-sm font-medium';
        label.textContent = comp.label;
        div.appendChild(label);
      }
      
      const select = document.createElement('select');
      select.className = 'rounded-lg border border-slate-700 bg-slate-900/50 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none';
      
      comp.options?.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label;
        option.selected = opt.value === comp.value;
        select.appendChild(option);
      });
      
      if (comp.onChange) {
        select.addEventListener('change', (e) => {
          this.handleEvent(comp.onChange, { type: 'change', componentId: comp.id, value: e.target.value });
        });
      }
      
      div.appendChild(select);
      return div;
    },

    // Data viz components (simplified)
    progress: (comp) => {
      const div = document.createElement('div');
      div.className = 'flex flex-col gap-1';
      
      if (comp.label) {
        const label = document.createElement('p');
        label.className = 'text-xs text-slate-500';
        label.textContent = comp.label;
        div.appendChild(label);
      }
      
      const bar = document.createElement('div');
      bar.className = 'w-full bg-slate-700 rounded-full h-2';
      
      const fill = document.createElement('div');
      const variantMap = {
        default: 'bg-sky-500',
        success: 'bg-emerald-500',
        warning: 'bg-yellow-500',
        error: 'bg-red-500',
      };
      fill.className = `h-2 rounded-full transition-all ${variantMap[comp.variant] || variantMap.default}`;
      fill.style.width = `${Math.min(100, comp.value)}%`;
      
      bar.appendChild(fill);
      div.appendChild(bar);
      
      return div;
    },

    chart: (comp) => {
      // Simplified chart rendering (would integrate with Chart.js or D3 in production)
      const div = document.createElement('div');
      div.className = 'rounded-lg bg-slate-800/50 p-4 text-center';
      div.innerHTML = `<p class="text-sm text-slate-400">Chart: ${comp.chartType}</p><p class="text-xs text-slate-500 mt-1">${comp.data?.length || 0} data points</p>`;
      return div;
    },

    sparkline: (comp) => {
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('class', 'w-full h-8');
      svg.setAttribute('viewBox', '0 0 100 20');
      
      if (comp.data && comp.data.length > 0) {
        const max = Math.max(...comp.data);
        const min = Math.min(...comp.data);
        const range = max - min || 1;
        
        const points = comp.data.map((val, i) => {
          const x = (i / (comp.data.length - 1)) * 100;
          const y = 20 - ((val - min) / range) * 18;
          return `${x},${y}`;
        }).join(' ');
        
        const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
        polyline.setAttribute('points', points);
        polyline.setAttribute('fill', 'none');
        polyline.setAttribute('stroke', '#38bdf8');
        polyline.setAttribute('stroke-width', '2');
        svg.appendChild(polyline);
      }
      
      return svg;
    },

    // Pipeline-specific components
    'node-card': (comp) => {
      const div = document.createElement('div');
      const statusColors = {
        active: 'border-emerald-500/40 bg-emerald-500/10',
        inactive: 'border-slate-500/40 bg-slate-500/10',
        error: 'border-red-500/40 bg-red-500/10',
      };
      div.className = `rounded-lg border-2 p-3 ${statusColors[comp.status] || statusColors.inactive}`;
      
      const header = document.createElement('div');
      header.className = 'flex items-center gap-2 mb-2';
      
      if (comp.icon) {
        const icon = document.createElement('span');
        icon.className = 'text-xl';
        icon.textContent = comp.icon;
        header.appendChild(icon);
      }
      
      const label = document.createElement('span');
      label.className = 'font-semibold';
      label.textContent = comp.label || comp.nodeType;
      header.appendChild(label);
      
      div.appendChild(header);
      
      if (comp.metadata) {
        const meta = document.createElement('div');
        meta.className = 'text-xs text-slate-400 space-y-1';
        Object.entries(comp.metadata).forEach(([key, val]) => {
          const p = document.createElement('p');
          p.textContent = `${key}: ${val}`;
          meta.appendChild(p);
        });
        div.appendChild(meta);
      }
      
      return div;
    },
  };

  /**
   * Apply inline styles from schema
   */
  applyStyles(element, styles) {
    if (styles.backgroundColor) element.style.backgroundColor = styles.backgroundColor;
    if (styles.borderColor) element.style.borderColor = styles.borderColor;
    if (styles.textColor) element.style.color = styles.textColor;
    if (styles.padding) element.style.padding = styles.padding;
    if (styles.margin) element.style.margin = styles.margin;
    if (styles.width) element.style.width = styles.width;
    if (styles.height) element.style.height = styles.height;
    if (styles.className) element.className += ` ${styles.className}`;
  }

  /**
   * Handle component events
   */
  handleEvent(handlerId, data) {
    this.options.onEvent(handlerId, data);
  }

  /**
   * Render error message
   */
  renderError(message) {
    this.container.innerHTML = `
      <div class="rounded-xl border border-red-500/40 bg-red-500/10 p-4 text-red-300">
        <p class="font-semibold">Error rendering Dynamic View</p>
        <p class="text-sm mt-1">${message}</p>
      </div>
    `;
  }

  /**
   * Render unknown component fallback
   */
  renderUnknown(component) {
    const div = document.createElement('div');
    div.className = 'rounded border border-yellow-500/40 bg-yellow-500/10 p-2 text-yellow-300 text-xs';
    div.textContent = `Unknown component: ${component.type}`;
    return div;
  }
}

// Export for use in other scripts
if (typeof module !== 'undefined' && module.exports) {
  module.exports = DynamicViewRenderer;
}
